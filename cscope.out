cscope 15 $HOME/data/linux-dmdedup/drivers/md               0002349406
	@bcache/alloc.c

63 
	~"bˇche.h
"

64 
	~"båì.h
"

66 
	~<löux/blkdev.h
>

67 
	~<löux/‰ìzî.h
>

68 
	~<löux/kthªad.h
>

69 
	~<löux/øndom.h
>

70 
	~<åa˚/evíts/bˇche.h
>

74 
uöt8_t
 
	$bch_öc_gí
(
ˇche
 *
ˇ
, 
buckë
 *
b
)

76 
uöt8_t
 
ªt
 = ++
b
->
gí
;

78 
ˇ
->
£t
->
√ed_gc
 = 
	`max
(ˇ->£t->√ed_gc, 
	`buckë_gc_gí
(
b
));

79 
	`WARN_ON_ONCE
(
ˇ
->
£t
->
√ed_gc
 > 
BUCKET_GC_GEN_MAX
);

81  
ªt
;

82 
	}
}

84 
	$bch_ªsˇÀ_¥i‹ôõs
(
ˇche_£t
 *
c
, 
£˘‹s
)

86 
ˇche
 *
ˇ
;

87 
buckë
 *
b
;

88 
√xt
 = 
c
->
nbuckës
 * c->
sb
.
buckë_size
 / 1024;

89 
i
;

90 
r
;

92 
	`©omic_sub
(
£˘‹s
, &
c
->
ªsˇÀ
);

95 
r
 = 
	`©omic_ªad
(&
c
->
ªsˇÀ
);

97 i‡(
r
 >= 0)

99 } 
	`©omic_cmpxchg
(&
c
->
ªsˇÀ
, 
r
,Ñ + 
√xt
) !=Ñ);

101 
	`muãx_lock
(&
c
->
buckë_lock
);

103 
c
->
mö_¥io
 = 
USHRT_MAX
;

105 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

106 
	`f‹_óch_buckë
(
b
, 
ˇ
)

107 i‡(
b
->
¥io
 &&

108 
b
->
¥io
 !
BTREE_PRIO
 &&

109 !
	`©omic_ªad
(&
b
->
pö
)) {

110 
b
->
¥io
--;

111 
c
->
mö_¥io
 = 
	`mö
(c->mö_¥io, 
b
->
¥io
);

114 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

115 
	}
}

124 
ölöe
 
boﬁ
 
	$ˇn_öc_buckë_gí
(
buckë
 *
b
)

126  
	`buckë_gc_gí
(
b
Ë< 
BUCKET_GC_GEN_MAX
;

127 
	}
}

129 
boﬁ
 
	$bch_ˇn_övÆid©e_buckë
(
ˇche
 *
ˇ
, 
buckë
 *
b
)

131 
	`BUG_ON
(!
ˇ
->
£t
->
gc_m¨k_vÆid
);

133  (!
	`GC_MARK
(
b
) ||

134 
	`GC_MARK
(
b
Ë=
GC_MARK_RECLAIMABLE
) &&

135 !
	`©omic_ªad
(&
b
->
pö
) &&

136 
	`ˇn_öc_buckë_gí
(
b
);

137 
	}
}

139 
	$__bch_övÆid©e_⁄e_buckë
(
ˇche
 *
ˇ
, 
buckë
 *
b
)

141 
	`lockdï_as£π_hñd
(&
ˇ
->
£t
->
buckë_lock
);

142 
	`BUG_ON
(
	`GC_MARK
(
b
Ë&& GC_MARK(bË!
GC_MARK_RECLAIMABLE
);

144 i‡(
	`GC_SECTORS_USED
(
b
))

145 
	`åa˚_bˇche_övÆid©e
(
ˇ
, 
b
 - ca->
buckës
);

147 
	`bch_öc_gí
(
ˇ
, 
b
);

148 
b
->
¥io
 = 
INITIAL_PRIO
;

149 
	`©omic_öc
(&
b
->
pö
);

150 
	}
}

152 
	$bch_övÆid©e_⁄e_buckë
(
ˇche
 *
ˇ
, 
buckë
 *
b
)

154 
	`__bch_övÆid©e_⁄e_buckë
(
ˇ
, 
b
);

156 
	`fifo_push
(&
ˇ
->
‰ì_öc
, 
b
 - ca->
buckës
);

157 
	}
}

168 
	#buckë_¥io
(
b
) \

170 
mö_¥io
 = (
INITIAL_PRIO
 - 
ˇ
->
£t
->min_prio) / 8; \

172 (
b
->
¥io
 - 
ˇ
->
£t
->
mö_¥io
 + mö_¥ioË* 
	`GC_SECTORS_USED
(b); \

173 })

	)

175 
	#buckë_max_cmp
(
l
, 
r
Ë(
	`buckë_¥io
÷Ë< buckë_¥io‘))

	)

176 
	#buckë_mö_cmp
(
l
, 
r
Ë(
	`buckë_¥io
÷Ë> buckë_¥io‘))

	)

178 
	$övÆid©e_buckës_Ãu
(
ˇche
 *
ˇ
)

180 
buckë
 *
b
;

181 
ssize_t
 
i
;

183 
ˇ
->
hóp
.
u£d
 = 0;

185 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

186 i‡(!
	`bch_ˇn_övÆid©e_buckë
(
ˇ
, 
b
))

189 i‡(!
	`hóp_fuŒ
(&
ˇ
->
hóp
))

190 
	`hóp_add
(&
ˇ
->
hóp
, 
b
, 
buckë_max_cmp
);

191 i‡(
	`buckë_max_cmp
(
b
, 
	`hóp_≥ek
(&
ˇ
->
hóp
))) {

192 
ˇ
->
hóp
.
d©a
[0] = 
b
;

193 
	`hóp_si·
(&
ˇ
->
hóp
, 0, 
buckë_max_cmp
);

197 
i
 = 
ˇ
->
hóp
.
u£d
 / 2 - 1; i >= 0; --i)

198 
	`hóp_si·
(&
ˇ
->
hóp
, 
i
, 
buckë_mö_cmp
);

200 !
	`fifo_fuŒ
(&
ˇ
->
‰ì_öc
)) {

201 i‡(!
	`hóp_p›
(&
ˇ
->
hóp
, 
b
, 
buckë_mö_cmp
)) {

206 
ˇ
->
övÆid©e_√eds_gc
 = 1;

207 
	`wake_up_gc
(
ˇ
->
£t
);

211 
	`bch_övÆid©e_⁄e_buckë
(
ˇ
, 
b
);

213 
	}
}

215 
	$övÆid©e_buckës_fifo
(
ˇche
 *
ˇ
)

217 
buckë
 *
b
;

218 
size_t
 
checked
 = 0;

220 !
	`fifo_fuŒ
(&
ˇ
->
‰ì_öc
)) {

221 i‡(
ˇ
->
fifo_œ°_buckë
 < ca->
sb
.
fú°_buckë
 ||

222 
ˇ
->
fifo_œ°_buckë
 >ˇ->
sb
.
nbuckës
)

223 
ˇ
->
fifo_œ°_buckë
 = ca->
sb
.
fú°_buckë
;

225 
b
 = 
ˇ
->
buckës
 + ca->
fifo_œ°_buckë
++;

227 i‡(
	`bch_ˇn_övÆid©e_buckë
(
ˇ
, 
b
))

228 
	`bch_övÆid©e_⁄e_buckë
(
ˇ
, 
b
);

230 i‡(++
checked
 >
ˇ
->
sb
.
nbuckës
) {

231 
ˇ
->
övÆid©e_√eds_gc
 = 1;

232 
	`wake_up_gc
(
ˇ
->
£t
);

236 
	}
}

238 
	$övÆid©e_buckës_øndom
(
ˇche
 *
ˇ
)

240 
buckë
 *
b
;

241 
size_t
 
checked
 = 0;

243 !
	`fifo_fuŒ
(&
ˇ
->
‰ì_öc
)) {

244 
size_t
 
n
;

245 
	`gë_øndom_byãs
(&
n
, (n));

247 
n
 %(
size_t
Ë(
ˇ
->
sb
.
nbuckës
 - ca->sb.
fú°_buckë
);

248 
n
 +
ˇ
->
sb
.
fú°_buckë
;

250 
b
 = 
ˇ
->
buckës
 + 
n
;

252 i‡(
	`bch_ˇn_övÆid©e_buckë
(
ˇ
, 
b
))

253 
	`bch_övÆid©e_⁄e_buckë
(
ˇ
, 
b
);

255 i‡(++
checked
 >
ˇ
->
sb
.
nbuckës
 / 2) {

256 
ˇ
->
övÆid©e_√eds_gc
 = 1;

257 
	`wake_up_gc
(
ˇ
->
£t
);

261 
	}
}

263 
	$övÆid©e_buckës
(
ˇche
 *
ˇ
)

265 
	`BUG_ON
(
ˇ
->
övÆid©e_√eds_gc
);

267 
	`CACHE_REPLACEMENT
(&
ˇ
->
sb
)) {

268 
CACHE_REPLACEMENT_LRU
:

269 
	`övÆid©e_buckës_Ãu
(
ˇ
);

271 
CACHE_REPLACEMENT_FIFO
:

272 
	`övÆid©e_buckës_fifo
(
ˇ
);

274 
CACHE_REPLACEMENT_RANDOM
:

275 
	`övÆid©e_buckës_øndom
(
ˇ
);

278 
	}
}

280 
	#Æloˇt‹_waô
(
ˇ
, 
c⁄d
) \

283 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
); \

284 i‡(
c⁄d
) \

287 
	`muãx_u∆ock
(&(
ˇ
)->
£t
->
buckë_lock
); \

288 i‡(
	`kthªad_should_°›
()) \

291 
	`åy_to_‰ìze
(); \

292 
	`scheduÀ
(); \

293 
	`muãx_lock
(&(
ˇ
)->
£t
->
buckë_lock
); \

295 
	`__£t_cuºít_°©e
(
TASK_RUNNING
); \

296 } 0)

	)

298 
	$bch_Æloˇt‹_push
(
ˇche
 *
ˇ
, 
buckë
)

300 
i
;

303 i‡(
	`fifo_push
(&
ˇ
->
‰ì
[
RESERVE_PRIO
], 
buckë
))

304  
åue
;

306 
i
 = 0; i < 
RESERVE_NR
; i++)

307 i‡(
	`fifo_push
(&
ˇ
->
‰ì
[
i
], 
buckë
))

308  
åue
;

310  
Ál£
;

311 
	}
}

313 
	$bch_Æloˇt‹_thªad
(*
¨g
)

315 
ˇche
 *
ˇ
 = 
¨g
;

317 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

325 !
	`fifo_em±y
(&
ˇ
->
‰ì_öc
)) {

326 
buckë
;

328 
	`fifo_p›
(&
ˇ
->
‰ì_öc
, 
buckë
);

330 i‡(
ˇ
->
disˇrd
) {

331 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

332 
	`blkdev_issue_disˇrd
(
ˇ
->
bdev
,

333 
	`buckë_to_£˘‹
(
ˇ
->
£t
, 
buckë
),

334 
ˇ
->
sb
.
buckë_size
, 
GFP_KERNEL
, 0);

335 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

338 
	`Æloˇt‹_waô
(
ˇ
, 
	`bch_Æloˇt‹_push
(ˇ, 
buckë
));

339 
	`wake_up
(&
ˇ
->
£t
->
båì_ˇche_waô
);

340 
	`wake_up
(&
ˇ
->
£t
->
buckë_waô
);

349 
ªåy_övÆid©e
:

350 
	`Æloˇt‹_waô
(
ˇ
, ca->
£t
->
gc_m¨k_vÆid
 &&

351 !
ˇ
->
övÆid©e_√eds_gc
);

352 
	`övÆid©e_buckës
(
ˇ
);

358 
	`Æloˇt‹_waô
(
ˇ
, !
	`©omic_ªad
(&ˇ->
£t
->
¥io_blocked
));

359 i‡(
	`CACHE_SYNC
(&
ˇ
->
£t
->
sb
)) {

371 i‡(!
	`fifo_fuŒ
(&
ˇ
->
‰ì_öc
))

372 
ªåy_övÆid©e
;

374 
	`bch_¥io_wrôe
(
ˇ
);

377 
	}
}

381 
	$bch_buckë_Æloc
(
ˇche
 *
ˇ
, 
ª£rve
, 
boﬁ
 
waô
)

383 
	`DEFINE_WAIT
(
w
);

384 
buckë
 *
b
;

385 
r
;

388 i‡(
	`fifo_p›
(&
ˇ
->
‰ì
[
RESERVE_NONE
], 
r
) ||

389 
	`fifo_p›
(&
ˇ
->
‰ì
[
ª£rve
], 
r
))

390 
out
;

392 i‡(!
waô
) {

393 
	`åa˚_bˇche_Æloc_Áû
(
ˇ
, 
ª£rve
);

398 
	`¥ï¨e_to_waô
(&
ˇ
->
£t
->
buckë_waô
, &
w
,

399 
TASK_UNINTERRUPTIBLE
);

401 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

402 
	`scheduÀ
();

403 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

404 } !
	`fifo_p›
(&
ˇ
->
‰ì
[
RESERVE_NONE
], 
r
) &&

405 !
	`fifo_p›
(&
ˇ
->
‰ì
[
ª£rve
], 
r
));

407 
	`föish_waô
(&
ˇ
->
£t
->
buckë_waô
, &
w
);

408 
out
:

409 
	`wake_up_¥o˚ss
(
ˇ
->
Æloc_thªad
);

411 
	`åa˚_bˇche_Æloc
(
ˇ
, 
ª£rve
);

413 i‡(
	`ex≥nsive_debug_checks
(
ˇ
->
£t
)) {

414 
size_t
 
ôî
;

415 
i
;

416 
j
;

418 
ôî
 = 0; iã∏< 
	`¥io_buckës
(
ˇ
) * 2; iter++)

419 
	`BUG_ON
(
ˇ
->
¥io_buckës
[
ôî
] =(
uöt64_t
Ë
r
);

421 
j
 = 0; j < 
RESERVE_NR
; j++)

422 
	`fifo_f‹_óch
(
i
, &
ˇ
->
‰ì
[
j
], 
ôî
)

423 
	`BUG_ON
(
i
 =
r
);

424 
	`fifo_f‹_óch
(
i
, &
ˇ
->
‰ì_öc
, 
ôî
)

425 
	`BUG_ON
(
i
 =
r
);

428 
b
 = 
ˇ
->
buckës
 + 
r
;

430 
	`BUG_ON
(
	`©omic_ªad
(&
b
->
pö
) != 1);

432 
	`SET_GC_SECTORS_USED
(
b
, 
ˇ
->
sb
.
buckë_size
);

434 i‡(
ª£rve
 <
RESERVE_PRIO
) {

435 
	`SET_GC_MARK
(
b
, 
GC_MARK_METADATA
);

436 
	`SET_GC_MOVE
(
b
, 0);

437 
b
->
¥io
 = 
BTREE_PRIO
;

439 
	`SET_GC_MARK
(
b
, 
GC_MARK_RECLAIMABLE
);

440 
	`SET_GC_MOVE
(
b
, 0);

441 
b
->
¥io
 = 
INITIAL_PRIO
;

444  
r
;

445 
	}
}

447 
	$__bch_buckë_‰ì
(
ˇche
 *
ˇ
, 
buckë
 *
b
)

449 
	`SET_GC_MARK
(
b
, 0);

450 
	`SET_GC_SECTORS_USED
(
b
, 0);

451 
	}
}

453 
	$bch_buckë_‰ì
(
ˇche_£t
 *
c
, 
bkey
 *
k
)

455 
i
;

457 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

458 
	`__bch_buckë_‰ì
(
	`PTR_CACHE
(
c
, 
k
, 
i
),

459 
	`PTR_BUCKET
(
c
, 
k
, 
i
));

460 
	}
}

462 
	$__bch_buckë_Æloc_£t
(
ˇche_£t
 *
c
, 
ª£rve
,

463 
bkey
 *
k
, 
n
, 
boﬁ
 
waô
)

465 
i
;

467 
	`lockdï_as£π_hñd
(&
c
->
buckë_lock
);

468 
	`BUG_ON
(!
n
 ||Ç > 
c
->
ˇches_lﬂded
 ||Ç > 8);

470 
	`bkey_öô
(
k
);

474 
i
 = 0; i < 
n
; i++) {

475 
ˇche
 *
ˇ
 = 
c
->
ˇche_by_Æloc
[
i
];

476 
b
 = 
	`bch_buckë_Æloc
(
ˇ
, 
ª£rve
, 
waô
);

478 i‡(
b
 == -1)

479 
îr
;

481 
k
->
±r
[
i
] = 
	`PTR
(
ˇ
->
buckës
[
b
].
gí
,

482 
	`buckë_to_£˘‹
(
c
, 
b
),

483 
ˇ
->
sb
.
ƒ_this_dev
);

485 
	`SET_KEY_PTRS
(
k
, 
i
 + 1);

489 
îr
:

490 
	`bch_buckë_‰ì
(
c
, 
k
);

491 
	`bkey_put
(
c
, 
k
);

493 
	}
}

495 
	$bch_buckë_Æloc_£t
(
ˇche_£t
 *
c
, 
ª£rve
,

496 
bkey
 *
k
, 
n
, 
boﬁ
 
waô
)

498 
ªt
;

499 
	`muãx_lock
(&
c
->
buckë_lock
);

500 
ªt
 = 
	`__bch_buckë_Æloc_£t
(
c
, 
ª£rve
, 
k
, 
n
, 
waô
);

501 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

502  
ªt
;

503 
	}
}

507 
	s›í_buckë
 {

508 
li°_hód
 
	mli°
;

509 
	mœ°_wrôe_poöt
;

510 
	m£˘‹s_‰ì
;

511 
BKEY_PADDED
(
key
);

533 
›í_buckë
 *
	$pick_d©a_buckë
(
ˇche_£t
 *
c
,

534 c⁄° 
bkey
 *
£¨ch
,

535 
wrôe_poöt
,

536 
bkey
 *
Æloc
)

538 
›í_buckë
 *
ªt
, *
ªt_èsk
 = 
NULL
;

540 
	`li°_f‹_óch_íåy_ªvî£
(
ªt
, &
c
->
d©a_buckës
, 
li°
)

541 i‡(!
	`bkey_cmp
(&
ªt
->
key
, 
£¨ch
))

542 
found
;

543 i‡(
ªt
->
œ°_wrôe_poöt
 =
wrôe_poöt
)

544 
ªt_èsk
 = 
ªt
;

546 
ªt
 = 
ªt_èsk
 ?: 
	`li°_fú°_íåy
(&
c
->
d©a_buckës
,

547 
›í_buckë
, 
li°
);

548 
found
:

549 i‡(!
ªt
->
£˘‹s_‰ì
 && 
	`KEY_PTRS
(
Æloc
)) {

550 
ªt
->
£˘‹s_‰ì
 = 
c
->
sb
.
buckë_size
;

551 
	`bkey_c›y
(&
ªt
->
key
, 
Æloc
);

552 
	`bkey_öô
(
Æloc
);

555 i‡(!
ªt
->
£˘‹s_‰ì
)

556 
ªt
 = 
NULL
;

558  
ªt
;

559 
	}
}

571 
boﬁ
 
	$bch_Æloc_£˘‹s
(
ˇche_£t
 *
c
, 
bkey
 *
k
, 
£˘‹s
,

572 
wrôe_poöt
, 
wrôe_¥io
, 
boﬁ
 
waô
)

574 
›í_buckë
 *
b
;

575 
	`BKEY_PADDED
(
key
Ë
Æloc
;

576 
i
;

585 
	`bkey_öô
(&
Æloc
.
key
);

586 
	`•ö_lock
(&
c
->
d©a_buckë_lock
);

588 !(
b
 = 
	`pick_d©a_buckë
(
c
, 
k
, 
wrôe_poöt
, &
Æloc
.
key
))) {

589 
w©îm¨k
 = 
wrôe_¥io


590 ? 
RESERVE_MOVINGGC


591 : 
RESERVE_NONE
;

593 
	`•ö_u∆ock
(&
c
->
d©a_buckë_lock
);

595 i‡(
	`bch_buckë_Æloc_£t
(
c
, 
w©îm¨k
, &
Æloc
.
key
, 1, 
waô
))

596  
Ál£
;

598 
	`•ö_lock
(&
c
->
d©a_buckë_lock
);

606 i‡(
	`KEY_PTRS
(&
Æloc
.
key
))

607 
	`bkey_put
(
c
, &
Æloc
.
key
);

609 
i
 = 0; i < 
	`KEY_PTRS
(&
b
->
key
); i++)

610 
	`EBUG_ON
(
	`±r_°Æe
(
c
, &
b
->
key
, 
i
));

614 
i
 = 0; i < 
	`KEY_PTRS
(&
b
->
key
); i++)

615 
k
->
±r
[
i
] = 
b
->
key
.ptr[i];

617 
£˘‹s
 = 
	`mö
(£˘‹s, 
b
->
£˘‹s_‰ì
);

619 
	`SET_KEY_OFFSET
(
k
, 
	`KEY_OFFSET
(kË+ 
£˘‹s
);

620 
	`SET_KEY_SIZE
(
k
, 
£˘‹s
);

621 
	`SET_KEY_PTRS
(
k
, 
	`KEY_PTRS
(&
b
->
key
));

627 
	`li°_move_èû
(&
b
->
li°
, &
c
->
d©a_buckës
);

628 
	`bkey_c›y_key
(&
b
->
key
, 
k
);

629 
b
->
œ°_wrôe_poöt
 = 
wrôe_poöt
;

631 
b
->
£˘‹s_‰ì
 -
£˘‹s
;

633 
i
 = 0; i < 
	`KEY_PTRS
(&
b
->
key
); i++) {

634 
	`SET_PTR_OFFSET
(&
b
->
key
, 
i
, 
	`PTR_OFFSET
(&b->key, iË+ 
£˘‹s
);

636 
	`©omic_l⁄g_add
(
£˘‹s
,

637 &
	`PTR_CACHE
(
c
, &
b
->
key
, 
i
)->
£˘‹s_wrôãn
);

640 i‡(
b
->
£˘‹s_‰ì
 < 
c
->
sb
.
block_size
)

641 
b
->
£˘‹s_‰ì
 = 0;

648 i‡(
b
->
£˘‹s_‰ì
)

649 
i
 = 0; i < 
	`KEY_PTRS
(&
b
->
key
); i++)

650 
	`©omic_öc
(&
	`PTR_BUCKET
(
c
, &
b
->
key
, 
i
)->
pö
);

652 
	`•ö_u∆ock
(&
c
->
d©a_buckë_lock
);

653  
åue
;

654 
	}
}

658 
	$bch_›í_buckës_‰ì
(
ˇche_£t
 *
c
)

660 
›í_buckë
 *
b
;

662 !
	`li°_em±y
(&
c
->
d©a_buckës
)) {

663 
b
 = 
	`li°_fú°_íåy
(&
c
->
d©a_buckës
,

664 
›í_buckë
, 
li°
);

665 
	`li°_dñ
(&
b
->
li°
);

666 
	`k‰ì
(
b
);

668 
	}
}

670 
	$bch_›í_buckës_Æloc
(
ˇche_£t
 *
c
)

672 
i
;

674 
	`•ö_lock_öô
(&
c
->
d©a_buckë_lock
);

676 
i
 = 0; i < 6; i++) {

677 
›í_buckë
 *
b
 = 
	`kzÆloc
((*b), 
GFP_KERNEL
);

678 i‡(!
b
)

679  -
ENOMEM
;

681 
	`li°_add
(&
b
->
li°
, &
c
->
d©a_buckës
);

685 
	}
}

687 
	$bch_ˇche_Æloˇt‹_°¨t
(
ˇche
 *
ˇ
)

689 
èsk_°ru˘
 *
k
 = 
	`kthªad_run
(
bch_Æloˇt‹_thªad
,

690 
ˇ
, "bcache_allocator");

691 i‡(
	`IS_ERR
(
k
))

692  
	`PTR_ERR
(
k
);

694 
ˇ
->
Æloc_thªad
 = 
k
;

696 
	}
}

	@bcache/bcache.h

1 #i‚de‡
_BCACHE_H


2 
	#_BCACHE_H


	)

178 
	#¥_fmt
(
fmt
Ë"bˇche: %s(Ë" fmà"\n", 
__func__


	)

180 
	~<löux/bˇche.h
>

181 
	~<löux/bio.h
>

182 
	~<löux/kobje˘.h
>

183 
	~<löux/li°.h
>

184 
	~<löux/muãx.h
>

185 
	~<löux/rbåì.h
>

186 
	~<löux/rw£m.h
>

187 
	~<löux/ty≥s.h
>

188 
	~<löux/w‹kqueue.h
>

190 
	~"b£t.h
"

191 
	~"utû.h
"

192 
	~"˛osuª.h
"

194 
	sbuckë
 {

195 
©omic_t
 
	mpö
;

196 
uöt16_t
 
	m¥io
;

197 
uöt8_t
 
	mgí
;

198 
uöt8_t
 
	mœ°_gc
;

199 
uöt16_t
 
	mgc_m¨k
;

207 
BITMASK
(
GC_MARK
, 
buckë
, 
gc_m¨k
, 0, 2);

208 
	#GC_MARK_RECLAIMABLE
 1

	)

209 
	#GC_MARK_DIRTY
 2

	)

210 
	#GC_MARK_METADATA
 3

	)

211 
	#GC_SECTORS_USED_SIZE
 13

	)

212 
	#MAX_GC_SECTORS_USED
 (~(~0ULL << 
GC_SECTORS_USED_SIZE
))

	)

213 
BITMASK
(
GC_SECTORS_USED
, 
buckë
, 
gc_m¨k
, 2, 
GC_SECTORS_USED_SIZE
);

214 
BITMASK
(
GC_MOVE
, 
buckë
, 
gc_m¨k
, 15, 1);

216 
	~"jou∫Æ.h
"

217 
	~"°©s.h
"

218 
	g£¨ch
;

219 
	gbåì
;

220 
	gkeybuf
;

222 
	skeybuf_key
 {

223 
rb_node
 
	mnode
;

224 
BKEY_PADDED
(
key
);

225 *
	m¥iv©e
;

228 
	skeybuf
 {

229 
bkey
 
	mœ°_sˇ¬ed
;

230 
•ölock_t
 
	mlock
;

237 
bkey
 
	m°¨t
;

238 
bkey
 
	míd
;

240 
rb_roŸ
 
	mkeys
;

242 
	#KEYBUF_NR
 500

	)

243 
DECLARE_ARRAY_ALLOCATOR
(
keybuf_key
, 
‰ìli°
, 
KEYBUF_NR
);

246 
	sbio_•lô_poﬁ
 {

247 
bio_£t
 *
	mbio_•lô
;

248 
mempoﬁ_t
 *
	mbio_•lô_hook
;

251 
	sbio_•lô_hook
 {

252 
˛osuª
 
	m˛
;

253 
bio_•lô_poﬁ
 *
	mp
;

254 
bio
 *
	mbio
;

255 
bio_íd_io_t
 *
	mbi_íd_io
;

256 *
	mbi_¥iv©e
;

259 
	sbˇche_devi˚
 {

260 
˛osuª
 
	m˛
;

262 
kobje˘
 
	mkobj
;

264 
ˇche_£t
 *
	mc
;

265 
	mid
;

266 
	#BCACHEDEVNAME_SIZE
 12

	)

267 
	m«me
[
BCACHEDEVNAME_SIZE
];

269 
gídisk
 *
	mdisk
;

271 
	mÊags
;

272 
	#BCACHE_DEV_CLOSING
 0

	)

273 
	#BCACHE_DEV_DETACHING
 1

	)

274 
	#BCACHE_DEV_UNLINK_DONE
 2

	)

276 
	mƒ_°rùes
;

277 
	m°rùe_size
;

278 
©omic_t
 *
	m°rùe_£˘‹s_dúty
;

279 *
	mfuŒ_dúty_°rùes
;

281 
	m£˘‹s_dúty_œ°
;

282 
	m£˘‹s_dúty_dîiv©ive
;

284 
bio_£t
 *
	mbio_•lô
;

286 
	md©a_csum
:1;

288 (*
	mˇche_miss
)(
	mbåì
 *, 
	m£¨ch
 *,

289 
	mbio
 *, );

290 (*
	mio˘l
Ë(
	mbˇche_devi˚
 *, 
	mfmode_t
, , );

292 
bio_•lô_poﬁ
 
	mbio_•lô_hook
;

295 
	sio
 {

297 
hli°_node
 
	mhash
;

298 
li°_hód
 
	mÃu
;

300 
	mjiffõs
;

301 
	m£quítül
;

302 
£˘‹_t
 
	mœ°
;

305 
	sˇched_dev
 {

306 
li°_hód
 
	mli°
;

307 
bˇche_devi˚
 
	mdisk
;

308 
block_devi˚
 *
	mbdev
;

310 
ˇche_sb
 
	msb
;

311 
bio
 
	msb_bio
;

312 
bio_vec
 
	msb_bv
[1];

313 
˛osuª
 
	msb_wrôe
;

314 
£m≠h‹e
 
	msb_wrôe_muãx
;

317 
©omic_t
 
	mcou¡
;

318 
w‹k_°ru˘
 
	mdëach
;

324 
©omic_t
 
	mru¬ög
;

330 
rw_£m≠h‹e
 
	mwrôeback_lock
;

337 
©omic_t
 
	mhas_dúty
;

339 
bch_øãlimô
 
	mwrôeback_øã
;

340 
dñayed_w‹k
 
	mwrôeback_øã_upd©e
;

346 
£˘‹_t
 
	mœ°_ªad
;

349 
£m≠h‹e
 
	mö_Êight
;

350 
èsk_°ru˘
 *
	mwrôeback_thªad
;

352 
keybuf
 
	mwrôeback_keys
;

355 
	#RECENT_IO_BITS
 7

	)

356 
	#RECENT_IO
 (1 << 
RECENT_IO_BITS
)

	)

357 
io
 
	mio
[
RECENT_IO
];

358 
hli°_hód
 
	mio_hash
[
RECENT_IO
 + 1];

359 
li°_hód
 
	mio_Ãu
;

360 
•ölock_t
 
	mio_lock
;

362 
ˇche_accou¡ög
 
	maccou¡ög
;

365 
	m£quítül_cutoff
;

366 
	mªadahód
;

368 
	mvîify
:1;

369 
	mby∑ss_t‹tuª_ã°
:1;

371 
	m∑πül_°rùes_ex≥nsive
:1;

372 
	mwrôeback_mëad©a
:1;

373 
	mwrôeback_ru¬ög
:1;

374 
	mwrôeback_≥r˚¡
;

375 
	mwrôeback_dñay
;

377 
uöt64_t
 
	mwrôeback_øã_èrgë
;

378 
öt64_t
 
	mwrôeback_øã_¥›‹ti⁄Æ
;

379 
öt64_t
 
	mwrôeback_øã_dîiv©ive
;

380 
öt64_t
 
	mwrôeback_øã_ch™ge
;

382 
	mwrôeback_øã_upd©e_£c⁄ds
;

383 
	mwrôeback_øã_d_ãrm
;

384 
	mwrôeback_øã_p_ãrm_övî£
;

387 
	eÆloc_ª£rve
 {

388 
	mRESERVE_BTREE
,

389 
	mRESERVE_PRIO
,

390 
	mRESERVE_MOVINGGC
,

391 
	mRESERVE_NONE
,

392 
	mRESERVE_NR
,

395 
	sˇche
 {

396 
ˇche_£t
 *
	m£t
;

397 
ˇche_sb
 
	msb
;

398 
bio
 
	msb_bio
;

399 
bio_vec
 
	msb_bv
[1];

401 
kobje˘
 
	mkobj
;

402 
block_devi˚
 *
	mbdev
;

404 
èsk_°ru˘
 *
	mÆloc_thªad
;

406 
˛osuª
 
	m¥io
;

407 
¥io_£t
 *
	mdisk_buckës
;

416 
uöt64_t
 *
	m¥io_buckës
;

417 
uöt64_t
 *
	m¥io_œ°_buckës
;

428 
DECLARE_FIFO
(, 
‰ì
)[
RESERVE_NR
];

429 
DECLARE_FIFO
(, 
‰ì_öc
);

431 
size_t
 
	mfifo_œ°_buckë
;

434 
buckë
 *
	mbuckës
;

436 
DECLARE_HEAP
(
buckë
 *, 
hóp
);

443 
	mövÆid©e_√eds_gc
:1;

445 
boﬁ
 
	mdisˇrd
;

447 
jou∫Æ_devi˚
 
	mjou∫Æ
;

450 
	#IO_ERROR_SHIFT
 20

	)

451 
©omic_t
 
	mio_îr‹s
;

452 
©omic_t
 
	mio_cou¡
;

454 
©omic_l⁄g_t
 
	mmëa_£˘‹s_wrôãn
;

455 
©omic_l⁄g_t
 
	mbåì_£˘‹s_wrôãn
;

456 
©omic_l⁄g_t
 
	m£˘‹s_wrôãn
;

458 
bio_•lô_poﬁ
 
	mbio_•lô_hook
;

461 
	sgc_°©
 {

462 
size_t
 
	mnodes
;

463 
size_t
 
	mkey_byãs
;

465 
size_t
 
	mnkeys
;

466 
uöt64_t
 
	md©a
;

467 
	mö_u£
;

484 
	#CACHE_SET_UNREGISTERING
 0

	)

485 
	#CACHE_SET_STOPPING
 1

	)

486 
	#CACHE_SET_RUNNING
 2

	)

488 
	sˇche_£t
 {

489 
˛osuª
 
	m˛
;

491 
li°_hód
 
	mli°
;

492 
kobje˘
 
	mkobj
;

493 
kobje˘
 
	möã∫Æ
;

494 
díåy
 *
	mdebug
;

495 
ˇche_accou¡ög
 
	maccou¡ög
;

497 
	mÊags
;

499 
ˇche_sb
 
	msb
;

501 
ˇche
 *
	mˇche
[
MAX_CACHES_PER_SET
];

502 
ˇche
 *
	mˇche_by_Æloc
[
MAX_CACHES_PER_SET
];

503 
	mˇches_lﬂded
;

505 
bˇche_devi˚
 **
	mdevi˚s
;

506 
li°_hód
 
	mˇched_devs
;

507 
uöt64_t
 
	mˇched_dev_£˘‹s
;

508 
˛osuª
 
	mˇchög
;

510 
˛osuª
 
	msb_wrôe
;

511 
£m≠h‹e
 
	msb_wrôe_muãx
;

513 
mempoﬁ_t
 *
	m£¨ch
;

514 
mempoﬁ_t
 *
	mbio_mëa
;

515 
bio_£t
 *
	mbio_•lô
;

518 
shrökî
 
	mshrök
;

521 
muãx
 
	mbuckë_lock
;

524 
	mbuckë_bôs
;

527 
	mblock_bôs
;

533 
	mbåì_∑ges
;

551 
li°_hód
 
	mbåì_ˇche
;

552 
li°_hód
 
	mbåì_ˇche_‰ìabÀ
;

553 
li°_hód
 
	mbåì_ˇche_‰ìd
;

556 
	mbåì_ˇche_u£d
;

564 
waô_queue_hód_t
 
	mbåì_ˇche_waô
;

565 
èsk_°ru˘
 *
	mbåì_ˇche_Æloc_lock
;

577 
©omic_t
 
	m¥io_blocked
;

578 
waô_queue_hód_t
 
	mbuckë_waô
;

584 
©omic_t
 
	mªsˇÀ
;

591 
uöt16_t
 
	mmö_¥io
;

597 
uöt8_t
 
	m√ed_gc
;

598 
gc_°©
 
	mgc_°©s
;

599 
size_t
 
	mnbuckës
;

601 
èsk_°ru˘
 *
	mgc_thªad
;

603 
bkey
 
	mgc_d⁄e
;

609 
	mgc_m¨k_vÆid
;

612 
©omic_t
 
	m£˘‹s_to_gc
;

614 
waô_queue_hód_t
 
	mmovög_gc_waô
;

615 
keybuf
 
	mmovög_gc_keys
;

617 
£m≠h‹e
 
	mmovög_ö_Êight
;

619 
w‹kqueue_°ru˘
 *
	mmovög_gc_wq
;

621 
båì
 *
	mroŸ
;

623 #ifde‡
CONFIG_BCACHE_DEBUG


624 
båì
 *
	mvîify_d©a
;

625 
b£t
 *
	mvîify_⁄disk
;

626 
muãx
 
	mvîify_lock
;

629 
	mƒ_uuids
;

630 
uuid_íåy
 *
	muuids
;

631 
BKEY_PADDED
(
uuid_buckë
);

632 
˛osuª
 
	muuid_wrôe
;

633 
£m≠h‹e
 
	muuid_wrôe_muãx
;

639 
mempoﬁ_t
 *
	mfûl_ôî
;

641 
b£t_s‹t_°©e
 
	ms‹t
;

644 
li°_hód
 
	md©a_buckës
;

645 
•ölock_t
 
	md©a_buckë_lock
;

647 
jou∫Æ
 
	mjou∫Æ
;

649 
	#CONGESTED_MAX
 1024

	)

650 
	mc⁄ge°ed_œ°_us
;

651 
©omic_t
 
	mc⁄ge°ed
;

654 
	mc⁄ge°ed_ªad_thªshﬁd_us
;

655 
	mc⁄ge°ed_wrôe_thªshﬁd_us
;

657 
time_°©s
 
	mbåì_gc_time
;

658 
time_°©s
 
	mbåì_•lô_time
;

659 
time_°©s
 
	mbåì_ªad_time
;

661 
©omic_l⁄g_t
 
	mˇche_ªad_ø˚s
;

662 
©omic_l⁄g_t
 
	mwrôeback_keys_d⁄e
;

663 
©omic_l⁄g_t
 
	mwrôeback_keys_Áûed
;

666 
	mON_ERROR_UNREGISTER
,

667 
	mON_ERROR_PANIC
,

668 } 
	m⁄_îr‹
;

669 
	mîr‹_limô
;

670 
	mîr‹_deˇy
;

672 
	mjou∫Æ_dñay_ms
;

673 
boﬁ
 
	mex≥nsive_debug_checks
;

674 
	mvîify
:1;

675 
	mkey_mîgög_dißbÀd
:1;

676 
	mgc_Æways_ªwrôe
:1;

677 
	mshrökî_dißbÀd
:1;

678 
	mc›y_gc_íabÀd
:1;

680 
	#BUCKET_HASH_BITS
 12

	)

681 
hli°_hód
 
	mbuckë_hash
[1 << 
BUCKET_HASH_BITS
];

684 
	sbbio
 {

685 
	msubmô_time_us
;

687 
bkey
 
	mkey
;

688 
uöt64_t
 
	m_∑d
[3];

694 
bio
 
	mbio
;

697 
	#BTREE_PRIO
 
USHRT_MAX


	)

698 
	#INITIAL_PRIO
 32768U

	)

700 
	#båì_byãs
(
c
Ë((c)->
båì_∑ges
 * 
PAGE_SIZE
)

	)

701 
	#båì_blocks
(
b
) \

702 ((Ë(
	`KEY_SIZE
(&
b
->
key
Ë>> (b)->
c
->
block_bôs
))

	)

704 
	#båì_deÁu…_blocks
(
c
) \

705 ((Ë((
PAGE_SECTORS
 * (
c
)->
båì_∑ges
Ë>> (c)->
block_bôs
))

	)

707 
	#buckë_∑ges
(
c
Ë((c)->
sb
.
buckë_size
 / 
PAGE_SECTORS
)

	)

708 
	#buckë_byãs
(
c
Ë((c)->
sb
.
buckë_size
 << 9)

	)

709 
	#block_byãs
(
c
Ë((c)->
sb
.
block_size
 << 9)

	)

711 
	#¥ios_≥r_buckë
(
c
) \

712 ((
	`buckë_byãs
(
c
Ë- (
¥io_£t
)) / \

713 (
buckë_disk
))

	)

714 
	#¥io_buckës
(
c
) \

715 
	`DIV_ROUND_UP
((
size_t
Ë(
c
)->
sb
.
nbuckës
, 
	`¥ios_≥r_buckë
(c))

	)

717 
ölöe
 
size_t
 
	$£˘‹_to_buckë
(
ˇche_£t
 *
c
, 
£˘‹_t
 
s
)

719  
s
 >> 
c
->
buckë_bôs
;

720 
	}
}

722 
ölöe
 
£˘‹_t
 
	$buckë_to_£˘‹
(
ˇche_£t
 *
c
, 
size_t
 
b
)

724  ((
£˘‹_t
Ë
b
Ë<< 
c
->
buckë_bôs
;

725 
	}
}

727 
ölöe
 
£˘‹_t
 
	$buckë_ªmaödî
(
ˇche_£t
 *
c
, 
£˘‹_t
 
s
)

729  
s
 & (
c
->
sb
.
buckë_size
 - 1);

730 
	}
}

732 
ölöe
 
ˇche
 *
	$PTR_CACHE
(
ˇche_£t
 *
c
,

733 c⁄° 
bkey
 *
k
,

734 
±r
)

736  
c
->
ˇche
[
	`PTR_DEV
(
k
, 
±r
)];

737 
	}
}

739 
ölöe
 
size_t
 
	$PTR_BUCKET_NR
(
ˇche_£t
 *
c
,

740 c⁄° 
bkey
 *
k
,

741 
±r
)

743  
	`£˘‹_to_buckë
(
c
, 
	`PTR_OFFSET
(
k
, 
±r
));

744 
	}
}

746 
ölöe
 
buckë
 *
	$PTR_BUCKET
(
ˇche_£t
 *
c
,

747 c⁄° 
bkey
 *
k
,

748 
±r
)

750  
	`PTR_CACHE
(
c
, 
k
, 
±r
)->
buckës
 + 
	`PTR_BUCKET_NR
(c, k,Ötr);

751 
	}
}

753 
ölöe
 
uöt8_t
 
	$gí_a·î
(
uöt8_t
 
a
, uöt8_à
b
)

755 
uöt8_t
 
r
 = 
a
 - 
b
;

756  
r
 > 128U ? 0 :Ñ;

757 
	}
}

759 
ölöe
 
uöt8_t
 
	$±r_°Æe
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
,

760 
i
)

762  
	`gí_a·î
(
	`PTR_BUCKET
(
c
, 
k
, 
i
)->
gí
, 
	`PTR_GEN
(k, i));

763 
	}
}

765 
ölöe
 
boﬁ
 
	$±r_avaûabÀ
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
,

766 
i
)

768  (
	`PTR_DEV
(
k
, 
i
Ë< 
MAX_CACHES_PER_SET
Ë&& 
	`PTR_CACHE
(
c
, k, i);

769 
	}
}

777 
	#csum_£t
(
i
) \

778 
	`bch_¸c64
(((*Ë(
i
)Ë+ (
uöt64_t
), \

779 ((*Ë
	`b£t_bkey_œ°
(
i
)) - \

780 (((*Ë(
i
)Ë+ (
uöt64_t
)))

	)

784 
	#båì_bug
(
b
, ...) \

786 i‡(
	`bch_ˇche_£t_îr‹
((
b
)->
c
, 
__VA_ARGS__
)) \

787 
	`dump_°ack
(); \

788 } 0)

	)

790 
	#ˇche_bug
(
c
, ...) \

792 i‡(
	`bch_ˇche_£t_îr‹
(
c
, 
__VA_ARGS__
)) \

793 
	`dump_°ack
(); \

794 } 0)

	)

796 
	#båì_bug_⁄
(
c⁄d
, 
b
, ...) \

798 i‡(
c⁄d
) \

799 
	`båì_bug
(
b
, 
__VA_ARGS__
); \

800 } 0)

	)

802 
	#ˇche_bug_⁄
(
c⁄d
, 
c
, ...) \

804 i‡(
c⁄d
) \

805 
	`ˇche_bug
(
c
, 
__VA_ARGS__
); \

806 } 0)

	)

808 
	#ˇche_£t_îr_⁄
(
c⁄d
, 
c
, ...) \

810 i‡(
c⁄d
) \

811 
	`bch_ˇche_£t_îr‹
(
c
, 
__VA_ARGS__
); \

812 } 0)

	)

816 
	#f‹_óch_ˇche
(
ˇ
, 
cs
, 
ôî
) \

817 
ôî
 = 0; 
ˇ
 = 
cs
->
ˇche
[ôî], iã∏< (cs)->
sb
.
ƒ_ö_£t
; iãr++)

	)

819 
	#f‹_óch_buckë
(
b
, 
ˇ
) \

820 
b
 = (
ˇ
)->
buckës
 + (ˇ)->
sb
.
fú°_buckë
; \

821 
b
 < (
ˇ
)->
buckës
 + (ˇ)->
sb
.
nbuckës
; b++)

	)

823 
ölöe
 
	$ˇched_dev_put
(
ˇched_dev
 *
dc
)

825 i‡(
	`©omic_dec_™d_ã°
(&
dc
->
cou¡
))

826 
	`scheduÀ_w‹k
(&
dc
->
dëach
);

827 
	}
}

829 
ölöe
 
boﬁ
 
	$ˇched_dev_gë
(
ˇched_dev
 *
dc
)

831 i‡(!
	`©omic_öc_nŸ_zîo
(&
dc
->
cou¡
))

832  
Ál£
;

835 
	`smp_mb__a·î_©omic
();

836  
åue
;

837 
	}
}

844 
ölöe
 
uöt8_t
 
	$buckë_gc_gí
(
buckë
 *
b
)

846  
b
->
gí
 - b->
œ°_gc
;

847 
	}
}

849 
	#BUCKET_GC_GEN_MAX
 96U

	)

851 
	#kobj_©åibuã_wrôe
(
n
, 
‚
) \

852 
kobj_©åibuã
 
ksysfs_
##
n
 = 
	`__ATTR
“, 
S_IWUSR
, 
NULL
, 
‚
)

	)

854 
	#kobj_©åibuã_rw
(
n
, 
show
, 
°‹e
) \

855 
kobj_©åibuã
 
ksysfs_
##
n
 = \

856 
	`__ATTR
(
n
, 
S_IWUSR
|
S_IRUSR
, 
show
, 
°‹e
)

	)

858 
ölöe
 
	$wake_up_Æloˇt‹s
(
ˇche_£t
 *
c
)

860 
ˇche
 *
ˇ
;

861 
i
;

863 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

864 
	`wake_up_¥o˚ss
(
ˇ
->
Æloc_thªad
);

865 
	}
}

869 
bch_cou¡_io_îr‹s
(
ˇche
 *, , const *);

870 
bch_bbio_cou¡_io_îr‹s
(
ˇche_£t
 *, 
bio
 *,

872 
bch_bbio_ídio
(
ˇche_£t
 *, 
bio
 *, , const *);

873 
bch_bbio_‰ì
(
bio
 *, 
ˇche_£t
 *);

874 
bio
 *
bch_bbio_Æloc
(
ˇche_£t
 *);

876 
bch_gíîic_make_ªque°
(
bio
 *, 
bio_•lô_poﬁ
 *);

877 
__bch_submô_bbio
(
bio
 *, 
ˇche_£t
 *);

878 
bch_submô_bbio
(
bio
 *, 
ˇche_£t
 *, 
bkey
 *, );

880 
uöt8_t
 
bch_öc_gí
(
ˇche
 *, 
buckë
 *);

881 
bch_ªsˇÀ_¥i‹ôõs
(
ˇche_£t
 *, );

883 
boﬁ
 
bch_ˇn_övÆid©e_buckë
(
ˇche
 *, 
buckë
 *);

884 
__bch_övÆid©e_⁄e_buckë
(
ˇche
 *, 
buckë
 *);

886 
__bch_buckë_‰ì
(
ˇche
 *, 
buckë
 *);

887 
bch_buckë_‰ì
(
ˇche_£t
 *, 
bkey
 *);

889 
bch_buckë_Æloc
(
ˇche
 *, , 
boﬁ
);

890 
__bch_buckë_Æloc_£t
(
ˇche_£t
 *, ,

891 
bkey
 *, , 
boﬁ
);

892 
bch_buckë_Æloc_£t
(
ˇche_£t
 *, ,

893 
bkey
 *, , 
boﬁ
);

894 
boﬁ
 
bch_Æloc_£˘‹s
(
ˇche_£t
 *, 
bkey
 *, ,

895 , , 
boﬁ
);

897 
	$__¥ötf
(2, 3)

898 
boﬁ
 
	`bch_ˇche_£t_îr‹
(
ˇche_£t
 *, const *, ...);

900 
	`bch_¥io_wrôe
(
ˇche
 *);

901 
	`bch_wrôe_bdev_su≥r
(
ˇched_dev
 *, 
˛osuª
 *);

903 
w‹kqueue_°ru˘
 *
bˇche_wq
;

904 c⁄° * c⁄° 
bch_ˇche_modes
[];

905 
muãx
 
bch_ªgi°î_lock
;

906 
li°_hód
 
bch_ˇche_£ts
;

908 
kobj_ty≥
 
bch_ˇched_dev_kty≥
;

909 
kobj_ty≥
 
bch_Êash_dev_kty≥
;

910 
kobj_ty≥
 
bch_ˇche_£t_kty≥
;

911 
kobj_ty≥
 
bch_ˇche_£t_öã∫Æ_kty≥
;

912 
kobj_ty≥
 
bch_ˇche_kty≥
;

914 
	`bch_ˇched_dev_ªÀa£
(
kobje˘
 *);

915 
	`bch_Êash_dev_ªÀa£
(
kobje˘
 *);

916 
	`bch_ˇche_£t_ªÀa£
(
kobje˘
 *);

917 
	`bch_ˇche_ªÀa£
(
kobje˘
 *);

919 
	`bch_uuid_wrôe
(
ˇche_£t
 *);

920 
	`bˇche_wrôe_su≥r
(
ˇche_£t
 *);

922 
	`bch_Êash_dev_¸óã
(
ˇche_£t
 *
c
, 
uöt64_t
 
size
);

924 
	`bch_ˇched_dev_©èch
(
ˇched_dev
 *, 
ˇche_£t
 *);

925 
	`bch_ˇched_dev_dëach
(
ˇched_dev
 *);

926 
	`bch_ˇched_dev_run
(
ˇched_dev
 *);

927 
	`bˇche_devi˚_°›
(
bˇche_devi˚
 *);

929 
	`bch_ˇche_£t_uƒegi°î
(
ˇche_£t
 *);

930 
	`bch_ˇche_£t_°›
(
ˇche_£t
 *);

932 
ˇche_£t
 *
	`bch_ˇche_£t_Æloc
(
ˇche_sb
 *);

933 
	`bch_båì_ˇche_‰ì
(
ˇche_£t
 *);

934 
	`bch_båì_ˇche_Æloc
(
ˇche_£t
 *);

935 
	`bch_movög_öô_ˇche_£t
(
ˇche_£t
 *);

936 
	`bch_›í_buckës_Æloc
(
ˇche_£t
 *);

937 
	`bch_›í_buckës_‰ì
(
ˇche_£t
 *);

939 
	`bch_ˇche_Æloˇt‹_°¨t
(
ˇche
 *
ˇ
);

941 
	`bch_debug_exô
();

942 
	`bch_debug_öô
(
kobje˘
 *);

943 
	`bch_ªque°_exô
();

944 
	`bch_ªque°_öô
();

	@bcache/bcache.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x61b7b126, 
__VMLINUX_SYMBOL_STR
(
sim∂e_°πouŒ
) },

24 { 0x964b601a, 
__VMLINUX_SYMBOL_STR
(
kobje˘_put
) },

25 { 0x9822c0cb, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_disˇrd
) },

26 { 0x53326531, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_∑ges
) },

27 { 0x2d3385d3, 
__VMLINUX_SYMBOL_STR
(
sy°em_wq
) },

28 { 0xeb594c85, 
__VMLINUX_SYMBOL_STR
(
bio_•lô
) },

29 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

30 { 0xe˚a2194, 
__VMLINUX_SYMBOL_STR
(
∑π_round_°©s
) },

31 { 0x262f20a8, 
__VMLINUX_SYMBOL_STR
(
loˇl_˛ock
) },

32 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

33 { 0x71ccd88e, 
__VMLINUX_SYMBOL_STR
(
kobje˘_gë
) },

34 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

35 { 0xó38ada, 
__VMLINUX_SYMBOL_STR
(
≥rf_ç_evít
) },

36 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
gë_£c⁄ds
) },

37 { 0x„a376d0, 
__VMLINUX_SYMBOL_STR
(
Æloc_disk
) },

38 { 0x5876c094, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

39 { 0x26f9f3d6, 
__VMLINUX_SYMBOL_STR
(
blk_˛ónup_queue
) },

40 { 0x96d19383, 
__VMLINUX_SYMBOL_STR
(
__bªad
) },

41 { 0x4c4„f19, 
__VMLINUX_SYMBOL_STR
(
kî√l_°ack
) },

42 { 0x3d69f5a0, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

43 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

44 { 0xb5c51be8, 
__VMLINUX_SYMBOL_STR
(
debugfs_¸óã_dú
) },

45 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

46 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
°æí
) },

47 { 0xc29bf967, 
__VMLINUX_SYMBOL_STR
(
°r•n
) },

48 { 0xc7a1840e, 
__VMLINUX_SYMBOL_STR
(
Œi°_add_b©ch
) },

49 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

50 { 0xc8b57c27, 
__VMLINUX_SYMBOL_STR
(
aut‹emove_wake_fun˘i⁄
) },

51 { 0x79Ø04a2, 
__VMLINUX_SYMBOL_STR
(
gë_øndom_byãs
) },

52 { 0x4e68e9be, 
__VMLINUX_SYMBOL_STR
(
rb_√xt_po°‹dî
) },

53 { 0x7756˚d9, 
__VMLINUX_SYMBOL_STR
(
downgøde_wrôe
) },

54 { 0x˚6693ˇ, 
__VMLINUX_SYMBOL_STR
(
bd_lök_disk_hﬁdî
) },

55 { 0x7ab88a45, 
__VMLINUX_SYMBOL_STR
(
sy°em_‰ìzög_˙t
) },

56 { 0x20000329, 
__VMLINUX_SYMBOL_STR
(
sim∂e_°πoul
) },

57 { 0xc0a3d105, 
__VMLINUX_SYMBOL_STR
(
föd_√xt_bô
) },

58 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

59 { 0x5e8ba93e, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_fûes
) },

60 { 0xf087137d, 
__VMLINUX_SYMBOL_STR
(
__dy«mic_¥_debug
) },

61 { 0xì91879b, 
__VMLINUX_SYMBOL_STR
(
rb_fú°_po°‹dî
) },

62 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

63 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

64 { 0x797c8Á9, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k_sync
) },

65 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

66 { 0xb573114a, 
__VMLINUX_SYMBOL_STR
(
ida_sim∂e_gë
) },

67 { 0xb7067e8, 
__VMLINUX_SYMBOL_STR
(
bio_adv™˚
) },

68 { 0x703dfdb2, 
__VMLINUX_SYMBOL_STR
(
kobje˘_dñ
) },

69 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

70 { 0x131916df, 
__VMLINUX_SYMBOL_STR
(
debugfs_¸óã_fûe
) },

71 { 0x7a2af7b4, 
__VMLINUX_SYMBOL_STR
(
˝u_numbî
) },

72 { 0xÁ4f7eb4, 
__VMLINUX_SYMBOL_STR
(
blk_queue_Êush
) },

73 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

74 { 0xd48c3f21, 
__VMLINUX_SYMBOL_STR
(
debugfs_ªmove_ªcursive
) },

75 { 0x880519c1, 
__VMLINUX_SYMBOL_STR
(
kthªad_¸óã_⁄_node
) },

76 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

77 { 0x9eda469c, 
__VMLINUX_SYMBOL_STR
(
lookup_bdev
) },

78 { 0xecd85ddb, 
__VMLINUX_SYMBOL_STR
(
bio_ídio_nodec
) },

79 { 0xcf2786a9, 
__VMLINUX_SYMBOL_STR
(
muãx_åylock
) },

80 { 0xf96cc7e, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

81 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

82 { 0x64Ø2bb6, 
__VMLINUX_SYMBOL_STR
(
kobje˘_¸óã_™d_add
) },

83 { 0x2b5ad4ì, 
__VMLINUX_SYMBOL_STR
(
down_wrôe_åylock
) },

84 { 0x733c3b54, 
__VMLINUX_SYMBOL_STR
(
ka•rötf
) },

85 { 0xe˚784c2, 
__VMLINUX_SYMBOL_STR
(
rb_fú°
) },

86 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

87 { 0x4f8b5ddb, 
__VMLINUX_SYMBOL_STR
(
_c›y_to_u£r
) },

88 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

89 { 0xc3639d5e, 
__VMLINUX_SYMBOL_STR
(
bio_ª£t
) },

90 { 0xd5f2172f, 
__VMLINUX_SYMBOL_STR
(
dñ_timî_sync
) },

91 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

92 { 0x33b7a697, 
__VMLINUX_SYMBOL_STR
(
åa˚_deföe_fõld
) },

93 { 0x2a4dcf38, 
__VMLINUX_SYMBOL_STR
(
·ø˚_evít_buf„r_commô
) },

94 { 0xf8c0f16e, 
__VMLINUX_SYMBOL_STR
(
__blkdev_drivî_io˘l
) },

95 { 0xe693f9c5, 
__VMLINUX_SYMBOL_STR
(
bio_öô
) },

96 { 0x5991219c, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k
) },

97 { 0x3721cc78, 
__VMLINUX_SYMBOL_STR
(
bd_u∆ök_disk_hﬁdî
) },

98 { 0xfc˚2ebd, 
__VMLINUX_SYMBOL_STR
(
blk_Æloc_queue
) },

99 { 0x11089ac7, 
__VMLINUX_SYMBOL_STR
(
_˘y≥
) },

100 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

101 { 0x7fde6769, 
__VMLINUX_SYMBOL_STR
(
‰ìzög_¶ow_∑th
) },

102 { 0x37befc70, 
__VMLINUX_SYMBOL_STR
(
jiffõs_to_m£cs
) },

103 { 0xf147ecb1, 
__VMLINUX_SYMBOL_STR
(
down_åylock
) },

104 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

105 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

106 { 0x30976d5f, 
__VMLINUX_SYMBOL_STR
(
kthªad_°›
) },

107 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

108 { 0x44b58df0, 
__VMLINUX_SYMBOL_STR
(
dñ_gídisk
) },

109 { 0x7c1372e8, 
__VMLINUX_SYMBOL_STR
(
∑nic
) },

110 { 0x4c9d28b0, 
__VMLINUX_SYMBOL_STR
(
phys_ba£
) },

111 { 0xd3249e1, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_Á°
) },

112 { 0xìf9bff6, 
__VMLINUX_SYMBOL_STR
(
ida_sim∂e_ªmove
) },

113 { 0x479c3c86, 
__VMLINUX_SYMBOL_STR
(
föd_√xt_zîo_bô
) },

114 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

115 { 0x4d9b652b, 
__VMLINUX_SYMBOL_STR
(
rb_îa£
) },

116 { 0xafb0f5d2, 
__VMLINUX_SYMBOL_STR
(
blkdev_gë_by_∑th
) },

117 { 0xd985dc99, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_∑ges
) },

118 { 0x50410d4e, 
__VMLINUX_SYMBOL_STR
(
debugfs_ªmove
) },

119 { 0xbf8ba54a, 
__VMLINUX_SYMBOL_STR
(
v¥ötk
) },

120 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_nuŒ
) },

121 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

122 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

123 { 0x68aˇ4ad, 
__VMLINUX_SYMBOL_STR
(
down
) },

124 { 0x71a50dbc, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_blkdev
) },

125 { 0xbe2c0274, 
__VMLINUX_SYMBOL_STR
(
add_timî
) },

126 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

127 { 0x27edb51, 
__VMLINUX_SYMBOL_STR
(
sysfs_ªmove_lök
) },

128 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

129 { 0xe3a53f4c, 
__VMLINUX_SYMBOL_STR
(
s‹t
) },

130 { 0x6e5db7e4, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

131 { 0x95eb8512, 
__VMLINUX_SYMBOL_STR
(
kobje˘_add
) },

132 { 0x2ed55c8e, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

133 { 0xf09de776, 
__VMLINUX_SYMBOL_STR
(
gë_øndom_öt
) },

134 { 0xˇ8c76e1, 
__VMLINUX_SYMBOL_STR
(
__gë_∑ge_èû
) },

135 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

136 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

137 { 0x992814f4, 
__VMLINUX_SYMBOL_STR
(
kobje˘_uevít_ív
) },

138 { 0x9f46˚d8, 
__VMLINUX_SYMBOL_STR
(
__sw_hweight64
) },

139 { 0xaf6´696, 
__VMLINUX_SYMBOL_STR
(
k°∫dup
) },

140 { 0xf11543ff, 
__VMLINUX_SYMBOL_STR
(
föd_fú°_zîo_bô
) },

141 { 0xac1a55be, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_ªboŸ_nŸifõr
) },

142 { 0xb5a459dc, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_blkdev
) },

143 { 0xf8d7a305, 
__VMLINUX_SYMBOL_STR
(
·ø˚_evít_ªg
) },

144 { 0x210fd9b, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_lök
) },

145 { 0xbe0498f3, 
__VMLINUX_SYMBOL_STR
(
moduÀ_put
) },

146 { 0x63d68f9d, 
__VMLINUX_SYMBOL_STR
(
submô_bio
) },

147 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

148 { 0x48dc4149, 
__VMLINUX_SYMBOL_STR
(
__‰ì_∑ges
) },

149 { 0x8f54„7e, 
__VMLINUX_SYMBOL_STR
(
blkdev_put
) },

150 { 0x45ba5804, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_shrökî
) },

151 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

152 { 0xdd22209, 
__VMLINUX_SYMBOL_STR
(
fs_kobj
) },

153 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

154 { 0x3517383e, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_ªboŸ_nŸifõr
) },

155 { 0x2d´a771, 
__VMLINUX_SYMBOL_STR
(
blk_queue_make_ªque°
) },

156 { 0x93fˇ811, 
__VMLINUX_SYMBOL_STR
(
__gë_‰ì_∑ges
) },

157 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

158 { 0x3bd1b1f6, 
__VMLINUX_SYMBOL_STR
(
m£cs_to_jiffõs
) },

159 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

160 { 0xd62c833f, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout
) },

161 { 0xa202a8e5, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_‹dî_åa˚
) },

162 { 0x68edcc89, 
__VMLINUX_SYMBOL_STR
(
put_disk
) },

163 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

164 { 0x155cb2eb, 
__VMLINUX_SYMBOL_STR
(
bio£t_¸óã
) },

165 { 0x6b2dc060, 
__VMLINUX_SYMBOL_STR
(
dump_°ack
) },

166 { 0x4482cdb, 
__VMLINUX_SYMBOL_STR
(
__ª‰igî©‹
) },

167 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

168 { 0xb678366f, 
__VMLINUX_SYMBOL_STR
(
öt_sqπ
) },

169 { 0x507dÁ5c, 
__VMLINUX_SYMBOL_STR
(
wake_up_¥o˚ss
) },

170 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

171 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

172 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

173 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

174 { 0x3928e„9, 
__VMLINUX_SYMBOL_STR
(
__≥r_˝u_off£t
) },

175 { 0x556a4898, 
__VMLINUX_SYMBOL_STR
(
·ø˚_evít_buf„r_ª£rve
) },

176 { 0xa5526619, 
__VMLINUX_SYMBOL_STR
(
rb_ö£π_cﬁ‹
) },

177 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

178 { 0x9c0404c1, 
__VMLINUX_SYMBOL_STR
(
__moduÀ_gë
) },

179 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
‰ì_∑ges
) },

180 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

181 { 0x3e652c7d, 
__VMLINUX_SYMBOL_STR
(
evít_åiggîs_ˇŒ
) },

182 { 0xb3f7646e, 
__VMLINUX_SYMBOL_STR
(
kthªad_should_°›
) },

183 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

184 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

185 { 0x7db˚81d, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_∑ges
) },

186 { 0x9c55˚c, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout_öãºu±ibÀ
) },

187 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

188 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

189 { 0xd881702e, 
__VMLINUX_SYMBOL_STR
(
åa˚_evít_øw_öô
) },

190 { 0x5c8b5˚8, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô
) },

191 { 0x53eb9c3, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_shrökî
) },

192 { 0x7f24cd1d, 
__VMLINUX_SYMBOL_STR
(
add_disk
) },

193 { 0x56777a, 
__VMLINUX_SYMBOL_STR
(
kobje˘_öô
) },

194 { 0xe6602e9f, 
__VMLINUX_SYMBOL_STR
(
≥rf_åa˚_buf_¥ï¨e
) },

195 { 0x71e3˚cb, 
__VMLINUX_SYMBOL_STR
(
up
) },

196 { 0x71abd310, 
__VMLINUX_SYMBOL_STR
(
__bio_˛⁄e_Á°
) },

197 { 0x7628f3c7, 
__VMLINUX_SYMBOL_STR
(
this_˝u_off
) },

198 { 0x88c6f˚5, 
__VMLINUX_SYMBOL_STR
(
put_∑ge
) },

199 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

200 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

201 { 0x758a782e, 
__VMLINUX_SYMBOL_STR
(
blk_fûl_rwbs
) },

202 { 0xˇ9360b5, 
__VMLINUX_SYMBOL_STR
(
rb_√xt
) },

203 { 0xb742fd7, 
__VMLINUX_SYMBOL_STR
(
sim∂e_°πﬁ
) },

204 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

205 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢¥ötf
) },

206 { 0x1e3a88fb, 
__VMLINUX_SYMBOL_STR
(
åa˚_£q_¥ötf
) },

207 { 0xb0e602eb, 
__VMLINUX_SYMBOL_STR
(
memmove
) },

208 { 0xa8f9d5a5, 
__VMLINUX_SYMBOL_STR
(
vmÆloc_to_∑ge
) },

209 { 0xf186e58, 
__VMLINUX_SYMBOL_STR
(
£t_blocksize
) },

210 { 0x77bc13a0, 
__VMLINUX_SYMBOL_STR
(
°rim
) },

211 { 0x53219ì8, 
__VMLINUX_SYMBOL_STR
(
bio_c›y_d©a
) },

212 { 0xd7e56a4e, 
__VMLINUX_SYMBOL_STR
(
sim∂e_°πﬁl
) },

213 { 0xdf2c2742, 
__VMLINUX_SYMBOL_STR
(
rb_œ°
) },

214 { 0x869526c5, 
__VMLINUX_SYMBOL_STR
(
zîo_fûl_bio
) },

215 { 0x6ab31aba, 
__VMLINUX_SYMBOL_STR
(
bio£t_‰ì
) },

216 { 0x624˚36c, 
__VMLINUX_SYMBOL_STR
(
·ø˚_øw_ouçut_¥ï
) },

217 { 0xa88bd3e3, 
__VMLINUX_SYMBOL_STR
(
__öô_rw£m
) },

218 { 0x8ó31722, 
__VMLINUX_SYMBOL_STR
(
åy_moduÀ_gë
) },

219 { 0x7c2d098f, 
__VMLINUX_SYMBOL_STR
(
kªÆloc
) },

220 { 0x6c07d933, 
__VMLINUX_SYMBOL_STR
(
add_uevít_v¨
) },

223 c⁄° 
	g__moduÀ_dïíds
[]

224 
__u£d


225 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

229 
MODULE_INFO
(
§cvîsi⁄
, "FFCCF8C8C32D31086349BD6");

	@bcache/bset.c

8 
	#¥_fmt
(
fmt
Ë"bˇche: %s(Ë" fmà"\n", 
__func__


	)

10 
	~"utû.h
"

11 
	~"b£t.h
"

13 
	~<löux/c⁄sﬁe.h
>

14 
	~<löux/øndom.h
>

15 
	~<löux/¥e„tch.h
>

17 #ifde‡
CONFIG_BCACHE_DEBUG


19 
	$bch_dump_b£t
(
båì_keys
 *
b
, 
b£t
 *
i
, 
£t
)

21 
bkey
 *
k
, *
√xt
;

23 
k
 = 
i
->
°¨t
; k < 
	`b£t_bkey_œ°
(i); k = 
√xt
) {

24 
√xt
 = 
	`bkey_√xt
(
k
);

26 
	`¥ötk
(
KERN_ERR
 "block %u key %u/%u: ", 
£t
,

27 (Ë((
u64
 *Ë
k
 - 
i
->
d
), i->
keys
);

29 i‡(
b
->
›s
->
key_dump
)

30 
b
->
›s
->
	`key_dump
(b, 
k
);

32 
	`¥ötk
("%Œu:%Œu\n", 
	`KEY_INODE
(
k
), 
	`KEY_OFFSET
(k));

34 i‡(
√xt
 < 
	`b£t_bkey_œ°
(
i
) &&

35 
	`bkey_cmp
(
k
, 
b
->
›s
->
is_exã¡s
 ?

36 &
	`START_KEY
(
√xt
) :Çext) > 0)

37 
	`¥ötk
(
KERN_ERR
 "Key skipped backwards\n");

39 
	}
}

41 
	$bch_dump_buckë
(
båì_keys
 *
b
)

43 
i
;

45 
	`c⁄sﬁe_lock
();

46 
i
 = 0; i <
b
->
n£ts
; i++)

47 
	`bch_dump_b£t
(
b
, b->
£t
[
i
].
d©a
,

48 
	`b£t_£˘‹_off£t
(
b
, b->
£t
[
i
].
d©a
));

49 
	`c⁄sﬁe_u∆ock
();

50 
	}
}

52 
	$__bch_cou¡_d©a
(
båì_keys
 *
b
)

54 
ªt
 = 0;

55 
båì_ôî
 
ôî
;

56 
bkey
 *
k
;

58 i‡(
b
->
›s
->
is_exã¡s
)

59 
	`f‹_óch_key
(
b
, 
k
, &
ôî
)

60 
ªt
 +
	`KEY_SIZE
(
k
);

61  
ªt
;

62 
	}
}

64 
	$__bch_check_keys
(
båì_keys
 *
b
, c⁄° *
fmt
, ...)

66 
va_li°
 
¨gs
;

67 
bkey
 *
k
, *
p
 = 
NULL
;

68 
båì_ôî
 
ôî
;

69 c⁄° *
îr
;

71 
	`f‹_óch_key
(
b
, 
k
, &
ôî
) {

72 i‡(
b
->
›s
->
is_exã¡s
) {

73 
îr
 = "Keys out of order";

74 i‡(
p
 && 
	`bkey_cmp
(&
	`START_KEY
’), &START_KEY(
k
)) > 0)

75 
bug
;

77 i‡(
	`bch_±r_övÆid
(
b
, 
k
))

80 
îr
 = "Overlapping keys";

81 i‡(
p
 && 
	`bkey_cmp
’, &
	`START_KEY
(
k
)) > 0)

82 
bug
;

84 i‡(
	`bch_±r_bad
(
b
, 
k
))

87 
îr
 = "Duplicate keys";

88 i‡(
p
 && !
	`bkey_cmp
’, 
k
))

89 
bug
;

91 
p
 = 
k
;

94 
îr
 = "KeyÜargerÅhan btreeÇode key";

95 i‡(
p
 && 
	`bkey_cmp
’, &
b
->
key
) > 0)

96 
bug
;

99 
bug
:

100 
	`bch_dump_buckë
(
b
);

102 
	`va_°¨t
(
¨gs
, 
fmt
);

103 
	`v¥ötk
(
fmt
, 
¨gs
);

104 
	`va_íd
(
¨gs
);

106 
	`∑nic
("bch_check_key†îr‹: %s:\n", 
îr
);

107 
	}
}

109 
	$bch_båì_ôî_√xt_check
(
båì_ôî
 *
ôî
)

111 
bkey
 *
k
 = 
ôî
->
d©a
->k, *
√xt
 = 
	`bkey_√xt
(k);

113 i‡(
√xt
 < 
ôî
->
d©a
->
íd
 &&

114 
	`bkey_cmp
(
k
, 
ôî
->
b
->
›s
->
is_exã¡s
 ?

115 &
	`START_KEY
(
√xt
) :Çext) > 0) {

116 
	`bch_dump_buckë
(
ôî
->
b
);

117 
	`∑nic
("Key skipped backwards\n");

119 
	}
}

123 
ölöe
 
	$bch_båì_ôî_√xt_check
(
båì_ôî
 *
ôî
Ë{
	}
}

129 
	$__bch_keyli°_ªÆloc
(
keyli°
 *
l
, 
u64s
)

131 
size_t
 
ﬁdsize
 = 
	`bch_keyli°_nkeys
(
l
);

132 
size_t
 
√wsize
 = 
ﬁdsize
 + 
u64s
;

133 
uöt64_t
 *
ﬁd_keys
 = 
l
->
keys_p
 =l->
ölöe_keys
 ? 
NULL
 :Ü->keys_p;

134 
uöt64_t
 *
√w_keys
;

136 
√wsize
 = 
	`roundup_pow_of_two
(newsize);

138 i‡(
√wsize
 <
KEYLIST_INLINE
 ||

139 
	`roundup_pow_of_two
(
ﬁdsize
Ë=
√wsize
)

142 
√w_keys
 = 
	`kªÆloc
(
ﬁd_keys
, (
uöt64_t
Ë* 
√wsize
, 
GFP_NOIO
);

144 i‡(!
√w_keys
)

145  -
ENOMEM
;

147 i‡(!
ﬁd_keys
)

148 
	`mem˝y
(
√w_keys
, 
l
->
ölöe_keys
, (
uöt64_t
Ë* 
ﬁdsize
);

150 
l
->
keys_p
 = 
√w_keys
;

151 
l
->
t›_p
 = 
√w_keys
 + 
ﬁdsize
;

154 
	}
}

156 
bkey
 *
	$bch_keyli°_p›
(
keyli°
 *
l
)

158 
bkey
 *
k
 = 
l
->
keys
;

160 i‡(
k
 =
l
->
t›
)

161  
NULL
;

163 
	`bkey_√xt
(
k
Ë!
l
->
t›
)

164 
k
 = 
	`bkey_√xt
(k);

166  
l
->
t›
 = 
k
;

167 
	}
}

169 
	$bch_keyli°_p›_‰⁄t
(
keyli°
 *
l
)

171 
l
->
t›_p
 -
	`bkey_u64s
÷->
keys
);

173 
	`memmove
(
l
->
keys
,

174 
	`bkey_√xt
(
l
->
keys
),

175 
	`bch_keyli°_byãs
(
l
));

176 
	}
}

180 
	$bch_bkey_c›y_sögÀ_±r
(
bkey
 *
de°
, c⁄° bkey *
§c
,

181 
i
)

183 
	`BUG_ON
(
i
 > 
	`KEY_PTRS
(
§c
));

186 
	`mem˝y
(
de°
, 
§c
, 2 * (
uöt64_t
));

187 
de°
->
±r
[0] = 
§c
->±r[
i
];

188 
	`SET_KEY_PTRS
(
de°
, 1);

190 
	`SET_KEY_CSUM
(
de°
, 0);

191 
	}
}

193 
boﬁ
 
	$__bch_cut_‰⁄t
(c⁄° 
bkey
 *
whîe
, bkey *
k
)

195 
i
, 
Àn
 = 0;

197 i‡(
	`bkey_cmp
(
whîe
, &
	`START_KEY
(
k
)) <= 0)

198  
Ál£
;

200 i‡(
	`bkey_cmp
(
whîe
, 
k
) < 0)

201 
Àn
 = 
	`KEY_OFFSET
(
k
Ë- KEY_OFFSET(
whîe
);

203 
	`bkey_c›y_key
(
k
, 
whîe
);

205 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

206 
	`SET_PTR_OFFSET
(
k
, 
i
, 
	`PTR_OFFSET
(k, iË+ 
	`KEY_SIZE
(kË- 
Àn
);

208 
	`BUG_ON
(
Àn
 > 
	`KEY_SIZE
(
k
));

209 
	`SET_KEY_SIZE
(
k
, 
Àn
);

210  
åue
;

211 
	}
}

213 
boﬁ
 
	$__bch_cut_back
(c⁄° 
bkey
 *
whîe
, bkey *
k
)

215 
Àn
 = 0;

217 i‡(
	`bkey_cmp
(
whîe
, 
k
) >= 0)

218  
Ál£
;

220 
	`BUG_ON
(
	`KEY_INODE
(
whîe
Ë!KEY_INODE(
k
));

222 i‡(
	`bkey_cmp
(
whîe
, &
	`START_KEY
(
k
)) > 0)

223 
Àn
 = 
	`KEY_OFFSET
(
whîe
Ë- 
	`KEY_START
(
k
);

225 
	`bkey_c›y_key
(
k
, 
whîe
);

227 
	`BUG_ON
(
Àn
 > 
	`KEY_SIZE
(
k
));

228 
	`SET_KEY_SIZE
(
k
, 
Àn
);

229  
åue
;

230 
	}
}

235 
	#BKEY_MID_BITS
 3

	)

236 
	#BKEY_EXPONENT_BITS
 7

	)

237 
	#BKEY_MANTISSA_BITS
 (32 - 
BKEY_MID_BITS
 - 
BKEY_EXPONENT_BITS
)

	)

238 
	#BKEY_MANTISSA_MASK
 ((1 << 
BKEY_MANTISSA_BITS
Ë- 1)

	)

240 
	sbkey_Êﬂt
 {

241 
	mexp⁄ít
:
BKEY_EXPONENT_BITS
;

242 
	mm
:
BKEY_MID_BITS
;

243 
	mm™tisß
:
BKEY_MANTISSA_BITS
;

244 } 
	g__∑cked
;

261 
	#BSET_CACHELINE
 128

	)

264 
ölöe
 
size_t
 
	$båì_keys_byãs
(
båì_keys
 *
b
)

266  
PAGE_SIZE
 << 
b
->
∑ge_‹dî
;

267 
	}
}

269 
ölöe
 
size_t
 
	$båì_keys_ˇchñöes
(
båì_keys
 *
b
)

271  
	`båì_keys_byãs
(
b
Ë/ 
BSET_CACHELINE
;

272 
	}
}

275 
ölöe
 
size_t
 
	$b£t_åì_byãs
(
båì_keys
 *
b
)

277  
	`båì_keys_ˇchñöes
(
b
Ë* (
bkey_Êﬂt
);

278 
	}
}

281 
ölöe
 
size_t
 
	$b£t_¥ev_byãs
(
båì_keys
 *
b
)

283  
	`båì_keys_ˇchñöes
(
b
Ë* (
uöt8_t
);

284 
	}
}

288 
	$bch_båì_keys_‰ì
(
båì_keys
 *
b
)

290 
b£t_åì
 *
t
 = 
b
->
£t
;

292 i‡(
	`b£t_¥ev_byãs
(
b
Ë< 
PAGE_SIZE
)

293 
	`k‰ì
(
t
->
¥ev
);

295 
	`‰ì_∑ges
((Ë
t
->
¥ev
,

296 
	`gë_‹dî
(
	`b£t_¥ev_byãs
(
b
)));

298 i‡(
	`b£t_åì_byãs
(
b
Ë< 
PAGE_SIZE
)

299 
	`k‰ì
(
t
->
åì
);

301 
	`‰ì_∑ges
((Ë
t
->
åì
,

302 
	`gë_‹dî
(
	`b£t_åì_byãs
(
b
)));

304 
	`‰ì_∑ges
((Ë
t
->
d©a
, 
b
->
∑ge_‹dî
);

306 
t
->
¥ev
 = 
NULL
;

307 
t
->
åì
 = 
NULL
;

308 
t
->
d©a
 = 
NULL
;

309 
	}
}

310 
EXPORT_SYMBOL
(
bch_båì_keys_‰ì
);

312 
	$bch_båì_keys_Æloc
(
båì_keys
 *
b
, 
∑ge_‹dî
, 
gÂ_t
 
gÂ
)

314 
b£t_åì
 *
t
 = 
b
->
£t
;

316 
	`BUG_ON
(
t
->
d©a
);

318 
b
->
∑ge_‹dî
 =Öage_order;

320 
t
->
d©a
 = (*Ë
	`__gë_‰ì_∑ges
(
gÂ
, 
b
->
∑ge_‹dî
);

321 i‡(!
t
->
d©a
)

322 
îr
;

324 
t
->
åì
 = 
	`b£t_åì_byãs
(
b
Ë< 
PAGE_SIZE


325 ? 
	`kmÆloc
(
	`b£t_åì_byãs
(
b
), 
gÂ
)

326 : (*Ë
	`__gë_‰ì_∑ges
(
gÂ
, 
	`gë_‹dî
(
	`b£t_åì_byãs
(
b
)));

327 i‡(!
t
->
åì
)

328 
îr
;

330 
t
->
¥ev
 = 
	`b£t_¥ev_byãs
(
b
Ë< 
PAGE_SIZE


331 ? 
	`kmÆloc
(
	`b£t_¥ev_byãs
(
b
), 
gÂ
)

332 : (*Ë
	`__gë_‰ì_∑ges
(
gÂ
, 
	`gë_‹dî
(
	`b£t_¥ev_byãs
(
b
)));

333 i‡(!
t
->
¥ev
)

334 
îr
;

337 
îr
:

338 
	`bch_båì_keys_‰ì
(
b
);

339  -
ENOMEM
;

340 
	}
}

341 
EXPORT_SYMBOL
(
bch_båì_keys_Æloc
);

343 
	$bch_båì_keys_öô
(
båì_keys
 *
b
, c⁄° 
båì_keys_›s
 *
›s
,

344 
boﬁ
 *
ex≥nsive_debug_checks
)

346 
i
;

348 
b
->
›s
 = ops;

349 
b
->
ex≥nsive_debug_checks
 =Éxpensive_debug_checks;

350 
b
->
n£ts
 = 0;

351 
b
->
œ°_£t_unwrôãn
 = 0;

354 
i
 = 0; i < 
MAX_BSETS
; i++)

355 
b
->
£t
[
i
].
size
 = 0;

360 
i
 = 1; i < 
MAX_BSETS
; i++)

361 
b
->
£t
[
i
].
d©a
 = 
NULL
;

362 
	}
}

363 
EXPORT_SYMBOL
(
bch_båì_keys_öô
);

367 
	$ö‹dî_√xt
(
j
, 
size
)

369 i‡(
j
 * 2 + 1 < 
size
) {

370 
j
 = j * 2 + 1;

372 
j
 * 2 < 
size
)

373 
j
 *= 2;

375 
j
 >>
	`ffz
(j) + 1;

377  
j
;

378 
	}
}

380 
	$ö‹dî_¥ev
(
j
, 
size
)

382 i‡(
j
 * 2 < 
size
) {

383 
j
 = j * 2;

385 
j
 * 2 + 1 < 
size
)

386 
j
 = j * 2 + 1;

388 
j
 >>
	`ffs
(j);

390  
j
;

391 
	}
}

406 
	$__to_ö‹dî
(
j
, 
size
, 
exåa
)

408 
b
 = 
	`Ês
(
j
);

409 
shi·
 = 
	`Ês
(
size
 - 1Ë- 
b
;

411 
j
 ^1U << (
b
 - 1);

412 
j
 <<= 1;

413 
j
 |= 1;

414 
j
 <<
shi·
;

416 i‡(
j
 > 
exåa
)

417 
j
 -(j - 
exåa
) >> 1;

419  
j
;

420 
	}
}

422 
	$to_ö‹dî
(
j
, 
b£t_åì
 *
t
)

424  
	`__to_ö‹dî
(
j
, 
t
->
size
,Å->
exåa
);

425 
	}
}

427 
	$__ö‹dî_to_åì
(
j
, 
size
, 
exåa
)

429 
shi·
;

431 i‡(
j
 > 
exåa
)

432 
j
 +j - 
exåa
;

434 
shi·
 = 
	`ffs
(
j
);

436 
j
 >>
shi·
;

437 
j
 |
	`roundup_pow_of_two
(
size
Ë>> 
shi·
;

439  
j
;

440 
	}
}

442 
	$ö‹dî_to_åì
(
j
, 
b£t_åì
 *
t
)

444  
	`__ö‹dî_to_åì
(
j
, 
t
->
size
,Å->
exåa
);

445 
	}
}

448 
	$ö‹dî_ã°
()

450 
d⁄e
 = 0;

451 
ktime_t
 
°¨t
 = 
	`ktime_gë
();

453 
size
 = 2;

454 
size
 < 65536000;

455 
size
++) {

456 
exåa
 = (
size
 - 
	`rounddown_pow_of_two
(size - 1)) << 1;

457 
i
 = 1, 
j
 = 
	`rounddown_pow_of_two
(
size
 - 1);

459 i‡(!(
size
 % 4096))

460 
	`¥ötk
(
KERN_NOTICE
 "lo› %u, %ŒuÖî us\n", 
size
,

461 
d⁄e
 / 
	`ktime_us_dñè
(
	`ktime_gë
(), 
°¨t
));

464 i‡(
	`__ö‹dî_to_åì
(
i
, 
size
, 
exåa
Ë!
j
)

465 
	`∑nic
("sizê%10u j %10u i %10u", 
size
, 
j
, 
i
);

467 i‡(
	`__to_ö‹dî
(
j
, 
size
, 
exåa
Ë!
i
)

468 
	`∑nic
("sizê%10u j %10u i %10u", 
size
, 
j
, 
i
);

470 i‡(
j
 =
	`rounddown_pow_of_two
(
size
) - 1)

473 
	`BUG_ON
(
	`ö‹dî_¥ev
(
	`ö‹dî_√xt
(
j
, 
size
), size) != j);

475 
j
 = 
	`ö‹dî_√xt
(j, 
size
);

476 
i
++;

479 
d⁄e
 +
size
 - 1;

481 
	}
}

503 
bkey
 *
	$ˇchñöe_to_bkey
(
b£t_åì
 *
t
, 
ˇchñöe
,

504 
off£t
)

506  ((*Ë
t
->
d©a
Ë+ 
ˇchñöe
 * 
BSET_CACHELINE
 + 
off£t
 * 8;

507 
	}
}

509 
	$bkey_to_ˇchñöe
(
b£t_åì
 *
t
, 
bkey
 *
k
)

511  ((*Ë
k
 - (*Ë
t
->
d©a
Ë/ 
BSET_CACHELINE
;

512 
	}
}

514 
	$bkey_to_ˇchñöe_off£t
(
b£t_åì
 *
t
,

515 
ˇchñöe
,

516 
bkey
 *
k
)

518  (
u64
 *Ë
k
 - (u64 *Ë
	`ˇchñöe_to_bkey
(
t
, 
ˇchñöe
, 0);

519 
	}
}

521 
bkey
 *
	$åì_to_bkey
(
b£t_åì
 *
t
, 
j
)

523  
	`ˇchñöe_to_bkey
(
t
, 
	`to_ö‹dî
(
j
,Å),Å->
åì
[j].
m
);

524 
	}
}

526 
bkey
 *
	$åì_to_¥ev_bkey
(
b£t_åì
 *
t
, 
j
)

528  (*Ë(((
uöt64_t
 *Ë
	`åì_to_bkey
(
t
, 
j
)Ë-Å->
¥ev
[j]);

529 
	}
}

535 
bkey
 *
	$èbÀ_to_bkey
(
b£t_åì
 *
t
, 
ˇchñöe
)

537  
	`ˇchñöe_to_bkey
(
t
, 
ˇchñöe
,Å->
¥ev
[cacheline]);

538 
	}
}

540 
ölöe
 
uöt64_t
 
	$shrd128
(
uöt64_t
 
high
, uöt64_à
low
, 
uöt8_t
 
shi·
)

542 
low
 >>
shi·
;

543 
low
 |(
high
 << 1Ë<< (63U - 
shi·
);

544  
low
;

545 
	}
}

547 
ölöe
 
	$bÊﬂt_m™tisß
(c⁄° 
bkey
 *
k
,

548 
bkey_Êﬂt
 *
f
)

550 c⁄° 
uöt64_t
 *
p
 = &
k
->
low
 - (
f
->
exp⁄ít
 >> 6);

551  
	`shrd128
(
p
[-1],Ö[0], 
f
->
exp⁄ít
 & 63Ë& 
BKEY_MANTISSA_MASK
;

552 
	}
}

554 
	$make_bÊﬂt
(
b£t_åì
 *
t
, 
j
)

556 
bkey_Êﬂt
 *
f
 = &
t
->
åì
[
j
];

557 
bkey
 *
m
 = 
	`åì_to_bkey
(
t
, 
j
);

558 
bkey
 *
p
 = 
	`åì_to_¥ev_bkey
(
t
, 
j
);

560 
bkey
 *
l
 = 
	`is_powî_of_2
(
j
)

561 ? 
t
->
d©a
->
°¨t


562 : 
	`åì_to_¥ev_bkey
(
t
, 
j
 >> 
	`ffs
(j));

564 
bkey
 *
r
 = 
	`is_powî_of_2
(
j
 + 1)

565 ? 
	`b£t_bkey_idx
(
t
->
d©a
,Å->d©a->
keys
 - 
	`bkey_u64s
(&t->
íd
))

566 : 
	`åì_to_bkey
(
t
, 
j
 >> (
	`ffz
(j) + 1));

568 
	`BUG_ON
(
m
 < 
l
 || m > 
r
);

569 
	`BUG_ON
(
	`bkey_√xt
(
p
Ë!
m
);

571 i‡(
	`KEY_INODE
(
l
Ë!KEY_INODE(
r
))

572 
f
->
exp⁄ít
 = 
	`Ês64
(
	`KEY_INODE
(
r
Ë^ KEY_INODE(
l
)) + 64;

574 
f
->
exp⁄ít
 = 
	`Ês64
(
r
->
low
 ^ 
l
->low);

576 
f
->
exp⁄ít
 = 
	`max_t
(, f->exp⁄íà- 
BKEY_MANTISSA_BITS
, 0);

583 i‡(
	`bÊﬂt_m™tisß
(
m
, 
f
Ë!bÊﬂt_m™tisß(
p
, f))

584 
f
->
m™tisß
 = 
	`bÊﬂt_m™tisß
(
m
, f) - 1;

586 
f
->
exp⁄ít
 = 127;

587 
	}
}

589 
	$b£t_Æloc_åì
(
båì_keys
 *
b
, 
b£t_åì
 *
t
)

591 i‡(
t
 !
b
->
£t
) {

592 
j
 = 
	`roundup
(
t
[-1].
size
,

593 64 / (
bkey_Êﬂt
));

595 
t
->
åì
 =Å[-1].åì + 
j
;

596 
t
->
¥ev
 =Å[-1].¥ev + 
j
;

599 
t
 < 
b
->
£t
 + 
MAX_BSETS
)

600 
t
++->
size
 = 0;

601 
	}
}

603 
	$bch_b£t_buûd_unwrôãn_åì
(
båì_keys
 *
b
)

605 
b£t_åì
 *
t
 = 
	`b£t_åì_œ°
(
b
);

607 
	`BUG_ON
(
b
->
œ°_£t_unwrôãn
);

608 
b
->
œ°_£t_unwrôãn
 = 1;

610 
	`b£t_Æloc_åì
(
b
, 
t
);

612 i‡(
t
->
åì
 !
b
->
£t
->åì + 
	`båì_keys_ˇchñöes
(b)) {

613 
t
->
¥ev
[0] = 
	`bkey_to_ˇchñöe_off£t
—, 0,Å->
d©a
->
°¨t
);

614 
t
->
size
 = 1;

616 
	}
}

618 
	$bch_b£t_öô_√xt
(
båì_keys
 *
b
, 
b£t
 *
i
, 
uöt64_t
 
magic
)

620 i‡(
i
 !
b
->
£t
->
d©a
) {

621 
b
->
£t
[++b->
n£ts
].
d©a
 = 
i
;

622 
i
->
£q
 = 
b
->
£t
->
d©a
->seq;

624 
	`gë_øndom_byãs
(&
i
->
£q
, (
uöt64_t
));

626 
i
->
magic
 = magic;

627 
i
->
vîsi⁄
 = 0;

628 
i
->
keys
 = 0;

630 
	`bch_b£t_buûd_unwrôãn_åì
(
b
);

631 
	}
}

632 
EXPORT_SYMBOL
(
bch_b£t_öô_√xt
);

634 
	$bch_b£t_buûd_wrôãn_åì
(
båì_keys
 *
b
)

636 
b£t_åì
 *
t
 = 
	`b£t_åì_œ°
(
b
);

637 
bkey
 *
¥ev
 = 
NULL
, *
k
 = 
t
->
d©a
->
°¨t
;

638 
j
, 
ˇchñöe
 = 1;

640 
b
->
œ°_£t_unwrôãn
 = 0;

642 
	`b£t_Æloc_åì
(
b
, 
t
);

644 
t
->
size
 = 
	`mö_t
(,

645 
	`bkey_to_ˇchñöe
(
t
, 
	`b£t_bkey_œ°
—->
d©a
)),

646 
b
->
£t
->
åì
 + 
	`båì_keys_ˇchñöes
(bË- 
t
->tree);

648 i‡(
t
->
size
 < 2) {

649 
t
->
size
 = 0;

653 
t
->
exåa
 = (t->
size
 - 
	`rounddown_pow_of_two
(t->size - 1)) << 1;

656 
j
 = 
	`ö‹dî_√xt
(0, 
t
->
size
);

657 
j
;

658 
j
 = 
	`ö‹dî_√xt
(j, 
t
->
size
)) {

659 
	`bkey_to_ˇchñöe
(
t
, 
k
Ë< 
ˇchñöe
)

660 
¥ev
 = 
k
, k = 
	`bkey_√xt
(k);

662 
t
->
¥ev
[
j
] = 
	`bkey_u64s
(prev);

663 
t
->
åì
[
j
].
m
 = 
	`bkey_to_ˇchñöe_off£t
—, 
ˇchñöe
++, 
k
);

666 
	`bkey_√xt
(
k
Ë!
	`b£t_bkey_œ°
(
t
->
d©a
))

667 
k
 = 
	`bkey_√xt
(k);

669 
t
->
íd
 = *
k
;

672 
j
 = 
	`ö‹dî_√xt
(0, 
t
->
size
);

673 
j
;

674 
j
 = 
	`ö‹dî_√xt
(j, 
t
->
size
))

675 
	`make_bÊﬂt
(
t
, 
j
);

676 
	}
}

677 
EXPORT_SYMBOL
(
bch_b£t_buûd_wrôãn_åì
);

681 
	$bch_b£t_fix_övÆid©ed_key
(
båì_keys
 *
b
, 
bkey
 *
k
)

683 
b£t_åì
 *
t
;

684 
ö‹dî
, 
j
 = 1;

686 
t
 = 
b
->
£t
;Å <
	`b£t_åì_œ°
(b);Å++)

687 i‡(
k
 < 
	`b£t_bkey_œ°
(
t
->
d©a
))

688 
found_£t
;

690 
	`BUG
();

691 
found_£t
:

692 i‡(!
t
->
size
 || !
	`b£t_wrôãn
(
b
,Å))

695 
ö‹dî
 = 
	`bkey_to_ˇchñöe
(
t
, 
k
);

697 i‡(
k
 =
t
->
d©a
->
°¨t
)

698 
fix_À·
;

700 i‡(
	`bkey_√xt
(
k
Ë=
	`b£t_bkey_œ°
(
t
->
d©a
)) {

701 
t
->
íd
 = *
k
;

702 
fix_right
;

705 
j
 = 
	`ö‹dî_to_åì
(
ö‹dî
, 
t
);

707 i‡(
j
 &&

708 
j
 < 
t
->
size
 &&

709 
k
 =
	`åì_to_bkey
(
t
, 
j
))

710 
fix_À·
: do {

711 
	`make_bÊﬂt
(
t
, 
j
);

712 
j
 = j * 2;

713 } 
j
 < 
t
->
size
);

715 
j
 = 
	`ö‹dî_to_åì
(
ö‹dî
 + 1, 
t
);

717 i‡(
j
 &&

718 
j
 < 
t
->
size
 &&

719 
k
 =
	`åì_to_¥ev_bkey
(
t
, 
j
))

720 
fix_right
: do {

721 
	`make_bÊﬂt
(
t
, 
j
);

722 
j
 = j * 2 + 1;

723 } 
j
 < 
t
->
size
);

724 
	}
}

725 
EXPORT_SYMBOL
(
bch_b£t_fix_övÆid©ed_key
);

727 
	$bch_b£t_fix_lookup_èbÀ
(
båì_keys
 *
b
,

728 
b£t_åì
 *
t
,

729 
bkey
 *
k
)

731 
shi·
 = 
	`bkey_u64s
(
k
);

732 
j
 = 
	`bkey_to_ˇchñöe
(
t
, 
k
);

735 i‡(!
t
->
size
)

742 
j
 < 
t
->
size
 &&

743 
	`èbÀ_to_bkey
(
t
, 
j
Ë<
k
)

744 
j
++;

749 ; 
j
 < 
t
->
size
; j++) {

750 
t
->
¥ev
[
j
] +
shi·
;

752 i‡(
t
->
¥ev
[
j
] > 7) {

753 
k
 = 
	`èbÀ_to_bkey
(
t
, 
j
 - 1);

755 
k
 < 
	`ˇchñöe_to_bkey
(
t
, 
j
, 0))

756 
k
 = 
	`bkey_√xt
(k);

758 
t
->
¥ev
[
j
] = 
	`bkey_to_ˇchñöe_off£t
—, j, 
k
);

762 i‡(
t
->
size
 =
b
->
£t
->
åì
 + 
	`båì_keys_ˇchñöes
(b) -Å->tree)

767 
k
 = 
	`èbÀ_to_bkey
(
t
,Å->
size
 - 1);

768 
k
 !
	`b£t_bkey_œ°
(
t
->
d©a
);

769 
k
 = 
	`bkey_√xt
(k))

770 i‡(
t
->
size
 =
	`bkey_to_ˇchñöe
—, 
k
)) {

771 
t
->
¥ev
[t->
size
] = 
	`bkey_to_ˇchñöe_off£t
—,Å->size, 
k
);

772 
t
->
size
++;

774 
	}
}

781 
boﬁ
 
	$bch_bkey_åy_mîge
(
båì_keys
 *
b
, 
bkey
 *
l
, bkey *
r
)

783 i‡(!
b
->
›s
->
key_mîge
)

784  
Ál£
;

791 i‡(!
	`bch_bkey_equÆ_hódî
(
l
, 
r
) ||

792 
	`bkey_cmp
(
l
, &
	`START_KEY
(
r
)))

793  
Ál£
;

795  
b
->
›s
->
	`key_mîge
(b, 
l
, 
r
);

796 
	}
}

797 
EXPORT_SYMBOL
(
bch_bkey_åy_mîge
);

799 
	$bch_b£t_ö£π
(
båì_keys
 *
b
, 
bkey
 *
whîe
,

800 
bkey
 *
ö£π
)

802 
b£t_åì
 *
t
 = 
	`b£t_åì_œ°
(
b
);

804 
	`BUG_ON
(!
b
->
œ°_£t_unwrôãn
);

805 
	`BUG_ON
(
	`b£t_byã_off£t
(
b
, 
t
->
d©a
) +

806 
	`__£t_byãs
(
t
->
d©a
,Å->d©a->
keys
 + 
	`bkey_u64s
(
ö£π
)) >

807 
PAGE_SIZE
 << 
b
->
∑ge_‹dî
);

809 
	`memmove
((
uöt64_t
 *Ë
whîe
 + 
	`bkey_u64s
(
ö£π
),

810 
whîe
,

811 (*Ë
	`b£t_bkey_œ°
(
t
->
d©a
Ë- (*Ë
whîe
);

813 
t
->
d©a
->
keys
 +
	`bkey_u64s
(
ö£π
);

814 
	`bkey_c›y
(
whîe
, 
ö£π
);

815 
	`bch_b£t_fix_lookup_èbÀ
(
b
, 
t
, 
whîe
);

816 
	}
}

817 
EXPORT_SYMBOL
(
bch_b£t_ö£π
);

819 
	$bch_båì_ö£π_key
(
båì_keys
 *
b
, 
bkey
 *
k
,

820 
bkey
 *
ª∂a˚_key
)

822 
°©us
 = 
BTREE_INSERT_STATUS_NO_INSERT
;

823 
b£t
 *
i
 = 
	`b£t_åì_œ°
(
b
)->
d©a
;

824 
bkey
 *
m
, *
¥ev
 = 
NULL
;

825 
båì_ôî
 
ôî
;

827 
	`BUG_ON
(
b
->
›s
->
is_exã¡s
 && !
	`KEY_SIZE
(
k
));

829 
m
 = 
	`bch_båì_ôî_öô
(
b
, &
ôî
, b->
›s
->
is_exã¡s


830 ? 
	`PRECEDING_KEY
(&
	`START_KEY
(
k
))

831 : 
	`PRECEDING_KEY
(
k
));

833 i‡(
b
->
›s
->
	`ö£π_fixup
(b, 
k
, &
ôî
, 
ª∂a˚_key
))

834  
°©us
;

836 
°©us
 = 
BTREE_INSERT_STATUS_INSERT
;

838 
m
 !
	`b£t_bkey_œ°
(
i
) &&

839 
	`bkey_cmp
(
k
, 
b
->
›s
->
is_exã¡s
 ? &
	`START_KEY
(
m
) : m) > 0)

840 
¥ev
 = 
m
, m = 
	`bkey_√xt
(m);

843 
°©us
 = 
BTREE_INSERT_STATUS_BACK_MERGE
;

844 i‡(
¥ev
 &&

845 
	`bch_bkey_åy_mîge
(
b
, 
¥ev
, 
k
))

846 
mîged
;

848 
°©us
 = 
BTREE_INSERT_STATUS_OVERWROTE
;

849 i‡(
m
 !
	`b£t_bkey_œ°
(
i
) &&

850 
	`KEY_PTRS
(
m
Ë=KEY_PTRS(
k
Ë&& !
	`KEY_SIZE
(m))

851 
c›y
;

853 
°©us
 = 
BTREE_INSERT_STATUS_FRONT_MERGE
;

854 i‡(
m
 !
	`b£t_bkey_œ°
(
i
) &&

855 
	`bch_bkey_åy_mîge
(
b
, 
k
, 
m
))

856 
c›y
;

858 
	`bch_b£t_ö£π
(
b
, 
m
, 
k
);

859 
c›y
: 
	`bkey_c›y
(
m
, 
k
);

860 
mîged
:

861  
°©us
;

862 
	}
}

863 
EXPORT_SYMBOL
(
bch_båì_ö£π_key
);

867 
	sb£t_£¨ch_ôî
 {

868 
bkey
 *
	ml
, *
	mr
;

871 
b£t_£¨ch_ôî
 
	$b£t_£¨ch_wrôe_£t
(
b£t_åì
 *
t
,

872 c⁄° 
bkey
 *
£¨ch
)

874 
li
 = 0, 
ri
 = 
t
->
size
;

876 
li
 + 1 !
ri
) {

877 
m
 = (
li
 + 
ri
) >> 1;

879 i‡(
	`bkey_cmp
(
	`èbÀ_to_bkey
(
t
, 
m
), 
£¨ch
) > 0)

880 
ri
 = 
m
;

882 
li
 = 
m
;

885  (
b£t_£¨ch_ôî
) {

886 
	`èbÀ_to_bkey
(
t
, 
li
),

887 
ri
 < 
t
->
size
 ? 
	`èbÀ_to_bkey
—,ÑiË: 
	`b£t_bkey_œ°
—->
d©a
)

889 
	}
}

891 
b£t_£¨ch_ôî
 
	$b£t_£¨ch_åì
(
b£t_åì
 *
t
,

892 c⁄° 
bkey
 *
£¨ch
)

894 
bkey
 *
l
, *
r
;

895 
bkey_Êﬂt
 *
f
;

896 
ö‹dî
, 
j
, 
n
 = 1;

899 
p
 = 
n
 << 4;

900 
p
 &((Ë’ - 
t
->
size
)) >> 31;

902 
	`¥e„tch
(&
t
->
åì
[
p
]);

904 
j
 = 
n
;

905 
f
 = &
t
->
åì
[
j
];

915 i‡(
	`likñy
(
f
->
exp⁄ít
 != 127))

916 
n
 = 
j
 * 2 + ((()

917 (
f
->
m™tisß
 -

918 
	`bÊﬂt_m™tisß
(
£¨ch
, 
f
))) >> 31);

920 
n
 = (
	`bkey_cmp
(
	`åì_to_bkey
(
t
, 
j
), 
£¨ch
) > 0)

921 ? 
j
 * 2

922 : 
j
 * 2 + 1;

923 } 
n
 < 
t
->
size
);

925 
ö‹dî
 = 
	`to_ö‹dî
(
j
, 
t
);

931 i‡(
n
 & 1) {

932 
l
 = 
	`ˇchñöe_to_bkey
(
t
, 
ö‹dî
, 
f
->
m
);

934 i‡(++
ö‹dî
 !
t
->
size
) {

935 
f
 = &
t
->
åì
[
	`ö‹dî_√xt
(
j
,Å->
size
)];

936 
r
 = 
	`ˇchñöe_to_bkey
(
t
, 
ö‹dî
, 
f
->
m
);

938 
r
 = 
	`b£t_bkey_œ°
(
t
->
d©a
);

940 
r
 = 
	`ˇchñöe_to_bkey
(
t
, 
ö‹dî
, 
f
->
m
);

942 i‡(--
ö‹dî
) {

943 
f
 = &
t
->
åì
[
	`ö‹dî_¥ev
(
j
,Å->
size
)];

944 
l
 = 
	`ˇchñöe_to_bkey
(
t
, 
ö‹dî
, 
f
->
m
);

946 
l
 = 
t
->
d©a
->
°¨t
;

949  (
b£t_£¨ch_ôî
Ë{
l
, 
r
};

950 
	}
}

952 
bkey
 *
	$__bch_b£t_£¨ch
(
båì_keys
 *
b
, 
b£t_åì
 *
t
,

953 c⁄° 
bkey
 *
£¨ch
)

955 
b£t_£¨ch_ôî
 
i
;

972 i‡(
	`u∆ikñy
(!
t
->
size
)) {

973 
i
.
l
 = 
t
->
d©a
->
°¨t
;

974 
i
.
r
 = 
	`b£t_bkey_œ°
(
t
->
d©a
);

975 } i‡(
	`b£t_wrôãn
(
b
, 
t
)) {

983 i‡(
	`u∆ikñy
(
	`bkey_cmp
(
£¨ch
, &
t
->
íd
) >= 0))

984  
	`b£t_bkey_œ°
(
t
->
d©a
);

986 i‡(
	`u∆ikñy
(
	`bkey_cmp
(
£¨ch
, 
t
->
d©a
->
°¨t
) < 0))

987  
t
->
d©a
->
°¨t
;

989 
i
 = 
	`b£t_£¨ch_åì
(
t
, 
£¨ch
);

991 
	`BUG_ON
(!
b
->
n£ts
 &&

992 
t
->
size
 < 
	`bkey_to_ˇchñöe
—, 
	`b£t_bkey_œ°
—->
d©a
)));

994 
i
 = 
	`b£t_£¨ch_wrôe_£t
(
t
, 
£¨ch
);

997 i‡(
	`båì_keys_ex≥nsive_checks
(
b
)) {

998 
	`BUG_ON
(
	`b£t_wrôãn
(
b
, 
t
) &&

999 
i
.
l
 !
t
->
d©a
->
°¨t
 &&

1000 
	`bkey_cmp
(
	`åì_to_¥ev_bkey
(
t
,

1001 
	`ö‹dî_to_åì
(
	`bkey_to_ˇchñöe
(
t
, 
i
.
l
),Å)),

1002 
£¨ch
) > 0);

1004 
	`BUG_ON
(
i
.
r
 !
	`b£t_bkey_œ°
(
t
->
d©a
) &&

1005 
	`bkey_cmp
(
i
.
r
, 
£¨ch
) <= 0);

1008 
	`likñy
(
i
.
l
 !i.
r
) &&

1009 
	`bkey_cmp
(
i
.
l
, 
£¨ch
) <= 0)

1010 
i
.
l
 = 
	`bkey_√xt
(i.l);

1012  
i
.
l
;

1013 
	}
}

1014 
EXPORT_SYMBOL
(
__bch_b£t_£¨ch
);

1018 
	$boﬁ
 (
	tbåì_ôî_cmp_‚
)(
	tbåì_ôî_£t
,

1019 
	tbåì_ôî_£t
);

1021 
ölöe
 
boﬁ
 
	$båì_ôî_cmp
(
båì_ôî_£t
 
l
,

1022 
båì_ôî_£t
 
r
)

1024  
	`bkey_cmp
(
l
.
k
, 
r
.k) > 0;

1025 
	}
}

1027 
ölöe
 
boﬁ
 
	$båì_ôî_íd
(
båì_ôî
 *
ôî
)

1029  !
ôî
->
u£d
;

1030 
	}
}

1032 
	$bch_båì_ôî_push
(
båì_ôî
 *
ôî
, 
bkey
 *
k
,

1033 
bkey
 *
íd
)

1035 i‡(
k
 !
íd
)

1036 
	`BUG_ON
(!
	`hóp_add
(
ôî
,

1037 ((
båì_ôî_£t
Ë{ 
k
, 
íd
 }),

1038 
båì_ôî_cmp
));

1039 
	}
}

1041 
bkey
 *
	$__bch_båì_ôî_öô
(
båì_keys
 *
b
,

1042 
båì_ôî
 *
ôî
,

1043 
bkey
 *
£¨ch
,

1044 
b£t_åì
 *
°¨t
)

1046 
bkey
 *
ªt
 = 
NULL
;

1047 
ôî
->
size
 = 
	`ARRAY_SIZE
(ôî->
d©a
);

1048 
ôî
->
u£d
 = 0;

1050 #ifde‡
CONFIG_BCACHE_DEBUG


1051 
ôî
->
b
 = b;

1054 ; 
°¨t
 <
	`b£t_åì_œ°
(
b
); start++) {

1055 
ªt
 = 
	`bch_b£t_£¨ch
(
b
, 
°¨t
, 
£¨ch
);

1056 
	`bch_båì_ôî_push
(
ôî
, 
ªt
, 
	`b£t_bkey_œ°
(
°¨t
->
d©a
));

1059  
ªt
;

1060 
	}
}

1062 
bkey
 *
	$bch_båì_ôî_öô
(
båì_keys
 *
b
,

1063 
båì_ôî
 *
ôî
,

1064 
bkey
 *
£¨ch
)

1066  
	`__bch_båì_ôî_öô
(
b
, 
ôî
, 
£¨ch
, b->
£t
);

1067 
	}
}

1068 
EXPORT_SYMBOL
(
bch_båì_ôî_öô
);

1070 
ölöe
 
bkey
 *
	$__bch_båì_ôî_√xt
(
båì_ôî
 *
ôî
,

1071 
båì_ôî_cmp_‚
 *
cmp
)

1073 
båì_ôî_£t
 
unu£d
;

1074 
bkey
 *
ªt
 = 
NULL
;

1076 i‡(!
	`båì_ôî_íd
(
ôî
)) {

1077 
	`bch_båì_ôî_√xt_check
(
ôî
);

1079 
ªt
 = 
ôî
->
d©a
->
k
;

1080 
ôî
->
d©a
->
k
 = 
	`bkey_√xt
(iter->data->k);

1082 i‡(
ôî
->
d©a
->
k
 > iãr->d©a->
íd
) {

1083 
	`WARN_ONCE
(1, "bset was corrupt!\n");

1084 
ôî
->
d©a
->
k
 = iãr->d©a->
íd
;

1087 i‡(
ôî
->
d©a
->
k
 =ôî->d©a->
íd
)

1088 
	`hóp_p›
(
ôî
, 
unu£d
, 
cmp
);

1090 
	`hóp_si·
(
ôî
, 0, 
cmp
);

1093  
ªt
;

1094 
	}
}

1096 
bkey
 *
	$bch_båì_ôî_√xt
(
båì_ôî
 *
ôî
)

1098  
	`__bch_båì_ôî_√xt
(
ôî
, 
båì_ôî_cmp
);

1100 
	}
}

1101 
EXPORT_SYMBOL
(
bch_båì_ôî_√xt
);

1103 
bkey
 *
	$bch_båì_ôî_√xt_fûãr
(
båì_ôî
 *
ôî
,

1104 
båì_keys
 *
b
, 
±r_fûãr_‚
 
‚
)

1106 
bkey
 *
ªt
;

1109 
ªt
 = 
	`bch_båì_ôî_√xt
(
ôî
);

1110 } 
ªt
 && 
	`‚
(
b
,Ñet));

1112  
ªt
;

1113 
	}
}

1117 
	$bch_b£t_s‹t_°©e_‰ì
(
b£t_s‹t_°©e
 *
°©e
)

1119 i‡(
°©e
->
poﬁ
)

1120 
	`mempoﬁ_de°roy
(
°©e
->
poﬁ
);

1121 
	}
}

1123 
	$bch_b£t_s‹t_°©e_öô
(
b£t_s‹t_°©e
 *
°©e
, 
∑ge_‹dî
)

1125 
	`•ö_lock_öô
(&
°©e
->
time
.
lock
);

1127 
°©e
->
∑ge_‹dî
 =Öage_order;

1128 
°©e
->
¸ô_Á˘‹
 = 
	`öt_sqπ
(1 << 
∑ge_‹dî
);

1130 
°©e
->
poﬁ
 = 
	`mempoﬁ_¸óã_∑ge_poﬁ
(1, 
∑ge_‹dî
);

1131 i‡(!
°©e
->
poﬁ
)

1132  -
ENOMEM
;

1135 
	}
}

1136 
EXPORT_SYMBOL
(
bch_b£t_s‹t_°©e_öô
);

1138 
	$båì_mîges‹t
(
båì_keys
 *
b
, 
b£t
 *
out
,

1139 
båì_ôî
 *
ôî
,

1140 
boﬁ
 
fixup
, boﬁ 
ªmove_°Æe
)

1142 
i
;

1143 
bkey
 *
k
, *
œ°
 = 
NULL
;

1144 
	`BKEY_PADDED
(
k
Ë
tmp
;

1145 
	`boﬁ
 (*
bad
)(
båì_keys
 *, c⁄° 
bkey
 *Ë
ªmove_°Æe


1146 ? 
bch_±r_bad


1147 : 
bch_±r_övÆid
;

1150 
i
 = 
ôî
->
u£d
 / 2 - 1; i >= 0; --i)

1151 
	`hóp_si·
(
ôî
, 
i
, 
b
->
›s
->
s‹t_cmp
);

1153 !
	`båì_ôî_íd
(
ôî
)) {

1154 i‡(
b
->
›s
->
s‹t_fixup
 && 
fixup
)

1155 
k
 = 
b
->
›s
->
	`s‹t_fixup
(
ôî
, &
tmp
.k);

1157 
k
 = 
NULL
;

1159 i‡(!
k
)

1160 
k
 = 
	`__bch_båì_ôî_√xt
(
ôî
, 
b
->
›s
->
s‹t_cmp
);

1162 i‡(
	`bad
(
b
, 
k
))

1165 i‡(!
œ°
) {

1166 
œ°
 = 
out
->
°¨t
;

1167 
	`bkey_c›y
(
œ°
, 
k
);

1168 } i‡(!
	`bch_bkey_åy_mîge
(
b
, 
œ°
, 
k
)) {

1169 
œ°
 = 
	`bkey_√xt
(last);

1170 
	`bkey_c›y
(
œ°
, 
k
);

1174 
out
->
keys
 = 
œ°
 ? (
uöt64_t
 *Ë
	`bkey_√xt
÷a°Ë- out->
d
 : 0;

1176 
	`¥_debug
("s‹ãd %òkeys", 
out
->
keys
);

1177 
	}
}

1179 
	$__båì_s‹t
(
båì_keys
 *
b
, 
båì_ôî
 *
ôî
,

1180 
°¨t
, 
‹dî
, 
boﬁ
 
fixup
,

1181 
b£t_s‹t_°©e
 *
°©e
)

1183 
uöt64_t
 
°¨t_time
;

1184 
boﬁ
 
u£d_mempoﬁ
 = 
Ál£
;

1185 
b£t
 *
out
 = (*Ë
	`__gë_‰ì_∑ges
(
__GFP_NOWARN
|
GFP_NOWAIT
,

1186 
‹dî
);

1187 i‡(!
out
) {

1188 
∑ge
 *
ouç
;

1190 
	`BUG_ON
(
‹dî
 > 
°©e
->
∑ge_‹dî
);

1192 
ouç
 = 
	`mempoﬁ_Æloc
(
°©e
->
poﬁ
, 
GFP_NOIO
);

1193 
out
 = 
	`∑ge_addªss
(
ouç
);

1194 
u£d_mempoﬁ
 = 
åue
;

1195 
‹dî
 = 
°©e
->
∑ge_‹dî
;

1198 
°¨t_time
 = 
	`loˇl_˛ock
();

1200 
	`båì_mîges‹t
(
b
, 
out
, 
ôî
, 
fixup
, 
Ál£
);

1201 
b
->
n£ts
 = 
°¨t
;

1203 i‡(!
°¨t
 && 
‹dî
 =
b
->
∑ge_‹dî
) {

1210 
out
->
magic
 = 
b
->
£t
->
d©a
->magic;

1211 
out
->
£q
 = 
b
->
£t
->
d©a
->seq;

1212 
out
->
vîsi⁄
 = 
b
->
£t
->
d©a
->version;

1213 
	`sw≠
(
out
, 
b
->
£t
->
d©a
);

1215 
b
->
£t
[
°¨t
].
d©a
->
keys
 = 
out
->keys;

1216 
	`mem˝y
(
b
->
£t
[
°¨t
].
d©a
->°¨t, 
out
->start,

1217 (*Ë
	`b£t_bkey_œ°
(
out
Ë- (*Ëout->
°¨t
);

1220 i‡(
u£d_mempoﬁ
)

1221 
	`mempoﬁ_‰ì
(
	`vút_to_∑ge
(
out
), 
°©e
->
poﬁ
);

1223 
	`‰ì_∑ges
((Ë
out
, 
‹dî
);

1225 
	`bch_b£t_buûd_wrôãn_åì
(
b
);

1227 i‡(!
°¨t
)

1228 
	`bch_time_°©s_upd©e
(&
°©e
->
time
, 
°¨t_time
);

1229 
	}
}

1231 
	$bch_båì_s‹t_∑πül
(
båì_keys
 *
b
, 
°¨t
,

1232 
b£t_s‹t_°©e
 *
°©e
)

1234 
size_t
 
‹dî
 = 
b
->
∑ge_‹dî
, 
keys
 = 0;

1235 
båì_ôî
 
ôî
;

1236 
ﬁdsize
 = 
	`bch_cou¡_d©a
(
b
);

1238 
	`__bch_båì_ôî_öô
(
b
, &
ôî
, 
NULL
, &b->
£t
[
°¨t
]);

1240 i‡(
°¨t
) {

1241 
i
;

1243 
i
 = 
°¨t
; i <
b
->
n£ts
; i++)

1244 
keys
 +
b
->
£t
[
i
].
d©a
->keys;

1246 
‹dî
 = 
	`gë_‹dî
(
	`__£t_byãs
(
b
->
£t
->
d©a
, 
keys
));

1249 
	`__båì_s‹t
(
b
, &
ôî
, 
°¨t
, 
‹dî
, 
Ál£
, 
°©e
);

1251 
	`EBUG_ON
(
ﬁdsize
 >0 && 
	`bch_cou¡_d©a
(
b
) != oldsize);

1252 
	}
}

1253 
EXPORT_SYMBOL
(
bch_båì_s‹t_∑πül
);

1255 
	$bch_båì_s‹t_™d_fix_exã¡s
(
båì_keys
 *
b
,

1256 
båì_ôî
 *
ôî
,

1257 
b£t_s‹t_°©e
 *
°©e
)

1259 
	`__båì_s‹t
(
b
, 
ôî
, 0, b->
∑ge_‹dî
, 
åue
, 
°©e
);

1260 
	}
}

1262 
	$bch_båì_s‹t_öto
(
båì_keys
 *
b
, båì_key†*
√w
,

1263 
b£t_s‹t_°©e
 *
°©e
)

1265 
uöt64_t
 
°¨t_time
 = 
	`loˇl_˛ock
();

1267 
båì_ôî
 
ôî
;

1268 
	`bch_båì_ôî_öô
(
b
, &
ôî
, 
NULL
);

1270 
	`båì_mîges‹t
(
b
, 
√w
->
£t
->
d©a
, &
ôî
, 
Ál£
, 
åue
);

1272 
	`bch_time_°©s_upd©e
(&
°©e
->
time
, 
°¨t_time
);

1274 
√w
->
£t
->
size
 = 0;

1275 
	}
}

1277 
	#SORT_CRIT
 (4096 / (
uöt64_t
))

	)

1279 
	$bch_båì_s‹t_œzy
(
båì_keys
 *
b
, 
b£t_s‹t_°©e
 *
°©e
)

1281 
¸ô
 = 
SORT_CRIT
;

1282 
i
;

1285 i‡(!
b
->
n£ts
)

1286 
out
;

1288 
i
 = 
b
->
n£ts
 - 1; i >= 0; --i) {

1289 
¸ô
 *
°©e
->
¸ô_Á˘‹
;

1291 i‡(
b
->
£t
[
i
].
d©a
->
keys
 < 
¸ô
) {

1292 
	`bch_båì_s‹t_∑πül
(
b
, 
i
, 
°©e
);

1298 i‡(
b
->
n£ts
 + 1 =
MAX_BSETS
) {

1299 
	`bch_båì_s‹t
(
b
, 
°©e
);

1303 
out
:

1304 
	`bch_b£t_buûd_wrôãn_åì
(
b
);

1305 
	}
}

1306 
EXPORT_SYMBOL
(
bch_båì_s‹t_œzy
);

1308 
	$bch_båì_keys_°©s
(
båì_keys
 *
b
, 
b£t_°©s
 *
°©s
)

1310 
i
;

1312 
i
 = 0; i <
b
->
n£ts
; i++) {

1313 
b£t_åì
 *
t
 = &
b
->
£t
[
i
];

1314 
size_t
 
byãs
 = 
t
->
d©a
->
keys
 * (
uöt64_t
);

1315 
size_t
 
j
;

1317 i‡(
	`b£t_wrôãn
(
b
, 
t
)) {

1318 
°©s
->
£ts_wrôãn
++;

1319 
°©s
->
byãs_wrôãn
 +
byãs
;

1321 
°©s
->
Êﬂts
 +
t
->
size
 - 1;

1323 
j
 = 1; j < 
t
->
size
; j++)

1324 i‡(
t
->
åì
[
j
].
exp⁄ít
 == 127)

1325 
°©s
->
Áûed
++;

1327 
°©s
->
£ts_unwrôãn
++;

1328 
°©s
->
byãs_unwrôãn
 +
byãs
;

1331 
	}
}

	@bcache/bset.h

1 #i‚de‡
_BCACHE_BSET_H


2 
	#_BCACHE_BSET_H


	)

4 
	~<löux/bˇche.h
>

5 
	~<löux/kî√l.h
>

6 
	~<löux/ty≥s.h
>

8 
	~"utû.h
"

149 
	gbåì_keys
;

150 
	gbåì_ôî
;

151 
	gbåì_ôî_£t
;

152 
	gbkey_Êﬂt
;

154 
	#MAX_BSETS
 4U

	)

156 
	sb£t_åì
 {

165 
	msize
;

168 
	mexåa
;

171 
bkey
 
	míd
;

172 
bkey_Êﬂt
 *
	måì
;

182 
uöt8_t
 *
	m¥ev
;

185 
b£t
 *
	md©a
;

188 
	sbåì_keys_›s
 {

189 
boﬁ
 (*
s‹t_cmp
)(
	mbåì_ôî_£t
,

190 
	mbåì_ôî_£t
);

191 
	mbkey
 *(*
	ms‹t_fixup
)(
	mbåì_ôî
 *, bkey *);

192 
boﬁ
 (*
ö£π_fixup
)(
	mbåì_keys
 *, 
	mbkey
 *,

193 
	mbåì_ôî
 *, 
	mbkey
 *);

194 
boﬁ
 (*
key_övÆid
)(
	mbåì_keys
 *,

195 c⁄° 
	mbkey
 *);

196 
boﬁ
 (*
key_bad
)(
	mbåì_keys
 *, c⁄° 
	mbkey
 *);

197 
boﬁ
 (*
key_mîge
)(
	mbåì_keys
 *,

198 
	mbkey
 *, bkey *);

199 (*
	mkey_to_ãxt
)(*, 
	msize_t
, c⁄° 
	mbkey
 *);

200 (*
	mkey_dump
)(
	mbåì_keys
 *, c⁄° 
	mbkey
 *);

206 
boﬁ
 
	mis_exã¡s
;

209 
	sbåì_keys
 {

210 c⁄° 
båì_keys_›s
 *
	m›s
;

211 
uöt8_t
 
	m∑ge_‹dî
;

212 
uöt8_t
 
	mn£ts
;

213 
	mœ°_£t_unwrôãn
:1;

214 
boﬁ
 *
	mex≥nsive_debug_checks
;

223 
b£t_åì
 
	m£t
[
MAX_BSETS
];

226 
ölöe
 
b£t_åì
 *
	$b£t_åì_œ°
(
båì_keys
 *
b
)

228  
b
->
£t
 + b->
n£ts
;

229 
	}
}

231 
ölöe
 
boﬁ
 
	$b£t_wrôãn
(
båì_keys
 *
b
, 
b£t_åì
 *
t
)

233  
t
 <
b
->
£t
 + b->
n£ts
 - b->
œ°_£t_unwrôãn
;

234 
	}
}

236 
ölöe
 
boﬁ
 
	$bkey_wrôãn
(
båì_keys
 *
b
, 
bkey
 *
k
)

238  !
b
->
œ°_£t_unwrôãn
 || 
k
 < b->
£t
[b->
n£ts
].
d©a
->
°¨t
;

239 
	}
}

241 
ölöe
 
	$b£t_byã_off£t
(
båì_keys
 *
b
, 
b£t
 *
i
)

243  ((
size_t
Ë
i
Ë- ((size_tË
b
->
£t
->
d©a
);

244 
	}
}

246 
ölöe
 
	$b£t_£˘‹_off£t
(
båì_keys
 *
b
, 
b£t
 *
i
)

248  
	`b£t_byã_off£t
(
b
, 
i
) >> 9;

249 
	}
}

251 
	#__£t_byãs
(
i
, 
k
Ë((*(i)Ë+ (kË* (
uöt64_t
))

	)

252 
	#£t_byãs
(
i
Ë
	`__£t_byãs
(i, i->
keys
)

	)

254 
	#__£t_blocks
(
i
, 
k
, 
block_byãs
) \

255 
	`DIV_ROUND_UP
(
	`__£t_byãs
(
i
, 
k
), 
block_byãs
)

	)

256 
	#£t_blocks
(
i
, 
block_byãs
) \

257 
	`__£t_blocks
(
i
, (i)->
keys
, 
block_byãs
)

	)

259 
ölöe
 
size_t
 
	$bch_båì_keys_u64s_ªmaöög
(
båì_keys
 *
b
)

261 
b£t_åì
 *
t
 = 
	`b£t_åì_œ°
(
b
);

263 
	`BUG_ON
((
PAGE_SIZE
 << 
b
->
∑ge_‹dî
) <

264 (
	`b£t_byã_off£t
(
b
, 
t
->
d©a
Ë+ 
	`£t_byãs
(t->data)));

266 i‡(!
b
->
œ°_£t_unwrôãn
)

269  ((
PAGE_SIZE
 << 
b
->
∑ge_‹dî
) -

270 (
	`b£t_byã_off£t
(
b
, 
t
->
d©a
Ë+ 
	`£t_byãs
(t->data))) /

271 (
u64
);

272 
	}
}

274 
ölöe
 
b£t
 *
	$b£t_√xt_£t
(
båì_keys
 *
b
,

275 
block_byãs
)

277 
b£t
 *
i
 = 
	`b£t_åì_œ°
(
b
)->
d©a
;

279  ((*Ë
i
Ë+ 
	`roundup
(
	`£t_byãs
(i), 
block_byãs
);

280 
	}
}

282 
bch_båì_keys_‰ì
(
båì_keys
 *);

283 
bch_båì_keys_Æloc
(
båì_keys
 *, , 
gÂ_t
);

284 
bch_båì_keys_öô
(
båì_keys
 *, c⁄° 
båì_keys_›s
 *,

285 
boﬁ
 *);

287 
bch_b£t_öô_√xt
(
båì_keys
 *, 
b£t
 *, 
uöt64_t
);

288 
bch_b£t_buûd_wrôãn_åì
(
båì_keys
 *);

289 
bch_b£t_fix_övÆid©ed_key
(
båì_keys
 *, 
bkey
 *);

290 
boﬁ
 
bch_bkey_åy_mîge
(
båì_keys
 *, 
bkey
 *, bkey *);

291 
bch_b£t_ö£π
(
båì_keys
 *, 
bkey
 *, bkey *);

292 
bch_båì_ö£π_key
(
båì_keys
 *, 
bkey
 *,

293 
bkey
 *);

296 
	mBTREE_INSERT_STATUS_NO_INSERT
 = 0,

297 
	mBTREE_INSERT_STATUS_INSERT
,

298 
	mBTREE_INSERT_STATUS_BACK_MERGE
,

299 
	mBTREE_INSERT_STATUS_OVERWROTE
,

300 
	mBTREE_INSERT_STATUS_FRONT_MERGE
,

305 
	sbåì_ôî
 {

306 
size_t
 
	msize
, 
	mu£d
;

307 #ifde‡
CONFIG_BCACHE_DEBUG


308 
båì_keys
 *
	mb
;

310 
	sbåì_ôî_£t
 {

311 
bkey
 *
	mk
, *
	míd
;

312 } 
	md©a
[
MAX_BSETS
];

315 
	$boﬁ
 (*
	t±r_fûãr_‚
)(
	tbåì_keys
 *, c⁄° 
	tbkey
 *);

317 
bkey
 *
	`bch_båì_ôî_√xt
(
båì_ôî
 *);

318 
bkey
 *
	`bch_båì_ôî_√xt_fûãr
(
båì_ôî
 *,

319 
båì_keys
 *, 
±r_fûãr_‚
);

321 
	`bch_båì_ôî_push
(
båì_ôî
 *, 
bkey
 *, bkey *);

322 
bkey
 *
	`bch_båì_ôî_öô
(
båì_keys
 *, 
båì_ôî
 *,

323 
bkey
 *);

325 
bkey
 *
	`__bch_b£t_£¨ch
(
båì_keys
 *, 
b£t_åì
 *,

326 c⁄° 
bkey
 *);

331 
ölöe
 
bkey
 *
	$bch_b£t_£¨ch
(
båì_keys
 *
b
,

332 
b£t_åì
 *
t
,

333 c⁄° 
bkey
 *
£¨ch
)

335  
£¨ch
 ? 
	`__bch_b£t_£¨ch
(
b
, 
t
, sórchË:Å->
d©a
->
°¨t
;

336 
	}
}

338 
	#f‹_óch_key_fûãr
(
b
, 
k
, 
ôî
, 
fûãr
) \

339 
	`bch_båì_ôî_öô
((
b
), (
ôî
), 
NULL
); \

340 ((
k
Ë
	`bch_båì_ôî_√xt_fûãr
((
ôî
), (
b
), 
fûãr
));)

	)

342 
	#f‹_óch_key
(
b
, 
k
, 
ôî
) \

343 
	`bch_båì_ôî_öô
((
b
), (
ôî
), 
NULL
); \

344 ((
k
Ë
	`bch_båì_ôî_√xt
(
ôî
));)

	)

348 
	sb£t_s‹t_°©e
 {

349 
mempoﬁ_t
 *
	mpoﬁ
;

351 
	m∑ge_‹dî
;

352 
	m¸ô_Á˘‹
;

354 
time_°©s
 
	mtime
;

357 
bch_b£t_s‹t_°©e_‰ì
(
b£t_s‹t_°©e
 *);

358 
bch_b£t_s‹t_°©e_öô
(
b£t_s‹t_°©e
 *, );

359 
bch_båì_s‹t_œzy
(
båì_keys
 *, 
b£t_s‹t_°©e
 *);

360 
bch_båì_s‹t_öto
(
båì_keys
 *, btree_keys *,

361 
b£t_s‹t_°©e
 *);

362 
bch_båì_s‹t_™d_fix_exã¡s
(
båì_keys
 *, 
båì_ôî
 *,

363 
b£t_s‹t_°©e
 *);

364 
bch_båì_s‹t_∑πül
(
båì_keys
 *, ,

365 
b£t_s‹t_°©e
 *);

367 
ölöe
 
	$bch_båì_s‹t
(
båì_keys
 *
b
,

368 
b£t_s‹t_°©e
 *
°©e
)

370 
	`bch_båì_s‹t_∑πül
(
b
, 0, 
°©e
);

371 
	}
}

373 
	sb£t_°©s
 {

374 
size_t
 
	m£ts_wrôãn
, 
	m£ts_unwrôãn
;

375 
size_t
 
	mbyãs_wrôãn
, 
	mbyãs_unwrôãn
;

376 
size_t
 
	mÊﬂts
, 
	mÁûed
;

379 
bch_båì_keys_°©s
(
båì_keys
 *, 
b£t_°©s
 *);

383 
	#b£t_bkey_œ°
(
i
Ë
	`bkey_idx
((
bkey
 *Ë(i)->
d
, (i)->
keys
)

	)

385 
ölöe
 
bkey
 *
	$b£t_bkey_idx
(
b£t
 *
i
, 
idx
)

387  
	`bkey_idx
(
i
->
°¨t
, 
idx
);

388 
	}
}

390 
ölöe
 
	$bkey_öô
(
bkey
 *
k
)

392 *
k
 = 
ZERO_KEY
;

393 
	}
}

395 
__Æways_ölöe
 
öt64_t
 
	$bkey_cmp
(c⁄° 
bkey
 *
l
,

396 c⁄° 
bkey
 *
r
)

398  
	`u∆ikñy
(
	`KEY_INODE
(
l
Ë!KEY_INODE(
r
))

399 ? (
öt64_t
Ë
	`KEY_INODE
(
l
Ë- (öt64_tËKEY_INODE(
r
)

400 : (
öt64_t
Ë
	`KEY_OFFSET
(
l
Ë- (öt64_tËKEY_OFFSET(
r
);

401 
	}
}

403 
bch_bkey_c›y_sögÀ_±r
(
bkey
 *, const bkey *,

405 
boﬁ
 
__bch_cut_‰⁄t
(c⁄° 
bkey
 *, bkey *);

406 
boﬁ
 
__bch_cut_back
(c⁄° 
bkey
 *, bkey *);

408 
ölöe
 
boﬁ
 
	$bch_cut_‰⁄t
(c⁄° 
bkey
 *
whîe
, bkey *
k
)

410 
	`BUG_ON
(
	`bkey_cmp
(
whîe
, 
k
) > 0);

411  
	`__bch_cut_‰⁄t
(
whîe
, 
k
);

412 
	}
}

414 
ölöe
 
boﬁ
 
	$bch_cut_back
(c⁄° 
bkey
 *
whîe
, bkey *
k
)

416 
	`BUG_ON
(
	`bkey_cmp
(
whîe
, &
	`START_KEY
(
k
)) < 0);

417  
	`__bch_cut_back
(
whîe
, 
k
);

418 
	}
}

420 
	#PRECEDING_KEY
(
_k
) \

422 
bkey
 *
_ªt
 = 
NULL
; \

424 i‡(
	`KEY_INODE
(
_k
Ë|| 
	`KEY_OFFSET
(_k)) { \

425 
_ªt
 = &
	`KEY
(
	`KEY_INODE
(
_k
), 
	`KEY_OFFSET
(_k), 0); \

427 i‡(!
_ªt
->
low
) \

428 
_ªt
->
high
--; \

429 
_ªt
->
low
--; \

432 
_ªt
; \

433 })

	)

435 
ölöe
 
boﬁ
 
	$bch_±r_övÆid
(
båì_keys
 *
b
, c⁄° 
bkey
 *
k
)

437  
b
->
›s
->
	`key_övÆid
(b, 
k
);

438 
	}
}

440 
ölöe
 
boﬁ
 
	$bch_±r_bad
(
båì_keys
 *
b
, c⁄° 
bkey
 *
k
)

442  
b
->
›s
->
	`key_bad
(b, 
k
);

443 
	}
}

445 
ölöe
 
	$bch_bkey_to_ãxt
(
båì_keys
 *
b
, *
buf
,

446 
size_t
 
size
, c⁄° 
bkey
 *
k
)

448  
b
->
›s
->
	`key_to_ãxt
(
buf
, 
size
, 
k
);

449 
	}
}

451 
ölöe
 
boﬁ
 
	$bch_bkey_equÆ_hódî
(c⁄° 
bkey
 *
l
,

452 c⁄° 
bkey
 *
r
)

454  (
	`KEY_DIRTY
(
l
Ë=KEY_DIRTY(
r
) &&

455 
	`KEY_PTRS
(
l
Ë=KEY_PTRS(
r
) &&

456 
	`KEY_CSUM
(
l
Ë=KEY_CSUM(
r
));

457 
	}
}

461 
	skeyli°
 {

463 
bkey
 *
	mkeys
;

464 
uöt64_t
 *
	mkeys_p
;

467 
bkey
 *
	mt›
;

468 
uöt64_t
 *
	mt›_p
;

472 
	#KEYLIST_INLINE
 16

	)

473 
uöt64_t
 
	mölöe_keys
[
KEYLIST_INLINE
];

476 
ölöe
 
	$bch_keyli°_öô
(
keyli°
 *
l
)

478 
l
->
t›_p
 =Ü->
keys_p
 =Ü->
ölöe_keys
;

479 
	}
}

481 
ölöe
 
	$bch_keyli°_öô_sögÀ
(
keyli°
 *
l
, 
bkey
 *
k
)

483 
l
->
keys
 = 
k
;

484 
l
->
t›
 = 
	`bkey_√xt
(
k
);

485 
	}
}

487 
ölöe
 
	$bch_keyli°_push
(
keyli°
 *
l
)

489 
l
->
t›
 = 
	`bkey_√xt
(l->top);

490 
	}
}

492 
ölöe
 
	$bch_keyli°_add
(
keyli°
 *
l
, 
bkey
 *
k
)

494 
	`bkey_c›y
(
l
->
t›
, 
k
);

495 
	`bch_keyli°_push
(
l
);

496 
	}
}

498 
ölöe
 
boﬁ
 
	$bch_keyli°_em±y
(
keyli°
 *
l
)

500  
l
->
t›
 =l->
keys
;

501 
	}
}

503 
ölöe
 
	$bch_keyli°_ª£t
(
keyli°
 *
l
)

505 
l
->
t›
 =Ü->
keys
;

506 
	}
}

508 
ölöe
 
	$bch_keyli°_‰ì
(
keyli°
 *
l
)

510 i‡(
l
->
keys_p
 !l->
ölöe_keys
)

511 
	`k‰ì
(
l
->
keys_p
);

512 
	}
}

514 
ölöe
 
size_t
 
	$bch_keyli°_nkeys
(
keyli°
 *
l
)

516  
l
->
t›_p
 -Ü->
keys_p
;

517 
	}
}

519 
ölöe
 
size_t
 
	$bch_keyli°_byãs
(
keyli°
 *
l
)

521  
	`bch_keyli°_nkeys
(
l
Ë* (
uöt64_t
);

522 
	}
}

524 
bkey
 *
bch_keyli°_p›
(
keyli°
 *);

525 
bch_keyli°_p›_‰⁄t
(
keyli°
 *);

526 
__bch_keyli°_ªÆloc
(
keyli°
 *, );

530 #ifde‡
CONFIG_BCACHE_DEBUG


532 
__bch_cou¡_d©a
(
båì_keys
 *);

533 
__bch_check_keys
(
båì_keys
 *, const *, ...);

534 
bch_dump_b£t
(
båì_keys
 *, 
b£t
 *, );

535 
bch_dump_buckë
(
båì_keys
 *);

539 
ölöe
 
	$__bch_cou¡_d©a
(
båì_keys
 *
b
Ë{  -1; 
	}
}

540 
ölöe
 
	$__bch_check_keys
(
båì_keys
 *
b
, c⁄° *
fmt
, ...Ë{
	}
}

541 
ölöe
 
	$bch_dump_buckë
(
båì_keys
 *
b
Ë{
	}
}

542 
bch_dump_b£t
(
båì_keys
 *, 
b£t
 *, );

546 
ölöe
 
boﬁ
 
	$båì_keys_ex≥nsive_checks
(
båì_keys
 *
b
)

548 #ifde‡
CONFIG_BCACHE_DEBUG


549  *
b
->
ex≥nsive_debug_checks
;

551  
Ál£
;

553 
	}
}

555 
ölöe
 
	$bch_cou¡_d©a
(
båì_keys
 *
b
)

557  
	`båì_keys_ex≥nsive_checks
(
b
Ë? 
	`__bch_cou¡_d©a
(b) : -1;

558 
	}
}

560 
	#bch_check_keys
(
b
, ...) \

562 i‡(
	`båì_keys_ex≥nsive_checks
(
b
)) \

563 
	`__bch_check_keys
(
b
, 
__VA_ARGS__
); \

564 } 0)

	)

	@bcache/btree.c

23 
	~"bˇche.h
"

24 
	~"båì.h
"

25 
	~"debug.h
"

26 
	~"exã¡s.h
"

28 
	~<löux/¶ab.h
>

29 
	~<löux/bô›s.h
>

30 
	~<löux/‰ìzî.h
>

31 
	~<löux/hash.h
>

32 
	~<löux/kthªad.h
>

33 
	~<löux/¥e„tch.h
>

34 
	~<löux/øndom.h
>

35 
	~<löux/rcupd©e.h
>

36 
	~<åa˚/evíts/bˇche.h
>

88 
	#MAX_NEED_GC
 64

	)

89 
	#MAX_SAVE_PRIO
 72

	)

91 
	#PTR_DIRTY_BIT
 (((
uöt64_t
Ë1 << 36))

	)

93 
	#PTR_HASH
(
c
, 
k
) \

94 (((
k
)->
±r
[0] >> 
c
->
buckë_bôs
Ë| 
	`PTR_GEN
(k, 0))

	)

96 
	#ö£π_lock
(
s
, 
b
Ë((b)->
Àvñ
 <(s)->
lock
)

	)

116 
	#båì
(
‚
, 
key
, 
b
, 
›
, ...) \

118 
_r
, 
l
 = (
b
)->
Àvñ
 - 1; \

119 
boﬁ
 
_w
 = 
l
 <(
›
)->
lock
; \

120 
båì
 *
_chûd
 = 
	`bch_båì_node_gë
((
b
)->
c
, 
›
, 
key
, 
l
, \

121 
_w
, 
b
); \

122 i‡(!
	`IS_ERR
(
_chûd
)) { \

123 
_r
 = 
bch_båì_
 ## 
	`‚
(
_chûd
, 
›
, ##
__VA_ARGS__
); \

124 
	`rw_u∆ock
(
_w
, 
_chûd
); \

126 
_r
 = 
	`PTR_ERR
(
_chûd
); \

127 
_r
; \

128 })

	)

136 
	#båì_roŸ
(
‚
, 
c
, 
›
, ...) \

138 
_r
 = -
EINTR
; \

140 
båì
 *
_b
 = (
c
)->
roŸ
; \

141 
boﬁ
 
_w
 = 
	`ö£π_lock
(
›
, 
_b
); \

142 
	`rw_lock
(
_w
, 
_b
, _b->
Àvñ
); \

143 i‡(
_b
 =(
c
)->
roŸ
 && \

144 
_w
 =
	`ö£π_lock
(
›
, 
_b
)) { \

145 
_r
 = 
bch_båì_
 ## 
	`‚
(
_b
, 
›
, ##
__VA_ARGS__
); \

147 
	`rw_u∆ock
(
_w
, 
_b
); \

148 
	`bch_ˇ¬ibÆize_u∆ock
(
c
); \

149 i‡(
_r
 =-
EINTR
) \

150 
	`scheduÀ
(); \

151 } 
_r
 =-
EINTR
); \

153 
	`föish_waô
(&(
c
)->
båì_ˇche_waô
, &(
›
)->
waô
); \

154 
_r
; \

155 })

	)

157 
ölöe
 
b£t
 *
	$wrôe_block
(
båì
 *
b
)

159  ((*Ë
	`båì_b£t_fú°
(
b
)Ë+ b->
wrôãn
 * 
	`block_byãs
(b->
c
);

160 
	}
}

162 
	$bch_båì_öô_√xt
(
båì
 *
b
)

165 i‡(
b
->
Àvñ
 && b->
keys
.
n£ts
)

166 
	`bch_båì_s‹t
(&
b
->
keys
, &b->
c
->
s‹t
);

168 
	`bch_båì_s‹t_œzy
(&
b
->
keys
, &b->
c
->
s‹t
);

170 i‡(
b
->
wrôãn
 < 
	`båì_blocks
(b))

171 
	`bch_b£t_öô_√xt
(&
b
->
keys
, 
	`wrôe_block
(b),

172 
	`b£t_magic
(&
b
->
c
->
sb
));

174 
	}
}

178 
	$bkey_put
(
ˇche_£t
 *
c
, 
bkey
 *
k
)

180 
i
;

182 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

183 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
i
))

184 
	`©omic_dec_bug
(&
	`PTR_BUCKET
(
c
, 
k
, 
i
)->
pö
);

185 
	}
}

189 
uöt64_t
 
	$båì_csum_£t
(
båì
 *
b
, 
b£t
 *
i
)

191 
uöt64_t
 
¸c
 = 
b
->
key
.
±r
[0];

192 *
d©a
 = (*Ë
i
 + 8, *
íd
 = 
	`b£t_bkey_œ°
(i);

194 
¸c
 = 
	`bch_¸c64_upd©e
(¸c, 
d©a
, 
íd
 - data);

195  
¸c
 ^ 0xffffffffffffffffULL;

196 
	}
}

198 
	$bch_båì_node_ªad_d⁄e
(
båì
 *
b
)

200 c⁄° *
îr
 = "bad btree header";

201 
b£t
 *
i
 = 
	`båì_b£t_fú°
(
b
);

202 
båì_ôî
 *
ôî
;

204 
ôî
 = 
	`mempoﬁ_Æloc
(
b
->
c
->
fûl_ôî
, 
GFP_NOIO
);

205 
ôî
->
size
 = 
b
->
c
->
sb
.
buckë_size
 / b->c->sb.
block_size
;

206 
ôî
->
u£d
 = 0;

208 #ifde‡
CONFIG_BCACHE_DEBUG


209 
ôî
->
b
 = &b->
keys
;

212 i‡(!
i
->
£q
)

213 
îr
;

216 
b
->
wrôãn
 < 
	`båì_blocks
(bË&& 
i
->
£q
 =b->
keys
.
£t
[0].
d©a
->seq;

217 
i
 = 
	`wrôe_block
(
b
)) {

218 
îr
 = "unsupported bset version";

219 i‡(
i
->
vîsi⁄
 > 
BCACHE_BSET_VERSION
)

220 
îr
;

222 
îr
 = "bad btree header";

223 i‡(
b
->
wrôãn
 + 
	`£t_blocks
(
i
, 
	`block_byãs
(b->
c
)) >

224 
	`båì_blocks
(
b
))

225 
îr
;

227 
îr
 = "bad magic";

228 i‡(
i
->
magic
 !
	`b£t_magic
(&
b
->
c
->
sb
))

229 
îr
;

231 
îr
 = "bad checksum";

232 
i
->
vîsi⁄
) {

234 i‡(
i
->
csum
 !
	`csum_£t
(i))

235 
îr
;

237 
BCACHE_BSET_VERSION
:

238 i‡(
i
->
csum
 !
	`båì_csum_£t
(
b
, i))

239 
îr
;

243 
îr
 = "empty set";

244 i‡(
i
 !
b
->
keys
.
£t
[0].
d©a
 && !i->keys)

245 
îr
;

247 
	`bch_båì_ôî_push
(
ôî
, 
i
->
°¨t
, 
	`b£t_bkey_œ°
(i));

249 
b
->
wrôãn
 +
	`£t_blocks
(
i
, 
	`block_byãs
(b->
c
));

252 
îr
 = "corrupted btree";

253 
i
 = 
	`wrôe_block
(
b
);

254 
	`b£t_£˘‹_off£t
(&
b
->
keys
, 
i
Ë< 
	`KEY_SIZE
(&b->
key
);

255 
i
 = ((*ËiË+ 
	`block_byãs
(
b
->
c
))

256 i‡(
i
->
£q
 =
b
->
keys
.
£t
[0].
d©a
->seq)

257 
îr
;

259 
	`bch_båì_s‹t_™d_fix_exã¡s
(&
b
->
keys
, 
ôî
, &b->
c
->
s‹t
);

261 
i
 = 
b
->
keys
.
£t
[0].
d©a
;

262 
îr
 = "short btree key";

263 i‡(
b
->
keys
.
£t
[0].
size
 &&

264 
	`bkey_cmp
(&
b
->
key
, &b->
keys
.
£t
[0].
íd
) < 0)

265 
îr
;

267 i‡(
b
->
wrôãn
 < 
	`båì_blocks
(b))

268 
	`bch_b£t_öô_√xt
(&
b
->
keys
, 
	`wrôe_block
(b),

269 
	`b£t_magic
(&
b
->
c
->
sb
));

270 
out
:

271 
	`mempoﬁ_‰ì
(
ôî
, 
b
->
c
->
fûl_ôî
);

273 
îr
:

274 
	`£t_båì_node_io_îr‹
(
b
);

275 
	`bch_ˇche_£t_îr‹
(
b
->
c
, "%sát bucket %zu, block %u, %u keys",

276 
îr
, 
	`PTR_BUCKET_NR
(
b
->
c
, &b->
key
, 0),

277 
	`b£t_block_off£t
(
b
, 
i
), i->
keys
);

278 
out
;

279 
	}
}

281 
	$båì_node_ªad_ídio
(
bio
 *bio, 
îr‹
)

283 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

284 
	`˛osuª_put
(
˛
);

285 
	}
}

287 
	$bch_båì_node_ªad
(
båì
 *
b
)

289 
uöt64_t
 
°¨t_time
 = 
	`loˇl_˛ock
();

290 
˛osuª
 
˛
;

291 
bio
 *bio;

293 
	`åa˚_bˇche_båì_ªad
(
b
);

295 
	`˛osuª_öô_°ack
(&
˛
);

297 
bio
 = 
	`bch_bbio_Æloc
(
b
->
c
);

298 
bio
->
bi_rw
 = 
REQ_META
|
READ_SYNC
;

299 
bio
->
bi_ôî
.
bi_size
 = 
	`KEY_SIZE
(&
b
->
key
) << 9;

300 
bio
->
bi_íd_io
 = 
båì_node_ªad_ídio
;

301 
bio
->
bi_¥iv©e
 = &
˛
;

303 
	`bch_bio_m≠
(
bio
, 
b
->
keys
.
£t
[0].
d©a
);

305 
	`bch_submô_bbio
(
bio
, 
b
->
c
, &b->
key
, 0);

306 
	`˛osuª_sync
(&
˛
);

308 i‡(!
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
))

309 
	`£t_båì_node_io_îr‹
(
b
);

311 
	`bch_bbio_‰ì
(
bio
, 
b
->
c
);

313 i‡(
	`båì_node_io_îr‹
(
b
))

314 
îr
;

316 
	`bch_båì_node_ªad_d⁄e
(
b
);

317 
	`bch_time_°©s_upd©e
(&
b
->
c
->
båì_ªad_time
, 
°¨t_time
);

320 
îr
:

321 
	`bch_ˇche_£t_îr‹
(
b
->
c
, "ioÉrrorÑeading bucket %zu",

322 
	`PTR_BUCKET_NR
(
b
->
c
, &b->
key
, 0));

323 
	}
}

325 
	$båì_com∂ëe_wrôe
(
båì
 *
b
, 
båì_wrôe
 *
w
)

327 i‡(
w
->
¥io_blocked
 &&

328 !
	`©omic_sub_ªtu∫
(
w
->
¥io_blocked
, &
b
->
c
->prio_blocked))

329 
	`wake_up_Æloˇt‹s
(
b
->
c
);

331 i‡(
w
->
jou∫Æ
) {

332 
	`©omic_dec_bug
(
w
->
jou∫Æ
);

333 
	`__˛osuª_wake_up
(&
b
->
c
->
jou∫Æ
.
waô
);

336 
w
->
¥io_blocked
 = 0;

337 
w
->
jou∫Æ
 = 
NULL
;

338 
	}
}

340 
	$båì_node_wrôe_u∆ock
(
˛osuª
 *
˛
)

342 
båì
 *
b
 = 
	`c⁄èöî_of
(
˛
, båì, 
io
);

344 
	`up
(&
b
->
io_muãx
);

345 
	}
}

347 
	$__båì_node_wrôe_d⁄e
(
˛osuª
 *
˛
)

349 
båì
 *
b
 = 
	`c⁄èöî_of
(
˛
, båì, 
io
);

350 
båì_wrôe
 *
w
 = 
	`båì_¥ev_wrôe
(
b
);

352 
	`bch_bbio_‰ì
(
b
->
bio
, b->
c
);

353 
b
->
bio
 = 
NULL
;

354 
	`båì_com∂ëe_wrôe
(
b
, 
w
);

356 i‡(
	`båì_node_dúty
(
b
))

357 
	`scheduÀ_dñayed_w‹k
(&
b
->
w‹k
, 30 * 
HZ
);

359 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
båì_node_wrôe_u∆ock
);

360 
	}
}

362 
	$båì_node_wrôe_d⁄e
(
˛osuª
 *
˛
)

364 
båì
 *
b
 = 
	`c⁄èöî_of
(
˛
, båì, 
io
);

365 
bio_vec
 *
bv
;

366 
n
;

368 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
b
->
bio
, 
n
)

369 
	`__‰ì_∑ge
(
bv
->
bv_∑ge
);

371 
	`__båì_node_wrôe_d⁄e
(
˛
);

372 
	}
}

374 
	$båì_node_wrôe_ídio
(
bio
 *bio, 
îr‹
)

376 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

377 
båì
 *
b
 = 
	`c⁄èöî_of
(
˛
, båì, 
io
);

379 i‡(
îr‹
)

380 
	`£t_båì_node_io_îr‹
(
b
);

382 
	`bch_bbio_cou¡_io_îr‹s
(
b
->
c
, 
bio
, 
îr‹
, "writing btree");

383 
	`˛osuª_put
(
˛
);

384 
	}
}

386 
	$do_båì_node_wrôe
(
båì
 *
b
)

388 
˛osuª
 *
˛
 = &
b
->
io
;

389 
b£t
 *
i
 = 
	`båì_b£t_œ°
(
b
);

390 
	`BKEY_PADDED
(
key
Ë
k
;

392 
i
->
vîsi⁄
 = 
BCACHE_BSET_VERSION
;

393 
i
->
csum
 = 
	`båì_csum_£t
(
b
, i);

395 
	`BUG_ON
(
b
->
bio
);

396 
b
->
bio
 = 
	`bch_bbio_Æloc
(b->
c
);

398 
b
->
bio
->
bi_íd_io
 = 
båì_node_wrôe_ídio
;

399 
b
->
bio
->
bi_¥iv©e
 = 
˛
;

400 
b
->
bio
->
bi_rw
 = 
REQ_META
|
WRITE_SYNC
|
REQ_FUA
;

401 
b
->
bio
->
bi_ôî
.
bi_size
 = 
	`roundup
(
	`£t_byãs
(
i
), 
	`block_byãs
(b->
c
));

402 
	`bch_bio_m≠
(
b
->
bio
, 
i
);

419 
	`bkey_c›y
(&
k
.
key
, &
b
->key);

420 
	`SET_PTR_OFFSET
(&
k
.
key
, 0, 
	`PTR_OFFSET
(&k.key, 0) +

421 
	`b£t_£˘‹_off£t
(&
b
->
keys
, 
i
));

423 i‡(!
	`bio_Æloc_∑ges
(
b
->
bio
, 
__GFP_NOWARN
|
GFP_NOWAIT
)) {

424 
j
;

425 
bio_vec
 *
bv
;

426 *
ba£
 = (*Ë((Ë
i
 & ~(
PAGE_SIZE
 - 1));

428 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
b
->
bio
, 
j
)

429 
	`mem˝y
(
	`∑ge_addªss
(
bv
->
bv_∑ge
),

430 
ba£
 + 
j
 * 
PAGE_SIZE
, PAGE_SIZE);

432 
	`bch_submô_bbio
(
b
->
bio
, b->
c
, &
k
.
key
, 0);

434 
	`c⁄töue_©
(
˛
, 
båì_node_wrôe_d⁄e
, 
NULL
);

436 
b
->
bio
->
bi_v˙t
 = 0;

437 
	`bch_bio_m≠
(
b
->
bio
, 
i
);

439 
	`bch_submô_bbio
(
b
->
bio
, b->
c
, &
k
.
key
, 0);

441 
	`˛osuª_sync
(
˛
);

442 
	`c⁄töue_©_nob¨rõr
(
˛
, 
__båì_node_wrôe_d⁄e
, 
NULL
);

444 
	}
}

446 
	$__bch_båì_node_wrôe
(
båì
 *
b
, 
˛osuª
 *
∑ª¡
)

448 
b£t
 *
i
 = 
	`båì_b£t_œ°
(
b
);

450 
	`lockdï_as£π_hñd
(&
b
->
wrôe_lock
);

452 
	`åa˚_bˇche_båì_wrôe
(
b
);

454 
	`BUG_ON
(
cuºít
->
bio_li°
);

455 
	`BUG_ON
(
b
->
wrôãn
 >
	`båì_blocks
(b));

456 
	`BUG_ON
(
b
->
wrôãn
 && !
i
->
keys
);

457 
	`BUG_ON
(
	`båì_b£t_fú°
(
b
)->
£q
 !
i
->seq);

458 
	`bch_check_keys
(&
b
->
keys
, "writing");

460 
	`ˇn˚l_dñayed_w‹k
(&
b
->
w‹k
);

463 
	`down
(&
b
->
io_muãx
);

464 
	`˛osuª_öô
(&
b
->
io
, 
∑ª¡
 ?: &b->
c
->
˛
);

466 
	`˛ór_bô
(
BTREE_NODE_dúty
, &
b
->
Êags
);

467 
	`ch™ge_bô
(
BTREE_NODE_wrôe_idx
, &
b
->
Êags
);

469 
	`do_båì_node_wrôe
(
b
);

471 
	`©omic_l⁄g_add
(
	`£t_blocks
(
i
, 
	`block_byãs
(
b
->
c
)Ë* b->c->
sb
.
block_size
,

472 &
	`PTR_CACHE
(
b
->
c
, &b->
key
, 0)->
båì_£˘‹s_wrôãn
);

474 
b
->
wrôãn
 +
	`£t_blocks
(
i
, 
	`block_byãs
(b->
c
));

475 
	}
}

477 
	$bch_båì_node_wrôe
(
båì
 *
b
, 
˛osuª
 *
∑ª¡
)

479 
n£ts
 = 
b
->
keys
.nsets;

481 
	`lockdï_as£π_hñd
(&
b
->
lock
);

483 
	`__bch_båì_node_wrôe
(
b
, 
∑ª¡
);

489 i‡(
n£ts
 && !
b
->
keys
.nsets)

490 
	`bch_båì_vîify
(
b
);

492 
	`bch_båì_öô_√xt
(
b
);

493 
	}
}

495 
	$bch_båì_node_wrôe_sync
(
båì
 *
b
)

497 
˛osuª
 
˛
;

499 
	`˛osuª_öô_°ack
(&
˛
);

501 
	`muãx_lock
(&
b
->
wrôe_lock
);

502 
	`bch_båì_node_wrôe
(
b
, &
˛
);

503 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

505 
	`˛osuª_sync
(&
˛
);

506 
	}
}

508 
	$båì_node_wrôe_w‹k
(
w‹k_°ru˘
 *
w
)

510 
båì
 *
b
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w
), båì, 
w‹k
);

512 
	`muãx_lock
(&
b
->
wrôe_lock
);

513 i‡(
	`båì_node_dúty
(
b
))

514 
	`__bch_båì_node_wrôe
(
b
, 
NULL
);

515 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

516 
	}
}

518 
	$bch_båì_Àaf_dúty
(
båì
 *
b
, 
©omic_t
 *
jou∫Æ_ªf
)

520 
b£t
 *
i
 = 
	`båì_b£t_œ°
(
b
);

521 
båì_wrôe
 *
w
 = 
	`båì_cuºít_wrôe
(
b
);

523 
	`lockdï_as£π_hñd
(&
b
->
wrôe_lock
);

525 
	`BUG_ON
(!
b
->
wrôãn
);

526 
	`BUG_ON
(!
i
->
keys
);

528 i‡(!
	`båì_node_dúty
(
b
))

529 
	`scheduÀ_dñayed_w‹k
(&
b
->
w‹k
, 30 * 
HZ
);

531 
	`£t_båì_node_dúty
(
b
);

533 i‡(
jou∫Æ_ªf
) {

534 i‡(
w
->
jou∫Æ
 &&

535 
	`jou∫Æ_pö_cmp
(
b
->
c
, 
w
->
jou∫Æ
, 
jou∫Æ_ªf
)) {

536 
	`©omic_dec_bug
(
w
->
jou∫Æ
);

537 
w
->
jou∫Æ
 = 
NULL
;

540 i‡(!
w
->
jou∫Æ
) {

541 
w
->
jou∫Æ
 = 
jou∫Æ_ªf
;

542 
	`©omic_öc
(
w
->
jou∫Æ
);

547 i‡(
	`£t_byãs
(
i
Ë> 
PAGE_SIZE
 - 48 &&

548 !
cuºít
->
bio_li°
)

549 
	`bch_båì_node_wrôe
(
b
, 
NULL
);

550 
	}
}

557 
	#mˇ_ª£rve
(
c
Ë(((c->
roŸ
 && c->roŸ->
Àvñ
) \

558 ? 
c
->
roŸ
->
Àvñ
 : 1Ë* 8 + 16)

	)

559 
	#mˇ_ˇn_‰ì
(
c
) \

560 
	`max_t
(, 0, 
c
->
båì_ˇche_u£d
 - 
	`mˇ_ª£rve
(c))

	)

562 
	$mˇ_d©a_‰ì
(
båì
 *
b
)

564 
	`BUG_ON
(
b
->
io_muãx
.
cou¡
 != 1);

566 
	`bch_båì_keys_‰ì
(&
b
->
keys
);

568 
b
->
c
->
båì_ˇche_u£d
--;

569 
	`li°_move
(&
b
->
li°
, &b->
c
->
båì_ˇche_‰ìd
);

570 
	}
}

572 
	$mˇ_buckë_‰ì
(
båì
 *
b
)

574 
	`BUG_ON
(
	`båì_node_dúty
(
b
));

576 
b
->
key
.
±r
[0] = 0;

577 
	`hli°_dñ_öô_rcu
(&
b
->
hash
);

578 
	`li°_move
(&
b
->
li°
, &b->
c
->
båì_ˇche_‰ìabÀ
);

579 
	}
}

581 
	$båì_‹dî
(
bkey
 *
k
)

583  
	`ûog2
(
	`KEY_SIZE
(
k
Ë/ 
PAGE_SECTORS
 ?: 1);

584 
	}
}

586 
	$mˇ_d©a_Æloc
(
båì
 *
b
, 
bkey
 *
k
, 
gÂ_t
 
gÂ
)

588 i‡(!
	`bch_båì_keys_Æloc
(&
b
->
keys
,

589 
	`max_t
(,

590 
	`ûog2
(
b
->
c
->
båì_∑ges
),

591 
	`båì_‹dî
(
k
)),

592 
gÂ
)) {

593 
b
->
c
->
båì_ˇche_u£d
++;

594 
	`li°_move
(&
b
->
li°
, &b->
c
->
båì_ˇche
);

596 
	`li°_move
(&
b
->
li°
, &b->
c
->
båì_ˇche_‰ìd
);

598 
	}
}

600 
båì
 *
	$mˇ_buckë_Æloc
(
ˇche_£t
 *
c
,

601 
bkey
 *
k
, 
gÂ_t
 
gÂ
)

603 
båì
 *
b
 = 
	`kzÆloc
((båì), 
gÂ
);

604 i‡(!
b
)

605  
NULL
;

607 
	`öô_rw£m
(&
b
->
lock
);

608 
	`lockdï_£t_novÆid©e_˛ass
(&
b
->
lock
);

609 
	`muãx_öô
(&
b
->
wrôe_lock
);

610 
	`lockdï_£t_novÆid©e_˛ass
(&
b
->
wrôe_lock
);

611 
	`INIT_LIST_HEAD
(&
b
->
li°
);

612 
	`INIT_DELAYED_WORK
(&
b
->
w‹k
, 
båì_node_wrôe_w‹k
);

613 
b
->
c
 = c;

614 
	`£ma_öô
(&
b
->
io_muãx
, 1);

616 
	`mˇ_d©a_Æloc
(
b
, 
k
, 
gÂ
);

617  
b
;

618 
	}
}

620 
	$mˇ_ª≠
(
båì
 *
b
, 
mö_‹dî
, 
boﬁ
 
Êush
)

622 
˛osuª
 
˛
;

624 
	`˛osuª_öô_°ack
(&
˛
);

625 
	`lockdï_as£π_hñd
(&
b
->
c
->
buckë_lock
);

627 i‡(!
	`down_wrôe_åylock
(&
b
->
lock
))

628  -
ENOMEM
;

630 
	`BUG_ON
(
	`båì_node_dúty
(
b
Ë&& !b->
keys
.
£t
[0].
d©a
);

632 i‡(
b
->
keys
.
∑ge_‹dî
 < 
mö_‹dî
)

633 
out_u∆ock
;

635 i‡(!
Êush
) {

636 i‡(
	`båì_node_dúty
(
b
))

637 
out_u∆ock
;

639 i‡(
	`down_åylock
(&
b
->
io_muãx
))

640 
out_u∆ock
;

641 
	`up
(&
b
->
io_muãx
);

644 
	`muãx_lock
(&
b
->
wrôe_lock
);

645 i‡(
	`båì_node_dúty
(
b
))

646 
	`__bch_båì_node_wrôe
(
b
, &
˛
);

647 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

649 
	`˛osuª_sync
(&
˛
);

652 
	`down
(&
b
->
io_muãx
);

653 
	`up
(&
b
->
io_muãx
);

656 
out_u∆ock
:

657 
	`rw_u∆ock
(
åue
, 
b
);

658  -
ENOMEM
;

659 
	}
}

661 
	$bch_mˇ_sˇn
(
shrökî
 *
shrök
,

662 
shrök_c⁄åﬁ
 *
sc
)

664 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
shrök
, cache_set, shrink);

665 
båì
 *
b
, *
t
;

666 
i
, 
ƒ
 = 
sc
->
ƒ_to_sˇn
;

667 
‰ìd
 = 0;

669 i‡(
c
->
shrökî_dißbÀd
)

670  
SHRINK_STOP
;

672 i‡(
c
->
båì_ˇche_Æloc_lock
)

673  
SHRINK_STOP
;

676 i‡(
sc
->
gÂ_mask
 & 
__GFP_IO
)

677 
	`muãx_lock
(&
c
->
buckë_lock
);

678 i‡(!
	`muãx_åylock
(&
c
->
buckë_lock
))

688 
ƒ
 /
c
->
båì_∑ges
;

689 
ƒ
 = 
	`mö_t
(,Çr, 
	`mˇ_ˇn_‰ì
(
c
));

691 
i
 = 0;

692 
	`li°_f‹_óch_íåy_ß„
(
b
, 
t
, &
c
->
båì_ˇche_‰ìabÀ
, 
li°
) {

693 i‡(
‰ìd
 >
ƒ
)

696 i‡(++
i
 > 3 &&

697 !
	`mˇ_ª≠
(
b
, 0, 
Ál£
)) {

698 
	`mˇ_d©a_‰ì
(
b
);

699 
	`rw_u∆ock
(
åue
, 
b
);

700 
‰ìd
++;

704 
i
 = 0; (
ƒ
--Ë&& i < 
c
->
båì_ˇche_u£d
; i++) {

705 i‡(
	`li°_em±y
(&
c
->
båì_ˇche
))

706 
out
;

708 
b
 = 
	`li°_fú°_íåy
(&
c
->
båì_ˇche
, 
båì
, 
li°
);

709 
	`li°_rŸ©e_À·
(&
c
->
båì_ˇche
);

711 i‡(!
b
->
ac˚s£d
 &&

712 !
	`mˇ_ª≠
(
b
, 0, 
Ál£
)) {

713 
	`mˇ_buckë_‰ì
(
b
);

714 
	`mˇ_d©a_‰ì
(
b
);

715 
	`rw_u∆ock
(
åue
, 
b
);

716 
‰ìd
++;

718 
b
->
ac˚s£d
 = 0;

720 
out
:

721 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

722  
‰ìd
;

723 
	}
}

725 
	$bch_mˇ_cou¡
(
shrökî
 *
shrök
,

726 
shrök_c⁄åﬁ
 *
sc
)

728 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
shrök
, cache_set, shrink);

730 i‡(
c
->
shrökî_dißbÀd
)

733 i‡(
c
->
båì_ˇche_Æloc_lock
)

736  
	`mˇ_ˇn_‰ì
(
c
Ë* c->
båì_∑ges
;

737 
	}
}

739 
	$bch_båì_ˇche_‰ì
(
ˇche_£t
 *
c
)

741 
båì
 *
b
;

742 
˛osuª
 
˛
;

743 
	`˛osuª_öô_°ack
(&
˛
);

745 i‡(
c
->
shrök
.
li°
.
√xt
)

746 
	`uƒegi°î_shrökî
(&
c
->
shrök
);

748 
	`muãx_lock
(&
c
->
buckë_lock
);

750 #ifde‡
CONFIG_BCACHE_DEBUG


751 i‡(
c
->
vîify_d©a
)

752 
	`li°_move
(&
c
->
vîify_d©a
->
li°
, &c->
båì_ˇche
);

754 
	`‰ì_∑ges
((Ë
c
->
vîify_⁄disk
, 
	`ûog2
(
	`buckë_∑ges
(c)));

757 
	`li°_•li˚
(&
c
->
båì_ˇche_‰ìabÀ
,

758 &
c
->
båì_ˇche
);

760 !
	`li°_em±y
(&
c
->
båì_ˇche
)) {

761 
b
 = 
	`li°_fú°_íåy
(&
c
->
båì_ˇche
, 
båì
, 
li°
);

763 i‡(
	`båì_node_dúty
(
b
))

764 
	`båì_com∂ëe_wrôe
(
b
, 
	`båì_cuºít_wrôe
(b));

765 
	`˛ór_bô
(
BTREE_NODE_dúty
, &
b
->
Êags
);

767 
	`mˇ_d©a_‰ì
(
b
);

770 !
	`li°_em±y
(&
c
->
båì_ˇche_‰ìd
)) {

771 
b
 = 
	`li°_fú°_íåy
(&
c
->
båì_ˇche_‰ìd
,

772 
båì
, 
li°
);

773 
	`li°_dñ
(&
b
->
li°
);

774 
	`ˇn˚l_dñayed_w‹k_sync
(&
b
->
w‹k
);

775 
	`k‰ì
(
b
);

778 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

779 
	}
}

781 
	$bch_båì_ˇche_Æloc
(
ˇche_£t
 *
c
)

783 
i
;

785 
i
 = 0; i < 
	`mˇ_ª£rve
(
c
); i++)

786 i‡(!
	`mˇ_buckë_Æloc
(
c
, &
ZERO_KEY
, 
GFP_KERNEL
))

787  -
ENOMEM
;

789 
	`li°_•li˚_öô
(&
c
->
båì_ˇche
,

790 &
c
->
båì_ˇche_‰ìabÀ
);

792 #ifde‡
CONFIG_BCACHE_DEBUG


793 
	`muãx_öô
(&
c
->
vîify_lock
);

795 
c
->
vîify_⁄disk
 = (*)

796 
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`ûog2
(
	`buckë_∑ges
(
c
)));

798 
c
->
vîify_d©a
 = 
	`mˇ_buckë_Æloc
(c, &
ZERO_KEY
, 
GFP_KERNEL
);

800 i‡(
c
->
vîify_d©a
 &&

801 
c
->
vîify_d©a
->
keys
.
£t
->
d©a
)

802 
	`li°_dñ_öô
(&
c
->
vîify_d©a
->
li°
);

804 
c
->
vîify_d©a
 = 
NULL
;

807 
c
->
shrök
.
cou¡_obje˘s
 = 
bch_mˇ_cou¡
;

808 
c
->
shrök
.
sˇn_obje˘s
 = 
bch_mˇ_sˇn
;

809 
c
->
shrök
.
£eks
 = 4;

810 
c
->
shrök
.
b©ch
 = c->
båì_∑ges
 * 2;

811 
	`ªgi°î_shrökî
(&
c
->
shrök
);

814 
	}
}

818 
hli°_hód
 *
	$mˇ_hash
(
ˇche_£t
 *
c
, 
bkey
 *
k
)

820  &
c
->
buckë_hash
[
	`hash_32
(
	`PTR_HASH
(c, 
k
), 
BUCKET_HASH_BITS
)];

821 
	}
}

823 
båì
 *
	$mˇ_föd
(
ˇche_£t
 *
c
, 
bkey
 *
k
)

825 
båì
 *
b
;

827 
	`rcu_ªad_lock
();

828 
	`hli°_f‹_óch_íåy_rcu
(
b
, 
	`mˇ_hash
(
c
, 
k
), 
hash
)

829 i‡(
	`PTR_HASH
(
c
, &
b
->
key
Ë=PTR_HASH(c, 
k
))

830 
out
;

831 
b
 = 
NULL
;

832 
out
:

833 
	`rcu_ªad_u∆ock
();

834  
b
;

835 
	}
}

837 
	$mˇ_ˇ¬ibÆize_lock
(
ˇche_£t
 *
c
, 
båì_›
 *
›
)

839 
èsk_°ru˘
 *
ﬁd
;

841 
ﬁd
 = 
	`cmpxchg
(&
c
->
båì_ˇche_Æloc_lock
, 
NULL
, 
cuºít
);

842 i‡(
ﬁd
 && old !
cuºít
) {

843 i‡(
›
)

844 
	`¥ï¨e_to_waô
(&
c
->
båì_ˇche_waô
, &
›
->
waô
,

845 
TASK_UNINTERRUPTIBLE
);

846  -
EINTR
;

850 
	}
}

852 
båì
 *
	$mˇ_ˇ¬ibÆize
(
ˇche_£t
 *
c
, 
båì_›
 *
›
,

853 
bkey
 *
k
)

855 
båì
 *
b
;

857 
	`åa˚_bˇche_båì_ˇche_ˇ¬ibÆize
(
c
);

859 i‡(
	`mˇ_ˇ¬ibÆize_lock
(
c
, 
›
))

860  
	`ERR_PTR
(-
EINTR
);

862 
	`li°_f‹_óch_íåy_ªvî£
(
b
, &
c
->
båì_ˇche
, 
li°
)

863 i‡(!
	`mˇ_ª≠
(
b
, 
	`båì_‹dî
(
k
), 
Ál£
))

864  
b
;

866 
	`li°_f‹_óch_íåy_ªvî£
(
b
, &
c
->
båì_ˇche
, 
li°
)

867 i‡(!
	`mˇ_ª≠
(
b
, 
	`båì_‹dî
(
k
), 
åue
))

868  
b
;

870 
	`WARN
(1, "btree cache cannibalize failed\n");

871  
	`ERR_PTR
(-
ENOMEM
);

872 
	}
}

880 
	$bch_ˇ¬ibÆize_u∆ock
(
ˇche_£t
 *
c
)

882 i‡(
c
->
båì_ˇche_Æloc_lock
 =
cuºít
) {

883 
c
->
båì_ˇche_Æloc_lock
 = 
NULL
;

884 
	`wake_up
(&
c
->
båì_ˇche_waô
);

886 
	}
}

888 
båì
 *
	$mˇ_Æloc
(
ˇche_£t
 *
c
, 
båì_›
 *
›
,

889 
bkey
 *
k
, 
Àvñ
)

891 
båì
 *
b
;

893 
	`BUG_ON
(
cuºít
->
bio_li°
);

895 
	`lockdï_as£π_hñd
(&
c
->
buckë_lock
);

897 i‡(
	`mˇ_föd
(
c
, 
k
))

898  
NULL
;

903 
	`li°_f‹_óch_íåy
(
b
, &
c
->
båì_ˇche_‰ìabÀ
, 
li°
)

904 i‡(!
	`mˇ_ª≠
(
b
, 
	`båì_‹dî
(
k
), 
Ál£
))

905 
out
;

910 
	`li°_f‹_óch_íåy
(
b
, &
c
->
båì_ˇche_‰ìd
, 
li°
)

911 i‡(!
	`mˇ_ª≠
(
b
, 0, 
Ál£
)) {

912 
	`mˇ_d©a_Æloc
(
b
, 
k
, 
__GFP_NOWARN
|
GFP_NOIO
);

913 i‡(!
b
->
keys
.
£t
[0].
d©a
)

914 
îr
;

916 
out
;

919 
b
 = 
	`mˇ_buckë_Æloc
(
c
, 
k
, 
__GFP_NOWARN
|
GFP_NOIO
);

920 i‡(!
b
)

921 
îr
;

923 
	`BUG_ON
(!
	`down_wrôe_åylock
(&
b
->
lock
));

924 i‡(!
b
->
keys
.
£t
->
d©a
)

925 
îr
;

926 
out
:

927 
	`BUG_ON
(
b
->
io_muãx
.
cou¡
 != 1);

929 
	`bkey_c›y
(&
b
->
key
, 
k
);

930 
	`li°_move
(&
b
->
li°
, &
c
->
båì_ˇche
);

931 
	`hli°_dñ_öô_rcu
(&
b
->
hash
);

932 
	`hli°_add_hód_rcu
(&
b
->
hash
, 
	`mˇ_hash
(
c
, 
k
));

934 
	`lock_£t_sub˛ass
(&
b
->
lock
.
dï_m≠
, 
Àvñ
 + 1, 
_THIS_IP_
);

935 
b
->
∑ª¡
 = (*) ~0UL;

936 
b
->
Êags
 = 0;

937 
b
->
wrôãn
 = 0;

938 
b
->
Àvñ
 =Üevel;

940 i‡(!
b
->
Àvñ
)

941 
	`bch_båì_keys_öô
(&
b
->
keys
, &
bch_exã¡_keys_›s
,

942 &
b
->
c
->
ex≥nsive_debug_checks
);

944 
	`bch_båì_keys_öô
(&
b
->
keys
, &
bch_båì_keys_›s
,

945 &
b
->
c
->
ex≥nsive_debug_checks
);

947  
b
;

948 
îr
:

949 i‡(
b
)

950 
	`rw_u∆ock
(
åue
, 
b
);

952 
b
 = 
	`mˇ_ˇ¬ibÆize
(
c
, 
›
, 
k
);

953 i‡(!
	`IS_ERR
(
b
))

954 
out
;

956  
b
;

957 
	}
}

968 
båì
 *
	$bch_båì_node_gë
(
ˇche_£t
 *
c
, 
båì_›
 *
›
,

969 
bkey
 *
k
, 
Àvñ
, 
boﬁ
 
wrôe
,

970 
båì
 *
∑ª¡
)

972 
i
 = 0;

973 
båì
 *
b
;

975 
	`BUG_ON
(
Àvñ
 < 0);

976 
ªåy
:

977 
b
 = 
	`mˇ_föd
(
c
, 
k
);

979 i‡(!
b
) {

980 i‡(
cuºít
->
bio_li°
)

981  
	`ERR_PTR
(-
EAGAIN
);

983 
	`muãx_lock
(&
c
->
buckë_lock
);

984 
b
 = 
	`mˇ_Æloc
(
c
, 
›
, 
k
, 
Àvñ
);

985 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

987 i‡(!
b
)

988 
ªåy
;

989 i‡(
	`IS_ERR
(
b
))

990  
b
;

992 
	`bch_båì_node_ªad
(
b
);

994 i‡(!
wrôe
)

995 
	`downgøde_wrôe
(&
b
->
lock
);

997 
	`rw_lock
(
wrôe
, 
b
, 
Àvñ
);

998 i‡(
	`PTR_HASH
(
c
, &
b
->
key
Ë!PTR_HASH(c, 
k
)) {

999 
	`rw_u∆ock
(
wrôe
, 
b
);

1000 
ªåy
;

1002 
	`BUG_ON
(
b
->
Àvñ
 !=Üevel);

1005 
b
->
∑ª¡
 =Öarent;

1006 
b
->
ac˚s£d
 = 1;

1008 ; 
i
 <
b
->
keys
.
n£ts
 && b->keys.
£t
[i].
size
; i++) {

1009 
	`¥e„tch
(
b
->
keys
.
£t
[
i
].
åì
);

1010 
	`¥e„tch
(
b
->
keys
.
£t
[
i
].
d©a
);

1013 ; 
i
 <
b
->
keys
.
n£ts
; i++)

1014 
	`¥e„tch
(
b
->
keys
.
£t
[
i
].
d©a
);

1016 i‡(
	`båì_node_io_îr‹
(
b
)) {

1017 
	`rw_u∆ock
(
wrôe
, 
b
);

1018  
	`ERR_PTR
(-
EIO
);

1021 
	`BUG_ON
(!
b
->
wrôãn
);

1023  
b
;

1024 
	}
}

1026 
	$båì_node_¥e„tch
(
båì
 *
∑ª¡
, 
bkey
 *
k
)

1028 
båì
 *
b
;

1030 
	`muãx_lock
(&
∑ª¡
->
c
->
buckë_lock
);

1031 
b
 = 
	`mˇ_Æloc
(
∑ª¡
->
c
, 
NULL
, 
k
,Ö¨ít->
Àvñ
 - 1);

1032 
	`muãx_u∆ock
(&
∑ª¡
->
c
->
buckë_lock
);

1034 i‡(!
	`IS_ERR_OR_NULL
(
b
)) {

1035 
b
->
∑ª¡
 =Öarent;

1036 
	`bch_båì_node_ªad
(
b
);

1037 
	`rw_u∆ock
(
åue
, 
b
);

1039 
	}
}

1043 
	$båì_node_‰ì
(
båì
 *
b
)

1045 
	`åa˚_bˇche_båì_node_‰ì
(
b
);

1047 
	`BUG_ON
(
b
 =b->
c
->
roŸ
);

1049 
	`muãx_lock
(&
b
->
wrôe_lock
);

1051 i‡(
	`båì_node_dúty
(
b
))

1052 
	`båì_com∂ëe_wrôe
(
b
, 
	`båì_cuºít_wrôe
(b));

1053 
	`˛ór_bô
(
BTREE_NODE_dúty
, &
b
->
Êags
);

1055 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

1057 
	`ˇn˚l_dñayed_w‹k
(&
b
->
w‹k
);

1059 
	`muãx_lock
(&
b
->
c
->
buckë_lock
);

1060 
	`bch_buckë_‰ì
(
b
->
c
, &b->
key
);

1061 
	`mˇ_buckë_‰ì
(
b
);

1062 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

1063 
	}
}

1065 
båì
 *
	$__bch_båì_node_Æloc
(
ˇche_£t
 *
c
, 
båì_›
 *
›
,

1066 
Àvñ
, 
boﬁ
 
waô
,

1067 
båì
 *
∑ª¡
)

1069 
	`BKEY_PADDED
(
key
Ë
k
;

1070 
båì
 *
b
 = 
	`ERR_PTR
(-
EAGAIN
);

1072 
	`muãx_lock
(&
c
->
buckë_lock
);

1073 
ªåy
:

1074 i‡(
	`__bch_buckë_Æloc_£t
(
c
, 
RESERVE_BTREE
, &
k
.
key
, 1, 
waô
))

1075 
îr
;

1077 
	`bkey_put
(
c
, &
k
.
key
);

1078 
	`SET_KEY_SIZE
(&
k
.
key
, 
c
->
båì_∑ges
 * 
PAGE_SECTORS
);

1080 
b
 = 
	`mˇ_Æloc
(
c
, 
›
, &
k
.
key
, 
Àvñ
);

1081 i‡(
	`IS_ERR
(
b
))

1082 
îr_‰ì
;

1084 i‡(!
b
) {

1085 
	`ˇche_bug
(
c
,

1087 
ªåy
;

1090 
b
->
ac˚s£d
 = 1;

1091 
b
->
∑ª¡
 =Öarent;

1092 
	`bch_b£t_öô_√xt
(&
b
->
keys
, b->keys.
£t
->
d©a
, 
	`b£t_magic
(&b->
c
->
sb
));

1094 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1096 
	`åa˚_bˇche_båì_node_Æloc
(
b
);

1097  
b
;

1098 
îr_‰ì
:

1099 
	`bch_buckë_‰ì
(
c
, &
k
.
key
);

1100 
îr
:

1101 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1103 
	`åa˚_bˇche_båì_node_Æloc_Áû
(
c
);

1104  
b
;

1105 
	}
}

1107 
båì
 *
	$bch_båì_node_Æloc
(
ˇche_£t
 *
c
,

1108 
båì_›
 *
›
, 
Àvñ
,

1109 
båì
 *
∑ª¡
)

1111  
	`__bch_båì_node_Æloc
(
c
, 
›
, 
Àvñ
, o∞!
NULL
, 
∑ª¡
);

1112 
	}
}

1114 
båì
 *
	$båì_node_Æloc_ª∂a˚mít
(
båì
 *
b
,

1115 
båì_›
 *
›
)

1117 
båì
 *
n
 = 
	`bch_båì_node_Æloc
(
b
->
c
, 
›
, b->
Àvñ
, b->
∑ª¡
);

1118 i‡(!
	`IS_ERR_OR_NULL
(
n
)) {

1119 
	`muãx_lock
(&
n
->
wrôe_lock
);

1120 
	`bch_båì_s‹t_öto
(&
b
->
keys
, &
n
->keys, &b->
c
->
s‹t
);

1121 
	`bkey_c›y_key
(&
n
->
key
, &
b
->key);

1122 
	`muãx_u∆ock
(&
n
->
wrôe_lock
);

1125  
n
;

1126 
	}
}

1128 
	$make_båì_‰ìög_key
(
båì
 *
b
, 
bkey
 *
k
)

1130 
i
;

1132 
	`muãx_lock
(&
b
->
c
->
buckë_lock
);

1134 
	`©omic_öc
(&
b
->
c
->
¥io_blocked
);

1136 
	`bkey_c›y
(
k
, &
b
->
key
);

1137 
	`bkey_c›y_key
(
k
, &
ZERO_KEY
);

1139 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

1140 
	`SET_PTR_GEN
(
k
, 
i
,

1141 
	`bch_öc_gí
(
	`PTR_CACHE
(
b
->
c
, &b->
key
, 
i
),

1142 
	`PTR_BUCKET
(
b
->
c
, &b->
key
, 
i
)));

1144 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

1145 
	}
}

1147 
	$båì_check_ª£rve
(
båì
 *
b
, 
båì_›
 *
›
)

1149 
ˇche_£t
 *
c
 = 
b
->c;

1150 
ˇche
 *
ˇ
;

1151 
i
, 
ª£rve
 = (
c
->
roŸ
->
Àvñ
 - 
b
->level) * 2 + 1;

1153 
	`muãx_lock
(&
c
->
buckë_lock
);

1155 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1156 i‡(
	`fifo_u£d
(&
ˇ
->
‰ì
[
RESERVE_BTREE
]Ë< 
ª£rve
) {

1157 i‡(
›
)

1158 
	`¥ï¨e_to_waô
(&
c
->
båì_ˇche_waô
, &
›
->
waô
,

1159 
TASK_UNINTERRUPTIBLE
);

1160 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1161  -
EINTR
;

1164 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1166  
	`mˇ_ˇ¬ibÆize_lock
(
b
->
c
, 
›
);

1167 
	}
}

1171 
uöt8_t
 
	$__bch_båì_m¨k_key
(
ˇche_£t
 *
c
, 
Àvñ
,

1172 
bkey
 *
k
)

1174 
uöt8_t
 
°Æe
 = 0;

1175 
i
;

1176 
buckë
 *
g
;

1183 i‡(!
	`bkey_cmp
(
k
, &
ZERO_KEY
))

1184  
°Æe
;

1186 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++) {

1187 i‡(!
	`±r_avaûabÀ
(
c
, 
k
, 
i
))

1190 
g
 = 
	`PTR_BUCKET
(
c
, 
k
, 
i
);

1192 i‡(
	`gí_a·î
(
g
->
œ°_gc
, 
	`PTR_GEN
(
k
, 
i
)))

1193 
g
->
œ°_gc
 = 
	`PTR_GEN
(
k
, 
i
);

1195 i‡(
	`±r_°Æe
(
c
, 
k
, 
i
)) {

1196 
°Æe
 = 
	`max
(°Æe, 
	`±r_°Æe
(
c
, 
k
, 
i
));

1200 
	`ˇche_bug_⁄
(
	`GC_MARK
(
g
) &&

1201 (
	`GC_MARK
(
g
Ë=
GC_MARK_METADATA
Ë!(
Àvñ
 != 0),

1202 
c
, "inconsistentÖtrs: mark = %llu,Üevel = %i",

1203 
	`GC_MARK
(
g
), 
Àvñ
);

1205 i‡(
Àvñ
)

1206 
	`SET_GC_MARK
(
g
, 
GC_MARK_METADATA
);

1207 i‡(
	`KEY_DIRTY
(
k
))

1208 
	`SET_GC_MARK
(
g
, 
GC_MARK_DIRTY
);

1209 i‡(!
	`GC_MARK
(
g
))

1210 
	`SET_GC_MARK
(
g
, 
GC_MARK_RECLAIMABLE
);

1213 
	`SET_GC_SECTORS_USED
(
g
, 
	`mö_t
(,

1214 
	`GC_SECTORS_USED
(
g
Ë+ 
	`KEY_SIZE
(
k
),

1215 
MAX_GC_SECTORS_USED
));

1217 
	`BUG_ON
(!
	`GC_SECTORS_USED
(
g
));

1220  
°Æe
;

1221 
	}
}

1223 
	#båì_m¨k_key
(
b
, 
k
Ë
	`__bch_båì_m¨k_key
(b->
c
, b->
Àvñ
, k)

	)

1225 
	$bch_öôül_m¨k_key
(
ˇche_£t
 *
c
, 
Àvñ
, 
bkey
 *
k
)

1227 
i
;

1229 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

1230 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
i
) &&

1231 !
	`±r_°Æe
(
c
, 
k
, 
i
)) {

1232 
buckë
 *
b
 = 
	`PTR_BUCKET
(
c
, 
k
, 
i
);

1234 
b
->
gí
 = 
	`PTR_GEN
(
k
, 
i
);

1236 i‡(
Àvñ
 && 
	`bkey_cmp
(
k
, &
ZERO_KEY
))

1237 
b
->
¥io
 = 
BTREE_PRIO
;

1238 i‡(!
Àvñ
 && 
b
->
¥io
 =
BTREE_PRIO
)

1239 
b
->
¥io
 = 
INITIAL_PRIO
;

1242 
	`__bch_båì_m¨k_key
(
c
, 
Àvñ
, 
k
);

1243 
	}
}

1245 
boﬁ
 
	$båì_gc_m¨k_node
(
båì
 *
b
, 
gc_°©
 *
gc
)

1247 
uöt8_t
 
°Æe
 = 0;

1248 
keys
 = 0, 
good_keys
 = 0;

1249 
bkey
 *
k
;

1250 
båì_ôî
 
ôî
;

1251 
b£t_åì
 *
t
;

1253 
gc
->
nodes
++;

1255 
	`f‹_óch_key_fûãr
(&
b
->
keys
, 
k
, &
ôî
, 
bch_±r_övÆid
) {

1256 
°Æe
 = 
	`max
(°Æe, 
	`båì_m¨k_key
(
b
, 
k
));

1257 
keys
++;

1259 i‡(
	`bch_±r_bad
(&
b
->
keys
, 
k
))

1262 
gc
->
key_byãs
 +
	`bkey_u64s
(
k
);

1263 
gc
->
nkeys
++;

1264 
good_keys
++;

1266 
gc
->
d©a
 +
	`KEY_SIZE
(
k
);

1269 
t
 = 
b
->
keys
.
£t
;Å <&b->keys.£t[b->keys.
n£ts
];Å++)

1270 
	`båì_bug_⁄
(
t
->
size
 &&

1271 
	`b£t_wrôãn
(&
b
->
keys
, 
t
) &&

1272 
	`bkey_cmp
(&
b
->
key
, &
t
->
íd
) < 0,

1273 
b
, "found short btree key in gc");

1275 i‡(
b
->
c
->
gc_Æways_ªwrôe
)

1276  
åue
;

1278 i‡(
°Æe
 > 10)

1279  
åue
;

1281 i‡((
keys
 - 
good_keys
) * 2 > keys)

1282  
åue
;

1284  
Ál£
;

1285 
	}
}

1287 
	#GC_MERGE_NODES
 4U

	)

1289 
	sgc_mîge_öfo
 {

1290 
båì
 *
	mb
;

1291 
	mkeys
;

1294 
bch_båì_ö£π_node
(
båì
 *, 
båì_›
 *,

1295 
keyli°
 *, 
©omic_t
 *, 
bkey
 *);

1297 
	$båì_gc_cﬂÀs˚
(
båì
 *
b
, 
båì_›
 *
›
,

1298 
gc_°©
 *
gc
, 
gc_mîge_öfo
 *
r
)

1300 
i
, 
nodes
 = 0, 
keys
 = 0, 
blocks
;

1301 
båì
 *
√w_nodes
[
GC_MERGE_NODES
];

1302 
keyli°
 keylist;

1303 
˛osuª
 
˛
;

1304 
bkey
 *
k
;

1306 
	`bch_keyli°_öô
(&
keyli°
);

1308 i‡(
	`båì_check_ª£rve
(
b
, 
NULL
))

1311 
	`mem£t
(
√w_nodes
, 0, (new_nodes));

1312 
	`˛osuª_öô_°ack
(&
˛
);

1314 
nodes
 < 
GC_MERGE_NODES
 && !
	`IS_ERR_OR_NULL
(
r
[nodes].
b
))

1315 
keys
 +
r
[
nodes
++].keys;

1317 
blocks
 = 
	`båì_deÁu…_blocks
(
b
->
c
) * 2 / 3;

1319 i‡(
nodes
 < 2 ||

1320 
	`__£t_blocks
(
b
->
keys
.
£t
[0].
d©a
, keys,

1321 
	`block_byãs
(
b
->
c
)Ë> 
blocks
 * (
nodes
 - 1))

1324 
i
 = 0; i < 
nodes
; i++) {

1325 
√w_nodes
[
i
] = 
	`båì_node_Æloc_ª∂a˚mít
(
r
[i].
b
, 
NULL
);

1326 i‡(
	`IS_ERR_OR_NULL
(
√w_nodes
[
i
]))

1327 
out_nocﬂÀs˚
;

1336 i‡(
	`båì_check_ª£rve
(
b
, 
NULL
))

1337 
out_nocﬂÀs˚
;

1339 
i
 = 0; i < 
nodes
; i++)

1340 
	`muãx_lock
(&
√w_nodes
[
i
]->
wrôe_lock
);

1342 
i
 = 
nodes
 - 1; i > 0; --i) {

1343 
b£t
 *
n1
 = 
	`båì_b£t_fú°
(
√w_nodes
[
i
]);

1344 
b£t
 *
n2
 = 
	`båì_b£t_fú°
(
√w_nodes
[
i
 - 1]);

1345 
bkey
 *
k
, *
œ°
 = 
NULL
;

1347 
keys
 = 0;

1349 i‡(
i
 > 1) {

1350 
k
 = 
n2
->
°¨t
;

1351 
k
 < 
	`b£t_bkey_œ°
(
n2
);

1352 
k
 = 
	`bkey_√xt
(k)) {

1353 i‡(
	`__£t_blocks
(
n1
,Ç1->
keys
 + keys +

1354 
	`bkey_u64s
(
k
),

1355 
	`block_byãs
(
b
->
c
)Ë> 
blocks
)

1358 
œ°
 = 
k
;

1359 
keys
 +
	`bkey_u64s
(
k
);

1370 i‡(
	`__£t_blocks
(
n1
,Ç1->
keys
 + 
n2
->keys,

1371 
	`block_byãs
(
b
->
c
)) >

1372 
	`båì_blocks
(
√w_nodes
[
i
]))

1373 
out_nocﬂÀs˚
;

1375 
keys
 = 
n2
->keys;

1377 
œ°
 = &
r
->
b
->
key
;

1380 
	`BUG_ON
(
	`__£t_blocks
(
n1
,Ç1->
keys
 + keys, 
	`block_byãs
(
b
->
c
)) >

1381 
	`båì_blocks
(
√w_nodes
[
i
]));

1383 i‡(
œ°
)

1384 
	`bkey_c›y_key
(&
√w_nodes
[
i
]->
key
, 
œ°
);

1386 
	`mem˝y
(
	`b£t_bkey_œ°
(
n1
),

1387 
n2
->
°¨t
,

1388 (*Ë
	`b£t_bkey_idx
(
n2
, 
keys
Ë- (*Ën2->
°¨t
);

1390 
n1
->
keys
 += keys;

1391 
r
[
i
].
keys
 = 
n1
->keys;

1393 
	`memmove
(
n2
->
°¨t
,

1394 
	`b£t_bkey_idx
(
n2
, 
keys
),

1395 (*Ë
	`b£t_bkey_œ°
(
n2
) -

1396 (*Ë
	`b£t_bkey_idx
(
n2
, 
keys
));

1398 
n2
->
keys
 -= keys;

1400 i‡(
	`__bch_keyli°_ªÆloc
(&
keyli°
,

1401 
	`bkey_u64s
(&
√w_nodes
[
i
]->
key
)))

1402 
out_nocﬂÀs˚
;

1404 
	`bch_båì_node_wrôe
(
√w_nodes
[
i
], &
˛
);

1405 
	`bch_keyli°_add
(&
keyli°
, &
√w_nodes
[
i
]->
key
);

1408 
i
 = 0; i < 
nodes
; i++)

1409 
	`muãx_u∆ock
(&
√w_nodes
[
i
]->
wrôe_lock
);

1411 
	`˛osuª_sync
(&
˛
);

1414 
	`BUG_ON
(
	`båì_b£t_fú°
(
√w_nodes
[0])->
keys
);

1415 
	`båì_node_‰ì
(
√w_nodes
[0]);

1416 
	`rw_u∆ock
(
åue
, 
√w_nodes
[0]);

1417 
√w_nodes
[0] = 
NULL
;

1419 
i
 = 0; i < 
nodes
; i++) {

1420 i‡(
	`__bch_keyli°_ªÆloc
(&
keyli°
, 
	`bkey_u64s
(&
r
[
i
].
b
->
key
)))

1421 
out_nocﬂÀs˚
;

1423 
	`make_båì_‰ìög_key
(
r
[
i
].
b
, 
keyli°
.
t›
);

1424 
	`bch_keyli°_push
(&
keyli°
);

1427 
	`bch_båì_ö£π_node
(
b
, 
›
, &
keyli°
, 
NULL
, NULL);

1428 
	`BUG_ON
(!
	`bch_keyli°_em±y
(&
keyli°
));

1430 
i
 = 0; i < 
nodes
; i++) {

1431 
	`båì_node_‰ì
(
r
[
i
].
b
);

1432 
	`rw_u∆ock
(
åue
, 
r
[
i
].
b
);

1434 
r
[
i
].
b
 = 
√w_nodes
[i];

1437 
	`memmove
(
r
,Ñ + 1, ‘[0]Ë* (
nodes
 - 1));

1438 
r
[
nodes
 - 1].
b
 = 
	`ERR_PTR
(-
EINTR
);

1440 
	`åa˚_bˇche_båì_gc_cﬂÀs˚
(
nodes
);

1441 
gc
->
nodes
--;

1443 
	`bch_keyli°_‰ì
(&
keyli°
);

1446  -
EINTR
;

1448 
out_nocﬂÀs˚
:

1449 
	`˛osuª_sync
(&
˛
);

1450 
	`bch_keyli°_‰ì
(&
keyli°
);

1452 (
k
 = 
	`bch_keyli°_p›
(&
keyli°
)))

1453 i‡(!
	`bkey_cmp
(
k
, &
ZERO_KEY
))

1454 
	`©omic_dec
(&
b
->
c
->
¥io_blocked
);

1456 
i
 = 0; i < 
nodes
; i++)

1457 i‡(!
	`IS_ERR_OR_NULL
(
√w_nodes
[
i
])) {

1458 
	`båì_node_‰ì
(
√w_nodes
[
i
]);

1459 
	`rw_u∆ock
(
åue
, 
√w_nodes
[
i
]);

1462 
	}
}

1464 
	$båì_gc_ªwrôe_node
(
båì
 *
b
, 
båì_›
 *
›
,

1465 
båì
 *
ª∂a˚
)

1467 
keyli°
 
keys
;

1468 
båì
 *
n
;

1470 i‡(
	`båì_check_ª£rve
(
b
, 
NULL
))

1473 
n
 = 
	`båì_node_Æloc_ª∂a˚mít
(
ª∂a˚
, 
NULL
);

1476 i‡(
	`båì_check_ª£rve
(
b
, 
NULL
)) {

1477 
	`båì_node_‰ì
(
n
);

1478 
	`rw_u∆ock
(
åue
, 
n
);

1482 
	`bch_båì_node_wrôe_sync
(
n
);

1484 
	`bch_keyli°_öô
(&
keys
);

1485 
	`bch_keyli°_add
(&
keys
, &
n
->
key
);

1487 
	`make_båì_‰ìög_key
(
ª∂a˚
, 
keys
.
t›
);

1488 
	`bch_keyli°_push
(&
keys
);

1490 
	`bch_båì_ö£π_node
(
b
, 
›
, &
keys
, 
NULL
, NULL);

1491 
	`BUG_ON
(!
	`bch_keyli°_em±y
(&
keys
));

1493 
	`båì_node_‰ì
(
ª∂a˚
);

1494 
	`rw_u∆ock
(
åue
, 
n
);

1497  -
EINTR
;

1498 
	}
}

1500 
	$båì_gc_cou¡_keys
(
båì
 *
b
)

1502 
bkey
 *
k
;

1503 
båì_ôî
 
ôî
;

1504 
ªt
 = 0;

1506 
	`f‹_óch_key_fûãr
(&
b
->
keys
, 
k
, &
ôî
, 
bch_±r_bad
)

1507 
ªt
 +
	`bkey_u64s
(
k
);

1509  
ªt
;

1510 
	}
}

1512 
	$båì_gc_ªcur£
(
båì
 *
b
, 
båì_›
 *
›
,

1513 
˛osuª
 *
wrôes
, 
gc_°©
 *
gc
)

1515 
ªt
 = 0;

1516 
boﬁ
 
should_ªwrôe
;

1517 
bkey
 *
k
;

1518 
båì_ôî
 
ôî
;

1519 
gc_mîge_öfo
 
r
[
GC_MERGE_NODES
];

1520 
gc_mîge_öfo
 *
i
, *
œ°
 = 
r
 + 
	`ARRAY_SIZE
(r) - 1;

1522 
	`bch_båì_ôî_öô
(&
b
->
keys
, &
ôî
, &b->
c
->
gc_d⁄e
);

1524 
i
 = 
r
; i <Ñ + 
	`ARRAY_SIZE
(r); i++)

1525 
i
->
b
 = 
	`ERR_PTR
(-
EINTR
);

1528 
k
 = 
	`bch_båì_ôî_√xt_fûãr
(&
ôî
, &
b
->
keys
, 
bch_±r_bad
);

1529 i‡(
k
) {

1530 
r
->
b
 = 
	`bch_båì_node_gë
(b->
c
, 
›
, 
k
, b->
Àvñ
 - 1,

1531 
åue
, 
b
);

1532 i‡(
	`IS_ERR
(
r
->
b
)) {

1533 
ªt
 = 
	`PTR_ERR
(
r
->
b
);

1537 
r
->
keys
 = 
	`båì_gc_cou¡_keys
‘->
b
);

1539 
ªt
 = 
	`båì_gc_cﬂÀs˚
(
b
, 
›
, 
gc
, 
r
);

1540 i‡(
ªt
)

1544 i‡(!
œ°
->
b
)

1547 i‡(!
	`IS_ERR
(
œ°
->
b
)) {

1548 
should_ªwrôe
 = 
	`båì_gc_m¨k_node
(
œ°
->
b
, 
gc
);

1549 i‡(
should_ªwrôe
) {

1550 
ªt
 = 
	`båì_gc_ªwrôe_node
(
b
, 
›
, 
œ°
->b);

1551 i‡(
ªt
)

1555 i‡(
œ°
->
b
->
Àvñ
) {

1556 
ªt
 = 
	`båì_gc_ªcur£
(
œ°
->
b
, 
›
, 
wrôes
, 
gc
);

1557 i‡(
ªt
)

1561 
	`bkey_c›y_key
(&
b
->
c
->
gc_d⁄e
, &
œ°
->b->
key
);

1567 
	`muãx_lock
(&
œ°
->
b
->
wrôe_lock
);

1568 i‡(
	`båì_node_dúty
(
œ°
->
b
))

1569 
	`bch_båì_node_wrôe
(
œ°
->
b
, 
wrôes
);

1570 
	`muãx_u∆ock
(&
œ°
->
b
->
wrôe_lock
);

1571 
	`rw_u∆ock
(
åue
, 
œ°
->
b
);

1574 
	`memmove
(
r
 + 1,Ñ, ‘[0]Ë* (
GC_MERGE_NODES
 - 1));

1575 
r
->
b
 = 
NULL
;

1577 i‡(
	`√ed_ªsched
()) {

1578 
ªt
 = -
EAGAIN
;

1583 
i
 = 
r
; i <Ñ + 
	`ARRAY_SIZE
(r); i++)

1584 i‡(!
	`IS_ERR_OR_NULL
(
i
->
b
)) {

1585 
	`muãx_lock
(&
i
->
b
->
wrôe_lock
);

1586 i‡(
	`båì_node_dúty
(
i
->
b
))

1587 
	`bch_båì_node_wrôe
(
i
->
b
, 
wrôes
);

1588 
	`muãx_u∆ock
(&
i
->
b
->
wrôe_lock
);

1589 
	`rw_u∆ock
(
åue
, 
i
->
b
);

1592  
ªt
;

1593 
	}
}

1595 
	$bch_båì_gc_roŸ
(
båì
 *
b
, 
båì_›
 *
›
,

1596 
˛osuª
 *
wrôes
, 
gc_°©
 *
gc
)

1598 
båì
 *
n
 = 
NULL
;

1599 
ªt
 = 0;

1600 
boﬁ
 
should_ªwrôe
;

1602 
should_ªwrôe
 = 
	`båì_gc_m¨k_node
(
b
, 
gc
);

1603 i‡(
should_ªwrôe
) {

1604 
n
 = 
	`båì_node_Æloc_ª∂a˚mít
(
b
, 
NULL
);

1606 i‡(!
	`IS_ERR_OR_NULL
(
n
)) {

1607 
	`bch_båì_node_wrôe_sync
(
n
);

1609 
	`bch_båì_£t_roŸ
(
n
);

1610 
	`båì_node_‰ì
(
b
);

1611 
	`rw_u∆ock
(
åue
, 
n
);

1613  -
EINTR
;

1617 
	`__bch_båì_m¨k_key
(
b
->
c
, b->
Àvñ
 + 1, &b->
key
);

1619 i‡(
b
->
Àvñ
) {

1620 
ªt
 = 
	`båì_gc_ªcur£
(
b
, 
›
, 
wrôes
, 
gc
);

1621 i‡(
ªt
)

1622  
ªt
;

1625 
	`bkey_c›y_key
(&
b
->
c
->
gc_d⁄e
, &b->
key
);

1627  
ªt
;

1628 
	}
}

1630 
	$båì_gc_°¨t
(
ˇche_£t
 *
c
)

1632 
ˇche
 *
ˇ
;

1633 
buckë
 *
b
;

1634 
i
;

1636 i‡(!
c
->
gc_m¨k_vÆid
)

1639 
	`muãx_lock
(&
c
->
buckë_lock
);

1641 
c
->
gc_m¨k_vÆid
 = 0;

1642 
c
->
gc_d⁄e
 = 
ZERO_KEY
;

1644 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1645 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

1646 
b
->
œ°_gc
 = b->
gí
;

1647 i‡(!
	`©omic_ªad
(&
b
->
pö
)) {

1648 
	`SET_GC_MARK
(
b
, 0);

1649 
	`SET_GC_SECTORS_USED
(
b
, 0);

1653 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1654 
	}
}

1656 
size_t
 
	$bch_båì_gc_föish
(
ˇche_£t
 *
c
)

1658 
size_t
 
avaûabÀ
 = 0;

1659 
buckë
 *
b
;

1660 
ˇche
 *
ˇ
;

1661 
i
;

1663 
	`muãx_lock
(&
c
->
buckë_lock
);

1665 
	`£t_gc_£˘‹s
(
c
);

1666 
c
->
gc_m¨k_vÆid
 = 1;

1667 
c
->
√ed_gc
 = 0;

1669 
i
 = 0; i < 
	`KEY_PTRS
(&
c
->
uuid_buckë
); i++)

1670 
	`SET_GC_MARK
(
	`PTR_BUCKET
(
c
, &c->
uuid_buckë
, 
i
),

1671 
GC_MARK_METADATA
);

1674 
	`rcu_ªad_lock
();

1675 
i
 = 0; i < 
c
->
ƒ_uuids
; i++) {

1676 
bˇche_devi˚
 *
d
 = 
c
->
devi˚s
[
i
];

1677 
ˇched_dev
 *
dc
;

1678 
keybuf_key
 *
w
, *
n
;

1679 
j
;

1681 i‡(!
d
 || 
	`UUID_FLASH_ONLY
(&
c
->
uuids
[
i
]))

1683 
dc
 = 
	`c⁄èöî_of
(
d
, 
ˇched_dev
, 
disk
);

1685 
	`•ö_lock
(&
dc
->
wrôeback_keys
.
lock
);

1686 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
w
, 
n
,

1687 &
dc
->
wrôeback_keys
.
keys
, 
node
)

1688 
j
 = 0; j < 
	`KEY_PTRS
(&
w
->
key
); j++)

1689 
	`SET_GC_MARK
(
	`PTR_BUCKET
(
c
, &
w
->
key
, 
j
),

1690 
GC_MARK_DIRTY
);

1691 
	`•ö_u∆ock
(&
dc
->
wrôeback_keys
.
lock
);

1693 
	`rcu_ªad_u∆ock
();

1695 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
) {

1696 
uöt64_t
 *
i
;

1698 
ˇ
->
övÆid©e_√eds_gc
 = 0;

1700 
i
 = 
ˇ
->
sb
.
d
; i < ca->sb.d + ca->sb.
keys
; i++)

1701 
	`SET_GC_MARK
(
ˇ
->
buckës
 + *
i
, 
GC_MARK_METADATA
);

1703 
i
 = 
ˇ
->
¥io_buckës
;

1704 
i
 < 
ˇ
->
¥io_buckës
 + 
	`¥io_buckës
(ca) * 2; i++)

1705 
	`SET_GC_MARK
(
ˇ
->
buckës
 + *
i
, 
GC_MARK_METADATA
);

1707 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

1708 
c
->
√ed_gc
 = 
	`max
(c->√ed_gc, 
	`buckë_gc_gí
(
b
));

1710 i‡(
	`©omic_ªad
(&
b
->
pö
))

1713 
	`BUG_ON
(!
	`GC_MARK
(
b
Ë&& 
	`GC_SECTORS_USED
(b));

1715 i‡(!
	`GC_MARK
(
b
Ë|| GC_MARK(bË=
GC_MARK_RECLAIMABLE
)

1716 
avaûabÀ
++;

1720 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1721  
avaûabÀ
;

1722 
	}
}

1724 
	$bch_båì_gc
(
ˇche_£t
 *
c
)

1726 
ªt
;

1727 
avaûabÀ
;

1728 
gc_°©
 
°©s
;

1729 
˛osuª
 
wrôes
;

1730 
båì_›
 
›
;

1731 
uöt64_t
 
°¨t_time
 = 
	`loˇl_˛ock
();

1733 
	`åa˚_bˇche_gc_°¨t
(
c
);

1735 
	`mem£t
(&
°©s
, 0, (
gc_°©
));

1736 
	`˛osuª_öô_°ack
(&
wrôes
);

1737 
	`bch_båì_›_öô
(&
›
, 
SHRT_MAX
);

1739 
	`båì_gc_°¨t
(
c
);

1742 
ªt
 = 
	`båì_roŸ
(
gc_roŸ
, 
c
, &
›
, &
wrôes
, &
°©s
);

1743 
	`˛osuª_sync
(&
wrôes
);

1745 i‡(
ªt
 &&Ñë !-
EAGAIN
)

1746 
	`¥_w¨n
("gc failed!");

1747 } 
ªt
);

1749 
avaûabÀ
 = 
	`bch_båì_gc_föish
(
c
);

1750 
	`wake_up_Æloˇt‹s
(
c
);

1752 
	`bch_time_°©s_upd©e
(&
c
->
båì_gc_time
, 
°¨t_time
);

1754 
°©s
.
key_byãs
 *(
uöt64_t
);

1755 
°©s
.
d©a
 <<= 9;

1756 
°©s
.
ö_u£
 = (
c
->
nbuckës
 - 
avaûabÀ
) * 100 / c->nbuckets;

1757 
	`mem˝y
(&
c
->
gc_°©s
, &
°©s
, (
gc_°©
));

1759 
	`åa˚_bˇche_gc_íd
(
c
);

1761 
	`bch_movög_gc
(
c
);

1762 
	}
}

1764 
	$bch_gc_thªad
(*
¨g
)

1766 
ˇche_£t
 *
c
 = 
¨g
;

1767 
ˇche
 *
ˇ
;

1768 
i
;

1771 
agaö
:

1772 
	`bch_båì_gc
(
c
);

1774 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

1775 i‡(
	`kthªad_should_°›
())

1778 
	`muãx_lock
(&
c
->
buckë_lock
);

1780 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1781 i‡(
ˇ
->
övÆid©e_√eds_gc
) {

1782 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1783 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

1784 
agaö
;

1787 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1789 
	`åy_to_‰ìze
();

1790 
	`scheduÀ
();

1794 
	}
}

1796 
	$bch_gc_thªad_°¨t
(
ˇche_£t
 *
c
)

1798 
c
->
gc_thªad
 = 
	`kthªad_¸óã
(
bch_gc_thªad
, c, "bcache_gc");

1799 i‡(
	`IS_ERR
(
c
->
gc_thªad
))

1800  
	`PTR_ERR
(
c
->
gc_thªad
);

1802 
	`£t_èsk_°©e
(
c
->
gc_thªad
, 
TASK_INTERRUPTIBLE
);

1804 
	}
}

1808 
	$bch_båì_check_ªcur£
(
båì
 *
b
, 
båì_›
 *
›
)

1810 
ªt
 = 0;

1811 
bkey
 *
k
, *
p
 = 
NULL
;

1812 
båì_ôî
 
ôî
;

1814 
	`f‹_óch_key_fûãr
(&
b
->
keys
, 
k
, &
ôî
, 
bch_±r_övÆid
)

1815 
	`bch_öôül_m¨k_key
(
b
->
c
, b->
Àvñ
, 
k
);

1817 
	`bch_öôül_m¨k_key
(
b
->
c
, b->
Àvñ
 + 1, &b->
key
);

1819 i‡(
b
->
Àvñ
) {

1820 
	`bch_båì_ôî_öô
(&
b
->
keys
, &
ôî
, 
NULL
);

1823 
k
 = 
	`bch_båì_ôî_√xt_fûãr
(&
ôî
, &
b
->
keys
,

1824 
bch_±r_bad
);

1825 i‡(
k
)

1826 
	`båì_node_¥e„tch
(
b
, 
k
);

1828 i‡(
p
)

1829 
ªt
 = 
	`båì
(
check_ªcur£
, 
p
, 
b
, 
›
);

1831 
p
 = 
k
;

1832 } 
p
 && !
ªt
);

1835  
ªt
;

1836 
	}
}

1838 
	$bch_båì_check
(
ˇche_£t
 *
c
)

1840 
båì_›
 
›
;

1842 
	`bch_båì_›_öô
(&
›
, 
SHRT_MAX
);

1844  
	`båì_roŸ
(
check_ªcur£
, 
c
, &
›
);

1845 
	}
}

1847 
	$bch_öôül_gc_föish
(
ˇche_£t
 *
c
)

1849 
ˇche
 *
ˇ
;

1850 
buckë
 *
b
;

1851 
i
;

1853 
	`bch_båì_gc_föish
(
c
);

1855 
	`muãx_lock
(&
c
->
buckë_lock
);

1866 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
) {

1867 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

1868 i‡(
	`fifo_fuŒ
(&
ˇ
->
‰ì
[
RESERVE_PRIO
]))

1871 i‡(
	`bch_ˇn_övÆid©e_buckë
(
ˇ
, 
b
) &&

1872 !
	`GC_MARK
(
b
)) {

1873 
	`__bch_övÆid©e_⁄e_buckë
(
ˇ
, 
b
);

1874 
	`fifo_push
(&
ˇ
->
‰ì
[
RESERVE_PRIO
],

1875 
b
 - 
ˇ
->
buckës
);

1880 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1881 
	}
}

1885 
boﬁ
 
	$båì_ö£π_key
(
båì
 *
b
, 
bkey
 *
k
,

1886 
bkey
 *
ª∂a˚_key
)

1888 
°©us
;

1890 
	`BUG_ON
(
	`bkey_cmp
(
k
, &
b
->
key
) > 0);

1892 
°©us
 = 
	`bch_båì_ö£π_key
(&
b
->
keys
, 
k
, 
ª∂a˚_key
);

1893 i‡(
°©us
 !
BTREE_INSERT_STATUS_NO_INSERT
) {

1894 
	`bch_check_keys
(&
b
->
keys
, "%u f‹ %s", 
°©us
,

1895 
ª∂a˚_key
 ? "replace" : "insert");

1897 
	`åa˚_bˇche_båì_ö£π_key
(
b
, 
k
, 
ª∂a˚_key
 !
NULL
,

1898 
°©us
);

1899  
åue
;

1901  
Ál£
;

1902 
	}
}

1904 
size_t
 
	$ö£π_u64s_ªmaöög
(
båì
 *
b
)

1906 
ªt
 = 
	`bch_båì_keys_u64s_ªmaöög
(&
b
->
keys
);

1911 i‡(
b
->
keys
.
›s
->
is_exã¡s
)

1912 
ªt
 -
KEY_MAX_U64S
;

1914  
	`max
(
ªt
, 0L);

1915 
	}
}

1917 
boﬁ
 
	$bch_båì_ö£π_keys
(
båì
 *
b
, 
båì_›
 *
›
,

1918 
keyli°
 *
ö£π_keys
,

1919 
bkey
 *
ª∂a˚_key
)

1921 
boﬁ
 
ªt
 = 
Ál£
;

1922 
ﬁdsize
 = 
	`bch_cou¡_d©a
(&
b
->
keys
);

1924 !
	`bch_keyli°_em±y
(
ö£π_keys
)) {

1925 
bkey
 *
k
 = 
ö£π_keys
->
keys
;

1927 i‡(
	`bkey_u64s
(
k
Ë> 
	`ö£π_u64s_ªmaöög
(
b
))

1930 i‡(
	`bkey_cmp
(
k
, &
b
->
key
) <= 0) {

1931 i‡(!
b
->
Àvñ
)

1932 
	`bkey_put
(
b
->
c
, 
k
);

1934 
ªt
 |
	`båì_ö£π_key
(
b
, 
k
, 
ª∂a˚_key
);

1935 
	`bch_keyli°_p›_‰⁄t
(
ö£π_keys
);

1936 } i‡(
	`bkey_cmp
(&
	`START_KEY
(
k
), &
b
->
key
) < 0) {

1937 
	`BKEY_PADDED
(
key
Ë
ãmp
;

1938 
	`bkey_c›y
(&
ãmp
.
key
, 
ö£π_keys
->
keys
);

1940 
	`bch_cut_back
(&
b
->
key
, &
ãmp
.key);

1941 
	`bch_cut_‰⁄t
(&
b
->
key
, 
ö£π_keys
->
keys
);

1943 
ªt
 |
	`båì_ö£π_key
(
b
, &
ãmp
.
key
, 
ª∂a˚_key
);

1950 i‡(!
ªt
)

1951 
›
->
ö£π_cﬁlisi⁄
 = 
åue
;

1953 
	`BUG_ON
(!
	`bch_keyli°_em±y
(
ö£π_keys
Ë&& 
b
->
Àvñ
);

1955 
	`BUG_ON
(
	`bch_cou¡_d©a
(&
b
->
keys
Ë< 
ﬁdsize
);

1956  
ªt
;

1957 
	}
}

1959 
	$båì_•lô
(
båì
 *
b
, 
båì_›
 *
›
,

1960 
keyli°
 *
ö£π_keys
,

1961 
bkey
 *
ª∂a˚_key
)

1963 
boﬁ
 
•lô
;

1964 
båì
 *
n1
, *
n2
 = 
NULL
, *
n3
 = NULL;

1965 
uöt64_t
 
°¨t_time
 = 
	`loˇl_˛ock
();

1966 
˛osuª
 
˛
;

1967 
keyli°
 
∑ª¡_keys
;

1969 
	`˛osuª_öô_°ack
(&
˛
);

1970 
	`bch_keyli°_öô
(&
∑ª¡_keys
);

1972 i‡(
	`båì_check_ª£rve
(
b
, 
›
)) {

1973 i‡(!
b
->
Àvñ
)

1974  -
EINTR
;

1976 
	`WARN
(1, "insufficientÑeserve for split\n");

1979 
n1
 = 
	`båì_node_Æloc_ª∂a˚mít
(
b
, 
›
);

1980 i‡(
	`IS_ERR
(
n1
))

1981 
îr
;

1983 
•lô
 = 
	`£t_blocks
(
	`båì_b£t_fú°
(
n1
),

1984 
	`block_byãs
(
n1
->
c
)Ë> (
	`båì_blocks
(
b
) * 4) / 5;

1986 i‡(
•lô
) {

1987 
keys
 = 0;

1989 
	`åa˚_bˇche_båì_node_•lô
(
b
, 
	`båì_b£t_fú°
(
n1
)->
keys
);

1991 
n2
 = 
	`bch_båì_node_Æloc
(
b
->
c
, 
›
, b->
Àvñ
, b->
∑ª¡
);

1992 i‡(
	`IS_ERR
(
n2
))

1993 
îr_‰ì1
;

1995 i‡(!
b
->
∑ª¡
) {

1996 
n3
 = 
	`bch_båì_node_Æloc
(
b
->
c
, 
›
, b->
Àvñ
 + 1, 
NULL
);

1997 i‡(
	`IS_ERR
(
n3
))

1998 
îr_‰ì2
;

2001 
	`muãx_lock
(&
n1
->
wrôe_lock
);

2002 
	`muãx_lock
(&
n2
->
wrôe_lock
);

2004 
	`bch_båì_ö£π_keys
(
n1
, 
›
, 
ö£π_keys
, 
ª∂a˚_key
);

2011 
keys
 < (
	`båì_b£t_fú°
(
n1
)->keys * 3) / 5)

2012 
keys
 +
	`bkey_u64s
(
	`b£t_bkey_idx
(
	`båì_b£t_fú°
(
n1
),

2013 
keys
));

2015 
	`bkey_c›y_key
(&
n1
->
key
,

2016 
	`b£t_bkey_idx
(
	`båì_b£t_fú°
(
n1
), 
keys
));

2017 
keys
 +
	`bkey_u64s
(
	`b£t_bkey_idx
(
	`båì_b£t_fú°
(
n1
), keys));

2019 
	`båì_b£t_fú°
(
n2
)->
keys
 = båì_b£t_fú°(
n1
)->keys - keys;

2020 
	`båì_b£t_fú°
(
n1
)->
keys
 = keys;

2022 
	`mem˝y
(
	`båì_b£t_fú°
(
n2
)->
°¨t
,

2023 
	`b£t_bkey_œ°
(
	`båì_b£t_fú°
(
n1
)),

2024 
	`båì_b£t_fú°
(
n2
)->
keys
 * (
uöt64_t
));

2026 
	`bkey_c›y_key
(&
n2
->
key
, &
b
->key);

2028 
	`bch_keyli°_add
(&
∑ª¡_keys
, &
n2
->
key
);

2029 
	`bch_båì_node_wrôe
(
n2
, &
˛
);

2030 
	`muãx_u∆ock
(&
n2
->
wrôe_lock
);

2031 
	`rw_u∆ock
(
åue
, 
n2
);

2033 
	`åa˚_bˇche_båì_node_com∑˘
(
b
, 
	`båì_b£t_fú°
(
n1
)->
keys
);

2035 
	`muãx_lock
(&
n1
->
wrôe_lock
);

2036 
	`bch_båì_ö£π_keys
(
n1
, 
›
, 
ö£π_keys
, 
ª∂a˚_key
);

2039 
	`bch_keyli°_add
(&
∑ª¡_keys
, &
n1
->
key
);

2040 
	`bch_båì_node_wrôe
(
n1
, &
˛
);

2041 
	`muãx_u∆ock
(&
n1
->
wrôe_lock
);

2043 i‡(
n3
) {

2045 
	`muãx_lock
(&
n3
->
wrôe_lock
);

2046 
	`bkey_c›y_key
(&
n3
->
key
, &
MAX_KEY
);

2047 
	`bch_båì_ö£π_keys
(
n3
, 
›
, &
∑ª¡_keys
, 
NULL
);

2048 
	`bch_båì_node_wrôe
(
n3
, &
˛
);

2049 
	`muãx_u∆ock
(&
n3
->
wrôe_lock
);

2051 
	`˛osuª_sync
(&
˛
);

2052 
	`bch_båì_£t_roŸ
(
n3
);

2053 
	`rw_u∆ock
(
åue
, 
n3
);

2054 } i‡(!
b
->
∑ª¡
) {

2056 
	`˛osuª_sync
(&
˛
);

2057 
	`bch_båì_£t_roŸ
(
n1
);

2060 
	`˛osuª_sync
(&
˛
);

2061 
	`make_båì_‰ìög_key
(
b
, 
∑ª¡_keys
.
t›
);

2062 
	`bch_keyli°_push
(&
∑ª¡_keys
);

2064 
	`bch_båì_ö£π_node
(
b
->
∑ª¡
, 
›
, &
∑ª¡_keys
, 
NULL
, NULL);

2065 
	`BUG_ON
(!
	`bch_keyli°_em±y
(&
∑ª¡_keys
));

2068 
	`båì_node_‰ì
(
b
);

2069 
	`rw_u∆ock
(
åue
, 
n1
);

2071 
	`bch_time_°©s_upd©e
(&
b
->
c
->
båì_•lô_time
, 
°¨t_time
);

2074 
îr_‰ì2
:

2075 
	`bkey_put
(
b
->
c
, &
n2
->
key
);

2076 
	`båì_node_‰ì
(
n2
);

2077 
	`rw_u∆ock
(
åue
, 
n2
);

2078 
îr_‰ì1
:

2079 
	`bkey_put
(
b
->
c
, &
n1
->
key
);

2080 
	`båì_node_‰ì
(
n1
);

2081 
	`rw_u∆ock
(
åue
, 
n1
);

2082 
îr
:

2083 
	`WARN
(1, "bˇche: båì s∂ô faûed (Àvñ %u)", 
b
->
Àvñ
);

2085 i‡(
n3
 =
	`ERR_PTR
(-
EAGAIN
) ||

2086 
n2
 =
	`ERR_PTR
(-
EAGAIN
) ||

2087 
n1
 =
	`ERR_PTR
(-
EAGAIN
))

2088  -
EAGAIN
;

2090  -
ENOMEM
;

2091 
	}
}

2093 
	$bch_båì_ö£π_node
(
båì
 *
b
, 
båì_›
 *
›
,

2094 
keyli°
 *
ö£π_keys
,

2095 
©omic_t
 *
jou∫Æ_ªf
,

2096 
bkey
 *
ª∂a˚_key
)

2098 
˛osuª
 
˛
;

2100 
	`BUG_ON
(
b
->
Àvñ
 && 
ª∂a˚_key
);

2102 
	`˛osuª_öô_°ack
(&
˛
);

2104 
	`muãx_lock
(&
b
->
wrôe_lock
);

2106 i‡(
	`wrôe_block
(
b
Ë!
	`båì_b£t_œ°
(b) &&

2107 
b
->
keys
.
œ°_£t_unwrôãn
)

2108 
	`bch_båì_öô_√xt
(
b
);

2110 i‡(
	`bch_keyli°_nkeys
(
ö£π_keys
Ë> 
	`ö£π_u64s_ªmaöög
(
b
)) {

2111 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

2112 
•lô
;

2115 
	`BUG_ON
(
	`wrôe_block
(
b
Ë!
	`båì_b£t_œ°
(b));

2117 i‡(
	`bch_båì_ö£π_keys
(
b
, 
›
, 
ö£π_keys
, 
ª∂a˚_key
)) {

2118 i‡(!
b
->
Àvñ
)

2119 
	`bch_båì_Àaf_dúty
(
b
, 
jou∫Æ_ªf
);

2121 
	`bch_båì_node_wrôe
(
b
, &
˛
);

2124 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

2127 
	`˛osuª_sync
(&
˛
);

2130 
•lô
:

2131 i‡(
cuºít
->
bio_li°
) {

2132 
›
->
lock
 = 
b
->
c
->
roŸ
->
Àvñ
 + 1;

2133  -
EAGAIN
;

2134 } i‡(
›
->
lock
 <
b
->
c
->
roŸ
->
Àvñ
) {

2135 
›
->
lock
 = 
b
->
c
->
roŸ
->
Àvñ
 + 1;

2136  -
EINTR
;

2139 
ªt
 = 
	`båì_•lô
(
b
, 
›
, 
ö£π_keys
, 
ª∂a˚_key
);

2141 i‡(
	`bch_keyli°_em±y
(
ö£π_keys
))

2143 i‡(!
ªt
)

2144  -
EINTR
;

2145  
ªt
;

2147 
	}
}

2149 
	$bch_båì_ö£π_check_key
(
båì
 *
b
, 
båì_›
 *
›
,

2150 
bkey
 *
check_key
)

2152 
ªt
 = -
EINTR
;

2153 
uöt64_t
 
båì_±r
 = 
b
->
key
.
±r
[0];

2154 
£q
 = 
b
->seq;

2155 
keyli°
 
ö£π
;

2156 
boﬁ
 
upgøde
 = 
›
->
lock
 == -1;

2158 
	`bch_keyli°_öô
(&
ö£π
);

2160 i‡(
upgøde
) {

2161 
	`rw_u∆ock
(
Ál£
, 
b
);

2162 
	`rw_lock
(
åue
, 
b
, b->
Àvñ
);

2164 i‡(
b
->
key
.
±r
[0] !
båì_±r
 ||

2165 
b
->
£q
 != seq + 1)

2166 
out
;

2169 
	`SET_KEY_PTRS
(
check_key
, 1);

2170 
	`gë_øndom_byãs
(&
check_key
->
±r
[0], (
uöt64_t
));

2172 
	`SET_PTR_DEV
(
check_key
, 0, 
PTR_CHECK_DEV
);

2174 
	`bch_keyli°_add
(&
ö£π
, 
check_key
);

2176 
ªt
 = 
	`bch_båì_ö£π_node
(
b
, 
›
, &
ö£π
, 
NULL
, NULL);

2178 
	`BUG_ON
(!
ªt
 && !
	`bch_keyli°_em±y
(&
ö£π
));

2179 
out
:

2180 i‡(
upgøde
)

2181 
	`downgøde_wrôe
(&
b
->
lock
);

2182  
ªt
;

2183 
	}
}

2185 
	sbåì_ö£π_›
 {

2186 
båì_›
 
	m›
;

2187 
keyli°
 *
	mkeys
;

2188 
©omic_t
 *
	mjou∫Æ_ªf
;

2189 
bkey
 *
	mª∂a˚_key
;

2192 
	$båì_ö£π_‚
(
båì_›
 *
b_›
, 
båì
 *
b
)

2194 
båì_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
b_›
,

2195 
båì_ö£π_›
, 
›
);

2197 
ªt
 = 
	`bch_båì_ö£π_node
(
b
, &
›
->›, op->
keys
,

2198 
›
->
jou∫Æ_ªf
, op->
ª∂a˚_key
);

2199 i‡(
ªt
 && !
	`bch_keyli°_em±y
(
›
->
keys
))

2200  
ªt
;

2202  
MAP_DONE
;

2203 
	}
}

2205 
	$bch_båì_ö£π
(
ˇche_£t
 *
c
, 
keyli°
 *
keys
,

2206 
©omic_t
 *
jou∫Æ_ªf
, 
bkey
 *
ª∂a˚_key
)

2208 
båì_ö£π_›
 
›
;

2209 
ªt
 = 0;

2211 
	`BUG_ON
(
cuºít
->
bio_li°
);

2212 
	`BUG_ON
(
	`bch_keyli°_em±y
(
keys
));

2214 
	`bch_båì_›_öô
(&
›
.op, 0);

2215 
›
.
keys
 = keys;

2216 
›
.
jou∫Æ_ªf
 = journal_ref;

2217 
›
.
ª∂a˚_key
 =Ñeplace_key;

2219 !
ªt
 && !
	`bch_keyli°_em±y
(
keys
)) {

2220 
›
.›.
lock
 = 0;

2221 
ªt
 = 
	`bch_båì_m≠_Àaf_nodes
(&
›
.›, 
c
,

2222 &
	`START_KEY
(
keys
->keys),

2223 
båì_ö£π_‚
);

2226 i‡(
ªt
) {

2227 
bkey
 *
k
;

2229 
	`¥_îr
("îr‹ %i", 
ªt
);

2231 (
k
 = 
	`bch_keyli°_p›
(
keys
)))

2232 
	`bkey_put
(
c
, 
k
);

2233 } i‡(
›
.›.
ö£π_cﬁlisi⁄
)

2234 
ªt
 = -
ESRCH
;

2236  
ªt
;

2237 
	}
}

2239 
	$bch_båì_£t_roŸ
(
båì
 *
b
)

2241 
i
;

2242 
˛osuª
 
˛
;

2244 
	`˛osuª_öô_°ack
(&
˛
);

2246 
	`åa˚_bˇche_båì_£t_roŸ
(
b
);

2248 
	`BUG_ON
(!
b
->
wrôãn
);

2250 
i
 = 0; i < 
	`KEY_PTRS
(&
b
->
key
); i++)

2251 
	`BUG_ON
(
	`PTR_BUCKET
(
b
->
c
, &b->
key
, 
i
)->
¥io
 !
BTREE_PRIO
);

2253 
	`muãx_lock
(&
b
->
c
->
buckë_lock
);

2254 
	`li°_dñ_öô
(&
b
->
li°
);

2255 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

2257 
b
->
c
->
roŸ
 = b;

2259 
	`bch_jou∫Æ_mëa
(
b
->
c
, &
˛
);

2260 
	`˛osuª_sync
(&
˛
);

2261 
	}
}

2265 
	$bch_båì_m≠_nodes_ªcur£
(
båì
 *
b
, 
båì_›
 *
›
,

2266 
bkey
 *
‰om
,

2267 
båì_m≠_nodes_‚
 *
‚
, 
Êags
)

2269 
ªt
 = 
MAP_CONTINUE
;

2271 i‡(
b
->
Àvñ
) {

2272 
bkey
 *
k
;

2273 
båì_ôî
 
ôî
;

2275 
	`bch_båì_ôî_öô
(&
b
->
keys
, &
ôî
, 
‰om
);

2277 (
k
 = 
	`bch_båì_ôî_√xt_fûãr
(&
ôî
, &
b
->
keys
,

2278 
bch_±r_bad
))) {

2279 
ªt
 = 
	`båì
(
m≠_nodes_ªcur£
, 
k
, 
b
,

2280 
›
, 
‰om
, 
‚
, 
Êags
);

2281 
‰om
 = 
NULL
;

2283 i‡(
ªt
 !
MAP_CONTINUE
)

2284  
ªt
;

2288 i‡(!
b
->
Àvñ
 || 
Êags
 =
MAP_ALL_NODES
)

2289 
ªt
 = 
	`‚
(
›
, 
b
);

2291  
ªt
;

2292 
	}
}

2294 
	$__bch_båì_m≠_nodes
(
båì_›
 *
›
, 
ˇche_£t
 *
c
,

2295 
bkey
 *
‰om
, 
båì_m≠_nodes_‚
 *
‚
, 
Êags
)

2297  
	`båì_roŸ
(
m≠_nodes_ªcur£
, 
c
, 
›
, 
‰om
, 
‚
, 
Êags
);

2298 
	}
}

2300 
	$bch_båì_m≠_keys_ªcur£
(
båì
 *
b
, 
båì_›
 *
›
,

2301 
bkey
 *
‰om
, 
båì_m≠_keys_‚
 *
‚
,

2302 
Êags
)

2304 
ªt
 = 
MAP_CONTINUE
;

2305 
bkey
 *
k
;

2306 
båì_ôî
 
ôî
;

2308 
	`bch_båì_ôî_öô
(&
b
->
keys
, &
ôî
, 
‰om
);

2310 (
k
 = 
	`bch_båì_ôî_√xt_fûãr
(&
ôî
, &
b
->
keys
, 
bch_±r_bad
))) {

2311 
ªt
 = !
b
->
Àvñ


2312 ? 
	`‚
(
›
, 
b
, 
k
)

2313 : 
	`båì
(
m≠_keys_ªcur£
, 
k
, 
b
, 
›
, 
‰om
, 
‚
, 
Êags
);

2314 
‰om
 = 
NULL
;

2316 i‡(
ªt
 !
MAP_CONTINUE
)

2317  
ªt
;

2320 i‡(!
b
->
Àvñ
 && (
Êags
 & 
MAP_END_KEY
))

2321 
ªt
 = 
	`‚
(
›
, 
b
, &
	`KEY
(
	`KEY_INODE
(&b->
key
),

2322 
	`KEY_OFFSET
(&
b
->
key
), 0));

2324  
ªt
;

2325 
	}
}

2327 
	$bch_båì_m≠_keys
(
båì_›
 *
›
, 
ˇche_£t
 *
c
,

2328 
bkey
 *
‰om
, 
båì_m≠_keys_‚
 *
‚
, 
Êags
)

2330  
	`båì_roŸ
(
m≠_keys_ªcur£
, 
c
, 
›
, 
‰om
, 
‚
, 
Êags
);

2331 
	}
}

2335 
ölöe
 
	$keybuf_cmp
(
keybuf_key
 *
l
, keybuf_key *
r
)

2338 i‡(
	`bkey_cmp
(&
l
->
key
, &
	`START_KEY
(&
r
->key)) <= 0)

2340 i‡(
	`bkey_cmp
(&
	`START_KEY
(&
l
->
key
), &
r
->key) >= 0)

2343 
	}
}

2345 
ölöe
 
	$keybuf_n⁄ovîœµög_cmp
(
keybuf_key
 *
l
,

2346 
keybuf_key
 *
r
)

2348  
	`˛amp_t
(
öt64_t
, 
	`bkey_cmp
(&
l
->
key
, &
r
->key), -1, 1);

2349 
	}
}

2351 
	sªfûl
 {

2352 
båì_›
 
	m›
;

2353 
	mƒ_found
;

2354 
keybuf
 *
	mbuf
;

2355 
bkey
 *
	míd
;

2356 
keybuf_¥ed_‚
 *
	m¥ed
;

2359 
	$ªfûl_keybuf_‚
(
båì_›
 *
›
, 
båì
 *
b
,

2360 
bkey
 *
k
)

2362 
ªfûl
 *ªfû»
	`c⁄èöî_of
(
›
, refill, op);

2363 
keybuf
 *
buf
 = 
ªfûl
->buf;

2364 
ªt
 = 
MAP_CONTINUE
;

2366 i‡(
	`bkey_cmp
(
k
, 
ªfûl
->
íd
) >= 0) {

2367 
ªt
 = 
MAP_DONE
;

2368 
out
;

2371 i‡(!
	`KEY_SIZE
(
k
))

2372 
out
;

2374 i‡(
ªfûl
->
	`¥ed
(
buf
, 
k
)) {

2375 
keybuf_key
 *
w
;

2377 
	`•ö_lock
(&
buf
->
lock
);

2379 
w
 = 
	`¨øy_Æloc
(&
buf
->
‰ìli°
);

2380 i‡(!
w
) {

2381 
	`•ö_u∆ock
(&
buf
->
lock
);

2382  
MAP_DONE
;

2385 
w
->
¥iv©e
 = 
NULL
;

2386 
	`bkey_c›y
(&
w
->
key
, 
k
);

2388 i‡(
	`RB_INSERT
(&
buf
->
keys
, 
w
, 
node
, 
keybuf_cmp
))

2389 
	`¨øy_‰ì
(&
buf
->
‰ìli°
, 
w
);

2391 
ªfûl
->
ƒ_found
++;

2393 i‡(
	`¨øy_‰ìli°_em±y
(&
buf
->
‰ìli°
))

2394 
ªt
 = 
MAP_DONE
;

2396 
	`•ö_u∆ock
(&
buf
->
lock
);

2398 
out
:

2399 
buf
->
œ°_sˇ¬ed
 = *
k
;

2400  
ªt
;

2401 
	}
}

2403 
	$bch_ªfûl_keybuf
(
ˇche_£t
 *
c
, 
keybuf
 *
buf
,

2404 
bkey
 *
íd
, 
keybuf_¥ed_‚
 *
¥ed
)

2406 
bkey
 
°¨t
 = 
buf
->
œ°_sˇ¬ed
;

2407 
ªfûl
Ñefill;

2409 
	`c⁄d_ªsched
();

2411 
	`bch_båì_›_öô
(&
ªfûl
.
›
, -1);

2412 
ªfûl
.
ƒ_found
 = 0;

2413 
ªfûl
.
buf
 = buf;

2414 
ªfûl
.
íd
 =Énd;

2415 
ªfûl
.
¥ed
 =Öred;

2417 
	`bch_båì_m≠_keys
(&
ªfûl
.
›
, 
c
, &
buf
->
œ°_sˇ¬ed
,

2418 
ªfûl_keybuf_‚
, 
MAP_END_KEY
);

2420 
	`åa˚_bˇche_keysˇn
(
ªfûl
.
ƒ_found
,

2421 
	`KEY_INODE
(&
°¨t
), 
	`KEY_OFFSET
(&start),

2422 
	`KEY_INODE
(&
buf
->
œ°_sˇ¬ed
),

2423 
	`KEY_OFFSET
(&
buf
->
œ°_sˇ¬ed
));

2425 
	`•ö_lock
(&
buf
->
lock
);

2427 i‡(!
	`RB_EMPTY_ROOT
(&
buf
->
keys
)) {

2428 
keybuf_key
 *
w
;

2429 
w
 = 
	`RB_FIRST
(&
buf
->
keys
, 
keybuf_key
, 
node
);

2430 
buf
->
°¨t
 = 
	`START_KEY
(&
w
->
key
);

2432 
w
 = 
	`RB_LAST
(&
buf
->
keys
, 
keybuf_key
, 
node
);

2433 
buf
->
íd
 = 
w
->
key
;

2435 
buf
->
°¨t
 = 
MAX_KEY
;

2436 
buf
->
íd
 = 
MAX_KEY
;

2439 
	`•ö_u∆ock
(&
buf
->
lock
);

2440 
	}
}

2442 
	$__bch_keybuf_dñ
(
keybuf
 *
buf
, 
keybuf_key
 *
w
)

2444 
	`rb_îa£
(&
w
->
node
, &
buf
->
keys
);

2445 
	`¨øy_‰ì
(&
buf
->
‰ìli°
, 
w
);

2446 
	}
}

2448 
	$bch_keybuf_dñ
(
keybuf
 *
buf
, 
keybuf_key
 *
w
)

2450 
	`•ö_lock
(&
buf
->
lock
);

2451 
	`__bch_keybuf_dñ
(
buf
, 
w
);

2452 
	`•ö_u∆ock
(&
buf
->
lock
);

2453 
	}
}

2455 
boﬁ
 
	$bch_keybuf_check_ovîœµög
(
keybuf
 *
buf
, 
bkey
 *
°¨t
,

2456 
bkey
 *
íd
)

2458 
boﬁ
 
ªt
 = 
Ál£
;

2459 
keybuf_key
 *
p
, *
w
, 
s
;

2460 
s
.
key
 = *
°¨t
;

2462 i‡(
	`bkey_cmp
(
íd
, &
buf
->
°¨t
) <= 0 ||

2463 
	`bkey_cmp
(
°¨t
, &
buf
->
íd
) >= 0)

2464  
Ál£
;

2466 
	`•ö_lock
(&
buf
->
lock
);

2467 
w
 = 
	`RB_GREATER
(&
buf
->
keys
, 
s
, 
node
, 
keybuf_n⁄ovîœµög_cmp
);

2469 
w
 && 
	`bkey_cmp
(&
	`START_KEY
(&w->
key
), 
íd
) < 0) {

2470 
p
 = 
w
;

2471 
w
 = 
	`RB_NEXT
(w, 
node
);

2473 i‡(
p
->
¥iv©e
)

2474 
ªt
 = 
åue
;

2476 
	`__bch_keybuf_dñ
(
buf
, 
p
);

2479 
	`•ö_u∆ock
(&
buf
->
lock
);

2480  
ªt
;

2481 
	}
}

2483 
keybuf_key
 *
	$bch_keybuf_√xt
(
keybuf
 *
buf
)

2485 
keybuf_key
 *
w
;

2486 
	`•ö_lock
(&
buf
->
lock
);

2488 
w
 = 
	`RB_FIRST
(&
buf
->
keys
, 
keybuf_key
, 
node
);

2490 
w
 && w->
¥iv©e
)

2491 
w
 = 
	`RB_NEXT
(w, 
node
);

2493 i‡(
w
)

2494 
w
->
¥iv©e
 = 
	`ERR_PTR
(-
EINTR
);

2496 
	`•ö_u∆ock
(&
buf
->
lock
);

2497  
w
;

2498 
	}
}

2500 
keybuf_key
 *
	$bch_keybuf_√xt_ªsˇn
(
ˇche_£t
 *
c
,

2501 
keybuf
 *
buf
,

2502 
bkey
 *
íd
,

2503 
keybuf_¥ed_‚
 *
¥ed
)

2505 
keybuf_key
 *
ªt
;

2508 
ªt
 = 
	`bch_keybuf_√xt
(
buf
);

2509 i‡(
ªt
)

2512 i‡(
	`bkey_cmp
(&
buf
->
œ°_sˇ¬ed
, 
íd
) >= 0) {

2513 
	`¥_debug
("scan finished");

2517 
	`bch_ªfûl_keybuf
(
c
, 
buf
, 
íd
, 
¥ed
);

2520  
ªt
;

2521 
	}
}

2523 
	$bch_keybuf_öô
(
keybuf
 *
buf
)

2525 
buf
->
œ°_sˇ¬ed
 = 
MAX_KEY
;

2526 
buf
->
keys
 = 
RB_ROOT
;

2528 
	`•ö_lock_öô
(&
buf
->
lock
);

2529 
	`¨øy_Æloˇt‹_öô
(&
buf
->
‰ìli°
);

2530 
	}
}

	@bcache/btree.h

1 #i‚de‡
_BCACHE_BTREE_H


2 
	#_BCACHE_BTREE_H


	)

101 
	~"b£t.h
"

102 
	~"debug.h
"

104 
	sbåì_wrôe
 {

105 
©omic_t
 *
	mjou∫Æ
;

113 
	m¥io_blocked
;

116 
	sbåì
 {

118 
hli°_node
 
	mhash
;

121 
BKEY_PADDED
(
key
);

124 
	mac˚s£d
;

125 
	m£q
;

126 
rw_£m≠h‹e
 
	mlock
;

127 
ˇche_£t
 *
	mc
;

128 
båì
 *
	m∑ª¡
;

130 
muãx
 
	mwrôe_lock
;

132 
	mÊags
;

133 
uöt16_t
 
	mwrôãn
;

134 
uöt8_t
 
	mÀvñ
;

136 
båì_keys
 
	mkeys
;

139 
˛osuª
 
	mio
;

140 
£m≠h‹e
 
	mio_muãx
;

142 
li°_hód
 
	mli°
;

143 
dñayed_w‹k
 
	mw‹k
;

145 
båì_wrôe
 
	mwrôes
[2];

146 
bio
 *
	mbio
;

149 
	#BTREE_FLAG
(
Êag
) \

150 
ölöe
 
boﬁ
 
båì_node_
 ## 
	`Êag
(
båì
 *
b
) \

151 {  
	`ã°_bô
(
BTREE_NODE_
 ## 
Êag
, &
b
->
Êags
); } \

153 
ölöe
 
£t_båì_node_
 ## 
	`Êag
(
båì
 *
b
) \

154 { 
	`£t_bô
(
BTREE_NODE_
 ## 
Êag
, &
b
->
Êags
); } \

155 

	)

156 
	ebåì_Êags
 {

157 
	mBTREE_NODE_io_îr‹
,

158 
	mBTREE_NODE_dúty
,

159 
	mBTREE_NODE_wrôe_idx
,

162 
BTREE_FLAG
(
io_îr‹
);

163 
BTREE_FLAG
(
dúty
);

164 
BTREE_FLAG
(
wrôe_idx
);

166 
ölöe
 
båì_wrôe
 *
	$båì_cuºít_wrôe
(
båì
 *
b
)

168  
b
->
wrôes
 + 
	`båì_node_wrôe_idx
(b);

169 
	}
}

171 
ölöe
 
båì_wrôe
 *
	$båì_¥ev_wrôe
(
båì
 *
b
)

173  
b
->
wrôes
 + (
	`båì_node_wrôe_idx
(b) ^ 1);

174 
	}
}

176 
ölöe
 
b£t
 *
	$båì_b£t_fú°
(
båì
 *
b
)

178  
b
->
keys
.
£t
->
d©a
;

179 
	}
}

181 
ölöe
 
b£t
 *
	$båì_b£t_œ°
(
båì
 *
b
)

183  
	`b£t_åì_œ°
(&
b
->
keys
)->
d©a
;

184 
	}
}

186 
ölöe
 
	$b£t_block_off£t
(
båì
 *
b
, 
b£t
 *
i
)

188  
	`b£t_£˘‹_off£t
(&
b
->
keys
, 
i
Ë>> b->
c
->
block_bôs
;

189 
	}
}

191 
ölöe
 
	$£t_gc_£˘‹s
(
ˇche_£t
 *
c
)

193 
	`©omic_£t
(&
c
->
£˘‹s_to_gc
, c->
sb
.
buckë_size
 * c->
nbuckës
 / 16);

194 
	}
}

196 
bkey_put
(
ˇche_£t
 *
c
, 
bkey
 *
k
);

200 
	#f‹_óch_ˇched_båì
(
b
, 
c
, 
ôî
) \

201 
ôî
 = 0; \

202 
ôî
 < 
	`ARRAY_SIZE
((
c
)->
buckë_hash
); \

203 
ôî
++) \

204 
	`hli°_f‹_óch_íåy_rcu
((
b
), (
c
)->
buckë_hash
 + 
ôî
, 
hash
)

	)

208 
	sbåì_›
 {

210 
waô_queue_t
 
	mwaô
;

213 
	mlock
;

215 
	mö£π_cﬁlisi⁄
:1;

218 
ölöe
 
	$bch_båì_›_öô
(
båì_›
 *
›
, 
wrôe_lock_Àvñ
)

220 
	`mem£t
(
›
, 0, (
båì_›
));

221 
	`öô_waô
(&
›
->
waô
);

222 
›
->
lock
 = 
wrôe_lock_Àvñ
;

223 
	}
}

225 
ölöe
 
	$rw_lock
(
boﬁ
 
w
, 
båì
 *
b
, 
Àvñ
)

227 
w
 ? 
	`down_wrôe_√°ed
(&
b
->
lock
, 
Àvñ
 + 1)

228 : 
	`down_ªad_√°ed
(&
b
->
lock
, 
Àvñ
 + 1);

229 i‡(
w
)

230 
b
->
£q
++;

231 
	}
}

233 
ölöe
 
	$rw_u∆ock
(
boﬁ
 
w
, 
båì
 *
b
)

235 i‡(
w
)

236 
b
->
£q
++;

237 (
w
 ? 
up_wrôe
 : 
up_ªad
)(&
b
->
lock
);

238 
	}
}

240 
bch_båì_node_ªad_d⁄e
(
båì
 *);

241 
__bch_båì_node_wrôe
(
båì
 *, 
˛osuª
 *);

242 
bch_båì_node_wrôe
(
båì
 *, 
˛osuª
 *);

244 
bch_båì_£t_roŸ
(
båì
 *);

245 
båì
 *
__bch_båì_node_Æloc
(
ˇche_£t
 *, 
båì_›
 *,

246 , 
boﬁ
, 
båì
 *);

247 
båì
 *
bch_båì_node_gë
(
ˇche_£t
 *, 
båì_›
 *,

248 
bkey
 *, , 
boﬁ
, 
båì
 *);

250 
bch_båì_ö£π_check_key
(
båì
 *, 
båì_›
 *,

251 
bkey
 *);

252 
bch_båì_ö£π
(
ˇche_£t
 *, 
keyli°
 *,

253 
©omic_t
 *, 
bkey
 *);

255 
bch_gc_thªad_°¨t
(
ˇche_£t
 *);

256 
bch_öôül_gc_föish
(
ˇche_£t
 *);

257 
bch_movög_gc
(
ˇche_£t
 *);

258 
bch_båì_check
(
ˇche_£t
 *);

259 
bch_öôül_m¨k_key
(
ˇche_£t
 *, , 
bkey
 *);

261 
ölöe
 
	$wake_up_gc
(
ˇche_£t
 *
c
)

263 i‡(
c
->
gc_thªad
)

264 
	`wake_up_¥o˚ss
(
c
->
gc_thªad
);

265 
	}
}

267 
	#MAP_DONE
 0

	)

268 
	#MAP_CONTINUE
 1

	)

270 
	#MAP_ALL_NODES
 0

	)

271 
	#MAP_LEAF_NODES
 1

	)

273 
	#MAP_END_KEY
 1

	)

275 (
	tbåì_m≠_nodes_‚
)(
	tbåì_›
 *, 
	tbåì
 *);

276 
	`__bch_båì_m≠_nodes
(
båì_›
 *, 
ˇche_£t
 *,

277 
bkey
 *, 
båì_m≠_nodes_‚
 *, );

279 
ölöe
 
	$bch_båì_m≠_nodes
(
båì_›
 *
›
, 
ˇche_£t
 *
c
,

280 
bkey
 *
‰om
, 
båì_m≠_nodes_‚
 *
‚
)

282  
	`__bch_båì_m≠_nodes
(
›
, 
c
, 
‰om
, 
‚
, 
MAP_ALL_NODES
);

283 
	}
}

285 
ölöe
 
	$bch_båì_m≠_Àaf_nodes
(
båì_›
 *
›
,

286 
ˇche_£t
 *
c
,

287 
bkey
 *
‰om
,

288 
båì_m≠_nodes_‚
 *
‚
)

290  
	`__bch_båì_m≠_nodes
(
›
, 
c
, 
‰om
, 
‚
, 
MAP_LEAF_NODES
);

291 
	}
}

293 (
	tbåì_m≠_keys_‚
)(
	tbåì_›
 *, 
	tbåì
 *,

294 
	tbkey
 *);

295 
	`bch_båì_m≠_keys
(
båì_›
 *, 
ˇche_£t
 *,

296 
bkey
 *, 
båì_m≠_keys_‚
 *, );

298 
	$boﬁ
 (
	tkeybuf_¥ed_‚
)(
	tkeybuf
 *, 
	tbkey
 *);

300 
	`bch_keybuf_öô
(
keybuf
 *);

301 
	`bch_ªfûl_keybuf
(
ˇche_£t
 *, 
keybuf
 *,

302 
bkey
 *, 
keybuf_¥ed_‚
 *);

303 
boﬁ
 
	`bch_keybuf_check_ovîœµög
(
keybuf
 *, 
bkey
 *,

304 
bkey
 *);

305 
	`bch_keybuf_dñ
(
keybuf
 *, 
keybuf_key
 *);

306 
keybuf_key
 *
	`bch_keybuf_√xt
(
keybuf
 *);

307 
keybuf_key
 *
	`bch_keybuf_√xt_ªsˇn
(
ˇche_£t
 *, 
keybuf
 *,

308 
bkey
 *, 
keybuf_¥ed_‚
 *);

	@bcache/closure.c

8 
	~<löux/debugfs.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/£q_fûe.h
>

12 
	~"˛osuª.h
"

14 
ölöe
 
	$˛osuª_put_a·î_sub
(
˛osuª
 *
˛
, 
Êags
)

16 
r
 = 
Êags
 & 
CLOSURE_REMAINING_MASK
;

18 
	`BUG_ON
(
Êags
 & 
CLOSURE_GUARD_MASK
);

19 
	`BUG_ON
(!
r
 && (
Êags
 & ~
CLOSURE_DESTRUCTOR
));

22 i‡(
r
 =1 && (
Êags
 & 
CLOSURE_SLEEPING
))

23 
	`wake_up_¥o˚ss
(
˛
->
èsk
);

25 i‡(!
r
) {

26 i‡(
˛
->
‚
 && !(
Êags
 & 
CLOSURE_DESTRUCTOR
)) {

27 
	`©omic_£t
(&
˛
->
ªmaöög
,

28 
CLOSURE_REMAINING_INITIALIZER
);

29 
	`˛osuª_queue
(
˛
);

31 
˛osuª
 *
∑ª¡
 = 
˛
->parent;

32 
˛osuª_‚
 *
de°ru˘‹
 = 
˛
->
‚
;

34 
	`˛osuª_debug_de°roy
(
˛
);

36 i‡(
de°ru˘‹
)

37 
	`de°ru˘‹
(
˛
);

39 i‡(
∑ª¡
)

40 
	`˛osuª_put
(
∑ª¡
);

43 
	}
}

46 
	$˛osuª_sub
(
˛osuª
 *
˛
, 
v
)

48 
	`˛osuª_put_a·î_sub
(
˛
, 
	`©omic_sub_ªtu∫
(
v
, &˛->
ªmaöög
));

49 
	}
}

50 
EXPORT_SYMBOL
(
˛osuª_sub
);

55 
	$˛osuª_put
(
˛osuª
 *
˛
)

57 
	`˛osuª_put_a·î_sub
(
˛
, 
	`©omic_dec_ªtu∫
(&˛->
ªmaöög
));

58 
	}
}

59 
EXPORT_SYMBOL
(
˛osuª_put
);

64 
	$__˛osuª_wake_up
(
˛osuª_waôli°
 *
waô_li°
)

66 
Œi°_node
 *
li°
;

67 
˛osuª
 *
˛
;

68 
Œi°_node
 *
ªvî£
 = 
NULL
;

70 
li°
 = 
	`Œi°_dñ_Æl
(&
waô_li°
->list);

74 
li°
) {

75 
Œi°_node
 *
t
 = 
li°
;

76 
li°
 = 
	`Œi°_√xt
(list);

78 
t
->
√xt
 = 
ªvî£
;

79 
ªvî£
 = 
t
;

84 
ªvî£
) {

85 
˛
 = 
	`c⁄èöî_of
(
ªvî£
, 
˛osuª
, 
li°
);

86 
ªvî£
 = 
	`Œi°_√xt
(reverse);

88 
	`˛osuª_£t_waôög
(
˛
, 0);

89 
	`˛osuª_sub
(
˛
, 
CLOSURE_WAITING
 + 1);

91 
	}
}

92 
EXPORT_SYMBOL
(
__˛osuª_wake_up
);

101 
boﬁ
 
	$˛osuª_waô
(
˛osuª_waôli°
 *
waôli°
, 
˛osuª
 *
˛
)

103 i‡(
	`©omic_ªad
(&
˛
->
ªmaöög
Ë& 
CLOSURE_WAITING
)

104  
Ál£
;

106 
	`˛osuª_£t_waôög
(
˛
, 
_RET_IP_
);

107 
	`©omic_add
(
CLOSURE_WAITING
 + 1, &
˛
->
ªmaöög
);

108 
	`Œi°_add
(&
˛
->
li°
, &
waôli°
->list);

110  
åue
;

111 
	}
}

112 
EXPORT_SYMBOL
(
˛osuª_waô
);

120 
	$˛osuª_sync
(
˛osuª
 *
˛
)

123 
	`__˛osuª_°¨t_¶ìp
(
˛
);

124 
	`˛osuª_£t_ªt_ù
(
˛
);

126 i‡((
	`©omic_ªad
(&
˛
->
ªmaöög
) &

127 
CLOSURE_REMAINING_MASK
) == 1)

130 
	`scheduÀ
();

133 
	`__˛osuª_íd_¶ìp
(
˛
);

134 
	}
}

135 
EXPORT_SYMBOL
(
˛osuª_sync
);

137 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


139 
LIST_HEAD
(
˛osuª_li°
);

140 
DEFINE_SPINLOCK
(
˛osuª_li°_lock
);

142 
	$˛osuª_debug_¸óã
(
˛osuª
 *
˛
)

144 
Êags
;

146 
	`BUG_ON
(
˛
->
magic
 =
CLOSURE_MAGIC_ALIVE
);

147 
˛
->
magic
 = 
CLOSURE_MAGIC_ALIVE
;

149 
	`•ö_lock_úqßve
(&
˛osuª_li°_lock
, 
Êags
);

150 
	`li°_add
(&
˛
->
Æl
, &
˛osuª_li°
);

151 
	`•ö_u∆ock_úqª°‹e
(&
˛osuª_li°_lock
, 
Êags
);

152 
	}
}

153 
EXPORT_SYMBOL
(
˛osuª_debug_¸óã
);

155 
	$˛osuª_debug_de°roy
(
˛osuª
 *
˛
)

157 
Êags
;

159 
	`BUG_ON
(
˛
->
magic
 !
CLOSURE_MAGIC_ALIVE
);

160 
˛
->
magic
 = 
CLOSURE_MAGIC_DEAD
;

162 
	`•ö_lock_úqßve
(&
˛osuª_li°_lock
, 
Êags
);

163 
	`li°_dñ
(&
˛
->
Æl
);

164 
	`•ö_u∆ock_úqª°‹e
(&
˛osuª_li°_lock
, 
Êags
);

165 
	}
}

166 
EXPORT_SYMBOL
(
˛osuª_debug_de°roy
);

168 
díåy
 *
	gdebug
;

170 
	#w‹k_d©a_bôs
(
w‹k
Ë((*)(&(w‹k)->
d©a
))

	)

172 
	$debug_£q_show
(
£q_fûe
 *
f
, *
d©a
)

174 
˛osuª
 *
˛
;

175 
	`•ö_lock_úq
(&
˛osuª_li°_lock
);

177 
	`li°_f‹_óch_íåy
(
˛
, &
˛osuª_li°
, 
Æl
) {

178 
r
 = 
	`©omic_ªad
(&
˛
->
ªmaöög
);

180 
	`£q_¥ötf
(
f
, "%p: %pF -> %pfÖ %pÑ %i ",

181 
˛
, (*Ë˛->
ù
, cl->
‚
, cl->
∑ª¡
,

182 
r
 & 
CLOSURE_REMAINING_MASK
);

184 
	`£q_¥ötf
(
f
, "%s%s%s%s\n",

185 
	`ã°_bô
(
WORK_STRUCT_PENDING
,

186 
	`w‹k_d©a_bôs
(&
˛
->
w‹k
)) ? "Q" : "",

187 
r
 & 
CLOSURE_RUNNING
 ? "R" : "",

188 
r
 & 
CLOSURE_STACK
 ? "S" : "",

189 
r
 & 
CLOSURE_SLEEPING
 ? "Sl" : "");

191 i‡(
r
 & 
CLOSURE_WAITING
)

192 
	`£q_¥ötf
(
f
, " W %pF\n",

193 (*Ë
˛
->
waôög_⁄
);

195 
	`£q_¥ötf
(
f
, "\n");

198 
	`•ö_u∆ock_úq
(&
˛osuª_li°_lock
);

200 
	}
}

202 
	$debug_£q_›í
(
öode
 *öode, 
fûe
 *file)

204  
	`sögÀ_›í
(
fûe
, 
debug_£q_show
, 
NULL
);

205 
	}
}

207 c⁄° 
fûe_›î©i⁄s
 
	gdebug_›s
 = {

208 .
ow√r
 = 
THIS_MODULE
,

209 .
	g›í
 = 
debug_£q_›í
,

210 .
	gªad
 = 
£q_ªad
,

211 .
	gªÀa£
 = 
sögÀ_ªÀa£


214 
__öô
 
	$˛osuª_debug_öô
()

216 
debug
 = 
	`debugfs_¸óã_fûe
("˛osuªs", 0400, 
NULL
, NULL, &
debug_›s
);

217 
	}
}

221 
MODULE_AUTHOR
("Kent Overstreet <koverstreet@google.com>");

222 
MODULE_LICENSE
("GPL");

	@bcache/closure.h

1 #i‚de‡
_LINUX_CLOSURE_H


2 
	#_LINUX_CLOSURE_H


	)

4 
	~<löux/Œi°.h
>

5 
	~<löux/sched.h
>

6 
	~<löux/w‹kqueue.h
>

102 
	g˛osuª
;

103 (
	t˛osuª_‚
Ë(
	t˛osuª
 *);

105 
	s˛osuª_waôli°
 {

106 
Œi°_hód
 
li°
;

109 
	e˛osuª_°©e
 {

133 
CLOSURE_BITS_START
 = (1 << 23),

134 
CLOSURE_DESTRUCTOR
 = (1 << 23),

135 
CLOSURE_WAITING
 = (1 << 25),

136 
CLOSURE_SLEEPING
 = (1 << 27),

137 
CLOSURE_RUNNING
 = (1 << 29),

138 
CLOSURE_STACK
 = (1 << 31),

141 
	#CLOSURE_GUARD_MASK
 \

142 ((
CLOSURE_DESTRUCTOR
|
CLOSURE_WAITING
|
CLOSURE_SLEEPING
| \

143 
CLOSURE_RUNNING
|
CLOSURE_STACK
Ë<< 1)

	)

145 
	#CLOSURE_REMAINING_MASK
 (
CLOSURE_BITS_START
 - 1)

	)

146 
	#CLOSURE_REMAINING_INITIALIZER
 (1|
CLOSURE_RUNNING
)

	)

148 
	s˛osuª
 {

151 
w‹kqueue_°ru˘
 *
wq
;

152 
èsk_°ru˘
 *
èsk
;

153 
Œi°_node
 
li°
;

154 
˛osuª_‚
 *
‚
;

156 
w‹k_°ru˘
 
w‹k
;

159 
˛osuª
 *
∑ª¡
;

161 
©omic_t
 
ªmaöög
;

163 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


164 
	#CLOSURE_MAGIC_DEAD
 0xc054dód

	)

165 
	#CLOSURE_MAGIC_ALIVE
 0xc054a11e

	)

167 
magic
;

168 
li°_hód
 
Æl
;

169 
ù
;

170 
waôög_⁄
;

174 
	`˛osuª_sub
(
˛osuª
 *
˛
, 
v
);

175 
	`˛osuª_put
(
˛osuª
 *
˛
);

176 
	`__˛osuª_wake_up
(
˛osuª_waôli°
 *
li°
);

177 
boﬁ
 
	`˛osuª_waô
(
˛osuª_waôli°
 *
li°
, 
˛osuª
 *
˛
);

178 
	`˛osuª_sync
(
˛osuª
 *
˛
);

180 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


182 
	`˛osuª_debug_öô
();

183 
	`˛osuª_debug_¸óã
(
˛osuª
 *
˛
);

184 
	`˛osuª_debug_de°roy
(
˛osuª
 *
˛
);

188 
ölöe
 
	$˛osuª_debug_öô
(Ë{
	}
}

189 
ölöe
 
	$˛osuª_debug_¸óã
(
˛osuª
 *
˛
Ë{
	}
}

190 
ölöe
 
	$˛osuª_debug_de°roy
(
˛osuª
 *
˛
Ë{
	}
}

194 
ölöe
 
	$˛osuª_£t_ù
(
˛osuª
 *
˛
)

196 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


197 
˛
->
ù
 = 
_THIS_IP_
;

199 
	}
}

201 
ölöe
 
	$˛osuª_£t_ªt_ù
(
˛osuª
 *
˛
)

203 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


204 
˛
->
ù
 = 
_RET_IP_
;

206 
	}
}

208 
ölöe
 
	$˛osuª_£t_waôög
(
˛osuª
 *
˛
, 
f
)

210 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


211 
˛
->
waôög_⁄
 = 
f
;

213 
	}
}

215 
ölöe
 
	$__˛osuª_íd_¶ìp
(
˛osuª
 *
˛
)

217 
	`__£t_cuºít_°©e
(
TASK_RUNNING
);

219 i‡(
	`©omic_ªad
(&
˛
->
ªmaöög
Ë& 
CLOSURE_SLEEPING
)

220 
	`©omic_sub
(
CLOSURE_SLEEPING
, &
˛
->
ªmaöög
);

221 
	}
}

223 
ölöe
 
	$__˛osuª_°¨t_¶ìp
(
˛osuª
 *
˛
)

225 
	`˛osuª_£t_ù
(
˛
);

226 
˛
->
èsk
 = 
cuºít
;

227 
	`£t_cuºít_°©e
(
TASK_UNINTERRUPTIBLE
);

229 i‡(!(
	`©omic_ªad
(&
˛
->
ªmaöög
Ë& 
CLOSURE_SLEEPING
))

230 
	`©omic_add
(
CLOSURE_SLEEPING
, &
˛
->
ªmaöög
);

231 
	}
}

233 
ölöe
 
	$˛osuª_£t_°›≥d
(
˛osuª
 *
˛
)

235 
	`©omic_sub
(
CLOSURE_RUNNING
, &
˛
->
ªmaöög
);

236 
	}
}

238 
ölöe
 
	$£t_˛osuª_‚
(
˛osuª
 *
˛
, 
˛osuª_‚
 *
‚
,

239 
w‹kqueue_°ru˘
 *
wq
)

241 
	`BUG_ON
(
	`obje˘_is_⁄_°ack
(
˛
));

242 
	`˛osuª_£t_ù
(
˛
);

243 
˛
->
‚
 = fn;

244 
˛
->
wq
 = wq;

246 
	`smp_mb__bef‹e_©omic
();

247 
	}
}

249 
ölöe
 
	$˛osuª_queue
(
˛osuª
 *
˛
)

251 
w‹kqueue_°ru˘
 *
wq
 = 
˛
->wq;

252 i‡(
wq
) {

253 
	`INIT_WORK
(&
˛
->
w‹k
, cl->w‹k.
func
);

254 
	`BUG_ON
(!
	`queue_w‹k
(
wq
, &
˛
->
w‹k
));

256 
˛
->
	`‚
(cl);

257 
	}
}

262 
ölöe
 
	$˛osuª_gë
(
˛osuª
 *
˛
)

264 #ifde‡
CONFIG_BCACHE_CLOSURES_DEBUG


265 
	`BUG_ON
((
	`©omic_öc_ªtu∫
(&
˛
->
ªmaöög
) &

266 
CLOSURE_REMAINING_MASK
) <= 1);

268 
	`©omic_öc
(&
˛
->
ªmaöög
);

270 
	}
}

278 
ölöe
 
	$˛osuª_öô
(
˛osuª
 *
˛
, ˛osuª *
∑ª¡
)

280 
	`mem£t
(
˛
, 0, (
˛osuª
));

281 
˛
->
∑ª¡
 =Öarent;

282 i‡(
∑ª¡
)

283 
	`˛osuª_gë
(
∑ª¡
);

285 
	`©omic_£t
(&
˛
->
ªmaöög
, 
CLOSURE_REMAINING_INITIALIZER
);

287 
	`˛osuª_debug_¸óã
(
˛
);

288 
	`˛osuª_£t_ù
(
˛
);

289 
	}
}

291 
ölöe
 
	$˛osuª_öô_°ack
(
˛osuª
 *
˛
)

293 
	`mem£t
(
˛
, 0, (
˛osuª
));

294 
	`©omic_£t
(&
˛
->
ªmaöög
, 
CLOSURE_REMAINING_INITIALIZER
|
CLOSURE_STACK
);

295 
	}
}

300 
ölöe
 
	$˛osuª_wake_up
(
˛osuª_waôli°
 *
li°
)

302 
	`smp_mb
();

303 
	`__˛osuª_wake_up
(
li°
);

304 
	}
}

319 
	#c⁄töue_©
(
_˛
, 
_‚
, 
_wq
) \

321 
	`£t_˛osuª_‚
(
_˛
, 
_‚
, 
_wq
); \

322 
	`˛osuª_sub
(
_˛
, 
CLOSURE_RUNNING
 + 1); \

324 } 0)

	)

334 
	#˛osuª_ªtu∫
(
_˛
Ë
	`c⁄töue_©
((_˛), 
NULL
, NULL)

	)

348 
	#c⁄töue_©_nob¨rõr
(
_˛
, 
_‚
, 
_wq
) \

350 
	`£t_˛osuª_‚
(
_˛
, 
_‚
, 
_wq
); \

351 
	`˛osuª_queue
(
_˛
); \

353 } 0)

	)

364 
	#˛osuª_ªtu∫_wôh_de°ru˘‹
(
_˛
, 
_de°ru˘‹
) \

366 
	`£t_˛osuª_‚
(
_˛
, 
_de°ru˘‹
, 
NULL
); \

367 
	`˛osuª_sub
(
_˛
, 
CLOSURE_RUNNING
 - 
CLOSURE_DESTRUCTOR
 + 1); \

369 } 0)

	)

378 
ölöe
 
	$˛osuª_ˇŒ
(
˛osuª
 *
˛
, 
˛osuª_‚
 
‚
,

379 
w‹kqueue_°ru˘
 *
wq
,

380 
˛osuª
 *
∑ª¡
)

382 
	`˛osuª_öô
(
˛
, 
∑ª¡
);

383 
	`c⁄töue_©_nob¨rõr
(
˛
, 
‚
, 
wq
);

384 
	}
}

	@bcache/debug.c

8 
	~"bˇche.h
"

9 
	~"båì.h
"

10 
	~"debug.h
"

11 
	~"exã¡s.h
"

13 
	~<löux/c⁄sﬁe.h
>

14 
	~<löux/debugfs.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/øndom.h
>

17 
	~<löux/£q_fûe.h
>

19 
díåy
 *
	gdebug
;

21 #ifde‡
CONFIG_BCACHE_DEBUG


23 
	#f‹_óch_wrôãn_b£t
(
b
, 
°¨t
, 
i
) \

24 
i
 = (
°¨t
); \

25 (*Ë
i
 < (*Ë(
°¨t
Ë+ (
	`KEY_SIZE
(&
b
->
key
) << 9) &&\

26 
i
->
£q
 =(
°¨t
)->seq; \

27 
i
 = (*Ëò+ 
	`£t_blocks
(i, 
	`block_byãs
(
b
->
c
)) * \

28 
	`block_byãs
(
b
->
c
))

	)

30 
	$bch_båì_vîify
(
båì
 *
b
)

32 
båì
 *
v
 = 
b
->
c
->
vîify_d©a
;

33 
b£t
 *
⁄disk
, *
s‹ãd
, *
ömem‹y
;

34 
bio
 *bio;

36 i‡(!
b
->
c
->
vîify
 || !b->c->
vîify_⁄disk
)

39 
	`down
(&
b
->
io_muãx
);

40 
	`muãx_lock
(&
b
->
c
->
vîify_lock
);

42 
⁄disk
 = 
b
->
c
->
vîify_⁄disk
;

43 
s‹ãd
 = 
b
->
c
->
vîify_d©a
->
keys
.
£t
->
d©a
;

44 
ömem‹y
 = 
b
->
keys
.
£t
->
d©a
;

46 
	`bkey_c›y
(&
v
->
key
, &
b
->key);

47 
v
->
wrôãn
 = 0;

48 
v
->
Àvñ
 = 
b
->level;

49 
v
->
keys
.
›s
 = 
b
->keys.ops;

51 
bio
 = 
	`bch_bbio_Æloc
(
b
->
c
);

52 
bio
->
bi_bdev
 = 
	`PTR_CACHE
(
b
->
c
, &b->
key
, 0)->
bdev
;

53 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`PTR_OFFSET
(&
b
->
key
, 0);

54 
bio
->
bi_ôî
.
bi_size
 = 
	`KEY_SIZE
(&
v
->
key
) << 9;

55 
	`bch_bio_m≠
(
bio
, 
s‹ãd
);

57 
	`submô_bio_waô
(
REQ_META
|
READ_SYNC
, 
bio
);

58 
	`bch_bbio_‰ì
(
bio
, 
b
->
c
);

60 
	`mem˝y
(
⁄disk
, 
s‹ãd
, 
	`KEY_SIZE
(&
v
->
key
) << 9);

62 
	`bch_båì_node_ªad_d⁄e
(
v
);

63 
s‹ãd
 = 
v
->
keys
.
£t
->
d©a
;

65 i‡(
ömem‹y
->
keys
 !
s‹ãd
->keys ||

66 
	`memcmp
(
ömem‹y
->
°¨t
,

67 
s‹ãd
->
°¨t
,

68 (*Ë
	`b£t_bkey_œ°
(
ömem‹y
Ë- (*Ëömem‹y->
°¨t
)) {

69 
b£t
 *
i
;

70 
j
;

72 
	`c⁄sﬁe_lock
();

74 
	`¥ötk
(
KERN_ERR
 "*** in memory:\n");

75 
	`bch_dump_b£t
(&
b
->
keys
, 
ömem‹y
, 0);

77 
	`¥ötk
(
KERN_ERR
 "***Ñead back in:\n");

78 
	`bch_dump_b£t
(&
v
->
keys
, 
s‹ãd
, 0);

80 
	`f‹_óch_wrôãn_b£t
(
b
, 
⁄disk
, 
i
) {

81 
block
 = ((*Ë
i
 - (*Ë
⁄disk
) /

82 
	`block_byãs
(
b
->
c
);

84 
	`¥ötk
(
KERN_ERR
 "*** o¿disk block %u:\n", 
block
);

85 
	`bch_dump_b£t
(&
b
->
keys
, 
i
, 
block
);

88 
	`¥ötk
(
KERN_ERR
 "*** block %zuÇot written\n",

89 ((*Ë
i
 - (*Ë
⁄disk
Ë/ 
	`block_byãs
(
b
->
c
));

91 
j
 = 0; j < 
ömem‹y
->
keys
; j++)

92 i‡(
ömem‹y
->
d
[
j
] !
s‹ãd
->d[j])

95 
	`¥ötk
(
KERN_ERR
 "b->wrôã¿%u\n", 
b
->
wrôãn
);

97 
	`c⁄sﬁe_u∆ock
();

98 
	`∑nic
("vîify faûedáà%u\n", 
j
);

101 
	`muãx_u∆ock
(&
b
->
c
->
vîify_lock
);

102 
	`up
(&
b
->
io_muãx
);

103 
	}
}

105 
	$bch_d©a_vîify
(
ˇched_dev
 *
dc
, 
bio
 *bio)

107 
«me
[
BDEVNAME_SIZE
];

108 
bio
 *
check
;

109 
bio_vec
 
bv
, *
bv2
;

110 
bvec_ôî
 
ôî
;

111 
i
;

113 
check
 = 
	`bio_˛⁄e
(
bio
, 
GFP_NOIO
);

114 i‡(!
check
)

117 i‡(
	`bio_Æloc_∑ges
(
check
, 
GFP_NOIO
))

118 
out_put
;

120 
	`submô_bio_waô
(
READ_SYNC
, 
check
);

122 
	`bio_f‹_óch_£gmít
(
bv
, 
bio
, 
ôî
) {

123 *
p1
 = 
	`km≠_©omic
(
bv
.
bv_∑ge
);

124 *
p2
 = 
	`∑ge_addªss
(
check
->
bi_io_vec
[
ôî
.
bi_idx
].
bv_∑ge
);

126 
	`ˇche_£t_îr_⁄
(
	`memcmp
(
p1
 + 
bv
.
bv_off£t
,

127 
p2
 + 
bv
.
bv_off£t
,

128 
bv
.
bv_Àn
),

129 
dc
->
disk
.
c
,

131 
	`bdev«me
(
dc
->
bdev
, 
«me
),

132 (
uöt64_t
Ë
bio
->
bi_ôî
.
bi_£˘‹
);

134 
	`kunm≠_©omic
(
p1
);

137 
	`bio_f‹_óch_£gmít_Æl
(
bv2
, 
check
, 
i
)

138 
	`__‰ì_∑ge
(
bv2
->
bv_∑ge
);

139 
out_put
:

140 
	`bio_put
(
check
);

141 
	}
}

145 #ifde‡
CONFIG_DEBUG_FS


149 
	sdump_ôî©‹
 {

150 
	mbuf
[
PAGE_SIZE
];

151 
size_t
 
	mbyãs
;

152 
ˇche_£t
 *
	mc
;

153 
keybuf
 
	mkeys
;

156 
boﬁ
 
	$dump_¥ed
(
keybuf
 *
buf
, 
bkey
 *
k
)

158  
åue
;

159 
	}
}

161 
ssize_t
 
	$bch_dump_ªad
(
fûe
 *fûe, 
__u£r
 *
buf
,

162 
size_t
 
size
, 
loff_t
 *
µos
)

164 
dump_ôî©‹
 *
i
 = 
fûe
->
¥iv©e_d©a
;

165 
ssize_t
 
ªt
 = 0;

166 
kbuf
[80];

168 
size
) {

169 
keybuf_key
 *
w
;

170 
byãs
 = 
	`mö
(
i
->byãs, 
size
);

172 
îr
 = 
	`c›y_to_u£r
(
buf
, 
i
->buf, 
byãs
);

173 i‡(
îr
)

174  
îr
;

176 
ªt
 +
byãs
;

177 
buf
 +
byãs
;

178 
size
 -
byãs
;

179 
i
->
byãs
 -= bytes;

180 
	`memmove
(
i
->
buf
, i->bu‡+ 
byãs
, i->bytes);

182 i‡(
i
->
byãs
)

185 
w
 = 
	`bch_keybuf_√xt_ªsˇn
(
i
->
c
, &i->
keys
, &
MAX_KEY
, 
dump_¥ed
);

186 i‡(!
w
)

189 
	`bch_exã¡_to_ãxt
(
kbuf
, (kbuf), &
w
->
key
);

190 
i
->
byãs
 = 
	`¢¥ötf
(i->
buf
, 
PAGE_SIZE
, "%s\n", 
kbuf
);

191 
	`bch_keybuf_dñ
(&
i
->
keys
, 
w
);

194  
ªt
;

195 
	}
}

197 
	$bch_dump_›í
(
öode
 *öode, 
fûe
 *file)

199 
ˇche_£t
 *
c
 = 
öode
->
i_¥iv©e
;

200 
dump_ôî©‹
 *
i
;

202 
i
 = 
	`kzÆloc
((
dump_ôî©‹
), 
GFP_KERNEL
);

203 i‡(!
i
)

204  -
ENOMEM
;

206 
fûe
->
¥iv©e_d©a
 = 
i
;

207 
i
->
c
 = c;

208 
	`bch_keybuf_öô
(&
i
->
keys
);

209 
i
->
keys
.
œ°_sˇ¬ed
 = 
	`KEY
(0, 0, 0);

212 
	}
}

214 
	$bch_dump_ªÀa£
(
öode
 *öode, 
fûe
 *file)

216 
	`k‰ì
(
fûe
->
¥iv©e_d©a
);

218 
	}
}

220 c⁄° 
fûe_›î©i⁄s
 
	gˇche_£t_debug_›s
 = {

221 .
ow√r
 = 
THIS_MODULE
,

222 .
	g›í
 = 
bch_dump_›í
,

223 .
	gªad
 = 
bch_dump_ªad
,

224 .
	gªÀa£
 = 
bch_dump_ªÀa£


227 
	$bch_debug_öô_ˇche_£t
(
ˇche_£t
 *
c
)

229 i‡(!
	`IS_ERR_OR_NULL
(
debug
)) {

230 
«me
[50];

231 
	`¢¥ötf
(
«me
, 50, "bˇche-%pU", 
c
->
sb
.
£t_uuid
);

233 
c
->
debug
 = 
	`debugfs_¸óã_fûe
(
«me
, 0400, debug, c,

234 &
ˇche_£t_debug_›s
);

236 
	}
}

240 
	$bch_debug_exô
()

242 i‡(!
	`IS_ERR_OR_NULL
(
debug
))

243 
	`debugfs_ªmove_ªcursive
(
debug
);

244 
	}
}

246 
__öô
 
	$bch_debug_öô
(
kobje˘
 *
kobj
)

248 
ªt
 = 0;

250 
debug
 = 
	`debugfs_¸óã_dú
("bˇche", 
NULL
);

251  
ªt
;

252 
	}
}

	@bcache/debug.h

1 #i‚de‡
_BCACHE_DEBUG_H


2 
	#_BCACHE_DEBUG_H


	)

4 
	gbio
;

5 
	gˇched_dev
;

6 
	gˇche_£t
;

8 #ifde‡
CONFIG_BCACHE_DEBUG


10 
bch_båì_vîify
(
båì
 *);

11 
bch_d©a_vîify
(
ˇched_dev
 *, 
bio
 *);

13 
	#ex≥nsive_debug_checks
(
c
Ë((c)->
ex≥nsive_debug_checks
)

	)

14 
	#key_mîgög_dißbÀd
(
c
Ë((c)->
key_mîgög_dißbÀd
)

	)

15 
	#by∑ss_t‹tuª_ã°
(
d
Ë((d)->
by∑ss_t‹tuª_ã°
)

	)

19 
ölöe
 
	$bch_båì_vîify
(
båì
 *
b
Ë{
	}
}

20 
ölöe
 
	$bch_d©a_vîify
(
ˇched_dev
 *
dc
, 
bio
 *bioË{
	}
}

22 
	#ex≥nsive_debug_checks
(
c
Ë0

	)

23 
	#key_mîgög_dißbÀd
(
c
Ë0

	)

24 
	#by∑ss_t‹tuª_ã°
(
d
Ë0

	)

28 #ifde‡
CONFIG_DEBUG_FS


29 
bch_debug_öô_ˇche_£t
(
ˇche_£t
 *);

31 
ölöe
 
	$bch_debug_öô_ˇche_£t
(
ˇche_£t
 *
c
Ë{
	}
}

	@bcache/extents.c

23 
	~"bˇche.h
"

24 
	~"båì.h
"

25 
	~"debug.h
"

26 
	~"exã¡s.h
"

27 
	~"wrôeback.h
"

29 
	$s‹t_key_√xt
(
båì_ôî
 *
ôî
,

30 
båì_ôî_£t
 *
i
)

32 
i
->
k
 = 
	`bkey_√xt
(i->k);

34 i‡(
i
->
k
 =i->
íd
)

35 *
i
 = 
ôî
->
d©a
[--ôî->
u£d
];

36 
	}
}

38 
boﬁ
 
	$bch_key_s‹t_cmp
(
båì_ôî_£t
 
l
,

39 
båì_ôî_£t
 
r
)

41 
öt64_t
 
c
 = 
	`bkey_cmp
(
l
.
k
, 
r
.k);

43  
c
 ? c > 0 : 
l
.
k
 < 
r
.k;

44 
	}
}

46 
boﬁ
 
	$__±r_övÆid
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
)

48 
i
;

50 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

51 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
i
)) {

52 
ˇche
 *
ˇ
 = 
	`PTR_CACHE
(
c
, 
k
, 
i
);

53 
size_t
 
buckë
 = 
	`PTR_BUCKET_NR
(
c
, 
k
, 
i
);

54 
size_t
 
r
 = 
	`buckë_ªmaödî
(
c
, 
	`PTR_OFFSET
(
k
, 
i
));

56 i‡(
	`KEY_SIZE
(
k
Ë+ 
r
 > 
c
->
sb
.
buckë_size
 ||

57 
buckë
 < 
ˇ
->
sb
.
fú°_buckë
 ||

58 
buckë
 >
ˇ
->
sb
.
nbuckës
)

59  
åue
;

62  
Ál£
;

63 
	}
}

67 c⁄° *
	$bch_±r_°©us
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
)

69 
i
;

71 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

72 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
i
)) {

73 
ˇche
 *
ˇ
 = 
	`PTR_CACHE
(
c
, 
k
, 
i
);

74 
size_t
 
buckë
 = 
	`PTR_BUCKET_NR
(
c
, 
k
, 
i
);

75 
size_t
 
r
 = 
	`buckë_ªmaödî
(
c
, 
	`PTR_OFFSET
(
k
, 
i
));

77 i‡(
	`KEY_SIZE
(
k
Ë+ 
r
 > 
c
->
sb
.
buckë_size
)

79 i‡(
buckë
 < 
ˇ
->
sb
.
fú°_buckë
)

81 i‡(
buckë
 >
ˇ
->
sb
.
nbuckës
)

83 i‡(
	`±r_°Æe
(
c
, 
k
, 
i
))

87 i‡(!
	`bkey_cmp
(
k
, &
ZERO_KEY
))

89 i‡(!
	`KEY_PTRS
(
k
))

91 i‡(!
	`KEY_SIZE
(
k
))

94 
	}
}

96 
	$bch_exã¡_to_ãxt
(*
buf
, 
size_t
 
size
, c⁄° 
bkey
 *
k
)

98 
i
 = 0;

99 *
out
 = 
buf
, *
íd
 = bu‡+ 
size
;

101 
	#p
(...Ë(
out
 +
	`s˙¥ötf
(out, 
íd
 - out, 
__VA_ARGS__
))

	)

103 
	`p
("%Œu:%ŒuÜí %Œu -> [", 
	`KEY_INODE
(
k
), 
	`KEY_START
(k), 
	`KEY_SIZE
(k));

105 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++) {

106 i‡(
i
)

107 
	`p
(", ");

109 i‡(
	`PTR_DEV
(
k
, 
i
Ë=
PTR_CHECK_DEV
)

110 
	`p
("check dev");

112 
	`p
("%Œu:%Œu gí %Œu", 
	`PTR_DEV
(
k
, 
i
),

113 
	`PTR_OFFSET
(
k
, 
i
), 
	`PTR_GEN
(k, i));

116 
	`p
("]");

118 i‡(
	`KEY_DIRTY
(
k
))

119 
	`p
(" dirty");

120 i‡(
	`KEY_CSUM
(
k
))

121 
	`p
(" cs%Œu %Œx", 
	`KEY_CSUM
(
k
), k->
±r
[1]);

122 #unde‡
p


123 
	}
}

125 
	$bch_bkey_dump
(
båì_keys
 *
keys
, c⁄° 
bkey
 *
k
)

127 
båì
 *
b
 = 
	`c⁄èöî_of
(
keys
, btree, keys);

128 
j
;

129 
buf
[80];

131 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

132 
	`¥ötk
(" %s", 
buf
);

134 
j
 = 0; j < 
	`KEY_PTRS
(
k
); j++) {

135 
size_t
 
n
 = 
	`PTR_BUCKET_NR
(
b
->
c
, 
k
, 
j
);

136 
	`¥ötk
(" buckë %zu", 
n
);

138 i‡(
n
 >
b
->
c
->
sb
.
fú°_buckë
 &&Ç < b->c->sb.
nbuckës
)

139 
	`¥ötk
("Örio %i",

140 
	`PTR_BUCKET
(
b
->
c
, 
k
, 
j
)->
¥io
);

143 
	`¥ötk
(" %s\n", 
	`bch_±r_°©us
(
b
->
c
, 
k
));

144 
	}
}

148 
boﬁ
 
	$__bch_båì_±r_övÆid
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
)

150 
buf
[80];

152 i‡(!
	`KEY_PTRS
(
k
Ë|| !
	`KEY_SIZE
(kË|| 
	`KEY_DIRTY
(k))

153 
bad
;

155 i‡(
	`__±r_övÆid
(
c
, 
k
))

156 
bad
;

158  
Ál£
;

159 
bad
:

160 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

161 
	`ˇche_bug
(
c
, "•Ÿãd båìÖå %s: %s", 
buf
, 
	`bch_±r_°©us
(c, 
k
));

162  
åue
;

163 
	}
}

165 
boﬁ
 
	$bch_båì_±r_övÆid
(
båì_keys
 *
bk
, c⁄° 
bkey
 *
k
)

167 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

168  
	`__bch_båì_±r_övÆid
(
b
->
c
, 
k
);

169 
	}
}

171 
boﬁ
 
	$båì_±r_bad_ex≥nsive
(
båì
 *
b
, c⁄° 
bkey
 *
k
)

173 
i
;

174 
buf
[80];

175 
buckë
 *
g
;

177 i‡(
	`muãx_åylock
(&
b
->
c
->
buckë_lock
)) {

178 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

179 i‡(
	`±r_avaûabÀ
(
b
->
c
, 
k
, 
i
)) {

180 
g
 = 
	`PTR_BUCKET
(
b
->
c
, 
k
, 
i
);

182 i‡(
	`KEY_DIRTY
(
k
) ||

183 
g
->
¥io
 !
BTREE_PRIO
 ||

184 (
b
->
c
->
gc_m¨k_vÆid
 &&

185 
	`GC_MARK
(
g
Ë!
GC_MARK_METADATA
))

186 
îr
;

189 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

192  
Ál£
;

193 
îr
:

194 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

195 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

196 
	`båì_bug
(
b
,

198 
buf
, 
	`PTR_BUCKET_NR
(
b
->
c
, 
k
, 
i
), 
	`©omic_ªad
(&
g
->
pö
),

199 
g
->
¥io
, g->
gí
, g->
œ°_gc
, 
	`GC_MARK
(g));

200  
åue
;

201 
	}
}

203 
boﬁ
 
	$bch_båì_±r_bad
(
båì_keys
 *
bk
, c⁄° 
bkey
 *
k
)

205 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

206 
i
;

208 i‡(!
	`bkey_cmp
(
k
, &
ZERO_KEY
) ||

209 !
	`KEY_PTRS
(
k
) ||

210 
	`bch_±r_övÆid
(
bk
, 
k
))

211  
åue
;

213 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

214 i‡(!
	`±r_avaûabÀ
(
b
->
c
, 
k
, 
i
) ||

215 
	`±r_°Æe
(
b
->
c
, 
k
, 
i
))

216  
åue
;

218 i‡(
	`ex≥nsive_debug_checks
(
b
->
c
) &&

219 
	`båì_±r_bad_ex≥nsive
(
b
, 
k
))

220  
åue
;

222  
Ál£
;

223 
	}
}

225 
boﬁ
 
	$bch_båì_±r_ö£π_fixup
(
båì_keys
 *
bk
,

226 
bkey
 *
ö£π
,

227 
båì_ôî
 *
ôî
,

228 
bkey
 *
ª∂a˚_key
)

230 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

232 i‡(!
	`KEY_OFFSET
(
ö£π
))

233 
	`båì_cuºít_wrôe
(
b
)->
¥io_blocked
++;

235  
Ál£
;

236 
	}
}

238 c⁄° 
båì_keys_›s
 
	gbch_båì_keys_›s
 = {

239 .
s‹t_cmp
 = 
bch_key_s‹t_cmp
,

240 .
	gö£π_fixup
 = 
bch_båì_±r_ö£π_fixup
,

241 .
	gkey_övÆid
 = 
bch_båì_±r_övÆid
,

242 .
	gkey_bad
 = 
bch_båì_±r_bad
,

243 .
	gkey_to_ãxt
 = 
bch_exã¡_to_ãxt
,

244 .
	gkey_dump
 = 
bch_bkey_dump
,

256 
boﬁ
 
	$bch_exã¡_s‹t_cmp
(
båì_ôî_£t
 
l
,

257 
båì_ôî_£t
 
r
)

259 
öt64_t
 
c
 = 
	`bkey_cmp
(&
	`START_KEY
(
l
.
k
), &START_KEY(
r
.k));

261  
c
 ? c > 0 : 
l
.
k
 < 
r
.k;

262 
	}
}

264 
bkey
 *
	$bch_exã¡_s‹t_fixup
(
båì_ôî
 *
ôî
,

265 
bkey
 *
tmp
)

267 
ôî
->
u£d
 > 1) {

268 
båì_ôî_£t
 *
t›
 = 
ôî
->
d©a
, *
i
 =Åop + 1;

270 i‡(
ôî
->
u£d
 > 2 &&

271 
	`bch_exã¡_s‹t_cmp
(
i
[0], i[1]))

272 
i
++;

274 i‡(
	`bkey_cmp
(
t›
->
k
, &
	`START_KEY
(
i
->k)) <= 0)

277 i‡(!
	`KEY_SIZE
(
i
->
k
)) {

278 
	`s‹t_key_√xt
(
ôî
, 
i
);

279 
	`hóp_si·
(
ôî
, 
i
 - 
t›
, 
bch_exã¡_s‹t_cmp
);

283 i‡(
t›
->
k
 > 
i
->k) {

284 i‡(
	`bkey_cmp
(
t›
->
k
, 
i
->k) >= 0)

285 
	`s‹t_key_√xt
(
ôî
, 
i
);

287 
	`bch_cut_‰⁄t
(
t›
->
k
, 
i
->k);

289 
	`hóp_si·
(
ôî
, 
i
 - 
t›
, 
bch_exã¡_s‹t_cmp
);

292 
	`BUG_ON
(!
	`bkey_cmp
(&
	`START_KEY
(
t›
->
k
), &START_KEY(
i
->k)));

294 i‡(
	`bkey_cmp
(
i
->
k
, 
t›
->k) < 0) {

295 
	`bkey_c›y
(
tmp
, 
t›
->
k
);

297 
	`bch_cut_back
(&
	`START_KEY
(
i
->
k
), 
tmp
);

298 
	`bch_cut_‰⁄t
(
i
->
k
, 
t›
->k);

299 
	`hóp_si·
(
ôî
, 0, 
bch_exã¡_s‹t_cmp
);

301  
tmp
;

303 
	`bch_cut_back
(&
	`START_KEY
(
i
->
k
), 
t›
->k);

308  
NULL
;

309 
	}
}

311 
	$bch_subåa˘_dúty
(
bkey
 *
k
,

312 
ˇche_£t
 *
c
,

313 
uöt64_t
 
off£t
,

314 
£˘‹s
)

316 i‡(
	`KEY_DIRTY
(
k
))

317 
	`bˇche_dev_£˘‹s_dúty_add
(
c
, 
	`KEY_INODE
(
k
),

318 
off£t
, -
£˘‹s
);

319 
	}
}

321 
boﬁ
 
	$bch_exã¡_ö£π_fixup
(
båì_keys
 *
b
,

322 
bkey
 *
ö£π
,

323 
båì_ôî
 *
ôî
,

324 
bkey
 *
ª∂a˚_key
)

326 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
b
, 
båì
, 
keys
)->c;

328 
uöt64_t
 
ﬁd_off£t
;

329 
ﬁd_size
, 
£˘‹s_found
 = 0;

331 
	`BUG_ON
(!
	`KEY_OFFSET
(
ö£π
));

332 
	`BUG_ON
(!
	`KEY_SIZE
(
ö£π
));

335 
bkey
 *
k
 = 
	`bch_båì_ôî_√xt
(
ôî
);

336 i‡(!
k
)

339 i‡(
	`bkey_cmp
(&
	`START_KEY
(
k
), 
ö£π
) >= 0) {

340 i‡(
	`KEY_SIZE
(
k
))

346 i‡(
	`bkey_cmp
(
k
, &
	`START_KEY
(
ö£π
)) <= 0)

349 
ﬁd_off£t
 = 
	`KEY_START
(
k
);

350 
ﬁd_size
 = 
	`KEY_SIZE
(
k
);

360 i‡(
ª∂a˚_key
 && 
	`KEY_SIZE
(
k
)) {

365 
i
;

366 
uöt64_t
 
off£t
 = 
	`KEY_START
(
k
) -

367 
	`KEY_START
(
ª∂a˚_key
);

370 i‡(
	`KEY_START
(
k
Ë< KEY_START(
ª∂a˚_key
) ||

371 
	`KEY_OFFSET
(
k
Ë> KEY_OFFSET(
ª∂a˚_key
))

372 
check_Áûed
;

375 i‡(
	`KEY_START
(
k
Ë> KEY_START(
ö£π
Ë+ 
£˘‹s_found
)

376 
check_Áûed
;

378 i‡(!
	`bch_bkey_equÆ_hódî
(
k
, 
ª∂a˚_key
))

379 
check_Áûed
;

382 
off£t
 <<= 8;

384 
	`BUG_ON
(!
	`KEY_PTRS
(
ª∂a˚_key
));

386 
i
 = 0; i < 
	`KEY_PTRS
(
ª∂a˚_key
); i++)

387 i‡(
k
->
±r
[
i
] !
ª∂a˚_key
->±r[i] + 
off£t
)

388 
check_Áûed
;

390 
£˘‹s_found
 = 
	`KEY_OFFSET
(
k
Ë- 
	`KEY_START
(
ö£π
);

393 i‡(
	`bkey_cmp
(
ö£π
, 
k
) < 0 &&

394 
	`bkey_cmp
(&
	`START_KEY
(
ö£π
), &START_KEY(
k
)) > 0) {

402 
bkey
 *
t›
;

404 
	`bch_subåa˘_dúty
(
k
, 
c
, 
	`KEY_START
(
ö£π
),

405 
	`KEY_SIZE
(
ö£π
));

407 i‡(
	`bkey_wrôãn
(
b
, 
k
)) {

420 
t›
 = 
	`bch_b£t_£¨ch
(
b
, 
	`b£t_åì_œ°
(b),

421 
ö£π
);

422 
	`bch_b£t_ö£π
(
b
, 
t›
, 
k
);

424 
	`BKEY_PADDED
(
key
Ë
ãmp
;

425 
	`bkey_c›y
(&
ãmp
.
key
, 
k
);

426 
	`bch_b£t_ö£π
(
b
, 
k
, &
ãmp
.
key
);

427 
t›
 = 
	`bkey_√xt
(
k
);

430 
	`bch_cut_‰⁄t
(
ö£π
, 
t›
);

431 
	`bch_cut_back
(&
	`START_KEY
(
ö£π
), 
k
);

432 
	`bch_b£t_fix_övÆid©ed_key
(
b
, 
k
);

433 
out
;

436 i‡(
	`bkey_cmp
(
ö£π
, 
k
) < 0) {

437 
	`bch_cut_‰⁄t
(
ö£π
, 
k
);

439 i‡(
	`bkey_cmp
(&
	`START_KEY
(
ö£π
), &START_KEY(
k
)) > 0)

440 
ﬁd_off£t
 = 
	`KEY_START
(
ö£π
);

442 i‡(
	`bkey_wrôãn
(
b
, 
k
) &&

443 
	`bkey_cmp
(&
	`START_KEY
(
ö£π
), &START_KEY(
k
)) <= 0) {

448 
	`bch_cut_‰⁄t
(
k
, k);

450 
	`__bch_cut_back
(&
	`START_KEY
(
ö£π
), 
k
);

451 
	`bch_b£t_fix_övÆid©ed_key
(
b
, 
k
);

455 
	`bch_subåa˘_dúty
(
k
, 
c
, 
ﬁd_off£t
, 
ﬁd_size
 - 
	`KEY_SIZE
(k));

458 
check_Áûed
:

459 i‡(
ª∂a˚_key
) {

460 i‡(!
£˘‹s_found
) {

461  
åue
;

462 } i‡(
£˘‹s_found
 < 
	`KEY_SIZE
(
ö£π
)) {

463 
	`SET_KEY_OFFSET
(
ö£π
, 
	`KEY_OFFSET
(insert) -

464 (
	`KEY_SIZE
(
ö£π
Ë- 
£˘‹s_found
));

465 
	`SET_KEY_SIZE
(
ö£π
, 
£˘‹s_found
);

468 
out
:

469 i‡(
	`KEY_DIRTY
(
ö£π
))

470 
	`bˇche_dev_£˘‹s_dúty_add
(
c
, 
	`KEY_INODE
(
ö£π
),

471 
	`KEY_START
(
ö£π
),

472 
	`KEY_SIZE
(
ö£π
));

474  
Ál£
;

475 
	}
}

477 
boﬁ
 
	$__bch_exã¡_övÆid
(
ˇche_£t
 *
c
, c⁄° 
bkey
 *
k
)

479 
buf
[80];

481 i‡(!
	`KEY_SIZE
(
k
))

482  
åue
;

484 i‡(
	`KEY_SIZE
(
k
Ë> 
	`KEY_OFFSET
(k))

485 
bad
;

487 i‡(
	`__±r_övÆid
(
c
, 
k
))

488 
bad
;

490  
Ál£
;

491 
bad
:

492 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

493 
	`ˇche_bug
(
c
, "•ŸãdÉxã¡ %s: %s", 
buf
, 
	`bch_±r_°©us
(c, 
k
));

494  
åue
;

495 
	}
}

497 
boﬁ
 
	$bch_exã¡_övÆid
(
båì_keys
 *
bk
, c⁄° 
bkey
 *
k
)

499 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

500  
	`__bch_exã¡_övÆid
(
b
->
c
, 
k
);

501 
	}
}

503 
boﬁ
 
	$bch_exã¡_bad_ex≥nsive
(
båì
 *
b
, c⁄° 
bkey
 *
k
,

504 
±r
)

506 
buckë
 *
g
 = 
	`PTR_BUCKET
(
b
->
c
, 
k
, 
±r
);

507 
buf
[80];

509 i‡(
	`muãx_åylock
(&
b
->
c
->
buckë_lock
)) {

510 i‡(
b
->
c
->
gc_m¨k_vÆid
 &&

511 (!
	`GC_MARK
(
g
) ||

512 
	`GC_MARK
(
g
Ë=
GC_MARK_METADATA
 ||

513 (
	`GC_MARK
(
g
Ë!
GC_MARK_DIRTY
 && 
	`KEY_DIRTY
(
k
))))

514 
îr
;

516 i‡(
g
->
¥io
 =
BTREE_PRIO
)

517 
îr
;

519 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

522  
Ál£
;

523 
îr
:

524 
	`muãx_u∆ock
(&
b
->
c
->
buckë_lock
);

525 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

526 
	`båì_bug
(
b
,

528 
buf
, 
	`PTR_BUCKET_NR
(
b
->
c
, 
k
, 
±r
), 
	`©omic_ªad
(&
g
->
pö
),

529 
g
->
¥io
, g->
gí
, g->
œ°_gc
, 
	`GC_MARK
(g));

530  
åue
;

531 
	}
}

533 
boﬁ
 
	$bch_exã¡_bad
(
båì_keys
 *
bk
, c⁄° 
bkey
 *
k
)

535 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

536 
buckë
 *
g
;

537 
i
, 
°Æe
;

539 i‡(!
	`KEY_PTRS
(
k
) ||

540 
	`bch_exã¡_övÆid
(
bk
, 
k
))

541  
åue
;

543 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

544 i‡(!
	`±r_avaûabÀ
(
b
->
c
, 
k
, 
i
))

545  
åue
;

547 i‡(!
	`ex≥nsive_debug_checks
(
b
->
c
Ë&& 
	`KEY_DIRTY
(
k
))

548  
Ál£
;

550 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++) {

551 
g
 = 
	`PTR_BUCKET
(
b
->
c
, 
k
, 
i
);

552 
°Æe
 = 
	`±r_°Æe
(
b
->
c
, 
k
, 
i
);

554 
	`båì_bug_⁄
(
°Æe
 > 96, 
b
,

556 
°Æe
, 
b
->
c
->
√ed_gc
);

558 
	`båì_bug_⁄
(
°Æe
 && 
	`KEY_DIRTY
(
k
Ë&& 
	`KEY_SIZE
(k),

559 
b
, "stale dirtyÖointer");

561 i‡(
°Æe
)

562  
åue
;

564 i‡(
	`ex≥nsive_debug_checks
(
b
->
c
) &&

565 
	`bch_exã¡_bad_ex≥nsive
(
b
, 
k
, 
i
))

566  
åue
;

569  
Ál£
;

570 
	}
}

572 
uöt64_t
 
	$mîge_chksums
(
bkey
 *
l
, bkey *
r
)

574  (
l
->
±r
[
	`KEY_PTRS
÷)] + 
r
->ptr[KEY_PTRS(r)]) &

575 ~((
uöt64_t
)1 << 63);

576 
	}
}

578 
boﬁ
 
	$bch_exã¡_mîge
(
båì_keys
 *
bk
, 
bkey
 *
l
, bkey *
r
)

580 
båì
 *
b
 = 
	`c⁄èöî_of
(
bk
, båì, 
keys
);

581 
i
;

583 i‡(
	`key_mîgög_dißbÀd
(
b
->
c
))

584  
Ál£
;

586 
i
 = 0; i < 
	`KEY_PTRS
(
l
); i++)

587 i‡(
l
->
±r
[
i
] + 
	`PTR
(0, 
	`KEY_SIZE
÷), 0Ë!
r
->ptr[i] ||

588 
	`PTR_BUCKET_NR
(
b
->
c
, 
l
, 
i
Ë!PTR_BUCKET_NR(b->c, 
r
, i))

589  
Ál£
;

594 i‡(
	`KEY_SIZE
(
l
Ë+ KEY_SIZE(
r
Ë> 
USHRT_MAX
) {

595 
	`SET_KEY_OFFSET
(
l
, 
	`KEY_OFFSET
÷Ë+ 
USHRT_MAX
 - 
	`KEY_SIZE
(l));

596 
	`SET_KEY_SIZE
(
l
, 
USHRT_MAX
);

598 
	`bch_cut_‰⁄t
(
l
, 
r
);

599  
Ál£
;

602 i‡(
	`KEY_CSUM
(
l
)) {

603 i‡(
	`KEY_CSUM
(
r
))

604 
l
->
±r
[
	`KEY_PTRS
÷)] = 
	`mîge_chksums
÷, 
r
);

606 
	`SET_KEY_CSUM
(
l
, 0);

609 
	`SET_KEY_OFFSET
(
l
, 
	`KEY_OFFSET
÷Ë+ 
	`KEY_SIZE
(
r
));

610 
	`SET_KEY_SIZE
(
l
, 
	`KEY_SIZE
÷Ë+ KEY_SIZE(
r
));

612  
åue
;

613 
	}
}

615 c⁄° 
båì_keys_›s
 
	gbch_exã¡_keys_›s
 = {

616 .
s‹t_cmp
 = 
bch_exã¡_s‹t_cmp
,

617 .
	gs‹t_fixup
 = 
bch_exã¡_s‹t_fixup
,

618 .
	gö£π_fixup
 = 
bch_exã¡_ö£π_fixup
,

619 .
	gkey_övÆid
 = 
bch_exã¡_övÆid
,

620 .
	gkey_bad
 = 
bch_exã¡_bad
,

621 .
	gkey_mîge
 = 
bch_exã¡_mîge
,

622 .
	gkey_to_ãxt
 = 
bch_exã¡_to_ãxt
,

623 .
	gkey_dump
 = 
bch_bkey_dump
,

624 .
	gis_exã¡s
 = 
åue
,

	@bcache/extents.h

1 #i‚de‡
_BCACHE_EXTENTS_H


2 
	#_BCACHE_EXTENTS_H


	)

4 c⁄° 
båì_keys_›s
 
bch_båì_keys_›s
;

5 c⁄° 
båì_keys_›s
 
bch_exã¡_keys_›s
;

7 
	gbkey
;

8 
	gˇche_£t
;

10 
bch_exã¡_to_ãxt
(*, 
size_t
, c⁄° 
bkey
 *);

11 
boﬁ
 
__bch_båì_±r_övÆid
(
ˇche_£t
 *, c⁄° 
bkey
 *);

12 
boﬁ
 
__bch_exã¡_övÆid
(
ˇche_£t
 *, c⁄° 
bkey
 *);

	@bcache/io.c

8 
	~"bˇche.h
"

9 
	~"b£t.h
"

10 
	~"debug.h
"

12 
	~<löux/blkdev.h
>

14 
	$bch_bio_max_£˘‹s
(
bio
 *bio)

16 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
bio
->
bi_bdev
);

17 
bio_vec
 
bv
;

18 
bvec_ôî
 
ôî
;

19 
ªt
 = 0, 
£g
 = 0;

21 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

22  
	`mö
(
	`bio_£˘‹s
(
bio
), 
q
->
limôs
.
max_disˇrd_£˘‹s
);

24 
	`bio_f‹_óch_£gmít
(
bv
, 
bio
, 
ôî
) {

25 
bvec_mîge_d©a
 
bvm
 = {

26 .
bi_bdev
 = 
bio
->bi_bdev,

27 .
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector,

28 .
bi_size
 = 
ªt
 << 9,

29 .
bi_rw
 = 
bio
->bi_rw,

32 i‡(
£g
 =
	`mö_t
(, 
BIO_MAX_PAGES
,

33 
	`queue_max_£gmíts
(
q
)))

36 i‡(
q
->
mîge_bvec_‚
 &&

37 
q
->
	`mîge_bvec_‚
(q, &
bvm
, &
bv
Ë< (Ëbv.
bv_Àn
)

40 
£g
++;

41 
ªt
 +
bv
.
bv_Àn
 >> 9;

44 
ªt
 = 
	`mö
‘ë, 
	`queue_max_£˘‹s
(
q
));

46 
	`WARN_ON
(!
ªt
);

47 
ªt
 = 
	`max_t
(,Ñë, 
	`bio_iovec
(
bio
).
bv_Àn
 >> 9);

49  
ªt
;

50 
	}
}

52 
	$bch_bio_submô_•lô_d⁄e
(
˛osuª
 *
˛
)

54 
bio_•lô_hook
 *
s
 = 
	`c⁄èöî_of
(
˛
, bio_split_hook, cl);

56 
s
->
bio
->
bi_íd_io
 = s->bi_end_io;

57 
s
->
bio
->
bi_¥iv©e
 = s->bi_private;

58 
	`bio_ídio_nodec
(
s
->
bio
, 0);

60 
	`˛osuª_debug_de°roy
(&
s
->
˛
);

61 
	`mempoﬁ_‰ì
(
s
, s->
p
->
bio_•lô_hook
);

62 
	}
}

64 
	$bch_bio_submô_•lô_ídio
(
bio
 *bio, 
îr‹
)

66 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

67 
bio_•lô_hook
 *
s
 = 
	`c⁄èöî_of
(
˛
, bio_split_hook, cl);

69 i‡(
îr‹
)

70 
	`˛ór_bô
(
BIO_UPTODATE
, &
s
->
bio
->
bi_Êags
);

72 
	`bio_put
(
bio
);

73 
	`˛osuª_put
(
˛
);

74 
	}
}

76 
	$bch_gíîic_make_ªque°
(
bio
 *bio, 
bio_•lô_poﬁ
 *
p
)

78 
bio_•lô_hook
 *
s
;

79 
bio
 *
n
;

81 i‡(!
	`bio_has_d©a
(
bio
Ë&& !(bio->
bi_rw
 & 
REQ_DISCARD
))

82 
submô
;

84 i‡(
	`bio_£˘‹s
(
bio
Ë<
	`bch_bio_max_£˘‹s
(bio))

85 
submô
;

87 
s
 = 
	`mempoﬁ_Æloc
(
p
->
bio_•lô_hook
, 
GFP_NOIO
);

88 
	`˛osuª_öô
(&
s
->
˛
, 
NULL
);

90 
s
->
bio
 = bio;

91 
s
->
p
 =Ö;

92 
s
->
bi_íd_io
 = 
bio
->bi_end_io;

93 
s
->
bi_¥iv©e
 = 
bio
->bi_private;

94 
	`bio_gë
(
bio
);

97 
n
 = 
	`bio_√xt_•lô
(
bio
, 
	`bch_bio_max_£˘‹s
(bio),

98 
GFP_NOIO
, 
s
->
p
->
bio_•lô
);

100 
n
->
bi_íd_io
 = 
bch_bio_submô_•lô_ídio
;

101 
n
->
bi_¥iv©e
 = &
s
->
˛
;

103 
	`˛osuª_gë
(&
s
->
˛
);

104 
	`gíîic_make_ªque°
(
n
);

105 } 
n
 !
bio
);

107 
	`c⁄töue_©
(&
s
->
˛
, 
bch_bio_submô_•lô_d⁄e
, 
NULL
);

108 
submô
:

109 
	`gíîic_make_ªque°
(
bio
);

110 
	}
}

114 
	$bch_bbio_‰ì
(
bio
 *bio, 
ˇche_£t
 *
c
)

116 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

117 
	`mempoﬁ_‰ì
(
b
, 
c
->
bio_mëa
);

118 
	}
}

120 
bio
 *
	$bch_bbio_Æloc
(
ˇche_£t
 *
c
)

122 
bbio
 *
b
 = 
	`mempoﬁ_Æloc
(
c
->
bio_mëa
, 
GFP_NOIO
);

123 
bio
 *biÿ&
b
->bio;

125 
	`bio_öô
(
bio
);

126 
bio
->
bi_Êags
 |
BIO_POOL_NONE
 << 
BIO_POOL_OFFSET
;

127 
bio
->
bi_max_vecs
 = 
	`buckë_∑ges
(
c
);

128 
bio
->
bi_io_vec
 = bio->
bi_ölöe_vecs
;

130  
bio
;

131 
	}
}

133 
	$__bch_submô_bbio
(
bio
 *bio, 
ˇche_£t
 *
c
)

135 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

137 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`PTR_OFFSET
(&
b
->
key
, 0);

138 
bio
->
bi_bdev
 = 
	`PTR_CACHE
(
c
, &
b
->
key
, 0)->
bdev
;

140 
b
->
submô_time_us
 = 
	`loˇl_˛ock_us
();

141 
	`˛osuª_bio_submô
(
bio
, bio->
bi_¥iv©e
, 
	`PTR_CACHE
(
c
, &
b
->
key
, 0));

142 
	}
}

144 
	$bch_submô_bbio
(
bio
 *bio, 
ˇche_£t
 *
c
,

145 
bkey
 *
k
, 
±r
)

147 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

148 
	`bch_bkey_c›y_sögÀ_±r
(&
b
->
key
, 
k
, 
±r
);

149 
	`__bch_submô_bbio
(
bio
, 
c
);

150 
	}
}

154 
	$bch_cou¡_io_îr‹s
(
ˇche
 *
ˇ
, 
îr‹
, c⁄° *
m
)

161 i‡(
ˇ
->
£t
->
îr‹_deˇy
) {

162 
cou¡
 = 
	`©omic_öc_ªtu∫
(&
ˇ
->
io_cou¡
);

164 
cou¡
 > 
ˇ
->
£t
->
îr‹_deˇy
) {

165 
îr‹s
;

166 
ﬁd
 = 
cou¡
;

167 
√w
 = 
cou¡
 - 
ˇ
->
£t
->
îr‹_deˇy
;

174 
cou¡
 = 
	`©omic_cmpxchg
(&
ˇ
->
io_cou¡
, 
ﬁd
, 
√w
);

176 i‡(
cou¡
 =
ﬁd
) {

177 
cou¡
 = 
√w
;

179 
îr‹s
 = 
	`©omic_ªad
(&
ˇ
->
io_îr‹s
);

181 
ﬁd
 = 
îr‹s
;

182 
√w
 = ((
uöt64_t
Ë
îr‹s
 * 127) / 128;

183 
îr‹s
 = 
	`©omic_cmpxchg
(&
ˇ
->
io_îr‹s
,

184 
ﬁd
, 
√w
);

185 } 
ﬁd
 !
îr‹s
);

190 i‡(
îr‹
) {

191 
buf
[
BDEVNAME_SIZE
];

192 
îr‹s
 = 
	`©omic_add_ªtu∫
(1 << 
IO_ERROR_SHIFT
,

193 &
ˇ
->
io_îr‹s
);

194 
îr‹s
 >>
IO_ERROR_SHIFT
;

196 i‡(
îr‹s
 < 
ˇ
->
£t
->
îr‹_limô
)

197 
	`¥_îr
("%s: IOÉrror on %s,Ñecovering",

198 
	`bdev«me
(
ˇ
->
bdev
, 
buf
), 
m
);

200 
	`bch_ˇche_£t_îr‹
(
ˇ
->
£t
,

202 
	`bdev«me
(
ˇ
->
bdev
, 
buf
), 
m
);

204 
	}
}

206 
	$bch_bbio_cou¡_io_îr‹s
(
ˇche_£t
 *
c
, 
bio
 *bio,

207 
îr‹
, c⁄° *
m
)

209 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

210 
ˇche
 *
ˇ
 = 
	`PTR_CACHE
(
c
, &
b
->
key
, 0);

212 
thªshﬁd
 = 
bio
->
bi_rw
 & 
REQ_WRITE


213 ? 
c
->
c⁄ge°ed_wrôe_thªshﬁd_us


214 : 
c
->
c⁄ge°ed_ªad_thªshﬁd_us
;

216 i‡(
thªshﬁd
) {

217 
t
 = 
	`loˇl_˛ock_us
();

219 
us
 = 
t
 - 
b
->
submô_time_us
;

220 
c⁄ge°ed
 = 
	`©omic_ªad
(&
c
->congested);

222 i‡(
us
 > (Ë
thªshﬁd
) {

223 
ms
 = 
us
 / 1024;

224 
c
->
c⁄ge°ed_œ°_us
 = 
t
;

226 
ms
 = 
	`mö
(ms, 
CONGESTED_MAX
 + 
c⁄ge°ed
);

227 
	`©omic_sub
(
ms
, &
c
->
c⁄ge°ed
);

228 } i‡(
c⁄ge°ed
 < 0)

229 
	`©omic_öc
(&
c
->
c⁄ge°ed
);

232 
	`bch_cou¡_io_îr‹s
(
ˇ
, 
îr‹
, 
m
);

233 
	}
}

235 
	$bch_bbio_ídio
(
ˇche_£t
 *
c
, 
bio
 *bio,

236 
îr‹
, c⁄° *
m
)

238 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

240 
	`bch_bbio_cou¡_io_îr‹s
(
c
, 
bio
, 
îr‹
, 
m
);

241 
	`bio_put
(
bio
);

242 
	`˛osuª_put
(
˛
);

243 
	}
}

	@bcache/journal.c

7 
	~"bˇche.h
"

8 
	~"båì.h
"

9 
	~"debug.h
"

10 
	~"exã¡s.h
"

12 
	~<åa˚/evíts/bˇche.h
>

27 
	$jou∫Æ_ªad_ídio
(
bio
 *bio, 
îr‹
)

29 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

30 
	`˛osuª_put
(
˛
);

31 
	}
}

33 
	$jou∫Æ_ªad_buckë
(
ˇche
 *
ˇ
, 
li°_hód
 *
li°
,

34 
buckë_ödex
)

36 
jou∫Æ_devi˚
 *
ja
 = &
ˇ
->
jou∫Æ
;

37 
bio
 *biÿ&
ja
->bio;

39 
jou∫Æ_ª∂ay
 *
i
;

40 
j£t
 *
j
, *
d©a
 = 
ˇ
->
£t
->
jou∫Æ
.
w
[0].data;

41 
˛osuª
 
˛
;

42 
Àn
, 
À·
, 
off£t
 = 0;

43 
ªt
 = 0;

44 
£˘‹_t
 
buckë
 = 
	`buckë_to_£˘‹
(
ˇ
->
£t
, ca->
sb
.
d
[
buckë_ödex
]);

46 
	`˛osuª_öô_°ack
(&
˛
);

48 
	`¥_debug
("ªadög %u", 
buckë_ödex
);

50 
off£t
 < 
ˇ
->
sb
.
buckë_size
) {

51 
ªªad
: 
À·
 = 
ˇ
->
sb
.
buckë_size
 - 
off£t
;

52 
Àn
 = 
	`mö_t
(, 
À·
, 
PAGE_SECTORS
 << 
JSET_BITS
);

54 
	`bio_ª£t
(
bio
);

55 
bio
->
bi_ôî
.
bi_£˘‹
 = 
buckë
 + 
off£t
;

56 
bio
->
bi_bdev
 = 
ˇ
->
bdev
;

57 
bio
->
bi_rw
 = 
READ
;

58 
bio
->
bi_ôî
.
bi_size
 = 
Àn
 << 9;

60 
bio
->
bi_íd_io
 = 
jou∫Æ_ªad_ídio
;

61 
bio
->
bi_¥iv©e
 = &
˛
;

62 
	`bch_bio_m≠
(
bio
, 
d©a
);

64 
	`˛osuª_bio_submô
(
bio
, &
˛
, 
ˇ
);

65 
	`˛osuª_sync
(&
˛
);

73 
j
 = 
d©a
;

74 
Àn
) {

75 
li°_hód
 *
whîe
;

76 
size_t
 
blocks
, 
byãs
 = 
	`£t_byãs
(
j
);

78 i‡(
j
->
magic
 !
	`j£t_magic
(&
ˇ
->
sb
)) {

79 
	`¥_debug
("%u: bad magic", 
buckë_ödex
);

80  
ªt
;

83 i‡(
byãs
 > 
À·
 << 9 ||

84 
byãs
 > 
PAGE_SIZE
 << 
JSET_BITS
) {

85 
	`¥_öfo
("%u:Åoo big, %zu bytes, offset %u",

86 
buckë_ödex
, 
byãs
, 
off£t
);

87  
ªt
;

90 i‡(
byãs
 > 
Àn
 << 9)

91 
ªªad
;

93 i‡(
j
->
csum
 !
	`csum_£t
(j)) {

94 
	`¥_öfo
("%u: bad csum, %zu bytes, offset %u",

95 
buckë_ödex
, 
byãs
, 
off£t
);

96  
ªt
;

99 
blocks
 = 
	`£t_blocks
(
j
, 
	`block_byãs
(
ˇ
->
£t
));

101 !
	`li°_em±y
(
li°
)) {

102 
i
 = 
	`li°_fú°_íåy
(
li°
,

103 
jou∫Æ_ª∂ay
, 
li°
);

104 i‡(
i
->
j
.
£q
 >j->
œ°_£q
)

106 
	`li°_dñ
(&
i
->
li°
);

107 
	`k‰ì
(
i
);

110 
	`li°_f‹_óch_íåy_ªvî£
(
i
, 
li°
,Üist) {

111 i‡(
j
->
£q
 =
i
->j.seq)

112 
√xt_£t
;

114 i‡(
j
->
£q
 < 
i
->j.
œ°_£q
)

115 
√xt_£t
;

117 i‡(
j
->
£q
 > 
i
->j.seq) {

118 
whîe
 = &
i
->
li°
;

119 
add
;

123 
whîe
 = 
li°
;

124 
add
:

125 
i
 = 
	`kmÆloc
(
	`off£tof
(
jou∫Æ_ª∂ay
, 
j
) +

126 
byãs
, 
GFP_KERNEL
);

127 i‡(!
i
)

128  -
ENOMEM
;

129 
	`mem˝y
(&
i
->
j
, j, 
byãs
);

130 
	`li°_add
(&
i
->
li°
, 
whîe
);

131 
ªt
 = 1;

133 
ja
->
£q
[
buckë_ödex
] = 
j
->seq;

134 
√xt_£t
:

135 
off£t
 +
blocks
 * 
ˇ
->
sb
.
block_size
;

136 
Àn
 -
blocks
 * 
ˇ
->
sb
.
block_size
;

137 
j
 = ((*ËjË+ 
blocks
 * 
	`block_byãs
(
ˇ
);

141  
ªt
;

142 
	}
}

144 
	$bch_jou∫Æ_ªad
(
ˇche_£t
 *
c
, 
li°_hód
 *
li°
)

146 
	#ªad_buckë
(
b
) \

148 
ªt
 = 
	`jou∫Æ_ªad_buckë
(
ˇ
, 
li°
, 
b
); \

149 
	`__£t_bô
(
b
, 
bôm≠
); \

150 i‡(
ªt
 < 0) \

151  
ªt
; \

152 
ªt
; \

153 })

	)

155 
ˇche
 *
ˇ
;

156 
ôî
;

158 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
ôî
) {

159 
jou∫Æ_devi˚
 *
ja
 = &
ˇ
->
jou∫Æ
;

160 
bôm≠
[
SB_JOURNAL_BUCKETS
 / 
BITS_PER_LONG
];

161 
i
, 
l
, 
r
, 
m
;

162 
uöt64_t
 
£q
;

164 
	`bôm≠_zîo
(
bôm≠
, 
SB_JOURNAL_BUCKETS
);

165 
	`¥_debug
("%u jou∫Æ buckës", 
ˇ
->
sb
.
njou∫Æ_buckës
);

171 
i
 = 0; i < 
ˇ
->
sb
.
njou∫Æ_buckës
; i++) {

172 
l
 = (
i
 * 2654435769UË% 
ˇ
->
sb
.
njou∫Æ_buckës
;

174 i‡(
	`ã°_bô
(
l
, 
bôm≠
))

177 i‡(
	`ªad_buckë
(
l
))

178 
b£¨ch
;

185 
	`¥_debug
("falling backÅoÜinear search");

187 
l
 = 
	`föd_fú°_zîo_bô
(
bôm≠
, 
ˇ
->
sb
.
njou∫Æ_buckës
);

188 
l
 < 
ˇ
->
sb
.
njou∫Æ_buckës
;

189 
l
 = 
	`föd_√xt_zîo_bô
(
bôm≠
, 
ˇ
->
sb
.
njou∫Æ_buckës
,Ü + 1))

190 i‡(
	`ªad_buckë
(
l
))

191 
b£¨ch
;

194 i‡(
l
 =
ˇ
->
sb
.
njou∫Æ_buckës
)

196 
b£¨ch
:

197 
	`BUG_ON
(
	`li°_em±y
(
li°
));

200 
m
 = 
l
;

201 
r
 = 
	`föd_√xt_bô
(
bôm≠
, 
ˇ
->
sb
.
njou∫Æ_buckës
, 
l
 + 1);

202 
	`¥_debug
("°¨tög bö¨y sórch,Ü %uÑ %u", 
l
, 
r
);

204 
l
 + 1 < 
r
) {

205 
£q
 = 
	`li°_íåy
(
li°
->
¥ev
, 
jou∫Æ_ª∂ay
,

206 
li°
)->
j
.
£q
;

208 
m
 = (
l
 + 
r
) >> 1;

209 
	`ªad_buckë
(
m
);

211 i‡(
£q
 !
	`li°_íåy
(
li°
->
¥ev
, 
jou∫Æ_ª∂ay
,

212 
li°
)->
j
.
£q
)

213 
l
 = 
m
;

215 
r
 = 
m
;

222 
	`¥_debug
("finishing up: m %uÇjournal_buckets %u",

223 
m
, 
ˇ
->
sb
.
njou∫Æ_buckës
);

224 
l
 = 
m
;

227 i‡(!
l
--)

228 
l
 = 
ˇ
->
sb
.
njou∫Æ_buckës
 - 1;

230 i‡(
l
 =
m
)

233 i‡(
	`ã°_bô
(
l
, 
bôm≠
))

236 i‡(!
	`ªad_buckë
(
l
))

240 
£q
 = 0;

242 
i
 = 0; i < 
ˇ
->
sb
.
njou∫Æ_buckës
; i++)

243 i‡(
ja
->
£q
[
i
] > seq) {

244 
£q
 = 
ja
->£q[
i
];

250 
ja
->
cur_idx
 = 
i
;

251 
ja
->
œ°_idx
 = ja->
disˇrd_idx
 = (
i
 + 1) %

252 
ˇ
->
sb
.
njou∫Æ_buckës
;

257 i‡(!
	`li°_em±y
(
li°
))

258 
c
->
jou∫Æ
.
£q
 = 
	`li°_íåy
(
li°
->
¥ev
,

259 
jou∫Æ_ª∂ay
,

260 
li°
)->
j
.
£q
;

263 #unde‡
ªad_buckë


264 
	}
}

266 
	$bch_jou∫Æ_m¨k
(
ˇche_£t
 *
c
, 
li°_hód
 *
li°
)

268 
©omic_t
 
p
 = { 0 };

269 
bkey
 *
k
;

270 
jou∫Æ_ª∂ay
 *
i
;

271 
jou∫Æ
 *
j
 = &
c
->journal;

272 
uöt64_t
 
œ°
 = 
j
->
£q
;

281 
	`li°_f‹_óch_íåy_ªvî£
(
i
, 
li°
,Üist) {

282 
	`BUG_ON
(
œ°
 < 
i
->
j
.
£q
);

283 
i
->
pö
 = 
NULL
;

285 
œ°
-- !
i
->
j
.
£q
)

286 i‡(
	`fifo_‰ì
(&
j
->
pö
) > 1) {

287 
	`fifo_push_‰⁄t
(&
j
->
pö
, 
p
);

288 
	`©omic_£t
(&
	`fifo_‰⁄t
(&
j
->
pö
), 0);

291 i‡(
	`fifo_‰ì
(&
j
->
pö
) > 1) {

292 
	`fifo_push_‰⁄t
(&
j
->
pö
, 
p
);

293 
i
->
pö
 = &
	`fifo_‰⁄t
(&
j
->pin);

294 
	`©omic_£t
(
i
->
pö
, 1);

297 
k
 = 
i
->
j
.
°¨t
;

298 
k
 < 
	`b£t_bkey_œ°
(&
i
->
j
);

299 
k
 = 
	`bkey_√xt
(k))

300 i‡(!
	`__bch_exã¡_övÆid
(
c
, 
k
)) {

301 
j
;

303 
j
 = 0; j < 
	`KEY_PTRS
(
k
); j++)

304 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
j
))

305 
	`©omic_öc
(&
	`PTR_BUCKET
(
c
, 
k
, 
j
)->
pö
);

307 
	`bch_öôül_m¨k_key
(
c
, 0, 
k
);

310 
	}
}

312 
	$bch_jou∫Æ_ª∂ay
(
ˇche_£t
 *
s
, 
li°_hód
 *
li°
)

314 
ªt
 = 0, 
keys
 = 0, 
íåõs
 = 0;

315 
bkey
 *
k
;

316 
jou∫Æ_ª∂ay
 *
i
 =

317 
	`li°_íåy
(
li°
->
¥ev
, 
jou∫Æ_ª∂ay
,Üist);

319 
uöt64_t
 
°¨t
 = 
i
->
j
.
œ°_£q
, 
íd
 = i->j.
£q
, 
n
 = start;

320 
keyli°
 keylist;

322 
	`li°_f‹_óch_íåy
(
i
, 
li°
,Üist) {

323 
	`BUG_ON
(
i
->
pö
 && 
	`©omic_ªad
(i->pin) != 1);

325 
	`ˇche_£t_îr_⁄
(
n
 !
i
->
j
.
£q
, 
s
,

327 
n
, 
i
->
j
.
£q
 - 1, 
°¨t
, 
íd
);

329 
k
 = 
i
->
j
.
°¨t
;

330 
k
 < 
	`b£t_bkey_œ°
(&
i
->
j
);

331 
k
 = 
	`bkey_√xt
(k)) {

332 
	`åa˚_bˇche_jou∫Æ_ª∂ay_key
(
k
);

334 
	`bch_keyli°_öô_sögÀ
(&
keyli°
, 
k
);

336 
ªt
 = 
	`bch_båì_ö£π
(
s
, &
keyli°
, 
i
->
pö
, 
NULL
);

337 i‡(
ªt
)

338 
îr
;

340 
	`BUG_ON
(!
	`bch_keyli°_em±y
(&
keyli°
));

341 
keys
++;

343 
	`c⁄d_ªsched
();

346 i‡(
i
->
pö
)

347 
	`©omic_dec
(
i
->
pö
);

348 
n
 = 
i
->
j
.
£q
 + 1;

349 
íåõs
++;

352 
	`¥_öfo
("journalÑeplay done, %i keys in %iÉntries, seq %llu",

353 
keys
, 
íåõs
, 
íd
);

354 
îr
:

355 !
	`li°_em±y
(
li°
)) {

356 
i
 = 
	`li°_fú°_íåy
(
li°
, 
jou∫Æ_ª∂ay
,Üist);

357 
	`li°_dñ
(&
i
->
li°
);

358 
	`k‰ì
(
i
);

361  
ªt
;

362 
	}
}

366 
	$båì_Êush_wrôe
(
ˇche_£t
 *
c
)

372 
båì
 *
b
, *
be°
;

373 
i
;

374 
ªåy
:

375 
be°
 = 
NULL
;

377 
	`f‹_óch_ˇched_båì
(
b
, 
c
, 
i
)

378 i‡(
	`båì_cuºít_wrôe
(
b
)->
jou∫Æ
) {

379 i‡(!
be°
)

380 
be°
 = 
b
;

381 i‡(
	`jou∫Æ_pö_cmp
(
c
,

382 
	`båì_cuºít_wrôe
(
be°
)->
jou∫Æ
,

383 
	`båì_cuºít_wrôe
(
b
)->
jou∫Æ
)) {

384 
be°
 = 
b
;

388 
b
 = 
be°
;

389 i‡(
b
) {

390 
	`muãx_lock
(&
b
->
wrôe_lock
);

391 i‡(!
	`båì_cuºít_wrôe
(
b
)->
jou∫Æ
) {

392 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

394 
ªåy
;

397 
	`__bch_båì_node_wrôe
(
b
, 
NULL
);

398 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

400 
	}
}

402 
	#œ°_£q
(
j
Ë((j)->
£q
 - 
	`fifo_u£d
(&(j)->
pö
Ë+ 1)

	)

404 
	$jou∫Æ_disˇrd_ídio
(
bio
 *bio, 
îr‹
)

406 
jou∫Æ_devi˚
 *
ja
 =

407 
	`c⁄èöî_of
(
bio
, 
jou∫Æ_devi˚
, 
disˇrd_bio
);

408 
ˇche
 *
ˇ
 = 
	`c⁄èöî_of
(
ja
, ˇche, 
jou∫Æ
);

410 
	`©omic_£t
(&
ja
->
disˇrd_ö_Êight
, 
DISCARD_DONE
);

412 
	`˛osuª_wake_up
(&
ˇ
->
£t
->
jou∫Æ
.
waô
);

413 
	`˛osuª_put
(&
ˇ
->
£t
->
˛
);

414 
	}
}

416 
	$jou∫Æ_disˇrd_w‹k
(
w‹k_°ru˘
 *
w‹k
)

418 
jou∫Æ_devi˚
 *
ja
 =

419 
	`c⁄èöî_of
(
w‹k
, 
jou∫Æ_devi˚
, 
disˇrd_w‹k
);

421 
	`submô_bio
(0, &
ja
->
disˇrd_bio
);

422 
	}
}

424 
	$do_jou∫Æ_disˇrd
(
ˇche
 *
ˇ
)

426 
jou∫Æ_devi˚
 *
ja
 = &
ˇ
->
jou∫Æ
;

427 
bio
 *biÿ&
ja
->
disˇrd_bio
;

429 i‡(!
ˇ
->
disˇrd
) {

430 
ja
->
disˇrd_idx
 = ja->
œ°_idx
;

434 
	`©omic_ªad
(&
ja
->
disˇrd_ö_Êight
)) {

435 
DISCARD_IN_FLIGHT
:

438 
DISCARD_DONE
:

439 
ja
->
disˇrd_idx
 = (ja->discard_idx + 1) %

440 
ˇ
->
sb
.
njou∫Æ_buckës
;

442 
	`©omic_£t
(&
ja
->
disˇrd_ö_Êight
, 
DISCARD_READY
);

445 
DISCARD_READY
:

446 i‡(
ja
->
disˇrd_idx
 =ja->
œ°_idx
)

449 
	`©omic_£t
(&
ja
->
disˇrd_ö_Êight
, 
DISCARD_IN_FLIGHT
);

451 
	`bio_öô
(
bio
);

452 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`buckë_to_£˘‹
(
ˇ
->
£t
,

453 
ˇ
->
sb
.
d
[
ja
->
disˇrd_idx
]);

454 
bio
->
bi_bdev
 = 
ˇ
->
bdev
;

455 
bio
->
bi_rw
 = 
REQ_WRITE
|
REQ_DISCARD
;

456 
bio
->
bi_max_vecs
 = 1;

457 
bio
->
bi_io_vec
 = bio->
bi_ölöe_vecs
;

458 
bio
->
bi_ôî
.
bi_size
 = 
	`buckë_byãs
(
ˇ
);

459 
bio
->
bi_íd_io
 = 
jou∫Æ_disˇrd_ídio
;

461 
	`˛osuª_gë
(&
ˇ
->
£t
->
˛
);

462 
	`INIT_WORK
(&
ja
->
disˇrd_w‹k
, 
jou∫Æ_disˇrd_w‹k
);

463 
	`scheduÀ_w‹k
(&
ja
->
disˇrd_w‹k
);

465 
	}
}

467 
	$jou∫Æ_ª˛aim
(
ˇche_£t
 *
c
)

469 
bkey
 *
k
 = &
c
->
jou∫Æ
.
key
;

470 
ˇche
 *
ˇ
;

471 
uöt64_t
 
œ°_£q
;

472 
ôî
, 
n
 = 0;

473 
©omic_t
 
p
;

475 !
	`©omic_ªad
(&
	`fifo_‰⁄t
(&
c
->
jou∫Æ
.
pö
)))

476 
	`fifo_p›
(&
c
->
jou∫Æ
.
pö
, 
p
);

478 
œ°_£q
 = 
	`œ°_£q
(&
c
->
jou∫Æ
);

482 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
ôî
) {

483 
jou∫Æ_devi˚
 *
ja
 = &
ˇ
->
jou∫Æ
;

485 
ja
->
œ°_idx
 !ja->
cur_idx
 &&

486 
ja
->
£q
[ja->
œ°_idx
] < 
œ°_£q
)

487 
ja
->
œ°_idx
 = (ja->last_idx + 1) %

488 
ˇ
->
sb
.
njou∫Æ_buckës
;

491 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
ôî
)

492 
	`do_jou∫Æ_disˇrd
(
ˇ
);

494 i‡(
c
->
jou∫Æ
.
blocks_‰ì
)

495 
out
;

502 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
ôî
) {

503 
jou∫Æ_devi˚
 *
ja
 = &
ˇ
->
jou∫Æ
;

504 
√xt
 = (
ja
->
cur_idx
 + 1Ë% 
ˇ
->
sb
.
njou∫Æ_buckës
;

507 i‡(
√xt
 =
ja
->
disˇrd_idx
)

510 
ja
->
cur_idx
 = 
√xt
;

511 
k
->
±r
[
n
++] = 
	`PTR
(0,

512 
	`buckë_to_£˘‹
(
c
, 
ˇ
->
sb
.
d
[
ja
->
cur_idx
]),

513 
ˇ
->
sb
.
ƒ_this_dev
);

516 
	`bkey_öô
(
k
);

517 
	`SET_KEY_PTRS
(
k
, 
n
);

519 i‡(
n
)

520 
c
->
jou∫Æ
.
blocks_‰ì
 = c->
sb
.
buckë_size
 >> c->
block_bôs
;

521 
out
:

522 i‡(!
	`jou∫Æ_fuŒ
(&
c
->
jou∫Æ
))

523 
	`__˛osuª_wake_up
(&
c
->
jou∫Æ
.
waô
);

524 
	}
}

526 
	$bch_jou∫Æ_√xt
(
jou∫Æ
 *
j
)

528 
©omic_t
 
p
 = { 1 };

530 
j
->
cur
 = (j->cu∏=j->
w
)

531 ? &
j
->
w
[1]

532 : &
j
->
w
[0];

538 
	`BUG_ON
(!
	`fifo_push
(&
j
->
pö
, 
p
));

539 
	`©omic_£t
(&
	`fifo_back
(&
j
->
pö
), 1);

541 
j
->
cur
->
d©a
->
£q
 = ++j->seq;

542 
j
->
cur
->
dúty
 = 
Ál£
;

543 
j
->
cur
->
√ed_wrôe
 = 
Ál£
;

544 
j
->
cur
->
d©a
->
keys
 = 0;

546 i‡(
	`fifo_fuŒ
(&
j
->
pö
))

547 
	`¥_debug
("jou∫Æ_pö fuŒ (%zu)", 
	`fifo_u£d
(&
j
->
pö
));

548 
	}
}

550 
	$jou∫Æ_wrôe_ídio
(
bio
 *bio, 
îr‹
)

552 
jou∫Æ_wrôe
 *
w
 = 
bio
->
bi_¥iv©e
;

554 
	`ˇche_£t_îr_⁄
(
îr‹
, 
w
->
c
, "journal ioÉrror");

555 
	`˛osuª_put
(&
w
->
c
->
jou∫Æ
.
io
);

556 
	}
}

558 
jou∫Æ_wrôe
(
˛osuª
 *);

560 
	$jou∫Æ_wrôe_d⁄e
(
˛osuª
 *
˛
)

562 
jou∫Æ
 *
j
 = 
	`c⁄èöî_of
(
˛
, jou∫Æ, 
io
);

563 
jou∫Æ_wrôe
 *
w
 = (
j
->
cur
 == j->w)

564 ? &
j
->
w
[1]

565 : &
j
->
w
[0];

567 
	`__˛osuª_wake_up
(&
w
->
waô
);

568 
	`c⁄töue_©_nob¨rõr
(
˛
, 
jou∫Æ_wrôe
, 
sy°em_wq
);

569 
	}
}

571 
	$jou∫Æ_wrôe_u∆ock
(
˛osuª
 *
˛
)

573 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
jou∫Æ
.
io
);

575 
c
->
jou∫Æ
.
io_ö_Êight
 = 0;

576 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

577 
	}
}

579 
	$jou∫Æ_wrôe_u∆ocked
(
˛osuª
 *
˛
)

580 
	`__ªÀa£s
(
c
->
jou∫Æ
.
lock
)

582 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
jou∫Æ
.
io
);

583 
ˇche
 *
ˇ
;

584 
jou∫Æ_wrôe
 *
w
 = 
c
->
jou∫Æ
.
cur
;

585 
bkey
 *
k
 = &
c
->
jou∫Æ
.
key
;

586 
i
, 
£˘‹s
 = 
	`£t_blocks
(
w
->
d©a
, 
	`block_byãs
(
c
)) *

587 
c
->
sb
.
block_size
;

589 
bio
 *bio;

590 
bio_li°
 
li°
;

591 
	`bio_li°_öô
(&
li°
);

593 i‡(!
w
->
√ed_wrôe
) {

594 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
jou∫Æ_wrôe_u∆ock
);

595 } i‡(
	`jou∫Æ_fuŒ
(&
c
->
jou∫Æ
)) {

596 
	`jou∫Æ_ª˛aim
(
c
);

597 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

599 
	`båì_Êush_wrôe
(
c
);

600 
	`c⁄töue_©
(
˛
, 
jou∫Æ_wrôe
, 
sy°em_wq
);

603 
c
->
jou∫Æ
.
blocks_‰ì
 -
	`£t_blocks
(
w
->
d©a
, 
	`block_byãs
(c));

605 
w
->
d©a
->
båì_Àvñ
 = 
c
->
roŸ
->
Àvñ
;

607 
	`bkey_c›y
(&
w
->
d©a
->
båì_roŸ
, &
c
->
roŸ
->
key
);

608 
	`bkey_c›y
(&
w
->
d©a
->
uuid_buckë
, &
c
->uuid_bucket);

610 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

611 
w
->
d©a
->
¥io_buckë
[
ˇ
->
sb
.
ƒ_this_dev
] = ca->
¥io_buckës
[0];

613 
w
->
d©a
->
magic
 = 
	`j£t_magic
(&
c
->
sb
);

614 
w
->
d©a
->
vîsi⁄
 = 
BCACHE_JSET_VERSION
;

615 
w
->
d©a
->
œ°_£q
 = 
	`œ°_£q
(&
c
->
jou∫Æ
);

616 
w
->
d©a
->
csum
 = 
	`csum_£t
(w->data);

618 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++) {

619 
ˇ
 = 
	`PTR_CACHE
(
c
, 
k
, 
i
);

620 
bio
 = &
ˇ
->
jou∫Æ
.bio;

622 
	`©omic_l⁄g_add
(
£˘‹s
, &
ˇ
->
mëa_£˘‹s_wrôãn
);

624 
	`bio_ª£t
(
bio
);

625 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`PTR_OFFSET
(
k
, 
i
);

626 
bio
->
bi_bdev
 = 
ˇ
->
bdev
;

627 
bio
->
bi_rw
 = 
REQ_WRITE
|
REQ_SYNC
|
REQ_META
|
REQ_FLUSH
|
REQ_FUA
;

628 
bio
->
bi_ôî
.
bi_size
 = 
£˘‹s
 << 9;

630 
bio
->
bi_íd_io
 = 
jou∫Æ_wrôe_ídio
;

631 
bio
->
bi_¥iv©e
 = 
w
;

632 
	`bch_bio_m≠
(
bio
, 
w
->
d©a
);

634 
	`åa˚_bˇche_jou∫Æ_wrôe
(
bio
);

635 
	`bio_li°_add
(&
li°
, 
bio
);

637 
	`SET_PTR_OFFSET
(
k
, 
i
, 
	`PTR_OFFSET
(k, iË+ 
£˘‹s
);

639 
ˇ
->
jou∫Æ
.
£q
[ˇ->jou∫Æ.
cur_idx
] = 
w
->
d©a
->seq;

642 
	`©omic_dec_bug
(&
	`fifo_back
(&
c
->
jou∫Æ
.
pö
));

643 
	`bch_jou∫Æ_√xt
(&
c
->
jou∫Æ
);

644 
	`jou∫Æ_ª˛aim
(
c
);

646 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

648 (
bio
 = 
	`bio_li°_p›
(&
li°
)))

649 
	`˛osuª_bio_submô
(
bio
, 
˛
, 
c
->
ˇche
[0]);

651 
	`c⁄töue_©
(
˛
, 
jou∫Æ_wrôe_d⁄e
, 
NULL
);

652 
	}
}

654 
	$jou∫Æ_wrôe
(
˛osuª
 *
˛
)

656 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
jou∫Æ
.
io
);

658 
	`•ö_lock
(&
c
->
jou∫Æ
.
lock
);

659 
	`jou∫Æ_wrôe_u∆ocked
(
˛
);

660 
	}
}

662 
	$jou∫Æ_åy_wrôe
(
ˇche_£t
 *
c
)

663 
	`__ªÀa£s
(
c
->
jou∫Æ
.
lock
)

665 
˛osuª
 *
˛
 = &
c
->
jou∫Æ
.
io
;

666 
jou∫Æ_wrôe
 *
w
 = 
c
->
jou∫Æ
.
cur
;

668 
w
->
√ed_wrôe
 = 
åue
;

670 i‡(!
c
->
jou∫Æ
.
io_ö_Êight
) {

671 
c
->
jou∫Æ
.
io_ö_Êight
 = 1;

672 
	`˛osuª_ˇŒ
(
˛
, 
jou∫Æ_wrôe_u∆ocked
, 
NULL
, &
c
->cl);

674 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

676 
	}
}

678 
jou∫Æ_wrôe
 *
	$jou∫Æ_waô_f‹_wrôe
(
ˇche_£t
 *
c
,

679 
nkeys
)

681 
size_t
 
£˘‹s
;

682 
˛osuª
 
˛
;

683 
boﬁ
 
waô
 = 
Ál£
;

685 
	`˛osuª_öô_°ack
(&
˛
);

687 
	`•ö_lock
(&
c
->
jou∫Æ
.
lock
);

690 
jou∫Æ_wrôe
 *
w
 = 
c
->
jou∫Æ
.
cur
;

692 
£˘‹s
 = 
	`__£t_blocks
(
w
->
d©a
, w->d©a->
keys
 + 
nkeys
,

693 
	`block_byãs
(
c
)Ë* c->
sb
.
block_size
;

695 i‡(
£˘‹s
 <
	`mö_t
(
size_t
,

696 
c
->
jou∫Æ
.
blocks_‰ì
 * c->
sb
.
block_size
,

697 
PAGE_SECTORS
 << 
JSET_BITS
))

698  
w
;

700 i‡(
waô
)

701 
	`˛osuª_waô
(&
c
->
jou∫Æ
.
waô
, &
˛
);

703 i‡(!
	`jou∫Æ_fuŒ
(&
c
->
jou∫Æ
)) {

704 i‡(
waô
)

705 
	`åa˚_bˇche_jou∫Æ_íåy_fuŒ
(
c
);

713 
	`BUG_ON
(!
w
->
d©a
->
keys
);

715 
	`jou∫Æ_åy_wrôe
(
c
);

717 i‡(
waô
)

718 
	`åa˚_bˇche_jou∫Æ_fuŒ
(
c
);

720 
	`jou∫Æ_ª˛aim
(
c
);

721 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

723 
	`båì_Êush_wrôe
(
c
);

726 
	`˛osuª_sync
(&
˛
);

727 
	`•ö_lock
(&
c
->
jou∫Æ
.
lock
);

728 
waô
 = 
åue
;

730 
	}
}

732 
	$jou∫Æ_wrôe_w‹k
(
w‹k_°ru˘
 *
w‹k
)

734 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

735 
ˇche_£t
,

736 
jou∫Æ
.
w‹k
);

737 
	`•ö_lock
(&
c
->
jou∫Æ
.
lock
);

738 i‡(
c
->
jou∫Æ
.
cur
->
dúty
)

739 
	`jou∫Æ_åy_wrôe
(
c
);

741 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

742 
	}
}

750 
©omic_t
 *
	$bch_jou∫Æ
(
ˇche_£t
 *
c
,

751 
keyli°
 *
keys
,

752 
˛osuª
 *
∑ª¡
)

754 
jou∫Æ_wrôe
 *
w
;

755 
©omic_t
 *
ªt
;

757 i‡(!
	`CACHE_SYNC
(&
c
->
sb
))

758  
NULL
;

760 
w
 = 
	`jou∫Æ_waô_f‹_wrôe
(
c
, 
	`bch_keyli°_nkeys
(
keys
));

762 
	`mem˝y
(
	`b£t_bkey_œ°
(
w
->
d©a
), 
keys
->keys, 
	`bch_keyli°_byãs
(keys));

763 
w
->
d©a
->
keys
 +
	`bch_keyli°_nkeys
(keys);

765 
ªt
 = &
	`fifo_back
(&
c
->
jou∫Æ
.
pö
);

766 
	`©omic_öc
(
ªt
);

768 i‡(
∑ª¡
) {

769 
	`˛osuª_waô
(&
w
->
waô
, 
∑ª¡
);

770 
	`jou∫Æ_åy_wrôe
(
c
);

771 } i‡(!
w
->
dúty
) {

772 
w
->
dúty
 = 
åue
;

773 
	`scheduÀ_dñayed_w‹k
(&
c
->
jou∫Æ
.
w‹k
,

774 
	`m£cs_to_jiffõs
(
c
->
jou∫Æ_dñay_ms
));

775 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

777 
	`•ö_u∆ock
(&
c
->
jou∫Æ
.
lock
);

781  
ªt
;

782 
	}
}

784 
	$bch_jou∫Æ_mëa
(
ˇche_£t
 *
c
, 
˛osuª
 *
˛
)

786 
keyli°
 
keys
;

787 
©omic_t
 *
ªf
;

789 
	`bch_keyli°_öô
(&
keys
);

791 
ªf
 = 
	`bch_jou∫Æ
(
c
, &
keys
, 
˛
);

792 i‡(
ªf
)

793 
	`©omic_dec_bug
(
ªf
);

794 
	}
}

796 
	$bch_jou∫Æ_‰ì
(
ˇche_£t
 *
c
)

798 
	`‰ì_∑ges
((Ë
c
->
jou∫Æ
.
w
[1].
d©a
, 
JSET_BITS
);

799 
	`‰ì_∑ges
((Ë
c
->
jou∫Æ
.
w
[0].
d©a
, 
JSET_BITS
);

800 
	`‰ì_fifo
(&
c
->
jou∫Æ
.
pö
);

801 
	}
}

803 
	$bch_jou∫Æ_Æloc
(
ˇche_£t
 *
c
)

805 
jou∫Æ
 *
j
 = &
c
->journal;

807 
	`•ö_lock_öô
(&
j
->
lock
);

808 
	`INIT_DELAYED_WORK
(&
j
->
w‹k
, 
jou∫Æ_wrôe_w‹k
);

810 
c
->
jou∫Æ_dñay_ms
 = 100;

812 
j
->
w
[0].
c
 = c;

813 
j
->
w
[1].
c
 = c;

815 i‡(!(
	`öô_fifo
(&
j
->
pö
, 
JOURNAL_PIN
, 
GFP_KERNEL
)) ||

816 !(
j
->
w
[0].
d©a
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
JSET_BITS
)) ||

817 !(
j
->
w
[1].
d©a
 = (*Ë
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
JSET_BITS
)))

818  -
ENOMEM
;

821 
	}
}

	@bcache/journal.h

1 #i‚de‡
_BCACHE_JOURNAL_H


2 
	#_BCACHE_JOURNAL_H


	)

82 
	sjou∫Æ_ª∂ay
 {

83 
li°_hód
 
	mli°
;

84 
©omic_t
 *
	mpö
;

85 
j£t
 
	mj
;

92 
	sjou∫Æ_wrôe
 {

93 
j£t
 *
	md©a
;

94 
	#JSET_BITS
 3

	)

96 
ˇche_£t
 *
	mc
;

97 
˛osuª_waôli°
 
	mwaô
;

98 
boﬁ
 
	mdúty
;

99 
boﬁ
 
	m√ed_wrôe
;

103 
	sjou∫Æ
 {

104 
•ölock_t
 
	mlock
;

106 
˛osuª_waôli°
 
	mwaô
;

107 
˛osuª
 
	mio
;

108 
	mio_ö_Êight
;

109 
dñayed_w‹k
 
	mw‹k
;

112 
	mblocks_‰ì
;

113 
uöt64_t
 
	m£q
;

114 
DECLARE_FIFO
(
©omic_t
, 
pö
);

116 
BKEY_PADDED
(
key
);

118 
jou∫Æ_wrôe
 
	mw
[2], *
	mcur
;

125 
	sjou∫Æ_devi˚
 {

130 
uöt64_t
 
	m£q
[
SB_JOURNAL_BUCKETS
];

133 
	mcur_idx
;

136 
	mœ°_idx
;

139 
	mdisˇrd_idx
;

141 
	#DISCARD_READY
 0

	)

142 
	#DISCARD_IN_FLIGHT
 1

	)

143 
	#DISCARD_DONE
 2

	)

145 
©omic_t
 
	mdisˇrd_ö_Êight
;

147 
w‹k_°ru˘
 
	mdisˇrd_w‹k
;

148 
bio
 
	mdisˇrd_bio
;

149 
bio_vec
 
	mdisˇrd_bv
;

152 
bio
 
	mbio
;

153 
bio_vec
 
	mbv
[8];

156 
	#jou∫Æ_pö_cmp
(
c
, 
l
, 
r
) \

157 (
	`fifo_idx
(&(
c
)->
jou∫Æ
.
pö
, (
l
)Ë> fifo_idx(&(c)->jou∫Æ.pö, (
r
)))

	)

159 
	#JOURNAL_PIN
 20000

	)

161 
	#jou∫Æ_fuŒ
(
j
) \

162 (!(
j
)->
blocks_‰ì
 || 
	`fifo_‰ì
(&(j)->
pö
Ë<1)

	)

164 
	g˛osuª
;

165 
	gˇche_£t
;

166 
	gbåì_›
;

167 
	gkeyli°
;

169 
©omic_t
 *
bch_jou∫Æ
(
ˇche_£t
 *, 
keyli°
 *, 
˛osuª
 *);

170 
bch_jou∫Æ_√xt
(
jou∫Æ
 *);

171 
bch_jou∫Æ_m¨k
(
ˇche_£t
 *, 
li°_hód
 *);

172 
bch_jou∫Æ_mëa
(
ˇche_£t
 *, 
˛osuª
 *);

173 
bch_jou∫Æ_ªad
(
ˇche_£t
 *, 
li°_hód
 *);

174 
bch_jou∫Æ_ª∂ay
(
ˇche_£t
 *, 
li°_hód
 *);

176 
bch_jou∫Æ_‰ì
(
ˇche_£t
 *);

177 
bch_jou∫Æ_Æloc
(
ˇche_£t
 *);

	@bcache/movinggc.c

7 
	~"bˇche.h
"

8 
	~"båì.h
"

9 
	~"debug.h
"

10 
	~"ªque°.h
"

12 
	~<åa˚/evíts/bˇche.h
>

14 
	smovög_io
 {

15 
˛osuª
 
	m˛
;

16 
keybuf_key
 *
	mw
;

17 
d©a_ö£π_›
 
	m›
;

18 
bbio
 
	mbio
;

21 
boﬁ
 
	$movög_¥ed
(
keybuf
 *
buf
, 
bkey
 *
k
)

23 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
buf
, cache_set,

24 
movög_gc_keys
);

25 
i
;

27 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

28 i‡(
	`±r_avaûabÀ
(
c
, 
k
, 
i
) &&

29 
	`GC_MOVE
(
	`PTR_BUCKET
(
c
, 
k
, 
i
)))

30  
åue
;

32  
Ál£
;

33 
	}
}

37 
	$movög_io_de°ru˘‹
(
˛osuª
 *
˛
)

39 
movög_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, moving_io, cl);

40 
	`k‰ì
(
io
);

41 
	}
}

43 
	$wrôe_movög_föish
(
˛osuª
 *
˛
)

45 
movög_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, moving_io, cl);

46 
bio
 *biÿ&
io
->bio.bio;

47 
bio_vec
 *
bv
;

48 
i
;

50 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
i
)

51 
	`__‰ì_∑ge
(
bv
->
bv_∑ge
);

53 i‡(
io
->
›
.
ª∂a˚_cﬁlisi⁄
)

54 
	`åa˚_bˇche_gc_c›y_cﬁlisi⁄
(&
io
->
w
->
key
);

56 
	`bch_keybuf_dñ
(&
io
->
›
.
c
->
movög_gc_keys
, io->
w
);

58 
	`up
(&
io
->
›
.
c
->
movög_ö_Êight
);

60 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
movög_io_de°ru˘‹
);

61 
	}
}

63 
	$ªad_movög_ídio
(
bio
 *bio, 
îr‹
)

65 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

66 
movög_io
 *
io
 = 
	`c⁄èöî_of
(
bio
->
bi_¥iv©e
,

67 
movög_io
, 
˛
);

69 i‡(
îr‹
)

70 
io
->
›
.
îr‹
 =Érror;

71 i‡(!
	`KEY_DIRTY
(&
b
->
key
) &&

72 
	`±r_°Æe
(
io
->
›
.
c
, &
b
->
key
, 0)) {

73 
io
->
›
.
îr‹
 = -
EINTR
;

76 
	`bch_bbio_ídio
(
io
->
›
.
c
, 
bio
, 
îr‹
, "reading dataÅo move");

77 
	}
}

79 
	$movög_öô
(
movög_io
 *
io
)

81 
bio
 *biÿ&
io
->bio.bio;

83 
	`bio_öô
(
bio
);

84 
	`bio_gë
(
bio
);

85 
	`bio_£t_¥io
(
bio
, 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_IDLE
, 0));

87 
bio
->
bi_ôî
.
bi_size
 = 
	`KEY_SIZE
(&
io
->
w
->
key
) << 9;

88 
bio
->
bi_max_vecs
 = 
	`DIV_ROUND_UP
(
	`KEY_SIZE
(&
io
->
w
->
key
),

89 
PAGE_SECTORS
);

90 
bio
->
bi_¥iv©e
 = &
io
->
˛
;

91 
bio
->
bi_io_vec
 = bio->
bi_ölöe_vecs
;

92 
	`bch_bio_m≠
(
bio
, 
NULL
);

93 
	}
}

95 
	$wrôe_movög
(
˛osuª
 *
˛
)

97 
movög_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, moving_io, cl);

98 
d©a_ö£π_›
 *
›
 = &
io
->op;

100 i‡(!
›
->
îr‹
) {

101 
	`movög_öô
(
io
);

103 
io
->
bio
.bio.
bi_ôî
.
bi_£˘‹
 = 
	`KEY_START
(&io->
w
->
key
);

104 
›
->
wrôe_¥io
 = 1;

105 
›
->
bio
 = &
io
->bio.bio;

107 
›
->
wrôeback
 = 
	`KEY_DIRTY
(&
io
->
w
->
key
);

108 
›
->
csum
 = 
	`KEY_CSUM
(&
io
->
w
->
key
);

110 
	`bkey_c›y
(&
›
->
ª∂a˚_key
, &
io
->
w
->
key
);

111 
›
->
ª∂a˚
 = 
åue
;

113 
	`˛osuª_ˇŒ
(&
›
->
˛
, 
bch_d©a_ö£π
, 
NULL
, cl);

116 
	`c⁄töue_©
(
˛
, 
wrôe_movög_föish
, 
›
->
wq
);

117 
	}
}

119 
	$ªad_movög_submô
(
˛osuª
 *
˛
)

121 
movög_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, moving_io, cl);

122 
bio
 *biÿ&
io
->bio.bio;

124 
	`bch_submô_bbio
(
bio
, 
io
->
›
.
c
, &io->
w
->
key
, 0);

126 
	`c⁄töue_©
(
˛
, 
wrôe_movög
, 
io
->
›
.
wq
);

127 
	}
}

129 
	$ªad_movög
(
ˇche_£t
 *
c
)

131 
keybuf_key
 *
w
;

132 
movög_io
 *
io
;

133 
bio
 *bio;

134 
˛osuª
 
˛
;

136 
	`˛osuª_öô_°ack
(&
˛
);

140 !
	`ã°_bô
(
CACHE_SET_STOPPING
, &
c
->
Êags
)) {

141 
w
 = 
	`bch_keybuf_√xt_ªsˇn
(
c
, &c->
movög_gc_keys
,

142 &
MAX_KEY
, 
movög_¥ed
);

143 i‡(!
w
)

146 i‡(
	`±r_°Æe
(
c
, &
w
->
key
, 0)) {

147 
	`bch_keybuf_dñ
(&
c
->
movög_gc_keys
, 
w
);

151 
io
 = 
	`kzÆloc
((
movög_io
Ë+ (
bio_vec
)

152 * 
	`DIV_ROUND_UP
(
	`KEY_SIZE
(&
w
->
key
), 
PAGE_SECTORS
),

153 
GFP_KERNEL
);

154 i‡(!
io
)

155 
îr
;

157 
w
->
¥iv©e
 = 
io
;

158 
io
->
w
 = w;

159 
io
->
›
.
öode
 = 
	`KEY_INODE
(&
w
->
key
);

160 
io
->
›
.
c
 = c;

161 
io
->
›
.
wq
 = 
c
->
movög_gc_wq
;

163 
	`movög_öô
(
io
);

164 
bio
 = &
io
->bio.bio;

166 
bio
->
bi_rw
 = 
READ
;

167 
bio
->
bi_íd_io
 = 
ªad_movög_ídio
;

169 i‡(
	`bio_Æloc_∑ges
(
bio
, 
GFP_KERNEL
))

170 
îr
;

172 
	`åa˚_bˇche_gc_c›y
(&
w
->
key
);

174 
	`down
(&
c
->
movög_ö_Êight
);

175 
	`˛osuª_ˇŒ
(&
io
->
˛
, 
ªad_movög_submô
, 
NULL
, &cl);

179 
îr
: i‡(!
	`IS_ERR_OR_NULL
(
w
->
¥iv©e
))

180 
	`k‰ì
(
w
->
¥iv©e
);

182 
	`bch_keybuf_dñ
(&
c
->
movög_gc_keys
, 
w
);

185 
	`˛osuª_sync
(&
˛
);

186 
	}
}

188 
boﬁ
 
	$buckë_cmp
(
buckë
 *
l
, buckë *
r
)

190  
	`GC_SECTORS_USED
(
l
Ë< GC_SECTORS_USED(
r
);

191 
	}
}

193 
	$buckë_hóp_t›
(
ˇche
 *
ˇ
)

195 
buckë
 *
b
;

196  (
b
 = 
	`hóp_≥ek
(&
ˇ
->
hóp
)Ë? 
	`GC_SECTORS_USED
(b) : 0;

197 
	}
}

199 
	$bch_movög_gc
(
ˇche_£t
 *
c
)

201 
ˇche
 *
ˇ
;

202 
buckë
 *
b
;

203 
i
;

205 i‡(!
c
->
c›y_gc_íabÀd
)

208 
	`muãx_lock
(&
c
->
buckë_lock
);

210 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
) {

211 
£˘‹s_to_move
 = 0;

212 
ª£rve_£˘‹s
 = 
ˇ
->
sb
.
buckë_size
 *

213 
	`fifo_u£d
(&
ˇ
->
‰ì
[
RESERVE_MOVINGGC
]);

215 
ˇ
->
hóp
.
u£d
 = 0;

217 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

218 i‡(
	`GC_MARK
(
b
Ë=
GC_MARK_METADATA
 ||

219 !
	`GC_SECTORS_USED
(
b
) ||

220 
	`GC_SECTORS_USED
(
b
Ë=
ˇ
->
sb
.
buckë_size
 ||

221 
	`©omic_ªad
(&
b
->
pö
))

224 i‡(!
	`hóp_fuŒ
(&
ˇ
->
hóp
)) {

225 
£˘‹s_to_move
 +
	`GC_SECTORS_USED
(
b
);

226 
	`hóp_add
(&
ˇ
->
hóp
, 
b
, 
buckë_cmp
);

227 } i‡(
	`buckë_cmp
(
b
, 
	`hóp_≥ek
(&
ˇ
->
hóp
))) {

228 
£˘‹s_to_move
 -
	`buckë_hóp_t›
(
ˇ
);

229 
£˘‹s_to_move
 +
	`GC_SECTORS_USED
(
b
);

231 
ˇ
->
hóp
.
d©a
[0] = 
b
;

232 
	`hóp_si·
(&
ˇ
->
hóp
, 0, 
buckë_cmp
);

236 
£˘‹s_to_move
 > 
ª£rve_£˘‹s
) {

237 
	`hóp_p›
(&
ˇ
->
hóp
, 
b
, 
buckë_cmp
);

238 
£˘‹s_to_move
 -
	`GC_SECTORS_USED
(
b
);

241 
	`hóp_p›
(&
ˇ
->
hóp
, 
b
, 
buckë_cmp
))

242 
	`SET_GC_MOVE
(
b
, 1);

245 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

247 
c
->
movög_gc_keys
.
œ°_sˇ¬ed
 = 
ZERO_KEY
;

249 
	`ªad_movög
(
c
);

250 
	}
}

252 
	$bch_movög_öô_ˇche_£t
(
ˇche_£t
 *
c
)

254 
	`bch_keybuf_öô
(&
c
->
movög_gc_keys
);

255 
	`£ma_öô
(&
c
->
movög_ö_Êight
, 64);

256 
	}
}

	@bcache/request.c

9 
	~"bˇche.h
"

10 
	~"båì.h
"

11 
	~"debug.h
"

12 
	~"ªque°.h
"

13 
	~"wrôeback.h
"

15 
	~<löux/moduÀ.h
>

16 
	~<löux/hash.h
>

17 
	~<löux/øndom.h
>

19 
	~<åa˚/evíts/bˇche.h
>

21 
	#CUTOFF_CACHE_ADD
 95

	)

22 
	#CUTOFF_CACHE_READA
 90

	)

24 
kmem_ˇche
 *
	gbch_£¨ch_ˇche
;

26 
bch_d©a_ö£π_°¨t
(
˛osuª
 *);

28 
	$ˇche_mode
(
ˇched_dev
 *
dc
, 
bio
 *bio)

30  
	`BDEV_CACHE_MODE
(&
dc
->
sb
);

31 
	}
}

33 
boﬁ
 
	$vîify
(
ˇched_dev
 *
dc
, 
bio
 *bio)

35  
dc
->
vîify
;

36 
	}
}

38 
	$bio_csum
(
bio
 *bio, 
bkey
 *
k
)

40 
bio_vec
 
bv
;

41 
bvec_ôî
 
ôî
;

42 
uöt64_t
 
csum
 = 0;

44 
	`bio_f‹_óch_£gmít
(
bv
, 
bio
, 
ôî
) {

45 *
d
 = 
	`km≠
(
bv
.
bv_∑ge
Ë+ bv.
bv_off£t
;

46 
csum
 = 
	`bch_¸c64_upd©e
(csum, 
d
, 
bv
.
bv_Àn
);

47 
	`kunm≠
(
bv
.
bv_∑ge
);

50 
k
->
±r
[
	`KEY_PTRS
(k)] = 
csum
 & (~0ULL >> 1);

51 
	}
}

55 
	$bch_d©a_ö£π_keys
(
˛osuª
 *
˛
)

57 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

58 
©omic_t
 *
jou∫Æ_ªf
 = 
NULL
;

59 
bkey
 *
ª∂a˚_key
 = 
›
->
ª∂a˚
 ? &›->ª∂a˚_key : 
NULL
;

60 
ªt
;

70 
	`©omic_ªad
(&
s
->
˛
.
ªmaöög
Ë& 
CLOSURE_WAITING
)

71 
	`˛osuª_sync
(&
s
->
˛
);

74 i‡(!
›
->
ª∂a˚
)

75 
jou∫Æ_ªf
 = 
	`bch_jou∫Æ
(
›
->
c
, &›->
ö£π_keys
,

76 
›
->
Êush_jou∫Æ
 ? 
˛
 : 
NULL
);

78 
ªt
 = 
	`bch_båì_ö£π
(
›
->
c
, &›->
ö£π_keys
,

79 
jou∫Æ_ªf
, 
ª∂a˚_key
);

80 i‡(
ªt
 =-
ESRCH
) {

81 
›
->
ª∂a˚_cﬁlisi⁄
 = 
åue
;

82 } i‡(
ªt
) {

83 
›
->
îr‹
 = -
ENOMEM
;

84 
›
->
ö£π_d©a_d⁄e
 = 
åue
;

87 i‡(
jou∫Æ_ªf
)

88 
	`©omic_dec_bug
(
jou∫Æ_ªf
);

90 i‡(!
›
->
ö£π_d©a_d⁄e
)

91 
	`c⁄töue_©
(
˛
, 
bch_d©a_ö£π_°¨t
, 
›
->
wq
);

93 
	`bch_keyli°_‰ì
(&
›
->
ö£π_keys
);

94 
	`˛osuª_ªtu∫
(
˛
);

95 
	}
}

97 
	$bch_keyli°_ªÆloc
(
keyli°
 *
l
, 
u64s
,

98 
ˇche_£t
 *
c
)

100 
size_t
 
ﬁdsize
 = 
	`bch_keyli°_nkeys
(
l
);

101 
size_t
 
√wsize
 = 
ﬁdsize
 + 
u64s
;

109 i‡(
√wsize
 * (
uöt64_t
Ë> 
	`block_byãs
(
c
Ë- (
j£t
))

110  -
ENOMEM
;

112  
	`__bch_keyli°_ªÆloc
(
l
, 
u64s
);

113 
	}
}

115 
	$bch_d©a_övÆid©e
(
˛osuª
 *
˛
)

117 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

118 
bio
 *biÿ
›
->bio;

120 
	`¥_debug
("invalidating %i sectors from %llu",

121 
	`bio_£˘‹s
(
bio
), (
uöt64_t
Ëbio->
bi_ôî
.
bi_£˘‹
);

123 
	`bio_£˘‹s
(
bio
)) {

124 
£˘‹s
 = 
	`mö
(
	`bio_£˘‹s
(
bio
),

125 1U << (
KEY_SIZE_BITS
 - 1));

127 i‡(
	`bch_keyli°_ªÆloc
(&
›
->
ö£π_keys
, 2, op->
c
))

128 
out
;

130 
bio
->
bi_ôî
.
bi_£˘‹
 +
£˘‹s
;

131 
bio
->
bi_ôî
.
bi_size
 -
£˘‹s
 << 9;

133 
	`bch_keyli°_add
(&
›
->
ö£π_keys
,

134 &
	`KEY
(
›
->
öode
, 
bio
->
bi_ôî
.
bi_£˘‹
, 
£˘‹s
));

137 
›
->
ö£π_d©a_d⁄e
 = 
åue
;

138 
	`bio_put
(
bio
);

139 
out
:

140 
	`c⁄töue_©
(
˛
, 
bch_d©a_ö£π_keys
, 
›
->
wq
);

141 
	}
}

143 
	$bch_d©a_ö£π_îr‹
(
˛osuª
 *
˛
)

145 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

156 
bkey
 *
§c
 = 
›
->
ö£π_keys
.
keys
, *
d°
 = op->insert_keys.keys;

158 
§c
 !
›
->
ö£π_keys
.
t›
) {

159 
bkey
 *
n
 = 
	`bkey_√xt
(
§c
);

161 
	`SET_KEY_PTRS
(
§c
, 0);

162 
	`memmove
(
d°
, 
§c
, 
	`bkey_byãs
(src));

164 
d°
 = 
	`bkey_√xt
(dst);

165 
§c
 = 
n
;

168 
›
->
ö£π_keys
.
t›
 = 
d°
;

170 
	`bch_d©a_ö£π_keys
(
˛
);

171 
	}
}

173 
	$bch_d©a_ö£π_ídio
(
bio
 *bio, 
îr‹
)

175 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

176 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

178 i‡(
îr‹
) {

180 i‡(
›
->
wrôeback
)

181 
›
->
îr‹
 =Érror;

182 i‡(!
›
->
ª∂a˚
)

183 
	`£t_˛osuª_‚
(
˛
, 
bch_d©a_ö£π_îr‹
, 
›
->
wq
);

185 
	`£t_˛osuª_‚
(
˛
, 
NULL
, NULL);

188 
	`bch_bbio_ídio
(
›
->
c
, 
bio
, 
îr‹
, "writing dataÅo cache");

189 
	}
}

191 
	$bch_d©a_ö£π_°¨t
(
˛osuª
 *
˛
)

193 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

194 
bio
 *biÿ
›
->bio, *
n
;

196 i‡(
	`©omic_sub_ªtu∫
(
	`bio_£˘‹s
(
bio
), &
›
->
c
->
£˘‹s_to_gc
) < 0) {

197 
	`£t_gc_£˘‹s
(
›
->
c
);

198 
	`wake_up_gc
(
›
->
c
);

201 i‡(
›
->
by∑ss
)

202  
	`bch_d©a_övÆid©e
(
˛
);

208 
bio
->
bi_rw
 &~(
REQ_FLUSH
|
REQ_FUA
);

211 
i
;

212 
bkey
 *
k
;

213 
bio_£t
 *
•lô
 = 
›
->
c
->
bio_•lô
;

216 i‡(
	`bch_keyli°_ªÆloc
(&
›
->
ö£π_keys
,

217 3 + (
›
->
csum
 ? 1 : 0),

218 
›
->
c
))

219 
	`c⁄töue_©
(
˛
, 
bch_d©a_ö£π_keys
, 
›
->
wq
);

221 
k
 = 
›
->
ö£π_keys
.
t›
;

222 
	`bkey_öô
(
k
);

223 
	`SET_KEY_INODE
(
k
, 
›
->
öode
);

224 
	`SET_KEY_OFFSET
(
k
, 
bio
->
bi_ôî
.
bi_£˘‹
);

226 i‡(!
	`bch_Æloc_£˘‹s
(
›
->
c
, 
k
, 
	`bio_£˘‹s
(
bio
),

227 
›
->
wrôe_poöt
, op->
wrôe_¥io
,

228 
›
->
wrôeback
))

229 
îr
;

231 
n
 = 
	`bio_√xt_•lô
(
bio
, 
	`KEY_SIZE
(
k
), 
GFP_NOIO
, 
•lô
);

233 
n
->
bi_íd_io
 = 
bch_d©a_ö£π_ídio
;

234 
n
->
bi_¥iv©e
 = 
˛
;

236 i‡(
›
->
wrôeback
) {

237 
	`SET_KEY_DIRTY
(
k
, 
åue
);

239 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++)

240 
	`SET_GC_MARK
(
	`PTR_BUCKET
(
›
->
c
, 
k
, 
i
),

241 
GC_MARK_DIRTY
);

244 
	`SET_KEY_CSUM
(
k
, 
›
->
csum
);

245 i‡(
	`KEY_CSUM
(
k
))

246 
	`bio_csum
(
n
, 
k
);

248 
	`åa˚_bˇche_ˇche_ö£π
(
k
);

249 
	`bch_keyli°_push
(&
›
->
ö£π_keys
);

251 
n
->
bi_rw
 |
REQ_WRITE
;

252 
	`bch_submô_bbio
(
n
, 
›
->
c
, 
k
, 0);

253 } 
n
 !
bio
);

255 
›
->
ö£π_d©a_d⁄e
 = 
åue
;

256 
	`c⁄töue_©
(
˛
, 
bch_d©a_ö£π_keys
, 
›
->
wq
);

257 
îr
:

259 
	`BUG_ON
(
›
->
wrôeback
);

267 i‡(!
›
->
ª∂a˚
) {

274 
›
->
by∑ss
 = 
åue
;

275  
	`bch_d©a_övÆid©e
(
˛
);

281 
›
->
ö£π_d©a_d⁄e
 = 
åue
;

282 
	`bio_put
(
bio
);

284 i‡(!
	`bch_keyli°_em±y
(&
›
->
ö£π_keys
))

285 
	`c⁄töue_©
(
˛
, 
bch_d©a_ö£π_keys
, 
›
->
wq
);

287 
	`˛osuª_ªtu∫
(
˛
);

289 
	}
}

310 
	$bch_d©a_ö£π
(
˛osuª
 *
˛
)

312 
d©a_ö£π_›
 *
›
 = 
	`c⁄èöî_of
(
˛
, data_insert_op, cl);

314 
	`åa˚_bˇche_wrôe
(
›
->
c
, op->
öode
, op->
bio
,

315 
›
->
wrôeback
, op->
by∑ss
);

317 
	`bch_keyli°_öô
(&
›
->
ö£π_keys
);

318 
	`bio_gë
(
›
->
bio
);

319 
	`bch_d©a_ö£π_°¨t
(
˛
);

320 
	}
}

324 
	$bch_gë_c⁄ge°ed
(
ˇche_£t
 *
c
)

326 
i
;

327 
ønd
;

329 i‡(!
c
->
c⁄ge°ed_ªad_thªshﬁd_us
 &&

330 !
c
->
c⁄ge°ed_wrôe_thªshﬁd_us
)

333 
i
 = (
	`loˇl_˛ock_us
(Ë- 
c
->
c⁄ge°ed_œ°_us
) / 1024;

334 i‡(
i
 < 0)

337 
i
 +
	`©omic_ªad
(&
c
->
c⁄ge°ed
);

338 i‡(
i
 >= 0)

341 
i
 +
CONGESTED_MAX
;

343 i‡(
i
 > 0)

344 
i
 = 
	`‰a˘_exp_two
(i, 6);

346 
ønd
 = 
	`gë_øndom_öt
();

347 
i
 -
	`bôm≠_weight
(&
ønd
, 
BITS_PER_LONG
);

349  
i
 > 0 ? i : 1;

350 
	}
}

352 
	$add_£quítül
(
èsk_°ru˘
 *
t
)

354 
	`ewma_add
(
t
->
£quítül_io_avg
,

355 
t
->
£quítül_io
, 8, 0);

357 
t
->
£quítül_io
 = 0;

358 
	}
}

360 
hli°_hód
 *
	$iohash
(
ˇched_dev
 *
dc
, 
uöt64_t
 
k
)

362  &
dc
->
io_hash
[
	`hash_64
(
k
, 
RECENT_IO_BITS
)];

363 
	}
}

365 
boﬁ
 
	$check_should_by∑ss
(
ˇched_dev
 *
dc
, 
bio
 *bio)

367 
ˇche_£t
 *
c
 = 
dc
->
disk
.c;

368 
mode
 = 
	`ˇche_mode
(
dc
, 
bio
);

369 
£˘‹s
, 
c⁄ge°ed
 = 
	`bch_gë_c⁄ge°ed
(
c
);

370 
èsk_°ru˘
 *
èsk
 = 
cuºít
;

371 
io
 *
i
;

373 i‡(
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
) ||

374 
c
->
gc_°©s
.
ö_u£
 > 
CUTOFF_CACHE_ADD
 ||

375 (
bio
->
bi_rw
 & 
REQ_DISCARD
))

376 
skù
;

378 i‡(
mode
 =
CACHE_MODE_NONE
 ||

379 (
mode
 =
CACHE_MODE_WRITEAROUND
 &&

380 (
bio
->
bi_rw
 & 
REQ_WRITE
)))

381 
skù
;

383 i‡(
bio
->
bi_ôî
.
bi_£˘‹
 & (
c
->
sb
.
block_size
 - 1) ||

384 
	`bio_£˘‹s
(
bio
Ë& (
c
->
sb
.
block_size
 - 1)) {

385 
	`¥_debug
("skipping unaligned io");

386 
skù
;

389 i‡(
	`by∑ss_t‹tuª_ã°
(
dc
)) {

390 i‡((
	`gë_øndom_öt
() & 3) == 3)

391 
skù
;

393 
ªsˇÀ
;

396 i‡(!
c⁄ge°ed
 && !
dc
->
£quítül_cutoff
)

397 
ªsˇÀ
;

399 i‡(!
c⁄ge°ed
 &&

400 
mode
 =
CACHE_MODE_WRITEBACK
 &&

401 (
bio
->
bi_rw
 & 
REQ_WRITE
) &&

402 (
bio
->
bi_rw
 & 
REQ_SYNC
))

403 
ªsˇÀ
;

405 
	`•ö_lock
(&
dc
->
io_lock
);

407 
	`hli°_f‹_óch_íåy
(
i
, 
	`iohash
(
dc
, 
bio
->
bi_ôî
.
bi_£˘‹
), 
hash
)

408 i‡(
i
->
œ°
 =
bio
->
bi_ôî
.
bi_£˘‹
 &&

409 
	`time_bef‹e
(
jiffõs
, 
i
->jiffies))

410 
found
;

412 
i
 = 
	`li°_fú°_íåy
(&
dc
->
io_Ãu
, 
io
, 
Ãu
);

414 
	`add_£quítül
(
èsk
);

415 
i
->
£quítül
 = 0;

416 
found
:

417 i‡(
i
->
£quítül
 + 
bio
->
bi_ôî
.
bi_size
 > i->sequential)

418 
i
->
£quítül
 +
bio
->
bi_ôî
.
bi_size
;

420 
i
->
œ°
 = 
	`bio_íd_£˘‹
(
bio
);

421 
i
->
jiffõs
 = jiffõ†+ 
	`m£cs_to_jiffõs
(5000);

422 
èsk
->
£quítül_io
 = 
i
->
£quítül
;

424 
	`hli°_dñ
(&
i
->
hash
);

425 
	`hli°_add_hód
(&
i
->
hash
, 
	`iohash
(
dc
, i->
œ°
));

426 
	`li°_move_èû
(&
i
->
Ãu
, &
dc
->
io_Ãu
);

428 
	`•ö_u∆ock
(&
dc
->
io_lock
);

430 
£˘‹s
 = 
	`max
(
èsk
->
£quítül_io
,

431 
èsk
->
£quítül_io_avg
) >> 9;

433 i‡(
dc
->
£quítül_cutoff
 &&

434 
£˘‹s
 >
dc
->
£quítül_cutoff
 >> 9) {

435 
	`åa˚_bˇche_by∑ss_£quítül
(
bio
);

436 
skù
;

439 i‡(
c⁄ge°ed
 && 
£˘‹s
 >= congested) {

440 
	`åa˚_bˇche_by∑ss_c⁄ge°ed
(
bio
);

441 
skù
;

444 
ªsˇÀ
:

445 
	`bch_ªsˇÀ_¥i‹ôõs
(
c
, 
	`bio_£˘‹s
(
bio
));

446  
Ál£
;

447 
skù
:

448 
	`bch_m¨k_£˘‹s_by∑s£d
(
c
, 
dc
, 
	`bio_£˘‹s
(
bio
));

449  
åue
;

450 
	}
}

454 
	s£¨ch
 {

456 
˛osuª
 
	m˛
;

458 
bbio
 
	mbio
;

459 
bio
 *
	m‹ig_bio
;

460 
bio
 *
	mˇche_miss
;

461 
bˇche_devi˚
 *
	md
;

463 
	mö£π_bio_£˘‹s
;

464 
	mªcovîabÀ
:1;

465 
	mwrôe
:1;

466 
	mªad_dúty_d©a
:1;

468 
	m°¨t_time
;

470 
båì_›
 
	m›
;

471 
d©a_ö£π_›
 
	mi›
;

474 
	$bch_ˇche_ªad_ídio
(
bio
 *bio, 
îr‹
)

476 
bbio
 *
b
 = 
	`c⁄èöî_of
(
bio
, bbio, bio);

477 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

478 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

487 i‡(
îr‹
)

488 
s
->
i›
.
îr‹
 =Érror;

489 i‡(!
	`KEY_DIRTY
(&
b
->
key
) &&

490 
	`±r_°Æe
(
s
->
i›
.
c
, &
b
->
key
, 0)) {

491 
	`©omic_l⁄g_öc
(&
s
->
i›
.
c
->
ˇche_ªad_ø˚s
);

492 
s
->
i›
.
îr‹
 = -
EINTR
;

495 
	`bch_bbio_ídio
(
s
->
i›
.
c
, 
bio
, 
îr‹
, "reading from cache");

496 
	}
}

502 
	$ˇche_lookup_‚
(
båì_›
 *
›
, 
båì
 *
b
, 
bkey
 *
k
)

504 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
›
, search, op);

505 
bio
 *
n
, *biÿ&
s
->bio.bio;

506 
bkey
 *
bio_key
;

507 
±r
;

509 i‡(
	`bkey_cmp
(
k
, &
	`KEY
(
s
->
i›
.
öode
, 
bio
->
bi_ôî
.
bi_£˘‹
, 0)) <= 0)

510  
MAP_CONTINUE
;

512 i‡(
	`KEY_INODE
(
k
Ë!
s
->
i›
.
öode
 ||

513 
	`KEY_START
(
k
Ë> 
bio
->
bi_ôî
.
bi_£˘‹
) {

514 
bio_£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

515 
£˘‹s
 = 
	`KEY_INODE
(
k
Ë=
s
->
i›
.
öode


516 ? 
	`mö_t
(
uöt64_t
, 
INT_MAX
,

517 
	`KEY_START
(
k
Ë- 
bio
->
bi_ôî
.
bi_£˘‹
)

518 : 
INT_MAX
;

520 
ªt
 = 
s
->
d
->
	`ˇche_miss
(
b
, s, 
bio
, 
£˘‹s
);

521 i‡(
ªt
 !
MAP_CONTINUE
)

522  
ªt
;

525 
	`BUG_ON
(
bio_£˘‹s
 <
£˘‹s
);

528 i‡(!
	`KEY_SIZE
(
k
))

529  
MAP_CONTINUE
;

532 
±r
 = 0;

534 
	`PTR_BUCKET
(
b
->
c
, 
k
, 
±r
)->
¥io
 = 
INITIAL_PRIO
;

536 i‡(
	`KEY_DIRTY
(
k
))

537 
s
->
ªad_dúty_d©a
 = 
åue
;

539 
n
 = 
	`bio_√xt_•lô
(
bio
, 
	`mö_t
(
uöt64_t
, 
INT_MAX
,

540 
	`KEY_OFFSET
(
k
Ë- 
bio
->
bi_ôî
.
bi_£˘‹
),

541 
GFP_NOIO
, 
s
->
d
->
bio_•lô
);

543 
bio_key
 = &
	`c⁄èöî_of
(
n
, 
bbio
, 
bio
)->
key
;

544 
	`bch_bkey_c›y_sögÀ_±r
(
bio_key
, 
k
, 
±r
);

546 
	`bch_cut_‰⁄t
(&
	`KEY
(
s
->
i›
.
öode
, 
n
->
bi_ôî
.
bi_£˘‹
, 0), 
bio_key
);

547 
	`bch_cut_back
(&
	`KEY
(
s
->
i›
.
öode
, 
	`bio_íd_£˘‹
(
n
), 0), 
bio_key
);

549 
n
->
bi_íd_io
 = 
bch_ˇche_ªad_ídio
;

550 
n
->
bi_¥iv©e
 = &
s
->
˛
;

563 
	`__bch_submô_bbio
(
n
, 
b
->
c
);

564  
n
 =
bio
 ? 
MAP_DONE
 : 
MAP_CONTINUE
;

565 
	}
}

567 
	$ˇche_lookup
(
˛osuª
 *
˛
)

569 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, £¨ch, 
i›
.cl);

570 
bio
 *biÿ&
s
->bio.bio;

571 
ªt
;

573 
	`bch_båì_›_öô
(&
s
->
›
, -1);

575 
ªt
 = 
	`bch_båì_m≠_keys
(&
s
->
›
, s->
i›
.
c
,

576 &
	`KEY
(
s
->
i›
.
öode
, 
bio
->
bi_ôî
.
bi_£˘‹
, 0),

577 
ˇche_lookup_‚
, 
MAP_END_KEY
);

578 i‡(
ªt
 =-
EAGAIN
)

579 
	`c⁄töue_©
(
˛
, 
ˇche_lookup
, 
bˇche_wq
);

581 
	`˛osuª_ªtu∫
(
˛
);

582 
	}
}

586 
	$ªque°_ídio
(
bio
 *bio, 
îr‹
)

588 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

590 i‡(
îr‹
) {

591 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

592 
s
->
i›
.
îr‹
 =Érror;

594 
s
->
ªcovîabÀ
 = 
Ál£
;

597 
	`bio_put
(
bio
);

598 
	`˛osuª_put
(
˛
);

599 
	}
}

601 
	$bio_com∂ëe
(
£¨ch
 *
s
)

603 i‡(
s
->
‹ig_bio
) {

604 
˝u
, 
rw
 = 
	`bio_d©a_dú
(
s
->
‹ig_bio
);

605 
duøti⁄
 = 
jiffõs
 - 
s
->
°¨t_time
;

607 
˝u
 = 
	`∑π_°©_lock
();

608 
	`∑π_round_°©s
(
˝u
, &
s
->
d
->
disk
->
∑π0
);

609 
	`∑π_°©_add
(
˝u
, &
s
->
d
->
disk
->
∑π0
, 
ticks
[
rw
], 
duøti⁄
);

610 
	`∑π_°©_u∆ock
();

612 
	`åa˚_bˇche_ªque°_íd
(
s
->
d
, s->
‹ig_bio
);

613 
	`bio_ídio
(
s
->
‹ig_bio
, s->
i›
.
îr‹
);

614 
s
->
‹ig_bio
 = 
NULL
;

616 
	}
}

618 
	$do_bio_hook
(
£¨ch
 *
s
, 
bio
 *
‹ig_bio
)

620 
bio
 *biÿ&
s
->bio.bio;

622 
	`bio_öô
(
bio
);

623 
	`__bio_˛⁄e_Á°
(
bio
, 
‹ig_bio
);

624 
bio
->
bi_íd_io
 = 
ªque°_ídio
;

625 
bio
->
bi_¥iv©e
 = &
s
->
˛
;

627 
	`©omic_£t
(&
bio
->
bi_˙t
, 3);

628 
	}
}

630 
	$£¨ch_‰ì
(
˛osuª
 *
˛
)

632 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

633 
	`bio_com∂ëe
(
s
);

635 i‡(
s
->
i›
.
bio
)

636 
	`bio_put
(
s
->
i›
.
bio
);

638 
	`˛osuª_debug_de°roy
(
˛
);

639 
	`mempoﬁ_‰ì
(
s
, s->
d
->
c
->
£¨ch
);

640 
	}
}

642 
ölöe
 
£¨ch
 *
	$£¨ch_Æloc
(
bio
 *bio,

643 
bˇche_devi˚
 *
d
)

645 
£¨ch
 *
s
;

647 
s
 = 
	`mempoﬁ_Æloc
(
d
->
c
->
£¨ch
, 
GFP_NOIO
);

649 
	`˛osuª_öô
(&
s
->
˛
, 
NULL
);

650 
	`do_bio_hook
(
s
, 
bio
);

652 
s
->
‹ig_bio
 = 
bio
;

653 
s
->
ˇche_miss
 = 
NULL
;

654 
s
->
d
 = d;

655 
s
->
ªcovîabÀ
 = 1;

656 
s
->
wrôe
 = (
bio
->
bi_rw
 & 
REQ_WRITE
) != 0;

657 
s
->
ªad_dúty_d©a
 = 0;

658 
s
->
°¨t_time
 = 
jiffõs
;

660 
s
->
i›
.
c
 = 
d
->c;

661 
s
->
i›
.
bio
 = 
NULL
;

662 
s
->
i›
.
öode
 = 
d
->
id
;

663 
s
->
i›
.
wrôe_poöt
 = 
	`hash_l⁄g
((Ë
cuºít
, 16);

664 
s
->
i›
.
wrôe_¥io
 = 0;

665 
s
->
i›
.
îr‹
 = 0;

666 
s
->
i›
.
Êags
 = 0;

667 
s
->
i›
.
Êush_jou∫Æ
 = (
bio
->
bi_rw
 & (
REQ_FLUSH
|
REQ_FUA
)) != 0;

668 
s
->
i›
.
wq
 = 
bˇche_wq
;

670  
s
;

671 
	}
}

675 
	$ˇched_dev_bio_com∂ëe
(
˛osuª
 *
˛
)

677 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

678 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
s
->
d
, ˇched_dev, 
disk
);

680 
	`£¨ch_‰ì
(
˛
);

681 
	`ˇched_dev_put
(
dc
);

682 
	}
}

686 
	$ˇched_dev_ˇche_miss_d⁄e
(
˛osuª
 *
˛
)

688 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

690 i‡(
s
->
i›
.
ª∂a˚_cﬁlisi⁄
)

691 
	`bch_m¨k_ˇche_miss_cﬁlisi⁄
(
s
->
i›
.
c
, s->
d
);

693 i‡(
s
->
i›
.
bio
) {

694 
i
;

695 
bio_vec
 *
bv
;

697 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
s
->
i›
.
bio
, 
i
)

698 
	`__‰ì_∑ge
(
bv
->
bv_∑ge
);

701 
	`ˇched_dev_bio_com∂ëe
(
˛
);

702 
	}
}

704 
	$ˇched_dev_ªad_îr‹
(
˛osuª
 *
˛
)

706 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

707 
bio
 *biÿ&
s
->bio.bio;

709 i‡(
s
->
ªcovîabÀ
) {

711 
	`åa˚_bˇche_ªad_ªåy
(
s
->
‹ig_bio
);

713 
s
->
i›
.
îr‹
 = 0;

714 
	`do_bio_hook
(
s
, s->
‹ig_bio
);

718 
	`˛osuª_bio_submô
(
bio
, 
˛
, 
s
->
d
);

721 
	`c⁄töue_©
(
˛
, 
ˇched_dev_ˇche_miss_d⁄e
, 
NULL
);

722 
	}
}

724 
	$ˇched_dev_ªad_d⁄e
(
˛osuª
 *
˛
)

726 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

727 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
s
->
d
, ˇched_dev, 
disk
);

737 i‡(
s
->
i›
.
bio
) {

738 
	`bio_ª£t
(
s
->
i›
.
bio
);

739 
s
->
i›
.
bio
->
bi_ôî
.
bi_£˘‹
 = s->
ˇche_miss
->bi_iter.bi_sector;

740 
s
->
i›
.
bio
->
bi_bdev
 = s->
ˇche_miss
->bi_bdev;

741 
s
->
i›
.
bio
->
bi_ôî
.
bi_size
 = s->
ö£π_bio_£˘‹s
 << 9;

742 
	`bch_bio_m≠
(
s
->
i›
.
bio
, 
NULL
);

744 
	`bio_c›y_d©a
(
s
->
ˇche_miss
, s->
i›
.
bio
);

746 
	`bio_put
(
s
->
ˇche_miss
);

747 
s
->
ˇche_miss
 = 
NULL
;

750 i‡(
	`vîify
(
dc
, &
s
->
bio
.bioË&& s->
ªcovîabÀ
 && !s->
ªad_dúty_d©a
)

751 
	`bch_d©a_vîify
(
dc
, 
s
->
‹ig_bio
);

753 
	`bio_com∂ëe
(
s
);

755 i‡(
s
->
i›
.
bio
 &&

756 !
	`ã°_bô
(
CACHE_SET_STOPPING
, &
s
->
i›
.
c
->
Êags
)) {

757 
	`BUG_ON
(!
s
->
i›
.
ª∂a˚
);

758 
	`˛osuª_ˇŒ
(&
s
->
i›
.
˛
, 
bch_d©a_ö£π
, 
NULL
, cl);

761 
	`c⁄töue_©
(
˛
, 
ˇched_dev_ˇche_miss_d⁄e
, 
NULL
);

762 
	}
}

764 
	$ˇched_dev_ªad_d⁄e_bh
(
˛osuª
 *
˛
)

766 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

767 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
s
->
d
, ˇched_dev, 
disk
);

769 
	`bch_m¨k_ˇche_accou¡ög
(
s
->
i›
.
c
, s->
d
,

770 !
s
->
ˇche_miss
, s->
i›
.
by∑ss
);

771 
	`åa˚_bˇche_ªad
(
s
->
‹ig_bio
, !s->
ˇche_miss
, s->
i›
.
by∑ss
);

773 i‡(
s
->
i›
.
îr‹
)

774 
	`c⁄töue_©_nob¨rõr
(
˛
, 
ˇched_dev_ªad_îr‹
, 
bˇche_wq
);

775 i‡(
s
->
i›
.
bio
 || 
	`vîify
(
dc
, &s->bio.bio))

776 
	`c⁄töue_©_nob¨rõr
(
˛
, 
ˇched_dev_ªad_d⁄e
, 
bˇche_wq
);

778 
	`c⁄töue_©_nob¨rõr
(
˛
, 
ˇched_dev_bio_com∂ëe
, 
NULL
);

779 
	}
}

781 
	$ˇched_dev_ˇche_miss
(
båì
 *
b
, 
£¨ch
 *
s
,

782 
bio
 *bio, 
£˘‹s
)

784 
ªt
 = 
MAP_CONTINUE
;

785 
ªada
 = 0;

786 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
s
->
d
, ˇched_dev, 
disk
);

787 
bio
 *
miss
, *
ˇche_bio
;

789 i‡(
s
->
ˇche_miss
 || s->
i›
.
by∑ss
) {

790 
miss
 = 
	`bio_√xt_•lô
(
bio
, 
£˘‹s
, 
GFP_NOIO
, 
s
->
d
->
bio_•lô
);

791 
ªt
 = 
miss
 =
bio
 ? 
MAP_DONE
 : 
MAP_CONTINUE
;

792 
out_submô
;

795 i‡(!(
bio
->
bi_rw
 & 
REQ_RAHEAD
) &&

796 !(
bio
->
bi_rw
 & 
REQ_META
) &&

797 
s
->
i›
.
c
->
gc_°©s
.
ö_u£
 < 
CUTOFF_CACHE_READA
)

798 
ªada
 = 
	`mö_t
(
£˘‹_t
, 
dc
->
ªadahód
 >> 9,

799 
	`bdev_£˘‹s
(
bio
->
bi_bdev
Ë- 
	`bio_íd_£˘‹
(bio));

801 
s
->
ö£π_bio_£˘‹s
 = 
	`mö
(
£˘‹s
, 
	`bio_£˘‹s
(
bio
Ë+ 
ªada
);

803 
s
->
i›
.
ª∂a˚_key
 = 
	`KEY
(s->i›.
öode
,

804 
bio
->
bi_ôî
.
bi_£˘‹
 + 
s
->
ö£π_bio_£˘‹s
,

805 
s
->
ö£π_bio_£˘‹s
);

807 
ªt
 = 
	`bch_båì_ö£π_check_key
(
b
, &
s
->
›
, &s->
i›
.
ª∂a˚_key
);

808 i‡(
ªt
)

809  
ªt
;

811 
s
->
i›
.
ª∂a˚
 = 
åue
;

813 
miss
 = 
	`bio_√xt_•lô
(
bio
, 
£˘‹s
, 
GFP_NOIO
, 
s
->
d
->
bio_•lô
);

816 
ªt
 = 
miss
 =
bio
 ? 
MAP_DONE
 : -
EINTR
;

818 
ˇche_bio
 = 
	`bio_Æloc_bio£t
(
GFP_NOWAIT
,

819 
	`DIV_ROUND_UP
(
s
->
ö£π_bio_£˘‹s
, 
PAGE_SECTORS
),

820 
dc
->
disk
.
bio_•lô
);

821 i‡(!
ˇche_bio
)

822 
out_submô
;

824 
ˇche_bio
->
bi_ôî
.
bi_£˘‹
 = 
miss
->bi_iter.bi_sector;

825 
ˇche_bio
->
bi_bdev
 = 
miss
->bi_bdev;

826 
ˇche_bio
->
bi_ôî
.
bi_size
 = 
s
->
ö£π_bio_£˘‹s
 << 9;

828 
ˇche_bio
->
bi_íd_io
 = 
ªque°_ídio
;

829 
ˇche_bio
->
bi_¥iv©e
 = &
s
->
˛
;

831 
	`bch_bio_m≠
(
ˇche_bio
, 
NULL
);

832 i‡(
	`bio_Æloc_∑ges
(
ˇche_bio
, 
__GFP_NOWARN
|
GFP_NOIO
))

833 
out_put
;

835 i‡(
ªada
)

836 
	`bch_m¨k_ˇche_ªadahód
(
s
->
i›
.
c
, s->
d
);

838 
s
->
ˇche_miss
 = 
miss
;

839 
s
->
i›
.
bio
 = 
ˇche_bio
;

840 
	`bio_gë
(
ˇche_bio
);

841 
	`˛osuª_bio_submô
(
ˇche_bio
, &
s
->
˛
, s->
d
);

843  
ªt
;

844 
out_put
:

845 
	`bio_put
(
ˇche_bio
);

846 
out_submô
:

847 
miss
->
bi_íd_io
 = 
ªque°_ídio
;

848 
miss
->
bi_¥iv©e
 = &
s
->
˛
;

849 
	`˛osuª_bio_submô
(
miss
, &
s
->
˛
, s->
d
);

850  
ªt
;

851 
	}
}

853 
	$ˇched_dev_ªad
(
ˇched_dev
 *
dc
, 
£¨ch
 *
s
)

855 
˛osuª
 *
˛
 = &
s
->cl;

857 
	`˛osuª_ˇŒ
(&
s
->
i›
.
˛
, 
ˇche_lookup
, 
NULL
, cl);

858 
	`c⁄töue_©
(
˛
, 
ˇched_dev_ªad_d⁄e_bh
, 
NULL
);

859 
	}
}

863 
	$ˇched_dev_wrôe_com∂ëe
(
˛osuª
 *
˛
)

865 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

866 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
s
->
d
, ˇched_dev, 
disk
);

868 
	`up_ªad_n⁄_ow√r
(&
dc
->
wrôeback_lock
);

869 
	`ˇched_dev_bio_com∂ëe
(
˛
);

870 
	}
}

872 
	$ˇched_dev_wrôe
(
ˇched_dev
 *
dc
, 
£¨ch
 *
s
)

874 
˛osuª
 *
˛
 = &
s
->cl;

875 
bio
 *biÿ&
s
->bio.bio;

876 
bkey
 
°¨t
 = 
	`KEY
(
dc
->
disk
.
id
, 
bio
->
bi_ôî
.
bi_£˘‹
, 0);

877 
bkey
 
íd
 = 
	`KEY
(
dc
->
disk
.
id
, 
	`bio_íd_£˘‹
(
bio
), 0);

879 
	`bch_keybuf_check_ovîœµög
(&
s
->
i›
.
c
->
movög_gc_keys
, &
°¨t
, &
íd
);

881 
	`down_ªad_n⁄_ow√r
(&
dc
->
wrôeback_lock
);

882 i‡(
	`bch_keybuf_check_ovîœµög
(&
dc
->
wrôeback_keys
, &
°¨t
, &
íd
)) {

887 
s
->
i›
.
by∑ss
 = 
Ál£
;

888 
s
->
i›
.
wrôeback
 = 
åue
;

898 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

899 
s
->
i›
.
by∑ss
 = 
åue
;

901 i‡(
	`should_wrôeback
(
dc
, 
s
->
‹ig_bio
,

902 
	`ˇche_mode
(
dc
, 
bio
),

903 
s
->
i›
.
by∑ss
)) {

904 
s
->
i›
.
by∑ss
 = 
Ál£
;

905 
s
->
i›
.
wrôeback
 = 
åue
;

908 i‡(
s
->
i›
.
by∑ss
) {

909 
s
->
i›
.
bio
 = s->
‹ig_bio
;

910 
	`bio_gë
(
s
->
i›
.
bio
);

912 i‡(!(
bio
->
bi_rw
 & 
REQ_DISCARD
) ||

913 
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
dc
->
bdev
)))

914 
	`˛osuª_bio_submô
(
bio
, 
˛
, 
s
->
d
);

915 } i‡(
s
->
i›
.
wrôeback
) {

916 
	`bch_wrôeback_add
(
dc
);

917 
s
->
i›
.
bio
 = bio;

919 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

921 
bio
 *
Êush
 = 
	`bio_Æloc_bio£t
(
GFP_NOIO
, 0,

922 
dc
->
disk
.
bio_•lô
);

924 
Êush
->
bi_rw
 = 
WRITE_FLUSH
;

925 
Êush
->
bi_bdev
 = 
bio
->bi_bdev;

926 
Êush
->
bi_íd_io
 = 
ªque°_ídio
;

927 
Êush
->
bi_¥iv©e
 = 
˛
;

929 
	`˛osuª_bio_submô
(
Êush
, 
˛
, 
s
->
d
);

932 
s
->
i›
.
bio
 = 
	`bio_˛⁄e_Á°
(bio, 
GFP_NOIO
, 
dc
->
disk
.
bio_•lô
);

934 
	`˛osuª_bio_submô
(
bio
, 
˛
, 
s
->
d
);

937 
	`˛osuª_ˇŒ
(&
s
->
i›
.
˛
, 
bch_d©a_ö£π
, 
NULL
, cl);

938 
	`c⁄töue_©
(
˛
, 
ˇched_dev_wrôe_com∂ëe
, 
NULL
);

939 
	}
}

941 
	$ˇched_dev_nod©a
(
˛osuª
 *
˛
)

943 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

944 
bio
 *biÿ&
s
->bio.bio;

946 i‡(
s
->
i›
.
Êush_jou∫Æ
)

947 
	`bch_jou∫Æ_mëa
(
s
->
i›
.
c
, 
˛
);

950 
	`˛osuª_bio_submô
(
bio
, 
˛
, 
s
->
d
);

952 
	`c⁄töue_©
(
˛
, 
ˇched_dev_bio_com∂ëe
, 
NULL
);

953 
	}
}

957 
	$ˇched_dev_make_ªque°
(
ªque°_queue
 *
q
, 
bio
 *bio)

959 
£¨ch
 *
s
;

960 
bˇche_devi˚
 *
d
 = 
bio
->
bi_bdev
->
bd_disk
->
¥iv©e_d©a
;

961 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

962 
˝u
, 
rw
 = 
	`bio_d©a_dú
(
bio
);

964 
˝u
 = 
	`∑π_°©_lock
();

965 
	`∑π_°©_öc
(
˝u
, &
d
->
disk
->
∑π0
, 
ios
[
rw
]);

966 
	`∑π_°©_add
(
˝u
, &
d
->
disk
->
∑π0
, 
£˘‹s
[
rw
], 
	`bio_£˘‹s
(
bio
));

967 
	`∑π_°©_u∆ock
();

969 
bio
->
bi_bdev
 = 
dc
->
bdev
;

970 
bio
->
bi_ôî
.
bi_£˘‹
 +
dc
->
sb
.
d©a_off£t
;

972 i‡(
	`ˇched_dev_gë
(
dc
)) {

973 
s
 = 
	`£¨ch_Æloc
(
bio
, 
d
);

974 
	`åa˚_bˇche_ªque°_°¨t
(
s
->
d
, 
bio
);

976 i‡(!
bio
->
bi_ôî
.
bi_size
) {

981 
	`c⁄töue_©_nob¨rõr
(&
s
->
˛
,

982 
ˇched_dev_nod©a
,

983 
bˇche_wq
);

985 
s
->
i›
.
by∑ss
 = 
	`check_should_by∑ss
(
dc
, 
bio
);

987 i‡(
rw
)

988 
	`ˇched_dev_wrôe
(
dc
, 
s
);

990 
	`ˇched_dev_ªad
(
dc
, 
s
);

993 i‡((
bio
->
bi_rw
 & 
REQ_DISCARD
) &&

994 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
dc
->
bdev
)))

995 
	`bio_ídio
(
bio
, 0);

997 
	`bch_gíîic_make_ªque°
(
bio
, &
d
->
bio_•lô_hook
);

999 
	}
}

1001 
	$ˇched_dev_io˘l
(
bˇche_devi˚
 *
d
, 
fmode_t
 
mode
,

1002 
cmd
, 
¨g
)

1004 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

1005  
	`__blkdev_drivî_io˘l
(
dc
->
bdev
, 
mode
, 
cmd
, 
¨g
);

1006 
	}
}

1008 
	$ˇched_dev_c⁄ge°ed
(*
d©a
, 
bôs
)

1010 
bˇche_devi˚
 *
d
 = 
d©a
;

1011 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

1012 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dc
->
bdev
);

1013 
ªt
 = 0;

1015 i‡(
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
))

1018 i‡(
	`ˇched_dev_gë
(
dc
)) {

1019 
i
;

1020 
ˇche
 *
ˇ
;

1022 
	`f‹_óch_ˇche
(
ˇ
, 
d
->
c
, 
i
) {

1023 
q
 = 
	`bdev_gë_queue
(
ˇ
->
bdev
);

1024 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

1027 
	`ˇched_dev_put
(
dc
);

1030  
ªt
;

1031 
	}
}

1033 
	$bch_ˇched_dev_ªque°_öô
(
ˇched_dev
 *
dc
)

1035 
gídisk
 *
g
 = 
dc
->
disk
.disk;

1037 
g
->
queue
->
make_ªque°_‚
 = 
ˇched_dev_make_ªque°
;

1038 
g
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
ˇched_dev_c⁄ge°ed
;

1039 
dc
->
disk
.
ˇche_miss
 = 
ˇched_dev_ˇche_miss
;

1040 
dc
->
disk
.
io˘l
 = 
ˇched_dev_io˘l
;

1041 
	}
}

1045 
	$Êash_dev_ˇche_miss
(
båì
 *
b
, 
£¨ch
 *
s
,

1046 
bio
 *bio, 
£˘‹s
)

1048 
byãs
 = 
	`mö
(
£˘‹s
, 
	`bio_£˘‹s
(
bio
)) << 9;

1050 
	`sw≠
(
bio
->
bi_ôî
.
bi_size
, 
byãs
);

1051 
	`zîo_fûl_bio
(
bio
);

1052 
	`sw≠
(
bio
->
bi_ôî
.
bi_size
, 
byãs
);

1054 
	`bio_adv™˚
(
bio
, 
byãs
);

1056 i‡(!
bio
->
bi_ôî
.
bi_size
)

1057  
MAP_DONE
;

1059  
MAP_CONTINUE
;

1060 
	}
}

1062 
	$Êash_dev_nod©a
(
˛osuª
 *
˛
)

1064 
£¨ch
 *
s
 = 
	`c⁄èöî_of
(
˛
, search, cl);

1066 i‡(
s
->
i›
.
Êush_jou∫Æ
)

1067 
	`bch_jou∫Æ_mëa
(
s
->
i›
.
c
, 
˛
);

1069 
	`c⁄töue_©
(
˛
, 
£¨ch_‰ì
, 
NULL
);

1070 
	}
}

1072 
	$Êash_dev_make_ªque°
(
ªque°_queue
 *
q
, 
bio
 *bio)

1074 
£¨ch
 *
s
;

1075 
˛osuª
 *
˛
;

1076 
bˇche_devi˚
 *
d
 = 
bio
->
bi_bdev
->
bd_disk
->
¥iv©e_d©a
;

1077 
˝u
, 
rw
 = 
	`bio_d©a_dú
(
bio
);

1079 
˝u
 = 
	`∑π_°©_lock
();

1080 
	`∑π_°©_öc
(
˝u
, &
d
->
disk
->
∑π0
, 
ios
[
rw
]);

1081 
	`∑π_°©_add
(
˝u
, &
d
->
disk
->
∑π0
, 
£˘‹s
[
rw
], 
	`bio_£˘‹s
(
bio
));

1082 
	`∑π_°©_u∆ock
();

1084 
s
 = 
	`£¨ch_Æloc
(
bio
, 
d
);

1085 
˛
 = &
s
->cl;

1086 
bio
 = &
s
->bio.bio;

1088 
	`åa˚_bˇche_ªque°_°¨t
(
s
->
d
, 
bio
);

1090 i‡(!
bio
->
bi_ôî
.
bi_size
) {

1095 
	`c⁄töue_©_nob¨rõr
(&
s
->
˛
,

1096 
Êash_dev_nod©a
,

1097 
bˇche_wq
);

1098 } i‡(
rw
) {

1099 
	`bch_keybuf_check_ovîœµög
(&
s
->
i›
.
c
->
movög_gc_keys
,

1100 &
	`KEY
(
d
->
id
, 
bio
->
bi_ôî
.
bi_£˘‹
, 0),

1101 &
	`KEY
(
d
->
id
, 
	`bio_íd_£˘‹
(
bio
), 0));

1103 
s
->
i›
.
by∑ss
 = (
bio
->
bi_rw
 & 
REQ_DISCARD
) != 0;

1104 
s
->
i›
.
wrôeback
 = 
åue
;

1105 
s
->
i›
.
bio
 = bio;

1107 
	`˛osuª_ˇŒ
(&
s
->
i›
.
˛
, 
bch_d©a_ö£π
, 
NULL
, cl);

1109 
	`˛osuª_ˇŒ
(&
s
->
i›
.
˛
, 
ˇche_lookup
, 
NULL
, cl);

1112 
	`c⁄töue_©
(
˛
, 
£¨ch_‰ì
, 
NULL
);

1113 
	}
}

1115 
	$Êash_dev_io˘l
(
bˇche_devi˚
 *
d
, 
fmode_t
 
mode
,

1116 
cmd
, 
¨g
)

1118  -
ENOTTY
;

1119 
	}
}

1121 
	$Êash_dev_c⁄ge°ed
(*
d©a
, 
bôs
)

1123 
bˇche_devi˚
 *
d
 = 
d©a
;

1124 
ªque°_queue
 *
q
;

1125 
ˇche
 *
ˇ
;

1126 
i
;

1127 
ªt
 = 0;

1129 
	`f‹_óch_ˇche
(
ˇ
, 
d
->
c
, 
i
) {

1130 
q
 = 
	`bdev_gë_queue
(
ˇ
->
bdev
);

1131 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

1134  
ªt
;

1135 
	}
}

1137 
	$bch_Êash_dev_ªque°_öô
(
bˇche_devi˚
 *
d
)

1139 
gídisk
 *
g
 = 
d
->
disk
;

1141 
g
->
queue
->
make_ªque°_‚
 = 
Êash_dev_make_ªque°
;

1142 
g
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
Êash_dev_c⁄ge°ed
;

1143 
d
->
ˇche_miss
 = 
Êash_dev_ˇche_miss
;

1144 
d
->
io˘l
 = 
Êash_dev_io˘l
;

1145 
	}
}

1147 
	$bch_ªque°_exô
()

1149 i‡(
bch_£¨ch_ˇche
)

1150 
	`kmem_ˇche_de°roy
(
bch_£¨ch_ˇche
);

1151 
	}
}

1153 
__öô
 
	$bch_ªque°_öô
()

1155 
bch_£¨ch_ˇche
 = 
	`KMEM_CACHE
(
£¨ch
, 0);

1156 i‡(!
bch_£¨ch_ˇche
)

1157  -
ENOMEM
;

1160 
	}
}

	@bcache/request.h

1 #i‚de‡
_BCACHE_REQUEST_H_


2 
	#_BCACHE_REQUEST_H_


	)

4 
	sd©a_ö£π_›
 {

5 
˛osuª
 
	m˛
;

6 
ˇche_£t
 *
	mc
;

7 
bio
 *
	mbio
;

8 
w‹kqueue_°ru˘
 *
	mwq
;

10 
	möode
;

11 
uöt16_t
 
	mwrôe_poöt
;

12 
uöt16_t
 
	mwrôe_¥io
;

13 
	mîr‹
;

16 
uöt16_t
 
	mÊags
;

19 
	mby∑ss
:1;

20 
	mwrôeback
:1;

21 
	mÊush_jou∫Æ
:1;

22 
	mcsum
:1;

24 
	mª∂a˚
:1;

25 
	mª∂a˚_cﬁlisi⁄
:1;

27 
	mö£π_d©a_d⁄e
:1;

31 
keyli°
 
	mö£π_keys
;

32 
BKEY_PADDED
(
ª∂a˚_key
);

35 
bch_gë_c⁄ge°ed
(
ˇche_£t
 *);

36 
bch_d©a_ö£π
(
˛osuª
 *
˛
);

38 
bch_ˇched_dev_ªque°_öô
(
ˇched_dev
 *
dc
);

39 
bch_Êash_dev_ªque°_öô
(
bˇche_devi˚
 *
d
);

41 
kmem_ˇche
 *
bch_£¨ch_ˇche
, *
bch_∑s°hrough_ˇche
;

	@bcache/stats.c

7 
	~"bˇche.h
"

8 
	~"°©s.h
"

9 
	~"båì.h
"

10 
	~"sysfs.h
"

35 c⁄° 
	gDAY_RESCALE
 = 288;

36 c⁄° 
	gHOUR_RESCALE
 = 12;

37 c⁄° 
	gFIVE_MINUTE_RESCALE
 = 1;

38 c⁄° 
	gaccou¡ög_dñay
 = (
HZ
 * 300) / 22;

39 c⁄° 
	gaccou¡ög_weight
 = 32;

43 
ªad_©åibuã
(
ˇche_hôs
);

44 
ªad_©åibuã
(
ˇche_mis£s
);

45 
ªad_©åibuã
(
ˇche_by∑ss_hôs
);

46 
ªad_©åibuã
(
ˇche_by∑ss_mis£s
);

47 
ªad_©åibuã
(
ˇche_hô_øtio
);

48 
ªad_©åibuã
(
ˇche_ªadahóds
);

49 
ªad_©åibuã
(
ˇche_miss_cﬁlisi⁄s
);

50 
ªad_©åibuã
(
by∑s£d
);

52 
	$SHOW
(
bch_°©s
)

54 
ˇche_°©s
 *
s
 =

55 
	`c⁄èöî_of
(
kobj
, 
ˇche_°©s
, kobj);

56 
	#v¨
(
°©
Ë(
s
->°© >> 16)

	)

57 
	`v¨_¥öt
(
ˇche_hôs
);

58 
	`v¨_¥öt
(
ˇche_mis£s
);

59 
	`v¨_¥öt
(
ˇche_by∑ss_hôs
);

60 
	`v¨_¥öt
(
ˇche_by∑ss_mis£s
);

62 
	`sysfs_¥öt
(
ˇche_hô_øtio
,

63 
	`DIV_SAFE
(
	`v¨
(
ˇche_hôs
) * 100,

64 
	`v¨
(
ˇche_hôs
Ë+ v¨(
ˇche_mis£s
)));

66 
	`v¨_¥öt
(
ˇche_ªadahóds
);

67 
	`v¨_¥öt
(
ˇche_miss_cﬁlisi⁄s
);

68 
	`sysfs_h¥öt
(
by∑s£d
, 
	`v¨
(
£˘‹s_by∑s£d
) << 9);

69 #unde‡
v¨


71 
	}
}

73 
	$STORE
(
bch_°©s
)

75  
size
;

76 
	}
}

78 
	$bch_°©s_ªÀa£
(
kobje˘
 *
k
)

80 
	}
}

82 
©åibuã
 *
	gbch_°©s_fûes
[] = {

83 &
sysfs_ˇche_hôs
,

84 &
sysfs_ˇche_mis£s
,

85 &
sysfs_ˇche_by∑ss_hôs
,

86 &
sysfs_ˇche_by∑ss_mis£s
,

87 &
sysfs_ˇche_hô_øtio
,

88 &
sysfs_ˇche_ªadahóds
,

89 &
sysfs_ˇche_miss_cﬁlisi⁄s
,

90 &
sysfs_by∑s£d
,

91 
NULL


93 
KTYPE
(
bch_°©s
);

95 
	$bch_ˇche_accou¡ög_add_kobjs
(
ˇche_accou¡ög
 *
acc
,

96 
kobje˘
 *
∑ª¡
)

98 
ªt
 = 
	`kobje˘_add
(&
acc
->
tŸÆ
.
kobj
, 
∑ª¡
,

100 
ªt
 =Ñë ?: 
	`kobje˘_add
(&
acc
->
five_möuã
.
kobj
, 
∑ª¡
,

102 
ªt
 =Ñë ?: 
	`kobje˘_add
(&
acc
->
hour
.
kobj
, 
∑ª¡
,

104 
ªt
 =Ñë ?: 
	`kobje˘_add
(&
acc
->
day
.
kobj
, 
∑ª¡
,

106  
ªt
;

107 
	}
}

109 
	$bch_ˇche_accou¡ög_˛ór
(
ˇche_accou¡ög
 *
acc
)

111 
	`mem£t
(&
acc
->
tŸÆ
.
ˇche_hôs
,

114 
	}
}

116 
	$bch_ˇche_accou¡ög_de°roy
(
ˇche_accou¡ög
 *
acc
)

118 
	`kobje˘_put
(&
acc
->
tŸÆ
.
kobj
);

119 
	`kobje˘_put
(&
acc
->
five_möuã
.
kobj
);

120 
	`kobje˘_put
(&
acc
->
hour
.
kobj
);

121 
	`kobje˘_put
(&
acc
->
day
.
kobj
);

123 
	`©omic_£t
(&
acc
->
˛osög
, 1);

124 i‡(
	`dñ_timî_sync
(&
acc
->
timî
))

125 
	`˛osuª_ªtu∫
(&
acc
->
˛
);

126 
	}
}

130 
	$sˇÀ_°©
(*
°©
)

132 *
°©
 = 
	`ewma_add
(*°©, 0, 
accou¡ög_weight
, 0);

133 
	}
}

135 
	$sˇÀ_°©s
(
ˇche_°©s
 *
°©s
, 
ªsˇÀ_©
)

137 i‡(++
°©s
->
ªsˇÀ
 =
ªsˇÀ_©
) {

138 
°©s
->
ªsˇÀ
 = 0;

139 
	`sˇÀ_°©
(&
°©s
->
ˇche_hôs
);

140 
	`sˇÀ_°©
(&
°©s
->
ˇche_mis£s
);

141 
	`sˇÀ_°©
(&
°©s
->
ˇche_by∑ss_hôs
);

142 
	`sˇÀ_°©
(&
°©s
->
ˇche_by∑ss_mis£s
);

143 
	`sˇÀ_°©
(&
°©s
->
ˇche_ªadahóds
);

144 
	`sˇÀ_°©
(&
°©s
->
ˇche_miss_cﬁlisi⁄s
);

145 
	`sˇÀ_°©
(&
°©s
->
£˘‹s_by∑s£d
);

147 
	}
}

149 
	$sˇÀ_accou¡ög
(
d©a
)

151 
ˇche_accou¡ög
 *
acc
 = (ˇche_accou¡ög *Ë
d©a
;

153 
	#move_°©
(
«me
) do { \

154 
t
 = 
	`©omic_xchg
(&
acc
->
cﬁÀ˘‹
.
«me
, 0); \

155 
t
 <<= 16; \

156 
acc
->
five_möuã
.
«me
 +
t
; \

157 
acc
->
hour
.
«me
 +
t
; \

158 
acc
->
day
.
«me
 +
t
; \

159 
acc
->
tŸÆ
.
«me
 +
t
; \

160 } 0)

	)

162 
	`move_°©
(
ˇche_hôs
);

163 
	`move_°©
(
ˇche_mis£s
);

164 
	`move_°©
(
ˇche_by∑ss_hôs
);

165 
	`move_°©
(
ˇche_by∑ss_mis£s
);

166 
	`move_°©
(
ˇche_ªadahóds
);

167 
	`move_°©
(
ˇche_miss_cﬁlisi⁄s
);

168 
	`move_°©
(
£˘‹s_by∑s£d
);

170 
	`sˇÀ_°©s
(&
acc
->
tŸÆ
, 0);

171 
	`sˇÀ_°©s
(&
acc
->
day
, 
DAY_RESCALE
);

172 
	`sˇÀ_°©s
(&
acc
->
hour
, 
HOUR_RESCALE
);

173 
	`sˇÀ_°©s
(&
acc
->
five_möuã
, 
FIVE_MINUTE_RESCALE
);

175 
acc
->
timî
.
expúes
 +
accou¡ög_dñay
;

177 i‡(!
	`©omic_ªad
(&
acc
->
˛osög
))

178 
	`add_timî
(&
acc
->
timî
);

180 
	`˛osuª_ªtu∫
(&
acc
->
˛
);

181 
	}
}

183 
	$m¨k_ˇche_°©s
(
ˇche_°©_cﬁÀ˘‹
 *
°©s
,

184 
boﬁ
 
hô
, boﬁ 
by∑ss
)

186 i‡(!
by∑ss
)

187 i‡(
hô
)

188 
	`©omic_öc
(&
°©s
->
ˇche_hôs
);

190 
	`©omic_öc
(&
°©s
->
ˇche_mis£s
);

192 i‡(
hô
)

193 
	`©omic_öc
(&
°©s
->
ˇche_by∑ss_hôs
);

195 
	`©omic_öc
(&
°©s
->
ˇche_by∑ss_mis£s
);

196 
	}
}

198 
	$bch_m¨k_ˇche_accou¡ög
(
ˇche_£t
 *
c
, 
bˇche_devi˚
 *
d
,

199 
boﬁ
 
hô
, boﬁ 
by∑ss
)

201 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

202 
	`m¨k_ˇche_°©s
(&
dc
->
accou¡ög
.
cﬁÀ˘‹
, 
hô
, 
by∑ss
);

203 
	`m¨k_ˇche_°©s
(&
c
->
accou¡ög
.
cﬁÀ˘‹
, 
hô
, 
by∑ss
);

204 
	}
}

206 
	$bch_m¨k_ˇche_ªadahód
(
ˇche_£t
 *
c
, 
bˇche_devi˚
 *
d
)

208 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

209 
	`©omic_öc
(&
dc
->
accou¡ög
.
cﬁÀ˘‹
.
ˇche_ªadahóds
);

210 
	`©omic_öc
(&
c
->
accou¡ög
.
cﬁÀ˘‹
.
ˇche_ªadahóds
);

211 
	}
}

213 
	$bch_m¨k_ˇche_miss_cﬁlisi⁄
(
ˇche_£t
 *
c
, 
bˇche_devi˚
 *
d
)

215 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
d
, ˇched_dev, 
disk
);

216 
	`©omic_öc
(&
dc
->
accou¡ög
.
cﬁÀ˘‹
.
ˇche_miss_cﬁlisi⁄s
);

217 
	`©omic_öc
(&
c
->
accou¡ög
.
cﬁÀ˘‹
.
ˇche_miss_cﬁlisi⁄s
);

218 
	}
}

220 
	$bch_m¨k_£˘‹s_by∑s£d
(
ˇche_£t
 *
c
, 
ˇched_dev
 *
dc
,

221 
£˘‹s
)

223 
	`©omic_add
(
£˘‹s
, &
dc
->
accou¡ög
.
cﬁÀ˘‹
.
£˘‹s_by∑s£d
);

224 
	`©omic_add
(
£˘‹s
, &
c
->
accou¡ög
.
cﬁÀ˘‹
.
£˘‹s_by∑s£d
);

225 
	}
}

227 
	$bch_ˇche_accou¡ög_öô
(
ˇche_accou¡ög
 *
acc
,

228 
˛osuª
 *
∑ª¡
)

230 
	`kobje˘_öô
(&
acc
->
tŸÆ
.
kobj
, &
bch_°©s_kty≥
);

231 
	`kobje˘_öô
(&
acc
->
five_möuã
.
kobj
, &
bch_°©s_kty≥
);

232 
	`kobje˘_öô
(&
acc
->
hour
.
kobj
, &
bch_°©s_kty≥
);

233 
	`kobje˘_öô
(&
acc
->
day
.
kobj
, &
bch_°©s_kty≥
);

235 
	`˛osuª_öô
(&
acc
->
˛
, 
∑ª¡
);

236 
	`öô_timî
(&
acc
->
timî
);

237 
acc
->
timî
.
expúes
 = 
jiffõs
 + 
accou¡ög_dñay
;

238 
acc
->
timî
.
d©a
 = ()ácc;

239 
acc
->
timî
.
fun˘i⁄
 = 
sˇÀ_accou¡ög
;

240 
	`add_timî
(&
acc
->
timî
);

241 
	}
}

	@bcache/stats.h

1 #i‚de‡
_BCACHE_STATS_H_


2 
	#_BCACHE_STATS_H_


	)

4 
	sˇche_°©_cﬁÀ˘‹
 {

5 
©omic_t
 
	mˇche_hôs
;

6 
©omic_t
 
	mˇche_mis£s
;

7 
©omic_t
 
	mˇche_by∑ss_hôs
;

8 
©omic_t
 
	mˇche_by∑ss_mis£s
;

9 
©omic_t
 
	mˇche_ªadahóds
;

10 
©omic_t
 
	mˇche_miss_cﬁlisi⁄s
;

11 
©omic_t
 
	m£˘‹s_by∑s£d
;

14 
	sˇche_°©s
 {

15 
kobje˘
 
	mkobj
;

17 
	mˇche_hôs
;

18 
	mˇche_mis£s
;

19 
	mˇche_by∑ss_hôs
;

20 
	mˇche_by∑ss_mis£s
;

21 
	mˇche_ªadahóds
;

22 
	mˇche_miss_cﬁlisi⁄s
;

23 
	m£˘‹s_by∑s£d
;

25 
	mªsˇÀ
;

28 
	sˇche_accou¡ög
 {

29 
˛osuª
 
	m˛
;

30 
timî_li°
 
	mtimî
;

31 
©omic_t
 
	m˛osög
;

33 
ˇche_°©_cﬁÀ˘‹
 
	mcﬁÀ˘‹
;

35 
ˇche_°©s
 
	mtŸÆ
;

36 
ˇche_°©s
 
	mfive_möuã
;

37 
ˇche_°©s
 
	mhour
;

38 
ˇche_°©s
 
	mday
;

41 
	gˇche_£t
;

42 
	gˇched_dev
;

43 
	gbˇche_devi˚
;

45 
bch_ˇche_accou¡ög_öô
(
ˇche_accou¡ög
 *
acc
,

46 
˛osuª
 *
∑ª¡
);

48 
bch_ˇche_accou¡ög_add_kobjs
(
ˇche_accou¡ög
 *
acc
,

49 
kobje˘
 *
∑ª¡
);

51 
bch_ˇche_accou¡ög_˛ór
(
ˇche_accou¡ög
 *
acc
);

53 
bch_ˇche_accou¡ög_de°roy
(
ˇche_accou¡ög
 *
acc
);

55 
bch_m¨k_ˇche_accou¡ög
(
ˇche_£t
 *, 
bˇche_devi˚
 *,

56 
boﬁ
, bool);

57 
bch_m¨k_ˇche_ªadahód
(
ˇche_£t
 *, 
bˇche_devi˚
 *);

58 
bch_m¨k_ˇche_miss_cﬁlisi⁄
(
ˇche_£t
 *, 
bˇche_devi˚
 *);

59 
bch_m¨k_£˘‹s_by∑s£d
(
ˇche_£t
 *, 
ˇched_dev
 *, );

	@bcache/super.c

9 
	~"bˇche.h
"

10 
	~"båì.h
"

11 
	~"debug.h
"

12 
	~"exã¡s.h
"

13 
	~"ªque°.h
"

14 
	~"wrôeback.h
"

16 
	~<löux/blkdev.h
>

17 
	~<löux/buf„r_hód.h
>

18 
	~<löux/debugfs.h
>

19 
	~<löux/gíhd.h
>

20 
	~<löux/idr.h
>

21 
	~<löux/kthªad.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/øndom.h
>

24 
	~<löux/ªboŸ.h
>

25 
	~<löux/sysfs.h
>

27 
MODULE_LICENSE
("GPL");

28 
MODULE_AUTHOR
("Kent Overstreet <kent.overstreet@gmail.com>");

30 c⁄° 
	gbˇche_magic
[] = {

35 c⁄° 
	gövÆid_uuid
[] = {

41 c⁄° * c⁄° 
	gbch_ˇche_modes
[] = {

47 
NULL


50 
kobje˘
 *
	gbˇche_kobj
;

51 
muãx
 
	gbch_ªgi°î_lock
;

52 
LIST_HEAD
(
bch_ˇche_£ts
);

53 
LIST_HEAD
(
unˇched_devi˚s
);

55 
	gbˇche_maj‹
;

56 
DEFINE_IDA
(
bˇche_mö‹
);

57 
waô_queue_hód_t
 
	guƒegi°î_waô
;

58 
w‹kqueue_°ru˘
 *
	gbˇche_wq
;

60 
	#BTREE_MAX_PAGES
 (256 * 1024 / 
PAGE_SIZE
)

	)

62 
	$bio_•lô_poﬁ_‰ì
(
bio_•lô_poﬁ
 *
p
)

64 i‡(
p
->
bio_•lô_hook
)

65 
	`mempoﬁ_de°roy
(
p
->
bio_•lô_hook
);

67 i‡(
p
->
bio_•lô
)

68 
	`bio£t_‰ì
(
p
->
bio_•lô
);

69 
	}
}

71 
	$bio_•lô_poﬁ_öô
(
bio_•lô_poﬁ
 *
p
)

73 
p
->
bio_•lô
 = 
	`bio£t_¸óã
(4, 0);

74 i‡(!
p
->
bio_•lô
)

75  -
ENOMEM
;

77 
p
->
bio_•lô_hook
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(4,

78 (
bio_•lô_hook
));

79 i‡(!
p
->
bio_•lô_hook
)

80  -
ENOMEM
;

83 
	}
}

87 c⁄° *
	$ªad_su≥r
(
ˇche_sb
 *
sb
, 
block_devi˚
 *
bdev
,

88 
∑ge
 **
ªs
)

90 c⁄° *
îr
;

91 
ˇche_sb
 *
s
;

92 
buf„r_hód
 *
bh
 = 
	`__bªad
(
bdev
, 1, 
SB_SIZE
);

93 
i
;

95 i‡(!
bh
)

98 
s
 = (
ˇche_sb
 *Ë
bh
->
b_d©a
;

100 
sb
->
off£t
 = 
	`À64_to_˝u
(
s
->offset);

101 
sb
->
vîsi⁄
 = 
	`À64_to_˝u
(
s
->version);

103 
	`mem˝y
(
sb
->
magic
, 
s
->magic, 16);

104 
	`mem˝y
(
sb
->
uuid
, 
s
->uuid, 16);

105 
	`mem˝y
(
sb
->
£t_uuid
, 
s
->set_uuid, 16);

106 
	`mem˝y
(
sb
->
œbñ
, 
s
->œbñ, 
SB_LABEL_SIZE
);

108 
sb
->
Êags
 = 
	`À64_to_˝u
(
s
->flags);

109 
sb
->
£q
 = 
	`À64_to_˝u
(
s
->seq);

110 
sb
->
œ°_mou¡
 = 
	`À32_to_˝u
(
s
->last_mount);

111 
sb
->
fú°_buckë
 = 
	`À16_to_˝u
(
s
->first_bucket);

112 
sb
->
keys
 = 
	`À16_to_˝u
(
s
->keys);

114 
i
 = 0; i < 
SB_JOURNAL_BUCKETS
; i++)

115 
sb
->
d
[
i
] = 
	`À64_to_˝u
(
s
->d[i]);

117 
	`¥_debug
("read sb version %llu, flags %llu, seq %llu, journal size %u",

118 
sb
->
vîsi⁄
, sb->
Êags
, sb->
£q
, sb->
keys
);

120 
îr
 = "Notá bcache superblock";

121 i‡(
sb
->
off£t
 !
SB_SECTOR
)

122 
îr
;

124 i‡(
	`memcmp
(
sb
->
magic
, 
bˇche_magic
, 16))

125 
îr
;

127 
îr
 = "Too many journal buckets";

128 i‡(
sb
->
keys
 > 
SB_JOURNAL_BUCKETS
)

129 
îr
;

131 
îr
 = "Bad checksum";

132 i‡(
s
->
csum
 !
	`csum_£t
(s))

133 
îr
;

135 
îr
 = "Bad UUID";

136 i‡(
	`bch_is_zîo
(
sb
->
uuid
, 16))

137 
îr
;

139 
sb
->
block_size
 = 
	`À16_to_˝u
(
s
->block_size);

141 
îr
 = "Superblock block size smallerÅhan device block size";

142 i‡(
sb
->
block_size
 << 9 < 
	`bdev_logiˇl_block_size
(
bdev
))

143 
îr
;

145 
sb
->
vîsi⁄
) {

146 
BCACHE_SB_VERSION_BDEV
:

147 
sb
->
d©a_off£t
 = 
BDEV_DATA_START_DEFAULT
;

149 
BCACHE_SB_VERSION_BDEV_WITH_OFFSET
:

150 
sb
->
d©a_off£t
 = 
	`À64_to_˝u
(
s
->data_offset);

152 
îr
 = "Bad data offset";

153 i‡(
sb
->
d©a_off£t
 < 
BDEV_DATA_START_DEFAULT
)

154 
îr
;

157 
BCACHE_SB_VERSION_CDEV
:

158 
BCACHE_SB_VERSION_CDEV_WITH_UUID
:

159 
sb
->
nbuckës
 = 
	`À64_to_˝u
(
s
->nbuckets);

160 
sb
->
block_size
 = 
	`À16_to_˝u
(
s
->block_size);

161 
sb
->
buckë_size
 = 
	`À16_to_˝u
(
s
->bucket_size);

163 
sb
->
ƒ_ö_£t
 = 
	`À16_to_˝u
(
s
->nr_in_set);

164 
sb
->
ƒ_this_dev
 = 
	`À16_to_˝u
(
s
->nr_this_dev);

166 
îr
 = "Too many buckets";

167 i‡(
sb
->
nbuckës
 > 
LONG_MAX
)

168 
îr
;

170 
îr
 = "NotÉnough buckets";

171 i‡(
sb
->
nbuckës
 < 1 << 7)

172 
îr
;

174 
îr
 = "Bad block/bucket size";

175 i‡(!
	`is_powî_of_2
(
sb
->
block_size
) ||

176 
sb
->
block_size
 > 
PAGE_SECTORS
 ||

177 !
	`is_powî_of_2
(
sb
->
buckë_size
) ||

178 
sb
->
buckë_size
 < 
PAGE_SECTORS
)

179 
îr
;

181 
îr
 = "Invalid superblock: deviceÅoo small";

182 i‡(
	`gë_ˇ∑côy
(
bdev
->
bd_disk
Ë< 
sb
->
buckë_size
 * sb->
nbuckës
)

183 
îr
;

185 
îr
 = "Bad UUID";

186 i‡(
	`bch_is_zîo
(
sb
->
£t_uuid
, 16))

187 
îr
;

189 
îr
 = "Bad cache deviceÇumber in set";

190 i‡(!
sb
->
ƒ_ö_£t
 ||

191 
sb
->
ƒ_ö_£t
 <sb->
ƒ_this_dev
 ||

192 
sb
->
ƒ_ö_£t
 > 
MAX_CACHES_PER_SET
)

193 
îr
;

195 
îr
 = "Journal bucketsÇot sequential";

196 
i
 = 0; i < 
sb
->
keys
; i++)

197 i‡(
sb
->
d
[
i
] !sb->
fú°_buckë
 + i)

198 
îr
;

200 
îr
 = "Too many journal buckets";

201 i‡(
sb
->
fú°_buckë
 + sb->
keys
 > sb->
nbuckës
)

202 
îr
;

204 
îr
 = "Invalid superblock: first bucket comes beforeÉnd of super";

205 i‡(
sb
->
fú°_buckë
 * sb->
buckë_size
 < 16)

206 
îr
;

210 
îr
 = "Unsupported superblock version";

211 
îr
;

214 
sb
->
œ°_mou¡
 = 
	`gë_£c⁄ds
();

215 
îr
 = 
NULL
;

217 
	`gë_∑ge
(
bh
->
b_∑ge
);

218 *
ªs
 = 
bh
->
b_∑ge
;

219 
îr
:

220 
	`put_bh
(
bh
);

221  
îr
;

222 
	}
}

224 
	$wrôe_bdev_su≥r_ídio
(
bio
 *bio, 
îr‹
)

226 
ˇched_dev
 *
dc
 = 
bio
->
bi_¥iv©e
;

229 
	`˛osuª_put
(&
dc
->
sb_wrôe
);

230 
	}
}

232 
	$__wrôe_su≥r
(
ˇche_sb
 *
sb
, 
bio
 *bio)

234 
ˇche_sb
 *
out
 = 
	`∑ge_addªss
(
bio
->
bi_io_vec
[0].
bv_∑ge
);

235 
i
;

237 
bio
->
bi_ôî
.
bi_£˘‹
 = 
SB_SECTOR
;

238 
bio
->
bi_rw
 = 
REQ_SYNC
|
REQ_META
;

239 
bio
->
bi_ôî
.
bi_size
 = 
SB_SIZE
;

240 
	`bch_bio_m≠
(
bio
, 
NULL
);

242 
out
->
off£t
 = 
	`˝u_to_À64
(
sb
->offset);

243 
out
->
vîsi⁄
 = 
	`˝u_to_À64
(
sb
->version);

245 
	`mem˝y
(
out
->
uuid
, 
sb
->uuid, 16);

246 
	`mem˝y
(
out
->
£t_uuid
, 
sb
->set_uuid, 16);

247 
	`mem˝y
(
out
->
œbñ
, 
sb
->œbñ, 
SB_LABEL_SIZE
);

249 
out
->
Êags
 = 
	`˝u_to_À64
(
sb
->flags);

250 
out
->
£q
 = 
	`˝u_to_À64
(
sb
->seq);

252 
out
->
œ°_mou¡
 = 
	`˝u_to_À32
(
sb
->last_mount);

253 
out
->
fú°_buckë
 = 
	`˝u_to_À16
(
sb
->first_bucket);

254 
out
->
keys
 = 
	`˝u_to_À16
(
sb
->keys);

256 
i
 = 0; i < 
sb
->
keys
; i++)

257 
out
->
d
[
i
] = 
	`˝u_to_À64
(
sb
->d[i]);

259 
out
->
csum
 = 
	`csum_£t
(out);

261 
	`¥_debug
("ver %llu, flags %llu, seq %llu",

262 
sb
->
vîsi⁄
, sb->
Êags
, sb->
£q
);

264 
	`submô_bio
(
REQ_WRITE
, 
bio
);

265 
	}
}

267 
	$bch_wrôe_bdev_su≥r_u∆ock
(
˛osuª
 *
˛
)

269 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
˛
, ˇched_dev, 
sb_wrôe
);

271 
	`up
(&
dc
->
sb_wrôe_muãx
);

272 
	}
}

274 
	$bch_wrôe_bdev_su≥r
(
ˇched_dev
 *
dc
, 
˛osuª
 *
∑ª¡
)

276 
˛osuª
 *
˛
 = &
dc
->
sb_wrôe
;

277 
bio
 *biÿ&
dc
->
sb_bio
;

279 
	`down
(&
dc
->
sb_wrôe_muãx
);

280 
	`˛osuª_öô
(
˛
, 
∑ª¡
);

282 
	`bio_ª£t
(
bio
);

283 
bio
->
bi_bdev
 = 
dc
->
bdev
;

284 
bio
->
bi_íd_io
 = 
wrôe_bdev_su≥r_ídio
;

285 
bio
->
bi_¥iv©e
 = 
dc
;

287 
	`˛osuª_gë
(
˛
);

288 
	`__wrôe_su≥r
(&
dc
->
sb
, 
bio
);

290 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
bch_wrôe_bdev_su≥r_u∆ock
);

291 
	}
}

293 
	$wrôe_su≥r_ídio
(
bio
 *bio, 
îr‹
)

295 
ˇche
 *
ˇ
 = 
bio
->
bi_¥iv©e
;

297 
	`bch_cou¡_io_îr‹s
(
ˇ
, 
îr‹
, "writing superblock");

298 
	`˛osuª_put
(&
ˇ
->
£t
->
sb_wrôe
);

299 
	}
}

301 
	$bˇche_wrôe_su≥r_u∆ock
(
˛osuª
 *
˛
)

303 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
sb_wrôe
);

305 
	`up
(&
c
->
sb_wrôe_muãx
);

306 
	}
}

308 
	$bˇche_wrôe_su≥r
(
ˇche_£t
 *
c
)

310 
˛osuª
 *
˛
 = &
c
->
sb_wrôe
;

311 
ˇche
 *
ˇ
;

312 
i
;

314 
	`down
(&
c
->
sb_wrôe_muãx
);

315 
	`˛osuª_öô
(
˛
, &
c
->cl);

317 
c
->
sb
.
£q
++;

319 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
) {

320 
bio
 *biÿ&
ˇ
->
sb_bio
;

322 
ˇ
->
sb
.
vîsi⁄
 = 
BCACHE_SB_VERSION_CDEV_WITH_UUID
;

323 
ˇ
->
sb
.
£q
 = 
c
->sb.seq;

324 
ˇ
->
sb
.
œ°_mou¡
 = 
c
->sb.last_mount;

326 
	`SET_CACHE_SYNC
(&
ˇ
->
sb
, 
	`CACHE_SYNC
(&
c
->sb));

328 
	`bio_ª£t
(
bio
);

329 
bio
->
bi_bdev
 = 
ˇ
->
bdev
;

330 
bio
->
bi_íd_io
 = 
wrôe_su≥r_ídio
;

331 
bio
->
bi_¥iv©e
 = 
ˇ
;

333 
	`˛osuª_gë
(
˛
);

334 
	`__wrôe_su≥r
(&
ˇ
->
sb
, 
bio
);

337 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
bˇche_wrôe_su≥r_u∆ock
);

338 
	}
}

342 
	$uuid_ídio
(
bio
 *bio, 
îr‹
)

344 
˛osuª
 *
˛
 = 
bio
->
bi_¥iv©e
;

345 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
uuid_wrôe
);

347 
	`ˇche_£t_îr_⁄
(
îr‹
, 
c
, "accessing uuids");

348 
	`bch_bbio_‰ì
(
bio
, 
c
);

349 
	`˛osuª_put
(
˛
);

350 
	}
}

352 
	$uuid_io_u∆ock
(
˛osuª
 *
˛
)

354 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
uuid_wrôe
);

356 
	`up
(&
c
->
uuid_wrôe_muãx
);

357 
	}
}

359 
	$uuid_io
(
ˇche_£t
 *
c
, 
rw
,

360 
bkey
 *
k
, 
˛osuª
 *
∑ª¡
)

362 
˛osuª
 *
˛
 = &
c
->
uuid_wrôe
;

363 
uuid_íåy
 *
u
;

364 
i
;

365 
buf
[80];

367 
	`BUG_ON
(!
∑ª¡
);

368 
	`down
(&
c
->
uuid_wrôe_muãx
);

369 
	`˛osuª_öô
(
˛
, 
∑ª¡
);

371 
i
 = 0; i < 
	`KEY_PTRS
(
k
); i++) {

372 
bio
 *biÿ
	`bch_bbio_Æloc
(
c
);

374 
bio
->
bi_rw
 = 
REQ_SYNC
|
REQ_META
|
rw
;

375 
bio
->
bi_ôî
.
bi_size
 = 
	`KEY_SIZE
(
k
) << 9;

377 
bio
->
bi_íd_io
 = 
uuid_ídio
;

378 
bio
->
bi_¥iv©e
 = 
˛
;

379 
	`bch_bio_m≠
(
bio
, 
c
->
uuids
);

381 
	`bch_submô_bbio
(
bio
, 
c
, 
k
, 
i
);

383 i‡(!(
rw
 & 
WRITE
))

387 
	`bch_exã¡_to_ãxt
(
buf
, (buf), 
k
);

388 
	`¥_debug
("%†UUID†© %s", 
rw
 & 
REQ_WRITE
 ? "wrŸe" : "ªad", 
buf
);

390 
u
 = 
c
->
uuids
; u < c->uuid†+ c->
ƒ_uuids
; u++)

391 i‡(!
	`bch_is_zîo
(
u
->
uuid
, 16))

392 
	`¥_debug
("Slot %zi: %pU: %s: 1st: %uÜast: %u inv: %u",

393 
u
 - 
c
->
uuids
, u->
uuid
, u->
œbñ
,

394 
u
->
fú°_ªg
, u->
œ°_ªg
, u->
övÆid©ed
);

396 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
uuid_io_u∆ock
);

397 
	}
}

399 *
	$uuid_ªad
(
ˇche_£t
 *
c
, 
j£t
 *
j
, 
˛osuª
 *
˛
)

401 
bkey
 *
k
 = &
j
->
uuid_buckë
;

403 i‡(
	`__bch_båì_±r_övÆid
(
c
, 
k
))

406 
	`bkey_c›y
(&
c
->
uuid_buckë
, 
k
);

407 
	`uuid_io
(
c
, 
READ_SYNC
, 
k
, 
˛
);

409 i‡(
j
->
vîsi⁄
 < 
BCACHE_JSET_VERSION_UUIDv1
) {

410 
uuid_íåy_v0
 *
u0
 = (*Ë
c
->
uuids
;

411 
uuid_íåy
 *
u1
 = (*Ë
c
->
uuids
;

412 
i
;

414 
	`˛osuª_sync
(
˛
);

422 
i
 = 
c
->
ƒ_uuids
 - 1;

423 
i
 >= 0;

424 --
i
) {

425 
	`mem˝y
(
u1
[
i
].
uuid
, 
u0
[i].uuid, 16);

426 
	`mem˝y
(
u1
[
i
].
œbñ
, 
u0
[i].label, 32);

428 
u1
[
i
].
fú°_ªg
 = 
u0
[i].first_reg;

429 
u1
[
i
].
œ°_ªg
 = 
u0
[i].last_reg;

430 
u1
[
i
].
övÆid©ed
 = 
u0
[i].invalidated;

432 
u1
[
i
].
Êags
 = 0;

433 
u1
[
i
].
£˘‹s
 = 0;

437  
NULL
;

438 
	}
}

440 
	$__uuid_wrôe
(
ˇche_£t
 *
c
)

442 
	`BKEY_PADDED
(
key
Ë
k
;

443 
˛osuª
 
˛
;

444 
	`˛osuª_öô_°ack
(&
˛
);

446 
	`lockdï_as£π_hñd
(&
bch_ªgi°î_lock
);

448 i‡(
	`bch_buckë_Æloc_£t
(
c
, 
RESERVE_BTREE
, &
k
.
key
, 1, 
åue
))

451 
	`SET_KEY_SIZE
(&
k
.
key
, 
c
->
sb
.
buckë_size
);

452 
	`uuid_io
(
c
, 
REQ_WRITE
, &
k
.
key
, &
˛
);

453 
	`˛osuª_sync
(&
˛
);

455 
	`bkey_c›y
(&
c
->
uuid_buckë
, &
k
.
key
);

456 
	`bkey_put
(
c
, &
k
.
key
);

458 
	}
}

460 
	$bch_uuid_wrôe
(
ˇche_£t
 *
c
)

462 
ªt
 = 
	`__uuid_wrôe
(
c
);

464 i‡(!
ªt
)

465 
	`bch_jou∫Æ_mëa
(
c
, 
NULL
);

467  
ªt
;

468 
	}
}

470 
uuid_íåy
 *
	$uuid_föd
(
ˇche_£t
 *
c
, c⁄° *
uuid
)

472 
uuid_íåy
 *
u
;

474 
u
 = 
c
->
uuids
;

475 
u
 < 
c
->
uuids
 + c->
ƒ_uuids
; u++)

476 i‡(!
	`memcmp
(
u
->
uuid
, uuid, 16))

477  
u
;

479  
NULL
;

480 
	}
}

482 
uuid_íåy
 *
	$uuid_föd_em±y
(
ˇche_£t
 *
c
)

484 c⁄° 
zîo_uuid
[16] = "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";

485  
	`uuid_föd
(
c
, 
zîo_uuid
);

486 
	}
}

515 
	$¥io_ídio
(
bio
 *bio, 
îr‹
)

517 
ˇche
 *
ˇ
 = 
bio
->
bi_¥iv©e
;

519 
	`ˇche_£t_îr_⁄
(
îr‹
, 
ˇ
->
£t
, "accessingÖriorities");

520 
	`bch_bbio_‰ì
(
bio
, 
ˇ
->
£t
);

521 
	`˛osuª_put
(&
ˇ
->
¥io
);

522 
	}
}

524 
	$¥io_io
(
ˇche
 *
ˇ
, 
uöt64_t
 
buckë
, 
rw
)

526 
˛osuª
 *
˛
 = &
ˇ
->
¥io
;

527 
bio
 *biÿ
	`bch_bbio_Æloc
(
ˇ
->
£t
);

529 
	`˛osuª_öô_°ack
(
˛
);

531 
bio
->
bi_ôî
.
bi_£˘‹
 = 
buckë
 * 
ˇ
->
sb
.
buckë_size
;

532 
bio
->
bi_bdev
 = 
ˇ
->
bdev
;

533 
bio
->
bi_rw
 = 
REQ_SYNC
|
REQ_META
|
rw
;

534 
bio
->
bi_ôî
.
bi_size
 = 
	`buckë_byãs
(
ˇ
);

536 
bio
->
bi_íd_io
 = 
¥io_ídio
;

537 
bio
->
bi_¥iv©e
 = 
ˇ
;

538 
	`bch_bio_m≠
(
bio
, 
ˇ
->
disk_buckës
);

540 
	`˛osuª_bio_submô
(
bio
, &
ˇ
->
¥io
, ca);

541 
	`˛osuª_sync
(
˛
);

542 
	}
}

544 
	$bch_¥io_wrôe
(
ˇche
 *
ˇ
)

546 
i
;

547 
buckë
 *
b
;

548 
˛osuª
 
˛
;

550 
	`˛osuª_öô_°ack
(&
˛
);

552 
	`lockdï_as£π_hñd
(&
ˇ
->
£t
->
buckë_lock
);

554 
ˇ
->
disk_buckës
->
£q
++;

556 
	`©omic_l⁄g_add
(
ˇ
->
sb
.
buckë_size
 * 
	`¥io_buckës
(ca),

557 &
ˇ
->
mëa_£˘‹s_wrôãn
);

562 
i
 = 
	`¥io_buckës
(
ˇ
) - 1; i >= 0; --i) {

563 
buckë
;

564 
¥io_£t
 *
p
 = 
ˇ
->
disk_buckës
;

565 
buckë_disk
 *
d
 = 
p
->
d©a
;

566 
buckë_disk
 *
íd
 = 
d
 + 
	`¥ios_≥r_buckë
(
ˇ
);

568 
b
 = 
ˇ
->
buckës
 + 
i
 * 
	`¥ios_≥r_buckë
(ca);

569 
b
 < 
ˇ
->
buckës
 + ca->
sb
.
nbuckës
 && 
d
 < 
íd
;

570 
b
++, 
d
++) {

571 
d
->
¥io
 = 
	`˝u_to_À16
(
b
->prio);

572 
d
->
gí
 = 
b
->gen;

575 
p
->
√xt_buckë
 = 
ˇ
->
¥io_buckës
[
i
 + 1];

576 
p
->
magic
 = 
	`p£t_magic
(&
ˇ
->
sb
);

577 
p
->
csum
 = 
	`bch_¸c64
(&p->
magic
, 
	`buckë_byãs
(
ˇ
) - 8);

579 
buckë
 = 
	`bch_buckë_Æloc
(
ˇ
, 
RESERVE_PRIO
, 
åue
);

580 
	`BUG_ON
(
buckë
 == -1);

582 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

583 
	`¥io_io
(
ˇ
, 
buckë
, 
REQ_WRITE
);

584 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

586 
ˇ
->
¥io_buckës
[
i
] = 
buckë
;

587 
	`©omic_dec_bug
(&
ˇ
->
buckës
[
buckë
].
pö
);

590 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

592 
	`bch_jou∫Æ_mëa
(
ˇ
->
£t
, &
˛
);

593 
	`˛osuª_sync
(&
˛
);

595 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

601 
i
 = 0; i < 
	`¥io_buckës
(
ˇ
); i++) {

602 i‡(
ˇ
->
¥io_œ°_buckës
[
i
])

603 
	`__bch_buckë_‰ì
(
ˇ
,

604 &
ˇ
->
buckës
[ˇ->
¥io_œ°_buckës
[
i
]]);

606 
ˇ
->
¥io_œ°_buckës
[
i
] = ca->
¥io_buckës
[i];

608 
	}
}

610 
	$¥io_ªad
(
ˇche
 *
ˇ
, 
uöt64_t
 
buckë
)

612 
¥io_£t
 *
p
 = 
ˇ
->
disk_buckës
;

613 
buckë_disk
 *
d
 = 
p
->
d©a
 + 
	`¥ios_≥r_buckë
(
ˇ
), *
íd
 = d;

614 
buckë
 *
b
;

615 
buckë_ƒ
 = 0;

617 
b
 = 
ˇ
->
buckës
;

618 
b
 < 
ˇ
->
buckës
 + ca->
sb
.
nbuckës
;

619 
b
++, 
d
++) {

620 i‡(
d
 =
íd
) {

621 
ˇ
->
¥io_buckës
[
buckë_ƒ
] = 
buckë
;

622 
ˇ
->
¥io_œ°_buckës
[
buckë_ƒ
] = 
buckë
;

623 
buckë_ƒ
++;

625 
	`¥io_io
(
ˇ
, 
buckë
, 
READ_SYNC
);

627 i‡(
p
->
csum
 !
	`bch_¸c64
(&p->
magic
, 
	`buckë_byãs
(
ˇ
) - 8))

628 
	`¥_w¨n
("bad csumÑeadingÖriorities");

630 i‡(
p
->
magic
 !
	`p£t_magic
(&
ˇ
->
sb
))

631 
	`¥_w¨n
("bad magicÑeadingÖriorities");

633 
buckë
 = 
p
->
√xt_buckë
;

634 
d
 = 
p
->
d©a
;

637 
b
->
¥io
 = 
	`À16_to_˝u
(
d
->prio);

638 
b
->
gí
 = b->
œ°_gc
 = 
d
->gen;

640 
	}
}

644 
	$›í_dev
(
block_devi˚
 *
b
, 
fmode_t
 
mode
)

646 
bˇche_devi˚
 *
d
 = 
b
->
bd_disk
->
¥iv©e_d©a
;

647 i‡(
	`ã°_bô
(
BCACHE_DEV_CLOSING
, &
d
->
Êags
))

648  -
ENXIO
;

650 
	`˛osuª_gë
(&
d
->
˛
);

652 
	}
}

654 
	$ªÀa£_dev
(
gídisk
 *
b
, 
fmode_t
 
mode
)

656 
bˇche_devi˚
 *
d
 = 
b
->
¥iv©e_d©a
;

657 
	`˛osuª_put
(&
d
->
˛
);

658 
	}
}

660 
	$io˘l_dev
(
block_devi˚
 *
b
, 
fmode_t
 
mode
,

661 
cmd
, 
¨g
)

663 
bˇche_devi˚
 *
d
 = 
b
->
bd_disk
->
¥iv©e_d©a
;

664  
d
->
	`io˘l
(d, 
mode
, 
cmd
, 
¨g
);

665 
	}
}

667 c⁄° 
block_devi˚_›î©i⁄s
 
	gbˇche_›s
 = {

668 .
›í
 = 
›í_dev
,

669 .
	gªÀa£
 = 
ªÀa£_dev
,

670 .
	gio˘l
 = 
io˘l_dev
,

671 .
	gow√r
 = 
THIS_MODULE
,

674 
	$bˇche_devi˚_°›
(
bˇche_devi˚
 *
d
)

676 i‡(!
	`ã°_™d_£t_bô
(
BCACHE_DEV_CLOSING
, &
d
->
Êags
))

677 
	`˛osuª_queue
(&
d
->
˛
);

678 
	}
}

680 
	$bˇche_devi˚_u∆ök
(
bˇche_devi˚
 *
d
)

682 
	`lockdï_as£π_hñd
(&
bch_ªgi°î_lock
);

684 i‡(
d
->
c
 && !
	`ã°_™d_£t_bô
(
BCACHE_DEV_UNLINK_DONE
, &d->
Êags
)) {

685 
i
;

686 
ˇche
 *
ˇ
;

688 
	`sysfs_ªmove_lök
(&
d
->
c
->
kobj
, d->
«me
);

689 
	`sysfs_ªmove_lök
(&
d
->
kobj
, "cache");

691 
	`f‹_óch_ˇche
(
ˇ
, 
d
->
c
, 
i
)

692 
	`bd_u∆ök_disk_hﬁdî
(
ˇ
->
bdev
, 
d
->
disk
);

694 
	}
}

696 
	$bˇche_devi˚_lök
(
bˇche_devi˚
 *
d
, 
ˇche_£t
 *
c
,

697 c⁄° *
«me
)

699 
i
;

700 
ˇche
 *
ˇ
;

702 
	`f‹_óch_ˇche
(
ˇ
, 
d
->
c
, 
i
)

703 
	`bd_lök_disk_hﬁdî
(
ˇ
->
bdev
, 
d
->
disk
);

705 
	`¢¥ötf
(
d
->
«me
, 
BCACHEDEVNAME_SIZE
,

706 "%s%u", 
«me
, 
d
->
id
);

708 
	`WARN
(
	`sysfs_¸óã_lök
(&
d
->
kobj
, &
c
->kobj, "cache") ||

709 
	`sysfs_¸óã_lök
(&
c
->
kobj
, &
d
->kobj, d->
«me
),

711 
	}
}

713 
	$bˇche_devi˚_dëach
(
bˇche_devi˚
 *
d
)

715 
	`lockdï_as£π_hñd
(&
bch_ªgi°î_lock
);

717 i‡(
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
d
->
Êags
)) {

718 
uuid_íåy
 *
u
 = 
d
->
c
->
uuids
 + d->
id
;

720 
	`SET_UUID_FLASH_ONLY
(
u
, 0);

721 
	`mem˝y
(
u
->
uuid
, 
övÆid_uuid
, 16);

722 
u
->
övÆid©ed
 = 
	`˝u_to_À32
(
	`gë_£c⁄ds
());

723 
	`bch_uuid_wrôe
(
d
->
c
);

726 
	`bˇche_devi˚_u∆ök
(
d
);

728 
d
->
c
->
devi˚s
[d->
id
] = 
NULL
;

729 
	`˛osuª_put
(&
d
->
c
->
ˇchög
);

730 
d
->
c
 = 
NULL
;

731 
	}
}

733 
	$bˇche_devi˚_©èch
(
bˇche_devi˚
 *
d
, 
ˇche_£t
 *
c
,

734 
id
)

736 
d
->
id
 = id;

737 
d
->
c
 = c;

738 
c
->
devi˚s
[
id
] = 
d
;

740 
	`˛osuª_gë
(&
c
->
ˇchög
);

741 
	}
}

743 
	$bˇche_devi˚_‰ì
(
bˇche_devi˚
 *
d
)

745 
	`lockdï_as£π_hñd
(&
bch_ªgi°î_lock
);

747 
	`¥_öfo
("%†°›≥d", 
d
->
disk
->
disk_«me
);

749 i‡(
d
->
c
)

750 
	`bˇche_devi˚_dëach
(
d
);

751 i‡(
d
->
disk
 && d->disk->
Êags
 & 
GENHD_FL_UP
)

752 
	`dñ_gídisk
(
d
->
disk
);

753 i‡(
d
->
disk
 && d->disk->
queue
)

754 
	`blk_˛ónup_queue
(
d
->
disk
->
queue
);

755 i‡(
d
->
disk
) {

756 
	`ida_sim∂e_ªmove
(&
bˇche_mö‹
, 
d
->
disk
->
fú°_mö‹
);

757 
	`put_disk
(
d
->
disk
);

760 
	`bio_•lô_poﬁ_‰ì
(&
d
->
bio_•lô_hook
);

761 i‡(
d
->
bio_•lô
)

762 
	`bio£t_‰ì
(
d
->
bio_•lô
);

763 i‡(
	`is_vmÆloc_addr
(
d
->
fuŒ_dúty_°rùes
))

764 
	`v‰ì
(
d
->
fuŒ_dúty_°rùes
);

766 
	`k‰ì
(
d
->
fuŒ_dúty_°rùes
);

767 i‡(
	`is_vmÆloc_addr
(
d
->
°rùe_£˘‹s_dúty
))

768 
	`v‰ì
(
d
->
°rùe_£˘‹s_dúty
);

770 
	`k‰ì
(
d
->
°rùe_£˘‹s_dúty
);

772 
	`˛osuª_debug_de°roy
(&
d
->
˛
);

773 
	}
}

775 
	$bˇche_devi˚_öô
(
bˇche_devi˚
 *
d
, 
block_size
,

776 
£˘‹_t
 
£˘‹s
)

778 
ªque°_queue
 *
q
;

779 
size_t
 
n
;

780 
mö‹
;

782 i‡(!
d
->
°rùe_size
)

783 
d
->
°rùe_size
 = 1 << 31;

785 
d
->
ƒ_°rùes
 = 
	`DIV_ROUND_UP_ULL
(
£˘‹s
, d->
°rùe_size
);

787 i‡(!
d
->
ƒ_°rùes
 ||

788 
d
->
ƒ_°rùes
 > 
INT_MAX
 ||

789 
d
->
ƒ_°rùes
 > 
SIZE_MAX
 / (
©omic_t
)) {

790 
	`¥_îr
("nr_stripesÅooÜarge");

791  -
ENOMEM
;

794 
n
 = 
d
->
ƒ_°rùes
 * (
©omic_t
);

795 
d
->
°rùe_£˘‹s_dúty
 = 
n
 < 
PAGE_SIZE
 << 6

796 ? 
	`kzÆloc
(
n
, 
GFP_KERNEL
)

797 : 
	`vzÆloc
(
n
);

798 i‡(!
d
->
°rùe_£˘‹s_dúty
)

799  -
ENOMEM
;

801 
n
 = 
	`BITS_TO_LONGS
(
d
->
ƒ_°rùes
) * ();

802 
d
->
fuŒ_dúty_°rùes
 = 
n
 < 
PAGE_SIZE
 << 6

803 ? 
	`kzÆloc
(
n
, 
GFP_KERNEL
)

804 : 
	`vzÆloc
(
n
);

805 i‡(!
d
->
fuŒ_dúty_°rùes
)

806  -
ENOMEM
;

808 
mö‹
 = 
	`ida_sim∂e_gë
(&
bˇche_mö‹
, 0, 
MINORMASK
 + 1, 
GFP_KERNEL
);

809 i‡(
mö‹
 < 0)

810  
mö‹
;

812 i‡(!(
d
->
bio_•lô
 = 
	`bio£t_¸óã
(4, 
	`off£tof
(
bbio
, 
bio
))) ||

813 
	`bio_•lô_poﬁ_öô
(&
d
->
bio_•lô_hook
) ||

814 !(
d
->
disk
 = 
	`Æloc_disk
(1))) {

815 
	`ida_sim∂e_ªmove
(&
bˇche_mö‹
, 
mö‹
);

816  -
ENOMEM
;

819 
	`£t_ˇ∑côy
(
d
->
disk
, 
£˘‹s
);

820 
	`¢¥ötf
(
d
->
disk
->
disk_«me
, 
DISK_NAME_LEN
, "bˇche%i", 
mö‹
);

822 
d
->
disk
->
maj‹
 = 
bˇche_maj‹
;

823 
d
->
disk
->
fú°_mö‹
 = 
mö‹
;

824 
d
->
disk
->
f›s
 = &
bˇche_›s
;

825 
d
->
disk
->
¥iv©e_d©a
 = d;

827 
q
 = 
	`blk_Æloc_queue
(
GFP_KERNEL
);

828 i‡(!
q
)

829  -
ENOMEM
;

831 
	`blk_queue_make_ªque°
(
q
, 
NULL
);

832 
d
->
disk
->
queue
 = 
q
;

833 
q
->
queued©a
 = 
d
;

834 
q
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = 
d
;

835 
q
->
limôs
.
max_hw_£˘‹s
 = 
UINT_MAX
;

836 
q
->
limôs
.
max_£˘‹s
 = 
UINT_MAX
;

837 
q
->
limôs
.
max_£gmít_size
 = 
UINT_MAX
;

838 
q
->
limôs
.
max_£gmíts
 = 
BIO_MAX_PAGES
;

839 
q
->
limôs
.
max_disˇrd_£˘‹s
 = 
UINT_MAX
;

840 
q
->
limôs
.
disˇrd_gønuœrôy
 = 512;

841 
q
->
limôs
.
io_mö
 = 
block_size
;

842 
q
->
limôs
.
logiˇl_block_size
 = 
block_size
;

843 
q
->
limôs
.
physiˇl_block_size
 = 
block_size
;

844 
	`£t_bô
(
QUEUE_FLAG_NONROT
, &
d
->
disk
->
queue
->
queue_Êags
);

845 
	`£t_bô
(
QUEUE_FLAG_DISCARD
, &
d
->
disk
->
queue
->
queue_Êags
);

847 
	`blk_queue_Êush
(
q
, 
REQ_FLUSH
|
REQ_FUA
);

850 
	}
}

854 
	$ˇlc_ˇched_dev_£˘‹s
(
ˇche_£t
 *
c
)

856 
uöt64_t
 
£˘‹s
 = 0;

857 
ˇched_dev
 *
dc
;

859 
	`li°_f‹_óch_íåy
(
dc
, &
c
->
ˇched_devs
, 
li°
)

860 
£˘‹s
 +
	`bdev_£˘‹s
(
dc
->
bdev
);

862 
c
->
ˇched_dev_£˘‹s
 = 
£˘‹s
;

863 
	}
}

865 
	$bch_ˇched_dev_run
(
ˇched_dev
 *
dc
)

867 
bˇche_devi˚
 *
d
 = &
dc
->
disk
;

868 
buf
[
SB_LABEL_SIZE
 + 1];

869 *
ív
[] = {

871 
	`ka•rötf
(
GFP_KERNEL
, "CACHED_UUID=%pU", 
dc
->
sb
.
uuid
),

872 
NULL
,

873 
NULL
,

876 
	`mem˝y
(
buf
, 
dc
->
sb
.
œbñ
, 
SB_LABEL_SIZE
);

877 
buf
[
SB_LABEL_SIZE
] = '\0';

878 
ív
[2] = 
	`ka•rötf
(
GFP_KERNEL
, "CACHED_LABEL=%s", 
buf
);

880 i‡(
	`©omic_xchg
(&
dc
->
ru¬ög
, 1))

883 i‡(!
d
->
c
 &&

884 
	`BDEV_STATE
(&
dc
->
sb
Ë!
BDEV_STATE_NONE
) {

885 
˛osuª
 
˛
;

886 
	`˛osuª_öô_°ack
(&
˛
);

888 
	`SET_BDEV_STATE
(&
dc
->
sb
, 
BDEV_STATE_STALE
);

889 
	`bch_wrôe_bdev_su≥r
(
dc
, &
˛
);

890 
	`˛osuª_sync
(&
˛
);

893 
	`add_disk
(
d
->
disk
);

894 
	`bd_lök_disk_hﬁdî
(
dc
->
bdev
, dc->
disk
.disk);

897 
	`kobje˘_uevít_ív
(&
	`disk_to_dev
(
d
->
disk
)->
kobj
, 
KOBJ_CHANGE
, 
ív
);

898 
	`k‰ì
(
ív
[1]);

899 
	`k‰ì
(
ív
[2]);

901 i‡(
	`sysfs_¸óã_lök
(&
d
->
kobj
, &
	`disk_to_dev
(d->
disk
)->kobj, "dev") ||

902 
	`sysfs_¸óã_lök
(&
	`disk_to_dev
(
d
->
disk
)->
kobj
, &d->kobj, "bcache"))

903 
	`¥_debug
("error creating sysfsÜink");

904 
	}
}

906 
	$ˇched_dev_dëach_föish
(
w‹k_°ru˘
 *
w
)

908 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
w
, ˇched_dev, 
dëach
);

909 
buf
[
BDEVNAME_SIZE
];

910 
˛osuª
 
˛
;

911 
	`˛osuª_öô_°ack
(&
˛
);

913 
	`BUG_ON
(!
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
));

914 
	`BUG_ON
(
	`©omic_ªad
(&
dc
->
cou¡
));

916 
	`muãx_lock
(&
bch_ªgi°î_lock
);

918 
	`mem£t
(&
dc
->
sb
.
£t_uuid
, 0, 16);

919 
	`SET_BDEV_STATE
(&
dc
->
sb
, 
BDEV_STATE_NONE
);

921 
	`bch_wrôe_bdev_su≥r
(
dc
, &
˛
);

922 
	`˛osuª_sync
(&
˛
);

924 
	`bˇche_devi˚_dëach
(&
dc
->
disk
);

925 
	`li°_move
(&
dc
->
li°
, &
unˇched_devi˚s
);

927 
	`˛ór_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
);

928 
	`˛ór_bô
(
BCACHE_DEV_UNLINK_DONE
, &
dc
->
disk
.
Êags
);

930 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

932 
	`¥_öfo
("Cachög dißbÀd f‹ %s", 
	`bdev«me
(
dc
->
bdev
, 
buf
));

935 
	`˛osuª_put
(&
dc
->
disk
.
˛
);

936 
	}
}

938 
	$bch_ˇched_dev_dëach
(
ˇched_dev
 *
dc
)

940 
	`lockdï_as£π_hñd
(&
bch_ªgi°î_lock
);

942 i‡(
	`ã°_bô
(
BCACHE_DEV_CLOSING
, &
dc
->
disk
.
Êags
))

945 i‡(
	`ã°_™d_£t_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
))

952 
	`˛osuª_gë
(&
dc
->
disk
.
˛
);

954 
	`bch_wrôeback_queue
(
dc
);

955 
	`ˇched_dev_put
(
dc
);

956 
	}
}

958 
	$bch_ˇched_dev_©èch
(
ˇched_dev
 *
dc
, 
ˇche_£t
 *
c
)

960 
uöt32_t
 
πime
 = 
	`˝u_to_À32
(
	`gë_£c⁄ds
());

961 
uuid_íåy
 *
u
;

962 
buf
[
BDEVNAME_SIZE
];

964 
	`bdev«me
(
dc
->
bdev
, 
buf
);

966 i‡(
	`memcmp
(
dc
->
sb
.
£t_uuid
, 
c
->sb.set_uuid, 16))

967  -
ENOENT
;

969 i‡(
dc
->
disk
.
c
) {

970 
	`¥_îr
("C™'à©èch %s:áÃódyáâached", 
buf
);

971  -
EINVAL
;

974 i‡(
	`ã°_bô
(
CACHE_SET_STOPPING
, &
c
->
Êags
)) {

975 
	`¥_îr
("C™'à©èch %s: shuâög down", 
buf
);

976  -
EINVAL
;

979 i‡(
dc
->
sb
.
block_size
 < 
c
->sb.block_size) {

981 
	`¥_îr
("Couldn'táttach %s: block sizeÜessÅhan set's block size",

982 
buf
);

983  -
EINVAL
;

986 
u
 = 
	`uuid_föd
(
c
, 
dc
->
sb
.
uuid
);

988 i‡(
u
 &&

989 (
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_STALE
 ||

990 
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_NONE
)) {

991 
	`mem˝y
(
u
->
uuid
, 
övÆid_uuid
, 16);

992 
u
->
övÆid©ed
 = 
	`˝u_to_À32
(
	`gë_£c⁄ds
());

993 
u
 = 
NULL
;

996 i‡(!
u
) {

997 i‡(
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_DIRTY
) {

998 
	`¥_îr
("Couldn'àföd uuid f‹ %†ö së", 
buf
);

999  -
ENOENT
;

1002 
u
 = 
	`uuid_föd_em±y
(
c
);

1003 i‡(!
u
) {

1004 
	`¥_îr
("NŸ cachög %s,Çÿroom f‹ UUID", 
buf
);

1005  -
EINVAL
;

1013 i‡(
	`bch_is_zîo
(
u
->
uuid
, 16)) {

1014 
˛osuª
 
˛
;

1015 
	`˛osuª_öô_°ack
(&
˛
);

1017 
	`mem˝y
(
u
->
uuid
, 
dc
->
sb
.uuid, 16);

1018 
	`mem˝y
(
u
->
œbñ
, 
dc
->
sb
.œbñ, 
SB_LABEL_SIZE
);

1019 
u
->
fú°_ªg
 = u->
œ°_ªg
 = 
πime
;

1020 
	`bch_uuid_wrôe
(
c
);

1022 
	`mem˝y
(
dc
->
sb
.
£t_uuid
, 
c
->sb.set_uuid, 16);

1023 
	`SET_BDEV_STATE
(&
dc
->
sb
, 
BDEV_STATE_CLEAN
);

1025 
	`bch_wrôe_bdev_su≥r
(
dc
, &
˛
);

1026 
	`˛osuª_sync
(&
˛
);

1028 
u
->
œ°_ªg
 = 
πime
;

1029 
	`bch_uuid_wrôe
(
c
);

1032 
	`bˇche_devi˚_©èch
(&
dc
->
disk
, 
c
, 
u
 - c->
uuids
);

1033 
	`li°_move
(&
dc
->
li°
, &
c
->
ˇched_devs
);

1034 
	`ˇlc_ˇched_dev_£˘‹s
(
c
);

1036 
	`smp_wmb
();

1041 
	`©omic_£t
(&
dc
->
cou¡
, 1);

1043 i‡(
	`bch_ˇched_dev_wrôeback_°¨t
(
dc
))

1044  -
ENOMEM
;

1046 i‡(
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_DIRTY
) {

1047 
	`bch_£˘‹s_dúty_öô
(
dc
);

1048 
	`©omic_£t
(&
dc
->
has_dúty
, 1);

1049 
	`©omic_öc
(&
dc
->
cou¡
);

1050 
	`bch_wrôeback_queue
(
dc
);

1053 
	`bch_ˇched_dev_run
(
dc
);

1054 
	`bˇche_devi˚_lök
(&
dc
->
disk
, 
c
, "bdev");

1056 
	`¥_öfo
("Caching %sás %s on set %pU",

1057 
	`bdev«me
(
dc
->
bdev
, 
buf
), dc->
disk
.disk->
disk_«me
,

1058 
dc
->
disk
.
c
->
sb
.
£t_uuid
);

1060 
	}
}

1062 
	$bch_ˇched_dev_ªÀa£
(
kobje˘
 *
kobj
)

1064 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
kobj
, cached_dev,

1065 
disk
.
kobj
);

1066 
	`k‰ì
(
dc
);

1067 
	`moduÀ_put
(
THIS_MODULE
);

1068 
	}
}

1070 
	$ˇched_dev_‰ì
(
˛osuª
 *
˛
)

1072 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
˛
, ˇched_dev, 
disk
.cl);

1074 
	`ˇn˚l_dñayed_w‹k_sync
(&
dc
->
wrôeback_øã_upd©e
);

1075 i‡(!
	`IS_ERR_OR_NULL
(
dc
->
wrôeback_thªad
))

1076 
	`kthªad_°›
(
dc
->
wrôeback_thªad
);

1078 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1080 i‡(
	`©omic_ªad
(&
dc
->
ru¬ög
))

1081 
	`bd_u∆ök_disk_hﬁdî
(
dc
->
bdev
, dc->
disk
.disk);

1082 
	`bˇche_devi˚_‰ì
(&
dc
->
disk
);

1083 
	`li°_dñ
(&
dc
->
li°
);

1085 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1087 i‡(!
	`IS_ERR_OR_NULL
(
dc
->
bdev
))

1088 
	`blkdev_put
(
dc
->
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

1090 
	`wake_up
(&
uƒegi°î_waô
);

1092 
	`kobje˘_put
(&
dc
->
disk
.
kobj
);

1093 
	}
}

1095 
	$ˇched_dev_Êush
(
˛osuª
 *
˛
)

1097 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
˛
, ˇched_dev, 
disk
.cl);

1098 
bˇche_devi˚
 *
d
 = &
dc
->
disk
;

1100 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1101 
	`bˇche_devi˚_u∆ök
(
d
);

1102 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1104 
	`bch_ˇche_accou¡ög_de°roy
(&
dc
->
accou¡ög
);

1105 
	`kobje˘_dñ
(&
d
->
kobj
);

1107 
	`c⁄töue_©
(
˛
, 
ˇched_dev_‰ì
, 
sy°em_wq
);

1108 
	}
}

1110 
	$ˇched_dev_öô
(
ˇched_dev
 *
dc
, 
block_size
)

1112 
ªt
;

1113 
io
 *io;

1114 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dc
->
bdev
);

1116 
	`__moduÀ_gë
(
THIS_MODULE
);

1117 
	`INIT_LIST_HEAD
(&
dc
->
li°
);

1118 
	`˛osuª_öô
(&
dc
->
disk
.
˛
, 
NULL
);

1119 
	`£t_˛osuª_‚
(&
dc
->
disk
.
˛
, 
ˇched_dev_Êush
, 
sy°em_wq
);

1120 
	`kobje˘_öô
(&
dc
->
disk
.
kobj
, &
bch_ˇched_dev_kty≥
);

1121 
	`INIT_WORK
(&
dc
->
dëach
, 
ˇched_dev_dëach_föish
);

1122 
	`£ma_öô
(&
dc
->
sb_wrôe_muãx
, 1);

1123 
	`INIT_LIST_HEAD
(&
dc
->
io_Ãu
);

1124 
	`•ö_lock_öô
(&
dc
->
io_lock
);

1125 
	`bch_ˇche_accou¡ög_öô
(&
dc
->
accou¡ög
, &dc->
disk
.
˛
);

1127 
dc
->
£quítül_cutoff
 = 4 << 20;

1129 
io
 = 
dc
->io; iÿ< dc->iÿ+ 
RECENT_IO
; io++) {

1130 
	`li°_add
(&
io
->
Ãu
, &
dc
->
io_Ãu
);

1131 
	`hli°_add_hód
(&
io
->
hash
, 
dc
->
io_hash
 + 
RECENT_IO
);

1134 
dc
->
disk
.
°rùe_size
 = 
q
->
limôs
.
io_›t
 >> 9;

1136 i‡(
dc
->
disk
.
°rùe_size
)

1137 
dc
->
∑πül_°rùes_ex≥nsive
 =

1138 
q
->
limôs
.
øid_∑πül_°rùes_ex≥nsive
;

1140 
ªt
 = 
	`bˇche_devi˚_öô
(&
dc
->
disk
, 
block_size
,

1141 
dc
->
bdev
->
bd_∑π
->
ƒ_£˘s
 - dc->
sb
.
d©a_off£t
);

1142 i‡(
ªt
)

1143  
ªt
;

1145 
	`£t_ˇ∑côy
(
dc
->
disk
.disk,

1146 
dc
->
bdev
->
bd_∑π
->
ƒ_£˘s
 - dc->
sb
.
d©a_off£t
);

1148 
dc
->
disk
.disk->
queue
->
backög_dev_öfo
.
ø_∑ges
 =

1149 
	`max
(
dc
->
disk
.disk->
queue
->
backög_dev_öfo
.
ø_∑ges
,

1150 
q
->
backög_dev_öfo
.
ø_∑ges
);

1152 
	`bch_ˇched_dev_ªque°_öô
(
dc
);

1153 
	`bch_ˇched_dev_wrôeback_öô
(
dc
);

1155 
	}
}

1159 
	$ªgi°î_bdev
(
ˇche_sb
 *
sb
, 
∑ge
 *
sb_∑ge
,

1160 
block_devi˚
 *
bdev
,

1161 
ˇched_dev
 *
dc
)

1163 
«me
[
BDEVNAME_SIZE
];

1164 c⁄° *
îr
 = "cannotállocate memory";

1165 
ˇche_£t
 *
c
;

1167 
	`mem˝y
(&
dc
->
sb
, sb, (
ˇche_sb
));

1168 
dc
->
bdev
 = bdev;

1169 
dc
->
bdev
->
bd_hﬁdî
 = dc;

1171 
	`bio_öô
(&
dc
->
sb_bio
);

1172 
dc
->
sb_bio
.
bi_max_vecs
 = 1;

1173 
dc
->
sb_bio
.
bi_io_vec
 = dc->sb_bio.
bi_ölöe_vecs
;

1174 
dc
->
sb_bio
.
bi_io_vec
[0].
bv_∑ge
 = 
sb_∑ge
;

1175 
	`gë_∑ge
(
sb_∑ge
);

1177 i‡(
	`ˇched_dev_öô
(
dc
, 
sb
->
block_size
 << 9))

1178 
îr
;

1180 
îr
 = "error creating kobject";

1181 i‡(
	`kobje˘_add
(&
dc
->
disk
.
kobj
, &
	`∑π_to_dev
(
bdev
->
bd_∑π
)->kobj,

1183 
îr
;

1184 i‡(
	`bch_ˇche_accou¡ög_add_kobjs
(&
dc
->
accou¡ög
, &dc->
disk
.
kobj
))

1185 
îr
;

1187 
	`¥_öfo
("ªgi°îed backög devi˚ %s", 
	`bdev«me
(
bdev
, 
«me
));

1189 
	`li°_add
(&
dc
->
li°
, &
unˇched_devi˚s
);

1190 
	`li°_f‹_óch_íåy
(
c
, &
bch_ˇche_£ts
, 
li°
)

1191 
	`bch_ˇched_dev_©èch
(
dc
, 
c
);

1193 i‡(
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_NONE
 ||

1194 
	`BDEV_STATE
(&
dc
->
sb
Ë=
BDEV_STATE_STALE
)

1195 
	`bch_ˇched_dev_run
(
dc
);

1198 
îr
:

1199 
	`¥_nŸi˚
("îr‹ o≥nög %s: %s", 
	`bdev«me
(
bdev
, 
«me
), 
îr
);

1200 
	`bˇche_devi˚_°›
(&
dc
->
disk
);

1201 
	}
}

1205 
	$bch_Êash_dev_ªÀa£
(
kobje˘
 *
kobj
)

1207 
bˇche_devi˚
 *
d
 = 
	`c⁄èöî_of
(
kobj
, bcache_device,

1208 
kobj
);

1209 
	`k‰ì
(
d
);

1210 
	}
}

1212 
	$Êash_dev_‰ì
(
˛osuª
 *
˛
)

1214 
bˇche_devi˚
 *
d
 = 
	`c⁄èöî_of
(
˛
, bcache_device, cl);

1215 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1216 
	`bˇche_devi˚_‰ì
(
d
);

1217 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1218 
	`kobje˘_put
(&
d
->
kobj
);

1219 
	}
}

1221 
	$Êash_dev_Êush
(
˛osuª
 *
˛
)

1223 
bˇche_devi˚
 *
d
 = 
	`c⁄èöî_of
(
˛
, bcache_device, cl);

1225 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1226 
	`bˇche_devi˚_u∆ök
(
d
);

1227 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1228 
	`kobje˘_dñ
(&
d
->
kobj
);

1229 
	`c⁄töue_©
(
˛
, 
Êash_dev_‰ì
, 
sy°em_wq
);

1230 
	}
}

1232 
	$Êash_dev_run
(
ˇche_£t
 *
c
, 
uuid_íåy
 *
u
)

1234 
bˇche_devi˚
 *
d
 = 
	`kzÆloc
((bcache_device),

1235 
GFP_KERNEL
);

1236 i‡(!
d
)

1237  -
ENOMEM
;

1239 
	`˛osuª_öô
(&
d
->
˛
, 
NULL
);

1240 
	`£t_˛osuª_‚
(&
d
->
˛
, 
Êash_dev_Êush
, 
sy°em_wq
);

1242 
	`kobje˘_öô
(&
d
->
kobj
, &
bch_Êash_dev_kty≥
);

1244 i‡(
	`bˇche_devi˚_öô
(
d
, 
	`block_byãs
(
c
), 
u
->
£˘‹s
))

1245 
îr
;

1247 
	`bˇche_devi˚_©èch
(
d
, 
c
, 
u
 - c->
uuids
);

1248 
	`bch_Êash_dev_ªque°_öô
(
d
);

1249 
	`add_disk
(
d
->
disk
);

1251 i‡(
	`kobje˘_add
(&
d
->
kobj
, &
	`disk_to_dev
(d->
disk
)->kobj, "bcache"))

1252 
îr
;

1254 
	`bˇche_devi˚_lök
(
d
, 
c
, "volume");

1257 
îr
:

1258 
	`kobje˘_put
(&
d
->
kobj
);

1259  -
ENOMEM
;

1260 
	}
}

1262 
	$Êash_devs_run
(
ˇche_£t
 *
c
)

1264 
ªt
 = 0;

1265 
uuid_íåy
 *
u
;

1267 
u
 = 
c
->
uuids
;

1268 
u
 < 
c
->
uuids
 + c->
ƒ_uuids
 && !
ªt
;

1269 
u
++)

1270 i‡(
	`UUID_FLASH_ONLY
(
u
))

1271 
ªt
 = 
	`Êash_dev_run
(
c
, 
u
);

1273  
ªt
;

1274 
	}
}

1276 
	$bch_Êash_dev_¸óã
(
ˇche_£t
 *
c
, 
uöt64_t
 
size
)

1278 
uuid_íåy
 *
u
;

1280 i‡(
	`ã°_bô
(
CACHE_SET_STOPPING
, &
c
->
Êags
))

1281  -
EINTR
;

1283 i‡(!
	`ã°_bô
(
CACHE_SET_RUNNING
, &
c
->
Êags
))

1284  -
EPERM
;

1286 
u
 = 
	`uuid_föd_em±y
(
c
);

1287 i‡(!
u
) {

1288 
	`¥_îr
("Can't create volume,ÇoÑoom for UUID");

1289  -
EINVAL
;

1292 
	`gë_øndom_byãs
(
u
->
uuid
, 16);

1293 
	`mem£t
(
u
->
œbñ
, 0, 32);

1294 
u
->
fú°_ªg
 = u->
œ°_ªg
 = 
	`˝u_to_À32
(
	`gë_£c⁄ds
());

1296 
	`SET_UUID_FLASH_ONLY
(
u
, 1);

1297 
u
->
£˘‹s
 = 
size
 >> 9;

1299 
	`bch_uuid_wrôe
(
c
);

1301  
	`Êash_dev_run
(
c
, 
u
);

1302 
	}
}

1306 
	$__¥ötf
(2, 3)

1307 
boﬁ
 
	$bch_ˇche_£t_îr‹
(
ˇche_£t
 *
c
, c⁄° *
fmt
, ...)

1309 
va_li°
 
¨gs
;

1311 i‡(
c
->
⁄_îr‹
 !
ON_ERROR_PANIC
 &&

1312 
	`ã°_bô
(
CACHE_SET_STOPPING
, &
c
->
Êags
))

1313  
Ál£
;

1319 
	`¥ötk
(
KERN_ERR
 "bˇche:Éº‹ o¿%pU: ", 
c
->
sb
.
£t_uuid
);

1321 
	`va_°¨t
(
¨gs
, 
fmt
);

1322 
	`v¥ötk
(
fmt
, 
¨gs
);

1323 
	`va_íd
(
¨gs
);

1325 
	`¥ötk
(", disabling caching\n");

1327 i‡(
c
->
⁄_îr‹
 =
ON_ERROR_PANIC
)

1328 
	`∑nic
("panic forcedáfterÉrror\n");

1330 
	`bch_ˇche_£t_uƒegi°î
(
c
);

1331  
åue
;

1332 
	}
}

1334 
	$bch_ˇche_£t_ªÀa£
(
kobje˘
 *
kobj
)

1336 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
kobj
, cache_set, kobj);

1337 
	`k‰ì
(
c
);

1338 
	`moduÀ_put
(
THIS_MODULE
);

1339 
	}
}

1341 
	$ˇche_£t_‰ì
(
˛osuª
 *
˛
)

1343 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, cache_set, cl);

1344 
ˇche
 *
ˇ
;

1345 
i
;

1347 i‡(!
	`IS_ERR_OR_NULL
(
c
->
debug
))

1348 
	`debugfs_ªmove
(
c
->
debug
);

1350 
	`bch_›í_buckës_‰ì
(
c
);

1351 
	`bch_båì_ˇche_‰ì
(
c
);

1352 
	`bch_jou∫Æ_‰ì
(
c
);

1354 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1355 i‡(
ˇ
) {

1356 
ˇ
->
£t
 = 
NULL
;

1357 
c
->
ˇche
[
ˇ
->
sb
.
ƒ_this_dev
] = 
NULL
;

1358 
	`kobje˘_put
(&
ˇ
->
kobj
);

1361 
	`bch_b£t_s‹t_°©e_‰ì
(&
c
->
s‹t
);

1362 
	`‰ì_∑ges
((Ë
c
->
uuids
, 
	`ûog2
(
	`buckë_∑ges
(c)));

1364 i‡(
c
->
movög_gc_wq
)

1365 
	`de°roy_w‹kqueue
(
c
->
movög_gc_wq
);

1366 i‡(
c
->
bio_•lô
)

1367 
	`bio£t_‰ì
(
c
->
bio_•lô
);

1368 i‡(
c
->
fûl_ôî
)

1369 
	`mempoﬁ_de°roy
(
c
->
fûl_ôî
);

1370 i‡(
c
->
bio_mëa
)

1371 
	`mempoﬁ_de°roy
(
c
->
bio_mëa
);

1372 i‡(
c
->
£¨ch
)

1373 
	`mempoﬁ_de°roy
(
c
->
£¨ch
);

1374 
	`k‰ì
(
c
->
devi˚s
);

1376 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1377 
	`li°_dñ
(&
c
->
li°
);

1378 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1380 
	`¥_öfo
("Cachê£à%pU uƒegi°îed", 
c
->
sb
.
£t_uuid
);

1381 
	`wake_up
(&
uƒegi°î_waô
);

1383 
	`˛osuª_debug_de°roy
(&
c
->
˛
);

1384 
	`kobje˘_put
(&
c
->
kobj
);

1385 
	}
}

1387 
	$ˇche_£t_Êush
(
˛osuª
 *
˛
)

1389 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
ˇchög
);

1390 
ˇche
 *
ˇ
;

1391 
båì
 *
b
;

1392 
i
;

1394 
	`bch_ˇche_accou¡ög_de°roy
(&
c
->
accou¡ög
);

1396 
	`kobje˘_put
(&
c
->
öã∫Æ
);

1397 
	`kobje˘_dñ
(&
c
->
kobj
);

1399 i‡(
c
->
gc_thªad
)

1400 
	`kthªad_°›
(
c
->
gc_thªad
);

1402 i‡(!
	`IS_ERR_OR_NULL
(
c
->
roŸ
))

1403 
	`li°_add
(&
c
->
roŸ
->
li°
, &c->
båì_ˇche
);

1406 
	`li°_f‹_óch_íåy
(
b
, &
c
->
båì_ˇche
, 
li°
) {

1407 
	`muãx_lock
(&
b
->
wrôe_lock
);

1408 i‡(
	`båì_node_dúty
(
b
))

1409 
	`__bch_båì_node_wrôe
(
b
, 
NULL
);

1410 
	`muãx_u∆ock
(&
b
->
wrôe_lock
);

1413 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1414 i‡(
ˇ
->
Æloc_thªad
)

1415 
	`kthªad_°›
(
ˇ
->
Æloc_thªad
);

1417 i‡(
c
->
jou∫Æ
.
cur
) {

1418 
	`ˇn˚l_dñayed_w‹k_sync
(&
c
->
jou∫Æ
.
w‹k
);

1420 
c
->
jou∫Æ
.
w‹k
.w‹k.
	`func
(&c->journal.work.work);

1423 
	`˛osuª_ªtu∫
(
˛
);

1424 
	}
}

1426 
	$__ˇche_£t_uƒegi°î
(
˛osuª
 *
˛
)

1428 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
˛
, ˇche_£t, 
ˇchög
);

1429 
ˇched_dev
 *
dc
;

1430 
size_t
 
i
;

1432 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1434 
i
 = 0; i < 
c
->
ƒ_uuids
; i++)

1435 i‡(
c
->
devi˚s
[
i
]) {

1436 i‡(!
	`UUID_FLASH_ONLY
(&
c
->
uuids
[
i
]) &&

1437 
	`ã°_bô
(
CACHE_SET_UNREGISTERING
, &
c
->
Êags
)) {

1438 
dc
 = 
	`c⁄èöî_of
(
c
->
devi˚s
[
i
],

1439 
ˇched_dev
, 
disk
);

1440 
	`bch_ˇched_dev_dëach
(
dc
);

1442 
	`bˇche_devi˚_°›
(
c
->
devi˚s
[
i
]);

1446 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1448 
	`c⁄töue_©
(
˛
, 
ˇche_£t_Êush
, 
sy°em_wq
);

1449 
	}
}

1451 
	$bch_ˇche_£t_°›
(
ˇche_£t
 *
c
)

1453 i‡(!
	`ã°_™d_£t_bô
(
CACHE_SET_STOPPING
, &
c
->
Êags
))

1454 
	`˛osuª_queue
(&
c
->
ˇchög
);

1455 
	}
}

1457 
	$bch_ˇche_£t_uƒegi°î
(
ˇche_£t
 *
c
)

1459 
	`£t_bô
(
CACHE_SET_UNREGISTERING
, &
c
->
Êags
);

1460 
	`bch_ˇche_£t_°›
(
c
);

1461 
	}
}

1463 
	#Æloc_buckë_∑ges
(
gÂ
, 
c
) \

1464 ((*Ë
	`__gë_‰ì_∑ges
(
__GFP_ZERO
|
gÂ
, 
	`ûog2
(
	`buckë_∑ges
(
c
))))

	)

1466 
ˇche_£t
 *
	$bch_ˇche_£t_Æloc
(
ˇche_sb
 *
sb
)

1468 
ôî_size
;

1469 
ˇche_£t
 *
c
 = 
	`kzÆloc
((ˇche_£t), 
GFP_KERNEL
);

1470 i‡(!
c
)

1471  
NULL
;

1473 
	`__moduÀ_gë
(
THIS_MODULE
);

1474 
	`˛osuª_öô
(&
c
->
˛
, 
NULL
);

1475 
	`£t_˛osuª_‚
(&
c
->
˛
, 
ˇche_£t_‰ì
, 
sy°em_wq
);

1477 
	`˛osuª_öô
(&
c
->
ˇchög
, &c->
˛
);

1478 
	`£t_˛osuª_‚
(&
c
->
ˇchög
, 
__ˇche_£t_uƒegi°î
, 
sy°em_wq
);

1481 
	`˛osuª_£t_°›≥d
(&
c
->
˛
);

1482 
	`˛osuª_put
(&
c
->
˛
);

1484 
	`kobje˘_öô
(&
c
->
kobj
, &
bch_ˇche_£t_kty≥
);

1485 
	`kobje˘_öô
(&
c
->
öã∫Æ
, &
bch_ˇche_£t_öã∫Æ_kty≥
);

1487 
	`bch_ˇche_accou¡ög_öô
(&
c
->
accou¡ög
, &c->
˛
);

1489 
	`mem˝y
(
c
->
sb
.
£t_uuid
, sb->set_uuid, 16);

1490 
c
->
sb
.
block_size
 = sb->block_size;

1491 
c
->
sb
.
buckë_size
 = sb->bucket_size;

1492 
c
->
sb
.
ƒ_ö_£t
 = sb->nr_in_set;

1493 
c
->
sb
.
œ°_mou¡
 = sb->last_mount;

1494 
c
->
buckë_bôs
 = 
	`ûog2
(
sb
->
buckë_size
);

1495 
c
->
block_bôs
 = 
	`ûog2
(
sb
->
block_size
);

1496 
c
->
ƒ_uuids
 = 
	`buckë_byãs
(cË/ (
uuid_íåy
);

1498 
c
->
båì_∑ges
 = 
	`buckë_∑ges
(c);

1499 i‡(
c
->
båì_∑ges
 > 
BTREE_MAX_PAGES
)

1500 
c
->
båì_∑ges
 = 
	`max_t
(, c->btree_pages / 4,

1501 
BTREE_MAX_PAGES
);

1503 
	`£ma_öô
(&
c
->
sb_wrôe_muãx
, 1);

1504 
	`muãx_öô
(&
c
->
buckë_lock
);

1505 
	`öô_waôqueue_hód
(&
c
->
båì_ˇche_waô
);

1506 
	`öô_waôqueue_hód
(&
c
->
buckë_waô
);

1507 
	`£ma_öô
(&
c
->
uuid_wrôe_muãx
, 1);

1509 
	`•ö_lock_öô
(&
c
->
båì_gc_time
.
lock
);

1510 
	`•ö_lock_öô
(&
c
->
båì_•lô_time
.
lock
);

1511 
	`•ö_lock_öô
(&
c
->
båì_ªad_time
.
lock
);

1513 
	`bch_movög_öô_ˇche_£t
(
c
);

1515 
	`INIT_LIST_HEAD
(&
c
->
li°
);

1516 
	`INIT_LIST_HEAD
(&
c
->
ˇched_devs
);

1517 
	`INIT_LIST_HEAD
(&
c
->
båì_ˇche
);

1518 
	`INIT_LIST_HEAD
(&
c
->
båì_ˇche_‰ìabÀ
);

1519 
	`INIT_LIST_HEAD
(&
c
->
båì_ˇche_‰ìd
);

1520 
	`INIT_LIST_HEAD
(&
c
->
d©a_buckës
);

1522 
c
->
£¨ch
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(32, 
bch_£¨ch_ˇche
);

1523 i‡(!
c
->
£¨ch
)

1524 
îr
;

1526 
ôî_size
 = (
sb
->
buckë_size
 / sb->
block_size
 + 1) *

1527 (
båì_ôî_£t
);

1529 i‡(!(
c
->
devi˚s
 = 
	`kzÆloc
(c->
ƒ_uuids
 * (*), 
GFP_KERNEL
)) ||

1530 !(
c
->
bio_mëa
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(2,

1531 (
bbio
Ë+ (
bio_vec
) *

1532 
	`buckë_∑ges
(
c
))) ||

1533 !(
c
->
fûl_ôî
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(1, 
ôî_size
)) ||

1534 !(
c
->
bio_•lô
 = 
	`bio£t_¸óã
(4, 
	`off£tof
(
bbio
, 
bio
))) ||

1535 !(
c
->
uuids
 = 
	`Æloc_buckë_∑ges
(
GFP_KERNEL
, c)) ||

1536 !(
c
->
movög_gc_wq
 = 
	`¸óã_w‹kqueue
("bcache_gc")) ||

1537 
	`bch_jou∫Æ_Æloc
(
c
) ||

1538 
	`bch_båì_ˇche_Æloc
(
c
) ||

1539 
	`bch_›í_buckës_Æloc
(
c
) ||

1540 
	`bch_b£t_s‹t_°©e_öô
(&
c
->
s‹t
, 
	`ûog2
(c->
båì_∑ges
)))

1541 
îr
;

1543 
c
->
c⁄ge°ed_ªad_thªshﬁd_us
 = 2000;

1544 
c
->
c⁄ge°ed_wrôe_thªshﬁd_us
 = 20000;

1545 
c
->
îr‹_limô
 = 8 << 
IO_ERROR_SHIFT
;

1547  
c
;

1548 
îr
:

1549 
	`bch_ˇche_£t_uƒegi°î
(
c
);

1550  
NULL
;

1551 
	}
}

1553 
	$run_ˇche_£t
(
ˇche_£t
 *
c
)

1555 c⁄° *
îr
 = "cannotállocate memory";

1556 
ˇched_dev
 *
dc
, *
t
;

1557 
ˇche
 *
ˇ
;

1558 
˛osuª
 
˛
;

1559 
i
;

1561 
	`˛osuª_öô_°ack
(&
˛
);

1563 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1564 
c
->
nbuckës
 +
ˇ
->
sb
.nbuckets;

1566 i‡(
	`CACHE_SYNC
(&
c
->
sb
)) {

1567 
	`LIST_HEAD
(
jou∫Æ
);

1568 
bkey
 *
k
;

1569 
j£t
 *
j
;

1571 
îr
 = "cannotállocate memory for journal";

1572 i‡(
	`bch_jou∫Æ_ªad
(
c
, &
jou∫Æ
))

1573 
îr
;

1575 
	`¥_debug
("btree_journal_read() done");

1577 
îr
 = "no journalÉntries found";

1578 i‡(
	`li°_em±y
(&
jou∫Æ
))

1579 
îr
;

1581 
j
 = &
	`li°_íåy
(
jou∫Æ
.
¥ev
, 
jou∫Æ_ª∂ay
, 
li°
)->j;

1583 
îr
 = "IOÉrrorÑeadingÖriorities";

1584 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1585 
	`¥io_ªad
(
ˇ
, 
j
->
¥io_buckë
[ˇ->
sb
.
ƒ_this_dev
]);

1593 
k
 = &
j
->
båì_roŸ
;

1595 
îr
 = "bad btreeÑoot";

1596 i‡(
	`__bch_båì_±r_övÆid
(
c
, 
k
))

1597 
îr
;

1599 
îr
 = "errorÑeading btreeÑoot";

1600 
c
->
roŸ
 = 
	`bch_båì_node_gë
(c, 
NULL
, 
k
, 
j
->
båì_Àvñ
, 
åue
, NULL);

1601 i‡(
	`IS_ERR_OR_NULL
(
c
->
roŸ
))

1602 
îr
;

1604 
	`li°_dñ_öô
(&
c
->
roŸ
->
li°
);

1605 
	`rw_u∆ock
(
åue
, 
c
->
roŸ
);

1607 
îr
 = 
	`uuid_ªad
(
c
, 
j
, &
˛
);

1608 i‡(
îr
)

1609 
îr
;

1611 
îr
 = "error inÑecovery";

1612 i‡(
	`bch_båì_check
(
c
))

1613 
îr
;

1615 
	`bch_jou∫Æ_m¨k
(
c
, &
jou∫Æ
);

1616 
	`bch_öôül_gc_föish
(
c
);

1617 
	`¥_debug
("btree_check() done");

1624 
	`bch_jou∫Æ_√xt
(&
c
->
jou∫Æ
);

1626 
îr
 = "error startingállocatorÅhread";

1627 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1628 i‡(
	`bch_ˇche_Æloˇt‹_°¨t
(
ˇ
))

1629 
îr
;

1641 i‡(
j
->
vîsi⁄
 < 
BCACHE_JSET_VERSION_UUID
)

1642 
	`__uuid_wrôe
(
c
);

1644 
	`bch_jou∫Æ_ª∂ay
(
c
, &
jou∫Æ
);

1646 
	`¥_nŸi˚
("invalidatingÉxisting data");

1648 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
) {

1649 
j
;

1651 
ˇ
->
sb
.
keys
 = 
	`˛amp_t
(, ca->sb.
nbuckës
 >> 7,

1652 2, 
SB_JOURNAL_BUCKETS
);

1654 
j
 = 0; j < 
ˇ
->
sb
.
keys
; j++)

1655 
ˇ
->
sb
.
d
[
j
] = ca->sb.
fú°_buckë
 + j;

1658 
	`bch_öôül_gc_föish
(
c
);

1660 
îr
 = "error startingállocatorÅhread";

1661 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1662 i‡(
	`bch_ˇche_Æloˇt‹_°¨t
(
ˇ
))

1663 
îr
;

1665 
	`muãx_lock
(&
c
->
buckë_lock
);

1666 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1667 
	`bch_¥io_wrôe
(
ˇ
);

1668 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

1670 
îr
 = "cannotállocateÇew UUID bucket";

1671 i‡(
	`__uuid_wrôe
(
c
))

1672 
îr
;

1674 
îr
 = "cannotállocateÇew btreeÑoot";

1675 
c
->
roŸ
 = 
	`__bch_båì_node_Æloc
(c, 
NULL
, 0, 
åue
, NULL);

1676 i‡(
	`IS_ERR_OR_NULL
(
c
->
roŸ
))

1677 
îr
;

1679 
	`muãx_lock
(&
c
->
roŸ
->
wrôe_lock
);

1680 
	`bkey_c›y_key
(&
c
->
roŸ
->
key
, &
MAX_KEY
);

1681 
	`bch_båì_node_wrôe
(
c
->
roŸ
, &
˛
);

1682 
	`muãx_u∆ock
(&
c
->
roŸ
->
wrôe_lock
);

1684 
	`bch_båì_£t_roŸ
(
c
->
roŸ
);

1685 
	`rw_u∆ock
(
åue
, 
c
->
roŸ
);

1692 
	`SET_CACHE_SYNC
(&
c
->
sb
, 
åue
);

1694 
	`bch_jou∫Æ_√xt
(&
c
->
jou∫Æ
);

1695 
	`bch_jou∫Æ_mëa
(
c
, &
˛
);

1698 
îr
 = "error starting gcÅhread";

1699 i‡(
	`bch_gc_thªad_°¨t
(
c
))

1700 
îr
;

1702 
	`˛osuª_sync
(&
˛
);

1703 
c
->
sb
.
œ°_mou¡
 = 
	`gë_£c⁄ds
();

1704 
	`bˇche_wrôe_su≥r
(
c
);

1706 
	`li°_f‹_óch_íåy_ß„
(
dc
, 
t
, &
unˇched_devi˚s
, 
li°
)

1707 
	`bch_ˇched_dev_©èch
(
dc
, 
c
);

1709 
	`Êash_devs_run
(
c
);

1711 
	`£t_bô
(
CACHE_SET_RUNNING
, &
c
->
Êags
);

1713 
îr
:

1714 
	`˛osuª_sync
(&
˛
);

1716 
	`bch_ˇche_£t_îr‹
(
c
, "%s", 
îr
);

1717 
	}
}

1719 
boﬁ
 
	$ˇn_©èch_ˇche
(
ˇche
 *
ˇ
, 
ˇche_£t
 *
c
)

1721  
ˇ
->
sb
.
block_size
 =
c
->sb.block_size &&

1722 
ˇ
->
sb
.
buckë_size
 =
c
->sb.bucket_size &&

1723 
ˇ
->
sb
.
ƒ_ö_£t
 =
c
->sb.nr_in_set;

1724 
	}
}

1726 c⁄° *
	$ªgi°î_ˇche_£t
(
ˇche
 *
ˇ
)

1728 
buf
[12];

1729 c⁄° *
îr
 = "cannotállocate memory";

1730 
ˇche_£t
 *
c
;

1732 
	`li°_f‹_óch_íåy
(
c
, &
bch_ˇche_£ts
, 
li°
)

1733 i‡(!
	`memcmp
(
c
->
sb
.
£t_uuid
, 
ˇ
->sb.set_uuid, 16)) {

1734 i‡(
c
->
ˇche
[
ˇ
->
sb
.
ƒ_this_dev
])

1737 i‡(!
	`ˇn_©èch_ˇche
(
ˇ
, 
c
))

1740 i‡(!
	`CACHE_SYNC
(&
ˇ
->
sb
))

1741 
	`SET_CACHE_SYNC
(&
c
->
sb
, 
Ál£
);

1743 
found
;

1746 
c
 = 
	`bch_ˇche_£t_Æloc
(&
ˇ
->
sb
);

1747 i‡(!
c
)

1748  
îr
;

1750 
îr
 = "error creating kobject";

1751 i‡(
	`kobje˘_add
(&
c
->
kobj
, 
bˇche_kobj
, "%pU", c->
sb
.
£t_uuid
) ||

1752 
	`kobje˘_add
(&
c
->
öã∫Æ
, &c->
kobj
, "internal"))

1753 
îr
;

1755 i‡(
	`bch_ˇche_accou¡ög_add_kobjs
(&
c
->
accou¡ög
, &c->
kobj
))

1756 
îr
;

1758 
	`bch_debug_öô_ˇche_£t
(
c
);

1760 
	`li°_add
(&
c
->
li°
, &
bch_ˇche_£ts
);

1761 
found
:

1762 
	`•rötf
(
buf
, "ˇche%i", 
ˇ
->
sb
.
ƒ_this_dev
);

1763 i‡(
	`sysfs_¸óã_lök
(&
ˇ
->
kobj
, &
c
->kobj, "set") ||

1764 
	`sysfs_¸óã_lök
(&
c
->
kobj
, &
ˇ
->kobj, 
buf
))

1765 
îr
;

1767 i‡(
ˇ
->
sb
.
£q
 > 
c
->sb.seq) {

1768 
c
->
sb
.
vîsi⁄
 = 
ˇ
->sb.version;

1769 
	`mem˝y
(
c
->
sb
.
£t_uuid
, 
ˇ
->sb.set_uuid, 16);

1770 
c
->
sb
.
Êags
 = 
ˇ
->sb.flags;

1771 
c
->
sb
.
£q
 = 
ˇ
->sb.seq;

1772 
	`¥_debug
("£àvîsi⁄ = %Œu", 
c
->
sb
.
vîsi⁄
);

1775 
	`kobje˘_gë
(&
ˇ
->
kobj
);

1776 
ˇ
->
£t
 = 
c
;

1777 
ˇ
->
£t
->
ˇche
[ˇ->
sb
.
ƒ_this_dev
] = ca;

1778 
c
->
ˇche_by_Æloc
[c->
ˇches_lﬂded
++] = 
ˇ
;

1780 i‡(
c
->
ˇches_lﬂded
 =c->
sb
.
ƒ_ö_£t
)

1781 
	`run_ˇche_£t
(
c
);

1783  
NULL
;

1784 
îr
:

1785 
	`bch_ˇche_£t_uƒegi°î
(
c
);

1786  
îr
;

1787 
	}
}

1791 
	$bch_ˇche_ªÀa£
(
kobje˘
 *
kobj
)

1793 
ˇche
 *
ˇ
 = 
	`c⁄èöî_of
(
kobj
, cache, kobj);

1794 
i
;

1796 i‡(
ˇ
->
£t
) {

1797 
	`BUG_ON
(
ˇ
->
£t
->
ˇche
[ˇ->
sb
.
ƒ_this_dev
] != ca);

1798 
ˇ
->
£t
->
ˇche
[ˇ->
sb
.
ƒ_this_dev
] = 
NULL
;

1801 
	`bio_•lô_poﬁ_‰ì
(&
ˇ
->
bio_•lô_hook
);

1803 
	`‰ì_∑ges
((Ë
ˇ
->
disk_buckës
, 
	`ûog2
(
	`buckë_∑ges
(ca)));

1804 
	`k‰ì
(
ˇ
->
¥io_buckës
);

1805 
	`v‰ì
(
ˇ
->
buckës
);

1807 
	`‰ì_hóp
(&
ˇ
->
hóp
);

1808 
	`‰ì_fifo
(&
ˇ
->
‰ì_öc
);

1810 
i
 = 0; i < 
RESERVE_NR
; i++)

1811 
	`‰ì_fifo
(&
ˇ
->
‰ì
[
i
]);

1813 i‡(
ˇ
->
sb_bio
.
bi_ölöe_vecs
[0].
bv_∑ge
)

1814 
	`put_∑ge
(
ˇ
->
sb_bio
.
bi_io_vec
[0].
bv_∑ge
);

1816 i‡(!
	`IS_ERR_OR_NULL
(
ˇ
->
bdev
))

1817 
	`blkdev_put
(
ˇ
->
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

1819 
	`k‰ì
(
ˇ
);

1820 
	`moduÀ_put
(
THIS_MODULE
);

1821 
	}
}

1823 
	$ˇche_Æloc
(
ˇche_sb
 *
sb
, 
ˇche
 *
ˇ
)

1825 
size_t
 
‰ì
;

1826 
buckë
 *
b
;

1828 
	`__moduÀ_gë
(
THIS_MODULE
);

1829 
	`kobje˘_öô
(&
ˇ
->
kobj
, &
bch_ˇche_kty≥
);

1831 
	`bio_öô
(&
ˇ
->
jou∫Æ
.
bio
);

1832 
ˇ
->
jou∫Æ
.
bio
.
bi_max_vecs
 = 8;

1833 
ˇ
->
jou∫Æ
.
bio
.
bi_io_vec
 = ca->jou∫Æ.bio.
bi_ölöe_vecs
;

1835 
‰ì
 = 
	`roundup_pow_of_two
(
ˇ
->
sb
.
nbuckës
) >> 10;

1837 i‡(!
	`öô_fifo
(&
ˇ
->
‰ì
[
RESERVE_BTREE
], 8, 
GFP_KERNEL
) ||

1838 !
	`öô_fifo
(&
ˇ
->
‰ì
[
RESERVE_PRIO
], 
	`¥io_buckës
(ˇ), 
GFP_KERNEL
) ||

1839 !
	`öô_fifo
(&
ˇ
->
‰ì
[
RESERVE_MOVINGGC
], fªe, 
GFP_KERNEL
) ||

1840 !
	`öô_fifo
(&
ˇ
->
‰ì
[
RESERVE_NONE
], fªe, 
GFP_KERNEL
) ||

1841 !
	`öô_fifo
(&
ˇ
->
‰ì_öc
, 
‰ì
 << 2, 
GFP_KERNEL
) ||

1842 !
	`öô_hóp
(&
ˇ
->
hóp
, 
‰ì
 << 3, 
GFP_KERNEL
) ||

1843 !(
ˇ
->
buckës
 = 
	`vzÆloc
((
buckë
) *

1844 
ˇ
->
sb
.
nbuckës
)) ||

1845 !(
ˇ
->
¥io_buckës
 = 
	`kzÆloc
((
uöt64_t
Ë* 
	`¥io_buckës
(ca) *

1846 2, 
GFP_KERNEL
)) ||

1847 !(
ˇ
->
disk_buckës
 = 
	`Æloc_buckë_∑ges
(
GFP_KERNEL
, ca)) ||

1848 
	`bio_•lô_poﬁ_öô
(&
ˇ
->
bio_•lô_hook
))

1849  -
ENOMEM
;

1851 
ˇ
->
¥io_œ°_buckës
 = ca->
¥io_buckës
 + 
	`¥io_buckës
(ca);

1853 
	`f‹_óch_buckë
(
b
, 
ˇ
)

1854 
	`©omic_£t
(&
b
->
pö
, 0);

1857 
	}
}

1859 
	$ªgi°î_ˇche
(
ˇche_sb
 *
sb
, 
∑ge
 *
sb_∑ge
,

1860 
block_devi˚
 *
bdev
, 
ˇche
 *
ˇ
)

1862 
«me
[
BDEVNAME_SIZE
];

1863 c⁄° *
îr
 = "cannotállocate memory";

1865 
	`mem˝y
(&
ˇ
->
sb
, sb, (
ˇche_sb
));

1866 
ˇ
->
bdev
 = bdev;

1867 
ˇ
->
bdev
->
bd_hﬁdî
 = ca;

1869 
	`bio_öô
(&
ˇ
->
sb_bio
);

1870 
ˇ
->
sb_bio
.
bi_max_vecs
 = 1;

1871 
ˇ
->
sb_bio
.
bi_io_vec
 = ca->sb_bio.
bi_ölöe_vecs
;

1872 
ˇ
->
sb_bio
.
bi_io_vec
[0].
bv_∑ge
 = 
sb_∑ge
;

1873 
	`gë_∑ge
(
sb_∑ge
);

1875 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
ˇ
->
bdev
)))

1876 
ˇ
->
disˇrd
 = 
	`CACHE_DISCARD
(&ˇ->
sb
);

1878 i‡(
	`ˇche_Æloc
(
sb
, 
ˇ
) != 0)

1879 
îr
;

1881 
îr
 = "error creating kobject";

1882 i‡(
	`kobje˘_add
(&
ˇ
->
kobj
, &
	`∑π_to_dev
(
bdev
->
bd_∑π
)->kobj, "bcache"))

1883 
îr
;

1885 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1886 
îr
 = 
	`ªgi°î_ˇche_£t
(
ˇ
);

1887 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1889 i‡(
îr
)

1890 
îr
;

1892 
	`¥_öfo
("ªgi°îed cachêdevi˚ %s", 
	`bdev«me
(
bdev
, 
«me
));

1893 
out
:

1894 
	`kobje˘_put
(&
ˇ
->
kobj
);

1896 
îr
:

1897 
	`¥_nŸi˚
("îr‹ o≥nög %s: %s", 
	`bdev«me
(
bdev
, 
«me
), 
îr
);

1898 
out
;

1899 
	}
}

1903 
ssize_t
 
ªgi°î_bˇche
(
kobje˘
 *, 
kobj_©åibuã
 *,

1904 c⁄° *, 
size_t
);

1906 
kobj_©åibuã_wrôe
(, 
ªgi°î_bˇche
);

1907 
kobj_©åibuã_wrôe
(
ªgi°î_quõt
, 
ªgi°î_bˇche
);

1909 
boﬁ
 
	$bch_is_›í_backög
(
block_devi˚
 *
bdev
) {

1910 
ˇche_£t
 *
c
, *
tc
;

1911 
ˇched_dev
 *
dc
, *
t
;

1913 
	`li°_f‹_óch_íåy_ß„
(
c
, 
tc
, &
bch_ˇche_£ts
, 
li°
)

1914 
	`li°_f‹_óch_íåy_ß„
(
dc
, 
t
, &
c
->
ˇched_devs
, 
li°
)

1915 i‡(
dc
->
bdev
 == bdev)

1916  
åue
;

1917 
	`li°_f‹_óch_íåy_ß„
(
dc
, 
t
, &
unˇched_devi˚s
, 
li°
)

1918 i‡(
dc
->
bdev
 == bdev)

1919  
åue
;

1920  
Ál£
;

1921 
	}
}

1923 
boﬁ
 
	$bch_is_›í_ˇche
(
block_devi˚
 *
bdev
) {

1924 
ˇche_£t
 *
c
, *
tc
;

1925 
ˇche
 *
ˇ
;

1926 
i
;

1928 
	`li°_f‹_óch_íåy_ß„
(
c
, 
tc
, &
bch_ˇche_£ts
, 
li°
)

1929 
	`f‹_óch_ˇche
(
ˇ
, 
c
, 
i
)

1930 i‡(
ˇ
->
bdev
 == bdev)

1931  
åue
;

1932  
Ál£
;

1933 
	}
}

1935 
boﬁ
 
	$bch_is_›í
(
block_devi˚
 *
bdev
) {

1936  
	`bch_is_›í_ˇche
(
bdev
Ë|| 
	`bch_is_›í_backög
(bdev);

1937 
	}
}

1939 
ssize_t
 
	$ªgi°î_bˇche
(
kobje˘
 *
k
, 
kobj_©åibuã
 *
©å
,

1940 c⁄° *
buf„r
, 
size_t
 
size
)

1942 
ssize_t
 
ªt
 = 
size
;

1943 c⁄° *
îr
 = "cannotállocate memory";

1944 *
∑th
 = 
NULL
;

1945 
ˇche_sb
 *
sb
 = 
NULL
;

1946 
block_devi˚
 *
bdev
 = 
NULL
;

1947 
∑ge
 *
sb_∑ge
 = 
NULL
;

1949 i‡(!
	`åy_moduÀ_gë
(
THIS_MODULE
))

1950  -
EBUSY
;

1952 i‡(!(
∑th
 = 
	`k°∫dup
(
buf„r
, 
size
, 
GFP_KERNEL
)) ||

1953 !(
sb
 = 
	`kmÆloc
((
ˇche_sb
), 
GFP_KERNEL
)))

1954 
îr
;

1956 
îr
 = "failedÅo open device";

1957 
bdev
 = 
	`blkdev_gë_by_∑th
(
	`°rim
(
∑th
),

1958 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
,

1959 
sb
);

1960 i‡(
	`IS_ERR
(
bdev
)) {

1961 i‡(
bdev
 =
	`ERR_PTR
(-
EBUSY
)) {

1962 
bdev
 = 
	`lookup_bdev
(
	`°rim
(
∑th
));

1963 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1964 i‡(!
	`IS_ERR
(
bdev
Ë&& 
	`bch_is_›í
(bdev))

1965 
îr
 = "deviceálreadyÑegistered";

1967 
îr
 = "device busy";

1968 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1970 
îr
;

1973 
îr
 = "failedÅo set blocksize";

1974 i‡(
	`£t_blocksize
(
bdev
, 4096))

1975 
îr_˛o£
;

1977 
îr
 = 
	`ªad_su≥r
(
sb
, 
bdev
, &
sb_∑ge
);

1978 i‡(
îr
)

1979 
îr_˛o£
;

1981 i‡(
	`SB_IS_BDEV
(
sb
)) {

1982 
ˇched_dev
 *
dc
 = 
	`kzÆloc
((*dc), 
GFP_KERNEL
);

1983 i‡(!
dc
)

1984 
îr_˛o£
;

1986 
	`muãx_lock
(&
bch_ªgi°î_lock
);

1987 
	`ªgi°î_bdev
(
sb
, 
sb_∑ge
, 
bdev
, 
dc
);

1988 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

1990 
ˇche
 *
ˇ
 = 
	`kzÆloc
((*ˇ), 
GFP_KERNEL
);

1991 i‡(!
ˇ
)

1992 
îr_˛o£
;

1994 
	`ªgi°î_ˇche
(
sb
, 
sb_∑ge
, 
bdev
, 
ˇ
);

1996 
out
:

1997 i‡(
sb_∑ge
)

1998 
	`put_∑ge
(
sb_∑ge
);

1999 
	`k‰ì
(
sb
);

2000 
	`k‰ì
(
∑th
);

2001 
	`moduÀ_put
(
THIS_MODULE
);

2002  
ªt
;

2004 
îr_˛o£
:

2005 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

2006 
îr
:

2007 i‡(
©å
 !&
ksysfs_ªgi°î_quõt
)

2008 
	`¥_öfo
("îr‹ o≥nög %s: %s", 
∑th
, 
îr
);

2009 
ªt
 = -
EINVAL
;

2010 
out
;

2011 
	}
}

2013 
	$bˇche_ªboŸ
(
nŸifõr_block
 *
n
, 
code
, *
x
)

2015 i‡(
code
 =
SYS_DOWN
 ||

2016 
code
 =
SYS_HALT
 ||

2017 
code
 =
SYS_POWER_OFF
) {

2018 
	`DEFINE_WAIT
(
waô
);

2019 
°¨t
 = 
jiffõs
;

2020 
boﬁ
 
°›≥d
 = 
Ál£
;

2022 
ˇche_£t
 *
c
, *
tc
;

2023 
ˇched_dev
 *
dc
, *
tdc
;

2025 
	`muãx_lock
(&
bch_ªgi°î_lock
);

2027 i‡(
	`li°_em±y
(&
bch_ˇche_£ts
) &&

2028 
	`li°_em±y
(&
unˇched_devi˚s
))

2029 
out
;

2031 
	`¥_öfo
("Stoppingáll devices:");

2033 
	`li°_f‹_óch_íåy_ß„
(
c
, 
tc
, &
bch_ˇche_£ts
, 
li°
)

2034 
	`bch_ˇche_£t_°›
(
c
);

2036 
	`li°_f‹_óch_íåy_ß„
(
dc
, 
tdc
, &
unˇched_devi˚s
, 
li°
)

2037 
	`bˇche_devi˚_°›
(&
dc
->
disk
);

2041 
timeout
 = 
°¨t
 + 2 * 
HZ
 - 
jiffõs
;

2043 
°›≥d
 = 
	`li°_em±y
(&
bch_ˇche_£ts
) &&

2044 
	`li°_em±y
(&
unˇched_devi˚s
);

2046 i‡(
timeout
 < 0 || 
°›≥d
)

2049 
	`¥ï¨e_to_waô
(&
uƒegi°î_waô
, &
waô
,

2050 
TASK_UNINTERRUPTIBLE
);

2052 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

2053 
	`scheduÀ_timeout
(
timeout
);

2054 
	`muãx_lock
(&
bch_ªgi°î_lock
);

2057 
	`föish_waô
(&
uƒegi°î_waô
, &
waô
);

2059 i‡(
°›≥d
)

2060 
	`¥_öfo
("All devices stopped");

2062 
	`¥_nŸi˚
("Timeout waiting for devicesÅo be closed");

2063 
out
:

2064 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

2067  
NOTIFY_DONE
;

2068 
	}
}

2070 
nŸifõr_block
 
	gªboŸ
 = {

2071 .
nŸifõr_ˇŒ
 = 
bˇche_ªboŸ
,

2072 .
	g¥i‹ôy
 = 
INT_MAX
,

2075 
	$bˇche_exô
()

2077 
	`bch_debug_exô
();

2078 
	`bch_ªque°_exô
();

2079 i‡(
bˇche_kobj
)

2080 
	`kobje˘_put
(
bˇche_kobj
);

2081 i‡(
bˇche_wq
)

2082 
	`de°roy_w‹kqueue
(
bˇche_wq
);

2083 i‡(
bˇche_maj‹
)

2084 
	`uƒegi°î_blkdev
(
bˇche_maj‹
, "bcache");

2085 
	`uƒegi°î_ªboŸ_nŸifõr
(&
ªboŸ
);

2086 
	}
}

2088 
__öô
 
	$bˇche_öô
()

2090 c⁄° 
©åibuã
 *
fûes
[] = {

2091 &
ksysfs_ªgi°î
.
©å
,

2092 &
ksysfs_ªgi°î_quõt
.
©å
,

2093 
NULL


2096 
	`muãx_öô
(&
bch_ªgi°î_lock
);

2097 
	`öô_waôqueue_hód
(&
uƒegi°î_waô
);

2098 
	`ªgi°î_ªboŸ_nŸifõr
(&
ªboŸ
);

2099 
	`˛osuª_debug_öô
();

2101 
bˇche_maj‹
 = 
	`ªgi°î_blkdev
(0, "bcache");

2102 i‡(
bˇche_maj‹
 < 0)

2103  
bˇche_maj‹
;

2105 i‡(!(
bˇche_wq
 = 
	`¸óã_w‹kqueue
("bcache")) ||

2106 !(
bˇche_kobj
 = 
	`kobje˘_¸óã_™d_add
("bˇche", 
fs_kobj
)) ||

2107 
	`sysfs_¸óã_fûes
(
bˇche_kobj
, 
fûes
) ||

2108 
	`bch_ªque°_öô
() ||

2109 
	`bch_debug_öô
(
bˇche_kobj
))

2110 
îr
;

2113 
îr
:

2114 
	`bˇche_exô
();

2115  -
ENOMEM
;

2116 
	}
}

2118 
moduÀ_exô
(
bˇche_exô
);

2119 
moduÀ_öô
(
bˇche_öô
);

	@bcache/sysfs.c

8 
	~"bˇche.h
"

9 
	~"sysfs.h
"

10 
	~"båì.h
"

11 
	~"ªque°.h
"

12 
	~"wrôeback.h
"

14 
	~<löux/blkdev.h
>

15 
	~<löux/s‹t.h
>

17 c⁄° * c⁄° 
	gˇche_ª∂a˚mít_pﬁicõs
[] = {

21 
NULL


24 c⁄° * c⁄° 
	gîr‹_a˘i⁄s
[] = {

27 
NULL


30 
wrôe_©åibuã
(
©èch
);

31 
wrôe_©åibuã
(
dëach
);

32 
wrôe_©åibuã
(
uƒegi°î
);

33 
wrôe_©åibuã
(
°›
);

34 
wrôe_©åibuã
(
˛ór_°©s
);

35 
wrôe_©åibuã
(
åiggî_gc
);

36 
wrôe_©åibuã
(
¥u√_ˇche
);

37 
wrôe_©åibuã
(
Êash_vﬁ_¸óã
);

39 
ªad_©åibuã
(
buckë_size
);

40 
ªad_©åibuã
(
block_size
);

41 
ªad_©åibuã
(
nbuckës
);

42 
ªad_©åibuã
(
åì_dïth
);

43 
ªad_©åibuã
(
roŸ_ußge_≥r˚¡
);

44 
ªad_©åibuã
(
¥i‹ôy_°©s
);

45 
ªad_©åibuã
(
båì_ˇche_size
);

46 
ªad_©åibuã
(
båì_ˇche_max_chaö
);

47 
ªad_©åibuã
(
ˇche_avaûabÀ_≥r˚¡
);

48 
ªad_©åibuã
(
wrôãn
);

49 
ªad_©åibuã
(
båì_wrôãn
);

50 
ªad_©åibuã
(
mëad©a_wrôãn
);

51 
ªad_©åibuã
(
a˘ive_jou∫Æ_íåõs
);

53 
sysfs_time_°©s_©åibuã
(
båì_gc
, 
£c
, 
ms
);

54 
sysfs_time_°©s_©åibuã
(
båì_•lô
, 
£c
, 
us
);

55 
sysfs_time_°©s_©åibuã
(
båì_s‹t
, 
ms
, 
us
);

56 
sysfs_time_°©s_©åibuã
(
båì_ªad
, 
ms
, 
us
);

58 
ªad_©åibuã
(
båì_nodes
);

59 
ªad_©åibuã
(
båì_u£d_≥r˚¡
);

60 
ªad_©åibuã
(
avîage_key_size
);

61 
ªad_©åibuã
(
dúty_d©a
);

62 
ªad_©åibuã
(
b£t_åì_°©s
);

64 
ªad_©åibuã
(
°©e
);

65 
ªad_©åibuã
(
ˇche_ªad_ø˚s
);

66 
ªad_©åibuã
(
wrôeback_keys_d⁄e
);

67 
ªad_©åibuã
(
wrôeback_keys_Áûed
);

68 
ªad_©åibuã
(
io_îr‹s
);

69 
ªad_©åibuã
(
c⁄ge°ed
);

70 
rw_©åibuã
(
c⁄ge°ed_ªad_thªshﬁd_us
);

71 
rw_©åibuã
(
c⁄ge°ed_wrôe_thªshﬁd_us
);

73 
rw_©åibuã
(
£quítül_cutoff
);

74 
rw_©åibuã
(
d©a_csum
);

75 
rw_©åibuã
(
ˇche_mode
);

76 
rw_©åibuã
(
wrôeback_mëad©a
);

77 
rw_©åibuã
(
wrôeback_ru¬ög
);

78 
rw_©åibuã
(
wrôeback_≥r˚¡
);

79 
rw_©åibuã
(
wrôeback_dñay
);

80 
rw_©åibuã
(
wrôeback_øã
);

82 
rw_©åibuã
(
wrôeback_øã_upd©e_£c⁄ds
);

83 
rw_©åibuã
(
wrôeback_øã_d_ãrm
);

84 
rw_©åibuã
(
wrôeback_øã_p_ãrm_övî£
);

85 
ªad_©åibuã
(
wrôeback_øã_debug
);

87 
ªad_©åibuã
(
°rùe_size
);

88 
ªad_©åibuã
(
∑πül_°rùes_ex≥nsive
);

90 
rw_©åibuã
(
synchr⁄ous
);

91 
rw_©åibuã
(
jou∫Æ_dñay_ms
);

92 
rw_©åibuã
(
disˇrd
);

93 
rw_©åibuã
(
ru¬ög
);

94 
rw_©åibuã
(
œbñ
);

95 
rw_©åibuã
(
ªadahód
);

96 
rw_©åibuã
(
îr‹s
);

97 
rw_©åibuã
(
io_îr‹_limô
);

98 
rw_©åibuã
(
io_îr‹_hÆÊi„
);

99 
rw_©åibuã
(
vîify
);

100 
rw_©åibuã
(
by∑ss_t‹tuª_ã°
);

101 
rw_©åibuã
(
key_mîgög_dißbÀd
);

102 
rw_©åibuã
(
gc_Æways_ªwrôe
);

103 
rw_©åibuã
(
ex≥nsive_debug_checks
);

104 
rw_©åibuã
(
ˇche_ª∂a˚mít_pﬁicy
);

105 
rw_©åibuã
(
båì_shrökî_dißbÀd
);

106 
rw_©åibuã
(
c›y_gc_íabÀd
);

107 
rw_©åibuã
(
size
);

109 
	$SHOW
(
__bch_ˇched_dev
)

111 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
kobj
, cached_dev,

112 
disk
.
kobj
);

113 c⁄° *
°©es
[] = { "no cache", "clean", "dirty", "inconsistent" };

115 
	#v¨
(
°©
Ë(
dc
->°©)

	)

117 i‡(
©å
 =&
sysfs_ˇche_mode
)

118  
	`bch_¢¥öt_°rög_li°
(
buf
, 
PAGE_SIZE
,

119 
bch_ˇche_modes
 + 1,

120 
	`BDEV_CACHE_MODE
(&
dc
->
sb
));

122 
	`sysfs_¥ötf
(
d©a_csum
, "%i", 
dc
->
disk
.data_csum);

123 
	`v¨_¥ötf
(
vîify
, "%i");

124 
	`v¨_¥ötf
(
by∑ss_t‹tuª_ã°
, "%i");

125 
	`v¨_¥ötf
(
wrôeback_mëad©a
, "%i");

126 
	`v¨_¥ötf
(
wrôeback_ru¬ög
, "%i");

127 
	`v¨_¥öt
(
wrôeback_dñay
);

128 
	`v¨_¥öt
(
wrôeback_≥r˚¡
);

129 
	`sysfs_h¥öt
(
wrôeback_øã
, 
dc
->wrôeback_øã.
øã
 << 9);

131 
	`v¨_¥öt
(
wrôeback_øã_upd©e_£c⁄ds
);

132 
	`v¨_¥öt
(
wrôeback_øã_d_ãrm
);

133 
	`v¨_¥öt
(
wrôeback_øã_p_ãrm_övî£
);

135 i‡(
©å
 =&
sysfs_wrôeback_øã_debug
) {

136 
øã
[20];

137 
dúty
[20];

138 
èrgë
[20];

139 
¥›‹ti⁄Æ
[20];

140 
dîiv©ive
[20];

141 
ch™ge
[20];

142 
s64
 
√xt_io
;

144 
	`bch_h¥öt
(
øã
, 
dc
->
wrôeback_øã
.rate << 9);

145 
	`bch_h¥öt
(
dúty
, 
	`bˇche_dev_£˘‹s_dúty
(&
dc
->
disk
) << 9);

146 
	`bch_h¥öt
(
èrgë
, 
dc
->
wrôeback_øã_èrgë
 << 9);

147 
	`bch_h¥öt
(
¥›‹ti⁄Æ
,
dc
->
wrôeback_øã_¥›‹ti⁄Æ
 << 9);

148 
	`bch_h¥öt
(
dîiv©ive
, 
dc
->
wrôeback_øã_dîiv©ive
 << 9);

149 
	`bch_h¥öt
(
ch™ge
, 
dc
->
wrôeback_øã_ch™ge
 << 9);

151 
√xt_io
 = 
	`div64_s64
(
dc
->
wrôeback_øã
.
√xt
 - 
	`loˇl_˛ock
(),

152 
NSEC_PER_MSEC
);

154  
	`•rötf
(
buf
,

162 
øã
, 
dúty
, 
èrgë
, 
¥›‹ti⁄Æ
,

163 
dîiv©ive
, 
ch™ge
, 
√xt_io
);

166 
	`sysfs_h¥öt
(
dúty_d©a
,

167 
	`bˇche_dev_£˘‹s_dúty
(&
dc
->
disk
) << 9);

169 
	`sysfs_h¥öt
(
°rùe_size
, 
dc
->
disk
.stripe_size << 9);

170 
	`v¨_¥ötf
(
∑πül_°rùes_ex≥nsive
, "%u");

172 
	`v¨_h¥öt
(
£quítül_cutoff
);

173 
	`v¨_h¥öt
(
ªadahód
);

175 
	`sysfs_¥öt
(
ru¬ög
, 
	`©omic_ªad
(&
dc
->running));

176 
	`sysfs_¥öt
(
°©e
, 
°©es
[
	`BDEV_STATE
(&
dc
->
sb
)]);

178 i‡(
©å
 =&
sysfs_œbñ
) {

179 
	`mem˝y
(
buf
, 
dc
->
sb
.
œbñ
, 
SB_LABEL_SIZE
);

180 
buf
[
SB_LABEL_SIZE
 + 1] = '\0';

181 
	`°rˇt
(
buf
, "\n");

182  
	`°æí
(
buf
);

185 #unde‡
v¨


187 
	}
}

188 
	$SHOW_LOCKED
(
bch_ˇched_dev
)

190 
	$STORE
(
__ˇched_dev
)

192 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
kobj
, cached_dev,

193 
disk
.
kobj
);

194 
v
 = 
size
;

195 
ˇche_£t
 *
c
;

196 
kobj_uevít_ív
 *
ív
;

198 
	#d_°πoul
(
v¨
Ë
	`sysfs_°πoul
(v¨, 
dc
->v¨)

	)

199 
	#d_°πoul_n⁄zîo
(
v¨
Ë
	`sysfs_°πoul_˛amp
(v¨, 
dc
->v¨, 1, 
INT_MAX
)

	)

200 
	#d_°πoi_h
(
v¨
Ë
	`sysfs_h©oi
(v¨, 
dc
->v¨)

	)

202 
	`sysfs_°πoul
(
d©a_csum
, 
dc
->
disk
.data_csum);

203 
	`d_°πoul
(
vîify
);

204 
	`d_°πoul
(
by∑ss_t‹tuª_ã°
);

205 
	`d_°πoul
(
wrôeback_mëad©a
);

206 
	`d_°πoul
(
wrôeback_ru¬ög
);

207 
	`d_°πoul
(
wrôeback_dñay
);

209 
	`sysfs_°πoul_˛amp
(
wrôeback_≥r˚¡
, 
dc
->writeback_percent, 0, 40);

211 
	`sysfs_°πoul_˛amp
(
wrôeback_øã
,

212 
dc
->
wrôeback_øã
.
øã
, 1, 
INT_MAX
);

214 
	`d_°πoul_n⁄zîo
(
wrôeback_øã_upd©e_£c⁄ds
);

215 
	`d_°πoul
(
wrôeback_øã_d_ãrm
);

216 
	`d_°πoul_n⁄zîo
(
wrôeback_øã_p_ãrm_övî£
);

218 
	`d_°πoi_h
(
£quítül_cutoff
);

219 
	`d_°πoi_h
(
ªadahód
);

221 i‡(
©å
 =&
sysfs_˛ór_°©s
)

222 
	`bch_ˇche_accou¡ög_˛ór
(&
dc
->
accou¡ög
);

224 i‡(
©å
 =&
sysfs_ru¬ög
 &&

225 
	`°πoul_‹_ªtu∫
(
buf
))

226 
	`bch_ˇched_dev_run
(
dc
);

228 i‡(
©å
 =&
sysfs_ˇche_mode
) {

229 
ssize_t
 
v
 = 
	`bch_ªad_°rög_li°
(
buf
, 
bch_ˇche_modes
 + 1);

231 i‡(
v
 < 0)

232  
v
;

234 i‡((Ë
v
 !
	`BDEV_CACHE_MODE
(&
dc
->
sb
)) {

235 
	`SET_BDEV_CACHE_MODE
(&
dc
->
sb
, 
v
);

236 
	`bch_wrôe_bdev_su≥r
(
dc
, 
NULL
);

240 i‡(
©å
 =&
sysfs_œbñ
) {

241 i‡(
size
 > 
SB_LABEL_SIZE
)

242  -
EINVAL
;

243 
	`mem˝y
(
dc
->
sb
.
œbñ
, 
buf
, 
size
);

244 i‡(
size
 < 
SB_LABEL_SIZE
)

245 
dc
->
sb
.
œbñ
[
size
] = '\0';

246 i‡(
size
 && 
dc
->
sb
.
œbñ
[size - 1] == '\n')

247 
dc
->
sb
.
œbñ
[
size
 - 1] = '\0';

248 
	`bch_wrôe_bdev_su≥r
(
dc
, 
NULL
);

249 i‡(
dc
->
disk
.
c
) {

250 
	`mem˝y
(
dc
->
disk
.
c
->
uuids
[dc->disk.
id
].
œbñ
,

251 
buf
, 
SB_LABEL_SIZE
);

252 
	`bch_uuid_wrôe
(
dc
->
disk
.
c
);

254 
ív
 = 
	`kzÆloc
((
kobj_uevít_ív
), 
GFP_KERNEL
);

255 i‡(!
ív
)

256  -
ENOMEM
;

257 
	`add_uevít_v¨
(
ív
, "DRIVER=bcache");

258 
	`add_uevít_v¨
(
ív
, "CACHED_UUID=%pU", 
dc
->
sb
.
uuid
),

259 
	`add_uevít_v¨
(
ív
, "CACHED_LABEL=%s", 
buf
);

260 
	`kobje˘_uevít_ív
(

261 &
	`disk_to_dev
(
dc
->
disk
.disk)->
kobj
, 
KOBJ_CHANGE
, 
ív
->
ívp
);

262 
	`k‰ì
(
ív
);

265 i‡(
©å
 =&
sysfs_©èch
) {

266 i‡(
	`bch_∑r£_uuid
(
buf
, 
dc
->
sb
.
£t_uuid
) < 16)

267  -
EINVAL
;

269 
	`li°_f‹_óch_íåy
(
c
, &
bch_ˇche_£ts
, 
li°
) {

270 
v
 = 
	`bch_ˇched_dev_©èch
(
dc
, 
c
);

271 i‡(!
v
)

272  
size
;

275 
	`¥_îr
("C™'à©èch %s: cachê£ànŸ found", 
buf
);

276 
size
 = 
v
;

279 i‡(
©å
 =&
sysfs_dëach
 && 
dc
->
disk
.
c
)

280 
	`bch_ˇched_dev_dëach
(
dc
);

282 i‡(
©å
 =&
sysfs_°›
)

283 
	`bˇche_devi˚_°›
(&
dc
->
disk
);

285  
size
;

286 
	}
}

288 
	$STORE
(
bch_ˇched_dev
)

290 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
kobj
, cached_dev,

291 
disk
.
kobj
);

293 
	`muãx_lock
(&
bch_ªgi°î_lock
);

294 
size
 = 
	`__ˇched_dev_°‹e
(
kobj
, 
©å
, 
buf
, size);

296 i‡(
©å
 =&
sysfs_wrôeback_ru¬ög
)

297 
	`bch_wrôeback_queue
(
dc
);

299 i‡(
©å
 =&
sysfs_wrôeback_≥r˚¡
)

300 
	`scheduÀ_dñayed_w‹k
(&
dc
->
wrôeback_øã_upd©e
,

301 
dc
->
wrôeback_øã_upd©e_£c⁄ds
 * 
HZ
);

303 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
);

304  
size
;

305 
	}
}

307 
©åibuã
 *
	gbch_ˇched_dev_fûes
[] = {

308 &
sysfs_©èch
,

309 &
sysfs_dëach
,

310 &
sysfs_°›
,

312 &
sysfs_d©a_csum
,

314 &
sysfs_ˇche_mode
,

315 &
sysfs_wrôeback_mëad©a
,

316 &
sysfs_wrôeback_ru¬ög
,

317 &
sysfs_wrôeback_dñay
,

318 &
sysfs_wrôeback_≥r˚¡
,

319 &
sysfs_wrôeback_øã
,

320 &
sysfs_wrôeback_øã_upd©e_£c⁄ds
,

321 &
sysfs_wrôeback_øã_d_ãrm
,

322 &
sysfs_wrôeback_øã_p_ãrm_övî£
,

323 &
sysfs_wrôeback_øã_debug
,

324 &
sysfs_dúty_d©a
,

325 &
sysfs_°rùe_size
,

326 &
sysfs_∑πül_°rùes_ex≥nsive
,

327 &
sysfs_£quítül_cutoff
,

328 &
sysfs_˛ór_°©s
,

329 &
sysfs_ru¬ög
,

330 &
sysfs_°©e
,

331 &
sysfs_œbñ
,

332 &
sysfs_ªadahód
,

333 #ifde‡
CONFIG_BCACHE_DEBUG


334 &
sysfs_vîify
,

335 &
sysfs_by∑ss_t‹tuª_ã°
,

337 
NULL


339 
KTYPE
(
bch_ˇched_dev
);

341 
	$SHOW
(
bch_Êash_dev
)

343 
bˇche_devi˚
 *
d
 = 
	`c⁄èöî_of
(
kobj
, bcache_device,

344 
kobj
);

345 
uuid_íåy
 *
u
 = &
d
->
c
->
uuids
[d->
id
];

347 
	`sysfs_¥ötf
(
d©a_csum
, "%i", 
d
->data_csum);

348 
	`sysfs_h¥öt
(
size
, 
u
->
£˘‹s
 << 9);

350 i‡(
©å
 =&
sysfs_œbñ
) {

351 
	`mem˝y
(
buf
, 
u
->
œbñ
, 
SB_LABEL_SIZE
);

352 
buf
[
SB_LABEL_SIZE
 + 1] = '\0';

353 
	`°rˇt
(
buf
, "\n");

354  
	`°æí
(
buf
);

358 
	}
}

360 
	$STORE
(
__bch_Êash_dev
)

362 
bˇche_devi˚
 *
d
 = 
	`c⁄èöî_of
(
kobj
, bcache_device,

363 
kobj
);

364 
uuid_íåy
 *
u
 = &
d
->
c
->
uuids
[d->
id
];

366 
	`sysfs_°πoul
(
d©a_csum
, 
d
->data_csum);

368 i‡(
©å
 =&
sysfs_size
) {

369 
uöt64_t
 
v
;

370 
	`°πoi_h_‹_ªtu∫
(
buf
, 
v
);

372 
u
->
£˘‹s
 = 
v
 >> 9;

373 
	`bch_uuid_wrôe
(
d
->
c
);

374 
	`£t_ˇ∑côy
(
d
->
disk
, 
u
->
£˘‹s
);

377 i‡(
©å
 =&
sysfs_œbñ
) {

378 
	`mem˝y
(
u
->
œbñ
, 
buf
, 
SB_LABEL_SIZE
);

379 
	`bch_uuid_wrôe
(
d
->
c
);

382 i‡(
©å
 =&
sysfs_uƒegi°î
) {

383 
	`£t_bô
(
BCACHE_DEV_DETACHING
, &
d
->
Êags
);

384 
	`bˇche_devi˚_°›
(
d
);

387  
size
;

388 
	}
}

389 
	$STORE_LOCKED
(
bch_Êash_dev
)

391 
©åibuã
 *
bch_Êash_dev_fûes
[] = {

392 &
sysfs_uƒegi°î
,

394 &
sysfs_d©a_csum
,

396 &
sysfs_œbñ
,

397 &
sysfs_size
,

398 
NULL


399 
	}
};

400 
KTYPE
(
bch_Êash_dev
);

402 
	sb£t_°©s_›
 {

403 
båì_›
 
	m›
;

404 
size_t
 
	mnodes
;

405 
b£t_°©s
 
	m°©s
;

408 
	$bch_båì_b£t_°©s
(
båì_›
 *
b_›
, 
båì
 *
b
)

410 
b£t_°©s_›
 *
›
 = 
	`c⁄èöî_of
(
b_›
, bset_stats_op, op);

412 
›
->
nodes
++;

413 
	`bch_båì_keys_°©s
(&
b
->
keys
, &
›
->
°©s
);

415  
MAP_CONTINUE
;

416 
	}
}

418 
	$bch_b£t_¥öt_°©s
(
ˇche_£t
 *
c
, *
buf
)

420 
b£t_°©s_›
 
›
;

421 
ªt
;

423 
	`mem£t
(&
›
, 0, (op));

424 
	`bch_båì_›_öô
(&
›
.op, -1);

426 
ªt
 = 
	`bch_båì_m≠_nodes
(&
›
.›, 
c
, &
ZERO_KEY
, 
bch_båì_b£t_°©s
);

427 i‡(
ªt
 < 0)

428  
ªt
;

430  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
,

438 
›
.
nodes
,

439 
›
.
°©s
.
£ts_wrôãn
, op.°©s.
£ts_unwrôãn
,

440 
›
.
°©s
.
byãs_wrôãn
, op.°©s.
byãs_unwrôãn
,

441 
›
.
°©s
.
Êﬂts
, op.°©s.
Áûed
);

442 
	}
}

444 
	$bch_roŸ_ußge
(
ˇche_£t
 *
c
)

446 
byãs
 = 0;

447 
bkey
 *
k
;

448 
båì
 *
b
;

449 
båì_ôî
 
ôî
;

451 
lock_roŸ
;

454 
	`rw_u∆ock
(
Ál£
, 
b
);

455 
lock_roŸ
:

456 
b
 = 
c
->
roŸ
;

457 
	`rw_lock
(
Ál£
, 
b
, b->
Àvñ
);

458 } 
b
 !
c
->
roŸ
);

460 
	`f‹_óch_key_fûãr
(&
b
->
keys
, 
k
, &
ôî
, 
bch_±r_bad
)

461 
byãs
 +
	`bkey_byãs
(
k
);

463 
	`rw_u∆ock
(
Ál£
, 
b
);

465  (
byãs
 * 100Ë/ 
	`båì_byãs
(
c
);

466 
	}
}

468 
size_t
 
	$bch_ˇche_size
(
ˇche_£t
 *
c
)

470 
size_t
 
ªt
 = 0;

471 
båì
 *
b
;

473 
	`muãx_lock
(&
c
->
buckë_lock
);

474 
	`li°_f‹_óch_íåy
(
b
, &
c
->
båì_ˇche
, 
li°
)

475 
ªt
 +1 << (
b
->
keys
.
∑ge_‹dî
 + 
PAGE_SHIFT
);

477 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

478  
ªt
;

479 
	}
}

481 
	$bch_ˇche_max_chaö
(
ˇche_£t
 *
c
)

483 
ªt
 = 0;

484 
hli°_hód
 *
h
;

486 
	`muãx_lock
(&
c
->
buckë_lock
);

488 
h
 = 
c
->
buckë_hash
;

489 
h
 < 
c
->
buckë_hash
 + (1 << 
BUCKET_HASH_BITS
);

490 
h
++) {

491 
i
 = 0;

492 
hli°_node
 *
p
;

494 
	`hli°_f‹_óch
(
p
, 
h
)

495 
i
++;

497 
ªt
 = 
	`max
‘ë, 
i
);

500 
	`muãx_u∆ock
(&
c
->
buckë_lock
);

501  
ªt
;

502 
	}
}

504 
	$bch_båì_u£d
(
ˇche_£t
 *
c
)

506  
	`div64_u64
(
c
->
gc_°©s
.
key_byãs
 * 100,

507 (
c
->
gc_°©s
.
nodes
 ?: 1Ë* 
	`båì_byãs
(c));

508 
	}
}

510 
	$bch_avîage_key_size
(
ˇche_£t
 *
c
)

512  
c
->
gc_°©s
.
nkeys


513 ? 
	`div64_u64
(
c
->
gc_°©s
.
d©a
, c->gc_°©s.
nkeys
)

515 
	}
}

517 
	$SHOW
(
__bch_ˇche_£t
)

519 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
kobj
, cache_set, kobj);

521 
	`sysfs_¥öt
(
synchr⁄ous
, 
	`CACHE_SYNC
(&
c
->
sb
));

522 
	`sysfs_¥öt
(
jou∫Æ_dñay_ms
, 
c
->journal_delay_ms);

523 
	`sysfs_h¥öt
(
buckë_size
, 
	`buckë_byãs
(
c
));

524 
	`sysfs_h¥öt
(
block_size
, 
	`block_byãs
(
c
));

525 
	`sysfs_¥öt
(
åì_dïth
, 
c
->
roŸ
->
Àvñ
);

526 
	`sysfs_¥öt
(
roŸ_ußge_≥r˚¡
, 
	`bch_roŸ_ußge
(
c
));

528 
	`sysfs_h¥öt
(
båì_ˇche_size
, 
	`bch_ˇche_size
(
c
));

529 
	`sysfs_¥öt
(
båì_ˇche_max_chaö
, 
	`bch_ˇche_max_chaö
(
c
));

530 
	`sysfs_¥öt
(
ˇche_avaûabÀ_≥r˚¡
, 100 - 
c
->
gc_°©s
.
ö_u£
);

532 
	`sysfs_¥öt_time_°©s
(&
c
->
båì_gc_time
, 
båì_gc
, 
£c
, 
ms
);

533 
	`sysfs_¥öt_time_°©s
(&
c
->
båì_•lô_time
, 
båì_•lô
, 
£c
, 
us
);

534 
	`sysfs_¥öt_time_°©s
(&
c
->
s‹t
.
time
, 
båì_s‹t
, 
ms
, 
us
);

535 
	`sysfs_¥öt_time_°©s
(&
c
->
båì_ªad_time
, 
båì_ªad
, 
ms
, 
us
);

537 
	`sysfs_¥öt
(
båì_u£d_≥r˚¡
, 
	`bch_båì_u£d
(
c
));

538 
	`sysfs_¥öt
(
båì_nodes
, 
c
->
gc_°©s
.
nodes
);

539 
	`sysfs_h¥öt
(
avîage_key_size
, 
	`bch_avîage_key_size
(
c
));

541 
	`sysfs_¥öt
(
ˇche_ªad_ø˚s
,

542 
	`©omic_l⁄g_ªad
(&
c
->
ˇche_ªad_ø˚s
));

544 
	`sysfs_¥öt
(
wrôeback_keys_d⁄e
,

545 
	`©omic_l⁄g_ªad
(&
c
->
wrôeback_keys_d⁄e
));

546 
	`sysfs_¥öt
(
wrôeback_keys_Áûed
,

547 
	`©omic_l⁄g_ªad
(&
c
->
wrôeback_keys_Áûed
));

549 i‡(
©å
 =&
sysfs_îr‹s
)

550  
	`bch_¢¥öt_°rög_li°
(
buf
, 
PAGE_SIZE
, 
îr‹_a˘i⁄s
,

551 
c
->
⁄_îr‹
);

554 
	`sysfs_¥öt
(
io_îr‹_hÆÊi„
, 
c
->
îr‹_deˇy
 * 88);

555 
	`sysfs_¥öt
(
io_îr‹_limô
, 
c
->
îr‹_limô
 >> 
IO_ERROR_SHIFT
);

557 
	`sysfs_h¥öt
(
c⁄ge°ed
,

558 ((
uöt64_t
Ë
	`bch_gë_c⁄ge°ed
(
c
)) << 9);

559 
	`sysfs_¥öt
(
c⁄ge°ed_ªad_thªshﬁd_us
,

560 
c
->
c⁄ge°ed_ªad_thªshﬁd_us
);

561 
	`sysfs_¥öt
(
c⁄ge°ed_wrôe_thªshﬁd_us
,

562 
c
->
c⁄ge°ed_wrôe_thªshﬁd_us
);

564 
	`sysfs_¥öt
(
a˘ive_jou∫Æ_íåõs
, 
	`fifo_u£d
(&
c
->
jou∫Æ
.
pö
));

565 
	`sysfs_¥ötf
(
vîify
, "%i", 
c
->verify);

566 
	`sysfs_¥ötf
(
key_mîgög_dißbÀd
, "%i", 
c
->key_merging_disabled);

567 
	`sysfs_¥ötf
(
ex≥nsive_debug_checks
,

568 "%i", 
c
->
ex≥nsive_debug_checks
);

569 
	`sysfs_¥ötf
(
gc_Æways_ªwrôe
, "%i", 
c
->gc_always_rewrite);

570 
	`sysfs_¥ötf
(
båì_shrökî_dißbÀd
, "%i", 
c
->
shrökî_dißbÀd
);

571 
	`sysfs_¥ötf
(
c›y_gc_íabÀd
, "%i", 
c
->copy_gc_enabled);

573 i‡(
©å
 =&
sysfs_b£t_åì_°©s
)

574  
	`bch_b£t_¥öt_°©s
(
c
, 
buf
);

577 
	}
}

578 
	$SHOW_LOCKED
(
bch_ˇche_£t
)

580 
	$STORE
(
__bch_ˇche_£t
)

582 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
kobj
, cache_set, kobj);

584 i‡(
©å
 =&
sysfs_uƒegi°î
)

585 
	`bch_ˇche_£t_uƒegi°î
(
c
);

587 i‡(
©å
 =&
sysfs_°›
)

588 
	`bch_ˇche_£t_°›
(
c
);

590 i‡(
©å
 =&
sysfs_synchr⁄ous
) {

591 
boﬁ
 
sync
 = 
	`°πoul_‹_ªtu∫
(
buf
);

593 i‡(
sync
 !
	`CACHE_SYNC
(&
c
->
sb
)) {

594 
	`SET_CACHE_SYNC
(&
c
->
sb
, 
sync
);

595 
	`bˇche_wrôe_su≥r
(
c
);

599 i‡(
©å
 =&
sysfs_Êash_vﬁ_¸óã
) {

600 
r
;

601 
uöt64_t
 
v
;

602 
	`°πoi_h_‹_ªtu∫
(
buf
, 
v
);

604 
r
 = 
	`bch_Êash_dev_¸óã
(
c
, 
v
);

605 i‡(
r
)

606  
r
;

609 i‡(
©å
 =&
sysfs_˛ór_°©s
) {

610 
	`©omic_l⁄g_£t
(&
c
->
wrôeback_keys_d⁄e
, 0);

611 
	`©omic_l⁄g_£t
(&
c
->
wrôeback_keys_Áûed
, 0);

613 
	`mem£t
(&
c
->
gc_°©s
, 0, (
gc_°©
));

614 
	`bch_ˇche_accou¡ög_˛ór
(&
c
->
accou¡ög
);

617 i‡(
©å
 =&
sysfs_åiggî_gc
)

618 
	`wake_up_gc
(
c
);

620 i‡(
©å
 =&
sysfs_¥u√_ˇche
) {

621 
shrök_c⁄åﬁ
 
sc
;

622 
sc
.
gÂ_mask
 = 
GFP_KERNEL
;

623 
sc
.
ƒ_to_sˇn
 = 
	`°πoul_‹_ªtu∫
(
buf
);

624 
c
->
shrök
.
	`sˇn_obje˘s
(&c->shrök, &
sc
);

627 
	`sysfs_°πoul
(
c⁄ge°ed_ªad_thªshﬁd_us
,

628 
c
->
c⁄ge°ed_ªad_thªshﬁd_us
);

629 
	`sysfs_°πoul
(
c⁄ge°ed_wrôe_thªshﬁd_us
,

630 
c
->
c⁄ge°ed_wrôe_thªshﬁd_us
);

632 i‡(
©å
 =&
sysfs_îr‹s
) {

633 
ssize_t
 
v
 = 
	`bch_ªad_°rög_li°
(
buf
, 
îr‹_a˘i⁄s
);

635 i‡(
v
 < 0)

636  
v
;

638 
c
->
⁄_îr‹
 = 
v
;

641 i‡(
©å
 =&
sysfs_io_îr‹_limô
)

642 
c
->
îr‹_limô
 = 
	`°πoul_‹_ªtu∫
(
buf
Ë<< 
IO_ERROR_SHIFT
;

645 i‡(
©å
 =&
sysfs_io_îr‹_hÆÊi„
)

646 
c
->
îr‹_deˇy
 = 
	`°πoul_‹_ªtu∫
(
buf
) / 88;

648 
	`sysfs_°πoul
(
jou∫Æ_dñay_ms
, 
c
->journal_delay_ms);

649 
	`sysfs_°πoul
(
vîify
, 
c
->verify);

650 
	`sysfs_°πoul
(
key_mîgög_dißbÀd
, 
c
->key_merging_disabled);

651 
	`sysfs_°πoul
(
ex≥nsive_debug_checks
, 
c
->expensive_debug_checks);

652 
	`sysfs_°πoul
(
gc_Æways_ªwrôe
, 
c
->gc_always_rewrite);

653 
	`sysfs_°πoul
(
båì_shrökî_dißbÀd
, 
c
->
shrökî_dißbÀd
);

654 
	`sysfs_°πoul
(
c›y_gc_íabÀd
, 
c
->copy_gc_enabled);

656  
size
;

657 
	}
}

658 
	$STORE_LOCKED
(
bch_ˇche_£t
)

660 
	$SHOW
(
bch_ˇche_£t_öã∫Æ
)

662 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
kobj
, ˇche_£t, 
öã∫Æ
);

663  
	`bch_ˇche_£t_show
(&
c
->
kobj
, 
©å
, 
buf
);

664 
	}
}

666 
	$STORE
(
bch_ˇche_£t_öã∫Æ
)

668 
ˇche_£t
 *
c
 = 
	`c⁄èöî_of
(
kobj
, ˇche_£t, 
öã∫Æ
);

669  
	`bch_ˇche_£t_°‹e
(&
c
->
kobj
, 
©å
, 
buf
, 
size
);

670 
	}
}

672 
	$bch_ˇche_£t_öã∫Æ_ªÀa£
(
kobje˘
 *
k
)

674 
	}
}

676 
©åibuã
 *
	gbch_ˇche_£t_fûes
[] = {

677 &
sysfs_uƒegi°î
,

678 &
sysfs_°›
,

679 &
sysfs_synchr⁄ous
,

680 &
sysfs_jou∫Æ_dñay_ms
,

681 &
sysfs_Êash_vﬁ_¸óã
,

683 &
sysfs_buckë_size
,

684 &
sysfs_block_size
,

685 &
sysfs_åì_dïth
,

686 &
sysfs_roŸ_ußge_≥r˚¡
,

687 &
sysfs_båì_ˇche_size
,

688 &
sysfs_ˇche_avaûabÀ_≥r˚¡
,

690 &
sysfs_avîage_key_size
,

692 &
sysfs_îr‹s
,

693 &
sysfs_io_îr‹_limô
,

694 &
sysfs_io_îr‹_hÆÊi„
,

695 &
sysfs_c⁄ge°ed
,

696 &
sysfs_c⁄ge°ed_ªad_thªshﬁd_us
,

697 &
sysfs_c⁄ge°ed_wrôe_thªshﬁd_us
,

698 &
sysfs_˛ór_°©s
,

699 
NULL


701 
KTYPE
(
bch_ˇche_£t
);

703 
©åibuã
 *
	gbch_ˇche_£t_öã∫Æ_fûes
[] = {

704 &
sysfs_a˘ive_jou∫Æ_íåõs
,

706 
sysfs_time_°©s_©åibuã_li°
(
båì_gc
, 
£c
, 
ms
)

707 
sysfs_time_°©s_©åibuã_li°
(
båì_•lô
, 
£c
, 
us
)

708 
sysfs_time_°©s_©åibuã_li°
(
båì_s‹t
, 
ms
, 
us
)

709 
sysfs_time_°©s_©åibuã_li°
(
båì_ªad
, 
ms
, 
us
)

711 &
sysfs_båì_nodes
,

712 &
sysfs_båì_u£d_≥r˚¡
,

713 &
sysfs_båì_ˇche_max_chaö
,

715 &
sysfs_b£t_åì_°©s
,

716 &
sysfs_ˇche_ªad_ø˚s
,

717 &
sysfs_wrôeback_keys_d⁄e
,

718 &
sysfs_wrôeback_keys_Áûed
,

720 &
sysfs_åiggî_gc
,

721 &
sysfs_¥u√_ˇche
,

722 #ifde‡
CONFIG_BCACHE_DEBUG


723 &
sysfs_vîify
,

724 &
sysfs_key_mîgög_dißbÀd
,

725 &
sysfs_ex≥nsive_debug_checks
,

727 &
sysfs_gc_Æways_ªwrôe
,

728 &
sysfs_båì_shrökî_dißbÀd
,

729 &
sysfs_c›y_gc_íabÀd
,

730 
NULL


732 
KTYPE
(
bch_ˇche_£t_öã∫Æ
);

734 
	$SHOW
(
__bch_ˇche
)

736 
ˇche
 *
ˇ
 = 
	`c⁄èöî_of
(
kobj
, cache, kobj);

738 
	`sysfs_h¥öt
(
buckë_size
, 
	`buckë_byãs
(
ˇ
));

739 
	`sysfs_h¥öt
(
block_size
, 
	`block_byãs
(
ˇ
));

740 
	`sysfs_¥öt
(
nbuckës
, 
ˇ
->
sb
.nbuckets);

741 
	`sysfs_¥öt
(
disˇrd
, 
ˇ
->discard);

742 
	`sysfs_h¥öt
(
wrôãn
, 
	`©omic_l⁄g_ªad
(&
ˇ
->
£˘‹s_wrôãn
) << 9);

743 
	`sysfs_h¥öt
(
båì_wrôãn
,

744 
	`©omic_l⁄g_ªad
(&
ˇ
->
båì_£˘‹s_wrôãn
) << 9);

745 
	`sysfs_h¥öt
(
mëad©a_wrôãn
,

746 (
	`©omic_l⁄g_ªad
(&
ˇ
->
mëa_£˘‹s_wrôãn
) +

747 
	`©omic_l⁄g_ªad
(&
ˇ
->
båì_£˘‹s_wrôãn
)) << 9);

749 
	`sysfs_¥öt
(
io_îr‹s
,

750 
	`©omic_ªad
(&
ˇ
->
io_îr‹s
Ë>> 
IO_ERROR_SHIFT
);

752 i‡(
©å
 =&
sysfs_ˇche_ª∂a˚mít_pﬁicy
)

753  
	`bch_¢¥öt_°rög_li°
(
buf
, 
PAGE_SIZE
,

754 
ˇche_ª∂a˚mít_pﬁicõs
,

755 
	`CACHE_REPLACEMENT
(&
ˇ
->
sb
));

757 i‡(
©å
 =&
sysfs_¥i‹ôy_°©s
) {

758 
	`cmp
(c⁄° *
l
, c⁄° *
r
)

759 {  *((
uöt16_t
 *Ë
r
Ë- *((uöt16_à*Ë
l
); }

761 
buckë
 *
b
;

762 
size_t
 
n
 = 
ˇ
->
sb
.
nbuckës
, 
i
;

763 
size_t
 
unu£d
 = 0, 
avaûabÀ
 = 0, 
dúty
 = 0, 
mëa
 = 0;

764 
uöt64_t
 
sum
 = 0;

766 
uöt16_t
 
q
[31], *
p
, *
ˇched
;

767 
ssize_t
 
ªt
;

769 
ˇched
 = 
p
 = 
	`vmÆloc
(
ˇ
->
sb
.
nbuckës
 * (
uöt16_t
));

770 i‡(!
p
)

771  -
ENOMEM
;

773 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

774 
	`f‹_óch_buckë
(
b
, 
ˇ
) {

775 i‡(!
	`GC_SECTORS_USED
(
b
))

776 
unu£d
++;

777 i‡(
	`GC_MARK
(
b
Ë=
GC_MARK_RECLAIMABLE
)

778 
avaûabÀ
++;

779 i‡(
	`GC_MARK
(
b
Ë=
GC_MARK_DIRTY
)

780 
dúty
++;

781 i‡(
	`GC_MARK
(
b
Ë=
GC_MARK_METADATA
)

782 
mëa
++;

785 
i
 = 
ˇ
->
sb
.
fú°_buckë
; i < 
n
; i++)

786 
p
[
i
] = 
ˇ
->
buckës
[i].
¥io
;

787 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

789 
	`s‹t
(
p
, 
n
, (
uöt16_t
), 
cmp
, 
NULL
);

791 
n
 &&

792 !
ˇched
[
n
 - 1])

793 --
n
;

795 
unu£d
 = 
ˇ
->
sb
.
nbuckës
 - 
n
;

797 
ˇched
 < 
p
 + 
n
 &&

798 *
ˇched
 =
BTREE_PRIO
)

799 
ˇched
++, 
n
--;

801 
i
 = 0; i < 
n
; i++)

802 
sum
 +
INITIAL_PRIO
 - 
ˇched
[
i
];

804 i‡(
n
)

805 
	`do_div
(
sum
, 
n
);

807 
i
 = 0; i < 
	`ARRAY_SIZE
(
q
); i++)

808 
q
[
i
] = 
INITIAL_PRIO
 - 
ˇched
[
n
 * (i + 1) /

809 (
	`ARRAY_SIZE
(
q
) + 1)];

811 
	`v‰ì
(
p
);

813 
ªt
 = 
	`s˙¥ötf
(
buf
, 
PAGE_SIZE
,

821 
unu£d
 * 100 / (
size_t
Ë
ˇ
->
sb
.
nbuckës
,

822 
avaûabÀ
 * 100 / (
size_t
Ë
ˇ
->
sb
.
nbuckës
,

823 
dúty
 * 100 / (
size_t
Ë
ˇ
->
sb
.
nbuckës
,

824 
mëa
 * 100 / (
size_t
Ë
ˇ
->
sb
.
nbuckës
, 
sum
,

825 
n
 * 
ˇ
->
sb
.
buckë_size
 / (
	`ARRAY_SIZE
(
q
) + 1));

827 
i
 = 0; i < 
	`ARRAY_SIZE
(
q
); i++)

828 
ªt
 +
	`s˙¥ötf
(
buf
 +Ñë, 
PAGE_SIZE
 -Ñet,

829 "%u ", 
q
[
i
]);

830 
ªt
--;

832 
ªt
 +
	`s˙¥ötf
(
buf
 +Ñë, 
PAGE_SIZE
 -Ñet, "]\n");

834  
ªt
;

838 
	}
}

839 
	$SHOW_LOCKED
(
bch_ˇche
)

841 
	$STORE
(
__bch_ˇche
)

843 
ˇche
 *
ˇ
 = 
	`c⁄èöî_of
(
kobj
, cache, kobj);

845 i‡(
©å
 =&
sysfs_disˇrd
) {

846 
boﬁ
 
v
 = 
	`°πoul_‹_ªtu∫
(
buf
);

848 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
ˇ
->
bdev
)))

849 
ˇ
->
disˇrd
 = 
v
;

851 i‡(
v
 !
	`CACHE_DISCARD
(&
ˇ
->
sb
)) {

852 
	`SET_CACHE_DISCARD
(&
ˇ
->
sb
, 
v
);

853 
	`bˇche_wrôe_su≥r
(
ˇ
->
£t
);

857 i‡(
©å
 =&
sysfs_ˇche_ª∂a˚mít_pﬁicy
) {

858 
ssize_t
 
v
 = 
	`bch_ªad_°rög_li°
(
buf
, 
ˇche_ª∂a˚mít_pﬁicõs
);

860 i‡(
v
 < 0)

861  
v
;

863 i‡((Ë
v
 !
	`CACHE_REPLACEMENT
(&
ˇ
->
sb
)) {

864 
	`muãx_lock
(&
ˇ
->
£t
->
buckë_lock
);

865 
	`SET_CACHE_REPLACEMENT
(&
ˇ
->
sb
, 
v
);

866 
	`muãx_u∆ock
(&
ˇ
->
£t
->
buckë_lock
);

868 
	`bˇche_wrôe_su≥r
(
ˇ
->
£t
);

872 i‡(
©å
 =&
sysfs_˛ór_°©s
) {

873 
	`©omic_l⁄g_£t
(&
ˇ
->
£˘‹s_wrôãn
, 0);

874 
	`©omic_l⁄g_£t
(&
ˇ
->
båì_£˘‹s_wrôãn
, 0);

875 
	`©omic_l⁄g_£t
(&
ˇ
->
mëa_£˘‹s_wrôãn
, 0);

876 
	`©omic_£t
(&
ˇ
->
io_cou¡
, 0);

877 
	`©omic_£t
(&
ˇ
->
io_îr‹s
, 0);

880  
size
;

881 
	}
}

882 
	$STORE_LOCKED
(
bch_ˇche
)

884 
©åibuã
 *
bch_ˇche_fûes
[] = {

885 &
sysfs_buckë_size
,

886 &
sysfs_block_size
,

887 &
sysfs_nbuckës
,

888 &
sysfs_¥i‹ôy_°©s
,

889 &
sysfs_disˇrd
,

890 &
sysfs_wrôãn
,

891 &
sysfs_båì_wrôãn
,

892 &
sysfs_mëad©a_wrôãn
,

893 &
sysfs_io_îr‹s
,

894 &
sysfs_˛ór_°©s
,

895 &
sysfs_ˇche_ª∂a˚mít_pﬁicy
,

896 
NULL


897 
	}
};

898 
KTYPE
(
bch_ˇche
);

	@bcache/sysfs.h

1 #i‚de‡
_BCACHE_SYSFS_H_


2 
	#_BCACHE_SYSFS_H_


	)

4 
	#KTYPE
(
ty≥
) \

5 
kobj_ty≥
 
ty≥
 ## 
_kty≥
 = { \

6 .
ªÀa£
 = 
ty≥
 ## 
_ªÀa£
, \

7 .
sysfs_›s
 = &((const sysfs_ops) { \

8 .
show
 = 
ty≥
 ## 
_show
, \

9 .
°‹e
 = 
ty≥
 ## 
_°‹e
 \

11 .
deÁu…_©ås
 = 
ty≥
 ## 
_fûes
 \

12 }

	)

14 
	#SHOW
(
‚
) \

15 
ssize_t
 
‚
 ## 
	`_show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,\

16 *
buf
) \

17 

	)

18 
	#STORE
(
‚
) \

19 
ssize_t
 
‚
 ## 
	`_°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,\

20 c⁄° *
buf
, 
size_t
 
size
) \

21 

	)

22 
	#SHOW_LOCKED
(
‚
) \

23 
	`SHOW
(
‚
) \

25 
ssize_t
 
ªt
; \

26 
	`muãx_lock
(&
bch_ªgi°î_lock
); \

27 
ªt
 = 
__
 ## 
‚
 ## 
	`_show
(
kobj
, 
©å
, 
buf
); \

28 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
); \

29  
ªt
; \

30 }

	)

32 
	#STORE_LOCKED
(
‚
) \

33 
	`STORE
(
‚
) \

35 
ssize_t
 
ªt
; \

36 
	`muãx_lock
(&
bch_ªgi°î_lock
); \

37 
ªt
 = 
__
 ## 
‚
 ## 
	`_°‹e
(
kobj
, 
©å
, 
buf
, 
size
); \

38 
	`muãx_u∆ock
(&
bch_ªgi°î_lock
); \

39  
ªt
; \

40 }

	)

42 
	#__sysfs_©åibuã
(
_«me
, 
_mode
) \

43 
©åibuã
 
sysfs_
##
_«me
 = \

44 { .
«me
 = #_«me, .
mode
 = 
_mode
 }

	)

46 
	#wrôe_©åibuã
(
n
Ë
	`__sysfs_©åibuã
“, 
S_IWUSR
)

	)

47 
	#ªad_©åibuã
(
n
Ë
	`__sysfs_©åibuã
“, 
S_IRUGO
)

	)

48 
	#rw_©åibuã
(
n
Ë
	`__sysfs_©åibuã
“, 
S_IRUGO
|
S_IWUSR
)

	)

50 
	#sysfs_¥ötf
(
fûe
, 
fmt
, ...) \

52 i‡(
©å
 =&
sysfs_
 ## 
fûe
) \

53  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, 
fmt
 "\n", 
__VA_ARGS__
); \

54 } 0)

	)

56 
	#sysfs_¥öt
(
fûe
, 
v¨
) \

58 i‡(
©å
 =&
sysfs_
 ## 
fûe
) \

59  
	`¢¥öt
(
buf
, 
PAGE_SIZE
, 
v¨
); \

60 } 0)

	)

62 
	#sysfs_h¥öt
(
fûe
, 
vÆ
) \

64 i‡(
©å
 =&
sysfs_
 ## 
fûe
) { \

65 
ssize_t
 
ªt
 = 
	`bch_h¥öt
(
buf
, 
vÆ
); \

66 
	`°rˇt
(
buf
, "\n"); \

67  
ªt
 + 1; \

69 } 0)

	)

71 
	#v¨_¥ötf
(
_v¨
, 
fmt
Ë
	`sysfs_¥ötf
(_v¨, fmt, 
	`v¨
(_v¨))

	)

72 
	#v¨_¥öt
(
_v¨
Ë
	`sysfs_¥öt
(_v¨, 
	`v¨
(_v¨))

	)

73 
	#v¨_h¥öt
(
_v¨
Ë
	`sysfs_h¥öt
(_v¨, 
	`v¨
(_v¨))

	)

75 
	#sysfs_°πoul
(
fûe
, 
v¨
) \

77 i‡(
©å
 =&
sysfs_
 ## 
fûe
) \

78  
	`°πoul_ß„
(
buf
, 
v¨
Ë?: (
ssize_t
Ë
size
; \

79 } 0)

	)

81 
	#sysfs_°πoul_˛amp
(
fûe
, 
v¨
, 
mö
, 
max
) \

83 i‡(
©å
 =&
sysfs_
 ## 
fûe
) \

84  
	`°πoul_ß„_˛amp
(
buf
, 
v¨
, 
mö
, 
max
) \

85 ?: (
ssize_t
Ë
size
; \

86 } 0)

	)

88 
	#°πoul_‹_ªtu∫
(
˝
) \

90 
_v
; \

91 
_r
 = 
	`k°πoul
(
˝
, 10, &
_v
); \

92 i‡(
_r
) \

93  
_r
; \

94 
_v
; \

95 })

	)

97 
	#°πoi_h_‹_ªtu∫
(
˝
, 
v
) \

99 
_r
 = 
	`°πoi_h
(
˝
, &
v
); \

100 i‡(
_r
) \

101  
_r
; \

102 } 0)

	)

104 
	#sysfs_h©oi
(
fûe
, 
v¨
) \

106 i‡(
©å
 =&
sysfs_
 ## 
fûe
) \

107  
	`°πoi_h
(
buf
, &
v¨
Ë?: (
ssize_t
Ë
size
; \

108 } 0)

	)

	@bcache/trace.c

1 
	~"bˇche.h
"

2 
	~"båì.h
"

4 
	~<löux/blkåa˚_≠i.h
>

5 
	~<löux/moduÀ.h
>

7 
	#CREATE_TRACE_POINTS


	)

8 
	~<åa˚/evíts/bˇche.h
>

10 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_ªque°_°¨t
);

11 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_ªque°_íd
);

13 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_by∑ss_£quítül
);

14 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_by∑ss_c⁄ge°ed
);

16 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_ªad
);

17 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_wrôe
);

18 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_ªad_ªåy
);

20 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_ˇche_ö£π
);

22 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_jou∫Æ_ª∂ay_key
);

23 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_jou∫Æ_wrôe
);

24 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_jou∫Æ_fuŒ
);

25 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_jou∫Æ_íåy_fuŒ
);

27 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_ˇche_ˇ¬ibÆize
);

29 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_ªad
);

30 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_wrôe
);

32 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_node_Æloc
);

33 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_node_Æloc_Áû
);

34 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_node_‰ì
);

36 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_gc_cﬂÀs˚
);

37 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_gc_°¨t
);

38 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_gc_íd
);

39 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_gc_c›y
);

40 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_gc_c›y_cﬁlisi⁄
);

42 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_ö£π_key
);

44 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_node_•lô
);

45 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_node_com∑˘
);

46 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_båì_£t_roŸ
);

48 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_övÆid©e
);

49 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_Æloc_Áû
);

51 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_wrôeback
);

52 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
bˇche_wrôeback_cﬁlisi⁄
);

	@bcache/util.c

8 
	~<löux/bio.h
>

9 
	~<löux/blkdev.h
>

10 
	~<löux/˘y≥.h
>

11 
	~<löux/debugfs.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/ty≥s.h
>

16 
	~"utû.h
"

18 
	#sim∂e_°πoöt
(
c
, 
íd
, 
ba£
Ë
	`sim∂e_°πﬁ
(c,Énd, ba£)

	)

19 
	#sim∂e_°πouöt
(
c
, 
íd
, 
ba£
Ë
	`sim∂e_°πoul
(c,Énd, ba£)

	)

21 
	#STRTO_H
(
«me
, 
ty≥
) \

22 
bch_
 ## 
«me
 ## 
	`_h
(c⁄° *
˝
, 
ty≥
 *
ªs
) \

24 
u
 = 0; \

25 *
e
; \

26 
ty≥
 
i
 = 
sim∂e_
 ## 
	`«me
(
˝
, &
e
, 10); \

28 
	`tﬁowî
(*
e
)) { \

30  -
EINVAL
; \

33 
u
++; \

35 
u
++; \

37 
u
++; \

39 
u
++; \

41 
u
++; \

43 
u
++; \

45 
u
++; \

46 i‡(
e
++ =
˝
) \

47  -
EINVAL
; \

50 i‡(*
e
 == '\n') \

51 
e
++; \

54 i‡(*
e
) \

55  -
EINVAL
; \

57 
u
--) { \

58 i‡((
ty≥
) ~0 > 0 && \

59 (
ty≥
Ë~0 / 1024 <
i
) \

60  -
EINVAL
; \

61 i‡((
i
 > 0 && 
	`ANYSINT_MAX
(
ty≥
) / 1024 < i) || \

62 (
i
 < 0 && -
	`ANYSINT_MAX
(
ty≥
) / 1024 > i)) \

63  -
EINVAL
; \

64 
i
 *= 1024; \

67 *
ªs
 = 
i
; \

70 

	)

71 
	$STRTO_H
(
°πoöt
, )

72 
	$STRTO_H
(
°πouöt
, )

73 
	$STRTO_H
(
°πﬁl
, )

74 
	$STRTO_H
(
°πouŒ
, )

76 
ssize_t
 
	$bch_h¥öt
(*
buf
, 
öt64_t
 
v
)

78 c⁄° 
unôs
[] = "?kMGTPEZY";

79 
dec
[4] = "";

80 
u
, 
t
 = 0;

82 
u
 = 0; 
v
 >= 1024 || v <= -1024; u++) {

83 
t
 = 
v
 & ~(~0 << 10);

84 
v
 >>= 10;

87 i‡(!
u
)

88  
	`•rötf
(
buf
, "%Œu", 
v
);

90 i‡(
v
 < 100 && v > -100)

91 
	`¢¥ötf
(
dec
, (dec), ".%i", 
t
 / 100);

93  
	`•rötf
(
buf
, "%Œi%s%c", 
v
, 
dec
, 
unôs
[
u
]);

94 
	}
}

96 
ssize_t
 
	$bch_¢¥öt_°rög_li°
(*
buf
, 
size_t
 
size
, c⁄° * c⁄° 
li°
[],

97 
size_t
 
£À˘ed
)

99 *
out
 = 
buf
;

100 
size_t
 
i
;

102 
i
 = 0; 
li°
[i]; i++)

103 
out
 +
	`¢¥ötf
(out, 
buf
 + 
size
 - out,

104 
i
 =
£À˘ed
 ? "[%s] " : "%†", 
li°
[i]);

106 
out
[-1] = '\n';

107  
out
 - 
buf
;

108 
	}
}

110 
ssize_t
 
	$bch_ªad_°rög_li°
(c⁄° *
buf
, c⁄° * c⁄° 
li°
[])

112 
size_t
 
i
;

113 *
s
, *
d
 = 
	`k°∫dup
(
buf
, 
PAGE_SIZE
 - 1, 
GFP_KERNEL
);

114 i‡(!
d
)

115  -
ENOMEM
;

117 
s
 = 
	`°rim
(
d
);

119 
i
 = 0; 
li°
[i]; i++)

120 i‡(!
	`°rcmp
(
li°
[
i
], 
s
))

123 
	`k‰ì
(
d
);

125 i‡(!
li°
[
i
])

126  -
EINVAL
;

128  
i
;

129 
	}
}

131 
boﬁ
 
	$bch_is_zîo
(c⁄° *
p
, 
size_t
 
n
)

133 
size_t
 
i
;

135 
i
 = 0; i < 
n
; i++)

136 i‡(
p
[
i
])

137  
Ál£
;

138  
åue
;

139 
	}
}

141 
	$bch_∑r£_uuid
(c⁄° *
s
, *
uuid
)

143 
size_t
 
i
, 
j
, 
x
;

144 
	`mem£t
(
uuid
, 0, 16);

146 
i
 = 0, 
j
 = 0;

147 
i
 < 
	`°r•n
(
s
, "-0123456789:ABCDEFabcdef"Ë&& 
j
 < 32;

148 
i
++) {

149 
x
 = 
s
[
i
] | 32;

151 
x
) {

153 
x
 -= '0';

156 
x
 -= 'a' - 10;

162 i‡(!(
j
 & 1))

163 
x
 <<= 4;

164 
uuid
[
j
++ >> 1] |
x
;

166  
i
;

167 
	}
}

169 
	$bch_time_°©s_upd©e
(
time_°©s
 *
°©s
, 
uöt64_t
 
°¨t_time
)

171 
uöt64_t
 
now
, 
duøti⁄
, 
œ°
;

173 
	`•ö_lock
(&
°©s
->
lock
);

175 
now
 = 
	`loˇl_˛ock
();

176 
duøti⁄
 = 
	`time_a·î64
(
now
, 
°¨t_time
)

177 ? 
now
 - 
°¨t_time
 : 0;

178 
œ°
 = 
	`time_a·î64
(
now
, 
°©s
->last)

179 ? 
now
 - 
°©s
->
œ°
 : 0;

181 
°©s
->
max_duøti⁄
 = 
	`max
(°©s->max_duøti⁄, 
duøti⁄
);

183 i‡(
°©s
->
œ°
) {

184 
	`ewma_add
(
°©s
->
avîage_duøti⁄
, 
duøti⁄
, 8, 8);

186 i‡(
°©s
->
avîage_‰equícy
)

187 
	`ewma_add
(
°©s
->
avîage_‰equícy
, 
œ°
, 8, 8);

189 
°©s
->
avîage_‰equícy
 = 
œ°
 << 8;

191 
°©s
->
avîage_duøti⁄
 = 
duøti⁄
 << 8;

194 
°©s
->
œ°
 = 
now
 ?: 1;

196 
	`•ö_u∆ock
(&
°©s
->
lock
);

197 
	}
}

208 
uöt64_t
 
	$bch_√xt_dñay
(
bch_øãlimô
 *
d
, 
uöt64_t
 
d⁄e
)

210 
uöt64_t
 
now
 = 
	`loˇl_˛ock
();

212 
d
->
√xt
 +
	`div_u64
(
d⁄e
 * 
NSEC_PER_SEC
, d->
øã
);

214 i‡(
	`time_bef‹e64
(
now
 + 
NSEC_PER_SEC
, 
d
->
√xt
))

215 
d
->
√xt
 = 
now
 + 
NSEC_PER_SEC
;

217 i‡(
	`time_a·î64
(
now
 - 
NSEC_PER_SEC
 * 2, 
d
->
√xt
))

218 
d
->
√xt
 = 
now
 - 
NSEC_PER_SEC
 * 2;

220  
	`time_a·î64
(
d
->
√xt
, 
now
)

221 ? 
	`div_u64
(
d
->
√xt
 - 
now
, 
NSEC_PER_SEC
 / 
HZ
)

223 
	}
}

225 
	$bch_bio_m≠
(
bio
 *bio, *
ba£
)

227 
size_t
 
size
 = 
bio
->
bi_ôî
.
bi_size
;

228 
bio_vec
 *
bv
 = 
bio
->
bi_io_vec
;

230 
	`BUG_ON
(!
bio
->
bi_ôî
.
bi_size
);

231 
	`BUG_ON
(
bio
->
bi_v˙t
);

233 
bv
->
bv_off£t
 = 
ba£
 ? ((Ëba£Ë% 
PAGE_SIZE
 : 0;

234 
°¨t
;

236 ; 
size
; 
bio
->
bi_v˙t
++, 
bv
++) {

237 
bv
->
bv_off£t
 = 0;

238 
°¨t
: 
bv
->
bv_Àn
 = 
	`mö_t
(
size_t
, 
PAGE_SIZE
 - bv->
bv_off£t
,

239 
size
);

240 i‡(
ba£
) {

241 
bv
->
bv_∑ge
 = 
	`is_vmÆloc_addr
(
ba£
)

242 ? 
	`vmÆloc_to_∑ge
(
ba£
)

243 : 
	`vút_to_∑ge
(
ba£
);

245 
ba£
 +
bv
->
bv_Àn
;

248 
size
 -
bv
->
bv_Àn
;

250 
	}
}

273 c⁄° 
uöt64_t
 
	g¸c_èbÀ
[256] = {

362 
uöt64_t
 
	$bch_¸c64_upd©e
(
uöt64_t
 
¸c
, c⁄° *
_d©a
, 
size_t
 
Àn
)

364 c⁄° *
d©a
 = 
_d©a
;

366 
Àn
--) {

367 
i
 = ((Ë(
¸c
 >> 56Ë^ *
d©a
++) & 0xFF;

368 
¸c
 = 
¸c_èbÀ
[
i
] ^ (crc << 8);

371  
¸c
;

372 
	}
}

374 
uöt64_t
 
	$bch_¸c64
(c⁄° *
d©a
, 
size_t
 
Àn
)

376 
uöt64_t
 
¸c
 = 0xffffffffffffffffULL;

378 
¸c
 = 
	`bch_¸c64_upd©e
(¸c, 
d©a
, 
Àn
);

380  
¸c
 ^ 0xffffffffffffffffULL;

381 
	}
}

	@bcache/util.h

2 #i‚de‡
_BCACHE_UTIL_H


3 
	#_BCACHE_UTIL_H


	)

5 
	~<löux/blkdev.h
>

6 
	~<löux/î∫o.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/Œi°.h
>

9 
	~<löux/øãlimô.h
>

10 
	~<löux/vmÆloc.h
>

11 
	~<löux/w‹kqueue.h
>

13 
	~"˛osuª.h
"

15 
	#PAGE_SECTORS
 (
PAGE_SIZE
 / 512)

	)

17 
	g˛osuª
;

19 #ifde‡
CONFIG_BCACHE_DEBUG


21 
	#EBUG_ON
(
c⁄d
Ë
	`BUG_ON
(c⁄d)

	)

22 
	#©omic_dec_bug
(
v
Ë
	`BUG_ON
(
	`©omic_dec_ªtu∫
(vË< 0)

	)

23 
	#©omic_öc_bug
(
v
, 
i
Ë
	`BUG_ON
(
	`©omic_öc_ªtu∫
(vË<i)

	)

27 
	#EBUG_ON
(
c⁄d
Ëdÿ{ i‡(c⁄d); } 0)

	)

28 
	#©omic_dec_bug
(
v
Ë
	`©omic_dec
(v)

	)

29 
	#©omic_öc_bug
(
v
, 
i
Ë
	`©omic_öc
(v)

	)

33 
	#DECLARE_HEAP
(
ty≥
, 
«me
) \

35 
size_t
 
size
, 
u£d
; \

36 
ty≥
 *
d©a
; \

37 } 
«me


	)

39 
	#öô_hóp
(
hóp
, 
_size
, 
gÂ
) \

41 
size_t
 
_byãs
; \

42 (
hóp
)->
u£d
 = 0; \

43 (
hóp
)->
size
 = (
_size
); \

44 
_byãs
 = (
hóp
)->
size
 * (*(hóp)->
d©a
); \

45 (
hóp
)->
d©a
 = 
NULL
; \

46 i‡(
_byãs
 < 
KMALLOC_MAX_SIZE
) \

47 (
hóp
)->
d©a
 = 
	`kmÆloc
(
_byãs
, (
gÂ
)); \

48 i‡((!(
hóp
)->
d©a
Ë&& ((
gÂ
Ë& 
GFP_KERNEL
)) \

49 (
hóp
)->
d©a
 = 
	`vmÆloc
(
_byãs
); \

50 (
hóp
)->
d©a
; \

51 })

	)

53 
	#‰ì_hóp
(
hóp
) \

55 i‡(
	`is_vmÆloc_addr
((
hóp
)->
d©a
)) \

56 
	`v‰ì
((
hóp
)->
d©a
); \

58 
	`k‰ì
((
hóp
)->
d©a
); \

59 (
hóp
)->
d©a
 = 
NULL
; \

60 } 0)

	)

62 
	#hóp_sw≠
(
h
, 
i
, 
j
Ë
	`sw≠
((h)->
d©a
[i], (h)->d©a[j])

	)

64 
	#hóp_si·
(
h
, 
i
, 
cmp
) \

66 
size_t
 
_r
, 
_j
 = 
i
; \

68 ; 
_j
 * 2 + 1 < (
h
)->
u£d
; _j = 
_r
) { \

69 
_r
 = 
_j
 * 2 + 1; \

70 i‡(
_r
 + 1 < (
h
)->
u£d
 && \

71 
	`cmp
((
h
)->
d©a
[
_r
], (h)->data[_r + 1])) \

72 
_r
++; \

74 i‡(
	`cmp
((
h
)->
d©a
[
_r
], (h)->d©a[
_j
])) \

76 
	`hóp_sw≠
(
h
, 
_r
, 
_j
); \

78 } 0)

	)

80 
	#hóp_si·_down
(
h
, 
i
, 
cmp
) \

82 
i
) { \

83 
size_t
 
p
 = (
i
 - 1) / 2; \

84 i‡(
	`cmp
((
h
)->
d©a
[
i
], (h)->d©a[
p
])) \

86 
	`hóp_sw≠
(
h
, 
i
, 
p
); \

87 
i
 = 
p
; \

89 } 0)

	)

91 
	#hóp_add
(
h
, 
d
, 
cmp
) \

93 
boﬁ
 
_r
 = !
	`hóp_fuŒ
(
h
); \

94 i‡(
_r
) { \

95 
size_t
 
_i
 = (
h
)->
u£d
++; \

96 (
h
)->
d©a
[
_i
] = 
d
; \

98 
	`hóp_si·_down
(
h
, 
_i
, 
cmp
); \

99 
	`hóp_si·
(
h
, 
_i
, 
cmp
); \

101 
_r
; \

102 })

	)

104 
	#hóp_p›
(
h
, 
d
, 
cmp
) \

106 
boﬁ
 
_r
 = (
h
)->
u£d
; \

107 i‡(
_r
) { \

108 (
d
Ë(
h
)->
d©a
[0]; \

109 (
h
)->
u£d
--; \

110 
	`hóp_sw≠
(
h
, 0, (h)->
u£d
); \

111 
	`hóp_si·
(
h
, 0, 
cmp
); \

113 
_r
; \

114 })

	)

116 
	#hóp_≥ek
(
h
Ë((h)->
u£d
 ? (h)->
d©a
[0] : 
NULL
)

	)

118 
	#hóp_fuŒ
(
h
Ë((h)->
u£d
 =(h)->
size
)

	)

120 
	#DECLARE_FIFO
(
ty≥
, 
«me
) \

122 
size_t
 
‰⁄t
, 
back
, 
size
, 
mask
; \

123 
ty≥
 *
d©a
; \

124 } 
«me


	)

126 
	#fifo_f‹_óch
(
c
, 
fifo
, 
ôî
) \

127 
ôî
 = (
fifo
)->
‰⁄t
; \

128 
c
 = (
fifo
)->
d©a
[
ôî
], iã∏!(fifo)->
back
; \

129 
ôî
 = (ôî + 1Ë& (
fifo
)->
mask
)

	)

131 
	#__öô_fifo
(
fifo
, 
gÂ
) \

133 
size_t
 
_Æloˇãd_size
, 
_byãs
; \

134 
	`BUG_ON
(!(
fifo
)->
size
); \

136 
_Æloˇãd_size
 = 
	`roundup_pow_of_two
((
fifo
)->
size
 + 1); \

137 
_byãs
 = 
_Æloˇãd_size
 * (*(
fifo
)->
d©a
); \

139 (
fifo
)->
mask
 = 
_Æloˇãd_size
 - 1; \

140 (
fifo
)->
‰⁄t
 = (fifo)->
back
 = 0; \

141 (
fifo
)->
d©a
 = 
NULL
; \

143 i‡(
_byãs
 < 
KMALLOC_MAX_SIZE
) \

144 (
fifo
)->
d©a
 = 
	`kmÆloc
(
_byãs
, (
gÂ
)); \

145 i‡((!(
fifo
)->
d©a
Ë&& ((
gÂ
Ë& 
GFP_KERNEL
)) \

146 (
fifo
)->
d©a
 = 
	`vmÆloc
(
_byãs
); \

147 (
fifo
)->
d©a
; \

148 })

	)

150 
	#öô_fifo_exa˘
(
fifo
, 
_size
, 
gÂ
) \

152 (
fifo
)->
size
 = (
_size
); \

153 
	`__öô_fifo
(
fifo
, 
gÂ
); \

154 })

	)

156 
	#öô_fifo
(
fifo
, 
_size
, 
gÂ
) \

158 (
fifo
)->
size
 = (
_size
); \

159 i‡((
fifo
)->
size
 > 4) \

160 (
fifo
)->
size
 = 
	`roundup_pow_of_two
((fifo)->size) - 1; \

161 
	`__öô_fifo
(
fifo
, 
gÂ
); \

162 })

	)

164 
	#‰ì_fifo
(
fifo
) \

166 i‡(
	`is_vmÆloc_addr
((
fifo
)->
d©a
)) \

167 
	`v‰ì
((
fifo
)->
d©a
); \

169 
	`k‰ì
((
fifo
)->
d©a
); \

170 (
fifo
)->
d©a
 = 
NULL
; \

171 } 0)

	)

173 
	#fifo_u£d
(
fifo
Ë(((fifo)->
back
 - (fifo)->
‰⁄t
Ë& (fifo)->
mask
)

	)

174 
	#fifo_‰ì
(
fifo
Ë((fifo)->
size
 - 
	`fifo_u£d
(fifo))

	)

176 
	#fifo_em±y
(
fifo
Ë(!
	`fifo_u£d
(fifo))

	)

177 
	#fifo_fuŒ
(
fifo
Ë(!
	`fifo_‰ì
(fifo))

	)

179 
	#fifo_‰⁄t
(
fifo
Ë((fifo)->
d©a
[(fifo)->
‰⁄t
])

	)

180 
	#fifo_back
(
fifo
) \

181 ((
fifo
)->
d©a
[((fifo)->
back
 - 1Ë& (fifo)->
mask
])

	)

183 
	#fifo_idx
(
fifo
, 
p
Ë((’Ë- &
	`fifo_‰⁄t
(fifo)Ë& (fifo)->
mask
)

	)

185 
	#fifo_push_back
(
fifo
, 
i
) \

187 
boﬁ
 
_r
 = !
	`fifo_fuŒ
((
fifo
)); \

188 i‡(
_r
) { \

189 (
fifo
)->
d©a
[(fifo)->
back
++] = (
i
); \

190 (
fifo
)->
back
 &(fifo)->
mask
; \

192 
_r
; \

193 })

	)

195 
	#fifo_p›_‰⁄t
(
fifo
, 
i
) \

197 
boﬁ
 
_r
 = !
	`fifo_em±y
((
fifo
)); \

198 i‡(
_r
) { \

199 (
i
Ë(
fifo
)->
d©a
[(fifo)->
‰⁄t
++]; \

200 (
fifo
)->
‰⁄t
 &(fifo)->
mask
; \

202 
_r
; \

203 })

	)

205 
	#fifo_push_‰⁄t
(
fifo
, 
i
) \

207 
boﬁ
 
_r
 = !
	`fifo_fuŒ
((
fifo
)); \

208 i‡(
_r
) { \

209 --(
fifo
)->
‰⁄t
; \

210 (
fifo
)->
‰⁄t
 &(fifo)->
mask
; \

211 (
fifo
)->
d©a
[(fifo)->
‰⁄t
] = (
i
); \

213 
_r
; \

214 })

	)

216 
	#fifo_p›_back
(
fifo
, 
i
) \

218 
boﬁ
 
_r
 = !
	`fifo_em±y
((
fifo
)); \

219 i‡(
_r
) { \

220 --(
fifo
)->
back
; \

221 (
fifo
)->
back
 &(fifo)->
mask
; \

222 (
i
Ë(
fifo
)->
d©a
[(fifo)->
back
] \

224 
_r
; \

225 })

	)

227 
	#fifo_push
(
fifo
, 
i
Ë
	`fifo_push_back
(fifo, (i))

	)

228 
	#fifo_p›
(
fifo
, 
i
Ë
	`fifo_p›_‰⁄t
(fifo, (i))

	)

230 
	#fifo_sw≠
(
l
, 
r
) \

232 
	`sw≠
((
l
)->
‰⁄t
, (
r
)->front); \

233 
	`sw≠
((
l
)->
back
, (
r
)->back); \

234 
	`sw≠
((
l
)->
size
, (
r
)->size); \

235 
	`sw≠
((
l
)->
mask
, (
r
)->mask); \

236 
	`sw≠
((
l
)->
d©a
, (
r
)->data); \

237 } 0)

	)

239 
	#fifo_move
(
de°
, 
§c
) \

241 
	`ty≥of
(*((
de°
)->
d©a
)Ë
_t
; \

242 !
	`fifo_fuŒ
(
de°
) && \

243 
	`fifo_p›
(
§c
, 
_t
)) \

244 
	`fifo_push
(
de°
, 
_t
); \

245 } 0)

	)

259 
	#DECLARE_ARRAY_ALLOCATOR
(
ty≥
, 
«me
, 
size
) \

261 
ty≥
 *
‰ìli°
; \

262 
ty≥
 
d©a
[
size
]; \

263 } 
«me


	)

265 
	#¨øy_Æloc
(
¨øy
) \

267 
	`ty≥of
((
¨øy
)->
‰ìli°
Ë
_ªt
 = (array)->freelist; \

269 i‡(
_ªt
) \

270 (
¨øy
)->
‰ìli°
 = *((
	`ty≥of
(◊ºay)->‰ìli°Ë*Ë
_ªt
);\

272 
_ªt
; \

273 })

	)

275 
	#¨øy_‰ì
(
¨øy
, 
±r
) \

277 
	`ty≥of
((
¨øy
)->
‰ìli°
Ë
_±r
 = 
±r
; \

279 *((
	`ty≥of
((
¨øy
)->
‰ìli°
Ë*Ë
_±r
) = (array)->freelist; \

280 (
¨øy
)->
‰ìli°
 = 
_±r
; \

281 } 0)

	)

283 
	#¨øy_Æloˇt‹_öô
(
¨øy
) \

285 
	`ty≥of
((
¨øy
)->
‰ìli°
Ë
_i
; \

287 
	`BUILD_BUG_ON
(((
¨øy
)->
d©a
[0]) < (*)); \

288 (
¨øy
)->
‰ìli°
 = 
NULL
; \

290 
_i
 = (
¨øy
)->
d©a
; \

291 
_i
 < (
¨øy
)->
d©a
 + 
	`ARRAY_SIZE
((array)->data); \

292 
_i
++) \

293 
	`¨øy_‰ì
(
¨øy
, 
_i
); \

294 } 0)

	)

296 
	#¨øy_‰ìli°_em±y
(
¨øy
Ë(◊ºay)->
‰ìli°
 =
NULL
)

	)

298 
	#ANYSINT_MAX
(
t
) \

299 ((((
t
Ë1 << (—Ë* 8 - 2)Ë- (tË1Ë* (tË2 + (tË1)

	)

301 
bch_°πoöt_h
(const *, *);

302 
bch_°πouöt_h
(const *, *);

303 
bch_°πﬁl_h
(const *, *);

304 
bch_°πouŒ_h
(const *, *);

306 
ölöe
 
	$bch_°πﬁ_h
(c⁄° *
˝
, *
ªs
)

308 #i‡
BITS_PER_LONG
 == 32

309  
	`bch_°πoöt_h
(
˝
, (*Ë
ªs
);

311  
	`bch_°πﬁl_h
(
˝
, (*Ë
ªs
);

313 
	}
}

315 
ölöe
 
	$bch_°πoul_h
(c⁄° *
˝
, *
ªs
)

317 #i‡
BITS_PER_LONG
 == 32

318  
	`bch_°πouöt_h
(
˝
, (*Ë
ªs
);

320  
	`bch_°πouŒ_h
(
˝
, (*Ë
ªs
);

322 
	}
}

324 
	#°πoi_h
(
˝
, 
ªs
) \

325 (
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), ) \

326 ? 
	`bch_°πoöt_h
(
˝
, (*Ë
ªs
) \

327 : 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), ) \

328 ? 
	`bch_°πﬁ_h
(
˝
, (*Ë
ªs
) \

329 : 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), ) \

330 ? 
	`bch_°πﬁl_h
(
˝
, (*Ë
ªs
) \

331 : 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), ) \

332 ? 
	`bch_°πouöt_h
(
˝
, (*Ë
ªs
) \

333 : 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), ) \

334 ? 
	`bch_°πoul_h
(
˝
, (*Ë
ªs
) \

335 : 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(*
ªs
), )\

336 ? 
	`bch_°πouŒ_h
(
˝
, (*Ë
ªs
Ë: -
EINVAL
)

	)

338 
	#°πoul_ß„
(
˝
, 
v¨
) \

340 
_v
; \

341 
_r
 = 
	`k°πoul
(
˝
, 10, &
_v
); \

342 i‡(!
_r
) \

343 
v¨
 = 
_v
; \

344 
_r
; \

345 })

	)

347 
	#°πoul_ß„_˛amp
(
˝
, 
v¨
, 
mö
, 
max
) \

349 
_v
; \

350 
_r
 = 
	`k°πoul
(
˝
, 10, &
_v
); \

351 i‡(!
_r
) \

352 
v¨
 = 
	`˛amp_t
(
	`ty≥of
(v¨), 
_v
, 
mö
, 
max
); \

353 
_r
; \

354 })

	)

356 
	#¢¥öt
(
buf
, 
size
, 
v¨
) \

357 
	`¢¥ötf
(
buf
, 
size
, \

358 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), ) \

360 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), ) \

362 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), ) \

364 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), )\

366 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), 
öt64_t
) \

368 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), 
uöt64_t
) \

370 
	`__buûtö_ty≥s_com∑tibÀ_p
(
	`ty≥of
(
v¨
), const *) \

371 ? "%s\n" : "%i\n", 
v¨
)

	)

373 
ssize_t
 
bch_h¥öt
(*
buf
, 
öt64_t
 
v
);

375 
boﬁ
 
bch_is_zîo
(c⁄° *
p
, 
size_t
 
n
);

376 
bch_∑r£_uuid
(c⁄° *
s
, *
uuid
);

378 
ssize_t
 
bch_¢¥öt_°rög_li°
(*
buf
, 
size_t
 
size
, c⁄° * c⁄° 
li°
[],

379 
size_t
 
£À˘ed
);

381 
ssize_t
 
bch_ªad_°rög_li°
(c⁄° *
buf
, c⁄° * c⁄° 
li°
[]);

383 
	stime_°©s
 {

384 
•ölock_t
 
	mlock
;

389 
uöt64_t
 
	mmax_duøti⁄
;

390 
uöt64_t
 
	mavîage_duøti⁄
;

391 
uöt64_t
 
	mavîage_‰equícy
;

392 
uöt64_t
 
	mœ°
;

395 
bch_time_°©s_upd©e
(
time_°©s
 *
°©s
, 
uöt64_t
 
time
);

397 
ölöe
 
	$loˇl_˛ock_us
()

399  
	`loˇl_˛ock
() >> 10;

400 
	}
}

402 
	#NSEC_PER_ns
 1L

	)

403 
	#NSEC_PER_us
 
NSEC_PER_USEC


	)

404 
	#NSEC_PER_ms
 
NSEC_PER_MSEC


	)

405 
	#NSEC_PER_£c
 
NSEC_PER_SEC


	)

407 
	#__¥öt_time_°©
(
°©s
, 
«me
, 
°©
, 
unôs
) \

408 
	`sysfs_¥öt
(
«me
 ## 
_
 ## 
°©
 ## _ ## 
unôs
, \

409 
	`div_u64
((
°©s
)->
°©
 >> 8, 
NSEC_PER_
 ## 
unôs
))

	)

411 
	#sysfs_¥öt_time_°©s
(
°©s
, 
«me
, \

412 
‰equícy_unôs
, \

413 
duøti⁄_unôs
) \

415 
	`__¥öt_time_°©
(
°©s
, 
«me
, \

416 
avîage_‰equícy
, 
‰equícy_unôs
); \

417 
	`__¥öt_time_°©
(
°©s
, 
«me
, \

418 
avîage_duøti⁄
, 
duøti⁄_unôs
); \

419 
	`sysfs_¥öt
(
«me
 ## 
_
 ##
max_duøti⁄
 ## _ ## 
duøti⁄_unôs
, \

420 
	`div_u64
((
°©s
)->
max_duøti⁄
, 
NSEC_PER_
 ## 
duøti⁄_unôs
));\

422 
	`sysfs_¥öt
(
«me
 ## 
_œ°_
 ## 
‰equícy_unôs
, (
°©s
)->
œ°
 \

423 ? 
	`div_s64
(
	`loˇl_˛ock
(Ë- (
°©s
)->
œ°
, \

424 
NSEC_PER_
 ## 
‰equícy_unôs
) \

426 } 0)

	)

428 
	#sysfs_time_°©s_©åibuã
(
«me
, \

429 
‰equícy_unôs
, \

430 
duøti⁄_unôs
) \

431 
	`ªad_©åibuã
(
«me
 ## 
_avîage_‰equícy_
 ## 
‰equícy_unôs
); \

432 
	`ªad_©åibuã
(
«me
 ## 
_avîage_duøti⁄_
 ## 
duøti⁄_unôs
); \

433 
	`ªad_©åibuã
(
«me
 ## 
_max_duøti⁄_
 ## 
duøti⁄_unôs
); \

434 
	`ªad_©åibuã
(
«me
 ## 
_œ°_
 ## 
‰equícy_unôs
)

	)

436 
	#sysfs_time_°©s_©åibuã_li°
(
«me
, \

437 
‰equícy_unôs
, \

438 
duøti⁄_unôs
) \

439 &
sysfs_
 ## 
«me
 ## 
_avîage_‰equícy_
 ## 
‰equícy_unôs
, \

440 &
sysfs_
 ## 
«me
 ## 
_avîage_duøti⁄_
 ## 
duøti⁄_unôs
, \

441 &
sysfs_
 ## 
«me
 ## 
_max_duøti⁄_
 ## 
duøti⁄_unôs
, \

442 &
sysfs_
 ## 
«me
 ## 
_œ°_
 ## 
‰equícy_unôs
,

	)

444 
	#ewma_add
(
ewma
, 
vÆ
, 
weight
, 
Á˘‹
) \

446 (
ewma
Ë*(
weight
) - 1; \

447 (
ewma
Ë+(
vÆ
Ë<< 
Á˘‹
; \

448 (
ewma
Ë/(
weight
); \

449 (
ewma
Ë>> 
Á˘‹
; \

450 })

	)

452 
	sbch_øãlimô
 {

454 
uöt64_t
 
	m√xt
;

460 
	møã
;

463 
ölöe
 
	$bch_øãlimô_ª£t
(
bch_øãlimô
 *
d
)

465 
d
->
√xt
 = 
	`loˇl_˛ock
();

466 
	}
}

468 
uöt64_t
 
bch_√xt_dñay
(
bch_øãlimô
 *
d
, uöt64_à
d⁄e
);

470 
	#__DIV_SAFE
(
n
, 
d
, 
zîo
) \

472 
	`ty≥of
(
n
Ë
_n
 = (n); \

473 
	`ty≥of
(
d
Ë
_d
 = (d); \

474 
_d
 ? 
_n
 / _d : 
zîo
; \

475 })

	)

477 
	#DIV_SAFE
(
n
, 
d
Ë
	`__DIV_SAFE
“, d, 0)

	)

479 
	#c⁄èöî_of_‹_nuŒ
(
±r
, 
ty≥
, 
membî
) \

481 
	`ty≥of
(
±r
Ë
_±r
 =Ötr; \

482 
_±r
 ? 
	`c⁄èöî_of
(_±r, 
ty≥
, 
membî
Ë: 
NULL
; \

483 })

	)

485 
	#RB_INSERT
(
roŸ
, 
√w
, 
membî
, 
cmp
) \

487 
__œbñ__
 
dup
; \

488 
rb_node
 **
n
 = &(
roŸ
)->rb_node, *
∑ª¡
 = 
NULL
; \

489 
	`ty≥of
(
√w
Ë
this
; \

490 
ªs
, 
ªt
 = -1; \

492 *
n
) { \

493 
∑ª¡
 = *
n
; \

494 
this
 = 
	`c⁄èöî_of
(*
n
, 
	`ty≥of
(*(
√w
)), 
membî
); \

495 
ªs
 = 
	`cmp
(
√w
, 
this
); \

496 i‡(!
ªs
) \

497 
dup
; \

498 
n
 = 
ªs
 < 0 \

499 ? &(*
n
)->
rb_À·
 \

500 : &(*
n
)->
rb_right
; \

503 
	`rb_lök_node
(&(
√w
)->
membî
, 
∑ª¡
, 
n
); \

504 
	`rb_ö£π_cﬁ‹
(&(
√w
)->
membî
, 
roŸ
); \

505 
ªt
 = 0; \

506 
dup
: \

507 
ªt
; \

508 })

	)

510 
	#RB_SEARCH
(
roŸ
, 
£¨ch
, 
membî
, 
cmp
) \

512 
rb_node
 *
n
 = (
roŸ
)->rb_node; \

513 
	`ty≥of
(&(
£¨ch
)Ë
this
, 
ªt
 = 
NULL
; \

514 
ªs
; \

516 
n
) { \

517 
this
 = 
	`c⁄èöî_of
(
n
, 
	`ty≥of
(
£¨ch
), 
membî
); \

518 
ªs
 = 
	`cmp
(&(
£¨ch
), 
this
); \

519 i‡(!
ªs
) { \

520 
ªt
 = 
this
; \

523 
n
 = 
ªs
 < 0 \

524 ? 
n
->
rb_À·
 \

525 : 
n
->
rb_right
; \

527 
ªt
; \

528 })

	)

530 
	#RB_GREATER
(
roŸ
, 
£¨ch
, 
membî
, 
cmp
) \

532 
rb_node
 *
n
 = (
roŸ
)->rb_node; \

533 
	`ty≥of
(&(
£¨ch
)Ë
this
, 
ªt
 = 
NULL
; \

534 
ªs
; \

536 
n
) { \

537 
this
 = 
	`c⁄èöî_of
(
n
, 
	`ty≥of
(
£¨ch
), 
membî
); \

538 
ªs
 = 
	`cmp
(&(
£¨ch
), 
this
); \

539 i‡(
ªs
 < 0) { \

540 
ªt
 = 
this
; \

541 
n
 =Ç->
rb_À·
; \

543 
n
 =Ç->
rb_right
; \

545 
ªt
; \

546 })

	)

548 
	#RB_FIRST
(
roŸ
, 
ty≥
, 
membî
) \

549 
	`c⁄èöî_of_‹_nuŒ
(
	`rb_fú°
(
roŸ
), 
ty≥
, 
membî
)

	)

551 
	#RB_LAST
(
roŸ
, 
ty≥
, 
membî
) \

552 
	`c⁄èöî_of_‹_nuŒ
(
	`rb_œ°
(
roŸ
), 
ty≥
, 
membî
)

	)

554 
	#RB_NEXT
(
±r
, 
membî
) \

555 
	`c⁄èöî_of_‹_nuŒ
(
	`rb_√xt
(&(
±r
)->
membî
), 
	`ty≥of
(*±r), membî)

	)

557 
	#RB_PREV
(
±r
, 
membî
) \

558 
	`c⁄èöî_of_‹_nuŒ
(
	`rb_¥ev
(&(
±r
)->
membî
), 
	`ty≥of
(*±r), membî)

	)

561 
ölöe
 
	$‰a˘_exp_two
(
x
, 
‰a˘_bôs
)

563 
‰a˘
 = 
x
 & ~(~0 << 
‰a˘_bôs
);

565 
x
 >>
‰a˘_bôs
;

566 
x
 = 1 << x;

567 
x
 +(x * 
‰a˘
Ë>> 
‰a˘_bôs
;

569  
x
;

570 
	}
}

572 
bch_bio_m≠
(
bio
 *bio, *
ba£
);

574 
ölöe
 
£˘‹_t
 
	$bdev_£˘‹s
(
block_devi˚
 *
bdev
)

576  
bdev
->
bd_öode
->
i_size
 >> 9;

577 
	}
}

579 
	#˛osuª_bio_submô
(
bio
, 
˛
, 
dev
) \

581 
	`˛osuª_gë
(
˛
); \

582 
	`bch_gíîic_make_ªque°
(
bio
, &(
dev
)->
bio_•lô_hook
); \

583 } 0)

	)

585 
uöt64_t
 
bch_¸c64_upd©e
(uöt64_t, c⁄° *, 
size_t
);

586 
uöt64_t
 
bch_¸c64
(c⁄° *, 
size_t
);

	@bcache/writeback.c

9 
	~"bˇche.h
"

10 
	~"båì.h
"

11 
	~"debug.h
"

12 
	~"wrôeback.h
"

14 
	~<löux/dñay.h
>

15 
	~<löux/‰ìzî.h
>

16 
	~<löux/kthªad.h
>

17 
	~<åa˚/evíts/bˇche.h
>

21 
	$__upd©e_wrôeback_øã
(
ˇched_dev
 *
dc
)

23 
ˇche_£t
 *
c
 = 
dc
->
disk
.c;

24 
uöt64_t
 
ˇche_£˘‹s
 = 
c
->
nbuckës
 * c->
sb
.
buckë_size
;

25 
uöt64_t
 
ˇche_dúty_èrgë
 =

26 
	`div_u64
(
ˇche_£˘‹s
 * 
dc
->
wrôeback_≥r˚¡
, 100);

28 
öt64_t
 
èrgë
 = 
	`div64_u64
(
ˇche_dúty_èrgë
 * 
	`bdev_£˘‹s
(
dc
->
bdev
),

29 
c
->
ˇched_dev_£˘‹s
);

33 
öt64_t
 
dúty
 = 
	`bˇche_dev_£˘‹s_dúty
(&
dc
->
disk
);

34 
öt64_t
 
dîiv©ive
 = 
dúty
 - 
dc
->
disk
.
£˘‹s_dúty_œ°
;

35 
öt64_t
 
¥›‹ti⁄Æ
 = 
dúty
 - 
èrgë
;

36 
öt64_t
 
ch™ge
;

38 
dc
->
disk
.
£˘‹s_dúty_œ°
 = 
dúty
;

42 
¥›‹ti⁄Æ
 *
dc
->
wrôeback_øã_upd©e_£c⁄ds
;

43 
¥›‹ti⁄Æ
 = 
	`div_s64
’r›‹ti⁄Æ, 
dc
->
wrôeback_øã_p_ãrm_övî£
);

45 
dîiv©ive
 = 
	`div_s64
(dîiv©ive, 
dc
->
wrôeback_øã_upd©e_£c⁄ds
);

47 
dîiv©ive
 = 
	`ewma_add
(
dc
->
disk
.
£˘‹s_dúty_dîiv©ive
, derivative,

48 (
dc
->
wrôeback_øã_d_ãrm
 /

49 
dc
->
wrôeback_øã_upd©e_£c⁄ds
) ?: 1, 0);

51 
dîiv©ive
 *
dc
->
wrôeback_øã_d_ãrm
;

52 
dîiv©ive
 = 
	`div_s64
(dîiv©ive, 
dc
->
wrôeback_øã_p_ãrm_övî£
);

54 
ch™ge
 = 
¥›‹ti⁄Æ
 + 
dîiv©ive
;

57 i‡(
ch™ge
 > 0 &&

58 
	`time_a·î64
(
	`loˇl_˛ock
(),

59 
dc
->
wrôeback_øã
.
√xt
 + 
NSEC_PER_MSEC
))

60 
ch™ge
 = 0;

62 
dc
->
wrôeback_øã
.
øã
 =

63 
	`˛amp_t
(
öt64_t
, (öt64_tË
dc
->
wrôeback_øã
.
øã
 + 
ch™ge
,

64 1, 
NSEC_PER_MSEC
);

66 
dc
->
wrôeback_øã_¥›‹ti⁄Æ
 = 
¥›‹ti⁄Æ
;

67 
dc
->
wrôeback_øã_dîiv©ive
 = 
dîiv©ive
;

68 
dc
->
wrôeback_øã_ch™ge
 = 
ch™ge
;

69 
dc
->
wrôeback_øã_èrgë
 = 
èrgë
;

70 
	}
}

72 
	$upd©e_wrôeback_øã
(
w‹k_°ru˘
 *
w‹k
)

74 
ˇched_dev
 *
dc
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

75 
ˇched_dev
,

76 
wrôeback_øã_upd©e
);

78 
	`down_ªad
(&
dc
->
wrôeback_lock
);

80 i‡(
	`©omic_ªad
(&
dc
->
has_dúty
) &&

81 
dc
->
wrôeback_≥r˚¡
)

82 
	`__upd©e_wrôeback_øã
(
dc
);

84 
	`up_ªad
(&
dc
->
wrôeback_lock
);

86 
	`scheduÀ_dñayed_w‹k
(&
dc
->
wrôeback_øã_upd©e
,

87 
dc
->
wrôeback_øã_upd©e_£c⁄ds
 * 
HZ
);

88 
	}
}

90 
	$wrôeback_dñay
(
ˇched_dev
 *
dc
, 
£˘‹s
)

92 i‡(
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
) ||

93 !
dc
->
wrôeback_≥r˚¡
)

96  
	`bch_√xt_dñay
(&
dc
->
wrôeback_øã
, 
£˘‹s
);

97 
	}
}

99 
	sdúty_io
 {

100 
˛osuª
 
	m˛
;

101 
ˇched_dev
 *
	mdc
;

102 
bio
 
	mbio
;

105 
	$dúty_öô
(
keybuf_key
 *
w
)

107 
dúty_io
 *
io
 = 
w
->
¥iv©e
;

108 
bio
 *biÿ&
io
->bio;

110 
	`bio_öô
(
bio
);

111 i‡(!
io
->
dc
->
wrôeback_≥r˚¡
)

112 
	`bio_£t_¥io
(
bio
, 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_IDLE
, 0));

114 
bio
->
bi_ôî
.
bi_size
 = 
	`KEY_SIZE
(&
w
->
key
) << 9;

115 
bio
->
bi_max_vecs
 = 
	`DIV_ROUND_UP
(
	`KEY_SIZE
(&
w
->
key
), 
PAGE_SECTORS
);

116 
bio
->
bi_¥iv©e
 = 
w
;

117 
bio
->
bi_io_vec
 = bio->
bi_ölöe_vecs
;

118 
	`bch_bio_m≠
(
bio
, 
NULL
);

119 
	}
}

121 
	$dúty_io_de°ru˘‹
(
˛osuª
 *
˛
)

123 
dúty_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, dirty_io, cl);

124 
	`k‰ì
(
io
);

125 
	}
}

127 
	$wrôe_dúty_föish
(
˛osuª
 *
˛
)

129 
dúty_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, dirty_io, cl);

130 
keybuf_key
 *
w
 = 
io
->
bio
.
bi_¥iv©e
;

131 
ˇched_dev
 *
dc
 = 
io
->dc;

132 
bio_vec
 *
bv
;

133 
i
;

135 
	`bio_f‹_óch_£gmít_Æl
(
bv
, &
io
->
bio
, 
i
)

136 
	`__‰ì_∑ge
(
bv
->
bv_∑ge
);

139 i‡(
	`KEY_DIRTY
(&
w
->
key
)) {

140 
ªt
;

141 
i
;

142 
keyli°
 
keys
;

144 
	`bch_keyli°_öô
(&
keys
);

146 
	`bkey_c›y
(
keys
.
t›
, &
w
->
key
);

147 
	`SET_KEY_DIRTY
(
keys
.
t›
, 
Ál£
);

148 
	`bch_keyli°_push
(&
keys
);

150 
i
 = 0; i < 
	`KEY_PTRS
(&
w
->
key
); i++)

151 
	`©omic_öc
(&
	`PTR_BUCKET
(
dc
->
disk
.
c
, &
w
->
key
, 
i
)->
pö
);

153 
ªt
 = 
	`bch_båì_ö£π
(
dc
->
disk
.
c
, &
keys
, 
NULL
, &
w
->
key
);

155 i‡(
ªt
)

156 
	`åa˚_bˇche_wrôeback_cﬁlisi⁄
(&
w
->
key
);

158 
	`©omic_l⁄g_öc
(
ªt


159 ? &
dc
->
disk
.
c
->
wrôeback_keys_Áûed


160 : &
dc
->
disk
.
c
->
wrôeback_keys_d⁄e
);

163 
	`bch_keybuf_dñ
(&
dc
->
wrôeback_keys
, 
w
);

164 
	`up
(&
dc
->
ö_Êight
);

166 
	`˛osuª_ªtu∫_wôh_de°ru˘‹
(
˛
, 
dúty_io_de°ru˘‹
);

167 
	}
}

169 
	$dúty_ídio
(
bio
 *bio, 
îr‹
)

171 
keybuf_key
 *
w
 = 
bio
->
bi_¥iv©e
;

172 
dúty_io
 *
io
 = 
w
->
¥iv©e
;

174 i‡(
îr‹
)

175 
	`SET_KEY_DIRTY
(&
w
->
key
, 
Ál£
);

177 
	`˛osuª_put
(&
io
->
˛
);

178 
	}
}

180 
	$wrôe_dúty
(
˛osuª
 *
˛
)

182 
dúty_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, dirty_io, cl);

183 
keybuf_key
 *
w
 = 
io
->
bio
.
bi_¥iv©e
;

185 
	`dúty_öô
(
w
);

186 
io
->
bio
.
bi_rw
 = 
WRITE
;

187 
io
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
	`KEY_START
(&
w
->
key
);

188 
io
->
bio
.
bi_bdev
 = io->
dc
->
bdev
;

189 
io
->
bio
.
bi_íd_io
 = 
dúty_ídio
;

191 
	`˛osuª_bio_submô
(&
io
->
bio
, 
˛
, &io->
dc
->
disk
);

193 
	`c⁄töue_©
(
˛
, 
wrôe_dúty_föish
, 
sy°em_wq
);

194 
	}
}

196 
	$ªad_dúty_ídio
(
bio
 *bio, 
îr‹
)

198 
keybuf_key
 *
w
 = 
bio
->
bi_¥iv©e
;

199 
dúty_io
 *
io
 = 
w
->
¥iv©e
;

201 
	`bch_cou¡_io_îr‹s
(
	`PTR_CACHE
(
io
->
dc
->
disk
.
c
, &
w
->
key
, 0),

202 
îr‹
, "reading dirty data from cache");

204 
	`dúty_ídio
(
bio
, 
îr‹
);

205 
	}
}

207 
	$ªad_dúty_submô
(
˛osuª
 *
˛
)

209 
dúty_io
 *
io
 = 
	`c⁄èöî_of
(
˛
, dirty_io, cl);

211 
	`˛osuª_bio_submô
(&
io
->
bio
, 
˛
, &io->
dc
->
disk
);

213 
	`c⁄töue_©
(
˛
, 
wrôe_dúty
, 
sy°em_wq
);

214 
	}
}

216 
	$ªad_dúty
(
ˇched_dev
 *
dc
)

218 
dñay
 = 0;

219 
keybuf_key
 *
w
;

220 
dúty_io
 *
io
;

221 
˛osuª
 
˛
;

223 
	`˛osuª_öô_°ack
(&
˛
);

230 !
	`kthªad_should_°›
()) {

231 
	`åy_to_‰ìze
();

233 
w
 = 
	`bch_keybuf_√xt
(&
dc
->
wrôeback_keys
);

234 i‡(!
w
)

237 
	`BUG_ON
(
	`±r_°Æe
(
dc
->
disk
.
c
, &
w
->
key
, 0));

239 i‡(
	`KEY_START
(&
w
->
key
Ë!
dc
->
œ°_ªad
 ||

240 
	`jiffõs_to_m£cs
(
dñay
) > 50)

241 !
	`kthªad_should_°›
(Ë&& 
dñay
)

242 
dñay
 = 
	`scheduÀ_timeout_öãºu±ibÀ
(delay);

244 
dc
->
œ°_ªad
 = 
	`KEY_OFFSET
(&
w
->
key
);

246 
io
 = 
	`kzÆloc
((
dúty_io
Ë+ (
bio_vec
)

247 * 
	`DIV_ROUND_UP
(
	`KEY_SIZE
(&
w
->
key
), 
PAGE_SECTORS
),

248 
GFP_KERNEL
);

249 i‡(!
io
)

250 
îr
;

252 
w
->
¥iv©e
 = 
io
;

253 
io
->
dc
 = dc;

255 
	`dúty_öô
(
w
);

256 
io
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
	`PTR_OFFSET
(&
w
->
key
, 0);

257 
io
->
bio
.
bi_bdev
 = 
	`PTR_CACHE
(
dc
->
disk
.
c
,

258 &
w
->
key
, 0)->
bdev
;

259 
io
->
bio
.
bi_rw
 = 
READ
;

260 
io
->
bio
.
bi_íd_io
 = 
ªad_dúty_ídio
;

262 i‡(
	`bio_Æloc_∑ges
(&
io
->
bio
, 
GFP_KERNEL
))

263 
îr_‰ì
;

265 
	`åa˚_bˇche_wrôeback
(&
w
->
key
);

267 
	`down
(&
dc
->
ö_Êight
);

268 
	`˛osuª_ˇŒ
(&
io
->
˛
, 
ªad_dúty_submô
, 
NULL
, &cl);

270 
dñay
 = 
	`wrôeback_dñay
(
dc
, 
	`KEY_SIZE
(&
w
->
key
));

274 
îr_‰ì
:

275 
	`k‰ì
(
w
->
¥iv©e
);

276 
îr
:

277 
	`bch_keybuf_dñ
(&
dc
->
wrôeback_keys
, 
w
);

284 
	`˛osuª_sync
(&
˛
);

285 
	}
}

289 
	$bˇche_dev_£˘‹s_dúty_add
(
ˇche_£t
 *
c
, 
öode
,

290 
uöt64_t
 
off£t
, 
ƒ_£˘‹s
)

292 
bˇche_devi˚
 *
d
 = 
c
->
devi˚s
[
öode
];

293 
°rùe_off£t
, 
°rùe
, 
£˘‹s_dúty
;

295 i‡(!
d
)

298 
°rùe
 = 
	`off£t_to_°rùe
(
d
, 
off£t
);

299 
°rùe_off£t
 = 
off£t
 & (
d
->
°rùe_size
 - 1);

301 
ƒ_£˘‹s
) {

302 
s
 = 
	`mö_t
(, 
	`abs
(
ƒ_£˘‹s
),

303 
d
->
°rùe_size
 - 
°rùe_off£t
);

305 i‡(
ƒ_£˘‹s
 < 0)

306 
s
 = -s;

308 i‡(
°rùe
 >
d
->
ƒ_°rùes
)

311 
£˘‹s_dúty
 = 
	`©omic_add_ªtu∫
(
s
,

312 
d
->
°rùe_£˘‹s_dúty
 + 
°rùe
);

313 i‡(
£˘‹s_dúty
 =
d
->
°rùe_size
)

314 
	`£t_bô
(
°rùe
, 
d
->
fuŒ_dúty_°rùes
);

316 
	`˛ór_bô
(
°rùe
, 
d
->
fuŒ_dúty_°rùes
);

318 
ƒ_£˘‹s
 -
s
;

319 
°rùe_off£t
 = 0;

320 
°rùe
++;

322 
	}
}

324 
boﬁ
 
	$dúty_¥ed
(
keybuf
 *
buf
, 
bkey
 *
k
)

326  
	`KEY_DIRTY
(
k
);

327 
	}
}

329 
	$ªfûl_fuŒ_°rùes
(
ˇched_dev
 *
dc
)

331 
keybuf
 *
buf
 = &
dc
->
wrôeback_keys
;

332 
°¨t_°rùe
, 
°rùe
, 
√xt_°rùe
;

333 
boﬁ
 
wøµed
 = 
Ál£
;

335 
°rùe
 = 
	`off£t_to_°rùe
(&
dc
->
disk
, 
	`KEY_OFFSET
(&
buf
->
œ°_sˇ¬ed
));

337 i‡(
°rùe
 >
dc
->
disk
.
ƒ_°rùes
)

338 
°rùe
 = 0;

340 
°¨t_°rùe
 = 
°rùe
;

343 
°rùe
 = 
	`föd_√xt_bô
(
dc
->
disk
.
fuŒ_dúty_°rùes
,

344 
dc
->
disk
.
ƒ_°rùes
, 
°rùe
);

346 i‡(
°rùe
 =
dc
->
disk
.
ƒ_°rùes
)

347 
√xt
;

349 
√xt_°rùe
 = 
	`föd_√xt_zîo_bô
(
dc
->
disk
.
fuŒ_dúty_°rùes
,

350 
dc
->
disk
.
ƒ_°rùes
, 
°rùe
);

352 
buf
->
œ°_sˇ¬ed
 = 
	`KEY
(
dc
->
disk
.
id
,

353 
°rùe
 * 
dc
->
disk
.
°rùe_size
, 0);

355 
	`bch_ªfûl_keybuf
(
dc
->
disk
.
c
, 
buf
,

356 &
	`KEY
(
dc
->
disk
.
id
,

357 
√xt_°rùe
 * 
dc
->
disk
.
°rùe_size
, 0),

358 
dúty_¥ed
);

360 i‡(
	`¨øy_‰ìli°_em±y
(&
buf
->
‰ìli°
))

363 
°rùe
 = 
√xt_°rùe
;

364 
√xt
:

365 i‡(
wøµed
 && 
°rùe
 > 
°¨t_°rùe
)

368 i‡(
°rùe
 =
dc
->
disk
.
ƒ_°rùes
) {

369 
°rùe
 = 0;

370 
wøµed
 = 
åue
;

373 
	}
}

375 
boﬁ
 
	$ªfûl_dúty
(
ˇched_dev
 *
dc
)

377 
keybuf
 *
buf
 = &
dc
->
wrôeback_keys
;

378 
bkey
 
íd
 = 
	`KEY
(
dc
->
disk
.
id
, 
MAX_KEY_OFFSET
, 0);

379 
boﬁ
 
£¨ched_‰om_°¨t
 = 
Ál£
;

381 i‡(
dc
->
∑πül_°rùes_ex≥nsive
) {

382 
	`ªfûl_fuŒ_°rùes
(
dc
);

383 i‡(
	`¨øy_‰ìli°_em±y
(&
buf
->
‰ìli°
))

384  
Ál£
;

387 i‡(
	`bkey_cmp
(&
buf
->
œ°_sˇ¬ed
, &
íd
) >= 0) {

388 
buf
->
œ°_sˇ¬ed
 = 
	`KEY
(
dc
->
disk
.
id
, 0, 0);

389 
£¨ched_‰om_°¨t
 = 
åue
;

392 
	`bch_ªfûl_keybuf
(
dc
->
disk
.
c
, 
buf
, &
íd
, 
dúty_¥ed
);

394  
	`bkey_cmp
(&
buf
->
œ°_sˇ¬ed
, &
íd
Ë>0 && 
£¨ched_‰om_°¨t
;

395 
	}
}

397 
	$bch_wrôeback_thªad
(*
¨g
)

399 
ˇched_dev
 *
dc
 = 
¨g
;

400 
boﬁ
 
£¨ched_fuŒ_ödex
;

402 !
	`kthªad_should_°›
()) {

403 
	`down_wrôe
(&
dc
->
wrôeback_lock
);

404 i‡(!
	`©omic_ªad
(&
dc
->
has_dúty
) ||

405 (!
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
) &&

406 !
dc
->
wrôeback_ru¬ög
)) {

407 
	`up_wrôe
(&
dc
->
wrôeback_lock
);

408 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

410 i‡(
	`kthªad_should_°›
())

413 
	`åy_to_‰ìze
();

414 
	`scheduÀ
();

418 
£¨ched_fuŒ_ödex
 = 
	`ªfûl_dúty
(
dc
);

420 i‡(
£¨ched_fuŒ_ödex
 &&

421 
	`RB_EMPTY_ROOT
(&
dc
->
wrôeback_keys
.
keys
)) {

422 
	`©omic_£t
(&
dc
->
has_dúty
, 0);

423 
	`ˇched_dev_put
(
dc
);

424 
	`SET_BDEV_STATE
(&
dc
->
sb
, 
BDEV_STATE_CLEAN
);

425 
	`bch_wrôe_bdev_su≥r
(
dc
, 
NULL
);

428 
	`up_wrôe
(&
dc
->
wrôeback_lock
);

430 
	`bch_øãlimô_ª£t
(&
dc
->
wrôeback_øã
);

431 
	`ªad_dúty
(
dc
);

433 i‡(
£¨ched_fuŒ_ödex
) {

434 
dñay
 = 
dc
->
wrôeback_dñay
 * 
HZ
;

436 
dñay
 &&

437 !
	`kthªad_should_°›
() &&

438 !
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
))

439 
dñay
 = 
	`scheduÀ_timeout_öãºu±ibÀ
(delay);

444 
	}
}

448 
	s£˘‹s_dúty_öô
 {

449 
båì_›
 
	m›
;

450 
	möode
;

453 
	$£˘‹s_dúty_öô_‚
(
båì_›
 *
_›
, 
båì
 *
b
,

454 
bkey
 *
k
)

456 
£˘‹s_dúty_öô
 *
›
 = 
	`c⁄èöî_of
(
_›
,

457 
£˘‹s_dúty_öô
, 
›
);

458 i‡(
	`KEY_INODE
(
k
Ë> 
›
->
öode
)

459  
MAP_DONE
;

461 i‡(
	`KEY_DIRTY
(
k
))

462 
	`bˇche_dev_£˘‹s_dúty_add
(
b
->
c
, 
	`KEY_INODE
(
k
),

463 
	`KEY_START
(
k
), 
	`KEY_SIZE
(k));

465  
MAP_CONTINUE
;

466 
	}
}

468 
	$bch_£˘‹s_dúty_öô
(
ˇched_dev
 *
dc
)

470 
£˘‹s_dúty_öô
 
›
;

472 
	`bch_båì_›_öô
(&
›
.op, -1);

473 
›
.
öode
 = 
dc
->
disk
.
id
;

475 
	`bch_båì_m≠_keys
(&
›
.›, 
dc
->
disk
.
c
, &
	`KEY
(›.
öode
, 0, 0),

476 
£˘‹s_dúty_öô_‚
, 0);

478 
dc
->
disk
.
£˘‹s_dúty_œ°
 = 
	`bˇche_dev_£˘‹s_dúty
(&dc->disk);

479 
	}
}

481 
	$bch_ˇched_dev_wrôeback_öô
(
ˇched_dev
 *
dc
)

483 
	`£ma_öô
(&
dc
->
ö_Êight
, 64);

484 
	`öô_rw£m
(&
dc
->
wrôeback_lock
);

485 
	`bch_keybuf_öô
(&
dc
->
wrôeback_keys
);

487 
dc
->
wrôeback_mëad©a
 = 
åue
;

488 
dc
->
wrôeback_ru¬ög
 = 
åue
;

489 
dc
->
wrôeback_≥r˚¡
 = 10;

490 
dc
->
wrôeback_dñay
 = 30;

491 
dc
->
wrôeback_øã
.
øã
 = 1024;

493 
dc
->
wrôeback_øã_upd©e_£c⁄ds
 = 5;

494 
dc
->
wrôeback_øã_d_ãrm
 = 30;

495 
dc
->
wrôeback_øã_p_ãrm_övî£
 = 6000;

497 
	`INIT_DELAYED_WORK
(&
dc
->
wrôeback_øã_upd©e
, 
upd©e_wrôeback_øã
);

498 
	}
}

500 
	$bch_ˇched_dev_wrôeback_°¨t
(
ˇched_dev
 *
dc
)

502 
dc
->
wrôeback_thªad
 = 
	`kthªad_¸óã
(
bch_wrôeback_thªad
, dc,

504 i‡(
	`IS_ERR
(
dc
->
wrôeback_thªad
))

505  
	`PTR_ERR
(
dc
->
wrôeback_thªad
);

507 
	`scheduÀ_dñayed_w‹k
(&
dc
->
wrôeback_øã_upd©e
,

508 
dc
->
wrôeback_øã_upd©e_£c⁄ds
 * 
HZ
);

510 
	`bch_wrôeback_queue
(
dc
);

513 
	}
}

	@bcache/writeback.h

1 #i‚de‡
_BCACHE_WRITEBACK_H


2 
	#_BCACHE_WRITEBACK_H


	)

4 
	#CUTOFF_WRITEBACK
 40

	)

5 
	#CUTOFF_WRITEBACK_SYNC
 70

	)

7 
ölöe
 
uöt64_t
 
	$bˇche_dev_£˘‹s_dúty
(
bˇche_devi˚
 *
d
)

9 
uöt64_t
 
i
, 
ªt
 = 0;

11 
i
 = 0; i < 
d
->
ƒ_°rùes
; i++)

12 
ªt
 +
	`©omic_ªad
(
d
->
°rùe_£˘‹s_dúty
 + 
i
);

14  
ªt
;

15 
	}
}

17 
ölöe
 
	$off£t_to_°rùe
(
bˇche_devi˚
 *
d
,

18 
uöt64_t
 
off£t
)

20 
	`do_div
(
off£t
, 
d
->
°rùe_size
);

21  
off£t
;

22 
	}
}

24 
ölöe
 
boﬁ
 
	$bˇche_dev_°rùe_dúty
(
ˇched_dev
 *
dc
,

25 
uöt64_t
 
off£t
,

26 
ƒ_£˘‹s
)

28 
°rùe
 = 
	`off£t_to_°rùe
(&
dc
->
disk
, 
off£t
);

31 i‡(
	`©omic_ªad
(
dc
->
disk
.
°rùe_£˘‹s_dúty
 + 
°rùe
))

32  
åue
;

34 i‡(
ƒ_£˘‹s
 <
dc
->
disk
.
°rùe_size
)

35  
Ál£
;

37 
ƒ_£˘‹s
 -
dc
->
disk
.
°rùe_size
;

38 
°rùe
++;

40 
	}
}

42 
ölöe
 
boﬁ
 
	$should_wrôeback
(
ˇched_dev
 *
dc
, 
bio
 *bio,

43 
ˇche_mode
, 
boﬁ
 
would_skù
)

45 
ö_u£
 = 
dc
->
disk
.
c
->
gc_°©s
.in_use;

47 i‡(
ˇche_mode
 !
CACHE_MODE_WRITEBACK
 ||

48 
	`ã°_bô
(
BCACHE_DEV_DETACHING
, &
dc
->
disk
.
Êags
) ||

49 
ö_u£
 > 
CUTOFF_WRITEBACK_SYNC
)

50  
Ál£
;

52 i‡(
dc
->
∑πül_°rùes_ex≥nsive
 &&

53 
	`bˇche_dev_°rùe_dúty
(
dc
, 
bio
->
bi_ôî
.
bi_£˘‹
,

54 
	`bio_£˘‹s
(
bio
)))

55  
åue
;

57 i‡(
would_skù
)

58  
Ál£
;

60  
bio
->
bi_rw
 & 
REQ_SYNC
 ||

61 
ö_u£
 <
CUTOFF_WRITEBACK
;

62 
	}
}

64 
ölöe
 
	$bch_wrôeback_queue
(
ˇched_dev
 *
dc
)

66 
	`wake_up_¥o˚ss
(
dc
->
wrôeback_thªad
);

67 
	}
}

69 
ölöe
 
	$bch_wrôeback_add
(
ˇched_dev
 *
dc
)

71 i‡(!
	`©omic_ªad
(&
dc
->
has_dúty
) &&

72 !
	`©omic_xchg
(&
dc
->
has_dúty
, 1)) {

73 
	`©omic_öc
(&
dc
->
cou¡
);

75 i‡(
	`BDEV_STATE
(&
dc
->
sb
Ë!
BDEV_STATE_DIRTY
) {

76 
	`SET_BDEV_STATE
(&
dc
->
sb
, 
BDEV_STATE_DIRTY
);

78 
	`bch_wrôe_bdev_su≥r
(
dc
, 
NULL
);

81 
	`bch_wrôeback_queue
(
dc
);

83 
	}
}

85 
bˇche_dev_£˘‹s_dúty_add
(
ˇche_£t
 *, , 
uöt64_t
, );

87 
bch_£˘‹s_dúty_öô
(
ˇched_dev
 *
dc
);

88 
bch_ˇched_dev_wrôeback_öô
(
ˇched_dev
 *);

89 
bch_ˇched_dev_wrôeback_°¨t
(
ˇched_dev
 *);

	@bitmap.c

18 
	~<löux/blkdev.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/timî.h
>

24 
	~<löux/sched.h
>

25 
	~<löux/li°.h
>

26 
	~<löux/fûe.h
>

27 
	~<löux/mou¡.h
>

28 
	~<löux/buf„r_hód.h
>

29 
	~<löux/£q_fûe.h
>

30 
	~"md.h
"

31 
	~"bôm≠.h
"

33 
ölöe
 *
	$bm«me
(
bôm≠
 *bitmap)

35  
bôm≠
->
mddev
 ? 
	`md«me
(bitmap->mddev) : "mdX";

36 
	}
}

48 
	$bôm≠_check∑ge
(
bôm≠_cou¡s
 *
bôm≠
,

49 
∑ge
, 
¸óã
)

50 
	`__ªÀa£s
(
bôm≠
->
lock
)

51 
	`__acquúes
(
bôm≠
->
lock
)

53 *
m≠∑ge
;

55 i‡(
∑ge
 >
bôm≠
->
∑ges
) {

60  -
EINVAL
;

63 i‡(
bôm≠
->
bp
[
∑ge
].
hijacked
)

66 i‡(
bôm≠
->
bp
[
∑ge
].
m≠
)

69 i‡(!
¸óã
)

70  -
ENOENT
;

74 
	`•ö_u∆ock_úq
(&
bôm≠
->
lock
);

75 
m≠∑ge
 = 
	`kzÆloc
(
PAGE_SIZE
, 
GFP_NOIO
);

76 
	`•ö_lock_úq
(&
bôm≠
->
lock
);

78 i‡(
m≠∑ge
 =
NULL
) {

79 
	`¥_debug
("md/bitmap: mapÖageállocation failed, hijacking\n");

82 i‡(!
bôm≠
->
bp
[
∑ge
].
m≠
)

83 
bôm≠
->
bp
[
∑ge
].
hijacked
 = 1;

84 } i‡(
bôm≠
->
bp
[
∑ge
].
m≠
 ||

85 
bôm≠
->
bp
[
∑ge
].
hijacked
) {

87 
	`k‰ì
(
m≠∑ge
);

93 
bôm≠
->
bp
[
∑ge
].
m≠
 = 
m≠∑ge
;

94 
bôm≠
->
missög_∑ges
--;

97 
	}
}

102 
	$bôm≠_check‰ì
(
bôm≠_cou¡s
 *
bôm≠
, 
∑ge
)

104 *
±r
;

106 i‡(
bôm≠
->
bp
[
∑ge
].
cou¡
)

111 i‡(
bôm≠
->
bp
[
∑ge
].
hijacked
) {

112 
bôm≠
->
bp
[
∑ge
].
hijacked
 = 0;

113 
bôm≠
->
bp
[
∑ge
].
m≠
 = 
NULL
;

116 
±r
 = 
bôm≠
->
bp
[
∑ge
].
m≠
;

117 
bôm≠
->
bp
[
∑ge
].
m≠
 = 
NULL
;

118 
bôm≠
->
missög_∑ges
++;

119 
	`k‰ì
(
±r
);

121 
	}
}

132 
	$ªad_sb_∑ge
(
mddev
 *mddev, 
loff_t
 
off£t
,

133 
∑ge
 *page,

134 
ödex
, 
size
)

138 
md_rdev
 *
rdev
;

139 
£˘‹_t
 
èrgë
;

141 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

142 i‡(! 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

143 || 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

146 
èrgë
 = 
off£t
 + 
ödex
 * (
PAGE_SIZE
/512);

148 i‡(
	`sync_∑ge_io
(
rdev
, 
èrgë
,

149 
	`roundup
(
size
, 
	`bdev_logiˇl_block_size
(
rdev
->
bdev
)),

150 
∑ge
, 
READ
, 
åue
)) {

151 
∑ge
->
ödex
 = index;

155  -
EIO
;

156 
	}
}

158 
md_rdev
 *
	$√xt_a˘ive_rdev
(
md_rdev
 *
rdev
, 
mddev
 *mddev)

168 
	`rcu_ªad_lock
();

169 i‡(
rdev
 =
NULL
)

171 
rdev
 = 
	`li°_íåy_rcu
(&
mddev
->
disks
, 
md_rdev
, 
ßme_£t
);

174 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

176 
	`li°_f‹_óch_íåy_c⁄töue_rcu
(
rdev
, &
mddev
->
disks
, 
ßme_£t
) {

177 i‡(
rdev
->
øid_disk
 >= 0 &&

178 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

180 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

181 
	`rcu_ªad_u∆ock
();

182  
rdev
;

185 
	`rcu_ªad_u∆ock
();

186  
NULL
;

187 
	}
}

189 
	$wrôe_sb_∑ge
(
bôm≠
 *bôm≠, 
∑ge
 *∑ge, 
waô
)

191 
md_rdev
 *
rdev
 = 
NULL
;

192 
block_devi˚
 *
bdev
;

193 
mddev
 *mddev = 
bôm≠
->mddev;

194 
bôm≠_°‹age
 *
°‹e
 = &
bôm≠
->
°‹age
;

196 (
rdev
 = 
	`√xt_a˘ive_rdev
‘dev, 
mddev
)Ë!
NULL
) {

197 
size
 = 
PAGE_SIZE
;

198 
loff_t
 
off£t
 = 
mddev
->
bôm≠_öfo
.offset;

200 
bdev
 = (
rdev
->
mëa_bdev
) ?Ñdev->meta_bdev :Ñdev->bdev;

202 i‡(
∑ge
->
ödex
 =
°‹e
->
fûe_∑ges
-1) {

203 
œ°_∑ge_size
 = 
°‹e
->
byãs
 & (
PAGE_SIZE
-1);

204 i‡(
œ°_∑ge_size
 == 0)

205 
œ°_∑ge_size
 = 
PAGE_SIZE
;

206 
size
 = 
	`roundup
(
œ°_∑ge_size
,

207 
	`bdev_logiˇl_block_size
(
bdev
));

212 i‡(
mddev
->
exã∫Æ
) {

214 i‡(
rdev
->
sb_°¨t
 + 
off£t
 + (
∑ge
->
ödex


215 * (
PAGE_SIZE
/512))

216 > 
rdev
->
d©a_off£t


218 
rdev
->
sb_°¨t
 + 
off£t


219 < (
rdev
->
d©a_off£t
 + 
mddev
->
dev_£˘‹s


220 + (
PAGE_SIZE
/512)))

221 
bad_Æignmít
;

222 } i‡(
off£t
 < 0) {

224 i‡(
off£t


225 + ()(
∑ge
->
ödex
 * (
PAGE_SIZE
/512))

226 + 
size
/512 > 0)

228 
bad_Æignmít
;

229 i‡(
rdev
->
d©a_off£t
 + 
mddev
->
dev_£˘‹s


230 > 
rdev
->
sb_°¨t
 + 
off£t
)

232 
bad_Æignmít
;

233 } i‡(
rdev
->
sb_°¨t
 <Ñdev->
d©a_off£t
) {

235 i‡(
rdev
->
sb_°¨t


236 + 
off£t


237 + 
∑ge
->
ödex
*(
PAGE_SIZE
/512Ë+ 
size
/512

238 > 
rdev
->
d©a_off£t
)

240 
bad_Æignmít
;

244 
	`md_su≥r_wrôe
(
mddev
, 
rdev
,

245 
rdev
->
sb_°¨t
 + 
off£t


246 + 
∑ge
->
ödex
 * (
PAGE_SIZE
/512),

247 
size
,

248 
∑ge
);

251 i‡(
waô
)

252 
	`md_su≥r_waô
(
mddev
);

255 
bad_Æignmít
:

256  -
EINVAL
;

257 
	}
}

259 
bôm≠_fûe_kick
(
bôm≠
 *bitmap);

263 
	$wrôe_∑ge
(
bôm≠
 *bôm≠, 
∑ge
 *∑ge, 
waô
)

265 
buf„r_hód
 *
bh
;

267 i‡(
bôm≠
->
°‹age
.
fûe
 =
NULL
) {

268 
	`wrôe_sb_∑ge
(
bôm≠
, 
∑ge
, 
waô
)) {

269 -
EINVAL
:

270 
	`£t_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
);

274 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

276 
bh
 && bh->
b_blockƒ
) {

277 
	`©omic_öc
(&
bôm≠
->
≥ndög_wrôes
);

278 
	`£t_buf„r_locked
(
bh
);

279 
	`£t_buf„r_m≠≥d
(
bh
);

280 
	`submô_bh
(
WRITE
 | 
REQ_SYNC
, 
bh
);

281 
bh
 = bh->
b_this_∑ge
;

284 i‡(
waô
)

285 
	`waô_evít
(
bôm≠
->
wrôe_waô
,

286 
	`©omic_ªad
(&
bôm≠
->
≥ndög_wrôes
)==0);

288 i‡(
	`ã°_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
))

289 
	`bôm≠_fûe_kick
(
bôm≠
);

290 
	}
}

292 
	$íd_bôm≠_wrôe
(
buf„r_hód
 *
bh
, 
u±od©e
)

294 
bôm≠
 *bôm≠ = 
bh
->
b_¥iv©e
;

296 i‡(!
u±od©e
)

297 
	`£t_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
);

298 i‡(
	`©omic_dec_™d_ã°
(&
bôm≠
->
≥ndög_wrôes
))

299 
	`wake_up
(&
bôm≠
->
wrôe_waô
);

300 
	}
}

304 
	$__˛ór_∑ge_buf„rs
(
∑ge
 *page)

306 
	`CÀ¨PagePriv©e
(
∑ge
);

307 
	`£t_∑ge_¥iv©e
(
∑ge
, 0);

308 
	`∑ge_ˇche_ªÀa£
(
∑ge
);

309 
	}
}

310 
	$‰ì_buf„rs
(
∑ge
 *page)

312 
buf„r_hód
 *
bh
;

314 i‡(!
	`PagePriv©e
(
∑ge
))

317 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

318 
bh
) {

319 
buf„r_hód
 *
√xt
 = 
bh
->
b_this_∑ge
;

320 
	`‰ì_buf„r_hód
(
bh
);

321 
bh
 = 
√xt
;

323 
	`__˛ór_∑ge_buf„rs
(
∑ge
);

324 
	`put_∑ge
(
∑ge
);

325 
	}
}

334 
	$ªad_∑ge
(
fûe
 *fûe, 
ödex
,

335 
bôm≠
 *bitmap,

336 
cou¡
,

337 
∑ge
 *page)

339 
ªt
 = 0;

340 
öode
 *öodê
	`fûe_öode
(
fûe
);

341 
buf„r_hód
 *
bh
;

342 
£˘‹_t
 
block
;

344 
	`¥_debug
("ªad bôm≠ fûê(%dB @ %Œu)\n", ()
PAGE_SIZE
,

345 ()
ödex
 << 
PAGE_SHIFT
);

347 
bh
 = 
	`Æloc_∑ge_buf„rs
(
∑ge
, 1<<
öode
->
i_blkbôs
, 0);

348 i‡(!
bh
) {

349 
ªt
 = -
ENOMEM
;

350 
out
;

352 
	`©èch_∑ge_buf„rs
(
∑ge
, 
bh
);

353 
block
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

354 
bh
) {

355 i‡(
cou¡
 == 0)

356 
bh
->
b_blockƒ
 = 0;

358 
bh
->
b_blockƒ
 = 
	`bm≠
(
öode
, 
block
);

359 i‡(
bh
->
b_blockƒ
 == 0) {

361 
ªt
 = -
EINVAL
;

362 
out
;

364 
bh
->
b_bdev
 = 
öode
->
i_sb
->
s_bdev
;

365 i‡(
cou¡
 < (1<<
öode
->
i_blkbôs
))

366 
cou¡
 = 0;

368 
cou¡
 -(1<<
öode
->
i_blkbôs
);

370 
bh
->
b_íd_io
 = 
íd_bôm≠_wrôe
;

371 
bh
->
b_¥iv©e
 = 
bôm≠
;

372 
	`©omic_öc
(&
bôm≠
->
≥ndög_wrôes
);

373 
	`£t_buf„r_locked
(
bh
);

374 
	`£t_buf„r_m≠≥d
(
bh
);

375 
	`submô_bh
(
READ
, 
bh
);

377 
block
++;

378 
bh
 = bh->
b_this_∑ge
;

380 
∑ge
->
ödex
 = index;

382 
	`waô_evít
(
bôm≠
->
wrôe_waô
,

383 
	`©omic_ªad
(&
bôm≠
->
≥ndög_wrôes
)==0);

384 i‡(
	`ã°_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
))

385 
ªt
 = -
EIO
;

386 
out
:

387 i‡(
ªt
)

388 
	`¥ötk
(
KERN_ALERT
 "md: bitmapÑeadÉrror: (%dB @ %llu): %d\n",

389 ()
PAGE_SIZE
,

390 ()
ödex
 << 
PAGE_SHIFT
,

391 
ªt
);

392  
ªt
;

393 
	}
}

400 
	$bôm≠_upd©e_sb
(
bôm≠
 *bitmap)

402 
bôm≠_su≥r_t
 *
sb
;

404 i‡(!
bôm≠
 || !bôm≠->
mddev
)

406 i‡(
bôm≠
->
mddev
->
bôm≠_öfo
.
exã∫Æ
)

408 i‡(!
bôm≠
->
°‹age
.
sb_∑ge
)

410 
sb
 = 
	`km≠_©omic
(
bôm≠
->
°‹age
.
sb_∑ge
);

411 
sb
->
evíts
 = 
	`˝u_to_À64
(
bôm≠
->
mddev
->events);

412 i‡(
bôm≠
->
mddev
->
evíts
 < bôm≠->
evíts_˛óªd
)

414 
bôm≠
->
evíts_˛óªd
 = bôm≠->
mddev
->
evíts
;

415 
sb
->
evíts_˛óªd
 = 
	`˝u_to_À64
(
bôm≠
->events_cleared);

416 
sb
->
°©e
 = 
	`˝u_to_À32
(
bôm≠
->
Êags
);

418 
sb
->
d´m⁄_¶ìp
 = 
	`˝u_to_À32
(
bôm≠
->
mddev
->
bôm≠_öfo
.d´m⁄_¶ìp/
HZ
);

419 
sb
->
wrôe_behöd
 = 
	`˝u_to_À32
(
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
);

421 
sb
->
sync_size
 = 
	`˝u_to_À64
(
bôm≠
->
mddev
->
ªsync_max_£˘‹s
);

422 
sb
->
chunksize
 = 
	`˝u_to_À32
(
bôm≠
->
mddev
->
bôm≠_öfo
.chunksize);

423 
sb
->
£˘‹s_ª£rved
 = 
	`˝u_to_À32
(
bôm≠
->
mddev
->

424 
bôm≠_öfo
.
•a˚
);

425 
	`kunm≠_©omic
(
sb
);

426 
	`wrôe_∑ge
(
bôm≠
, bôm≠->
°‹age
.
sb_∑ge
, 1);

427 
	}
}

430 
	$bôm≠_¥öt_sb
(
bôm≠
 *bitmap)

432 
bôm≠_su≥r_t
 *
sb
;

434 i‡(!
bôm≠
 || !bôm≠->
°‹age
.
sb_∑ge
)

436 
sb
 = 
	`km≠_©omic
(
bôm≠
->
°‹age
.
sb_∑ge
);

437 
	`¥ötk
(
KERN_DEBUG
 "%s: bôm≠ fûêsu≥rblock:\n", 
	`bm«me
(
bôm≠
));

438 
	`¥ötk
(
KERN_DEBUG
 " magic: %08x\n", 
	`À32_to_˝u
(
sb
->
magic
));

439 
	`¥ötk
(
KERN_DEBUG
 " vîsi⁄: %d\n", 
	`À32_to_˝u
(
sb
->
vîsi⁄
));

440 
	`¥ötk
(
KERN_DEBUG
 " uuid: %08x.%08x.%08x.%08x\n",

441 *(
__u32
 *)(
sb
->
uuid
+0),

442 *(
__u32
 *)(
sb
->
uuid
+4),

443 *(
__u32
 *)(
sb
->
uuid
+8),

444 *(
__u32
 *)(
sb
->
uuid
+12));

445 
	`¥ötk
(
KERN_DEBUG
 "Évents: %llu\n",

446 (Ë
	`À64_to_˝u
(
sb
->
evíts
));

447 
	`¥ötk
(
KERN_DEBUG
 "events cleared: %llu\n",

448 (Ë
	`À64_to_˝u
(
sb
->
evíts_˛óªd
));

449 
	`¥ötk
(
KERN_DEBUG
 " sèã: %08x\n", 
	`À32_to_˝u
(
sb
->
°©e
));

450 
	`¥ötk
(
KERN_DEBUG
 " chunksize: %d B\n", 
	`À32_to_˝u
(
sb
->
chunksize
));

451 
	`¥ötk
(
KERN_DEBUG
 " d´m⁄ sÀï: %ds\n", 
	`À32_to_˝u
(
sb
->
d´m⁄_¶ìp
));

452 
	`¥ötk
(
KERN_DEBUG
 " sync size: %llu KB\n",

453 ()
	`À64_to_˝u
(
sb
->
sync_size
)/2);

454 
	`¥ötk
(
KERN_DEBUG
 "max wrôêbehöd: %d\n", 
	`À32_to_˝u
(
sb
->
wrôe_behöd
));

455 
	`kunm≠_©omic
(
sb
);

456 
	}
}

469 
	$bôm≠_√w_disk_sb
(
bôm≠
 *bitmap)

471 
bôm≠_su≥r_t
 *
sb
;

472 
chunksize
, 
d´m⁄_¶ìp
, 
wrôe_behöd
;

474 
bôm≠
->
°‹age
.
sb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

475 i‡(
bôm≠
->
°‹age
.
sb_∑ge
 =
NULL
)

476  -
ENOMEM
;

477 
bôm≠
->
°‹age
.
sb_∑ge
->
ödex
 = 0;

479 
sb
 = 
	`km≠_©omic
(
bôm≠
->
°‹age
.
sb_∑ge
);

481 
sb
->
magic
 = 
	`˝u_to_À32
(
BITMAP_MAGIC
);

482 
sb
->
vîsi⁄
 = 
	`˝u_to_À32
(
BITMAP_MAJOR_HI
);

484 
chunksize
 = 
bôm≠
->
mddev
->
bôm≠_öfo
.chunksize;

485 
	`BUG_ON
(!
chunksize
);

486 i‡(!
	`is_powî_of_2
(
chunksize
)) {

487 
	`kunm≠_©omic
(
sb
);

488 
	`¥ötk
(
KERN_ERR
 "bitmap chunksizeÇotáÖower of 2\n");

489  -
EINVAL
;

491 
sb
->
chunksize
 = 
	`˝u_to_À32
(chunksize);

493 
d´m⁄_¶ìp
 = 
bôm≠
->
mddev
->
bôm≠_öfo
.daemon_sleep;

494 i‡(!
d´m⁄_¶ìp
 ||

495 (
d´m⁄_¶ìp
 < 1Ë|| (d´m⁄_¶ì∞> 
MAX_SCHEDULE_TIMEOUT
)) {

496 
	`¥ötk
(
KERN_INFO
 "Choosing daemon_sleep default (5 sec)\n");

497 
d´m⁄_¶ìp
 = 5 * 
HZ
;

499 
sb
->
d´m⁄_¶ìp
 = 
	`˝u_to_À32
(daemon_sleep);

500 
bôm≠
->
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 = daemon_sleep;

506 
wrôe_behöd
 = 
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
;

507 i‡(
wrôe_behöd
 > 
COUNTER_MAX
)

508 
wrôe_behöd
 = 
COUNTER_MAX
 / 2;

509 
sb
->
wrôe_behöd
 = 
	`˝u_to_À32
(write_behind);

510 
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
 = 
wrôe_behöd
;

513 
sb
->
sync_size
 = 
	`˝u_to_À64
(
bôm≠
->
mddev
->
ªsync_max_£˘‹s
);

515 
	`mem˝y
(
sb
->
uuid
, 
bôm≠
->
mddev
->uuid, 16);

517 
	`£t_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

518 
sb
->
°©e
 = 
	`˝u_to_À32
(
bôm≠
->
Êags
);

519 
bôm≠
->
evíts_˛óªd
 = bôm≠->
mddev
->
evíts
;

520 
sb
->
evíts_˛óªd
 = 
	`˝u_to_À64
(
bôm≠
->
mddev
->
evíts
);

522 
	`kunm≠_©omic
(
sb
);

525 
	}
}

528 
	$bôm≠_ªad_sb
(
bôm≠
 *bitmap)

530 *
ªas⁄
 = 
NULL
;

531 
bôm≠_su≥r_t
 *
sb
;

532 
chunksize
, 
d´m⁄_¶ìp
, 
wrôe_behöd
;

533 
evíts
;

534 
£˘‹s_ª£rved
 = 0;

535 
îr
 = -
EINVAL
;

536 
∑ge
 *
sb_∑ge
;

538 i‡(!
bôm≠
->
°‹age
.
fûe
 && !bôm≠->
mddev
->
bôm≠_öfo
.
off£t
) {

539 
chunksize
 = 128 * 1024 * 1024;

540 
d´m⁄_¶ìp
 = 5 * 
HZ
;

541 
wrôe_behöd
 = 0;

542 
	`£t_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

543 
îr
 = 0;

544 
out_no_sb
;

547 
sb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

548 i‡(!
sb_∑ge
)

549  -
ENOMEM
;

550 
bôm≠
->
°‹age
.
sb_∑ge
 = sb_page;

552 i‡(
bôm≠
->
°‹age
.
fûe
) {

553 
loff_t
 
isize
 = 
	`i_size_ªad
(
bôm≠
->
°‹age
.
fûe
->
f_m≠pög
->
ho°
);

554 
byãs
 = 
isize
 > 
PAGE_SIZE
 ? PAGE_SIZE : isize;

556 
îr
 = 
	`ªad_∑ge
(
bôm≠
->
°‹age
.
fûe
, 0,

557 
bôm≠
, 
byãs
, 
sb_∑ge
);

559 
îr
 = 
	`ªad_sb_∑ge
(
bôm≠
->
mddev
,

560 
bôm≠
->
mddev
->
bôm≠_öfo
.
off£t
,

561 
sb_∑ge
,

562 0, (
bôm≠_su≥r_t
));

564 i‡(
îr
)

565  
îr
;

567 
sb
 = 
	`km≠_©omic
(
sb_∑ge
);

569 
chunksize
 = 
	`À32_to_˝u
(
sb
->chunksize);

570 
d´m⁄_¶ìp
 = 
	`À32_to_˝u
(
sb
->d´m⁄_¶ìpË* 
HZ
;

571 
wrôe_behöd
 = 
	`À32_to_˝u
(
sb
->write_behind);

572 
£˘‹s_ª£rved
 = 
	`À32_to_˝u
(
sb
->sectors_reserved);

575 i‡(
sb
->
magic
 !
	`˝u_to_À32
(
BITMAP_MAGIC
))

576 
ªas⁄
 = "bad magic";

577 i‡(
	`À32_to_˝u
(
sb
->
vîsi⁄
Ë< 
BITMAP_MAJOR_LO
 ||

578 
	`À32_to_˝u
(
sb
->
vîsi⁄
Ë> 
BITMAP_MAJOR_HI
)

579 
ªas⁄
 = "unrecognized superblock version";

580 i‡(
chunksize
 < 512)

581 
ªas⁄
 = "bitmap chunksizeÅoo small";

582 i‡(!
	`is_powî_of_2
(
chunksize
))

583 
ªas⁄
 = "bitmap chunksizeÇotáÖower of 2";

584 i‡(
d´m⁄_¶ìp
 < 1 || d´m⁄_¶ì∞> 
MAX_SCHEDULE_TIMEOUT
)

585 
ªas⁄
 = "daemon sleepÖeriod out ofÑange";

586 i‡(
wrôe_behöd
 > 
COUNTER_MAX
)

587 
ªas⁄
 = "write-behindÜimit out ofÑange (0 - 16383)";

588 i‡(
ªas⁄
) {

589 
	`¥ötk
(
KERN_INFO
 "%s: invalid bitmap file superblock: %s\n",

590 
	`bm«me
(
bôm≠
), 
ªas⁄
);

591 
out
;

595 
sb
->
sync_size
 = 
	`˝u_to_À64
(
bôm≠
->
mddev
->
ªsync_max_£˘‹s
);

597 i‡(
bôm≠
->
mddev
->
≥rsi°ít
) {

602 i‡(
	`memcmp
(
sb
->
uuid
, 
bôm≠
->
mddev
->uuid, 16)) {

603 
	`¥ötk
(
KERN_INFO


605 
	`bm«me
(
bôm≠
));

606 
out
;

608 
evíts
 = 
	`À64_to_˝u
(
sb
->events);

609 i‡(
evíts
 < 
bôm≠
->
mddev
->events) {

610 
	`¥ötk
(
KERN_INFO


613 
	`bm«me
(
bôm≠
), 
evíts
,

614 (Ë
bôm≠
->
mddev
->
evíts
);

615 
	`£t_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

620 
bôm≠
->
Êags
 |
	`À32_to_˝u
(
sb
->
°©e
);

621 i‡(
	`À32_to_˝u
(
sb
->
vîsi⁄
Ë=
BITMAP_MAJOR_HOSTENDIAN
)

622 
	`£t_bô
(
BITMAP_HOSTENDIAN
, &
bôm≠
->
Êags
);

623 
bôm≠
->
evíts_˛óªd
 = 
	`À64_to_˝u
(
sb
->events_cleared);

624 
îr
 = 0;

625 
out
:

626 
	`kunm≠_©omic
(
sb
);

627 
out_no_sb
:

628 i‡(
	`ã°_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
))

629 
bôm≠
->
evíts_˛óªd
 = bôm≠->
mddev
->
evíts
;

630 
bôm≠
->
mddev
->
bôm≠_öfo
.
chunksize
 = chunksize;

631 
bôm≠
->
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 = daemon_sleep;

632 
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
 = 
wrôe_behöd
;

633 i‡(
bôm≠
->
mddev
->
bôm≠_öfo
.
•a˚
 == 0 ||

634 
bôm≠
->
mddev
->
bôm≠_öfo
.
•a˚
 > 
£˘‹s_ª£rved
)

635 
bôm≠
->
mddev
->
bôm≠_öfo
.
•a˚
 = 
£˘‹s_ª£rved
;

636 i‡(
îr
)

637 
	`bôm≠_¥öt_sb
(
bôm≠
);

638  
îr
;

639 
	}
}

652 
ölöe
 
	$fûe_∑ge_ödex
(
bôm≠_°‹age
 *
°‹e
,

653 
chunk
)

655 i‡(
°‹e
->
sb_∑ge
)

656 
chunk
 +(
bôm≠_su≥r_t
) << 3;

657  
chunk
 >> 
PAGE_BIT_SHIFT
;

658 
	}
}

661 
ölöe
 
	$fûe_∑ge_off£t
(
bôm≠_°‹age
 *
°‹e
,

662 
chunk
)

664 i‡(
°‹e
->
sb_∑ge
)

665 
chunk
 +(
bôm≠_su≥r_t
) << 3;

666  
chunk
 & (
PAGE_BITS
 - 1);

667 
	}
}

673 
ölöe
 
∑ge
 *
	$fûem≠_gë_∑ge
(
bôm≠_°‹age
 *
°‹e
,

674 
chunk
)

676 i‡(
	`fûe_∑ge_ödex
(
°‹e
, 
chunk
Ë>°‹e->
fûe_∑ges
)

677  
NULL
;

678  
°‹e
->
fûem≠
[
	`fûe_∑ge_ödex
(°‹e, 
chunk
)];

679 
	}
}

681 
	$bôm≠_°‹age_Æloc
(
bôm≠_°‹age
 *
°‹e
,

682 
chunks
, 
wôh_su≥r
)

684 
≤um
;

685 
num_∑ges
;

686 
byãs
;

688 
byãs
 = 
	`DIV_ROUND_UP
(
chunks
, 8);

689 i‡(
wôh_su≥r
)

690 
byãs
 +(
bôm≠_su≥r_t
);

692 
num_∑ges
 = 
	`DIV_ROUND_UP
(
byãs
, 
PAGE_SIZE
);

694 
°‹e
->
fûem≠
 = 
	`kmÆloc
((
∑ge
 *)

695 * 
num_∑ges
, 
GFP_KERNEL
);

696 i‡(!
°‹e
->
fûem≠
)

697  -
ENOMEM
;

699 i‡(
wôh_su≥r
 && !
°‹e
->
sb_∑ge
) {

700 
°‹e
->
sb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
|
__GFP_ZERO
);

701 i‡(
°‹e
->
sb_∑ge
 =
NULL
)

702  -
ENOMEM
;

703 
°‹e
->
sb_∑ge
->
ödex
 = 0;

705 
≤um
 = 0;

706 i‡(
°‹e
->
sb_∑ge
) {

707 
°‹e
->
fûem≠
[0] = st‹e->
sb_∑ge
;

708 
≤um
 = 1;

710  ; 
≤um
 < 
num_∑ges
;Önum++) {

711 
°‹e
->
fûem≠
[
≤um
] = 
	`Æloc_∑ge
(
GFP_KERNEL
|
__GFP_ZERO
);

712 i‡(!
°‹e
->
fûem≠
[
≤um
]) {

713 
°‹e
->
fûe_∑ges
 = 
≤um
;

714  -
ENOMEM
;

716 
°‹e
->
fûem≠
[
≤um
]->
ödex
 =Önum;

718 
°‹e
->
fûe_∑ges
 = 
≤um
;

722 
°‹e
->
fûem≠_©å
 = 
	`kzÆloc
(

723 
	`roundup
(
	`DIV_ROUND_UP
(
num_∑ges
*4, 8), ()),

724 
GFP_KERNEL
);

725 i‡(!
°‹e
->
fûem≠_©å
)

726  -
ENOMEM
;

728 
°‹e
->
byãs
 = bytes;

731 
	}
}

733 
	$bôm≠_fûe_unm≠
(
bôm≠_°‹age
 *
°‹e
)

735 
∑ge
 **
m≠
, *
sb_∑ge
;

736 
∑ges
;

737 
fûe
 *file;

739 
fûe
 = 
°‹e
->file;

740 
m≠
 = 
°‹e
->
fûem≠
;

741 
∑ges
 = 
°‹e
->
fûe_∑ges
;

742 
sb_∑ge
 = 
°‹e
->sb_page;

744 
∑ges
--)

745 i‡(
m≠
[
∑ges
] !
sb_∑ge
)

746 
	`‰ì_buf„rs
(
m≠
[
∑ges
]);

747 
	`k‰ì
(
m≠
);

748 
	`k‰ì
(
°‹e
->
fûem≠_©å
);

750 i‡(
sb_∑ge
)

751 
	`‰ì_buf„rs
(
sb_∑ge
);

753 i‡(
fûe
) {

754 
öode
 *öodê
	`fûe_öode
(
fûe
);

755 
	`övÆid©e_m≠pög_∑ges
(
öode
->
i_m≠pög
, 0, -1);

756 
	`Âut
(
fûe
);

758 
	}
}

765 
	$bôm≠_fûe_kick
(
bôm≠
 *bitmap)

767 *
∑th
, *
±r
 = 
NULL
;

769 i‡(!
	`ã°_™d_£t_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
)) {

770 
	`bôm≠_upd©e_sb
(
bôm≠
);

772 i‡(
bôm≠
->
°‹age
.
fûe
) {

773 
∑th
 = 
	`kmÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

774 i‡(
∑th
)

775 
±r
 = 
	`d_∑th
(&
bôm≠
->
°‹age
.
fûe
->
f_∑th
,

776 
∑th
, 
PAGE_SIZE
);

778 
	`¥ötk
(
KERN_ALERT


780 
	`bm«me
(
bôm≠
), 
	`IS_ERR
(
±r
) ? "" :Ötr);

782 
	`k‰ì
(
∑th
);

784 
	`¥ötk
(
KERN_ALERT


786 
	`bm«me
(
bôm≠
));

788 
	}
}

790 
	ebôm≠_∑ge_©å
 {

791 
	mBITMAP_PAGE_DIRTY
 = 0,

792 
	mBITMAP_PAGE_PENDING
 = 1,

794 
	mBITMAP_PAGE_NEEDWRITE
 = 2,

797 
ölöe
 
	$£t_∑ge_©å
(
bôm≠
 *bôm≠, 
≤um
,

798 
bôm≠_∑ge_©å
 
©å
)

800 
	`£t_bô
((
≤um
<<2Ë+ 
©å
, 
bôm≠
->
°‹age
.
fûem≠_©å
);

801 
	}
}

803 
ölöe
 
	$˛ór_∑ge_©å
(
bôm≠
 *bôm≠, 
≤um
,

804 
bôm≠_∑ge_©å
 
©å
)

806 
	`˛ór_bô
((
≤um
<<2Ë+ 
©å
, 
bôm≠
->
°‹age
.
fûem≠_©å
);

807 
	}
}

809 
ölöe
 
	$ã°_∑ge_©å
(
bôm≠
 *bôm≠, 
≤um
,

810 
bôm≠_∑ge_©å
 
©å
)

812  
	`ã°_bô
((
≤um
<<2Ë+ 
©å
, 
bôm≠
->
°‹age
.
fûem≠_©å
);

813 
	}
}

815 
ölöe
 
	$ã°_™d_˛ór_∑ge_©å
(
bôm≠
 *bôm≠, 
≤um
,

816 
bôm≠_∑ge_©å
 
©å
)

818  
	`ã°_™d_˛ór_bô
((
≤um
<<2Ë+ 
©å
,

819 
bôm≠
->
°‹age
.
fûem≠_©å
);

820 
	}
}

828 
	$bôm≠_fûe_£t_bô
(
bôm≠
 *bôm≠, 
£˘‹_t
 
block
)

830 
bô
;

831 
∑ge
 *page;

832 *
kaddr
;

833 
chunk
 = 
block
 >> 
bôm≠
->
cou¡s
.
chunkshi·
;

835 
∑ge
 = 
	`fûem≠_gë_∑ge
(&
bôm≠
->
°‹age
, 
chunk
);

836 i‡(!
∑ge
)

838 
bô
 = 
	`fûe_∑ge_off£t
(&
bôm≠
->
°‹age
, 
chunk
);

841 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

842 i‡(
	`ã°_bô
(
BITMAP_HOSTENDIAN
, &
bôm≠
->
Êags
))

843 
	`£t_bô
(
bô
, 
kaddr
);

845 
	`£t_bô_À
(
bô
, 
kaddr
);

846 
	`kunm≠_©omic
(
kaddr
);

847 
	`¥_debug
("£àfûêbô %luÖagê%lu\n", 
bô
, 
∑ge
->
ödex
);

849 
	`£t_∑ge_©å
(
bôm≠
, 
∑ge
->
ödex
, 
BITMAP_PAGE_DIRTY
);

850 
	}
}

852 
	$bôm≠_fûe_˛ór_bô
(
bôm≠
 *bôm≠, 
£˘‹_t
 
block
)

854 
bô
;

855 
∑ge
 *page;

856 *
∑ddr
;

857 
chunk
 = 
block
 >> 
bôm≠
->
cou¡s
.
chunkshi·
;

859 
∑ge
 = 
	`fûem≠_gë_∑ge
(&
bôm≠
->
°‹age
, 
chunk
);

860 i‡(!
∑ge
)

862 
bô
 = 
	`fûe_∑ge_off£t
(&
bôm≠
->
°‹age
, 
chunk
);

863 
∑ddr
 = 
	`km≠_©omic
(
∑ge
);

864 i‡(
	`ã°_bô
(
BITMAP_HOSTENDIAN
, &
bôm≠
->
Êags
))

865 
	`˛ór_bô
(
bô
, 
∑ddr
);

867 
	`˛ór_bô_À
(
bô
, 
∑ddr
);

868 
	`kunm≠_©omic
(
∑ddr
);

869 i‡(!
	`ã°_∑ge_©å
(
bôm≠
, 
∑ge
->
ödex
, 
BITMAP_PAGE_NEEDWRITE
)) {

870 
	`£t_∑ge_©å
(
bôm≠
, 
∑ge
->
ödex
, 
BITMAP_PAGE_PENDING
);

871 
bôm≠
->
Æl˛ón
 = 0;

873 
	}
}

878 
	$bôm≠_u≈lug
(
bôm≠
 *bitmap)

880 
i
;

881 
dúty
, 
√ed_wrôe
;

882 
waô
 = 0;

884 i‡(!
bôm≠
 || !bôm≠->
°‹age
.
fûem≠
 ||

885 
	`ã°_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
))

890 
i
 = 0; i < 
bôm≠
->
°‹age
.
fûe_∑ges
; i++) {

891 i‡(!
bôm≠
->
°‹age
.
fûem≠
)

893 
dúty
 = 
	`ã°_™d_˛ór_∑ge_©å
(
bôm≠
, 
i
, 
BITMAP_PAGE_DIRTY
);

894 
√ed_wrôe
 = 
	`ã°_™d_˛ór_∑ge_©å
(
bôm≠
, 
i
,

895 
BITMAP_PAGE_NEEDWRITE
);

896 i‡(
dúty
 || 
√ed_wrôe
) {

897 
	`˛ór_∑ge_©å
(
bôm≠
, 
i
, 
BITMAP_PAGE_PENDING
);

898 
	`wrôe_∑ge
(
bôm≠
, bôm≠->
°‹age
.
fûem≠
[
i
], 0);

900 i‡(
dúty
)

901 
waô
 = 1;

903 i‡(
waô
) {

904 i‡(
bôm≠
->
°‹age
.
fûe
)

905 
	`waô_evít
(
bôm≠
->
wrôe_waô
,

906 
	`©omic_ªad
(&
bôm≠
->
≥ndög_wrôes
)==0);

908 
	`md_su≥r_waô
(
bôm≠
->
mddev
);

910 i‡(
	`ã°_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
))

911 
	`bôm≠_fûe_kick
(
bôm≠
);

912 
	}
}

913 
EXPORT_SYMBOL
(
bôm≠_u≈lug
);

915 
bôm≠_£t_mem‹y_bôs
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, 
√eded
);

927 
	$bôm≠_öô_‰om_disk
(
bôm≠
 *bôm≠, 
£˘‹_t
 
°¨t
)

929 
i
, 
chunks
, 
ödex
, 
ﬁdödex
, 
bô
;

930 
∑ge
 *∑gê
NULL
;

931 
bô_˙t
 = 0;

932 
fûe
 *file;

933 
off£t
;

934 
outofd©e
;

935 
ªt
 = -
ENOSPC
;

936 *
∑ddr
;

937 
bôm≠_°‹age
 *
°‹e
 = &
bôm≠
->
°‹age
;

939 
chunks
 = 
bôm≠
->
cou¡s
.chunks;

940 
fûe
 = 
°‹e
->file;

942 i‡(!
fûe
 && !
bôm≠
->
mddev
->
bôm≠_öfo
.
off£t
) {

944 
°‹e
->
fûem≠
 = 
NULL
;

945 
°‹e
->
fûe_∑ges
 = 0;

946 
i
 = 0; i < 
chunks
 ; i++) {

948 
√eded
 = ((
£˘‹_t
)(
i
+1Ë<< (
bôm≠
->
cou¡s
.
chunkshi·
)

949 >
°¨t
);

950 
	`bôm≠_£t_mem‹y_bôs
(
bôm≠
,

951 (
£˘‹_t
)
i
 << 
bôm≠
->
cou¡s
.
chunkshi·
,

952 
√eded
);

957 
outofd©e
 = 
	`ã°_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

958 i‡(
outofd©e
)

959 
	`¥ötk
(
KERN_INFO
 "%s: bitmap file is out of date, doing full "

960 "ªcovîy\n", 
	`bm«me
(
bôm≠
));

962 i‡(
fûe
 && 
	`i_size_ªad
(fûe->
f_m≠pög
->
ho°
Ë< 
°‹e
->
byãs
) {

963 
	`¥ötk
(
KERN_INFO
 "%s: bitmap fileÅoo short %lu < %lu\n",

964 
	`bm«me
(
bôm≠
),

965 (Ë
	`i_size_ªad
(
fûe
->
f_m≠pög
->
ho°
),

966 
°‹e
->
byãs
);

967 
îr
;

970 
ﬁdödex
 = ~0L;

971 
off£t
 = 0;

972 i‡(!
bôm≠
->
mddev
->
bôm≠_öfo
.
exã∫Æ
)

973 
off£t
 = (
bôm≠_su≥r_t
);

975 
i
 = 0; i < 
chunks
; i++) {

976 
b
;

977 
ödex
 = 
	`fûe_∑ge_ödex
(&
bôm≠
->
°‹age
, 
i
);

978 
bô
 = 
	`fûe_∑ge_off£t
(&
bôm≠
->
°‹age
, 
i
);

979 i‡(
ödex
 !
ﬁdödex
) {

980 
cou¡
;

982 i‡(
ödex
 =
°‹e
->
fûe_∑ges
-1)

983 
cou¡
 = 
°‹e
->
byãs
 - 
ödex
 * 
PAGE_SIZE
;

985 
cou¡
 = 
PAGE_SIZE
;

986 
∑ge
 = 
°‹e
->
fûem≠
[
ödex
];

987 i‡(
fûe
)

988 
ªt
 = 
	`ªad_∑ge
(
fûe
, 
ödex
, 
bôm≠
,

989 
cou¡
, 
∑ge
);

991 
ªt
 = 
	`ªad_sb_∑ge
(

992 
bôm≠
->
mddev
,

993 
bôm≠
->
mddev
->
bôm≠_öfo
.
off£t
,

994 
∑ge
,

995 
ödex
, 
cou¡
);

997 i‡(
ªt
)

998 
îr
;

1000 
ﬁdödex
 = 
ödex
;

1002 i‡(
outofd©e
) {

1007 
∑ddr
 = 
	`km≠_©omic
(
∑ge
);

1008 
	`mem£t
(
∑ddr
 + 
off£t
, 0xff,

1009 
PAGE_SIZE
 - 
off£t
);

1010 
	`kunm≠_©omic
(
∑ddr
);

1011 
	`wrôe_∑ge
(
bôm≠
, 
∑ge
, 1);

1013 
ªt
 = -
EIO
;

1014 i‡(
	`ã°_bô
(
BITMAP_WRITE_ERROR
,

1015 &
bôm≠
->
Êags
))

1016 
îr
;

1019 
∑ddr
 = 
	`km≠_©omic
(
∑ge
);

1020 i‡(
	`ã°_bô
(
BITMAP_HOSTENDIAN
, &
bôm≠
->
Êags
))

1021 
b
 = 
	`ã°_bô
(
bô
, 
∑ddr
);

1023 
b
 = 
	`ã°_bô_À
(
bô
, 
∑ddr
);

1024 
	`kunm≠_©omic
(
∑ddr
);

1025 i‡(
b
) {

1027 
√eded
 = ((
£˘‹_t
)(
i
+1Ë<< 
bôm≠
->
cou¡s
.
chunkshi·


1028 >
°¨t
);

1029 
	`bôm≠_£t_mem‹y_bôs
(
bôm≠
,

1030 (
£˘‹_t
)
i
 << 
bôm≠
->
cou¡s
.
chunkshi·
,

1031 
√eded
);

1032 
bô_˙t
++;

1034 
off£t
 = 0;

1037 
	`¥ötk
(
KERN_INFO
 "%s: bitmap initialized from disk: "

1039 
	`bm«me
(
bôm≠
), 
°‹e
->
fûe_∑ges
,

1040 
bô_˙t
, 
chunks
);

1044 
îr
:

1045 
	`¥ötk
(
KERN_INFO
 "%s: bitmap initialisation failed: %d\n",

1046 
	`bm«me
(
bôm≠
), 
ªt
);

1047  
ªt
;

1048 
	}
}

1050 
	$bôm≠_wrôe_Æl
(
bôm≠
 *bitmap)

1055 
i
;

1057 i‡(!
bôm≠
 || !bôm≠->
°‹age
.
fûem≠
)

1059 i‡(
bôm≠
->
°‹age
.
fûe
)

1063 
i
 = 0; i < 
bôm≠
->
°‹age
.
fûe_∑ges
; i++)

1064 
	`£t_∑ge_©å
(
bôm≠
, 
i
,

1065 
BITMAP_PAGE_NEEDWRITE
);

1066 
bôm≠
->
Æl˛ón
 = 0;

1067 
	}
}

1069 
	$bôm≠_cou¡_∑ge
(
bôm≠_cou¡s
 *
bôm≠
,

1070 
£˘‹_t
 
off£t
, 
öc
)

1072 
£˘‹_t
 
chunk
 = 
off£t
 >> 
bôm≠
->
chunkshi·
;

1073 
∑ge
 = 
chunk
 >> 
PAGE_COUNTER_SHIFT
;

1074 
bôm≠
->
bp
[
∑ge
].
cou¡
 +
öc
;

1075 
	`bôm≠_check‰ì
(
bôm≠
, 
∑ge
);

1076 
	}
}

1078 
	$bôm≠_£t_≥ndög
(
bôm≠_cou¡s
 *
bôm≠
, 
£˘‹_t
 
off£t
)

1080 
£˘‹_t
 
chunk
 = 
off£t
 >> 
bôm≠
->
chunkshi·
;

1081 
∑ge
 = 
chunk
 >> 
PAGE_COUNTER_SHIFT
;

1082 
bôm≠_∑ge
 *
bp
 = &
bôm≠
->bp[
∑ge
];

1084 i‡(!
bp
->
≥ndög
)

1085 
bp
->
≥ndög
 = 1;

1086 
	}
}

1088 
bôm≠_cou¡î_t
 *
bôm≠_gë_cou¡î
(
bôm≠_cou¡s
 *
bôm≠
,

1089 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
,

1090 
¸óã
);

1097 
	$bôm≠_d´m⁄_w‹k
(
mddev
 *mddev)

1099 
bôm≠
 *bitmap;

1100 
j
;

1101 
√xçage
;

1102 
£˘‹_t
 
blocks
;

1103 
bôm≠_cou¡s
 *
cou¡s
;

1108 
	`muãx_lock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1109 
bôm≠
 = 
mddev
->bitmap;

1110 i‡(
bôm≠
 =
NULL
) {

1111 
	`muãx_u∆ock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1114 i‡(
	`time_bef‹e
(
jiffõs
, 
bôm≠
->
d´m⁄_œ°run


1115 + 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
))

1116 
d⁄e
;

1118 
bôm≠
->
d´m⁄_œ°run
 = 
jiffõs
;

1119 i‡(
bôm≠
->
Æl˛ón
) {

1120 
mddev
->
thªad
->
timeout
 = 
MAX_SCHEDULE_TIMEOUT
;

1121 
d⁄e
;

1123 
bôm≠
->
Æl˛ón
 = 1;

1129 
j
 = 0; j < 
bôm≠
->
°‹age
.
fûe_∑ges
; j++)

1130 i‡(
	`ã°_™d_˛ór_∑ge_©å
(
bôm≠
, 
j
,

1131 
BITMAP_PAGE_PENDING
))

1132 
	`£t_∑ge_©å
(
bôm≠
, 
j
,

1133 
BITMAP_PAGE_NEEDWRITE
);

1135 i‡(
bôm≠
->
√ed_sync
 &&

1136 
mddev
->
bôm≠_öfo
.
exã∫Æ
 == 0) {

1139 
bôm≠_su≥r_t
 *
sb
;

1140 
bôm≠
->
√ed_sync
 = 0;

1141 i‡(
bôm≠
->
°‹age
.
fûem≠
) {

1142 
sb
 = 
	`km≠_©omic
(
bôm≠
->
°‹age
.
sb_∑ge
);

1143 
sb
->
evíts_˛óªd
 =

1144 
	`˝u_to_À64
(
bôm≠
->
evíts_˛óªd
);

1145 
	`kunm≠_©omic
(
sb
);

1146 
	`£t_∑ge_©å
(
bôm≠
, 0,

1147 
BITMAP_PAGE_NEEDWRITE
);

1153 
cou¡s
 = &
bôm≠
->counts;

1154 
	`•ö_lock_úq
(&
cou¡s
->
lock
);

1155 
√xçage
 = 0;

1156 
j
 = 0; j < 
cou¡s
->
chunks
; j++) {

1157 
bôm≠_cou¡î_t
 *
bmc
;

1158 
£˘‹_t
 
block
 = (£˘‹_t)
j
 << 
cou¡s
->
chunkshi·
;

1160 i‡(
j
 =
√xçage
) {

1161 
√xçage
 +
PAGE_COUNTER_RATIO
;

1162 i‡(!
cou¡s
->
bp
[
j
 >> 
PAGE_COUNTER_SHIFT
].
≥ndög
) {

1163 
j
 |
PAGE_COUNTER_MASK
;

1166 
cou¡s
->
bp
[
j
 >> 
PAGE_COUNTER_SHIFT
].
≥ndög
 = 0;

1168 
bmc
 = 
	`bôm≠_gë_cou¡î
(
cou¡s
,

1169 
block
,

1170 &
blocks
, 0);

1172 i‡(!
bmc
) {

1173 
j
 |
PAGE_COUNTER_MASK
;

1176 i‡(*
bmc
 =1 && !
bôm≠
->
√ed_sync
) {

1178 *
bmc
 = 0;

1179 
	`bôm≠_cou¡_∑ge
(
cou¡s
, 
block
, -1);

1180 
	`bôm≠_fûe_˛ór_bô
(
bôm≠
, 
block
);

1181 } i‡(*
bmc
 && *bmc <= 2) {

1182 *
bmc
 = 1;

1183 
	`bôm≠_£t_≥ndög
(
cou¡s
, 
block
);

1184 
bôm≠
->
Æl˛ón
 = 0;

1187 
	`•ö_u∆ock_úq
(&
cou¡s
->
lock
);

1197 
j
 = 0;

1198 
j
 < 
bôm≠
->
°‹age
.
fûe_∑ges


1199 && !
	`ã°_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

1200 
j
++) {

1202 i‡(
	`ã°_∑ge_©å
(
bôm≠
, 
j
,

1203 
BITMAP_PAGE_DIRTY
))

1206 i‡(
	`ã°_™d_˛ór_∑ge_©å
(
bôm≠
, 
j
,

1207 
BITMAP_PAGE_NEEDWRITE
)) {

1208 
	`wrôe_∑ge
(
bôm≠
, bôm≠->
°‹age
.
fûem≠
[
j
], 0);

1212 
d⁄e
:

1213 i‡(
bôm≠
->
Æl˛ón
 == 0)

1214 
mddev
->
thªad
->
timeout
 =

1215 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
;

1216 
	`muãx_u∆ock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1217 
	}
}

1219 
bôm≠_cou¡î_t
 *
	$bôm≠_gë_cou¡î
(
bôm≠_cou¡s
 *
bôm≠
,

1220 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
,

1221 
¸óã
)

1222 
	`__ªÀa£s
(
bôm≠
->
lock
)

1223 
	`__acquúes
(
bôm≠
->
lock
)

1229 
£˘‹_t
 
chunk
 = 
off£t
 >> 
bôm≠
->
chunkshi·
;

1230 
∑ge
 = 
chunk
 >> 
PAGE_COUNTER_SHIFT
;

1231 
∑geoff
 = (
chunk
 & 
PAGE_COUNTER_MASK
Ë<< 
COUNTER_BYTE_SHIFT
;

1232 
£˘‹_t
 
csize
;

1233 
îr
;

1235 
îr
 = 
	`bôm≠_check∑ge
(
bôm≠
, 
∑ge
, 
¸óã
);

1237 i‡(
bôm≠
->
bp
[
∑ge
].
hijacked
 ||

1238 
bôm≠
->
bp
[
∑ge
].
m≠
 =
NULL
)

1239 
csize
 = ((
£˘‹_t
)1Ë<< (
bôm≠
->
chunkshi·
 +

1240 
PAGE_COUNTER_SHIFT
 - 1);

1242 
csize
 = ((
£˘‹_t
)1Ë<< 
bôm≠
->
chunkshi·
;

1243 *
blocks
 = 
csize
 - (
off£t
 & (csize - 1));

1245 i‡(
îr
 < 0)

1246  
NULL
;

1250 i‡(
bôm≠
->
bp
[
∑ge
].
hijacked
) {

1253 
hi
 = (
∑geoff
 > 
PAGE_COUNTER_MASK
);

1254  &((
bôm≠_cou¡î_t
 *)

1255 &
bôm≠
->
bp
[
∑ge
].
m≠
)[
hi
];

1257  (
bôm≠_cou¡î_t
 *)

1258 &(
bôm≠
->
bp
[
∑ge
].
m≠
[
∑geoff
]);

1259 
	}
}

1261 
	$bôm≠_°¨twrôe
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, 
£˘‹s
, 
behöd
)

1263 i‡(!
bôm≠
)

1266 i‡(
behöd
) {

1267 
bw
;

1268 
	`©omic_öc
(&
bôm≠
->
behöd_wrôes
);

1269 
bw
 = 
	`©omic_ªad
(&
bôm≠
->
behöd_wrôes
);

1270 i‡(
bw
 > 
bôm≠
->
behöd_wrôes_u£d
)

1271 
bôm≠
->
behöd_wrôes_u£d
 = 
bw
;

1273 
	`¥_debug
("inc write-behind count %d/%lu\n",

1274 
bw
, 
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
);

1277 
£˘‹s
) {

1278 
£˘‹_t
 
blocks
;

1279 
bôm≠_cou¡î_t
 *
bmc
;

1281 
	`•ö_lock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1282 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
off£t
, &
blocks
, 1);

1283 i‡(!
bmc
) {

1284 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1288 i‡(
	`u∆ikñy
(
	`COUNTER
(*
bmc
Ë=
COUNTER_MAX
)) {

1289 
	`DEFINE_WAIT
(
__waô
);

1294 
	`¥ï¨e_to_waô
(&
bôm≠
->
ovîÊow_waô
, &
__waô
,

1295 
TASK_UNINTERRUPTIBLE
);

1296 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1297 
	`scheduÀ
();

1298 
	`föish_waô
(&
bôm≠
->
ovîÊow_waô
, &
__waô
);

1302 *
bmc
) {

1304 
	`bôm≠_fûe_£t_bô
(
bôm≠
, 
off£t
);

1305 
	`bôm≠_cou¡_∑ge
(&
bôm≠
->
cou¡s
, 
off£t
, 1);

1308 *
bmc
 = 2;

1311 (*
bmc
)++;

1313 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1315 
off£t
 +
blocks
;

1316 i‡(
£˘‹s
 > 
blocks
)

1317 
£˘‹s
 -
blocks
;

1319 
£˘‹s
 = 0;

1322 
	}
}

1323 
EXPORT_SYMBOL
(
bôm≠_°¨twrôe
);

1325 
	$bôm≠_ídwrôe
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, 
£˘‹s
,

1326 
suc˚ss
, 
behöd
)

1328 i‡(!
bôm≠
)

1330 i‡(
behöd
) {

1331 i‡(
	`©omic_dec_™d_ã°
(&
bôm≠
->
behöd_wrôes
))

1332 
	`wake_up
(&
bôm≠
->
behöd_waô
);

1333 
	`¥_debug
("dec write-behind count %d/%lu\n",

1334 
	`©omic_ªad
(&
bôm≠
->
behöd_wrôes
),

1335 
bôm≠
->
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
);

1338 
£˘‹s
) {

1339 
£˘‹_t
 
blocks
;

1340 
Êags
;

1341 
bôm≠_cou¡î_t
 *
bmc
;

1343 
	`•ö_lock_úqßve
(&
bôm≠
->
cou¡s
.
lock
, 
Êags
);

1344 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
off£t
, &
blocks
, 0);

1345 i‡(!
bmc
) {

1346 
	`•ö_u∆ock_úqª°‹e
(&
bôm≠
->
cou¡s
.
lock
, 
Êags
);

1350 i‡(
suc˚ss
 && !
bôm≠
->
mddev
->
degøded
 &&

1351 
bôm≠
->
evíts_˛óªd
 < bôm≠->
mddev
->
evíts
) {

1352 
bôm≠
->
evíts_˛óªd
 = bôm≠->
mddev
->
evíts
;

1353 
bôm≠
->
√ed_sync
 = 1;

1354 
	`sysfs_nŸify_dúít_ß„
(
bôm≠
->
sysfs_ˇn_˛ór
);

1357 i‡(!
suc˚ss
 && !
	`NEEDED
(*
bmc
))

1358 *
bmc
 |
NEEDED_MASK
;

1360 i‡(
	`COUNTER
(*
bmc
Ë=
COUNTER_MAX
)

1361 
	`wake_up
(&
bôm≠
->
ovîÊow_waô
);

1363 (*
bmc
)--;

1364 i‡(*
bmc
 <= 2) {

1365 
	`bôm≠_£t_≥ndög
(&
bôm≠
->
cou¡s
, 
off£t
);

1366 
bôm≠
->
Æl˛ón
 = 0;

1368 
	`•ö_u∆ock_úqª°‹e
(&
bôm≠
->
cou¡s
.
lock
, 
Êags
);

1369 
off£t
 +
blocks
;

1370 i‡(
£˘‹s
 > 
blocks
)

1371 
£˘‹s
 -
blocks
;

1373 
£˘‹s
 = 0;

1375 
	}
}

1376 
EXPORT_SYMBOL
(
bôm≠_ídwrôe
);

1378 
	$__bôm≠_°¨t_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
,

1379 
degøded
)

1381 
bôm≠_cou¡î_t
 *
bmc
;

1382 
rv
;

1383 i‡(
bôm≠
 =
NULL
) {

1384 *
blocks
 = 1024;

1387 
	`•ö_lock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1388 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
off£t
, 
blocks
, 0);

1389 
rv
 = 0;

1390 i‡(
bmc
) {

1392 i‡(
	`RESYNC
(*
bmc
))

1393 
rv
 = 1;

1394 i‡(
	`NEEDED
(*
bmc
)) {

1395 
rv
 = 1;

1396 i‡(!
degøded
) {

1397 *
bmc
 |
RESYNC_MASK
;

1398 *
bmc
 &~
NEEDED_MASK
;

1402 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1403  
rv
;

1404 
	}
}

1406 
	$bôm≠_°¨t_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
,

1407 
degøded
)

1416 
rv
 = 0;

1417 
£˘‹_t
 
blocks1
;

1419 *
blocks
 = 0;

1420 *
blocks
 < (
PAGE_SIZE
>>9)) {

1421 
rv
 |
	`__bôm≠_°¨t_sync
(
bôm≠
, 
off£t
,

1422 &
blocks1
, 
degøded
);

1423 
off£t
 +
blocks1
;

1424 *
blocks
 +
blocks1
;

1426  
rv
;

1427 
	}
}

1428 
EXPORT_SYMBOL
(
bôm≠_°¨t_sync
);

1430 
	$bôm≠_íd_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
, 
ab‹ãd
)

1432 
bôm≠_cou¡î_t
 *
bmc
;

1433 
Êags
;

1435 i‡(
bôm≠
 =
NULL
) {

1436 *
blocks
 = 1024;

1439 
	`•ö_lock_úqßve
(&
bôm≠
->
cou¡s
.
lock
, 
Êags
);

1440 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
off£t
, 
blocks
, 0);

1441 i‡(
bmc
 =
NULL
)

1442 
u∆ock
;

1444 i‡(
	`RESYNC
(*
bmc
)) {

1445 *
bmc
 &~
RESYNC_MASK
;

1447 i‡(!
	`NEEDED
(*
bmc
Ë&& 
ab‹ãd
)

1448 *
bmc
 |
NEEDED_MASK
;

1450 i‡(*
bmc
 <= 2) {

1451 
	`bôm≠_£t_≥ndög
(&
bôm≠
->
cou¡s
, 
off£t
);

1452 
bôm≠
->
Æl˛ón
 = 0;

1456 
u∆ock
:

1457 
	`•ö_u∆ock_úqª°‹e
(&
bôm≠
->
cou¡s
.
lock
, 
Êags
);

1458 
	}
}

1459 
EXPORT_SYMBOL
(
bôm≠_íd_sync
);

1461 
	$bôm≠_˛o£_sync
(
bôm≠
 *bitmap)

1467 
£˘‹_t
 
£˘‹
 = 0;

1468 
£˘‹_t
 
blocks
;

1469 i‡(!
bôm≠
)

1471 
£˘‹
 < 
bôm≠
->
mddev
->
ªsync_max_£˘‹s
) {

1472 
	`bôm≠_íd_sync
(
bôm≠
, 
£˘‹
, &
blocks
, 0);

1473 
£˘‹
 +
blocks
;

1475 
	}
}

1476 
EXPORT_SYMBOL
(
bôm≠_˛o£_sync
);

1478 
	$bôm≠_c⁄d_íd_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
£˘‹
)

1480 
£˘‹_t
 
s
 = 0;

1481 
£˘‹_t
 
blocks
;

1483 i‡(!
bôm≠
)

1485 i‡(
£˘‹
 == 0) {

1486 
bôm≠
->
œ°_íd_sync
 = 
jiffõs
;

1489 i‡(
	`time_bef‹e
(
jiffõs
, (
bôm≠
->
œ°_íd_sync


1490 + 
bôm≠
->
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
)))

1492 
	`waô_evít
(
bôm≠
->
mddev
->
ªcovîy_waô
,

1493 
	`©omic_ªad
(&
bôm≠
->
mddev
->
ªcovîy_a˘ive
) == 0);

1495 
bôm≠
->
mddev
->
cuº_ªsync_com∂ëed
 = 
£˘‹
;

1496 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
bôm≠
->
mddev
->
Êags
);

1497 
£˘‹
 &~((1ULL << 
bôm≠
->
cou¡s
.
chunkshi·
) - 1);

1498 
s
 = 0;

1499 
s
 < 
£˘‹
 && s < 
bôm≠
->
mddev
->
ªsync_max_£˘‹s
) {

1500 
	`bôm≠_íd_sync
(
bôm≠
, 
s
, &
blocks
, 0);

1501 
s
 +
blocks
;

1503 
bôm≠
->
œ°_íd_sync
 = 
jiffõs
;

1504 
	`sysfs_nŸify
(&
bôm≠
->
mddev
->
kobj
, 
NULL
, "sync_completed");

1505 
	}
}

1506 
EXPORT_SYMBOL
(
bôm≠_c⁄d_íd_sync
);

1508 
	$bôm≠_£t_mem‹y_bôs
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, 
√eded
)

1515 
£˘‹_t
 
£cs
;

1516 
bôm≠_cou¡î_t
 *
bmc
;

1517 
	`•ö_lock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1518 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
off£t
, &
£cs
, 1);

1519 i‡(!
bmc
) {

1520 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1523 i‡(!*
bmc
) {

1524 *
bmc
 = 2 | (
√eded
 ? 
NEEDED_MASK
 : 0);

1525 
	`bôm≠_cou¡_∑ge
(&
bôm≠
->
cou¡s
, 
off£t
, 1);

1526 
	`bôm≠_£t_≥ndög
(&
bôm≠
->
cou¡s
, 
off£t
);

1527 
bôm≠
->
Æl˛ón
 = 0;

1529 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1530 
	}
}

1533 
	$bôm≠_dúty_bôs
(
bôm≠
 *bôm≠, 
s
, 
e
)

1535 
chunk
;

1537 
chunk
 = 
s
; chunk <
e
; chunk++) {

1538 
£˘‹_t
 
£c
 = (£˘‹_t)
chunk
 << 
bôm≠
->
cou¡s
.
chunkshi·
;

1539 
	`bôm≠_£t_mem‹y_bôs
(
bôm≠
, 
£c
, 1);

1540 
	`bôm≠_fûe_£t_bô
(
bôm≠
, 
£c
);

1541 i‡(
£c
 < 
bôm≠
->
mddev
->
ªcovîy_˝
)

1546 
bôm≠
->
mddev
->
ªcovîy_˝
 = 
£c
;

1548 
	}
}

1553 
	$bôm≠_Êush
(
mddev
 *mddev)

1555 
bôm≠
 *bôm≠ = 
mddev
->bitmap;

1556 
¶ìp
;

1558 i‡(!
bôm≠
)

1564 
¶ìp
 = 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 * 2;

1565 
bôm≠
->
d´m⁄_œ°run
 -
¶ìp
;

1566 
	`bôm≠_d´m⁄_w‹k
(
mddev
);

1567 
bôm≠
->
d´m⁄_œ°run
 -
¶ìp
;

1568 
	`bôm≠_d´m⁄_w‹k
(
mddev
);

1569 
bôm≠
->
d´m⁄_œ°run
 -
¶ìp
;

1570 
	`bôm≠_d´m⁄_w‹k
(
mddev
);

1571 
	`bôm≠_upd©e_sb
(
bôm≠
);

1572 
	}
}

1577 
	$bôm≠_‰ì
(
bôm≠
 *bitmap)

1579 
k
, 
∑ges
;

1580 
bôm≠_∑ge
 *
bp
;

1582 i‡(!
bôm≠
)

1586 
	`waô_evít
(
bôm≠
->
wrôe_waô
,

1587 
	`©omic_ªad
(&
bôm≠
->
≥ndög_wrôes
) == 0);

1590 
	`bôm≠_fûe_unm≠
(&
bôm≠
->
°‹age
);

1592 
bp
 = 
bôm≠
->
cou¡s
.bp;

1593 
∑ges
 = 
bôm≠
->
cou¡s
.pages;

1597 i‡(
bp
)

1598 
k
 = 0; k < 
∑ges
; k++)

1599 i‡(
bp
[
k
].
m≠
 && !bp[k].
hijacked
)

1600 
	`k‰ì
(
bp
[
k
].
m≠
);

1601 
	`k‰ì
(
bp
);

1602 
	`k‰ì
(
bôm≠
);

1603 
	}
}

1605 
	$bôm≠_de°roy
(
mddev
 *mddev)

1607 
bôm≠
 *bôm≠ = 
mddev
->bitmap;

1609 i‡(!
bôm≠
)

1612 
	`muãx_lock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1613 
mddev
->
bôm≠
 = 
NULL
;

1614 
	`muãx_u∆ock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1615 i‡(
mddev
->
thªad
)

1616 
mddev
->
thªad
->
timeout
 = 
MAX_SCHEDULE_TIMEOUT
;

1618 i‡(
bôm≠
->
sysfs_ˇn_˛ór
)

1619 
	`sysfs_put
(
bôm≠
->
sysfs_ˇn_˛ór
);

1621 
	`bôm≠_‰ì
(
bôm≠
);

1622 
	}
}

1628 
	$bôm≠_¸óã
(
mddev
 *mddev)

1630 
bôm≠
 *bitmap;

1631 
£˘‹_t
 
blocks
 = 
mddev
->
ªsync_max_£˘‹s
;

1632 
fûe
 *fûê
mddev
->
bôm≠_öfo
.file;

1633 
îr
;

1634 
kînfs_node
 *
bm
 = 
NULL
;

1636 
	`BUILD_BUG_ON
((
bôm≠_su≥r_t
) != 256);

1638 
	`BUG_ON
(
fûe
 && 
mddev
->
bôm≠_öfo
.
off£t
);

1640 
bôm≠
 = 
	`kzÆloc
((*bôm≠), 
GFP_KERNEL
);

1641 i‡(!
bôm≠
)

1642  -
ENOMEM
;

1644 
	`•ö_lock_öô
(&
bôm≠
->
cou¡s
.
lock
);

1645 
	`©omic_£t
(&
bôm≠
->
≥ndög_wrôes
, 0);

1646 
	`öô_waôqueue_hód
(&
bôm≠
->
wrôe_waô
);

1647 
	`öô_waôqueue_hód
(&
bôm≠
->
ovîÊow_waô
);

1648 
	`öô_waôqueue_hód
(&
bôm≠
->
behöd_waô
);

1650 
bôm≠
->
mddev
 = mddev;

1652 i‡(
mddev
->
kobj
.
sd
)

1653 
bm
 = 
	`sysfs_gë_dúít
(
mddev
->
kobj
.
sd
, "bitmap");

1654 i‡(
bm
) {

1655 
bôm≠
->
sysfs_ˇn_˛ór
 = 
	`sysfs_gë_dúít
(
bm
, "can_clear");

1656 
	`sysfs_put
(
bm
);

1658 
bôm≠
->
sysfs_ˇn_˛ór
 = 
NULL
;

1660 
bôm≠
->
°‹age
.
fûe
 = file;

1661 i‡(
fûe
) {

1662 
	`gë_fûe
(
fûe
);

1667 
	`vfs_fsync
(
fûe
, 1);

1670 i‡(!
mddev
->
bôm≠_öfo
.
exã∫Æ
) {

1675 i‡(
	`ã°_™d_˛ór_bô
(
MD_ARRAY_FIRST_USE
, &
mddev
->
Êags
))

1676 
îr
 = 
	`bôm≠_√w_disk_sb
(
bôm≠
);

1678 
îr
 = 
	`bôm≠_ªad_sb
(
bôm≠
);

1680 
îr
 = 0;

1681 i‡(
mddev
->
bôm≠_öfo
.
chunksize
 == 0 ||

1682 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 == 0)

1685 
îr
 = -
EINVAL
;

1687 i‡(
îr
)

1688 
îr‹
;

1690 
bôm≠
->
d´m⁄_œ°run
 = 
jiffõs
;

1691 
îr
 = 
	`bôm≠_ªsize
(
bôm≠
, 
blocks
, 
mddev
->
bôm≠_öfo
.
chunksize
, 1);

1692 i‡(
îr
)

1693 
îr‹
;

1695 
	`¥ötk
(
KERN_INFO
 "created bitmap (%luÖages) for device %s\n",

1696 
bôm≠
->
cou¡s
.
∑ges
, 
	`bm«me
(bitmap));

1698 
mddev
->
bôm≠
 = bitmap;

1699  
	`ã°_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
Ë? -
EIO
 : 0;

1701 
îr‹
:

1702 
	`bôm≠_‰ì
(
bôm≠
);

1703  
îr
;

1704 
	}
}

1706 
	$bôm≠_lﬂd
(
mddev
 *mddev)

1708 
îr
 = 0;

1709 
£˘‹_t
 
°¨t
 = 0;

1710 
£˘‹_t
 
£˘‹
 = 0;

1711 
bôm≠
 *bôm≠ = 
mddev
->bitmap;

1713 i‡(!
bôm≠
)

1714 
out
;

1721 
£˘‹
 < 
mddev
->
ªsync_max_£˘‹s
) {

1722 
£˘‹_t
 
blocks
;

1723 
	`bôm≠_°¨t_sync
(
bôm≠
, 
£˘‹
, &
blocks
, 0);

1724 
£˘‹
 +
blocks
;

1726 
	`bôm≠_˛o£_sync
(
bôm≠
);

1728 i‡(
mddev
->
degøded
 == 0

1729 || 
bôm≠
->
evíts_˛óªd
 =
mddev
->
evíts
)

1732 
°¨t
 = 
mddev
->
ªcovîy_˝
;

1734 
	`muãx_lock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1735 
îr
 = 
	`bôm≠_öô_‰om_disk
(
bôm≠
, 
°¨t
);

1736 
	`muãx_u∆ock
(&
mddev
->
bôm≠_öfo
.
muãx
);

1738 i‡(
îr
)

1739 
out
;

1740 
	`˛ór_bô
(
BITMAP_STALE
, &
bôm≠
->
Êags
);

1743 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
bôm≠
->
mddev
->
ªcovîy
);

1745 
mddev
->
thªad
->
timeout
 = mddev->
bôm≠_öfo
.
d´m⁄_¶ìp
;

1746 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1748 
	`bôm≠_upd©e_sb
(
bôm≠
);

1750 i‡(
	`ã°_bô
(
BITMAP_WRITE_ERROR
, &
bôm≠
->
Êags
))

1751 
îr
 = -
EIO
;

1752 
out
:

1753  
îr
;

1754 
	}
}

1755 
EXPORT_SYMBOL_GPL
(
bôm≠_lﬂd
);

1757 
	$bôm≠_°©us
(
£q_fûe
 *
£q
, 
bôm≠
 *bitmap)

1759 
chunk_kb
;

1760 
bôm≠_cou¡s
 *
cou¡s
;

1762 i‡(!
bôm≠
)

1765 
cou¡s
 = &
bôm≠
->counts;

1767 
chunk_kb
 = 
bôm≠
->
mddev
->
bôm≠_öfo
.
chunksize
 >> 10;

1768 
	`£q_¥ötf
(
£q
, "bitmap: %lu/%luÖages [%luKB], "

1770 
cou¡s
->
∑ges
 - cou¡s->
missög_∑ges
,

1771 
cou¡s
->
∑ges
,

1772 (
cou¡s
->
∑ges
 - cou¡s->
missög_∑ges
)

1773 << (
PAGE_SHIFT
 - 10),

1774 
chunk_kb
 ? chunk_kb : 
bôm≠
->
mddev
->
bôm≠_öfo
.
chunksize
,

1775 
chunk_kb
 ? "KB" : "B");

1776 i‡(
bôm≠
->
°‹age
.
fûe
) {

1777 
	`£q_¥ötf
(
£q
, ", file: ");

1778 
	`£q_∑th
(
£q
, &
bôm≠
->
°‹age
.
fûe
->
f_∑th
, " \t\n");

1781 
	`£q_¥ötf
(
£q
, "\n");

1782 
	}
}

1784 
	$bôm≠_ªsize
(
bôm≠
 *bôm≠, 
£˘‹_t
 
blocks
,

1785 
chunksize
, 
öô
)

1797 
bôm≠_°‹age
 
°‹e
;

1798 
bôm≠_cou¡s
 
ﬁd_cou¡s
;

1799 
chunks
;

1800 
£˘‹_t
 
block
;

1801 
£˘‹_t
 
ﬁd_blocks
, 
√w_blocks
;

1802 
chunkshi·
;

1803 
ªt
 = 0;

1804 
∑ges
;

1805 
bôm≠_∑ge
 *
√w_bp
;

1807 i‡(
chunksize
 == 0) {

1811 
byãs
;

1812 
•a˚
 = 
bôm≠
->
mddev
->
bôm≠_öfo
.space;

1814 i‡(
•a˚
 == 0) {

1818 
byãs
 = 
	`DIV_ROUND_UP
(
bôm≠
->
cou¡s
.
chunks
, 8);

1819 i‡(!
bôm≠
->
mddev
->
bôm≠_öfo
.
exã∫Æ
)

1820 
byãs
 +(
bôm≠_su≥r_t
);

1821 
•a˚
 = 
	`DIV_ROUND_UP
(
byãs
, 512);

1822 
bôm≠
->
mddev
->
bôm≠_öfo
.
•a˚
 = space;

1824 
chunkshi·
 = 
bôm≠
->
cou¡s
.chunkshift;

1825 
chunkshi·
--;

1828 
chunkshi·
++;

1829 
chunks
 = 
	`DIV_ROUND_UP_SECTOR_T
(
blocks
, 1 << 
chunkshi·
);

1830 
byãs
 = 
	`DIV_ROUND_UP
(
chunks
, 8);

1831 i‡(!
bôm≠
->
mddev
->
bôm≠_öfo
.
exã∫Æ
)

1832 
byãs
 +(
bôm≠_su≥r_t
);

1833 } 
byãs
 > (
•a˚
 << 9));

1835 
chunkshi·
 = 
	`ffz
(~
chunksize
Ë- 
BITMAP_BLOCK_SHIFT
;

1837 
chunks
 = 
	`DIV_ROUND_UP_SECTOR_T
(
blocks
, 1 << 
chunkshi·
);

1838 
	`mem£t
(&
°‹e
, 0, (store));

1839 i‡(
bôm≠
->
mddev
->
bôm≠_öfo
.
off£t
 || bôm≠->mddev->bôm≠_öfo.
fûe
)

1840 
ªt
 = 
	`bôm≠_°‹age_Æloc
(&
°‹e
, 
chunks
,

1841 !
bôm≠
->
mddev
->
bôm≠_öfo
.
exã∫Æ
);

1842 i‡(
ªt
)

1843 
îr
;

1845 
∑ges
 = 
	`DIV_ROUND_UP
(
chunks
, 
PAGE_COUNTER_RATIO
);

1847 
√w_bp
 = 
	`kzÆloc
(
∑ges
 * (*√w_bp), 
GFP_KERNEL
);

1848 
ªt
 = -
ENOMEM
;

1849 i‡(!
√w_bp
) {

1850 
	`bôm≠_fûe_unm≠
(&
°‹e
);

1851 
îr
;

1854 i‡(!
öô
)

1855 
bôm≠
->
mddev
->
≥rs
->
	`quõs˚
(bitmap->mddev, 1);

1857 
°‹e
.
fûe
 = 
bôm≠
->
°‹age
.file;

1858 
bôm≠
->
°‹age
.
fûe
 = 
NULL
;

1860 i‡(
°‹e
.
sb_∑ge
 && 
bôm≠
->
°‹age
.sb_page)

1861 
	`mem˝y
(
	`∑ge_addªss
(
°‹e
.
sb_∑ge
),

1862 
	`∑ge_addªss
(
bôm≠
->
°‹age
.
sb_∑ge
),

1863 (
bôm≠_su≥r_t
));

1864 
	`bôm≠_fûe_unm≠
(&
bôm≠
->
°‹age
);

1865 
bôm≠
->
°‹age
 = 
°‹e
;

1867 
ﬁd_cou¡s
 = 
bôm≠
->
cou¡s
;

1868 
bôm≠
->
cou¡s
.
bp
 = 
√w_bp
;

1869 
bôm≠
->
cou¡s
.
∑ges
 =Öages;

1870 
bôm≠
->
cou¡s
.
missög_∑ges
 = 
∑ges
;

1871 
bôm≠
->
cou¡s
.
chunkshi·
 = chunkshift;

1872 
bôm≠
->
cou¡s
.
chunks
 = chunks;

1873 
bôm≠
->
mddev
->
bôm≠_öfo
.
chunksize
 = 1 << (
chunkshi·
 +

1874 
BITMAP_BLOCK_SHIFT
);

1876 
blocks
 = 
	`mö
(
ﬁd_cou¡s
.
chunks
 << old_cou¡s.
chunkshi·
,

1877 
chunks
 << 
chunkshi·
);

1879 
	`•ö_lock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1880 
block
 = 0; block < 
blocks
; ) {

1881 
bôm≠_cou¡î_t
 *
bmc_ﬁd
, *
bmc_√w
;

1882 
£t
;

1884 
bmc_ﬁd
 = 
	`bôm≠_gë_cou¡î
(&
ﬁd_cou¡s
, 
block
,

1885 &
ﬁd_blocks
, 0);

1886 
£t
 = 
bmc_ﬁd
 && 
	`NEEDED
(*bmc_old);

1888 i‡(
£t
) {

1889 
bmc_√w
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
block
,

1890 &
√w_blocks
, 1);

1891 i‡(*
bmc_√w
 == 0) {

1893 
£˘‹_t
 
íd
 = 
block
 + 
√w_blocks
;

1894 
£˘‹_t
 
°¨t
 = 
block
 >> 
chunkshi·
;

1895 
°¨t
 <<
chunkshi·
;

1896 
°¨t
 < 
íd
) {

1897 
	`bôm≠_fûe_£t_bô
(
bôm≠
, 
block
);

1898 
°¨t
 +1 << 
chunkshi·
;

1900 *
bmc_√w
 = 2;

1901 
	`bôm≠_cou¡_∑ge
(&
bôm≠
->
cou¡s
,

1902 
block
, 1);

1903 
	`bôm≠_£t_≥ndög
(&
bôm≠
->
cou¡s
,

1904 
block
);

1906 *
bmc_√w
 |
NEEDED_MASK
;

1907 i‡(
√w_blocks
 < 
ﬁd_blocks
)

1908 
ﬁd_blocks
 = 
√w_blocks
;

1910 
block
 +
ﬁd_blocks
;

1913 i‡(!
öô
) {

1914 
i
;

1915 
block
 < (
chunks
 << 
chunkshi·
)) {

1916 
bôm≠_cou¡î_t
 *
bmc
;

1917 
bmc
 = 
	`bôm≠_gë_cou¡î
(&
bôm≠
->
cou¡s
, 
block
,

1918 &
√w_blocks
, 1);

1919 i‡(
bmc
) {

1923 i‡(*
bmc
 == 0) {

1924 *
bmc
 = 
NEEDED_MASK
 | 2;

1925 
	`bôm≠_cou¡_∑ge
(&
bôm≠
->
cou¡s
,

1926 
block
, 1);

1927 
	`bôm≠_£t_≥ndög
(&
bôm≠
->
cou¡s
,

1928 
block
);

1931 
block
 +
√w_blocks
;

1933 
i
 = 0; i < 
bôm≠
->
°‹age
.
fûe_∑ges
; i++)

1934 
	`£t_∑ge_©å
(
bôm≠
, 
i
, 
BITMAP_PAGE_DIRTY
);

1936 
	`•ö_u∆ock_úq
(&
bôm≠
->
cou¡s
.
lock
);

1938 i‡(!
öô
) {

1939 
	`bôm≠_u≈lug
(
bôm≠
);

1940 
bôm≠
->
mddev
->
≥rs
->
	`quõs˚
(bitmap->mddev, 0);

1942 
ªt
 = 0;

1943 
îr
:

1944  
ªt
;

1945 
	}
}

1946 
EXPORT_SYMBOL_GPL
(
bôm≠_ªsize
);

1948 
ssize_t


1949 
	$loˇti⁄_show
(
mddev
 *mddev, *
∑ge
)

1951 
ssize_t
 
Àn
;

1952 i‡(
mddev
->
bôm≠_öfo
.
fûe
)

1953 
Àn
 = 
	`•rötf
(
∑ge
, "file");

1954 i‡(
mddev
->
bôm≠_öfo
.
off£t
)

1955 
Àn
 = 
	`•rötf
(
∑ge
, "%+Œd", ()
mddev
->
bôm≠_öfo
.
off£t
);

1957 
Àn
 = 
	`•rötf
(
∑ge
, "none");

1958 
Àn
 +
	`•rötf
(
∑ge
+len, "\n");

1959  
Àn
;

1960 
	}
}

1962 
ssize_t


1963 
	$loˇti⁄_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

1966 i‡(
mddev
->
≥rs
) {

1967 i‡(!
mddev
->
≥rs
->
quõs˚
)

1968  -
EBUSY
;

1969 i‡(
mddev
->
ªcovîy
 || mddev->
sync_thªad
)

1970  -
EBUSY
;

1973 i‡(
mddev
->
bôm≠
 || mddev->
bôm≠_öfo
.
fûe
 ||

1974 
mddev
->
bôm≠_öfo
.
off£t
) {

1976 i‡(
	`°∫cmp
(
buf
, "none", 4) != 0)

1977  -
EBUSY
;

1978 i‡(
mddev
->
≥rs
) {

1979 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

1980 
	`bôm≠_de°roy
(
mddev
);

1981 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

1983 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

1984 i‡(
mddev
->
bôm≠_öfo
.
fûe
) {

1985 
fûe
 *
f
 = 
mddev
->
bôm≠_öfo
.file;

1986 
mddev
->
bôm≠_öfo
.
fûe
 = 
NULL
;

1987 
	`Âut
(
f
);

1991 
off£t
;

1992 i‡(
	`°∫cmp
(
buf
, "none", 4) == 0)

1994 i‡(
	`°∫cmp
(
buf
, "file:", 5) == 0) {

1996  -
EINVAL
;

1998 
rv
;

1999 i‡(
buf
[0] == '+')

2000 
rv
 = 
	`k°πﬁl
(
buf
+1, 10, &
off£t
);

2002 
rv
 = 
	`k°πﬁl
(
buf
, 10, &
off£t
);

2003 i‡(
rv
)

2004  
rv
;

2005 i‡(
off£t
 == 0)

2006  -
EINVAL
;

2007 i‡(
mddev
->
bôm≠_öfo
.
exã∫Æ
 == 0 &&

2008 
mddev
->
maj‹_vîsi⁄
 == 0 &&

2009 
off£t
 !
mddev
->
bôm≠_öfo
.
deÁu…_off£t
)

2010  -
EINVAL
;

2011 
mddev
->
bôm≠_öfo
.
off£t
 = offset;

2012 i‡(
mddev
->
≥rs
) {

2013 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

2014 
rv
 = 
	`bôm≠_¸óã
(
mddev
);

2015 i‡(!
rv
)

2016 
rv
 = 
	`bôm≠_lﬂd
(
mddev
);

2017 i‡(
rv
) {

2018 
	`bôm≠_de°roy
(
mddev
);

2019 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

2021 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

2022 i‡(
rv
)

2023  
rv
;

2027 i‡(!
mddev
->
exã∫Æ
) {

2031 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

2032 
	`md_wakeup_thªad
(
mddev
->
thªad
);

2034  
Àn
;

2035 
	}
}

2037 
md_sysfs_íåy
 
	gbôm≠_loˇti⁄
 =

2038 
__ATTR
(
loˇti⁄
, 
S_IRUGO
|
S_IWUSR
, 
loˇti⁄_show
, 
loˇti⁄_°‹e
);

2044 
ssize_t


2045 
	$•a˚_show
(
mddev
 *mddev, *
∑ge
)

2047  
	`•rötf
(
∑ge
, "%lu\n", 
mddev
->
bôm≠_öfo
.
•a˚
);

2048 
	}
}

2050 
ssize_t


2051 
	$•a˚_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2053 
£˘‹s
;

2054 
rv
;

2056 
rv
 = 
	`k°πoul
(
buf
, 10, &
£˘‹s
);

2057 i‡(
rv
)

2058  
rv
;

2060 i‡(
£˘‹s
 == 0)

2061  -
EINVAL
;

2063 i‡(
mddev
->
bôm≠
 &&

2064 
£˘‹s
 < (
mddev
->
bôm≠
->
°‹age
.
byãs
 + 511) >> 9)

2065  -
EFBIG
;

2070 
mddev
->
bôm≠_öfo
.
•a˚
 = 
£˘‹s
;

2071  
Àn
;

2072 
	}
}

2074 
md_sysfs_íåy
 
	gbôm≠_•a˚
 =

2075 
__ATTR
(
•a˚
, 
S_IRUGO
|
S_IWUSR
, 
•a˚_show
, 
•a˚_°‹e
);

2077 
ssize_t


2078 
	$timeout_show
(
mddev
 *mddev, *
∑ge
)

2080 
ssize_t
 
Àn
;

2081 
£cs
 = 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 / 
HZ
;

2082 
jifs
 = 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 % 
HZ
;

2084 
Àn
 = 
	`•rötf
(
∑ge
, "%lu", 
£cs
);

2085 i‡(
jifs
)

2086 
Àn
 +
	`•rötf
(
∑ge
+Àn, ".%03u", 
	`jiffõs_to_m£cs
(
jifs
));

2087 
Àn
 +
	`•rötf
(
∑ge
+len, "\n");

2088  
Àn
;

2089 
	}
}

2091 
ssize_t


2092 
	$timeout_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2095 
timeout
;

2096 
rv
 = 
	`°ri˘_°πoul_sˇÀd
(
buf
, &
timeout
, 4);

2097 i‡(
rv
)

2098  
rv
;

2101 i‡(
timeout
 >
LONG_MAX
 / 
HZ
)

2102  -
EINVAL
;

2104 
timeout
 =Åimeouà* 
HZ
 / 10000;

2106 i‡(
timeout
 >
MAX_SCHEDULE_TIMEOUT
)

2107 
timeout
 = 
MAX_SCHEDULE_TIMEOUT
-1;

2108 i‡(
timeout
 < 1)

2109 
timeout
 = 1;

2110 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 = 
timeout
;

2111 i‡(
mddev
->
thªad
) {

2116 i‡(
mddev
->
thªad
->
timeout
 < 
MAX_SCHEDULE_TIMEOUT
) {

2117 
mddev
->
thªad
->
timeout
 =Åimeout;

2118 
	`md_wakeup_thªad
(
mddev
->
thªad
);

2121  
Àn
;

2122 
	}
}

2124 
md_sysfs_íåy
 
	gbôm≠_timeout
 =

2125 
__ATTR
(
time_ba£
, 
S_IRUGO
|
S_IWUSR
, 
timeout_show
, 
timeout_°‹e
);

2127 
ssize_t


2128 
	$backlog_show
(
mddev
 *mddev, *
∑ge
)

2130  
	`•rötf
(
∑ge
, "%lu\n", 
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
);

2131 
	}
}

2133 
ssize_t


2134 
	$backlog_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2136 
backlog
;

2137 
rv
 = 
	`k°πoul
(
buf
, 10, &
backlog
);

2138 i‡(
rv
)

2139  
rv
;

2140 i‡(
backlog
 > 
COUNTER_MAX
)

2141  -
EINVAL
;

2142 
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
 = 
backlog
;

2143  
Àn
;

2144 
	}
}

2146 
md_sysfs_íåy
 
	gbôm≠_backlog
 =

2147 
__ATTR
(
backlog
, 
S_IRUGO
|
S_IWUSR
, 
backlog_show
, 
backlog_°‹e
);

2149 
ssize_t


2150 
	$chunksize_show
(
mddev
 *mddev, *
∑ge
)

2152  
	`•rötf
(
∑ge
, "%lu\n", 
mddev
->
bôm≠_öfo
.
chunksize
);

2153 
	}
}

2155 
ssize_t


2156 
	$chunksize_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2159 
rv
;

2160 
csize
;

2161 i‡(
mddev
->
bôm≠
)

2162  -
EBUSY
;

2163 
rv
 = 
	`k°πoul
(
buf
, 10, &
csize
);

2164 i‡(
rv
)

2165  
rv
;

2166 i‡(
csize
 < 512 ||

2167 !
	`is_powî_of_2
(
csize
))

2168  -
EINVAL
;

2169 
mddev
->
bôm≠_öfo
.
chunksize
 = 
csize
;

2170  
Àn
;

2171 
	}
}

2173 
md_sysfs_íåy
 
	gbôm≠_chunksize
 =

2174 
__ATTR
(
chunksize
, 
S_IRUGO
|
S_IWUSR
, 
chunksize_show
, 
chunksize_°‹e
);

2176 
ssize_t
 
	$mëad©a_show
(
mddev
 *mddev, *
∑ge
)

2178  
	`•rötf
(
∑ge
, "%s\n", (
mddev
->
bôm≠_öfo
.
exã∫Æ


2180 
	}
}

2182 
ssize_t
 
	$mëad©a_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2184 i‡(
mddev
->
bôm≠
 ||

2185 
mddev
->
bôm≠_öfo
.
fûe
 ||

2186 
mddev
->
bôm≠_öfo
.
off£t
)

2187  -
EBUSY
;

2188 i‡(
	`°∫cmp
(
buf
, "external", 8) == 0)

2189 
mddev
->
bôm≠_öfo
.
exã∫Æ
 = 1;

2190 i‡(
	`°∫cmp
(
buf
, "internal", 8) == 0)

2191 
mddev
->
bôm≠_öfo
.
exã∫Æ
 = 0;

2193  -
EINVAL
;

2194  
Àn
;

2195 
	}
}

2197 
md_sysfs_íåy
 
	gbôm≠_mëad©a
 =

2198 
__ATTR
(
mëad©a
, 
S_IRUGO
|
S_IWUSR
, 
mëad©a_show
, 
mëad©a_°‹e
);

2200 
ssize_t
 
	$ˇn_˛ór_show
(
mddev
 *mddev, *
∑ge
)

2202 
Àn
;

2203 i‡(
mddev
->
bôm≠
)

2204 
Àn
 = 
	`•rötf
(
∑ge
, "%s\n", (
mddev
->
bôm≠
->
√ed_sync
 ?

2207 
Àn
 = 
	`•rötf
(
∑ge
, "\n");

2208  
Àn
;

2209 
	}
}

2211 
ssize_t
 
	$ˇn_˛ór_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2213 i‡(
mddev
->
bôm≠
 =
NULL
)

2214  -
ENOENT
;

2215 i‡(
	`°∫cmp
(
buf
, "false", 5) == 0)

2216 
mddev
->
bôm≠
->
√ed_sync
 = 1;

2217 i‡(
	`°∫cmp
(
buf
, "true", 4) == 0) {

2218 i‡(
mddev
->
degøded
)

2219  -
EBUSY
;

2220 
mddev
->
bôm≠
->
√ed_sync
 = 0;

2222  -
EINVAL
;

2223  
Àn
;

2224 
	}
}

2226 
md_sysfs_íåy
 
	gbôm≠_ˇn_˛ór
 =

2227 
__ATTR
(
ˇn_˛ór
, 
S_IRUGO
|
S_IWUSR
, 
ˇn_˛ór_show
, 
ˇn_˛ór_°‹e
);

2229 
ssize_t


2230 
	$behöd_wrôes_u£d_show
(
mddev
 *mddev, *
∑ge
)

2232 i‡(
mddev
->
bôm≠
 =
NULL
)

2233  
	`•rötf
(
∑ge
, "0\n");

2234  
	`•rötf
(
∑ge
, "%lu\n",

2235 
mddev
->
bôm≠
->
behöd_wrôes_u£d
);

2236 
	}
}

2238 
ssize_t


2239 
	$behöd_wrôes_u£d_ª£t
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

2241 i‡(
mddev
->
bôm≠
)

2242 
mddev
->
bôm≠
->
behöd_wrôes_u£d
 = 0;

2243  
Àn
;

2244 
	}
}

2246 
md_sysfs_íåy
 
	gmax_backlog_u£d
 =

2247 
__ATTR
(
max_backlog_u£d
, 
S_IRUGO
 | 
S_IWUSR
,

2248 
behöd_wrôes_u£d_show
, 
behöd_wrôes_u£d_ª£t
);

2250 
©åibuã
 *
	gmd_bôm≠_©ås
[] = {

2251 &
bôm≠_loˇti⁄
.
©å
,

2252 &
bôm≠_•a˚
.
©å
,

2253 &
bôm≠_timeout
.
©å
,

2254 &
bôm≠_backlog
.
©å
,

2255 &
bôm≠_chunksize
.
©å
,

2256 &
bôm≠_mëad©a
.
©å
,

2257 &
bôm≠_ˇn_˛ór
.
©å
,

2258 &
max_backlog_u£d
.
©å
,

2259 
NULL


2261 
©åibuã_group
 
	gmd_bôm≠_group
 = {

2262 .
«me
 = "bitmap",

2263 .
	g©ås
 = 
md_bôm≠_©ås
,

	@bitmap.h

6 #i‚de‡
BITMAP_H


7 
	#BITMAP_H
 1

	)

9 
	#BITMAP_MAJOR_LO
 3

	)

13 
	#BITMAP_MAJOR_HI
 4

	)

14 
	#BITMAP_MAJOR_HOSTENDIAN
 3

	)

78 #ifde‡
__KERNEL__


80 
	#PAGE_BITS
 (
PAGE_SIZE
 << 3)

	)

81 
	#PAGE_BIT_SHIFT
 (
PAGE_SHIFT
 + 3)

	)

83 
__u16
 
	tbôm≠_cou¡î_t
;

84 
	#COUNTER_BITS
 16

	)

85 
	#COUNTER_BIT_SHIFT
 4

	)

86 
	#COUNTER_BYTE_SHIFT
 (
COUNTER_BIT_SHIFT
 - 3)

	)

88 
	#NEEDED_MASK
 ((
bôm≠_cou¡î_t
Ë(1 << (
COUNTER_BITS
 - 1)))

	)

89 
	#RESYNC_MASK
 ((
bôm≠_cou¡î_t
Ë(1 << (
COUNTER_BITS
 - 2)))

	)

90 
	#COUNTER_MAX
 ((
bôm≠_cou¡î_t
Ë
RESYNC_MASK
 - 1)

	)

91 
	#NEEDED
(
x
Ë(((
bôm≠_cou¡î_t
ËxË& 
NEEDED_MASK
)

	)

92 
	#RESYNC
(
x
Ë(((
bôm≠_cou¡î_t
ËxË& 
RESYNC_MASK
)

	)

93 
	#COUNTER
(
x
Ë(((
bôm≠_cou¡î_t
ËxË& 
COUNTER_MAX
)

	)

96 
	#PAGE_COUNTER_RATIO
 (
PAGE_BITS
 / 
COUNTER_BITS
)

	)

98 
	#PAGE_COUNTER_SHIFT
 (
PAGE_BIT_SHIFT
 - 
COUNTER_BIT_SHIFT
)

	)

100 
	#PAGE_COUNTER_MASK
 (
PAGE_COUNTER_RATIO
 - 1)

	)

102 
	#BITMAP_BLOCK_SHIFT
 9

	)

110 
	#BITMAP_MAGIC
 0x6d746962

	)

113 
	ebôm≠_°©e
 {

114 
	mBITMAP_STALE
 = 1,

115 
	mBITMAP_WRITE_ERROR
 = 2,

116 
	mBITMAP_HOSTENDIAN
 =15,

120 
	sbôm≠_su≥r_s
 {

121 
__À32
 
	mmagic
;

122 
__À32
 
	mvîsi⁄
;

123 
__u8
 
	muuid
[16];

124 
__À64
 
	mevíts
;

125 
__À64
 
	mevíts_˛óªd
;

126 
__À64
 
	msync_size
;

127 
__À32
 
	m°©e
;

128 
__À32
 
	mchunksize
;

129 
__À32
 
	md´m⁄_¶ìp
;

130 
__À32
 
	mwrôe_behöd
;

131 
__À32
 
	m£˘‹s_ª£rved
;

134 
__u8
 
	m∑d
[256 - 68];

135 } 
	tbôm≠_su≥r_t
;

151 #ifde‡
__KERNEL__


154 
	sbôm≠_∑ge
 {

158 *
	mm≠
;

163 
	mhijacked
:1;

168 
	m≥ndög
:1;

172 
	mcou¡
:30;

176 
	sbôm≠
 {

178 
	sbôm≠_cou¡s
 {

179 
•ölock_t
 
	mlock
;

180 
bôm≠_∑ge
 *
	mbp
;

181 
	m∑ges
;

183 
	mmissög_∑ges
;

185 
	mchunkshi·
;

187 
	mchunks
;

189 } 
	mcou¡s
;

191 
mddev
 *
	mmddev
;

193 
__u64
 
	mevíts_˛óªd
;

194 
	m√ed_sync
;

196 
	sbôm≠_°‹age
 {

197 
fûe
 *
	mfûe
;

198 
∑ge
 *
	msb_∑ge
;

200 
∑ge
 **
	mfûem≠
;

202 *
	mfûem≠_©å
;

204 
	mfûe_∑ges
;

205 
	mbyãs
;

206 } 
	m°‹age
;

208 
	mÊags
;

210 
	mÆl˛ón
;

212 
©omic_t
 
	mbehöd_wrôes
;

213 
	mbehöd_wrôes_u£d
;

219 
	md´m⁄_œ°run
;

220 
	mœ°_íd_sync
;

223 
©omic_t
 
	m≥ndög_wrôes
;

224 
waô_queue_hód_t
 
	mwrôe_waô
;

225 
waô_queue_hód_t
 
	movîÊow_waô
;

226 
waô_queue_hód_t
 
	mbehöd_waô
;

228 
kînfs_node
 *
	msysfs_ˇn_˛ór
;

234 
bôm≠_¸óã
(
mddev
 *mddev);

235 
bôm≠_lﬂd
(
mddev
 *mddev);

236 
bôm≠_Êush
(
mddev
 *mddev);

237 
bôm≠_de°roy
(
mddev
 *mddev);

239 
bôm≠_¥öt_sb
(
bôm≠
 *bitmap);

240 
bôm≠_upd©e_sb
(
bôm≠
 *bitmap);

241 
bôm≠_°©us
(
£q_fûe
 *
£q
, 
bôm≠
 *bitmap);

243 
bôm≠_£èŒbôs
(
bôm≠
 *bitmap);

244 
bôm≠_wrôe_Æl
(
bôm≠
 *bitmap);

246 
bôm≠_dúty_bôs
(
bôm≠
 *bôm≠, 
s
, 
e
);

249 
bôm≠_°¨twrôe
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
,

250 
£˘‹s
, 
behöd
);

251 
bôm≠_ídwrôe
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
,

252 
£˘‹s
, 
suc˚ss
, 
behöd
);

253 
bôm≠_°¨t_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
, 
degøded
);

254 
bôm≠_íd_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
off£t
, se˘‹_à*
blocks
, 
ab‹ãd
);

255 
bôm≠_˛o£_sync
(
bôm≠
 *bitmap);

256 
bôm≠_c⁄d_íd_sync
(
bôm≠
 *bôm≠, 
£˘‹_t
 
£˘‹
);

258 
bôm≠_u≈lug
(
bôm≠
 *bitmap);

259 
bôm≠_d´m⁄_w‹k
(
mddev
 *mddev);

261 
bôm≠_ªsize
(
bôm≠
 *bôm≠, 
£˘‹_t
 
blocks
,

262 
chunksize
, 
öô
);

	@dm-bio-prison.c

7 
	~"dm.h
"

8 
	~"dm-bio-¥is⁄.h
"

10 
	~<löux/•ölock.h
>

11 
	~<löux/mempoﬁ.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/¶ab.h
>

17 
	sbuckë
 {

18 
•ölock_t
 
	mlock
;

19 
hli°_hód
 
	m˚Œs
;

22 
	sdm_bio_¥is⁄
 {

23 
mempoﬁ_t
 *
	m˚Œ_poﬁ
;

25 
	mƒ_buckës
;

26 
	mhash_mask
;

27 
buckë
 *
	mbuckës
;

32 
uöt32_t
 
	$ˇlc_ƒ_buckës
(
ƒ_˚Œs
)

34 
uöt32_t
 
n
 = 128;

36 
ƒ_˚Œs
 /= 4;

37 
ƒ_˚Œs
 = 
	`mö
(nr_cells, 8192u);

39 
n
 < 
ƒ_˚Œs
)

40 
n
 <<= 1;

42  
n
;

43 
	}
}

45 
kmem_ˇche
 *
	g_˚Œ_ˇche
;

47 
	$öô_buckë
(
buckë
 *
b
)

49 
	`•ö_lock_öô
(&
b
->
lock
);

50 
	`INIT_HLIST_HEAD
(&
b
->
˚Œs
);

51 
	}
}

57 
dm_bio_¥is⁄
 *
	$dm_bio_¥is⁄_¸óã
(
ƒ_˚Œs
)

59 
i
;

60 
uöt32_t
 
ƒ_buckës
 = 
	`ˇlc_ƒ_buckës
(
ƒ_˚Œs
);

61 
size_t
 
Àn
 = (
dm_bio_¥is⁄
) +

62 ((
buckë
Ë* 
ƒ_buckës
);

63 
dm_bio_¥is⁄
 *
¥is⁄
 = 
	`kmÆloc
(
Àn
, 
GFP_KERNEL
);

65 i‡(!
¥is⁄
)

66  
NULL
;

68 
¥is⁄
->
˚Œ_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
ƒ_˚Œs
, 
_˚Œ_ˇche
);

69 i‡(!
¥is⁄
->
˚Œ_poﬁ
) {

70 
	`k‰ì
(
¥is⁄
);

71  
NULL
;

74 
¥is⁄
->
ƒ_buckës
 =Çr_buckets;

75 
¥is⁄
->
hash_mask
 = 
ƒ_buckës
 - 1;

76 
¥is⁄
->
buckës
 = (
buckë
 *) (prison + 1);

77 
i
 = 0; i < 
ƒ_buckës
; i++)

78 
	`öô_buckë
(
¥is⁄
->
buckës
 + 
i
);

80  
¥is⁄
;

81 
	}
}

82 
EXPORT_SYMBOL_GPL
(
dm_bio_¥is⁄_¸óã
);

84 
	$dm_bio_¥is⁄_de°roy
(
dm_bio_¥is⁄
 *
¥is⁄
)

86 
	`mempoﬁ_de°roy
(
¥is⁄
->
˚Œ_poﬁ
);

87 
	`k‰ì
(
¥is⁄
);

88 
	}
}

89 
EXPORT_SYMBOL_GPL
(
dm_bio_¥is⁄_de°roy
);

91 
dm_bio_¥is⁄_˚Œ
 *
	$dm_bio_¥is⁄_Æloc_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
, 
gÂ_t
 
gÂ
)

93  
	`mempoﬁ_Æloc
(
¥is⁄
->
˚Œ_poﬁ
, 
gÂ
);

94 
	}
}

95 
EXPORT_SYMBOL_GPL
(
dm_bio_¥is⁄_Æloc_˚Œ
);

97 
	$dm_bio_¥is⁄_‰ì_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
,

98 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

100 
	`mempoﬁ_‰ì
(
˚Œ
, 
¥is⁄
->
˚Œ_poﬁ
);

101 
	}
}

102 
EXPORT_SYMBOL_GPL
(
dm_bio_¥is⁄_‰ì_˚Œ
);

104 
uöt32_t
 
	$hash_key
(
dm_bio_¥is⁄
 *
¥is⁄
, 
dm_˚Œ_key
 *
key
)

106 c⁄° 
BIG_PRIME
 = 4294967291UL;

107 
uöt64_t
 
hash
 = 
key
->
block
 * 
BIG_PRIME
;

109  (
uöt32_t
Ë(
hash
 & 
¥is⁄
->
hash_mask
);

110 
	}
}

112 
	$keys_equÆ
(
dm_˚Œ_key
 *
lhs
, dm_˚Œ_key *
rhs
)

114  (
lhs
->
vútuÆ
 =
rhs
->virtual) &&

115 (
lhs
->
dev
 =
rhs
->dev) &&

116 (
lhs
->
block
 =
rhs
->block);

117 
	}
}

119 
buckë
 *
	$gë_buckë
(
dm_bio_¥is⁄
 *
¥is⁄
,

120 
dm_˚Œ_key
 *
key
)

122  
¥is⁄
->
buckës
 + 
	`hash_key
’ris⁄, 
key
);

123 
	}
}

125 
dm_bio_¥is⁄_˚Œ
 *
	$__£¨ch_buckë
(
buckë
 *
b
,

126 
dm_˚Œ_key
 *
key
)

128 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
;

130 
	`hli°_f‹_óch_íåy
(
˚Œ
, &
b
->
˚Œs
, 
li°
)

131 i‡(
	`keys_equÆ
(&
˚Œ
->
key
, key))

132  
˚Œ
;

134  
NULL
;

135 
	}
}

137 
	$__£tup_√w_˚Œ
(
buckë
 *
b
,

138 
dm_˚Œ_key
 *
key
,

139 
bio
 *
hﬁdî
,

140 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

142 
	`mem˝y
(&
˚Œ
->
key
, key, (cell->key));

143 
˚Œ
->
hﬁdî
 = holder;

144 
	`bio_li°_öô
(&
˚Œ
->
bios
);

145 
	`hli°_add_hód
(&
˚Œ
->
li°
, &
b
->
˚Œs
);

146 
	}
}

148 
	$__bio_dëaö
(
buckë
 *
b
,

149 
dm_˚Œ_key
 *
key
,

150 
bio
 *
öm©e
,

151 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

152 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

154 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
;

156 
˚Œ
 = 
	`__£¨ch_buckë
(
b
, 
key
);

157 i‡(
˚Œ
) {

158 i‡(
öm©e
)

159 
	`bio_li°_add
(&
˚Œ
->
bios
, 
öm©e
);

160 *
˚Œ_ªsu…
 = 
˚Œ
;

164 
	`__£tup_√w_˚Œ
(
b
, 
key
, 
öm©e
, 
˚Œ_¥óŒoc
);

165 *
˚Œ_ªsu…
 = 
˚Œ_¥óŒoc
;

167 
	}
}

169 
	$bio_dëaö
(
dm_bio_¥is⁄
 *
¥is⁄
,

170 
dm_˚Œ_key
 *
key
,

171 
bio
 *
öm©e
,

172 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

173 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

175 
r
;

176 
Êags
;

177 
buckë
 *
b
 = 
	`gë_buckë
(
¥is⁄
, 
key
);

179 
	`•ö_lock_úqßve
(&
b
->
lock
, 
Êags
);

180 
r
 = 
	`__bio_dëaö
(
b
, 
key
, 
öm©e
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

181 
	`•ö_u∆ock_úqª°‹e
(&
b
->
lock
, 
Êags
);

183  
r
;

184 
	}
}

186 
	$dm_bio_dëaö
(
dm_bio_¥is⁄
 *
¥is⁄
,

187 
dm_˚Œ_key
 *
key
,

188 
bio
 *
öm©e
,

189 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

190 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

192  
	`bio_dëaö
(
¥is⁄
, 
key
, 
öm©e
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

193 
	}
}

194 
EXPORT_SYMBOL_GPL
(
dm_bio_dëaö
);

196 
	$dm_gë_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
,

197 
dm_˚Œ_key
 *
key
,

198 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

199 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

201  
	`bio_dëaö
(
¥is⁄
, 
key
, 
NULL
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

202 
	}
}

203 
EXPORT_SYMBOL_GPL
(
dm_gë_˚Œ
);

208 
	$__˚Œ_ªÀa£
(
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

209 
bio_li°
 *
öm©es
)

211 
	`hli°_dñ
(&
˚Œ
->
li°
);

213 i‡(
öm©es
) {

214 i‡(
˚Œ
->
hﬁdî
)

215 
	`bio_li°_add
(
öm©es
, 
˚Œ
->
hﬁdî
);

216 
	`bio_li°_mîge
(
öm©es
, &
˚Œ
->
bios
);

218 
	}
}

220 
	$dm_˚Œ_ªÀa£
(
dm_bio_¥is⁄
 *
¥is⁄
,

221 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

222 
bio_li°
 *
bios
)

224 
Êags
;

225 
buckë
 *
b
 = 
	`gë_buckë
(
¥is⁄
, &
˚Œ
->
key
);

227 
	`•ö_lock_úqßve
(&
b
->
lock
, 
Êags
);

228 
	`__˚Œ_ªÀa£
(
˚Œ
, 
bios
);

229 
	`•ö_u∆ock_úqª°‹e
(&
b
->
lock
, 
Êags
);

230 
	}
}

231 
EXPORT_SYMBOL_GPL
(
dm_˚Œ_ªÀa£
);

236 
	$__˚Œ_ªÀa£_no_hﬁdî
(
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

237 
bio_li°
 *
öm©es
)

239 
	`hli°_dñ
(&
˚Œ
->
li°
);

240 
	`bio_li°_mîge
(
öm©es
, &
˚Œ
->
bios
);

241 
	}
}

243 
	$dm_˚Œ_ªÀa£_no_hﬁdî
(
dm_bio_¥is⁄
 *
¥is⁄
,

244 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

245 
bio_li°
 *
öm©es
)

247 
Êags
;

248 
buckë
 *
b
 = 
	`gë_buckë
(
¥is⁄
, &
˚Œ
->
key
);

250 
	`•ö_lock_úqßve
(&
b
->
lock
, 
Êags
);

251 
	`__˚Œ_ªÀa£_no_hﬁdî
(
˚Œ
, 
öm©es
);

252 
	`•ö_u∆ock_úqª°‹e
(&
b
->
lock
, 
Êags
);

253 
	}
}

254 
EXPORT_SYMBOL_GPL
(
dm_˚Œ_ªÀa£_no_hﬁdî
);

256 
	$dm_˚Œ_îr‹
(
dm_bio_¥is⁄
 *
¥is⁄
,

257 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
îr‹
)

259 
bio_li°
 
bios
;

260 
bio
 *bio;

262 
	`bio_li°_öô
(&
bios
);

263 
	`dm_˚Œ_ªÀa£
(
¥is⁄
, 
˚Œ
, &
bios
);

265 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

266 
	`bio_ídio
(
bio
, 
îr‹
);

267 
	}
}

268 
EXPORT_SYMBOL_GPL
(
dm_˚Œ_îr‹
);

272 
	#DEFERRED_SET_SIZE
 64

	)

274 
	sdm_de„ºed_íåy
 {

275 
dm_de„ºed_£t
 *
	mds
;

276 
	mcou¡
;

277 
li°_hód
 
	mw‹k_ôems
;

280 
	sdm_de„ºed_£t
 {

281 
•ölock_t
 
	mlock
;

282 
	mcuºít_íåy
;

283 
	mswì≥r
;

284 
dm_de„ºed_íåy
 
	míåõs
[
DEFERRED_SET_SIZE
];

287 
dm_de„ºed_£t
 *
	$dm_de„ºed_£t_¸óã
()

289 
i
;

290 
dm_de„ºed_£t
 *
ds
;

292 
ds
 = 
	`kmÆloc
((*ds), 
GFP_KERNEL
);

293 i‡(!
ds
)

294  
NULL
;

296 
	`•ö_lock_öô
(&
ds
->
lock
);

297 
ds
->
cuºít_íåy
 = 0;

298 
ds
->
swì≥r
 = 0;

299 
i
 = 0; i < 
DEFERRED_SET_SIZE
; i++) {

300 
ds
->
íåõs
[
i
].ds = ds;

301 
ds
->
íåõs
[
i
].
cou¡
 = 0;

302 
	`INIT_LIST_HEAD
(&
ds
->
íåõs
[
i
].
w‹k_ôems
);

305  
ds
;

306 
	}
}

307 
EXPORT_SYMBOL_GPL
(
dm_de„ºed_£t_¸óã
);

309 
	$dm_de„ºed_£t_de°roy
(
dm_de„ºed_£t
 *
ds
)

311 
	`k‰ì
(
ds
);

312 
	}
}

313 
EXPORT_SYMBOL_GPL
(
dm_de„ºed_£t_de°roy
);

315 
dm_de„ºed_íåy
 *
	$dm_de„ºed_íåy_öc
(
dm_de„ºed_£t
 *
ds
)

317 
Êags
;

318 
dm_de„ºed_íåy
 *
íåy
;

320 
	`•ö_lock_úqßve
(&
ds
->
lock
, 
Êags
);

321 
íåy
 = 
ds
->
íåõs
 + ds->
cuºít_íåy
;

322 
íåy
->
cou¡
++;

323 
	`•ö_u∆ock_úqª°‹e
(&
ds
->
lock
, 
Êags
);

325  
íåy
;

326 
	}
}

327 
EXPORT_SYMBOL_GPL
(
dm_de„ºed_íåy_öc
);

329 
	$ds_√xt
(
ödex
)

331  (
ödex
 + 1Ë% 
DEFERRED_SET_SIZE
;

332 
	}
}

334 
	$__swìp
(
dm_de„ºed_£t
 *
ds
, 
li°_hód
 *
hód
)

336 (
ds
->
swì≥r
 !ds->
cuºít_íåy
) &&

337 !
ds
->
íåõs
[ds->
swì≥r
].
cou¡
) {

338 
	`li°_•li˚_öô
(&
ds
->
íåõs
[ds->
swì≥r
].
w‹k_ôems
, 
hód
);

339 
ds
->
swì≥r
 = 
	`ds_√xt
(ds->sweeper);

342 i‡((
ds
->
swì≥r
 =ds->
cuºít_íåy
Ë&& !ds->
íåõs
[ds->swì≥r].
cou¡
)

343 
	`li°_•li˚_öô
(&
ds
->
íåõs
[ds->
swì≥r
].
w‹k_ôems
, 
hód
);

344 
	}
}

346 
	$dm_de„ºed_íåy_dec
(
dm_de„ºed_íåy
 *
íåy
, 
li°_hód
 *
hód
)

348 
Êags
;

350 
	`•ö_lock_úqßve
(&
íåy
->
ds
->
lock
, 
Êags
);

351 
	`BUG_ON
(!
íåy
->
cou¡
);

352 --
íåy
->
cou¡
;

353 
	`__swìp
(
íåy
->
ds
, 
hód
);

354 
	`•ö_u∆ock_úqª°‹e
(&
íåy
->
ds
->
lock
, 
Êags
);

355 
	}
}

356 
EXPORT_SYMBOL_GPL
(
dm_de„ºed_íåy_dec
);

361 
	$dm_de„ºed_£t_add_w‹k
(
dm_de„ºed_£t
 *
ds
, 
li°_hód
 *
w‹k
)

363 
r
 = 1;

364 
Êags
;

365 
√xt_íåy
;

367 
	`•ö_lock_úqßve
(&
ds
->
lock
, 
Êags
);

368 i‡((
ds
->
swì≥r
 =ds->
cuºít_íåy
) &&

369 !
ds
->
íåõs
[ds->
cuºít_íåy
].
cou¡
)

370 
r
 = 0;

372 
	`li°_add
(
w‹k
, &
ds
->
íåõs
[ds->
cuºít_íåy
].
w‹k_ôems
);

373 
√xt_íåy
 = 
	`ds_√xt
(
ds
->
cuºít_íåy
);

374 i‡(!
ds
->
íåõs
[
√xt_íåy
].
cou¡
)

375 
ds
->
cuºít_íåy
 = 
√xt_íåy
;

377 
	`•ö_u∆ock_úqª°‹e
(&
ds
->
lock
, 
Êags
);

379  
r
;

380 
	}
}

381 
EXPORT_SYMBOL_GPL
(
dm_de„ºed_£t_add_w‹k
);

385 
__öô
 
	$dm_bio_¥is⁄_öô
()

387 
_˚Œ_ˇche
 = 
	`KMEM_CACHE
(
dm_bio_¥is⁄_˚Œ
, 0);

388 i‡(!
_˚Œ_ˇche
)

389  -
ENOMEM
;

392 
	}
}

394 
__exô
 
	$dm_bio_¥is⁄_exô
()

396 
	`kmem_ˇche_de°roy
(
_˚Œ_ˇche
);

397 
_˚Œ_ˇche
 = 
NULL
;

398 
	}
}

403 
moduÀ_öô
(
dm_bio_¥is⁄_öô
);

404 
moduÀ_exô
(
dm_bio_¥is⁄_exô
);

406 
MODULE_DESCRIPTION
(
DM_NAME
 " bioÖrison");

407 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

408 
MODULE_LICENSE
("GPL");

	@dm-bio-prison.h

7 #i‚de‡
DM_BIO_PRISON_H


8 
	#DM_BIO_PRISON_H


	)

10 
	~"≥rsi°ít-d©a/dm-block-m™agî.h
"

11 
	~"dm-thö-mëad©a.h
"

13 
	~<löux/li°.h
>

14 
	~<löux/bio.h
>

24 
	gdm_bio_¥is⁄
;

27 
	sdm_˚Œ_key
 {

28 
	mvútuÆ
;

29 
dm_thö_id
 
	mdev
;

30 
dm_block_t
 
	mblock
;

37 
	sdm_bio_¥is⁄_˚Œ
 {

38 
hli°_node
 
	mli°
;

39 
dm_˚Œ_key
 
	mkey
;

40 
bio
 *
	mhﬁdî
;

41 
bio_li°
 
	mbios
;

44 
dm_bio_¥is⁄
 *
dm_bio_¥is⁄_¸óã
(
ƒ_˚Œs
);

45 
dm_bio_¥is⁄_de°roy
(
dm_bio_¥is⁄
 *
¥is⁄
);

54 
dm_bio_¥is⁄_˚Œ
 *
dm_bio_¥is⁄_Æloc_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
,

55 
gÂ_t
 
gÂ
);

56 
dm_bio_¥is⁄_‰ì_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
,

57 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
);

65 
dm_gë_˚Œ
(
dm_bio_¥is⁄
 *
¥is⁄
,

66 
dm_˚Œ_key
 *
key
,

67 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

68 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
);

75 
dm_bio_dëaö
(
dm_bio_¥is⁄
 *
¥is⁄
,

76 
dm_˚Œ_key
 *
key
,

77 
bio
 *
öm©e
,

78 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

79 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
);

81 
dm_˚Œ_ªÀa£
(
dm_bio_¥is⁄
 *
¥is⁄
,

82 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

83 
bio_li°
 *
bios
);

84 
dm_˚Œ_ªÀa£_no_hﬁdî
(
dm_bio_¥is⁄
 *
¥is⁄
,

85 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

86 
bio_li°
 *
öm©es
);

87 
dm_˚Œ_îr‹
(
dm_bio_¥is⁄
 *
¥is⁄
,

88 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
îr‹
);

99 
	gdm_de„ºed_£t
;

100 
	gdm_de„ºed_íåy
;

102 
dm_de„ºed_£t
 *
dm_de„ºed_£t_¸óã
();

103 
dm_de„ºed_£t_de°roy
(
dm_de„ºed_£t
 *
ds
);

105 
dm_de„ºed_íåy
 *
dm_de„ºed_íåy_öc
(
dm_de„ºed_£t
 *
ds
);

106 
dm_de„ºed_íåy_dec
(
dm_de„ºed_íåy
 *
íåy
, 
li°_hód
 *
hód
);

107 
dm_de„ºed_£t_add_w‹k
(
dm_de„ºed_£t
 *
ds
, 
li°_hód
 *
w‹k
);

	@dm-bio-prison.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

24 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

25 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

26 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

27 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

28 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

29 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

30 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

31 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

32 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

33 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

34 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

35 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

36 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

37 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

38 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

41 c⁄° 
	g__moduÀ_dïíds
[]

42 
__u£d


43 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

47 
MODULE_INFO
(
§cvîsi⁄
, "8CEF9927CF3E1E95930726A");

	@dm-bio-record.h

7 #i‚de‡
DM_BIO_RECORD_H


8 
	#DM_BIO_RECORD_H


	)

10 
	~<löux/bio.h
>

20 
	sdm_bio_dëaûs
 {

21 
block_devi˚
 *
	mbi_bdev
;

22 
	mbi_Êags
;

23 
bvec_ôî
 
	mbi_ôî
;

26 
ölöe
 
	$dm_bio_ªc‹d
(
dm_bio_dëaûs
 *
bd
, 
bio
 *bio)

28 
bd
->
bi_bdev
 = 
bio
->bi_bdev;

29 
bd
->
bi_Êags
 = 
bio
->bi_flags;

30 
bd
->
bi_ôî
 = 
bio
->bi_iter;

31 
	}
}

33 
ölöe
 
	$dm_bio_ª°‹e
(
dm_bio_dëaûs
 *
bd
, 
bio
 *bio)

35 
bio
->
bi_bdev
 = 
bd
->bi_bdev;

36 
bio
->
bi_Êags
 = 
bd
->bi_flags;

37 
bio
->
bi_ôî
 = 
bd
->bi_iter;

38 
	}
}

	@dm-bufio.c

9 
	~"dm-bufio.h
"

11 
	~<löux/devi˚-m≠≥r.h
>

12 
	~<löux/dm-io.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/shrökî.h
>

16 
	~<löux/moduÀ.h
>

18 
	#DM_MSG_PREFIX
 "bufio"

	)

28 
	#DM_BUFIO_MIN_BUFFERS
 8

	)

30 
	#DM_BUFIO_MEMORY_PERCENT
 2

	)

31 
	#DM_BUFIO_VMALLOC_PERCENT
 25

	)

32 
	#DM_BUFIO_WRITEBACK_PERCENT
 75

	)

37 
	#DM_BUFIO_WORK_TIMER_SECS
 10

	)

42 
	#DM_BUFIO_DEFAULT_AGE_SECS
 60

	)

48 
	#DM_BUFIO_INLINE_VECS
 16

	)

53 
	#DM_BUFIO_HASH_BITS
 20

	)

54 
	#DM_BUFIO_HASH
(
block
) \

55 ((((
block
Ë>> 
DM_BUFIO_HASH_BITS
) ^ (block)) & \

56 ((1 << 
DM_BUFIO_HASH_BITS
Ë- 1))

	)

62 
	#DM_BUFIO_BLOCK_SIZE_SLAB_LIMIT
 (
PAGE_SIZE
 >> 1)

	)

63 
	#DM_BUFIO_BLOCK_SIZE_GFP_LIMIT
 (
PAGE_SIZE
 << (
MAX_ORDER
 - 1))

	)

68 
	#LIST_CLEAN
 0

	)

69 
	#LIST_DIRTY
 1

	)

70 
	#LIST_SIZE
 2

	)

87 
	sdm_bufio_˛õ¡
 {

88 
muãx
 
	mlock
;

90 
li°_hód
 
	mÃu
[
LIST_SIZE
];

91 
	mn_buf„rs
[
LIST_SIZE
];

93 
block_devi˚
 *
	mbdev
;

94 
	mblock_size
;

95 
	m£˘‹s_≥r_block_bôs
;

96 
	m∑ges_≥r_block_bôs
;

97 
	mblocks_≥r_∑ge_bôs
;

98 
	maux_size
;

99 (*
	mÆloc_ˇŒback
)(
	mdm_buf„r
 *);

100 (*
	mwrôe_ˇŒback
)(
	mdm_buf„r
 *);

102 
dm_io_˛õ¡
 *
	mdm_io
;

104 
li°_hód
 
	mª£rved_buf„rs
;

105 
	m√ed_ª£rved_buf„rs
;

107 
	mmöimum_buf„rs
;

109 
hli°_hód
 *
	mˇche_hash
;

110 
waô_queue_hód_t
 
	m‰ì_buf„r_waô
;

112 
	masync_wrôe_îr‹
;

114 
li°_hód
 
	m˛õ¡_li°
;

115 
shrökî
 
	mshrökî
;

121 
	#B_READING
 0

	)

122 
	#B_WRITING
 1

	)

123 
	#B_DIRTY
 2

	)

130 
	ed©a_mode
 {

131 
	mDATA_MODE_SLAB
 = 0,

132 
	mDATA_MODE_GET_FREE_PAGES
 = 1,

133 
	mDATA_MODE_VMALLOC
 = 2,

134 
	mDATA_MODE_LIMIT
 = 3

137 
	sdm_buf„r
 {

138 
hli°_node
 
	mhash_li°
;

139 
li°_hód
 
	mÃu_li°
;

140 
£˘‹_t
 
	mblock
;

141 *
	md©a
;

142 
d©a_mode
 
	md©a_mode
;

143 
	mli°_mode
;

144 
	mhﬁd_cou¡
;

145 
	mªad_îr‹
;

146 
	mwrôe_îr‹
;

147 
	m°©e
;

148 
	mœ°_ac˚s£d
;

149 
dm_bufio_˛õ¡
 *
	mc
;

150 
li°_hód
 
	mwrôe_li°
;

151 
bio
 
	mbio
;

152 
bio_vec
 
	mbio_vec
[
DM_BUFIO_INLINE_VECS
];

157 
kmem_ˇche
 *
	gdm_bufio_ˇches
[
PAGE_SHIFT
 - 
SECTOR_SHIFT
];

158 *
	gdm_bufio_ˇche_«mes
[
PAGE_SHIFT
 - 
SECTOR_SHIFT
];

160 
ölöe
 
	$dm_bufio_ˇche_ödex
(
dm_bufio_˛õ¡
 *
c
)

162 
ªt
 = 
c
->
blocks_≥r_∑ge_bôs
 - 1;

164 
	`BUG_ON
(
ªt
 >
	`ARRAY_SIZE
(
dm_bufio_ˇches
));

166  
ªt
;

167 
	}
}

169 
	#DM_BUFIO_CACHE
(
c
Ë(
dm_bufio_ˇches
[
	`dm_bufio_ˇche_ödex
(c)])

	)

170 
	#DM_BUFIO_CACHE_NAME
(
c
Ë(
dm_bufio_ˇche_«mes
[
	`dm_bufio_ˇche_ödex
(c)])

	)

172 
	#dm_bufio_ö_ªque°
(Ë(!!
cuºít
->
bio_li°
)

	)

174 
	$dm_bufio_lock
(
dm_bufio_˛õ¡
 *
c
)

176 
	`muãx_lock_√°ed
(&
c
->
lock
, 
	`dm_bufio_ö_ªque°
());

177 
	}
}

179 
	$dm_bufio_åylock
(
dm_bufio_˛õ¡
 *
c
)

181  
	`muãx_åylock
(&
c
->
lock
);

182 
	}
}

184 
	$dm_bufio_u∆ock
(
dm_bufio_˛õ¡
 *
c
)

186 
	`muãx_u∆ock
(&
c
->
lock
);

187 
	}
}

192 #ifde‡
CONFIG_PREEMPT_VOLUNTARY


193 
	#dm_bufio_c⁄d_ªsched
() \

195 i‡(
	`u∆ikñy
(
	`√ed_ªsched
())) \

196 
	`_c⁄d_ªsched
(); \

197 } 0)

	)

199 
	#dm_bufio_c⁄d_ªsched
(Ëdÿ{ } 0)

	)

207 
	gdm_bufio_deÁu…_ˇche_size
;

212 
	gdm_bufio_ˇche_size
;

218 
	gdm_bufio_ˇche_size_œtch
;

220 
DEFINE_SPINLOCK
(
∑øm_•ölock
);

225 
	gdm_bufio_max_age
 = 
DM_BUFIO_DEFAULT_AGE_SECS
;

227 
	gdm_bufio_≥ak_Æloˇãd
;

228 
	gdm_bufio_Æloˇãd_kmem_ˇche
;

229 
	gdm_bufio_Æloˇãd_gë_‰ì_∑ges
;

230 
	gdm_bufio_Æloˇãd_vmÆloc
;

231 
	gdm_bufio_cuºít_Æloˇãd
;

238 
	gdm_bufio_ˇche_size_≥r_˛õ¡
;

243 
	gdm_bufio_˛õ¡_cou¡
;

248 
LIST_HEAD
(
dm_bufio_Æl_˛õ¡s
);

254 
DEFINE_MUTEX
(
dm_bufio_˛õ¡s_lock
);

258 
	$adju°_tŸÆ_Æloˇãd
(
d©a_mode
 d©a_mode, 
diff
)

260 * c⁄° 
˛ass_±r
[
DATA_MODE_LIMIT
] = {

261 &
dm_bufio_Æloˇãd_kmem_ˇche
,

262 &
dm_bufio_Æloˇãd_gë_‰ì_∑ges
,

263 &
dm_bufio_Æloˇãd_vmÆloc
,

266 
	`•ö_lock
(&
∑øm_•ölock
);

268 *
˛ass_±r
[
d©a_mode
] +
diff
;

270 
dm_bufio_cuºít_Æloˇãd
 +
diff
;

272 i‡(
dm_bufio_cuºít_Æloˇãd
 > 
dm_bufio_≥ak_Æloˇãd
)

273 
dm_bufio_≥ak_Æloˇãd
 = 
dm_bufio_cuºít_Æloˇãd
;

275 
	`•ö_u∆ock
(&
∑øm_•ölock
);

276 
	}
}

281 
	$__ˇche_size_ª‰esh
()

283 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_bufio_˛õ¡s_lock
));

284 
	`BUG_ON
(
dm_bufio_˛õ¡_cou¡
 < 0);

286 
dm_bufio_ˇche_size_œtch
 = 
	`ACCESS_ONCE
(
dm_bufio_ˇche_size
);

291 i‡(!
dm_bufio_ˇche_size_œtch
) {

292 ()
	`cmpxchg
(&
dm_bufio_ˇche_size
, 0,

293 
dm_bufio_deÁu…_ˇche_size
);

294 
dm_bufio_ˇche_size_œtch
 = 
dm_bufio_deÁu…_ˇche_size
;

297 
dm_bufio_ˇche_size_≥r_˛õ¡
 = 
dm_bufio_ˇche_size_œtch
 /

298 (
dm_bufio_˛õ¡_cou¡
 ? : 1);

299 
	}
}

322 *
	$Æloc_buf„r_d©a
(
dm_bufio_˛õ¡
 *
c
, 
gÂ_t
 
gÂ_mask
,

323 
d©a_mode
 *data_mode)

325 
noio_Êag
;

326 *
±r
;

328 i‡(
c
->
block_size
 <
DM_BUFIO_BLOCK_SIZE_SLAB_LIMIT
) {

329 *
d©a_mode
 = 
DATA_MODE_SLAB
;

330  
	`kmem_ˇche_Æloc
(
	`DM_BUFIO_CACHE
(
c
), 
gÂ_mask
);

333 i‡(
c
->
block_size
 <
DM_BUFIO_BLOCK_SIZE_GFP_LIMIT
 &&

334 
gÂ_mask
 & 
__GFP_NORETRY
) {

335 *
d©a_mode
 = 
DATA_MODE_GET_FREE_PAGES
;

336  (*)
	`__gë_‰ì_∑ges
(
gÂ_mask
,

337 
c
->
∑ges_≥r_block_bôs
);

340 *
d©a_mode
 = 
DATA_MODE_VMALLOC
;

352 i‡(
gÂ_mask
 & 
__GFP_NORETRY
)

353 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

355 
±r
 = 
	`__vmÆloc
(
c
->
block_size
, 
gÂ_mask
 | 
__GFP_HIGHMEM
, 
PAGE_KERNEL
);

357 i‡(
gÂ_mask
 & 
__GFP_NORETRY
)

358 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

360  
±r
;

361 
	}
}

366 
	$‰ì_buf„r_d©a
(
dm_bufio_˛õ¡
 *
c
,

367 *
d©a
, 
d©a_mode
 data_mode)

369 
d©a_mode
) {

370 
DATA_MODE_SLAB
:

371 
	`kmem_ˇche_‰ì
(
	`DM_BUFIO_CACHE
(
c
), 
d©a
);

374 
DATA_MODE_GET_FREE_PAGES
:

375 
	`‰ì_∑ges
(()
d©a
, 
c
->
∑ges_≥r_block_bôs
);

378 
DATA_MODE_VMALLOC
:

379 
	`v‰ì
(
d©a
);

383 
	`DMCRIT
("dm_bufio_free_buffer_data: bad data mode: %d",

384 
d©a_mode
);

385 
	`BUG
();

387 
	}
}

392 
dm_buf„r
 *
	$Æloc_buf„r
(
dm_bufio_˛õ¡
 *
c
, 
gÂ_t
 
gÂ_mask
)

394 
dm_buf„r
 *
b
 = 
	`kmÆloc
((dm_buf„rË+ 
c
->
aux_size
,

395 
gÂ_mask
);

397 i‡(!
b
)

398  
NULL
;

400 
b
->
c
 = c;

402 
b
->
d©a
 = 
	`Æloc_buf„r_d©a
(
c
, 
gÂ_mask
, &b->
d©a_mode
);

403 i‡(!
b
->
d©a
) {

404 
	`k‰ì
(
b
);

405  
NULL
;

408 
	`adju°_tŸÆ_Æloˇãd
(
b
->
d©a_mode
, ()
c
->
block_size
);

410  
b
;

411 
	}
}

416 
	$‰ì_buf„r
(
dm_buf„r
 *
b
)

418 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

420 
	`adju°_tŸÆ_Æloˇãd
(
b
->
d©a_mode
, -()
c
->
block_size
);

422 
	`‰ì_buf„r_d©a
(
c
, 
b
->
d©a
, b->
d©a_mode
);

423 
	`k‰ì
(
b
);

424 
	}
}

429 
	$__lök_buf„r
(
dm_buf„r
 *
b
, 
£˘‹_t
 
block
, 
dúty
)

431 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

433 
c
->
n_buf„rs
[
dúty
]++;

434 
b
->
block
 = block;

435 
b
->
li°_mode
 = 
dúty
;

436 
	`li°_add
(&
b
->
Ãu_li°
, &
c
->
Ãu
[
dúty
]);

437 
	`hli°_add_hód
(&
b
->
hash_li°
, &
c
->
ˇche_hash
[
	`DM_BUFIO_HASH
(
block
)]);

438 
b
->
œ°_ac˚s£d
 = 
jiffõs
;

439 
	}
}

444 
	$__u∆ök_buf„r
(
dm_buf„r
 *
b
)

446 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

448 
	`BUG_ON
(!
c
->
n_buf„rs
[
b
->
li°_mode
]);

450 
c
->
n_buf„rs
[
b
->
li°_mode
]--;

451 
	`hli°_dñ
(&
b
->
hash_li°
);

452 
	`li°_dñ
(&
b
->
Ãu_li°
);

453 
	}
}

458 
	$__ªlök_Ãu
(
dm_buf„r
 *
b
, 
dúty
)

460 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

462 
	`BUG_ON
(!
c
->
n_buf„rs
[
b
->
li°_mode
]);

464 
c
->
n_buf„rs
[
b
->
li°_mode
]--;

465 
c
->
n_buf„rs
[
dúty
]++;

466 
b
->
li°_mode
 = 
dúty
;

467 
	`li°_move
(&
b
->
Ãu_li°
, &
c
->
Ãu
[
dúty
]);

468 
	}
}

496 
	$dmio_com∂ëe
(
îr‹
, *
c⁄ãxt
)

498 
dm_buf„r
 *
b
 = 
c⁄ãxt
;

500 
b
->
bio
.
	`bi_íd_io
(&b->bio, 
îr‹
 ? -
EIO
 : 0);

501 
	}
}

503 
	$u£_dmio
(
dm_buf„r
 *
b
, 
rw
, 
£˘‹_t
 
block
,

504 
bio_íd_io_t
 *
íd_io
)

506 
r
;

507 
dm_io_ªque°
 
io_ªq
 = {

508 .
bi_rw
 = 
rw
,

509 .
nŸify
.
‚
 = 
dmio_com∂ëe
,

510 .
nŸify
.
c⁄ãxt
 = 
b
,

511 .
˛õ¡
 = 
b
->
c
->
dm_io
,

513 
dm_io_ªgi⁄
 
ªgi⁄
 = {

514 .
bdev
 = 
b
->
c
->bdev,

515 .
£˘‹
 = 
block
 << 
b
->
c
->
£˘‹s_≥r_block_bôs
,

516 .
cou¡
 = 
b
->
c
->
block_size
 >> 
SECTOR_SHIFT
,

519 i‡(
b
->
d©a_mode
 !
DATA_MODE_VMALLOC
) {

520 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

521 
io_ªq
.
mem
.
±r
.
addr
 = 
b
->
d©a
;

523 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_VMA
;

524 
io_ªq
.
mem
.
±r
.
vma
 = 
b
->
d©a
;

527 
b
->
bio
.
bi_íd_io
 = 
íd_io
;

529 
r
 = 
	`dm_io
(&
io_ªq
, 1, &
ªgi⁄
, 
NULL
);

530 i‡(
r
)

531 
	`íd_io
(&
b
->
bio
, 
r
);

532 
	}
}

534 
	$u£_ölöe_bio
(
dm_buf„r
 *
b
, 
rw
, 
£˘‹_t
 
block
,

535 
bio_íd_io_t
 *
íd_io
)

537 *
±r
;

538 
Àn
;

540 
	`bio_öô
(&
b
->
bio
);

541 
b
->
bio
.
bi_io_vec
 = b->
bio_vec
;

542 
b
->
bio
.
bi_max_vecs
 = 
DM_BUFIO_INLINE_VECS
;

543 
b
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
block
 << b->
c
->
£˘‹s_≥r_block_bôs
;

544 
b
->
bio
.
bi_bdev
 = b->
c
->
bdev
;

545 
b
->
bio
.
bi_íd_io
 = 
íd_io
;

551 
±r
 = 
b
->
d©a
;

552 
Àn
 = 
b
->
c
->
block_size
;

554 i‡(
Àn
 >
PAGE_SIZE
)

555 
	`BUG_ON
(()
±r
 & (
PAGE_SIZE
 - 1));

557 
	`BUG_ON
(()
±r
 & (
Àn
 - 1));

560 i‡(!
	`bio_add_∑ge
(&
b
->
bio
, 
	`vút_to_∑ge
(
±r
),

561 
Àn
 < 
PAGE_SIZE
 ?Üen : PAGE_SIZE,

562 
	`vút_to_phys
(
±r
Ë& (
PAGE_SIZE
 - 1))) {

563 
	`BUG_ON
(
b
->
c
->
block_size
 <
PAGE_SIZE
);

564 
	`u£_dmio
(
b
, 
rw
, 
block
, 
íd_io
);

568 
Àn
 -
PAGE_SIZE
;

569 
±r
 +
PAGE_SIZE
;

570 } 
Àn
 > 0);

572 
	`submô_bio
(
rw
, &
b
->
bio
);

573 
	}
}

575 
	$submô_io
(
dm_buf„r
 *
b
, 
rw
, 
£˘‹_t
 
block
,

576 
bio_íd_io_t
 *
íd_io
)

578 i‡(
rw
 =
WRITE
 && 
b
->
c
->
wrôe_ˇŒback
)

579 
b
->
c
->
	`wrôe_ˇŒback
(b);

581 i‡(
b
->
c
->
block_size
 <
DM_BUFIO_INLINE_VECS
 * 
PAGE_SIZE
 &&

582 
b
->
d©a_mode
 !
DATA_MODE_VMALLOC
)

583 
	`u£_ölöe_bio
(
b
, 
rw
, 
block
, 
íd_io
);

585 
	`u£_dmio
(
b
, 
rw
, 
block
, 
íd_io
);

586 
	}
}

598 
	$wrôe_ídio
(
bio
 *bio, 
îr‹
)

600 
dm_buf„r
 *
b
 = 
	`c⁄èöî_of
(
bio
, dm_buffer, bio);

602 
b
->
wrôe_îr‹
 = 
îr‹
;

603 i‡(
	`u∆ikñy
(
îr‹
)) {

604 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

605 ()
	`cmpxchg
(&
c
->
async_wrôe_îr‹
, 0, 
îr‹
);

608 
	`BUG_ON
(!
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
));

610 
	`smp_mb__bef‹e_©omic
();

611 
	`˛ór_bô
(
B_WRITING
, &
b
->
°©e
);

612 
	`smp_mb__a·î_©omic
();

614 
	`wake_up_bô
(&
b
->
°©e
, 
B_WRITING
);

615 
	}
}

626 
	$__wrôe_dúty_buf„r
(
dm_buf„r
 *
b
,

627 
li°_hód
 *
wrôe_li°
)

629 i‡(!
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
))

632 
	`˛ór_bô
(
B_DIRTY
, &
b
->
°©e
);

633 
	`waô_⁄_bô_lock_io
(&
b
->
°©e
, 
B_WRITING
, 
TASK_UNINTERRUPTIBLE
);

635 i‡(!
wrôe_li°
)

636 
	`submô_io
(
b
, 
WRITE
, b->
block
, 
wrôe_ídio
);

638 
	`li°_add_èû
(&
b
->
wrôe_li°
, write_list);

639 
	}
}

641 
	$__Êush_wrôe_li°
(
li°_hód
 *
wrôe_li°
)

643 
blk_∂ug
 
∂ug
;

644 
	`blk_°¨t_∂ug
(&
∂ug
);

645 !
	`li°_em±y
(
wrôe_li°
)) {

646 
dm_buf„r
 *
b
 =

647 
	`li°_íåy
(
wrôe_li°
->
√xt
, 
dm_buf„r
, write_list);

648 
	`li°_dñ
(&
b
->
wrôe_li°
);

649 
	`submô_io
(
b
, 
WRITE
, b->
block
, 
wrôe_ídio
);

650 
	`dm_bufio_c⁄d_ªsched
();

652 
	`blk_föish_∂ug
(&
∂ug
);

653 
	}
}

660 
	$__make_buf„r_˛ón
(
dm_buf„r
 *
b
)

662 
	`BUG_ON
(
b
->
hﬁd_cou¡
);

664 i‡(!
b
->
°©e
)

667 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_READING
, 
TASK_UNINTERRUPTIBLE
);

668 
	`__wrôe_dúty_buf„r
(
b
, 
NULL
);

669 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_WRITING
, 
TASK_UNINTERRUPTIBLE
);

670 
	}
}

676 
dm_buf„r
 *
	$__gë_un˛aimed_buf„r
(
dm_bufio_˛õ¡
 *
c
)

678 
dm_buf„r
 *
b
;

680 
	`li°_f‹_óch_íåy_ªvî£
(
b
, &
c
->
Ãu
[
LIST_CLEAN
], 
Ãu_li°
) {

681 
	`BUG_ON
(
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
));

682 
	`BUG_ON
(
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
));

684 i‡(!
b
->
hﬁd_cou¡
) {

685 
	`__make_buf„r_˛ón
(
b
);

686 
	`__u∆ök_buf„r
(
b
);

687  
b
;

689 
	`dm_bufio_c⁄d_ªsched
();

692 
	`li°_f‹_óch_íåy_ªvî£
(
b
, &
c
->
Ãu
[
LIST_DIRTY
], 
Ãu_li°
) {

693 
	`BUG_ON
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

695 i‡(!
b
->
hﬁd_cou¡
) {

696 
	`__make_buf„r_˛ón
(
b
);

697 
	`__u∆ök_buf„r
(
b
);

698  
b
;

700 
	`dm_bufio_c⁄d_ªsched
();

703  
NULL
;

704 
	}
}

713 
	$__waô_f‹_‰ì_buf„r
(
dm_bufio_˛õ¡
 *
c
)

715 
	`DECLARE_WAITQUEUE
(
waô
, 
cuºít
);

717 
	`add_waô_queue
(&
c
->
‰ì_buf„r_waô
, &
waô
);

718 
	`£t_èsk_°©e
(
cuºít
, 
TASK_UNINTERRUPTIBLE
);

719 
	`dm_bufio_u∆ock
(
c
);

721 
	`io_scheduÀ
();

723 
	`£t_èsk_°©e
(
cuºít
, 
TASK_RUNNING
);

724 
	`ªmove_waô_queue
(&
c
->
‰ì_buf„r_waô
, &
waô
);

726 
	`dm_bufio_lock
(
c
);

727 
	}
}

729 
	e√w_Êag
 {

730 
	mNF_FRESH
 = 0,

731 
	mNF_READ
 = 1,

732 
	mNF_GET
 = 2,

733 
	mNF_PREFETCH
 = 3

742 
dm_buf„r
 *
	$__Æloc_buf„r_waô_no_ˇŒback
(
dm_bufio_˛õ¡
 *
c
, 
√w_Êag
 
nf
)

744 
dm_buf„r
 *
b
;

759 i‡(
dm_bufio_ˇche_size_œtch
 != 1) {

760 
b
 = 
	`Æloc_buf„r
(
c
, 
GFP_NOIO
 | 
__GFP_NORETRY
 | 
__GFP_NOMEMALLOC
 | 
__GFP_NOWARN
);

761 i‡(
b
)

762  
b
;

765 i‡(
nf
 =
NF_PREFETCH
)

766  
NULL
;

768 i‡(!
	`li°_em±y
(&
c
->
ª£rved_buf„rs
)) {

769 
b
 = 
	`li°_íåy
(
c
->
ª£rved_buf„rs
.
√xt
,

770 
dm_buf„r
, 
Ãu_li°
);

771 
	`li°_dñ
(&
b
->
Ãu_li°
);

772 
c
->
√ed_ª£rved_buf„rs
++;

774  
b
;

777 
b
 = 
	`__gë_un˛aimed_buf„r
(
c
);

778 i‡(
b
)

779  
b
;

781 
	`__waô_f‹_‰ì_buf„r
(
c
);

783 
	}
}

785 
dm_buf„r
 *
	$__Æloc_buf„r_waô
(
dm_bufio_˛õ¡
 *
c
, 
√w_Êag
 
nf
)

787 
dm_buf„r
 *
b
 = 
	`__Æloc_buf„r_waô_no_ˇŒback
(
c
, 
nf
);

789 i‡(!
b
)

790  
NULL
;

792 i‡(
c
->
Æloc_ˇŒback
)

793 
c
->
	`Æloc_ˇŒback
(
b
);

795  
b
;

796 
	}
}

801 
	$__‰ì_buf„r_wake
(
dm_buf„r
 *
b
)

803 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

805 i‡(!
c
->
√ed_ª£rved_buf„rs
)

806 
	`‰ì_buf„r
(
b
);

808 
	`li°_add
(&
b
->
Ãu_li°
, &
c
->
ª£rved_buf„rs
);

809 
c
->
√ed_ª£rved_buf„rs
--;

812 
	`wake_up
(&
c
->
‰ì_buf„r_waô
);

813 
	}
}

815 
	$__wrôe_dúty_buf„rs_async
(
dm_bufio_˛õ¡
 *
c
, 
no_waô
,

816 
li°_hód
 *
wrôe_li°
)

818 
dm_buf„r
 *
b
, *
tmp
;

820 
	`li°_f‹_óch_íåy_ß„_ªvî£
(
b
, 
tmp
, &
c
->
Ãu
[
LIST_DIRTY
], 
Ãu_li°
) {

821 
	`BUG_ON
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

823 i‡(!
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
) &&

824 !
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
)) {

825 
	`__ªlök_Ãu
(
b
, 
LIST_CLEAN
);

829 i‡(
no_waô
 && 
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
))

832 
	`__wrôe_dúty_buf„r
(
b
, 
wrôe_li°
);

833 
	`dm_bufio_c⁄d_ªsched
();

835 
	}
}

840 
	$__gë_mem‹y_limô
(
dm_bufio_˛õ¡
 *
c
,

841 *
thªshﬁd_buf„rs
,

842 *
limô_buf„rs
)

844 
buf„rs
;

846 i‡(
	`ACCESS_ONCE
(
dm_bufio_ˇche_size
Ë!
dm_bufio_ˇche_size_œtch
) {

847 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

848 
	`__ˇche_size_ª‰esh
();

849 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

852 
buf„rs
 = 
dm_bufio_ˇche_size_≥r_˛õ¡
 >>

853 (
c
->
£˘‹s_≥r_block_bôs
 + 
SECTOR_SHIFT
);

855 i‡(
buf„rs
 < 
c
->
möimum_buf„rs
)

856 
buf„rs
 = 
c
->
möimum_buf„rs
;

858 *
limô_buf„rs
 = 
buf„rs
;

859 *
thªshﬁd_buf„rs
 = 
buf„rs
 * 
DM_BUFIO_WRITEBACK_PERCENT
 / 100;

860 
	}
}

867 
	$__check_w©îm¨k
(
dm_bufio_˛õ¡
 *
c
,

868 
li°_hód
 *
wrôe_li°
)

870 
thªshﬁd_buf„rs
, 
limô_buf„rs
;

872 
	`__gë_mem‹y_limô
(
c
, &
thªshﬁd_buf„rs
, &
limô_buf„rs
);

874 
c
->
n_buf„rs
[
LIST_CLEAN
] + c->n_buf„rs[
LIST_DIRTY
] >

875 
limô_buf„rs
) {

877 
dm_buf„r
 *
b
 = 
	`__gë_un˛aimed_buf„r
(
c
);

879 i‡(!
b
)

882 
	`__‰ì_buf„r_wake
(
b
);

883 
	`dm_bufio_c⁄d_ªsched
();

886 i‡(
c
->
n_buf„rs
[
LIST_DIRTY
] > 
thªshﬁd_buf„rs
)

887 
	`__wrôe_dúty_buf„rs_async
(
c
, 1, 
wrôe_li°
);

888 
	}
}

893 
dm_buf„r
 *
	$__föd
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
)

895 
dm_buf„r
 *
b
;

897 
	`hli°_f‹_óch_íåy
(
b
, &
c
->
ˇche_hash
[
	`DM_BUFIO_HASH
(
block
)],

898 
hash_li°
) {

899 
	`dm_bufio_c⁄d_ªsched
();

900 i‡(
b
->
block
 == block)

901  
b
;

904  
NULL
;

905 
	}
}

911 
dm_buf„r
 *
	$__bufio_√w
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

912 
√w_Êag
 
nf
, *
√ed_submô
,

913 
li°_hód
 *
wrôe_li°
)

915 
dm_buf„r
 *
b
, *
√w_b
 = 
NULL
;

917 *
√ed_submô
 = 0;

919 
b
 = 
	`__föd
(
c
, 
block
);

920 i‡(
b
)

921 
found_buf„r
;

923 i‡(
nf
 =
NF_GET
)

924  
NULL
;

926 
√w_b
 = 
	`__Æloc_buf„r_waô
(
c
, 
nf
);

927 i‡(!
√w_b
)

928  
NULL
;

934 
b
 = 
	`__föd
(
c
, 
block
);

935 i‡(
b
) {

936 
	`__‰ì_buf„r_wake
(
√w_b
);

937 
found_buf„r
;

940 
	`__check_w©îm¨k
(
c
, 
wrôe_li°
);

942 
b
 = 
√w_b
;

943 
b
->
hﬁd_cou¡
 = 1;

944 
b
->
ªad_îr‹
 = 0;

945 
b
->
wrôe_îr‹
 = 0;

946 
	`__lök_buf„r
(
b
, 
block
, 
LIST_CLEAN
);

948 i‡(
nf
 =
NF_FRESH
) {

949 
b
->
°©e
 = 0;

950  
b
;

953 
b
->
°©e
 = 1 << 
B_READING
;

954 *
√ed_submô
 = 1;

956  
b
;

958 
found_buf„r
:

959 i‡(
nf
 =
NF_PREFETCH
)

960  
NULL
;

968 i‡(
nf
 =
NF_GET
 && 
	`u∆ikñy
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
)))

969  
NULL
;

971 
b
->
hﬁd_cou¡
++;

972 
	`__ªlök_Ãu
(
b
, 
	`ã°_bô
(
B_DIRTY
, &b->
°©e
) ||

973 
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
));

974  
b
;

975 
	}
}

981 
	$ªad_ídio
(
bio
 *bio, 
îr‹
)

983 
dm_buf„r
 *
b
 = 
	`c⁄èöî_of
(
bio
, dm_buffer, bio);

985 
b
->
ªad_îr‹
 = 
îr‹
;

987 
	`BUG_ON
(!
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

989 
	`smp_mb__bef‹e_©omic
();

990 
	`˛ór_bô
(
B_READING
, &
b
->
°©e
);

991 
	`smp_mb__a·î_©omic
();

993 
	`wake_up_bô
(&
b
->
°©e
, 
B_READING
);

994 
	}
}

1002 *
	$√w_ªad
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

1003 
√w_Êag
 
nf
, 
dm_buf„r
 **
bp
)

1005 
√ed_submô
;

1006 
dm_buf„r
 *
b
;

1008 
	`LIST_HEAD
(
wrôe_li°
);

1010 
	`dm_bufio_lock
(
c
);

1011 
b
 = 
	`__bufio_√w
(
c
, 
block
, 
nf
, &
√ed_submô
, &
wrôe_li°
);

1012 
	`dm_bufio_u∆ock
(
c
);

1014 
	`__Êush_wrôe_li°
(&
wrôe_li°
);

1016 i‡(!
b
)

1017  
b
;

1019 i‡(
√ed_submô
)

1020 
	`submô_io
(
b
, 
READ
, b->
block
, 
ªad_ídio
);

1022 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_READING
, 
TASK_UNINTERRUPTIBLE
);

1024 i‡(
b
->
ªad_îr‹
) {

1025 
îr‹
 = 
b
->
ªad_îr‹
;

1027 
	`dm_bufio_ªÀa£
(
b
);

1029  
	`ERR_PTR
(
îr‹
);

1032 *
bp
 = 
b
;

1034  
b
->
d©a
;

1035 
	}
}

1037 *
	$dm_bufio_gë
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

1038 
dm_buf„r
 **
bp
)

1040  
	`√w_ªad
(
c
, 
block
, 
NF_GET
, 
bp
);

1041 
	}
}

1042 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë
);

1044 *
	$dm_bufio_ªad
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

1045 
dm_buf„r
 **
bp
)

1047 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1049  
	`√w_ªad
(
c
, 
block
, 
NF_READ
, 
bp
);

1050 
	}
}

1051 
EXPORT_SYMBOL_GPL
(
dm_bufio_ªad
);

1053 *
	$dm_bufio_√w
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

1054 
dm_buf„r
 **
bp
)

1056 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1058  
	`√w_ªad
(
c
, 
block
, 
NF_FRESH
, 
bp
);

1059 
	}
}

1060 
EXPORT_SYMBOL_GPL
(
dm_bufio_√w
);

1062 
	$dm_bufio_¥e„tch
(
dm_bufio_˛õ¡
 *
c
,

1063 
£˘‹_t
 
block
, 
n_blocks
)

1065 
blk_∂ug
 
∂ug
;

1067 
	`LIST_HEAD
(
wrôe_li°
);

1069 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1071 
	`blk_°¨t_∂ug
(&
∂ug
);

1072 
	`dm_bufio_lock
(
c
);

1074 ; 
n_blocks
--; 
block
++) {

1075 
√ed_submô
;

1076 
dm_buf„r
 *
b
;

1077 
b
 = 
	`__bufio_√w
(
c
, 
block
, 
NF_PREFETCH
, &
√ed_submô
,

1078 &
wrôe_li°
);

1079 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
wrôe_li°
))) {

1080 
	`dm_bufio_u∆ock
(
c
);

1081 
	`blk_föish_∂ug
(&
∂ug
);

1082 
	`__Êush_wrôe_li°
(&
wrôe_li°
);

1083 
	`blk_°¨t_∂ug
(&
∂ug
);

1084 
	`dm_bufio_lock
(
c
);

1086 i‡(
	`u∆ikñy
(
b
 !
NULL
)) {

1087 
	`dm_bufio_u∆ock
(
c
);

1089 i‡(
√ed_submô
)

1090 
	`submô_io
(
b
, 
READ
, b->
block
, 
ªad_ídio
);

1091 
	`dm_bufio_ªÀa£
(
b
);

1093 
	`dm_bufio_c⁄d_ªsched
();

1095 i‡(!
n_blocks
)

1096 
Êush_∂ug
;

1097 
	`dm_bufio_lock
(
c
);

1101 
	`dm_bufio_u∆ock
(
c
);

1103 
Êush_∂ug
:

1104 
	`blk_föish_∂ug
(&
∂ug
);

1105 
	}
}

1106 
EXPORT_SYMBOL_GPL
(
dm_bufio_¥e„tch
);

1108 
	$dm_bufio_ªÀa£
(
dm_buf„r
 *
b
)

1110 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

1112 
	`dm_bufio_lock
(
c
);

1114 
	`BUG_ON
(!
b
->
hﬁd_cou¡
);

1116 
b
->
hﬁd_cou¡
--;

1117 i‡(!
b
->
hﬁd_cou¡
) {

1118 
	`wake_up
(&
c
->
‰ì_buf„r_waô
);

1125 i‡((
b
->
ªad_îr‹
 || b->
wrôe_îr‹
) &&

1126 !
	`ã°_bô
(
B_READING
, &
b
->
°©e
) &&

1127 !
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
) &&

1128 !
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
)) {

1129 
	`__u∆ök_buf„r
(
b
);

1130 
	`__‰ì_buf„r_wake
(
b
);

1134 
	`dm_bufio_u∆ock
(
c
);

1135 
	}
}

1136 
EXPORT_SYMBOL_GPL
(
dm_bufio_ªÀa£
);

1138 
	$dm_bufio_m¨k_buf„r_dúty
(
dm_buf„r
 *
b
)

1140 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

1142 
	`dm_bufio_lock
(
c
);

1144 
	`BUG_ON
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

1146 i‡(!
	`ã°_™d_£t_bô
(
B_DIRTY
, &
b
->
°©e
))

1147 
	`__ªlök_Ãu
(
b
, 
LIST_DIRTY
);

1149 
	`dm_bufio_u∆ock
(
c
);

1150 
	}
}

1151 
EXPORT_SYMBOL_GPL
(
dm_bufio_m¨k_buf„r_dúty
);

1153 
	$dm_bufio_wrôe_dúty_buf„rs_async
(
dm_bufio_˛õ¡
 *
c
)

1155 
	`LIST_HEAD
(
wrôe_li°
);

1157 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1159 
	`dm_bufio_lock
(
c
);

1160 
	`__wrôe_dúty_buf„rs_async
(
c
, 0, &
wrôe_li°
);

1161 
	`dm_bufio_u∆ock
(
c
);

1162 
	`__Êush_wrôe_li°
(&
wrôe_li°
);

1163 
	}
}

1164 
EXPORT_SYMBOL_GPL
(
dm_bufio_wrôe_dúty_buf„rs_async
);

1173 
	$dm_bufio_wrôe_dúty_buf„rs
(
dm_bufio_˛õ¡
 *
c
)

1175 
a
, 
f
;

1176 
buf„rs_¥o˚s£d
 = 0;

1177 
dm_buf„r
 *
b
, *
tmp
;

1179 
	`LIST_HEAD
(
wrôe_li°
);

1181 
	`dm_bufio_lock
(
c
);

1182 
	`__wrôe_dúty_buf„rs_async
(
c
, 0, &
wrôe_li°
);

1183 
	`dm_bufio_u∆ock
(
c
);

1184 
	`__Êush_wrôe_li°
(&
wrôe_li°
);

1185 
	`dm_bufio_lock
(
c
);

1187 
agaö
:

1188 
	`li°_f‹_óch_íåy_ß„_ªvî£
(
b
, 
tmp
, &
c
->
Ãu
[
LIST_DIRTY
], 
Ãu_li°
) {

1189 
dr›≥d_lock
 = 0;

1191 i‡(
buf„rs_¥o˚s£d
 < 
c
->
n_buf„rs
[
LIST_DIRTY
])

1192 
buf„rs_¥o˚s£d
++;

1194 
	`BUG_ON
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

1196 i‡(
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
)) {

1197 i‡(
buf„rs_¥o˚s£d
 < 
c
->
n_buf„rs
[
LIST_DIRTY
]) {

1198 
dr›≥d_lock
 = 1;

1199 
b
->
hﬁd_cou¡
++;

1200 
	`dm_bufio_u∆ock
(
c
);

1201 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_WRITING
,

1202 
TASK_UNINTERRUPTIBLE
);

1203 
	`dm_bufio_lock
(
c
);

1204 
b
->
hﬁd_cou¡
--;

1206 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_WRITING
,

1207 
TASK_UNINTERRUPTIBLE
);

1210 i‡(!
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
) &&

1211 !
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
))

1212 
	`__ªlök_Ãu
(
b
, 
LIST_CLEAN
);

1214 
	`dm_bufio_c⁄d_ªsched
();

1230 i‡(
dr›≥d_lock
)

1231 
agaö
;

1233 
	`wake_up
(&
c
->
‰ì_buf„r_waô
);

1234 
	`dm_bufio_u∆ock
(
c
);

1236 
a
 = 
	`xchg
(&
c
->
async_wrôe_îr‹
, 0);

1237 
f
 = 
	`dm_bufio_issue_Êush
(
c
);

1238 i‡(
a
)

1239  
a
;

1241  
f
;

1242 
	}
}

1243 
EXPORT_SYMBOL_GPL
(
dm_bufio_wrôe_dúty_buf„rs
);

1248 
	$dm_bufio_issue_Êush
(
dm_bufio_˛õ¡
 *
c
)

1250 
dm_io_ªque°
 
io_ªq
 = {

1251 .
bi_rw
 = 
WRITE_FLUSH
,

1252 .
mem
.
ty≥
 = 
DM_IO_KMEM
,

1253 .
mem
.
±r
.
addr
 = 
NULL
,

1254 .
˛õ¡
 = 
c
->
dm_io
,

1256 
dm_io_ªgi⁄
 
io_ªg
 = {

1257 .
bdev
 = 
c
->bdev,

1258 .
£˘‹
 = 0,

1259 .
cou¡
 = 0,

1262 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1264  
	`dm_io
(&
io_ªq
, 1, &
io_ªg
, 
NULL
);

1265 
	}
}

1266 
EXPORT_SYMBOL_GPL
(
dm_bufio_issue_Êush
);

1280 
	$dm_bufio_ªÀa£_move
(
dm_buf„r
 *
b
, 
£˘‹_t
 
√w_block
)

1282 
dm_bufio_˛õ¡
 *
c
 = 
b
->c;

1283 
dm_buf„r
 *
√w
;

1285 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1287 
	`dm_bufio_lock
(
c
);

1289 
ªåy
:

1290 
√w
 = 
	`__föd
(
c
, 
√w_block
);

1291 i‡(
√w
) {

1292 i‡(
√w
->
hﬁd_cou¡
) {

1293 
	`__waô_f‹_‰ì_buf„r
(
c
);

1294 
ªåy
;

1301 
	`__make_buf„r_˛ón
(
√w
);

1302 
	`__u∆ök_buf„r
(
√w
);

1303 
	`__‰ì_buf„r_wake
(
√w
);

1306 
	`BUG_ON
(!
b
->
hﬁd_cou¡
);

1307 
	`BUG_ON
(
	`ã°_bô
(
B_READING
, &
b
->
°©e
));

1309 
	`__wrôe_dúty_buf„r
(
b
, 
NULL
);

1310 i‡(
b
->
hﬁd_cou¡
 == 1) {

1311 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_WRITING
,

1312 
TASK_UNINTERRUPTIBLE
);

1313 
	`£t_bô
(
B_DIRTY
, &
b
->
°©e
);

1314 
	`__u∆ök_buf„r
(
b
);

1315 
	`__lök_buf„r
(
b
, 
√w_block
, 
LIST_DIRTY
);

1317 
£˘‹_t
 
ﬁd_block
;

1318 
	`waô_⁄_bô_lock_io
(&
b
->
°©e
, 
B_WRITING
,

1319 
TASK_UNINTERRUPTIBLE
);

1327 
ﬁd_block
 = 
b
->
block
;

1328 
	`__u∆ök_buf„r
(
b
);

1329 
	`__lök_buf„r
(
b
, 
√w_block
, b->
li°_mode
);

1330 
	`submô_io
(
b
, 
WRITE
, 
√w_block
, 
wrôe_ídio
);

1331 
	`waô_⁄_bô_io
(&
b
->
°©e
, 
B_WRITING
,

1332 
TASK_UNINTERRUPTIBLE
);

1333 
	`__u∆ök_buf„r
(
b
);

1334 
	`__lök_buf„r
(
b
, 
ﬁd_block
, b->
li°_mode
);

1337 
	`dm_bufio_u∆ock
(
c
);

1338 
	`dm_bufio_ªÀa£
(
b
);

1339 
	}
}

1340 
EXPORT_SYMBOL_GPL
(
dm_bufio_ªÀa£_move
);

1348 
	$dm_bufio_f‹gë
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
)

1350 
dm_buf„r
 *
b
;

1352 
	`dm_bufio_lock
(
c
);

1354 
b
 = 
	`__föd
(
c
, 
block
);

1355 i‡(
b
 && 
	`likñy
(!b->
hﬁd_cou¡
Ë&&Üikñy(!b->
°©e
)) {

1356 
	`__u∆ök_buf„r
(
b
);

1357 
	`__‰ì_buf„r_wake
(
b
);

1360 
	`dm_bufio_u∆ock
(
c
);

1361 
	}
}

1362 
EXPORT_SYMBOL
(
dm_bufio_f‹gë
);

1364 
	$dm_bufio_£t_möimum_buf„rs
(
dm_bufio_˛õ¡
 *
c
, 
n
)

1366 
c
->
möimum_buf„rs
 = 
n
;

1367 
	}
}

1368 
EXPORT_SYMBOL
(
dm_bufio_£t_möimum_buf„rs
);

1370 
	$dm_bufio_gë_block_size
(
dm_bufio_˛õ¡
 *
c
)

1372  
c
->
block_size
;

1373 
	}
}

1374 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_block_size
);

1376 
£˘‹_t
 
	$dm_bufio_gë_devi˚_size
(
dm_bufio_˛õ¡
 *
c
)

1378  
	`i_size_ªad
(
c
->
bdev
->
bd_öode
) >>

1379 (
SECTOR_SHIFT
 + 
c
->
£˘‹s_≥r_block_bôs
);

1380 
	}
}

1381 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_devi˚_size
);

1383 
£˘‹_t
 
	$dm_bufio_gë_block_numbî
(
dm_buf„r
 *
b
)

1385  
b
->
block
;

1386 
	}
}

1387 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_block_numbî
);

1389 *
	$dm_bufio_gë_block_d©a
(
dm_buf„r
 *
b
)

1391  
b
->
d©a
;

1392 
	}
}

1393 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_block_d©a
);

1395 *
	$dm_bufio_gë_aux_d©a
(
dm_buf„r
 *
b
)

1397  
b
 + 1;

1398 
	}
}

1399 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_aux_d©a
);

1401 
dm_bufio_˛õ¡
 *
	$dm_bufio_gë_˛õ¡
(
dm_buf„r
 *
b
)

1403  
b
->
c
;

1404 
	}
}

1405 
EXPORT_SYMBOL_GPL
(
dm_bufio_gë_˛õ¡
);

1407 
	$dr›_buf„rs
(
dm_bufio_˛õ¡
 *
c
)

1409 
dm_buf„r
 *
b
;

1410 
i
;

1412 
	`BUG_ON
(
	`dm_bufio_ö_ªque°
());

1417 
	`dm_bufio_wrôe_dúty_buf„rs_async
(
c
);

1419 
	`dm_bufio_lock
(
c
);

1421 (
b
 = 
	`__gë_un˛aimed_buf„r
(
c
)))

1422 
	`__‰ì_buf„r_wake
(
b
);

1424 
i
 = 0; i < 
LIST_SIZE
; i++)

1425 
	`li°_f‹_óch_íåy
(
b
, &
c
->
Ãu
[
i
], 
Ãu_li°
)

1426 
	`DMERR
("leaked buffer %llx, hold count %u,Üist %d",

1427 ()
b
->
block
, b->
hﬁd_cou¡
, 
i
);

1429 
i
 = 0; i < 
LIST_SIZE
; i++)

1430 
	`BUG_ON
(!
	`li°_em±y
(&
c
->
Ãu
[
i
]));

1432 
	`dm_bufio_u∆ock
(
c
);

1433 
	}
}

1441 
	$__˛ónup_ﬁd_buf„r
(
dm_buf„r
 *
b
, 
gÂ_t
 
gÂ
,

1442 
max_jiffõs
)

1444 i‡(
jiffõs
 - 
b
->
œ°_ac˚s£d
 < 
max_jiffõs
)

1447 i‡(!(
gÂ
 & 
__GFP_IO
)) {

1448 i‡(
	`ã°_bô
(
B_READING
, &
b
->
°©e
) ||

1449 
	`ã°_bô
(
B_WRITING
, &
b
->
°©e
) ||

1450 
	`ã°_bô
(
B_DIRTY
, &
b
->
°©e
))

1454 i‡(
b
->
hﬁd_cou¡
)

1457 
	`__make_buf„r_˛ón
(
b
);

1458 
	`__u∆ök_buf„r
(
b
);

1459 
	`__‰ì_buf„r_wake
(
b
);

1462 
	}
}

1464 
	$__sˇn
(
dm_bufio_˛õ¡
 *
c
, 
ƒ_to_sˇn
,

1465 
gÂ_t
 
gÂ_mask
)

1467 
l
;

1468 
dm_buf„r
 *
b
, *
tmp
;

1469 
‰ìd
 = 0;

1471 
l
 = 0;Ü < 
LIST_SIZE
;Ü++) {

1472 
	`li°_f‹_óch_íåy_ß„_ªvî£
(
b
, 
tmp
, &
c
->
Ãu
[
l
], 
Ãu_li°
) {

1473 
‰ìd
 +
	`__˛ónup_ﬁd_buf„r
(
b
, 
gÂ_mask
, 0);

1474 i‡(!--
ƒ_to_sˇn
)

1477 
	`dm_bufio_c⁄d_ªsched
();

1479  
‰ìd
;

1480 
	}
}

1483 
	$dm_bufio_shrök_sˇn
(
shrökî
 *
shrök
, 
shrök_c⁄åﬁ
 *
sc
)

1485 
dm_bufio_˛õ¡
 *
c
;

1486 
‰ìd
;

1488 
c
 = 
	`c⁄èöî_of
(
shrök
, 
dm_bufio_˛õ¡
, 
shrökî
);

1489 i‡(
sc
->
gÂ_mask
 & 
__GFP_IO
)

1490 
	`dm_bufio_lock
(
c
);

1491 i‡(!
	`dm_bufio_åylock
(
c
))

1492  
SHRINK_STOP
;

1494 
‰ìd
 = 
	`__sˇn
(
c
, 
sc
->
ƒ_to_sˇn
, sc->
gÂ_mask
);

1495 
	`dm_bufio_u∆ock
(
c
);

1496  
‰ìd
;

1497 
	}
}

1500 
	$dm_bufio_shrök_cou¡
(
shrökî
 *
shrök
, 
shrök_c⁄åﬁ
 *
sc
)

1502 
dm_bufio_˛õ¡
 *
c
;

1503 
cou¡
;

1505 
c
 = 
	`c⁄èöî_of
(
shrök
, 
dm_bufio_˛õ¡
, 
shrökî
);

1506 i‡(
sc
->
gÂ_mask
 & 
__GFP_IO
)

1507 
	`dm_bufio_lock
(
c
);

1508 i‡(!
	`dm_bufio_åylock
(
c
))

1511 
cou¡
 = 
c
->
n_buf„rs
[
LIST_CLEAN
] + c->n_buf„rs[
LIST_DIRTY
];

1512 
	`dm_bufio_u∆ock
(
c
);

1513  
cou¡
;

1514 
	}
}

1519 
dm_bufio_˛õ¡
 *
dm_bufio_˛õ¡_¸óã
(
block_devi˚
 *
bdev
, 
block_size
,

1520 
ª£rved_buf„rs
, 
aux_size
,

1521 (*
Æloc_ˇŒback
)(
dm_buf„r
 *),

1522 (*
wrôe_ˇŒback
)(
dm_buf„r
 *))

1524 
r
;

1525 
dm_bufio_˛õ¡
 *
c
;

1526 
i
;

1528 
	`BUG_ON
(
block_size
 < 1 << 
SECTOR_SHIFT
 ||

1529 (
block_size
 & (block_size - 1)));

1531 
c
 = 
	`kzÆloc
((*c), 
GFP_KERNEL
);

1532 i‡(!
c
) {

1533 
r
 = -
ENOMEM
;

1534 
bad_˛õ¡
;

1536 
c
->
ˇche_hash
 = 
	`vmÆloc
((
hli°_hód
Ë<< 
DM_BUFIO_HASH_BITS
);

1537 i‡(!
c
->
ˇche_hash
) {

1538 
r
 = -
ENOMEM
;

1539 
bad_hash
;

1542 
c
->
bdev
 = bdev;

1543 
c
->
block_size
 = block_size;

1544 
c
->
£˘‹s_≥r_block_bôs
 = 
	`ffs
(
block_size
Ë- 1 - 
SECTOR_SHIFT
;

1545 
c
->
∑ges_≥r_block_bôs
 = (
	`ffs
(
block_size
Ë- 1 >
PAGE_SHIFT
) ?

1546 
	`ffs
(
block_size
Ë- 1 - 
PAGE_SHIFT
 : 0;

1547 
c
->
blocks_≥r_∑ge_bôs
 = (
	`ffs
(
block_size
Ë- 1 < 
PAGE_SHIFT
 ?

1548 
PAGE_SHIFT
 - (
	`ffs
(
block_size
) - 1) : 0);

1550 
c
->
aux_size
 =áux_size;

1551 
c
->
Æloc_ˇŒback
 =álloc_callback;

1552 
c
->
wrôe_ˇŒback
 = write_callback;

1554 
i
 = 0; i < 
LIST_SIZE
; i++) {

1555 
	`INIT_LIST_HEAD
(&
c
->
Ãu
[
i
]);

1556 
c
->
n_buf„rs
[
i
] = 0;

1559 
i
 = 0; i < 1 << 
DM_BUFIO_HASH_BITS
; i++)

1560 
	`INIT_HLIST_HEAD
(&
c
->
ˇche_hash
[
i
]);

1562 
	`muãx_öô
(&
c
->
lock
);

1563 
	`INIT_LIST_HEAD
(&
c
->
ª£rved_buf„rs
);

1564 
c
->
√ed_ª£rved_buf„rs
 = 
ª£rved_buf„rs
;

1566 
c
->
möimum_buf„rs
 = 
DM_BUFIO_MIN_BUFFERS
;

1568 
	`öô_waôqueue_hód
(&
c
->
‰ì_buf„r_waô
);

1569 
c
->
async_wrôe_îr‹
 = 0;

1571 
c
->
dm_io
 = 
	`dm_io_˛õ¡_¸óã
();

1572 i‡(
	`IS_ERR
(
c
->
dm_io
)) {

1573 
r
 = 
	`PTR_ERR
(
c
->
dm_io
);

1574 
bad_dm_io
;

1577 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

1578 i‡(
c
->
blocks_≥r_∑ge_bôs
) {

1579 i‡(!
	`DM_BUFIO_CACHE_NAME
(
c
)) {

1580 
	`DM_BUFIO_CACHE_NAME
(
c
Ë
	`ka•rötf
(
GFP_KERNEL
, "dm_bufio_ˇche-%u", c->
block_size
);

1581 i‡(!
	`DM_BUFIO_CACHE_NAME
(
c
)) {

1582 
r
 = -
ENOMEM
;

1583 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1584 
bad_ˇche
;

1588 i‡(!
	`DM_BUFIO_CACHE
(
c
)) {

1589 
	`DM_BUFIO_CACHE
(
c
Ë
	`kmem_ˇche_¸óã
(
	`DM_BUFIO_CACHE_NAME
(c),

1590 
c
->
block_size
,

1591 
c
->
block_size
, 0, 
NULL
);

1592 i‡(!
	`DM_BUFIO_CACHE
(
c
)) {

1593 
r
 = -
ENOMEM
;

1594 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1595 
bad_ˇche
;

1599 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1601 
c
->
√ed_ª£rved_buf„rs
) {

1602 
dm_buf„r
 *
b
 = 
	`Æloc_buf„r
(
c
, 
GFP_KERNEL
);

1604 i‡(!
b
) {

1605 
r
 = -
ENOMEM
;

1606 
bad_buf„r
;

1608 
	`__‰ì_buf„r_wake
(
b
);

1611 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

1612 
dm_bufio_˛õ¡_cou¡
++;

1613 
	`li°_add
(&
c
->
˛õ¡_li°
, &
dm_bufio_Æl_˛õ¡s
);

1614 
	`__ˇche_size_ª‰esh
();

1615 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1617 
c
->
shrökî
.
cou¡_obje˘s
 = 
dm_bufio_shrök_cou¡
;

1618 
c
->
shrökî
.
sˇn_obje˘s
 = 
dm_bufio_shrök_sˇn
;

1619 
c
->
shrökî
.
£eks
 = 1;

1620 
c
->
shrökî
.
b©ch
 = 0;

1621 
	`ªgi°î_shrökî
(&
c
->
shrökî
);

1623  
c
;

1625 
bad_buf„r
:

1626 
bad_ˇche
:

1627 !
	`li°_em±y
(&
c
->
ª£rved_buf„rs
)) {

1628 
dm_buf„r
 *
b
 = 
	`li°_íåy
(
c
->
ª£rved_buf„rs
.
√xt
,

1629 
dm_buf„r
, 
Ãu_li°
);

1630 
	`li°_dñ
(&
b
->
Ãu_li°
);

1631 
	`‰ì_buf„r
(
b
);

1633 
	`dm_io_˛õ¡_de°roy
(
c
->
dm_io
);

1634 
bad_dm_io
:

1635 
	`v‰ì
(
c
->
ˇche_hash
);

1636 
bad_hash
:

1637 
	`k‰ì
(
c
);

1638 
bad_˛õ¡
:

1639  
	`ERR_PTR
(
r
);

1640 
	}
}

1641 
EXPORT_SYMBOL_GPL
(
dm_bufio_˛õ¡_¸óã
);

1647 
	$dm_bufio_˛õ¡_de°roy
(
dm_bufio_˛õ¡
 *
c
)

1649 
i
;

1651 
	`dr›_buf„rs
(
c
);

1653 
	`uƒegi°î_shrökî
(&
c
->
shrökî
);

1655 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

1657 
	`li°_dñ
(&
c
->
˛õ¡_li°
);

1658 
dm_bufio_˛õ¡_cou¡
--;

1659 
	`__ˇche_size_ª‰esh
();

1661 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1663 
i
 = 0; i < 1 << 
DM_BUFIO_HASH_BITS
; i++)

1664 
	`BUG_ON
(!
	`hli°_em±y
(&
c
->
ˇche_hash
[
i
]));

1666 
	`BUG_ON
(
c
->
√ed_ª£rved_buf„rs
);

1668 !
	`li°_em±y
(&
c
->
ª£rved_buf„rs
)) {

1669 
dm_buf„r
 *
b
 = 
	`li°_íåy
(
c
->
ª£rved_buf„rs
.
√xt
,

1670 
dm_buf„r
, 
Ãu_li°
);

1671 
	`li°_dñ
(&
b
->
Ãu_li°
);

1672 
	`‰ì_buf„r
(
b
);

1675 
i
 = 0; i < 
LIST_SIZE
; i++)

1676 i‡(
c
->
n_buf„rs
[
i
])

1677 
	`DMERR
("Àaked buf„∏cou¡ %d: %ld", 
i
, 
c
->
n_buf„rs
[i]);

1679 
i
 = 0; i < 
LIST_SIZE
; i++)

1680 
	`BUG_ON
(
c
->
n_buf„rs
[
i
]);

1682 
	`dm_io_˛õ¡_de°roy
(
c
->
dm_io
);

1683 
	`v‰ì
(
c
->
ˇche_hash
);

1684 
	`k‰ì
(
c
);

1685 
	}
}

1686 
EXPORT_SYMBOL_GPL
(
dm_bufio_˛õ¡_de°roy
);

1688 
	$˛ónup_ﬁd_buf„rs
()

1690 
max_age
 = 
	`ACCESS_ONCE
(
dm_bufio_max_age
);

1691 
dm_bufio_˛õ¡
 *
c
;

1693 i‡(
max_age
 > 
ULONG_MAX
 / 
HZ
)

1694 
max_age
 = 
ULONG_MAX
 / 
HZ
;

1696 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

1697 
	`li°_f‹_óch_íåy
(
c
, &
dm_bufio_Æl_˛õ¡s
, 
˛õ¡_li°
) {

1698 i‡(!
	`dm_bufio_åylock
(
c
))

1701 !
	`li°_em±y
(&
c
->
Ãu
[
LIST_CLEAN
])) {

1702 
dm_buf„r
 *
b
;

1703 
b
 = 
	`li°_íåy
(
c
->
Ãu
[
LIST_CLEAN
].
¥ev
,

1704 
dm_buf„r
, 
Ãu_li°
);

1705 i‡(!
	`__˛ónup_ﬁd_buf„r
(
b
, 0, 
max_age
 * 
HZ
))

1707 
	`dm_bufio_c⁄d_ªsched
();

1710 
	`dm_bufio_u∆ock
(
c
);

1711 
	`dm_bufio_c⁄d_ªsched
();

1713 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1714 
	}
}

1716 
w‹kqueue_°ru˘
 *
	gdm_bufio_wq
;

1717 
dñayed_w‹k
 
	gdm_bufio_w‹k
;

1719 
	$w‹k_‚
(
w‹k_°ru˘
 *
w
)

1721 
	`˛ónup_ﬁd_buf„rs
();

1723 
	`queue_dñayed_w‹k
(
dm_bufio_wq
, &
dm_bufio_w‹k
,

1724 
DM_BUFIO_WORK_TIMER_SECS
 * 
HZ
);

1725 
	}
}

1735 
__öô
 
	$dm_bufio_öô
()

1737 
__u64
 
mem
;

1739 
dm_bufio_Æloˇãd_kmem_ˇche
 = 0;

1740 
dm_bufio_Æloˇãd_gë_‰ì_∑ges
 = 0;

1741 
dm_bufio_Æloˇãd_vmÆloc
 = 0;

1742 
dm_bufio_cuºít_Æloˇãd
 = 0;

1744 
	`mem£t
(&
dm_bufio_ˇches
, 0,  dm_bufio_caches);

1745 
	`mem£t
(&
dm_bufio_ˇche_«mes
, 0,  dm_bufio_cache_names);

1747 
mem
 = (
__u64
)((
tŸÆøm_∑ges
 - 
tŸÆhigh_∑ges
) *

1748 
DM_BUFIO_MEMORY_PERCENT
 / 100Ë<< 
PAGE_SHIFT
;

1750 i‡(
mem
 > 
ULONG_MAX
)

1751 
mem
 = 
ULONG_MAX
;

1753 #ifde‡
CONFIG_MMU


1758 i‡(
mem
 > (
VMALLOC_END
 - 
VMALLOC_START
Ë* 
DM_BUFIO_VMALLOC_PERCENT
 / 100)

1759 
mem
 = (
VMALLOC_END
 - 
VMALLOC_START
Ë* 
DM_BUFIO_VMALLOC_PERCENT
 / 100;

1762 
dm_bufio_deÁu…_ˇche_size
 = 
mem
;

1764 
	`muãx_lock
(&
dm_bufio_˛õ¡s_lock
);

1765 
	`__ˇche_size_ª‰esh
();

1766 
	`muãx_u∆ock
(&
dm_bufio_˛õ¡s_lock
);

1768 
dm_bufio_wq
 = 
	`¸óã_sögÀthªad_w‹kqueue
("dm_bufio_cache");

1769 i‡(!
dm_bufio_wq
)

1770  -
ENOMEM
;

1772 
	`INIT_DELAYED_WORK
(&
dm_bufio_w‹k
, 
w‹k_‚
);

1773 
	`queue_dñayed_w‹k
(
dm_bufio_wq
, &
dm_bufio_w‹k
,

1774 
DM_BUFIO_WORK_TIMER_SECS
 * 
HZ
);

1777 
	}
}

1782 
__exô
 
	$dm_bufio_exô
()

1784 
bug
 = 0;

1785 
i
;

1787 
	`ˇn˚l_dñayed_w‹k_sync
(&
dm_bufio_w‹k
);

1788 
	`de°roy_w‹kqueue
(
dm_bufio_wq
);

1790 
i
 = 0; i < 
	`ARRAY_SIZE
(
dm_bufio_ˇches
); i++) {

1791 
kmem_ˇche
 *
kc
 = 
dm_bufio_ˇches
[
i
];

1793 i‡(
kc
)

1794 
	`kmem_ˇche_de°roy
(
kc
);

1797 
i
 = 0; i < 
	`ARRAY_SIZE
(
dm_bufio_ˇche_«mes
); i++)

1798 
	`k‰ì
(
dm_bufio_ˇche_«mes
[
i
]);

1800 i‡(
dm_bufio_˛õ¡_cou¡
) {

1801 
	`DMCRIT
("%s: dm_bufio_client_countÜeaked: %d",

1802 
__func__
, 
dm_bufio_˛õ¡_cou¡
);

1803 
bug
 = 1;

1806 i‡(
dm_bufio_cuºít_Æloˇãd
) {

1807 
	`DMCRIT
("%s: dm_bufio_current_allocatedÜeaked: %lu",

1808 
__func__
, 
dm_bufio_cuºít_Æloˇãd
);

1809 
bug
 = 1;

1812 i‡(
dm_bufio_Æloˇãd_gë_‰ì_∑ges
) {

1813 
	`DMCRIT
("%s: dm_bufio_allocated_get_free_pagesÜeaked: %lu",

1814 
__func__
, 
dm_bufio_Æloˇãd_gë_‰ì_∑ges
);

1815 
bug
 = 1;

1818 i‡(
dm_bufio_Æloˇãd_vmÆloc
) {

1819 
	`DMCRIT
("%s: dm_bufio_vmallocÜeaked: %lu",

1820 
__func__
, 
dm_bufio_Æloˇãd_vmÆloc
);

1821 
bug
 = 1;

1824 i‡(
bug
)

1825 
	`BUG
();

1826 
	}
}

1828 
	$moduÀ_öô
(
dm_bufio_öô
)

1829 
	$moduÀ_exô
(
dm_bufio_exô
)

1831 
	`moduÀ_∑øm_«med
(
max_ˇche_size_byãs
, 
dm_bufio_ˇche_size
, 
ul⁄g
, 
S_IRUGO
 | 
S_IWUSR
);

1832 
	`MODULE_PARM_DESC
(
max_ˇche_size_byãs
, "Size of metadata cache");

1834 
	`moduÀ_∑øm_«med
(
max_age_£c⁄ds
, 
dm_bufio_max_age
, 
uöt
, 
S_IRUGO
 | 
S_IWUSR
);

1835 
	`MODULE_PARM_DESC
(
max_age_£c⁄ds
, "Maxáge ofá buffer in seconds");

1837 
	`moduÀ_∑øm_«med
(
≥ak_Æloˇãd_byãs
, 
dm_bufio_≥ak_Æloˇãd
, 
ul⁄g
, 
S_IRUGO
 | 
S_IWUSR
);

1838 
	`MODULE_PARM_DESC
(
≥ak_Æloˇãd_byãs
, "TracksÅhe maximumállocated memory");

1840 
	`moduÀ_∑øm_«med
(
Æloˇãd_kmem_ˇche_byãs
, 
dm_bufio_Æloˇãd_kmem_ˇche
, 
ul⁄g
, 
S_IRUGO
);

1841 
	`MODULE_PARM_DESC
(
Æloˇãd_kmem_ˇche_byãs
, "Memoryállocated with kmem_cache_alloc");

1843 
	`moduÀ_∑øm_«med
(
Æloˇãd_gë_‰ì_∑ges_byãs
, 
dm_bufio_Æloˇãd_gë_‰ì_∑ges
, 
ul⁄g
, 
S_IRUGO
);

1844 
	`MODULE_PARM_DESC
(
Æloˇãd_gë_‰ì_∑ges_byãs
, "Memoryállocated with get_free_pages");

1846 
	`moduÀ_∑øm_«med
(
Æloˇãd_vmÆloc_byãs
, 
dm_bufio_Æloˇãd_vmÆloc
, 
ul⁄g
, 
S_IRUGO
);

1847 
	`MODULE_PARM_DESC
(
Æloˇãd_vmÆloc_byãs
, "Memoryállocated with vmalloc");

1849 
	`moduÀ_∑øm_«med
(
cuºít_Æloˇãd_byãs
, 
dm_bufio_cuºít_Æloˇãd
, 
ul⁄g
, 
S_IRUGO
);

1850 
	`MODULE_PARM_DESC
(
cuºít_Æloˇãd_byãs
, "Memory currently used byÅhe cache");

1852 
	`MODULE_AUTHOR
("Mikulas Patocka <dm-devel@redhat.com>");

1853 
	`MODULE_DESCRIPTION
(
DM_NAME
 " buffered I/OÜibrary");

1854 
	`MODULE_LICENSE
("GPL");

	@dm-bufio.h

9 #i‚de‡
DM_BUFIO_H


10 
	#DM_BUFIO_H


	)

12 
	~<löux/blkdev.h
>

13 
	~<löux/ty≥s.h
>

17 
	gdm_bufio_˛õ¡
;

18 
	gdm_buf„r
;

23 
dm_bufio_˛õ¡
 *

24 
dm_bufio_˛õ¡_¸óã
(
block_devi˚
 *
bdev
, 
block_size
,

25 
ª£rved_buf„rs
, 
aux_size
,

26 (*
Æloc_ˇŒback
)(
dm_buf„r
 *),

27 (*
wrôe_ˇŒback
)(
dm_buf„r
 *));

32 
	`dm_bufio_˛õ¡_de°roy
(
dm_bufio_˛õ¡
 *
c
);

48 *
	`dm_bufio_ªad
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

49 
dm_buf„r
 **
bp
);

55 *
	`dm_bufio_gë
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

56 
dm_buf„r
 **
bp
);

62 *
	`dm_bufio_√w
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
,

63 
dm_buf„r
 **
bp
);

70 
	`dm_bufio_¥e„tch
(
dm_bufio_˛õ¡
 *
c
,

71 
£˘‹_t
 
block
, 
n_blocks
);

77 
	`dm_bufio_ªÀa£
(
dm_buf„r
 *
b
);

87 
	`dm_bufio_m¨k_buf„r_dúty
(
dm_buf„r
 *
b
);

92 
	`dm_bufio_wrôe_dúty_buf„rs_async
(
dm_bufio_˛õ¡
 *
c
);

98 
	`dm_bufio_wrôe_dúty_buf„rs
(
dm_bufio_˛õ¡
 *
c
);

103 
	`dm_bufio_issue_Êush
(
dm_bufio_˛õ¡
 *
c
);

109 
	`dm_bufio_ªÀa£_move
(
dm_buf„r
 *
b
, 
£˘‹_t
 
√w_block
);

116 
	`dm_bufio_f‹gë
(
dm_bufio_˛õ¡
 *
c
, 
£˘‹_t
 
block
);

121 
	`dm_bufio_£t_möimum_buf„rs
(
dm_bufio_˛õ¡
 *
c
, 
n
);

123 
	`dm_bufio_gë_block_size
(
dm_bufio_˛õ¡
 *
c
);

124 
£˘‹_t
 
	`dm_bufio_gë_devi˚_size
(
dm_bufio_˛õ¡
 *
c
);

125 
£˘‹_t
 
	`dm_bufio_gë_block_numbî
(
dm_buf„r
 *
b
);

126 *
	`dm_bufio_gë_block_d©a
(
dm_buf„r
 *
b
);

127 *
	`dm_bufio_gë_aux_d©a
(
dm_buf„r
 *
b
);

128 
dm_bufio_˛õ¡
 *
	`dm_bufio_gë_˛õ¡
(
dm_buf„r
 *
b
);

	@dm-bufio.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

24 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

25 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

26 { 0x4c4„f19, 
__VMLINUX_SYMBOL_STR
(
kî√l_°ack
) },

27 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

28 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

29 { 0xa0fbac79, 
__VMLINUX_SYMBOL_STR
(
wake_up_bô
) },

30 { 0x2b5a58a3, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

31 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

32 { 0xb5dˇb5b, 
__VMLINUX_SYMBOL_STR
(
ªmove_waô_queue
) },

33 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

34 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

35 { 0x797c8Á9, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k_sync
) },

36 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

37 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

38 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

39 { 0xcf2786a9, 
__VMLINUX_SYMBOL_STR
(
muãx_åylock
) },

40 { 0xb9a5d466, 
__VMLINUX_SYMBOL_STR
(
out_of_löe_waô_⁄_bô_lock
) },

41 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

42 { 0x733c3b54, 
__VMLINUX_SYMBOL_STR
(
ka•rötf
) },

43 { 0xde9360ba, 
__VMLINUX_SYMBOL_STR
(
tŸÆøm_∑ges
) },

44 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

45 { 0xffd5a395, 
__VMLINUX_SYMBOL_STR
(
deÁu…_wake_fun˘i⁄
) },

46 { 0xe693f9c5, 
__VMLINUX_SYMBOL_STR
(
bio_öô
) },

47 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

48 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

49 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

50 { 0xd14e5bc6, 
__VMLINUX_SYMBOL_STR
(
bio_add_∑ge
) },

51 { 0x4c9d28b0, 
__VMLINUX_SYMBOL_STR
(
phys_ba£
) },

52 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

53 { 0x5406d4ec, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_‰ì
) },

54 { 0x93a6e0b2, 
__VMLINUX_SYMBOL_STR
(
io_scheduÀ
) },

55 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

56 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

57 { 0xf33c9d85, 
__VMLINUX_SYMBOL_STR
(
bô_waô_io
) },

58 { 0x63d68f9d, 
__VMLINUX_SYMBOL_STR
(
submô_bio
) },

59 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

60 { 0xc4d6c774, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc
) },

61 { 0x45ba5804, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_shrökî
) },

62 { 0x93fˇ811, 
__VMLINUX_SYMBOL_STR
(
__gë_‰ì_∑ges
) },

63 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

64 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

65 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

66 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

67 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

68 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
‰ì_∑ges
) },

69 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

70 { 0x2cˇbb5b, 
__VMLINUX_SYMBOL_STR
(
out_of_löe_waô_⁄_bô
) },

71 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

72 { 0x5860Ød4, 
__VMLINUX_SYMBOL_STR
(
add_waô_queue
) },

73 { 0xa9bd2676, 
__VMLINUX_SYMBOL_STR
(
__vmÆloc
) },

74 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

75 { 0x53eb9c3, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_shrökî
) },

76 { 0x8d2e268b, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_ul⁄g
) },

77 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

78 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

81 c⁄° 
	g__moduÀ_dïíds
[]

82 
__u£d


83 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

87 
MODULE_INFO
(
§cvîsi⁄
, "C1F0A8F390A9E8B96424867");

	@dm-builtin.c

1 
	~"dm.h
"

43 
	$dm_kobje˘_ªÀa£
(
kobje˘
 *
kobj
)

45 
	`com∂ëe
(
	`dm_gë_com∂ëi⁄_‰om_kobje˘
(
kobj
));

46 
	}
}

48 
EXPORT_SYMBOL
(
dm_kobje˘_ªÀa£
);

	@dm-cache-block-types.h

7 #i‚de‡
DM_CACHE_BLOCK_TYPES_H


8 
	#DM_CACHE_BLOCK_TYPES_H


	)

10 
	~"≥rsi°ít-d©a/dm-block-m™agî.h
"

20 
dm_block_t
 
	t__bôwi£__
 
	tdm_oblock_t
;

21 
uöt32_t
 
	t__bôwi£__
 
	tdm_cblock_t
;

23 
ölöe
 
dm_oblock_t
 
	$to_oblock
(
dm_block_t
 
b
)

25  (
__f‹˚
 
dm_oblock_t
Ë
b
;

26 
	}
}

28 
ölöe
 
dm_block_t
 
	$‰om_oblock
(
dm_oblock_t
 
b
)

30  (
__f‹˚
 
dm_block_t
Ë
b
;

31 
	}
}

33 
ölöe
 
dm_cblock_t
 
	$to_cblock
(
uöt32_t
 
b
)

35  (
__f‹˚
 
dm_cblock_t
Ë
b
;

36 
	}
}

38 
ölöe
 
uöt32_t
 
	$‰om_cblock
(
dm_cblock_t
 
b
)

40  (
__f‹˚
 
uöt32_t
Ë
b
;

41 
	}
}

	@dm-cache-cleaner.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

24 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

25 { 0xbd4b63be, 
__VMLINUX_SYMBOL_STR
(
dm_ˇche_pﬁicy_ªgi°î
) },

26 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

27 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

28 { 0xe15f42bb, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_åylock
) },

29 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

30 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

31 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

32 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

33 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

34 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

35 { 0xe585fb9c, 
__VMLINUX_SYMBOL_STR
(
dm_ˇche_pﬁicy_uƒegi°î
) },

38 c⁄° 
	g__moduÀ_dïíds
[]

39 
__u£d


40 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

44 
MODULE_INFO
(
§cvîsi⁄
, "486A0FE161464E4E7F9082C");

	@dm-cache-metadata.c

7 
	~"dm-ˇche-mëad©a.h
"

9 
	~"≥rsi°ít-d©a/dm-¨øy.h
"

10 
	~"≥rsi°ít-d©a/dm-bô£t.h
"

11 
	~"≥rsi°ít-d©a/dm-•a˚-m≠.h
"

12 
	~"≥rsi°ít-d©a/dm-•a˚-m≠-disk.h
"

13 
	~"≥rsi°ít-d©a/dm-å™ß˘i⁄-m™agî.h
"

15 
	~<löux/devi˚-m≠≥r.h
>

19 
	#DM_MSG_PREFIX
 "ˇchêmëad©a"

	)

21 
	#CACHE_SUPERBLOCK_MAGIC
 06142003

	)

22 
	#CACHE_SUPERBLOCK_LOCATION
 0

	)

27 
	#MIN_CACHE_VERSION
 1

	)

28 
	#MAX_CACHE_VERSION
 1

	)

30 
	#CACHE_METADATA_CACHE_SIZE
 64

	)

36 
	#CACHE_MAX_CONCURRENT_LOCKS
 5

	)

37 
	#SPACE_MAP_ROOT_SIZE
 128

	)

39 
	esu≥rblock_Êag_bôs
 {

41 
	mCLEAN_SHUTDOWN
,

47 
	em≠pög_bôs
 {

52 
	mM_VALID
 = 1,

57 
	mM_DIRTY
 = 2

60 
	sˇche_disk_su≥rblock
 {

61 
__À32
 
	mcsum
;

62 
__À32
 
	mÊags
;

63 
__À64
 
	mblockƒ
;

65 
__u8
 
	muuid
[16];

66 
__À64
 
	mmagic
;

67 
__À32
 
	mvîsi⁄
;

69 
__u8
 
	mpﬁicy_«me
[
CACHE_POLICY_NAME_SIZE
];

70 
__À32
 
	mpﬁicy_höt_size
;

72 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

73 
__À64
 
	mm≠pög_roŸ
;

74 
__À64
 
	mhöt_roŸ
;

76 
__À64
 
	mdisˇrd_roŸ
;

77 
__À64
 
	mdisˇrd_block_size
;

78 
__À64
 
	mdisˇrd_ƒ_blocks
;

80 
__À32
 
	md©a_block_size
;

81 
__À32
 
	mmëad©a_block_size
;

82 
__À32
 
	mˇche_blocks
;

84 
__À32
 
	mcom∑t_Êags
;

85 
__À32
 
	mcom∑t_ro_Êags
;

86 
__À32
 
	möcom∑t_Êags
;

88 
__À32
 
	mªad_hôs
;

89 
__À32
 
	mªad_mis£s
;

90 
__À32
 
	mwrôe_hôs
;

91 
__À32
 
	mwrôe_mis£s
;

93 
__À32
 
	mpﬁicy_vîsi⁄
[
CACHE_POLICY_VERSION_SIZE
];

94 } 
	g__∑cked
;

96 
	sdm_ˇche_mëad©a
 {

97 
block_devi˚
 *
	mbdev
;

98 
dm_block_m™agî
 *
	mbm
;

99 
dm_•a˚_m≠
 *
	mmëad©a_sm
;

100 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

102 
dm_¨øy_öfo
 
	möfo
;

103 
dm_¨øy_öfo
 
	mhöt_öfo
;

104 
dm_disk_bô£t
 
	mdisˇrd_öfo
;

106 
rw_£m≠h‹e
 
	mroŸ_lock
;

107 
dm_block_t
 
	mroŸ
;

108 
dm_block_t
 
	mhöt_roŸ
;

109 
dm_block_t
 
	mdisˇrd_roŸ
;

111 
£˘‹_t
 
	mdisˇrd_block_size
;

112 
dm_oblock_t
 
	mdisˇrd_ƒ_blocks
;

114 
£˘‹_t
 
	md©a_block_size
;

115 
dm_cblock_t
 
	mˇche_blocks
;

116 
boﬁ
 
	mch™ged
:1;

117 
boﬁ
 
	m˛ón_whí_›íed
:1;

119 
	mpﬁicy_«me
[
CACHE_POLICY_NAME_SIZE
];

120 
	mpﬁicy_vîsi⁄
[
CACHE_POLICY_VERSION_SIZE
];

121 
size_t
 
	mpﬁicy_höt_size
;

122 
dm_ˇche_°©i°ics
 
	m°©s
;

128 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

135 
	#SUPERBLOCK_CSUM_XOR
 9031977

	)

137 
	$sb_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

138 
dm_block
 *
b
,

139 
size_t
 
sb_block_size
)

141 
ˇche_disk_su≥rblock
 *
disk_su≥r
 = 
	`dm_block_d©a
(
b
);

143 
disk_su≥r
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

144 
disk_su≥r
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&disk_su≥r->
Êags
,

145 
sb_block_size
 - (
__À32
),

146 
SUPERBLOCK_CSUM_XOR
));

147 
	}
}

149 
	$check_mëad©a_vîsi⁄
(
ˇche_disk_su≥rblock
 *
disk_su≥r
)

151 
uöt32_t
 
mëad©a_vîsi⁄
 = 
	`À32_to_˝u
(
disk_su≥r
->
vîsi⁄
);

152 i‡(
mëad©a_vîsi⁄
 < 
MIN_CACHE_VERSION
 || mëad©a_vîsi⁄ > 
MAX_CACHE_VERSION
) {

153 
	`DMERR
("Cache metadata version %u found, but only versions between %uánd %u supported.",

154 
mëad©a_vîsi⁄
, 
MIN_CACHE_VERSION
, 
MAX_CACHE_VERSION
);

155  -
EINVAL
;

159 
	}
}

161 
	$sb_check
(
dm_block_vÆid©‹
 *
v
,

162 
dm_block
 *
b
,

163 
size_t
 
sb_block_size
)

165 
ˇche_disk_su≥rblock
 *
disk_su≥r
 = 
	`dm_block_d©a
(
b
);

166 
__À32
 
csum_À
;

168 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
disk_su≥r
->
blockƒ
)) {

169 
	`DMERR
("sb_check failed: blocknr %llu: wanted %llu",

170 
	`À64_to_˝u
(
disk_su≥r
->
blockƒ
),

171 ()
	`dm_block_loˇti⁄
(
b
));

172  -
ENOTBLK
;

175 i‡(
	`À64_to_˝u
(
disk_su≥r
->
magic
Ë!
CACHE_SUPERBLOCK_MAGIC
) {

176 
	`DMERR
("sb_check failed: magic %llu: wanted %llu",

177 
	`À64_to_˝u
(
disk_su≥r
->
magic
),

178 ()
CACHE_SUPERBLOCK_MAGIC
);

179  -
EILSEQ
;

182 
csum_À
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
disk_su≥r
->
Êags
,

183 
sb_block_size
 - (
__À32
),

184 
SUPERBLOCK_CSUM_XOR
));

185 i‡(
csum_À
 !
disk_su≥r
->
csum
) {

186 
	`DMERR
("sb_check failed: csum %u: wanted %u",

187 
	`À32_to_˝u
(
csum_À
),Üe32_to_˝u(
disk_su≥r
->
csum
));

188  -
EILSEQ
;

191  
	`check_mëad©a_vîsi⁄
(
disk_su≥r
);

192 
	}
}

194 
dm_block_vÆid©‹
 
	gsb_vÆid©‹
 = {

195 .
«me
 = "superblock",

196 .
	g¥ï¨e_f‹_wrôe
 = 
sb_¥ï¨e_f‹_wrôe
,

197 .
	gcheck
 = 
sb_check


202 
	$su≥rblock_ªad_lock
(
dm_ˇche_mëad©a
 *
cmd
,

203 
dm_block
 **
sblock
)

205  
	`dm_bm_ªad_lock
(
cmd
->
bm
, 
CACHE_SUPERBLOCK_LOCATION
,

206 &
sb_vÆid©‹
, 
sblock
);

207 
	}
}

209 
	$su≥rblock_lock_zîo
(
dm_ˇche_mëad©a
 *
cmd
,

210 
dm_block
 **
sblock
)

212  
	`dm_bm_wrôe_lock_zîo
(
cmd
->
bm
, 
CACHE_SUPERBLOCK_LOCATION
,

213 &
sb_vÆid©‹
, 
sblock
);

214 
	}
}

216 
	$su≥rblock_lock
(
dm_ˇche_mëad©a
 *
cmd
,

217 
dm_block
 **
sblock
)

219  
	`dm_bm_wrôe_lock
(
cmd
->
bm
, 
CACHE_SUPERBLOCK_LOCATION
,

220 &
sb_vÆid©‹
, 
sblock
);

221 
	}
}

225 
	$__su≥rblock_Æl_zî€s
(
dm_block_m™agî
 *
bm
, 
boﬁ
 *
ªsu…
)

227 
r
;

228 
i
;

229 
dm_block
 *
b
;

230 
__À64
 *
d©a_À
, 
zîo
 = 
	`˝u_to_À64
(0);

231 
sb_block_size
 = 
	`dm_bm_block_size
(
bm
Ë/ (
__À64
);

236 
r
 = 
	`dm_bm_ªad_lock
(
bm
, 
CACHE_SUPERBLOCK_LOCATION
, 
NULL
, &
b
);

237 i‡(
r
)

238  
r
;

240 
d©a_À
 = 
	`dm_block_d©a
(
b
);

241 *
ªsu…
 = 
åue
;

242 
i
 = 0; i < 
sb_block_size
; i++) {

243 i‡(
d©a_À
[
i
] !
zîo
) {

244 *
ªsu…
 = 
Ál£
;

249  
	`dm_bm_u∆ock
(
b
);

250 
	}
}

252 
	$__£tup_m≠pög_öfo
(
dm_ˇche_mëad©a
 *
cmd
)

254 
dm_båì_vÆue_ty≥
 
vt
;

256 
vt
.
c⁄ãxt
 = 
NULL
;

257 
vt
.
size
 = (
__À64
);

258 
vt
.
öc
 = 
NULL
;

259 
vt
.
dec
 = 
NULL
;

260 
vt
.
equÆ
 = 
NULL
;

261 
	`dm_¨øy_öfo_öô
(&
cmd
->
öfo
, cmd->
tm
, &
vt
);

263 i‡(
cmd
->
pﬁicy_höt_size
) {

264 
vt
.
size
 = (
__À32
);

265 
	`dm_¨øy_öfo_öô
(&
cmd
->
höt_öfo
, cmd->
tm
, &
vt
);

267 
	}
}

269 
	$__ßve_sm_roŸ
(
dm_ˇche_mëad©a
 *
cmd
)

271 
r
;

272 
size_t
 
mëad©a_Àn
;

274 
r
 = 
	`dm_sm_roŸ_size
(
cmd
->
mëad©a_sm
, &
mëad©a_Àn
);

275 i‡(
r
 < 0)

276  
r
;

278  
	`dm_sm_c›y_roŸ
(
cmd
->
mëad©a_sm
, &cmd->
mëad©a_•a˚_m≠_roŸ
,

279 
mëad©a_Àn
);

280 
	}
}

282 
	$__c›y_sm_roŸ
(
dm_ˇche_mëad©a
 *
cmd
,

283 
ˇche_disk_su≥rblock
 *
disk_su≥r
)

285 
	`mem˝y
(&
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
,

286 &
cmd
->
mëad©a_•a˚_m≠_roŸ
,

287 (
cmd
->
mëad©a_•a˚_m≠_roŸ
));

288 
	}
}

290 
	$__wrôe_öôül_su≥rblock
(
dm_ˇche_mëad©a
 *
cmd
)

292 
r
;

293 
dm_block
 *
sblock
;

294 
ˇche_disk_su≥rblock
 *
disk_su≥r
;

295 
£˘‹_t
 
bdev_size
 = 
	`i_size_ªad
(
cmd
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

298 i‡(
bdev_size
 > 
DM_CACHE_METADATA_MAX_SECTORS
)

299 
bdev_size
 = 
DM_CACHE_METADATA_MAX_SECTORS
;

301 
r
 = 
	`dm_tm_¥e_commô
(
cmd
->
tm
);

302 i‡(
r
 < 0)

303  
r
;

309 
r
 = 
	`__ßve_sm_roŸ
(
cmd
);

310 i‡(
r
)

311  
r
;

313 
r
 = 
	`su≥rblock_lock_zîo
(
cmd
, &
sblock
);

314 i‡(
r
)

315  
r
;

317 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

318 
disk_su≥r
->
Êags
 = 0;

319 
	`mem£t
(
disk_su≥r
->
uuid
, 0, (disk_super->uuid));

320 
disk_su≥r
->
magic
 = 
	`˝u_to_À64
(
CACHE_SUPERBLOCK_MAGIC
);

321 
disk_su≥r
->
vîsi⁄
 = 
	`˝u_to_À32
(
MAX_CACHE_VERSION
);

322 
	`mem£t
(
disk_su≥r
->
pﬁicy_«me
, 0, (disk_super->policy_name));

323 
	`mem£t
(
disk_su≥r
->
pﬁicy_vîsi⁄
, 0, (disk_super->policy_version));

324 
disk_su≥r
->
pﬁicy_höt_size
 = 0;

326 
	`__c›y_sm_roŸ
(
cmd
, 
disk_su≥r
);

328 
disk_su≥r
->
m≠pög_roŸ
 = 
	`˝u_to_À64
(
cmd
->
roŸ
);

329 
disk_su≥r
->
höt_roŸ
 = 
	`˝u_to_À64
(
cmd
->hint_root);

330 
disk_su≥r
->
disˇrd_roŸ
 = 
	`˝u_to_À64
(
cmd
->discard_root);

331 
disk_su≥r
->
disˇrd_block_size
 = 
	`˝u_to_À64
(
cmd
->discard_block_size);

332 
disk_su≥r
->
disˇrd_ƒ_blocks
 = 
	`˝u_to_À64
(
	`‰om_oblock
(
cmd
->discard_nr_blocks));

333 
disk_su≥r
->
mëad©a_block_size
 = 
	`˝u_to_À32
(
DM_CACHE_METADATA_BLOCK_SIZE
);

334 
disk_su≥r
->
d©a_block_size
 = 
	`˝u_to_À32
(
cmd
->data_block_size);

335 
disk_su≥r
->
ˇche_blocks
 = 
	`˝u_to_À32
(0);

337 
disk_su≥r
->
ªad_hôs
 = 
	`˝u_to_À32
(0);

338 
disk_su≥r
->
ªad_mis£s
 = 
	`˝u_to_À32
(0);

339 
disk_su≥r
->
wrôe_hôs
 = 
	`˝u_to_À32
(0);

340 
disk_su≥r
->
wrôe_mis£s
 = 
	`˝u_to_À32
(0);

342  
	`dm_tm_commô
(
cmd
->
tm
, 
sblock
);

343 
	}
}

345 
	$__f‹m©_mëad©a
(
dm_ˇche_mëad©a
 *
cmd
)

347 
r
;

349 
r
 = 
	`dm_tm_¸óã_wôh_sm
(
cmd
->
bm
, 
CACHE_SUPERBLOCK_LOCATION
,

350 &
cmd
->
tm
, &cmd->
mëad©a_sm
);

351 i‡(
r
 < 0) {

352 
	`DMERR
("tm_create_with_sm failed");

353  
r
;

356 
	`__£tup_m≠pög_öfo
(
cmd
);

358 
r
 = 
	`dm_¨øy_em±y
(&
cmd
->
öfo
, &cmd->
roŸ
);

359 i‡(
r
 < 0)

360 
bad
;

362 
	`dm_disk_bô£t_öô
(
cmd
->
tm
, &cmd->
disˇrd_öfo
);

364 
r
 = 
	`dm_bô£t_em±y
(&
cmd
->
disˇrd_öfo
, &cmd->
disˇrd_roŸ
);

365 i‡(
r
 < 0)

366 
bad
;

368 
cmd
->
disˇrd_block_size
 = 0;

369 
cmd
->
disˇrd_ƒ_blocks
 = 0;

371 
r
 = 
	`__wrôe_öôül_su≥rblock
(
cmd
);

372 i‡(
r
)

373 
bad
;

375 
cmd
->
˛ón_whí_›íed
 = 
åue
;

378 
bad
:

379 
	`dm_tm_de°roy
(
cmd
->
tm
);

380 
	`dm_sm_de°roy
(
cmd
->
mëad©a_sm
);

382  
r
;

383 
	}
}

385 
	$__check_öcom∑t_„©uªs
(
ˇche_disk_su≥rblock
 *
disk_su≥r
,

386 
dm_ˇche_mëad©a
 *
cmd
)

388 
uöt32_t
 
„©uªs
;

390 
„©uªs
 = 
	`À32_to_˝u
(
disk_su≥r
->
öcom∑t_Êags
Ë& ~
DM_CACHE_FEATURE_INCOMPAT_SUPP
;

391 i‡(
„©uªs
) {

392 
	`DMERR
("couldÇotáccess metadata dueÅo unsupported optional features (%lx).",

393 ()
„©uªs
);

394  -
EINVAL
;

400 i‡(
	`gë_disk_ro
(
cmd
->
bdev
->
bd_disk
))

403 
„©uªs
 = 
	`À32_to_˝u
(
disk_su≥r
->
com∑t_ro_Êags
Ë& ~
DM_CACHE_FEATURE_COMPAT_RO_SUPP
;

404 i‡(
„©uªs
) {

405 
	`DMERR
("couldÇotáccess metadata RDWR dueÅo unsupported optional features (%lx).",

406 ()
„©uªs
);

407  -
EINVAL
;

411 
	}
}

413 
	$__›í_mëad©a
(
dm_ˇche_mëad©a
 *
cmd
)

415 
r
;

416 
dm_block
 *
sblock
;

417 
ˇche_disk_su≥rblock
 *
disk_su≥r
;

418 
sb_Êags
;

420 
r
 = 
	`su≥rblock_ªad_lock
(
cmd
, &
sblock
);

421 i‡(
r
 < 0) {

422 
	`DMERR
("couldn'tÑeadÜock superblock");

423  
r
;

426 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

429 i‡(
	`À32_to_˝u
(
disk_su≥r
->
d©a_block_size
Ë!
cmd
->data_block_size) {

430 
	`DMERR
("changingÅhe data block size (from %uÅo %llu) isÇot supported",

431 
	`À32_to_˝u
(
disk_su≥r
->
d©a_block_size
),

432 ()
cmd
->
d©a_block_size
);

433 
r
 = -
EINVAL
;

434 
bad
;

437 
r
 = 
	`__check_öcom∑t_„©uªs
(
disk_su≥r
, 
cmd
);

438 i‡(
r
 < 0)

439 
bad
;

441 
r
 = 
	`dm_tm_›í_wôh_sm
(
cmd
->
bm
, 
CACHE_SUPERBLOCK_LOCATION
,

442 
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
,

443 (
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
),

444 &
cmd
->
tm
, &cmd->
mëad©a_sm
);

445 i‡(
r
 < 0) {

446 
	`DMERR
("tm_open_with_sm failed");

447 
bad
;

450 
	`__£tup_m≠pög_öfo
(
cmd
);

451 
	`dm_disk_bô£t_öô
(
cmd
->
tm
, &cmd->
disˇrd_öfo
);

452 
sb_Êags
 = 
	`À32_to_˝u
(
disk_su≥r
->
Êags
);

453 
cmd
->
˛ón_whí_›íed
 = 
	`ã°_bô
(
CLEAN_SHUTDOWN
, &
sb_Êags
);

454  
	`dm_bm_u∆ock
(
sblock
);

456 
bad
:

457 
	`dm_bm_u∆ock
(
sblock
);

458  
r
;

459 
	}
}

461 
	$__›í_‹_f‹m©_mëad©a
(
dm_ˇche_mëad©a
 *
cmd
,

462 
boﬁ
 
f‹m©_devi˚
)

464 
r
;

465 
boﬁ
 
unf‹m©ãd
 = 
Ál£
;

467 
r
 = 
	`__su≥rblock_Æl_zî€s
(
cmd
->
bm
, &
unf‹m©ãd
);

468 i‡(
r
)

469  
r
;

471 i‡(
unf‹m©ãd
)

472  
f‹m©_devi˚
 ? 
	`__f‹m©_mëad©a
(
cmd
Ë: -
EPERM
;

474  
	`__›í_mëad©a
(
cmd
);

475 
	}
}

477 
	$__¸óã_≥rsi°ít_d©a_obje˘s
(
dm_ˇche_mëad©a
 *
cmd
,

478 
boﬁ
 
may_f‹m©_devi˚
)

480 
r
;

481 
cmd
->
bm
 = 
	`dm_block_m™agî_¸óã
(cmd->
bdev
, 
DM_CACHE_METADATA_BLOCK_SIZE
 << 
SECTOR_SHIFT
,

482 
CACHE_METADATA_CACHE_SIZE
,

483 
CACHE_MAX_CONCURRENT_LOCKS
);

484 i‡(
	`IS_ERR
(
cmd
->
bm
)) {

485 
	`DMERR
("couldÇot create block manager");

486  
	`PTR_ERR
(
cmd
->
bm
);

489 
r
 = 
	`__›í_‹_f‹m©_mëad©a
(
cmd
, 
may_f‹m©_devi˚
);

490 i‡(
r
)

491 
	`dm_block_m™agî_de°roy
(
cmd
->
bm
);

493  
r
;

494 
	}
}

496 
	$__de°roy_≥rsi°ít_d©a_obje˘s
(
dm_ˇche_mëad©a
 *
cmd
)

498 
	`dm_sm_de°roy
(
cmd
->
mëad©a_sm
);

499 
	`dm_tm_de°roy
(
cmd
->
tm
);

500 
	`dm_block_m™agî_de°roy
(
cmd
->
bm
);

501 
	}
}

503 (*
	tÊags_muèt‹
)();

505 
	$upd©e_Êags
(
ˇche_disk_su≥rblock
 *
disk_su≥r
,

506 
Êags_muèt‹
 
muèt‹
)

508 
uöt32_t
 
sb_Êags
 = 
	`muèt‹
(
	`À32_to_˝u
(
disk_su≥r
->
Êags
));

509 
disk_su≥r
->
Êags
 = 
	`˝u_to_À32
(
sb_Êags
);

510 
	}
}

512 
	$£t_˛ón_shutdown
(
Êags
)

514 
	`£t_bô
(
CLEAN_SHUTDOWN
, &
Êags
);

515  
Êags
;

516 
	}
}

518 
	$˛ór_˛ón_shutdown
(
Êags
)

520 
	`˛ór_bô
(
CLEAN_SHUTDOWN
, &
Êags
);

521  
Êags
;

522 
	}
}

524 
	$ªad_su≥rblock_fõlds
(
dm_ˇche_mëad©a
 *
cmd
,

525 
ˇche_disk_su≥rblock
 *
disk_su≥r
)

527 
cmd
->
roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->
m≠pög_roŸ
);

528 
cmd
->
höt_roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->hint_root);

529 
cmd
->
disˇrd_roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->discard_root);

530 
cmd
->
disˇrd_block_size
 = 
	`À64_to_˝u
(
disk_su≥r
->discard_block_size);

531 
cmd
->
disˇrd_ƒ_blocks
 = 
	`to_oblock
(
	`À64_to_˝u
(
disk_su≥r
->discard_nr_blocks));

532 
cmd
->
d©a_block_size
 = 
	`À32_to_˝u
(
disk_su≥r
->data_block_size);

533 
cmd
->
ˇche_blocks
 = 
	`to_cblock
(
	`À32_to_˝u
(
disk_su≥r
->cache_blocks));

534 
	`°∫˝y
(
cmd
->
pﬁicy_«me
, 
disk_su≥r
->policy_name, (cmd->policy_name));

535 
cmd
->
pﬁicy_vîsi⁄
[0] = 
	`À32_to_˝u
(
disk_su≥r
->policy_version[0]);

536 
cmd
->
pﬁicy_vîsi⁄
[1] = 
	`À32_to_˝u
(
disk_su≥r
->policy_version[1]);

537 
cmd
->
pﬁicy_vîsi⁄
[2] = 
	`À32_to_˝u
(
disk_su≥r
->policy_version[2]);

538 
cmd
->
pﬁicy_höt_size
 = 
	`À32_to_˝u
(
disk_su≥r
->policy_hint_size);

540 
cmd
->
°©s
.
ªad_hôs
 = 
	`À32_to_˝u
(
disk_su≥r
->read_hits);

541 
cmd
->
°©s
.
ªad_mis£s
 = 
	`À32_to_˝u
(
disk_su≥r
->read_misses);

542 
cmd
->
°©s
.
wrôe_hôs
 = 
	`À32_to_˝u
(
disk_su≥r
->write_hits);

543 
cmd
->
°©s
.
wrôe_mis£s
 = 
	`À32_to_˝u
(
disk_su≥r
->write_misses);

545 
cmd
->
ch™ged
 = 
Ál£
;

546 
	}
}

551 
	$__begö_å™ß˘i⁄_Êags
(
dm_ˇche_mëad©a
 *
cmd
,

552 
Êags_muèt‹
 
muèt‹
)

554 
r
;

555 
ˇche_disk_su≥rblock
 *
disk_su≥r
;

556 
dm_block
 *
sblock
;

558 
r
 = 
	`su≥rblock_lock
(
cmd
, &
sblock
);

559 i‡(
r
)

560  
r
;

562 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

563 
	`upd©e_Êags
(
disk_su≥r
, 
muèt‹
);

564 
	`ªad_su≥rblock_fõlds
(
cmd
, 
disk_su≥r
);

565 
	`dm_bm_u∆ock
(
sblock
);

567  
	`dm_bm_Êush
(
cmd
->
bm
);

568 
	}
}

570 
	$__begö_å™ß˘i⁄
(
dm_ˇche_mëad©a
 *
cmd
)

572 
r
;

573 
ˇche_disk_su≥rblock
 *
disk_su≥r
;

574 
dm_block
 *
sblock
;

580 
r
 = 
	`su≥rblock_ªad_lock
(
cmd
, &
sblock
);

581 i‡(
r
)

582  
r
;

584 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

585 
	`ªad_su≥rblock_fõlds
(
cmd
, 
disk_su≥r
);

586 
	`dm_bm_u∆ock
(
sblock
);

589 
	}
}

591 
	$__commô_å™ß˘i⁄
(
dm_ˇche_mëad©a
 *
cmd
,

592 
Êags_muèt‹
 
muèt‹
)

594 
r
;

595 
ˇche_disk_su≥rblock
 *
disk_su≥r
;

596 
dm_block
 *
sblock
;

601 
	`BUILD_BUG_ON
((
ˇche_disk_su≥rblock
) > 512);

603 
r
 = 
	`dm_bô£t_Êush
(&
cmd
->
disˇrd_öfo
, cmd->
disˇrd_roŸ
,

604 &
cmd
->
disˇrd_roŸ
);

605 i‡(
r
)

606  
r
;

608 
r
 = 
	`dm_tm_¥e_commô
(
cmd
->
tm
);

609 i‡(
r
 < 0)

610  
r
;

612 
r
 = 
	`__ßve_sm_roŸ
(
cmd
);

613 i‡(
r
)

614  
r
;

616 
r
 = 
	`su≥rblock_lock
(
cmd
, &
sblock
);

617 i‡(
r
)

618  
r
;

620 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

622 i‡(
muèt‹
)

623 
	`upd©e_Êags
(
disk_su≥r
, 
muèt‹
);

625 
disk_su≥r
->
m≠pög_roŸ
 = 
	`˝u_to_À64
(
cmd
->
roŸ
);

626 
disk_su≥r
->
höt_roŸ
 = 
	`˝u_to_À64
(
cmd
->hint_root);

627 
disk_su≥r
->
disˇrd_roŸ
 = 
	`˝u_to_À64
(
cmd
->discard_root);

628 
disk_su≥r
->
disˇrd_block_size
 = 
	`˝u_to_À64
(
cmd
->discard_block_size);

629 
disk_su≥r
->
disˇrd_ƒ_blocks
 = 
	`˝u_to_À64
(
	`‰om_oblock
(
cmd
->discard_nr_blocks));

630 
disk_su≥r
->
ˇche_blocks
 = 
	`˝u_to_À32
(
	`‰om_cblock
(
cmd
->cache_blocks));

631 
	`°∫˝y
(
disk_su≥r
->
pﬁicy_«me
, 
cmd
->policy_name, (disk_super->policy_name));

632 
disk_su≥r
->
pﬁicy_vîsi⁄
[0] = 
	`˝u_to_À32
(
cmd
->policy_version[0]);

633 
disk_su≥r
->
pﬁicy_vîsi⁄
[1] = 
	`˝u_to_À32
(
cmd
->policy_version[1]);

634 
disk_su≥r
->
pﬁicy_vîsi⁄
[2] = 
	`˝u_to_À32
(
cmd
->policy_version[2]);

636 
disk_su≥r
->
ªad_hôs
 = 
	`˝u_to_À32
(
cmd
->
°©s
.read_hits);

637 
disk_su≥r
->
ªad_mis£s
 = 
	`˝u_to_À32
(
cmd
->
°©s
.read_misses);

638 
disk_su≥r
->
wrôe_hôs
 = 
	`˝u_to_À32
(
cmd
->
°©s
.write_hits);

639 
disk_su≥r
->
wrôe_mis£s
 = 
	`˝u_to_À32
(
cmd
->
°©s
.write_misses);

640 
	`__c›y_sm_roŸ
(
cmd
, 
disk_su≥r
);

642  
	`dm_tm_commô
(
cmd
->
tm
, 
sblock
);

643 
	}
}

652 
	#FLAGS_MASK
 ((1 << 16Ë- 1)

	)

654 
__À64
 
	$∑ck_vÆue
(
dm_oblock_t
 
block
, 
Êags
)

656 
uöt64_t
 
vÆue
 = 
	`‰om_oblock
(
block
);

657 
vÆue
 <<= 16;

658 
vÆue
 = vÆuê| (
Êags
 & 
FLAGS_MASK
);

659  
	`˝u_to_À64
(
vÆue
);

660 
	}
}

662 
	$u≈ack_vÆue
(
__À64
 
vÆue_À
, 
dm_oblock_t
 *
block
, *
Êags
)

664 
uöt64_t
 
vÆue
 = 
	`À64_to_˝u
(
vÆue_À
);

665 
uöt64_t
 
b
 = 
vÆue
 >> 16;

666 *
block
 = 
	`to_oblock
(
b
);

667 *
Êags
 = 
vÆue
 & 
FLAGS_MASK
;

668 
	}
}

672 
dm_ˇche_mëad©a
 *
	$dm_ˇche_mëad©a_›í
(
block_devi˚
 *
bdev
,

673 
£˘‹_t
 
d©a_block_size
,

674 
boﬁ
 
may_f‹m©_devi˚
,

675 
size_t
 
pﬁicy_höt_size
)

677 
r
;

678 
dm_ˇche_mëad©a
 *
cmd
;

680 
cmd
 = 
	`kzÆloc
((*cmd), 
GFP_KERNEL
);

681 i‡(!
cmd
) {

682 
	`DMERR
("couldÇotállocate metadata struct");

683  
NULL
;

686 
	`öô_rw£m
(&
cmd
->
roŸ_lock
);

687 
cmd
->
bdev
 = bdev;

688 
cmd
->
d©a_block_size
 = data_block_size;

689 
cmd
->
ˇche_blocks
 = 0;

690 
cmd
->
pﬁicy_höt_size
 =Öolicy_hint_size;

691 
cmd
->
ch™ged
 = 
åue
;

693 
r
 = 
	`__¸óã_≥rsi°ít_d©a_obje˘s
(
cmd
, 
may_f‹m©_devi˚
);

694 i‡(
r
) {

695 
	`k‰ì
(
cmd
);

696  
	`ERR_PTR
(
r
);

699 
r
 = 
	`__begö_å™ß˘i⁄_Êags
(
cmd
, 
˛ór_˛ón_shutdown
);

700 i‡(
r
 < 0) {

701 
	`dm_ˇche_mëad©a_˛o£
(
cmd
);

702  
	`ERR_PTR
(
r
);

705  
cmd
;

706 
	}
}

708 
	$dm_ˇche_mëad©a_˛o£
(
dm_ˇche_mëad©a
 *
cmd
)

710 
	`__de°roy_≥rsi°ít_d©a_obje˘s
(
cmd
);

711 
	`k‰ì
(
cmd
);

712 
	}
}

717 
	$block_unm≠≥d_‹_˛ón
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
b
,

718 
boﬁ
 *
ªsu…
)

720 
r
;

721 
__À64
 
vÆue
;

722 
dm_oblock_t
 
ob
;

723 
Êags
;

725 
r
 = 
	`dm_¨øy_gë_vÆue
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(
b
), &
vÆue
);

726 i‡(
r
) {

727 
	`DMERR
("block_unmapped_or_clean failed");

728  
r
;

731 
	`u≈ack_vÆue
(
vÆue
, &
ob
, &
Êags
);

732 *
ªsu…
 = !((
Êags
 & 
M_VALID
Ë&& (Êag†& 
M_DIRTY
));

735 
	}
}

737 
	$blocks_¨e_unm≠≥d_‹_˛ón
(
dm_ˇche_mëad©a
 *
cmd
,

738 
dm_cblock_t
 
begö
, dm_cblock_à
íd
,

739 
boﬁ
 *
ªsu…
)

741 
r
;

742 *
ªsu…
 = 
åue
;

744 
begö
 !
íd
) {

745 
r
 = 
	`block_unm≠≥d_‹_˛ón
(
cmd
, 
begö
, 
ªsu…
);

746 i‡(
r
)

747  
r
;

749 i‡(!*
ªsu…
) {

750 
	`DMERR
("cache block %llu is dirty",

751 (Ë
	`‰om_cblock
(
begö
));

755 
begö
 = 
	`to_cblock
(
	`‰om_cblock
(begin) + 1);

759 
	}
}

761 
	$dm_ˇche_ªsize
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
√w_ˇche_size
)

763 
r
;

764 
boﬁ
 
˛ón
;

765 
__À64
 
nuŒ_m≠pög
 = 
	`∑ck_vÆue
(0, 0);

767 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

768 
	`__dm_bÀss_f‹_disk
(&
nuŒ_m≠pög
);

770 i‡(
	`‰om_cblock
(
√w_ˇche_size
Ë< from_cblock(
cmd
->
ˇche_blocks
)) {

771 
r
 = 
	`blocks_¨e_unm≠≥d_‹_˛ón
(
cmd
, 
√w_ˇche_size
, cmd->
ˇche_blocks
, &
˛ón
);

772 i‡(
r
) {

773 
	`__dm_unbÀss_f‹_disk
(&
nuŒ_m≠pög
);

774 
out
;

777 i‡(!
˛ón
) {

778 
	`DMERR
("unableÅo shrink cache dueÅo dirty blocks");

779 
r
 = -
EINVAL
;

780 
	`__dm_unbÀss_f‹_disk
(&
nuŒ_m≠pög
);

781 
out
;

785 
r
 = 
	`dm_¨øy_ªsize
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(cmd->
ˇche_blocks
),

786 
	`‰om_cblock
(
√w_ˇche_size
),

787 &
nuŒ_m≠pög
, &
cmd
->
roŸ
);

788 i‡(!
r
)

789 
cmd
->
ˇche_blocks
 = 
√w_ˇche_size
;

790 
cmd
->
ch™ged
 = 
åue
;

792 
out
:

793 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

795  
r
;

796 
	}
}

798 
	$dm_ˇche_disˇrd_bô£t_ªsize
(
dm_ˇche_mëad©a
 *
cmd
,

799 
£˘‹_t
 
disˇrd_block_size
,

800 
dm_oblock_t
 
√w_ƒ_íåõs
)

802 
r
;

804 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

805 
r
 = 
	`dm_bô£t_ªsize
(&
cmd
->
disˇrd_öfo
,

806 
cmd
->
disˇrd_roŸ
,

807 
	`‰om_oblock
(
cmd
->
disˇrd_ƒ_blocks
),

808 
	`‰om_oblock
(
√w_ƒ_íåõs
),

809 
Ál£
, &
cmd
->
disˇrd_roŸ
);

810 i‡(!
r
) {

811 
cmd
->
disˇrd_block_size
 = discard_block_size;

812 
cmd
->
disˇrd_ƒ_blocks
 = 
√w_ƒ_íåõs
;

815 
cmd
->
ch™ged
 = 
åue
;

816 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

818  
r
;

819 
	}
}

821 
	$__£t_disˇrd
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_oblock_t
 
b
)

823  
	`dm_bô£t_£t_bô
(&
cmd
->
disˇrd_öfo
, cmd->
disˇrd_roŸ
,

824 
	`‰om_oblock
(
b
), &
cmd
->
disˇrd_roŸ
);

825 
	}
}

827 
	$__˛ór_disˇrd
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_oblock_t
 
b
)

829  
	`dm_bô£t_˛ór_bô
(&
cmd
->
disˇrd_öfo
, cmd->
disˇrd_roŸ
,

830 
	`‰om_oblock
(
b
), &
cmd
->
disˇrd_roŸ
);

831 
	}
}

833 
	$__is_disˇrded
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_oblock_t
 
b
,

834 
boﬁ
 *
is_disˇrded
)

836  
	`dm_bô£t_ã°_bô
(&
cmd
->
disˇrd_öfo
, cmd->
disˇrd_roŸ
,

837 
	`‰om_oblock
(
b
), &
cmd
->
disˇrd_roŸ
,

838 
is_disˇrded
);

839 
	}
}

841 
	$__disˇrd
(
dm_ˇche_mëad©a
 *
cmd
,

842 
dm_oblock_t
 
dblock
, 
boﬁ
 
disˇrd
)

844 
r
;

846 
r
 = (
disˇrd
 ? 
__£t_disˇrd
 : 
__˛ór_disˇrd
)(
cmd
, 
dblock
);

847 i‡(
r
)

848  
r
;

850 
cmd
->
ch™ged
 = 
åue
;

852 
	}
}

854 
	$dm_ˇche_£t_disˇrd
(
dm_ˇche_mëad©a
 *
cmd
,

855 
dm_oblock_t
 
dblock
, 
boﬁ
 
disˇrd
)

857 
r
;

859 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

860 
r
 = 
	`__disˇrd
(
cmd
, 
dblock
, 
disˇrd
);

861 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

863  
r
;

864 
	}
}

866 
	$__lﬂd_disˇrds
(
dm_ˇche_mëad©a
 *
cmd
,

867 
lﬂd_disˇrd_‚
 
‚
, *
c⁄ãxt
)

869 
r
 = 0;

870 
dm_block_t
 
b
;

871 
boﬁ
 
disˇrd
;

873 
b
 = 0; b < 
	`‰om_oblock
(
cmd
->
disˇrd_ƒ_blocks
); b++) {

874 
dm_oblock_t
 
dblock
 = 
	`to_oblock
(
b
);

876 i‡(
cmd
->
˛ón_whí_›íed
) {

877 
r
 = 
	`__is_disˇrded
(
cmd
, 
dblock
, &
disˇrd
);

878 i‡(
r
)

879  
r
;

881 
disˇrd
 = 
Ál£
;

883 
r
 = 
	`‚
(
c⁄ãxt
, 
cmd
->
disˇrd_block_size
, 
dblock
, 
disˇrd
);

884 i‡(
r
)

888  
r
;

889 
	}
}

891 
	$dm_ˇche_lﬂd_disˇrds
(
dm_ˇche_mëad©a
 *
cmd
,

892 
lﬂd_disˇrd_‚
 
‚
, *
c⁄ãxt
)

894 
r
;

896 
	`down_ªad
(&
cmd
->
roŸ_lock
);

897 
r
 = 
	`__lﬂd_disˇrds
(
cmd
, 
‚
, 
c⁄ãxt
);

898 
	`up_ªad
(&
cmd
->
roŸ_lock
);

900  
r
;

901 
	}
}

903 
dm_cblock_t
 
	$dm_ˇche_size
(
dm_ˇche_mëad©a
 *
cmd
)

905 
dm_cblock_t
 
r
;

907 
	`down_ªad
(&
cmd
->
roŸ_lock
);

908 
r
 = 
cmd
->
ˇche_blocks
;

909 
	`up_ªad
(&
cmd
->
roŸ_lock
);

911  
r
;

912 
	}
}

914 
	$__ªmove
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
)

916 
r
;

917 
__À64
 
vÆue
 = 
	`∑ck_vÆue
(0, 0);

919 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

920 
r
 = 
	`dm_¨øy_£t_vÆue
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(
cblock
),

921 &
vÆue
, &
cmd
->
roŸ
);

922 i‡(
r
)

923  
r
;

925 
cmd
->
ch™ged
 = 
åue
;

927 
	}
}

929 
	$dm_ˇche_ªmove_m≠pög
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
)

931 
r
;

933 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

934 
r
 = 
	`__ªmove
(
cmd
, 
cblock
);

935 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

937  
r
;

938 
	}
}

940 
	$__ö£π
(
dm_ˇche_mëad©a
 *
cmd
,

941 
dm_cblock_t
 
cblock
, 
dm_oblock_t
 
oblock
)

943 
r
;

944 
__À64
 
vÆue
 = 
	`∑ck_vÆue
(
oblock
, 
M_VALID
);

945 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

947 
r
 = 
	`dm_¨øy_£t_vÆue
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(
cblock
),

948 &
vÆue
, &
cmd
->
roŸ
);

949 i‡(
r
)

950  
r
;

952 
cmd
->
ch™ged
 = 
åue
;

954 
	}
}

956 
	$dm_ˇche_ö£π_m≠pög
(
dm_ˇche_mëad©a
 *
cmd
,

957 
dm_cblock_t
 
cblock
, 
dm_oblock_t
 
oblock
)

959 
r
;

961 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

962 
r
 = 
	`__ö£π
(
cmd
, 
cblock
, 
oblock
);

963 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

965  
r
;

966 
	}
}

968 
	sthunk
 {

969 
lﬂd_m≠pög_‚
 
	m‚
;

970 *
	mc⁄ãxt
;

972 
dm_ˇche_mëad©a
 *
	mcmd
;

973 
boﬁ
 
	mª•e˘_dúty_Êags
;

974 
boﬁ
 
	mhöts_vÆid
;

977 
boﬁ
 
	$pﬁicy_unch™ged
(
dm_ˇche_mëad©a
 *
cmd
,

978 
dm_ˇche_pﬁicy
 *
pﬁicy
)

980 c⁄° *
pﬁicy_«me
 = 
	`dm_ˇche_pﬁicy_gë_«me
(
pﬁicy
);

981 c⁄° *
pﬁicy_vîsi⁄
 = 
	`dm_ˇche_pﬁicy_gë_vîsi⁄
(
pﬁicy
);

982 
size_t
 
pﬁicy_höt_size
 = 
	`dm_ˇche_pﬁicy_gë_höt_size
(
pﬁicy
);

987 i‡(
	`°∫cmp
(
cmd
->
pﬁicy_«me
,Öolicy_name, (cmd->policy_name)))

988  
Ál£
;

993 i‡(
cmd
->
pﬁicy_vîsi⁄
[0] !=Öolicy_version[0])

994  
Ál£
;

999 i‡(
cmd
->
pﬁicy_höt_size
 !=Öolicy_hint_size)

1000  
Ál£
;

1002  
åue
;

1003 
	}
}

1005 
boﬁ
 
	$höts_¨øy_öôülized
(
dm_ˇche_mëad©a
 *
cmd
)

1007  
cmd
->
höt_roŸ
 && cmd->
pﬁicy_höt_size
;

1008 
	}
}

1010 
boﬁ
 
	$höts_¨øy_avaûabÀ
(
dm_ˇche_mëad©a
 *
cmd
,

1011 
dm_ˇche_pﬁicy
 *
pﬁicy
)

1013  
cmd
->
˛ón_whí_›íed
 && 
	`pﬁicy_unch™ged
(cmd, 
pﬁicy
) &&

1014 
	`höts_¨øy_öôülized
(
cmd
);

1015 
	}
}

1017 
	$__lﬂd_m≠pög
(*
c⁄ãxt
, 
uöt64_t
 
cblock
, *
Àaf
)

1019 
r
 = 0;

1020 
boﬁ
 
dúty
;

1021 
__À64
 
vÆue
;

1022 
__À32
 
höt_vÆue
 = 0;

1023 
dm_oblock_t
 
oblock
;

1024 
Êags
;

1025 
thunk
 *thunk = 
c⁄ãxt
;

1026 
dm_ˇche_mëad©a
 *
cmd
 = 
thunk
->cmd;

1028 
	`mem˝y
(&
vÆue
, 
Àaf
, (value));

1029 
	`u≈ack_vÆue
(
vÆue
, &
oblock
, &
Êags
);

1031 i‡(
Êags
 & 
M_VALID
) {

1032 i‡(
thunk
->
höts_vÆid
) {

1033 
r
 = 
	`dm_¨øy_gë_vÆue
(&
cmd
->
höt_öfo
, cmd->
höt_roŸ
,

1034 
cblock
, &
höt_vÆue
);

1035 i‡(
r
 &&Ñ !-
ENODATA
)

1036  
r
;

1039 
dúty
 = 
thunk
->
ª•e˘_dúty_Êags
 ? (
Êags
 & 
M_DIRTY
Ë: 
åue
;

1040 
r
 = 
thunk
->
	`‚
—hunk->
c⁄ãxt
, 
oblock
, 
	`to_cblock
(
cblock
),

1041 
dúty
, 
	`À32_to_˝u
(
höt_vÆue
), 
thunk
->
höts_vÆid
);

1044  
r
;

1045 
	}
}

1047 
	$__lﬂd_m≠pögs
(
dm_ˇche_mëad©a
 *
cmd
,

1048 
dm_ˇche_pﬁicy
 *
pﬁicy
,

1049 
lﬂd_m≠pög_‚
 
‚
, *
c⁄ãxt
)

1051 
thunk
Åhunk;

1053 
thunk
.
‚
 = fn;

1054 
thunk
.
c⁄ãxt
 = context;

1056 
thunk
.
cmd
 = cmd;

1057 
thunk
.
ª•e˘_dúty_Êags
 = 
cmd
->
˛ón_whí_›íed
;

1058 
thunk
.
höts_vÆid
 = 
	`höts_¨øy_avaûabÀ
(
cmd
, 
pﬁicy
);

1060  
	`dm_¨øy_wÆk
(&
cmd
->
öfo
, cmd->
roŸ
, 
__lﬂd_m≠pög
, &
thunk
);

1061 
	}
}

1063 
	$dm_ˇche_lﬂd_m≠pögs
(
dm_ˇche_mëad©a
 *
cmd
,

1064 
dm_ˇche_pﬁicy
 *
pﬁicy
,

1065 
lﬂd_m≠pög_‚
 
‚
, *
c⁄ãxt
)

1067 
r
;

1069 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1070 
r
 = 
	`__lﬂd_m≠pögs
(
cmd
, 
pﬁicy
, 
‚
, 
c⁄ãxt
);

1071 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1073  
r
;

1074 
	}
}

1076 
	$__dump_m≠pög
(*
c⁄ãxt
, 
uöt64_t
 
cblock
, *
Àaf
)

1078 
r
 = 0;

1079 
__À64
 
vÆue
;

1080 
dm_oblock_t
 
oblock
;

1081 
Êags
;

1083 
	`mem˝y
(&
vÆue
, 
Àaf
, (value));

1084 
	`u≈ack_vÆue
(
vÆue
, &
oblock
, &
Êags
);

1086  
r
;

1087 
	}
}

1089 
	$__dump_m≠pögs
(
dm_ˇche_mëad©a
 *
cmd
)

1091  
	`dm_¨øy_wÆk
(&
cmd
->
öfo
, cmd->
roŸ
, 
__dump_m≠pög
, 
NULL
);

1092 
	}
}

1094 
	$dm_ˇche_dump
(
dm_ˇche_mëad©a
 *
cmd
)

1096 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1097 
	`__dump_m≠pögs
(
cmd
);

1098 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1099 
	}
}

1101 
	$dm_ˇche_ch™ged_this_å™ß˘i⁄
(
dm_ˇche_mëad©a
 *
cmd
)

1103 
r
;

1105 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1106 
r
 = 
cmd
->
ch™ged
;

1107 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1109  
r
;

1110 
	}
}

1112 
	$__dúty
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
, 
boﬁ
 
dúty
)

1114 
r
;

1115 
Êags
;

1116 
dm_oblock_t
 
oblock
;

1117 
__À64
 
vÆue
;

1119 
r
 = 
	`dm_¨øy_gë_vÆue
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(
cblock
), &
vÆue
);

1120 i‡(
r
)

1121  
r
;

1123 
	`u≈ack_vÆue
(
vÆue
, &
oblock
, &
Êags
);

1125 i‡(((
Êags
 & 
M_DIRTY
Ë&& 
dúty
) || (!(flags & M_DIRTY) && !dirty))

1129 
vÆue
 = 
	`∑ck_vÆue
(
oblock
, (
Êags
 & ~
M_DIRTY
Ë| (
dúty
 ? M_DIRTY : 0));

1130 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

1132 
r
 = 
	`dm_¨øy_£t_vÆue
(&
cmd
->
öfo
, cmd->
roŸ
, 
	`‰om_cblock
(
cblock
),

1133 &
vÆue
, &
cmd
->
roŸ
);

1134 i‡(
r
)

1135  
r
;

1137 
cmd
->
ch™ged
 = 
åue
;

1140 
	}
}

1142 
	$dm_ˇche_£t_dúty
(
dm_ˇche_mëad©a
 *
cmd
,

1143 
dm_cblock_t
 
cblock
, 
boﬁ
 
dúty
)

1145 
r
;

1147 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

1148 
r
 = 
	`__dúty
(
cmd
, 
cblock
, 
dúty
);

1149 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

1151  
r
;

1152 
	}
}

1154 
	$dm_ˇche_mëad©a_gë_°©s
(
dm_ˇche_mëad©a
 *
cmd
,

1155 
dm_ˇche_°©i°ics
 *
°©s
)

1157 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1158 *
°©s
 = 
cmd
->stats;

1159 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1160 
	}
}

1162 
	$dm_ˇche_mëad©a_£t_°©s
(
dm_ˇche_mëad©a
 *
cmd
,

1163 
dm_ˇche_°©i°ics
 *
°©s
)

1165 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

1166 
cmd
->
°©s
 = *stats;

1167 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

1168 
	}
}

1170 
	$dm_ˇche_commô
(
dm_ˇche_mëad©a
 *
cmd
, 
boﬁ
 
˛ón_shutdown
)

1172 
r
;

1173 
Êags_muèt‹
 
muèt‹
 = (
˛ón_shutdown
 ? 
£t_˛ón_shutdown
 :

1174 
˛ór_˛ón_shutdown
);

1176 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

1177 
r
 = 
	`__commô_å™ß˘i⁄
(
cmd
, 
muèt‹
);

1178 i‡(
r
)

1179 
out
;

1181 
r
 = 
	`__begö_å™ß˘i⁄
(
cmd
);

1183 
out
:

1184 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

1185  
r
;

1186 
	}
}

1188 
	$dm_ˇche_gë_‰ì_mëad©a_block_cou¡
(
dm_ˇche_mëad©a
 *
cmd
,

1189 
dm_block_t
 *
ªsu…
)

1191 
r
 = -
EINVAL
;

1193 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1194 
r
 = 
	`dm_sm_gë_ƒ_‰ì
(
cmd
->
mëad©a_sm
, 
ªsu…
);

1195 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1197  
r
;

1198 
	}
}

1200 
	$dm_ˇche_gë_mëad©a_dev_size
(
dm_ˇche_mëad©a
 *
cmd
,

1201 
dm_block_t
 *
ªsu…
)

1203 
r
 = -
EINVAL
;

1205 
	`down_ªad
(&
cmd
->
roŸ_lock
);

1206 
r
 = 
	`dm_sm_gë_ƒ_blocks
(
cmd
->
mëad©a_sm
, 
ªsu…
);

1207 
	`up_ªad
(&
cmd
->
roŸ_lock
);

1209  
r
;

1210 
	}
}

1214 
	$begö_höts
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_ˇche_pﬁicy
 *
pﬁicy
)

1216 
r
;

1217 
__À32
 
vÆue
;

1218 
size_t
 
höt_size
;

1219 c⁄° *
pﬁicy_«me
 = 
	`dm_ˇche_pﬁicy_gë_«me
(
pﬁicy
);

1220 c⁄° *
pﬁicy_vîsi⁄
 = 
	`dm_ˇche_pﬁicy_gë_vîsi⁄
(
pﬁicy
);

1222 i‡(!
pﬁicy_«me
[0] ||

1223 (
	`°æí
(
pﬁicy_«me
Ë> (
cmd
->policy_name) - 1))

1224  -
EINVAL
;

1226 i‡(!
	`pﬁicy_unch™ged
(
cmd
, 
pﬁicy
)) {

1227 
	`°∫˝y
(
cmd
->
pﬁicy_«me
,Öolicy_name, (cmd->policy_name));

1228 
	`mem˝y
(
cmd
->
pﬁicy_vîsi⁄
,Öolicy_version, (cmd->policy_version));

1230 
höt_size
 = 
	`dm_ˇche_pﬁicy_gë_höt_size
(
pﬁicy
);

1231 i‡(!
höt_size
)

1233 
cmd
->
pﬁicy_höt_size
 = 
höt_size
;

1235 i‡(
cmd
->
höt_roŸ
) {

1236 
r
 = 
	`dm_¨øy_dñ
(&
cmd
->
höt_öfo
, cmd->
höt_roŸ
);

1237 i‡(
r
)

1238  
r
;

1241 
r
 = 
	`dm_¨øy_em±y
(&
cmd
->
höt_öfo
, &cmd->
höt_roŸ
);

1242 i‡(
r
)

1243  
r
;

1245 
vÆue
 = 
	`˝u_to_À32
(0);

1246 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

1247 
r
 = 
	`dm_¨øy_ªsize
(&
cmd
->
höt_öfo
, cmd->
höt_roŸ
, 0,

1248 
	`‰om_cblock
(
cmd
->
ˇche_blocks
),

1249 &
vÆue
, &
cmd
->
höt_roŸ
);

1250 i‡(
r
)

1251  
r
;

1255 
	}
}

1257 
	$ßve_höt
(*
c⁄ãxt
, 
dm_cblock_t
 
cblock
, 
dm_oblock_t
 
oblock
, 
uöt32_t
 
höt
)

1259 
dm_ˇche_mëad©a
 *
cmd
 = 
c⁄ãxt
;

1260 
__À32
 
vÆue
 = 
	`˝u_to_À32
(
höt
);

1261 
r
;

1263 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

1265 
r
 = 
	`dm_¨øy_£t_vÆue
(&
cmd
->
höt_öfo
, cmd->
höt_roŸ
,

1266 
	`‰om_cblock
(
cblock
), &
vÆue
, &
cmd
->
höt_roŸ
);

1267 
cmd
->
ch™ged
 = 
åue
;

1269  
r
;

1270 
	}
}

1272 
	$wrôe_höts
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_ˇche_pﬁicy
 *
pﬁicy
)

1274 
r
;

1276 
r
 = 
	`begö_höts
(
cmd
, 
pﬁicy
);

1277 i‡(
r
) {

1278 
	`DMERR
("begin_hints failed");

1279  
r
;

1282  
	`pﬁicy_wÆk_m≠pögs
(
pﬁicy
, 
ßve_höt
, 
cmd
);

1283 
	}
}

1285 
	$dm_ˇche_wrôe_höts
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_ˇche_pﬁicy
 *
pﬁicy
)

1287 
r
;

1289 
	`down_wrôe
(&
cmd
->
roŸ_lock
);

1290 
r
 = 
	`wrôe_höts
(
cmd
, 
pﬁicy
);

1291 
	`up_wrôe
(&
cmd
->
roŸ_lock
);

1293  
r
;

1294 
	}
}

1296 
	$dm_ˇche_mëad©a_Æl_˛ón
(
dm_ˇche_mëad©a
 *
cmd
, 
boﬁ
 *
ªsu…
)

1298  
	`blocks_¨e_unm≠≥d_‹_˛ón
(
cmd
, 0, cmd->
ˇche_blocks
, 
ªsu…
);

1299 
	}
}

	@dm-cache-metadata.h

7 #i‚de‡
DM_CACHE_METADATA_H


8 
	#DM_CACHE_METADATA_H


	)

10 
	~"dm-ˇche-block-ty≥s.h
"

11 
	~"dm-ˇche-pﬁicy-öã∫Æ.h
"

12 
	~"≥rsi°ít-d©a/dm-•a˚-m≠-mëad©a.h
"

16 
	#DM_CACHE_METADATA_BLOCK_SIZE
 
DM_SM_METADATA_BLOCK_SIZE


	)

22 
	#DM_CACHE_METADATA_MAX_SECTORS
 
DM_SM_METADATA_MAX_SECTORS


	)

27 
	#DM_CACHE_METADATA_MAX_SECTORS_WARNING
 (16 * (1024 * 1024 * 1024 >> 
SECTOR_SHIFT
))

	)

48 
	#DM_CACHE_FEATURE_COMPAT_SUPP
 0UL

	)

49 
	#DM_CACHE_FEATURE_COMPAT_RO_SUPP
 0UL

	)

50 
	#DM_CACHE_FEATURE_INCOMPAT_SUPP
 0UL

	)

56 
dm_ˇche_mëad©a
 *
dm_ˇche_mëad©a_›í
(
block_devi˚
 *
bdev
,

57 
£˘‹_t
 
d©a_block_size
,

58 
boﬁ
 
may_f‹m©_devi˚
,

59 
size_t
 
pﬁicy_höt_size
);

61 
dm_ˇche_mëad©a_˛o£
(
dm_ˇche_mëad©a
 *
cmd
);

68 
dm_ˇche_ªsize
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
√w_ˇche_size
);

69 
dm_cblock_t
 
dm_ˇche_size
(
dm_ˇche_mëad©a
 *
cmd
);

71 
dm_ˇche_disˇrd_bô£t_ªsize
(
dm_ˇche_mëad©a
 *
cmd
,

72 
£˘‹_t
 
disˇrd_block_size
,

73 
dm_oblock_t
 
√w_ƒ_íåõs
);

75 (*
	tlﬂd_disˇrd_‚
)(*
	tc⁄ãxt
, 
	t£˘‹_t
 
	tdisˇrd_block_size
,

76 
	tdm_oblock_t
 
	tdblock
, 
	tboﬁ
 
	tdisˇrded
);

77 
	`dm_ˇche_lﬂd_disˇrds
(
dm_ˇche_mëad©a
 *
cmd
,

78 
lﬂd_disˇrd_‚
 
‚
, *
c⁄ãxt
);

80 
	`dm_ˇche_£t_disˇrd
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_oblock_t
 
dblock
, 
boﬁ
 
disˇrd
);

82 
	`dm_ˇche_ªmove_m≠pög
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
);

83 
	`dm_ˇche_ö£π_m≠pög
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
, 
dm_oblock_t
 
oblock
);

84 
	`dm_ˇche_ch™ged_this_å™ß˘i⁄
(
dm_ˇche_mëad©a
 *
cmd
);

86 (*
	tlﬂd_m≠pög_‚
)(*
	tc⁄ãxt
, 
	tdm_oblock_t
 
	toblock
,

87 
	tdm_cblock_t
 
	tcblock
, 
	tboﬁ
 
	tdúty
,

88 
	tuöt32_t
 
	thöt
, 
	tboﬁ
 
	thöt_vÆid
);

89 
	`dm_ˇche_lﬂd_m≠pögs
(
dm_ˇche_mëad©a
 *
cmd
,

90 
dm_ˇche_pﬁicy
 *
pﬁicy
,

91 
lﬂd_m≠pög_‚
 
‚
,

92 *
c⁄ãxt
);

94 
	`dm_ˇche_£t_dúty
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_cblock_t
 
cblock
, 
boﬁ
 
dúty
);

96 
	sdm_ˇche_°©i°ics
 {

97 
uöt32_t
 
ªad_hôs
;

98 
uöt32_t
 
ªad_mis£s
;

99 
uöt32_t
 
wrôe_hôs
;

100 
uöt32_t
 
wrôe_mis£s
;

103 
	`dm_ˇche_mëad©a_gë_°©s
(
dm_ˇche_mëad©a
 *
cmd
,

104 
dm_ˇche_°©i°ics
 *
°©s
);

105 
	`dm_ˇche_mëad©a_£t_°©s
(
dm_ˇche_mëad©a
 *
cmd
,

106 
dm_ˇche_°©i°ics
 *
°©s
);

108 
	`dm_ˇche_commô
(
dm_ˇche_mëad©a
 *
cmd
, 
boﬁ
 
˛ón_shutdown
);

110 
	`dm_ˇche_gë_‰ì_mëad©a_block_cou¡
(
dm_ˇche_mëad©a
 *
cmd
,

111 
dm_block_t
 *
ªsu…
);

113 
	`dm_ˇche_gë_mëad©a_dev_size
(
dm_ˇche_mëad©a
 *
cmd
,

114 
dm_block_t
 *
ªsu…
);

116 
	`dm_ˇche_dump
(
dm_ˇche_mëad©a
 *
cmd
);

129 
	`dm_ˇche_wrôe_höts
(
dm_ˇche_mëad©a
 *
cmd
, 
dm_ˇche_pﬁicy
 *
p
);

134 
	`dm_ˇche_mëad©a_Æl_˛ón
(
dm_ˇche_mëad©a
 *
cmd
, 
boﬁ
 *
ªsu…
);

	@dm-cache-mq.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

24 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

25 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

26 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

27 { 0xbd4b63be, 
__VMLINUX_SYMBOL_STR
(
dm_ˇche_pﬁicy_ªgi°î
) },

28 { 0xcf2786a9, 
__VMLINUX_SYMBOL_STR
(
muãx_åylock
) },

29 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

30 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

31 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

32 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

33 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

34 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

35 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

36 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

37 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

38 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

39 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

40 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

41 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

42 { 0xe585fb9c, 
__VMLINUX_SYMBOL_STR
(
dm_ˇche_pﬁicy_uƒegi°î
) },

45 c⁄° 
	g__moduÀ_dïíds
[]

46 
__u£d


47 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

51 
MODULE_INFO
(
§cvîsi⁄
, "E80F14932D32BB93F521740");

	@dm-cache-policy-cleaner.c

9 
	~"dm-ˇche-pﬁicy.h
"

10 
	~"dm.h
"

12 
	~<löux/hash.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/vmÆloc.h
>

19 
	#DM_MSG_PREFIX
 "ˇchê˛ó√r"

	)

22 
	swb_ˇche_íåy
 {

23 
li°_hód
 
	mli°
;

24 
hli°_node
 
	mhli°
;

26 
dm_oblock_t
 
	moblock
;

27 
dm_cblock_t
 
	mcblock
;

28 
boﬁ
 
	mdúty
:1;

29 
boﬁ
 
	m≥ndög
:1;

32 
	shash
 {

33 
hli°_hód
 *
	mèbÀ
;

34 
dm_block_t
 
	mhash_bôs
;

35 
	mƒ_buckës
;

38 
	spﬁicy
 {

39 
dm_ˇche_pﬁicy
 
	mpﬁicy
;

40 
•ölock_t
 
	mlock
;

42 
li°_hód
 
	m‰ì
;

43 
li°_hód
 
	m˛ón
;

44 
li°_hód
 
	m˛ón_≥ndög
;

45 
li°_hód
 
	mdúty
;

51 
dm_cblock_t
 
	mˇche_size
, 
	mƒ_cblocks_Æloˇãd
;

52 
wb_ˇche_íåy
 *
	mcblocks
;

53 
hash
 
	mchash
;

61 
	$√xt_powî
(
n
, 
mö
)

63  
	`roundup_pow_of_two
(
	`max
(
n
, 
mö
));

64 
	}
}

66 
pﬁicy
 *
	$to_pﬁicy
(
dm_ˇche_pﬁicy
 *
p
)

68  
	`c⁄èöî_of
(
p
, 
pﬁicy
,Öolicy);

69 
	}
}

71 
li°_hód
 *
	$li°_p›
(
li°_hód
 *
q
)

73 
li°_hód
 *
r
 = 
q
->
√xt
;

75 
	`li°_dñ
(
r
);

77  
r
;

78 
	}
}

83 
	$Æloc_hash
(
hash
 *hash, 
ñts
)

85 
hash
->
ƒ_buckës
 = 
	`√xt_powî
(
ñts
 >> 4, 16);

86 
hash
->
hash_bôs
 = 
	`ffs
(hash->
ƒ_buckës
) - 1;

87 
hash
->
èbÀ
 = 
	`vzÆloc
((*hash->èbÀË* hash->
ƒ_buckës
);

89  
hash
->
èbÀ
 ? 0 : -
ENOMEM
;

90 
	}
}

92 
	$‰ì_hash
(
hash
 *hash)

94 
	`v‰ì
(
hash
->
èbÀ
);

95 
	}
}

97 
	$Æloc_ˇche_blocks_wôh_hash
(
pﬁicy
 *
p
, 
dm_cblock_t
 
ˇche_size
)

99 
r
 = -
ENOMEM
;

101 
p
->
cblocks
 = 
	`vzÆloc
((*p->cblocksË* 
	`‰om_cblock
(
ˇche_size
));

102 i‡(
p
->
cblocks
) {

103 
u
 = 
	`‰om_cblock
(
ˇche_size
);

105 
u
--)

106 
	`li°_add
(&
p
->
cblocks
[
u
].
li°
, &p->
‰ì
);

108 
p
->
ƒ_cblocks_Æloˇãd
 = 0;

111 
r
 = 
	`Æloc_hash
(&
p
->
chash
, 
	`‰om_cblock
(
ˇche_size
));

112 i‡(
r
)

113 
	`v‰ì
(
p
->
cblocks
);

116  
r
;

117 
	}
}

119 
	$‰ì_ˇche_blocks_™d_hash
(
pﬁicy
 *
p
)

121 
	`‰ì_hash
(&
p
->
chash
);

122 
	`v‰ì
(
p
->
cblocks
);

123 
	}
}

125 
wb_ˇche_íåy
 *
	$Æloc_ˇche_íåy
(
pﬁicy
 *
p
)

127 
wb_ˇche_íåy
 *
e
;

129 
	`BUG_ON
(
	`‰om_cblock
(
p
->
ƒ_cblocks_Æloˇãd
Ë>‰om_cblock’->
ˇche_size
));

131 
e
 = 
	`li°_íåy
(
	`li°_p›
(&
p
->
‰ì
), 
wb_ˇche_íåy
, 
li°
);

132 
p
->
ƒ_cblocks_Æloˇãd
 = 
	`to_cblock
(
	`‰om_cblock
(p->nr_cblocks_allocated) + 1);

134  
e
;

135 
	}
}

140 
wb_ˇche_íåy
 *
	$lookup_ˇche_íåy
(
pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

142 
hash
 *hash = &
p
->
chash
;

143 
h
 = 
	`hash_64
(
	`‰om_oblock
(
oblock
), 
hash
->
hash_bôs
);

144 
wb_ˇche_íåy
 *
cur
;

145 
hli°_hód
 *
buckë
 = &
hash
->
èbÀ
[
h
];

147 
	`hli°_f‹_óch_íåy
(
cur
, 
buckë
, 
hli°
) {

148 i‡(
cur
->
oblock
 == oblock) {

150 
	`hli°_dñ
(&
cur
->
hli°
);

151 
	`hli°_add_hód
(&
cur
->
hli°
, 
buckë
);

152  
cur
;

156  
NULL
;

157 
	}
}

159 
	$ö£π_ˇche_hash_íåy
(
pﬁicy
 *
p
, 
wb_ˇche_íåy
 *
e
)

161 
h
 = 
	`hash_64
(
	`‰om_oblock
(
e
->
oblock
), 
p
->
chash
.
hash_bôs
);

163 
	`hli°_add_hód
(&
e
->
hli°
, &
p
->
chash
.
èbÀ
[
h
]);

164 
	}
}

166 
	$ªmove_ˇche_hash_íåy
(
wb_ˇche_íåy
 *
e
)

168 
	`hli°_dñ
(&
e
->
hli°
);

169 
	}
}

172 
	$wb_m≠
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
,

173 
boﬁ
 
ˇn_block
, boﬁ 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

174 
bio
 *bio, 
pﬁicy_ªsu…
 *
ªsu…
)

176 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

177 
wb_ˇche_íåy
 *
e
;

178 
Êags
;

180 
ªsu…
->
›
 = 
POLICY_MISS
;

182 i‡(
ˇn_block
)

183 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

185 i‡(!
	`•ö_åylock_úqßve
(&
p
->
lock
, 
Êags
))

186  -
EWOULDBLOCK
;

188 
e
 = 
	`lookup_ˇche_íåy
(
p
, 
oblock
);

189 i‡(
e
) {

190 
ªsu…
->
›
 = 
POLICY_HIT
;

191 
ªsu…
->
cblock
 = 
e
->cblock;

195 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

198 
	}
}

200 
	$wb_lookup
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 *
cblock
)

202 
r
;

203 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

204 
wb_ˇche_íåy
 *
e
;

205 
Êags
;

207 i‡(!
	`•ö_åylock_úqßve
(&
p
->
lock
, 
Êags
))

208  -
EWOULDBLOCK
;

210 
e
 = 
	`lookup_ˇche_íåy
(
p
, 
oblock
);

211 i‡(
e
) {

212 *
cblock
 = 
e
->cblock;

213 
r
 = 0;

216 
r
 = -
ENOENT
;

218 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

220  
r
;

221 
	}
}

223 
	$__£t_˛ór_dúty
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
, 
boﬁ
 
£t
)

225 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

226 
wb_ˇche_íåy
 *
e
;

228 
e
 = 
	`lookup_ˇche_íåy
(
p
, 
oblock
);

229 
	`BUG_ON
(!
e
);

231 i‡(
£t
) {

232 i‡(!
e
->
dúty
) {

233 
e
->
dúty
 = 
åue
;

234 
	`li°_move
(&
e
->
li°
, &
p
->
dúty
);

238 i‡(
e
->
dúty
) {

239 
e
->
≥ndög
 = 
Ál£
;

240 
e
->
dúty
 = 
Ál£
;

241 
	`li°_move
(&
e
->
li°
, &
p
->
˛ón
);

244 
	}
}

246 
	$wb_£t_dúty
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
)

248 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

249 
Êags
;

251 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

252 
	`__£t_˛ór_dúty
(
≥
, 
oblock
, 
åue
);

253 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

254 
	}
}

256 
	$wb_˛ór_dúty
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
)

258 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

259 
Êags
;

261 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

262 
	`__£t_˛ór_dúty
(
≥
, 
oblock
, 
Ál£
);

263 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

264 
	}
}

266 
	$add_ˇche_íåy
(
pﬁicy
 *
p
, 
wb_ˇche_íåy
 *
e
)

268 
	`ö£π_ˇche_hash_íåy
(
p
, 
e
);

269 i‡(
e
->
dúty
)

270 
	`li°_add
(&
e
->
li°
, &
p
->
dúty
);

272 
	`li°_add
(&
e
->
li°
, &
p
->
˛ón
);

273 
	}
}

275 
	$wb_lﬂd_m≠pög
(
dm_ˇche_pﬁicy
 *
≥
,

276 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

277 
uöt32_t
 
höt
, 
boﬁ
 
höt_vÆid
)

279 
r
;

280 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

281 
wb_ˇche_íåy
 *
e
 = 
	`Æloc_ˇche_íåy
(
p
);

283 i‡(
e
) {

284 
e
->
cblock
 = cblock;

285 
e
->
oblock
 = oblock;

286 
e
->
dúty
 = 
Ál£
;

287 
	`add_ˇche_íåy
(
p
, 
e
);

288 
r
 = 0;

291 
r
 = -
ENOMEM
;

293  
r
;

294 
	}
}

296 
	$wb_de°roy
(
dm_ˇche_pﬁicy
 *
≥
)

298 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

300 
	`‰ì_ˇche_blocks_™d_hash
(
p
);

301 
	`k‰ì
(
p
);

302 
	}
}

304 
wb_ˇche_íåy
 *
	$__wb_f‹˚_ªmove_m≠pög
(
pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

306 
wb_ˇche_íåy
 *
r
 = 
	`lookup_ˇche_íåy
(
p
, 
oblock
);

308 
	`BUG_ON
(!
r
);

310 
	`ªmove_ˇche_hash_íåy
(
r
);

311 
	`li°_dñ
(&
r
->
li°
);

313  
r
;

314 
	}
}

316 
	$wb_ªmove_m≠pög
(
dm_ˇche_pﬁicy
 *
≥
, 
dm_oblock_t
 
oblock
)

318 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

319 
wb_ˇche_íåy
 *
e
;

320 
Êags
;

322 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

323 
e
 = 
	`__wb_f‹˚_ªmove_m≠pög
(
p
, 
oblock
);

324 
	`li°_add_èû
(&
e
->
li°
, &
p
->
‰ì
);

325 
	`BUG_ON
(!
	`‰om_cblock
(
p
->
ƒ_cblocks_Æloˇãd
));

326 
p
->
ƒ_cblocks_Æloˇãd
 = 
	`to_cblock
(
	`‰om_cblock
(p->nr_cblocks_allocated) - 1);

327 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

328 
	}
}

330 
	$wb_f‹˚_m≠pög
(
dm_ˇche_pﬁicy
 *
≥
,

331 
dm_oblock_t
 
cuºít_oblock
, dm_oblock_à
oblock
)

333 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

334 
wb_ˇche_íåy
 *
e
;

335 
Êags
;

337 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

338 
e
 = 
	`__wb_f‹˚_ªmove_m≠pög
(
p
, 
cuºít_oblock
);

339 
e
->
oblock
 = oblock;

340 
	`add_ˇche_íåy
(
p
, 
e
);

341 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

342 
	}
}

344 
wb_ˇche_íåy
 *
	$gë_√xt_dúty_íåy
(
pﬁicy
 *
p
)

346 
li°_hód
 *
l
;

347 
wb_ˇche_íåy
 *
r
;

349 i‡(
	`li°_em±y
(&
p
->
dúty
))

350  
NULL
;

352 
l
 = 
	`li°_p›
(&
p
->
dúty
);

353 
r
 = 
	`c⁄èöî_of
(
l
, 
wb_ˇche_íåy
, 
li°
);

354 
	`li°_add
(
l
, &
p
->
˛ón_≥ndög
);

356  
r
;

357 
	}
}

359 
	$wb_wrôeback_w‹k
(
dm_ˇche_pﬁicy
 *
≥
,

360 
dm_oblock_t
 *
oblock
,

361 
dm_cblock_t
 *
cblock
)

363 
r
 = -
ENOENT
;

364 
pﬁicy
 *
p
 = 
	`to_pﬁicy
(
≥
);

365 
wb_ˇche_íåy
 *
e
;

366 
Êags
;

368 
	`•ö_lock_úqßve
(&
p
->
lock
, 
Êags
);

370 
e
 = 
	`gë_√xt_dúty_íåy
(
p
);

371 i‡(
e
) {

372 *
oblock
 = 
e
->oblock;

373 *
cblock
 = 
e
->cblock;

374 
r
 = 0;

377 
	`•ö_u∆ock_úqª°‹e
(&
p
->
lock
, 
Êags
);

379  
r
;

380 
	}
}

382 
dm_cblock_t
 
	$wb_ªsidícy
(
dm_ˇche_pﬁicy
 *
≥
)

384  
	`to_pﬁicy
(
≥
)->
ƒ_cblocks_Æloˇãd
;

385 
	}
}

388 
	$öô_pﬁicy_fun˘i⁄s
(
pﬁicy
 *
p
)

390 
p
->
pﬁicy
.
de°roy
 = 
wb_de°roy
;

391 
p
->
pﬁicy
.
m≠
 = 
wb_m≠
;

392 
p
->
pﬁicy
.
lookup
 = 
wb_lookup
;

393 
p
->
pﬁicy
.
£t_dúty
 = 
wb_£t_dúty
;

394 
p
->
pﬁicy
.
˛ór_dúty
 = 
wb_˛ór_dúty
;

395 
p
->
pﬁicy
.
lﬂd_m≠pög
 = 
wb_lﬂd_m≠pög
;

396 
p
->
pﬁicy
.
wÆk_m≠pögs
 = 
NULL
;

397 
p
->
pﬁicy
.
ªmove_m≠pög
 = 
wb_ªmove_m≠pög
;

398 
p
->
pﬁicy
.
wrôeback_w‹k
 = 
wb_wrôeback_w‹k
;

399 
p
->
pﬁicy
.
f‹˚_m≠pög
 = 
wb_f‹˚_m≠pög
;

400 
p
->
pﬁicy
.
ªsidícy
 = 
wb_ªsidícy
;

401 
p
->
pﬁicy
.
tick
 = 
NULL
;

402 
	}
}

404 
dm_ˇche_pﬁicy
 *
	$wb_¸óã
(
dm_cblock_t
 
ˇche_size
,

405 
£˘‹_t
 
‹igö_size
,

406 
£˘‹_t
 
ˇche_block_size
)

408 
r
;

409 
pﬁicy
 *
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

411 i‡(!
p
)

412  
NULL
;

414 
	`öô_pﬁicy_fun˘i⁄s
(
p
);

415 
	`INIT_LIST_HEAD
(&
p
->
‰ì
);

416 
	`INIT_LIST_HEAD
(&
p
->
˛ón
);

417 
	`INIT_LIST_HEAD
(&
p
->
˛ón_≥ndög
);

418 
	`INIT_LIST_HEAD
(&
p
->
dúty
);

420 
p
->
ˇche_size
 = cache_size;

421 
	`•ö_lock_öô
(&
p
->
lock
);

424 
r
 = 
	`Æloc_ˇche_blocks_wôh_hash
(
p
, 
ˇche_size
);

425 i‡(!
r
)

426  &
p
->
pﬁicy
;

428 
	`k‰ì
(
p
);

430  
NULL
;

431 
	}
}

434 
dm_ˇche_pﬁicy_ty≥
 
	gwb_pﬁicy_ty≥
 = {

435 .
«me
 = "cleaner",

436 .
	gvîsi⁄
 = {1, 0, 0},

437 .
	ghöt_size
 = 0,

438 .
	gow√r
 = 
THIS_MODULE
,

439 .
	g¸óã
 = 
wb_¸óã


442 
__öô
 
	$wb_öô
()

444 
r
 = 
	`dm_ˇche_pﬁicy_ªgi°î
(&
wb_pﬁicy_ty≥
);

446 i‡(
r
 < 0)

447 
	`DMERR
("ªgi°î faûed %d", 
r
);

449 
	`DMINFO
("version %u.%u.%uÜoaded",

450 
wb_pﬁicy_ty≥
.
vîsi⁄
[0],

451 
wb_pﬁicy_ty≥
.
vîsi⁄
[1],

452 
wb_pﬁicy_ty≥
.
vîsi⁄
[2]);

454  
r
;

455 
	}
}

457 
__exô
 
	$wb_exô
()

459 
	`dm_ˇche_pﬁicy_uƒegi°î
(&
wb_pﬁicy_ty≥
);

460 
	}
}

462 
moduÀ_öô
(
wb_öô
);

463 
moduÀ_exô
(
wb_exô
);

465 
MODULE_AUTHOR
("Heinz Mauelshagen <dm-devel@redhat.com>");

466 
MODULE_LICENSE
("GPL");

467 
MODULE_DESCRIPTION
("cleaner cacheÖolicy");

	@dm-cache-policy-internal.h

7 #i‚de‡
DM_CACHE_POLICY_INTERNAL_H


8 
	#DM_CACHE_POLICY_INTERNAL_H


	)

10 
	~"dm-ˇche-pﬁicy.h
"

17 
ölöe
 
	$pﬁicy_m≠
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
,

18 
boﬁ
 
ˇn_block
, boﬁ 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

19 
bio
 *bio, 
pﬁicy_ªsu…
 *
ªsu…
)

21  
p
->
	`m≠
’, 
oblock
, 
ˇn_block
, 
ˇn_migøã
, 
disˇrded_oblock
, 
bio
, 
ªsu…
);

22 
	}
}

24 
ölöe
 
	$pﬁicy_lookup
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 *
cblock
)

26 
	`BUG_ON
(!
p
->
lookup
);

27  
p
->
	`lookup
’, 
oblock
, 
cblock
);

28 
	}
}

30 
ölöe
 
	$pﬁicy_£t_dúty
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

32 i‡(
p
->
£t_dúty
)

33 
p
->
	`£t_dúty
’, 
oblock
);

34 
	}
}

36 
ölöe
 
	$pﬁicy_˛ór_dúty
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

38 i‡(
p
->
˛ór_dúty
)

39 
p
->
	`˛ór_dúty
’, 
oblock
);

40 
	}
}

42 
ölöe
 
	$pﬁicy_lﬂd_m≠pög
(
dm_ˇche_pﬁicy
 *
p
,

43 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

44 
uöt32_t
 
höt
, 
boﬁ
 
höt_vÆid
)

46  
p
->
	`lﬂd_m≠pög
’, 
oblock
, 
cblock
, 
höt
, 
höt_vÆid
);

47 
	}
}

49 
ölöe
 
	$pﬁicy_wÆk_m≠pögs
(
dm_ˇche_pﬁicy
 *
p
,

50 
pﬁicy_wÆk_‚
 
‚
, *
c⁄ãxt
)

52  
p
->
wÆk_m≠pögs
 ?Ö->
	`wÆk_m≠pögs
’, 
‚
, 
c⁄ãxt
) : 0;

53 
	}
}

55 
ölöe
 
	$pﬁicy_wrôeback_w‹k
(
dm_ˇche_pﬁicy
 *
p
,

56 
dm_oblock_t
 *
oblock
,

57 
dm_cblock_t
 *
cblock
)

59  
p
->
wrôeback_w‹k
 ?Ö->
	`wrôeback_w‹k
’, 
oblock
, 
cblock
Ë: -
ENOENT
;

60 
	}
}

62 
ölöe
 
	$pﬁicy_ªmove_m≠pög
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

64 
p
->
	`ªmove_m≠pög
’, 
oblock
);

65 
	}
}

67 
ölöe
 
	$pﬁicy_ªmove_cblock
(
dm_ˇche_pﬁicy
 *
p
, 
dm_cblock_t
 
cblock
)

69  
p
->
	`ªmove_cblock
’, 
cblock
);

70 
	}
}

72 
ölöe
 
	$pﬁicy_f‹˚_m≠pög
(
dm_ˇche_pﬁicy
 *
p
,

73 
dm_oblock_t
 
cuºít_oblock
, dm_oblock_à
√w_oblock
)

75  
p
->
	`f‹˚_m≠pög
’, 
cuºít_oblock
, 
√w_oblock
);

76 
	}
}

78 
ölöe
 
dm_cblock_t
 
	$pﬁicy_ªsidícy
(
dm_ˇche_pﬁicy
 *
p
)

80  
p
->
	`ªsidícy
(p);

81 
	}
}

83 
ölöe
 
	$pﬁicy_tick
(
dm_ˇche_pﬁicy
 *
p
)

85 i‡(
p
->
tick
)

86  
p
->
	`tick
(p);

87 
	}
}

89 
ölöe
 
	$pﬁicy_emô_c⁄fig_vÆues
(
dm_ˇche_pﬁicy
 *
p
, *
ªsu…
, 
maxÀn
)

91 
ssize_t
 
sz
 = 0;

92 i‡(
p
->
emô_c⁄fig_vÆues
)

93  
p
->
	`emô_c⁄fig_vÆues
’, 
ªsu…
, 
maxÀn
);

95 
	`DMEMIT
("0");

97 
	}
}

99 
ölöe
 
	$pﬁicy_£t_c⁄fig_vÆue
(
dm_ˇche_pﬁicy
 *
p
,

100 c⁄° *
key
, c⁄° *
vÆue
)

102  
p
->
£t_c⁄fig_vÆue
 ?Ö->
	`£t_c⁄fig_vÆue
’, 
key
, 
vÆue
Ë: -
EINVAL
;

103 
	}
}

110 
dm_ˇche_pﬁicy
 *
dm_ˇche_pﬁicy_¸óã
(c⁄° *
«me
, 
dm_cblock_t
 
ˇche_size
,

111 
£˘‹_t
 
‹igö_size
, se˘‹_à
block_size
);

118 
dm_ˇche_pﬁicy_de°roy
(
dm_ˇche_pﬁicy
 *
p
);

123 c⁄° *
dm_ˇche_pﬁicy_gë_«me
(
dm_ˇche_pﬁicy
 *
p
);

125 c⁄° *
dm_ˇche_pﬁicy_gë_vîsi⁄
(
dm_ˇche_pﬁicy
 *
p
);

127 
size_t
 
dm_ˇche_pﬁicy_gë_höt_size
(
dm_ˇche_pﬁicy
 *
p
);

	@dm-cache-policy-mq.c

7 
	~"dm-ˇche-pﬁicy.h
"

8 
	~"dm.h
"

10 
	~<löux/hash.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/muãx.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/vmÆloc.h
>

16 
	#DM_MSG_PREFIX
 "ˇche-pﬁicy-mq"

	)

18 
kmem_ˇche
 *
	gmq_íåy_ˇche
;

22 
	$√xt_powî
(
n
, 
mö
)

24  
	`roundup_pow_of_two
(
	`max
(
n
, 
mö
));

25 
	}
}

39 
	#RANDOM_THRESHOLD_DEFAULT
 4

	)

40 
	#SEQUENTIAL_THRESHOLD_DEFAULT
 512

	)

42 
	eio_∑âîn
 {

43 
	mPATTERN_SEQUENTIAL
,

44 
	mPATTERN_RANDOM


47 
	sio_åackî
 {

48 
io_∑âîn
 
	m∑âîn
;

50 
	mƒ_£q_ßm∂es
;

51 
	mƒ_ønd_ßm∂es
;

52 
	mthªshﬁds
[2];

54 
dm_oblock_t
 
	mœ°_íd_oblock
;

57 
	$iŸ_öô
(
io_åackî
 *
t
,

58 
£quítül_thªshﬁd
, 
øndom_thªshﬁd
)

60 
t
->
∑âîn
 = 
PATTERN_RANDOM
;

61 
t
->
ƒ_£q_ßm∂es
 = 0;

62 
t
->
ƒ_ønd_ßm∂es
 = 0;

63 
t
->
œ°_íd_oblock
 = 0;

64 
t
->
thªshﬁds
[
PATTERN_RANDOM
] = 
øndom_thªshﬁd
;

65 
t
->
thªshﬁds
[
PATTERN_SEQUENTIAL
] = 
£quítül_thªshﬁd
;

66 
	}
}

68 
io_∑âîn
 
	$iŸ_∑âîn
(
io_åackî
 *
t
)

70  
t
->
∑âîn
;

71 
	}
}

73 
	$iŸ_upd©e_°©s
(
io_åackî
 *
t
, 
bio
 *bio)

75 i‡(
bio
->
bi_ôî
.
bi_£˘‹
 =
	`‰om_oblock
(
t
->
œ°_íd_oblock
) + 1)

76 
t
->
ƒ_£q_ßm∂es
++;

82 i‡(
t
->
ƒ_£q_ßm∂es
) {

83 
t
->
ƒ_£q_ßm∂es
 = 0;

84 
t
->
ƒ_ønd_ßm∂es
 = 0;

87 
t
->
ƒ_ønd_ßm∂es
++;

90 
t
->
œ°_íd_oblock
 = 
	`to_oblock
(
	`bio_íd_£˘‹
(
bio
) - 1);

91 
	}
}

93 
	$iŸ_check_f‹_∑âîn_swôch
(
io_åackî
 *
t
)

95 
t
->
∑âîn
) {

96 
PATTERN_SEQUENTIAL
:

97 i‡(
t
->
ƒ_ønd_ßm∂es
 >t->
thªshﬁds
[
PATTERN_RANDOM
]) {

98 
t
->
∑âîn
 = 
PATTERN_RANDOM
;

99 
t
->
ƒ_£q_ßm∂es
 =Å->
ƒ_ønd_ßm∂es
 = 0;

103 
PATTERN_RANDOM
:

104 i‡(
t
->
ƒ_£q_ßm∂es
 >t->
thªshﬁds
[
PATTERN_SEQUENTIAL
]) {

105 
t
->
∑âîn
 = 
PATTERN_SEQUENTIAL
;

106 
t
->
ƒ_£q_ßm∂es
 =Å->
ƒ_ønd_ßm∂es
 = 0;

110 
	}
}

112 
	$iŸ_examöe_bio
(
io_åackî
 *
t
, 
bio
 *bio)

114 
	`iŸ_upd©e_°©s
(
t
, 
bio
);

115 
	`iŸ_check_f‹_∑âîn_swôch
(
t
);

116 
	}
}

126 
	#NR_QUEUE_LEVELS
 16u

	)

128 
	squeue
 {

129 
li°_hód
 
	mqs
[
NR_QUEUE_LEVELS
];

132 
	$queue_öô
(
queue
 *
q
)

134 
i
;

136 
i
 = 0; i < 
NR_QUEUE_LEVELS
; i++)

137 
	`INIT_LIST_HEAD
(
q
->
qs
 + 
i
);

138 
	}
}

144 
boﬁ
 
	$queue_em±y
(
queue
 *
q
)

146 
i
;

148 
i
 = 0; i < 
NR_QUEUE_LEVELS
; i++)

149 i‡(!
	`li°_em±y
(
q
->
qs
 + 
i
))

150  
Ál£
;

152  
åue
;

153 
	}
}

158 
	$queue_push
(
queue
 *
q
, 
Àvñ
, 
li°_hód
 *
ñt
)

160 
	`li°_add_èû
(
ñt
, 
q
->
qs
 + 
Àvñ
);

161 
	}
}

163 
	$queue_ªmove
(
li°_hód
 *
ñt
)

165 
	`li°_dñ
(
ñt
);

166 
	}
}

172 
	$queue_shi·_down
(
queue
 *
q
)

174 
Àvñ
;

176 
Àvñ
 = 1;Üevñ < 
NR_QUEUE_LEVELS
;Üevel++)

177 
	`li°_•li˚_öô
(
q
->
qs
 + 
Àvñ
, q->qs +Üevel - 1);

178 
	}
}

184 
li°_hód
 *
	$queue_p›
(
queue
 *
q
)

186 
Àvñ
;

187 
li°_hód
 *
r
;

189 
Àvñ
 = 0;Üevñ < 
NR_QUEUE_LEVELS
;Üevel++)

190 i‡(!
	`li°_em±y
(
q
->
qs
 + 
Àvñ
)) {

191 
r
 = 
q
->
qs
[
Àvñ
].
√xt
;

192 
	`li°_dñ
(
r
);

195 i‡(
Àvñ
 =0 && 
	`li°_em±y
(
q
->
qs
))

196 
	`queue_shi·_down
(
q
);

198  
r
;

201  
NULL
;

202 
	}
}

204 
li°_hód
 *
	$li°_p›
(
li°_hód
 *
lh
)

206 
li°_hód
 *
r
 = 
lh
->
√xt
;

208 
	`BUG_ON
(!
r
);

209 
	`li°_dñ_öô
(
r
);

211  
r
;

212 
	}
}

219 
	síåy
 {

220 
hli°_node
 
	mhli°
;

221 
li°_hód
 
	mli°
;

222 
dm_oblock_t
 
	moblock
;

227 
boﬁ
 
	mdúty
:1;

228 
	mhô_cou¡
;

229 
	mgíî©i⁄
;

230 
	mtick
;

239 
	síåy_poﬁ
 {

240 
íåy
 *
	míåõs
, *
	míåõs_íd
;

241 
li°_hód
 
	m‰ì
;

242 
	mƒ_Æloˇãd
;

245 
	$ïoﬁ_öô
(
íåy_poﬁ
 *
ï
, 
ƒ_íåõs
)

247 
i
;

249 
ï
->
íåõs
 = 
	`vzÆloc
((
íåy
Ë* 
ƒ_íåõs
);

250 i‡(!
ï
->
íåõs
)

251  -
ENOMEM
;

253 
ï
->
íåõs_íd
 =Ép->
íåõs
 + 
ƒ_íåõs
;

255 
	`INIT_LIST_HEAD
(&
ï
->
‰ì
);

256 
i
 = 0; i < 
ƒ_íåõs
; i++)

257 
	`li°_add
(&
ï
->
íåõs
[
i
].
li°
, &ï->
‰ì
);

259 
ï
->
ƒ_Æloˇãd
 = 0;

262 
	}
}

264 
	$ïoﬁ_exô
(
íåy_poﬁ
 *
ï
)

266 
	`v‰ì
(
ï
->
íåõs
);

267 
	}
}

269 
íåy
 *
	$Æloc_íåy
(
íåy_poﬁ
 *
ï
)

271 
íåy
 *
e
;

273 i‡(
	`li°_em±y
(&
ï
->
‰ì
))

274  
NULL
;

276 
e
 = 
	`li°_íåy
(
	`li°_p›
(&
ï
->
‰ì
), 
íåy
, 
li°
);

277 
	`INIT_LIST_HEAD
(&
e
->
li°
);

278 
	`INIT_HLIST_NODE
(&
e
->
hli°
);

279 
ï
->
ƒ_Æloˇãd
++;

281  
e
;

282 
	}
}

287 
íåy
 *
	$Æloc_∑πicuœr_íåy
(
íåy_poﬁ
 *
ï
, 
dm_cblock_t
 
cblock
)

289 
íåy
 *
e
 = 
ï
->
íåõs
 + 
	`‰om_cblock
(
cblock
);

291 
	`li°_dñ_öô
(&
e
->
li°
);

292 
	`INIT_HLIST_NODE
(&
e
->
hli°
);

293 
ï
->
ƒ_Æloˇãd
++;

295  
e
;

296 
	}
}

298 
	$‰ì_íåy
(
íåy_poﬁ
 *
ï
, 
íåy
 *
e
)

300 
	`BUG_ON
(!
ï
->
ƒ_Æloˇãd
);

301 
ï
->
ƒ_Æloˇãd
--;

302 
	`INIT_HLIST_NODE
(&
e
->
hli°
);

303 
	`li°_add
(&
e
->
li°
, &
ï
->
‰ì
);

304 
	}
}

309 
íåy
 *
	$ïoﬁ_föd
(
íåy_poﬁ
 *
ï
, 
dm_cblock_t
 
cblock
)

311 
íåy
 *
e
 = 
ï
->
íåõs
 + 
	`‰om_cblock
(
cblock
);

312  !
	`hli°_unhashed
(&
e
->
hli°
Ë?É : 
NULL
;

313 
	}
}

315 
boﬁ
 
	$ïoﬁ_em±y
(
íåy_poﬁ
 *
ï
)

317  
	`li°_em±y
(&
ï
->
‰ì
);

318 
	}
}

320 
boﬁ
 
	$ö_poﬁ
(
íåy_poﬁ
 *
ï
, 
íåy
 *
e
)

322  
e
 >
ï
->
íåõs
 &&É <Ép->
íåõs_íd
;

323 
	}
}

325 
dm_cblock_t
 
	$ö„r_cblock
(
íåy_poﬁ
 *
ï
, 
íåy
 *
e
)

327  
	`to_cblock
(
e
 - 
ï
->
íåõs
);

328 
	}
}

332 
	smq_pﬁicy
 {

333 
dm_ˇche_pﬁicy
 
	mpﬁicy
;

336 
muãx
 
	mlock
;

337 
dm_cblock_t
 
	mˇche_size
;

338 
io_åackî
 
	måackî
;

344 
íåy_poﬁ
 
	m¥e_ˇche_poﬁ
;

345 
íåy_poﬁ
 
	mˇche_poﬁ
;

354 
queue
 
	m¥e_ˇche
;

355 
queue
 
	mˇche_˛ón
;

356 
queue
 
	mˇche_dúty
;

366 
•ölock_t
 
	mtick_lock
;

367 
	mtick_¥Ÿe˘ed
;

368 
	mtick
;

375 
	mhô_cou¡
;

383 
	mgíî©i⁄
;

384 
	mgíî©i⁄_≥riod
;

391 
	m¥omŸe_thªshﬁd
;

393 
	mdisˇrd_¥omŸe_adju°mít
;

394 
	mªad_¥omŸe_adju°mít
;

395 
	mwrôe_¥omŸe_adju°mít
;

401 
	mƒ_buckës
;

402 
dm_block_t
 
	mhash_bôs
;

403 
hli°_hód
 *
	mèbÀ
;

406 
	#DEFAULT_DISCARD_PROMOTE_ADJUSTMENT
 1

	)

407 
	#DEFAULT_READ_PROMOTE_ADJUSTMENT
 4

	)

408 
	#DEFAULT_WRITE_PROMOTE_ADJUSTMENT
 8

	)

416 
	$hash_ö£π
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

418 
h
 = 
	`hash_64
(
	`‰om_oblock
(
e
->
oblock
), 
mq
->
hash_bôs
);

420 
	`hli°_add_hód
(&
e
->
hli°
, 
mq
->
èbÀ
 + 
h
);

421 
	}
}

423 
íåy
 *
	$hash_lookup
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
)

425 
h
 = 
	`hash_64
(
	`‰om_oblock
(
oblock
), 
mq
->
hash_bôs
);

426 
hli°_hód
 *
buckë
 = 
mq
->
èbÀ
 + 
h
;

427 
íåy
 *
e
;

429 
	`hli°_f‹_óch_íåy
(
e
, 
buckë
, 
hli°
)

430 i‡(
e
->
oblock
 == oblock) {

431 
	`hli°_dñ
(&
e
->
hli°
);

432 
	`hli°_add_hód
(&
e
->
hli°
, 
buckë
);

433  
e
;

436  
NULL
;

437 
	}
}

439 
	$hash_ªmove
(
íåy
 *
e
)

441 
	`hli°_dñ
(&
e
->
hli°
);

442 
	}
}

446 
boﬁ
 
	$™y_‰ì_cblocks
(
mq_pﬁicy
 *
mq
)

448  !
	`ïoﬁ_em±y
(&
mq
->
ˇche_poﬁ
);

449 
	}
}

451 
boﬁ
 
	$™y_˛ón_cblocks
(
mq_pﬁicy
 *
mq
)

453  !
	`queue_em±y
(&
mq
->
ˇche_˛ón
);

454 
	}
}

467 
	$queue_Àvñ
(
íåy
 *
e
)

469  
	`mö
((Ë
	`ûog2
(
e
->
hô_cou¡
), 
NR_QUEUE_LEVELS
 - 1u);

470 
	}
}

472 
boﬁ
 
	$ö_ˇche
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

474  
	`ö_poﬁ
(&
mq
->
ˇche_poﬁ
, 
e
);

475 
	}
}

482 
	$push
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

484 
e
->
tick
 = 
mq
->tick;

485 
	`hash_ö£π
(
mq
, 
e
);

487 i‡(
	`ö_ˇche
(
mq
, 
e
))

488 
	`queue_push
(
e
->
dúty
 ? &
mq
->
ˇche_dúty
 : &mq->
ˇche_˛ón
,

489 
	`queue_Àvñ
(
e
), &e->
li°
);

491 
	`queue_push
(&
mq
->
¥e_ˇche
, 
	`queue_Àvñ
(
e
), &e->
li°
);

492 
	}
}

497 
	$dñ
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

499 
	`queue_ªmove
(&
e
->
li°
);

500 
	`hash_ªmove
(
e
);

501 
	}
}

507 
íåy
 *
	$p›
(
mq_pﬁicy
 *
mq
, 
queue
 *
q
)

509 
íåy
 *
e
;

510 
li°_hód
 *
h
 = 
	`queue_p›
(
q
);

512 i‡(!
h
)

513  
NULL
;

515 
e
 = 
	`c⁄èöî_of
(
h
, 
íåy
, 
li°
);

516 
	`hash_ªmove
(
e
);

518  
e
;

519 
	}
}

524 
boﬁ
 
	$upd©ed_this_tick
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

526  
mq
->
tick
 =
e
->tick;

527 
	}
}

542 
	#MAX_TO_AVERAGE
 20

	)

544 
	$check_gíî©i⁄
(
mq_pﬁicy
 *
mq
)

546 
tŸÆ
 = 0, 
ƒ
 = 0, 
cou¡
 = 0, 
Àvñ
;

547 
li°_hód
 *
hód
;

548 
íåy
 *
e
;

550 i‡((
mq
->
hô_cou¡
 >mq->
gíî©i⁄_≥riod
Ë&& (
	`ïoﬁ_em±y
(&mq->
ˇche_poﬁ
))) {

551 
mq
->
hô_cou¡
 = 0;

552 
mq
->
gíî©i⁄
++;

554 
Àvñ
 = 0;Üevñ < 
NR_QUEUE_LEVELS
 && 
cou¡
 < 
MAX_TO_AVERAGE
;Üevel++) {

555 
hód
 = 
mq
->
ˇche_˛ón
.
qs
 + 
Àvñ
;

556 
	`li°_f‹_óch_íåy
(
e
, 
hód
, 
li°
) {

557 
ƒ
++;

558 
tŸÆ
 +
e
->
hô_cou¡
;

560 i‡(++
cou¡
 >
MAX_TO_AVERAGE
)

564 
hód
 = 
mq
->
ˇche_dúty
.
qs
 + 
Àvñ
;

565 
	`li°_f‹_óch_íåy
(
e
, 
hód
, 
li°
) {

566 
ƒ
++;

567 
tŸÆ
 +
e
->
hô_cou¡
;

569 i‡(++
cou¡
 >
MAX_TO_AVERAGE
)

574 
mq
->
¥omŸe_thªshﬁd
 = 
ƒ
 ? 
tŸÆ
 /Çr : 1;

575 i‡(
mq
->
¥omŸe_thªshﬁd
 * 
ƒ
 < 
tŸÆ
)

576 
mq
->
¥omŸe_thªshﬁd
++;

578 
	}
}

584 
	$ªqueue_™d_upd©e_tick
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
)

586 i‡(
	`upd©ed_this_tick
(
mq
, 
e
))

589 
e
->
hô_cou¡
++;

590 
mq
->
hô_cou¡
++;

591 
	`check_gíî©i⁄
(
mq
);

596 
e
->
gíî©i⁄
 = 
mq
->generation;

598 
	`dñ
(
mq
, 
e
);

599 
	`push
(
mq
, 
e
);

600 
	}
}

617 
	$demŸe_cblock
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 *
oblock
)

619 
íåy
 *
demŸed
 = 
	`p›
(
mq
, &mq->
ˇche_˛ón
);

621 i‡(!
demŸed
)

629  -
ENOSPC
;

631 *
oblock
 = 
demŸed
->oblock;

632 
	`‰ì_íåy
(&
mq
->
ˇche_poﬁ
, 
demŸed
);

641 
	}
}

652 
	$adju°ed_¥omŸe_thªshﬁd
(
mq_pﬁicy
 *
mq
,

653 
boﬁ
 
disˇrded_oblock
, 
d©a_dú
)

655 i‡(
d©a_dú
 =
READ
)

656  
mq
->
¥omŸe_thªshﬁd
 + mq->
ªad_¥omŸe_adju°mít
;

658 i‡(
disˇrded_oblock
 && (
	`™y_‰ì_cblocks
(
mq
Ë|| 
	`™y_˛ón_cblocks
(mq))) {

663  
mq
->
disˇrd_¥omŸe_adju°mít
;

666  
mq
->
¥omŸe_thªshﬁd
 + mq->
wrôe_¥omŸe_adju°mít
;

667 
	}
}

669 
boﬁ
 
	$should_¥omŸe
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
,

670 
boﬁ
 
disˇrded_oblock
, 
d©a_dú
)

672  
e
->
hô_cou¡
 >=

673 
	`adju°ed_¥omŸe_thªshﬁd
(
mq
, 
disˇrded_oblock
, 
d©a_dú
);

674 
	}
}

676 
	$ˇche_íåy_found
(
mq_pﬁicy
 *
mq
,

677 
íåy
 *
e
,

678 
pﬁicy_ªsu…
 *
ªsu…
)

680 
	`ªqueue_™d_upd©e_tick
(
mq
, 
e
);

682 i‡(
	`ö_ˇche
(
mq
, 
e
)) {

683 
ªsu…
->
›
 = 
POLICY_HIT
;

684 
ªsu…
->
cblock
 = 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
e
);

688 
	}
}

694 
	$¥e_ˇche_to_ˇche
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
,

695 
pﬁicy_ªsu…
 *
ªsu…
)

697 
r
;

698 
íåy
 *
√w_e
;

701 i‡(
	`ïoﬁ_em±y
(&
mq
->
ˇche_poﬁ
)) {

702 
ªsu…
->
›
 = 
POLICY_REPLACE
;

703 
r
 = 
	`demŸe_cblock
(
mq
, &
ªsu…
->
ﬁd_oblock
);

704 i‡(
r
) {

705 
ªsu…
->
›
 = 
POLICY_MISS
;

709 
ªsu…
->
›
 = 
POLICY_NEW
;

711 
√w_e
 = 
	`Æloc_íåy
(&
mq
->
ˇche_poﬁ
);

712 
	`BUG_ON
(!
√w_e
);

714 
√w_e
->
oblock
 = 
e
->oblock;

715 
√w_e
->
dúty
 = 
Ál£
;

716 
√w_e
->
hô_cou¡
 = 
e
->hit_count;

717 
√w_e
->
gíî©i⁄
 = 
e
->generation;

718 
√w_e
->
tick
 = 
e
->tick;

720 
	`dñ
(
mq
, 
e
);

721 
	`‰ì_íåy
(&
mq
->
¥e_ˇche_poﬁ
, 
e
);

722 
	`push
(
mq
, 
√w_e
);

724 
ªsu…
->
cblock
 = 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
√w_e
);

727 
	}
}

729 
	$¥e_ˇche_íåy_found
(
mq_pﬁicy
 *
mq
, 
íåy
 *
e
,

730 
boﬁ
 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

731 
d©a_dú
, 
pﬁicy_ªsu…
 *
ªsu…
)

733 
r
 = 0;

734 
boﬁ
 
upd©ed
 = 
	`upd©ed_this_tick
(
mq
, 
e
);

736 i‡((!
disˇrded_oblock
 && 
upd©ed
) ||

737 !
	`should_¥omŸe
(
mq
, 
e
, 
disˇrded_oblock
, 
d©a_dú
)) {

738 
	`ªqueue_™d_upd©e_tick
(
mq
, 
e
);

739 
ªsu…
->
›
 = 
POLICY_MISS
;

741 } i‡(!
ˇn_migøã
)

742 
r
 = -
EWOULDBLOCK
;

745 
	`ªqueue_™d_upd©e_tick
(
mq
, 
e
);

746 
r
 = 
	`¥e_ˇche_to_ˇche
(
mq
, 
e
, 
ªsu…
);

749  
r
;

750 
	}
}

752 
	$ö£π_ö_¥e_ˇche
(
mq_pﬁicy
 *
mq
,

753 
dm_oblock_t
 
oblock
)

755 
íåy
 *
e
 = 
	`Æloc_íåy
(&
mq
->
¥e_ˇche_poﬁ
);

757 i‡(!
e
)

762 
e
 = 
	`p›
(
mq
, &mq->
¥e_ˇche
);

764 i‡(
	`u∆ikñy
(!
e
)) {

765 
	`DMWARN
("couldn'tÖop fromÖre cache");

769 
e
->
dúty
 = 
Ál£
;

770 
e
->
oblock
 = oblock;

771 
e
->
hô_cou¡
 = 1;

772 
e
->
gíî©i⁄
 = 
mq
->generation;

773 
	`push
(
mq
, 
e
);

774 
	}
}

776 
	$ö£π_ö_ˇche
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
,

777 
pﬁicy_ªsu…
 *
ªsu…
)

779 
r
;

780 
íåy
 *
e
;

782 i‡(
	`ïoﬁ_em±y
(&
mq
->
ˇche_poﬁ
)) {

783 
ªsu…
->
›
 = 
POLICY_REPLACE
;

784 
r
 = 
	`demŸe_cblock
(
mq
, &
ªsu…
->
ﬁd_oblock
);

785 i‡(
	`u∆ikñy
(
r
)) {

786 
ªsu…
->
›
 = 
POLICY_MISS
;

787 
	`ö£π_ö_¥e_ˇche
(
mq
, 
oblock
);

794 
e
 = 
	`Æloc_íåy
(&
mq
->
ˇche_poﬁ
);

795 
	`BUG_ON
(!
e
);

798 
e
 = 
	`Æloc_íåy
(&
mq
->
ˇche_poﬁ
);

799 
ªsu…
->
›
 = 
POLICY_NEW
;

802 
e
->
oblock
 = oblock;

803 
e
->
dúty
 = 
Ál£
;

804 
e
->
hô_cou¡
 = 1;

805 
e
->
gíî©i⁄
 = 
mq
->generation;

806 
	`push
(
mq
, 
e
);

808 
ªsu…
->
cblock
 = 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
e
);

809 
	}
}

811 
	$no_íåy_found
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
,

812 
boﬁ
 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

813 
d©a_dú
, 
pﬁicy_ªsu…
 *
ªsu…
)

815 i‡(
	`adju°ed_¥omŸe_thªshﬁd
(
mq
, 
disˇrded_oblock
, 
d©a_dú
) <= 1) {

816 i‡(
ˇn_migøã
)

817 
	`ö£π_ö_ˇche
(
mq
, 
oblock
, 
ªsu…
);

819  -
EWOULDBLOCK
;

821 
	`ö£π_ö_¥e_ˇche
(
mq
, 
oblock
);

822 
ªsu…
->
›
 = 
POLICY_MISS
;

826 
	}
}

832 
	$m≠
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
,

833 
boﬁ
 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

834 
d©a_dú
, 
pﬁicy_ªsu…
 *
ªsu…
)

836 
r
 = 0;

837 
íåy
 *
e
 = 
	`hash_lookup
(
mq
, 
oblock
);

839 i‡(
e
 && 
	`ö_ˇche
(
mq
,É))

840 
r
 = 
	`ˇche_íåy_found
(
mq
, 
e
, 
ªsu…
);

842 i‡(
	`iŸ_∑âîn
(&
mq
->
åackî
Ë=
PATTERN_SEQUENTIAL
)

843 
ªsu…
->
›
 = 
POLICY_MISS
;

845 i‡(
e
)

846 
r
 = 
	`¥e_ˇche_íåy_found
(
mq
, 
e
, 
ˇn_migøã
, 
disˇrded_oblock
,

847 
d©a_dú
, 
ªsu…
);

850 
r
 = 
	`no_íåy_found
(
mq
, 
oblock
, 
ˇn_migøã
, 
disˇrded_oblock
,

851 
d©a_dú
, 
ªsu…
);

853 i‡(
r
 =-
EWOULDBLOCK
)

854 
ªsu…
->
›
 = 
POLICY_MISS
;

856  
r
;

857 
	}
}

866 
mq_pﬁicy
 *
	$to_mq_pﬁicy
(
dm_ˇche_pﬁicy
 *
p
)

868  
	`c⁄èöî_of
(
p
, 
mq_pﬁicy
, 
pﬁicy
);

869 
	}
}

871 
	$mq_de°roy
(
dm_ˇche_pﬁicy
 *
p
)

873 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

875 
	`v‰ì
(
mq
->
èbÀ
);

876 
	`ïoﬁ_exô
(&
mq
->
ˇche_poﬁ
);

877 
	`ïoﬁ_exô
(&
mq
->
¥e_ˇche_poﬁ
);

878 
	`k‰ì
(
mq
);

879 
	}
}

881 
	$c›y_tick
(
mq_pﬁicy
 *
mq
)

883 
Êags
;

885 
	`•ö_lock_úqßve
(&
mq
->
tick_lock
, 
Êags
);

886 
mq
->
tick
 = mq->
tick_¥Ÿe˘ed
;

887 
	`•ö_u∆ock_úqª°‹e
(&
mq
->
tick_lock
, 
Êags
);

888 
	}
}

890 
	$mq_m≠
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
,

891 
boﬁ
 
ˇn_block
, boﬁ 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

892 
bio
 *bio, 
pﬁicy_ªsu…
 *
ªsu…
)

894 
r
;

895 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

897 
ªsu…
->
›
 = 
POLICY_MISS
;

899 i‡(
ˇn_block
)

900 
	`muãx_lock
(&
mq
->
lock
);

901 i‡(!
	`muãx_åylock
(&
mq
->
lock
))

902  -
EWOULDBLOCK
;

904 
	`c›y_tick
(
mq
);

906 
	`iŸ_examöe_bio
(&
mq
->
åackî
, 
bio
);

907 
r
 = 
	`m≠
(
mq
, 
oblock
, 
ˇn_migøã
, 
disˇrded_oblock
,

908 
	`bio_d©a_dú
(
bio
), 
ªsu…
);

910 
	`muãx_u∆ock
(&
mq
->
lock
);

912  
r
;

913 
	}
}

915 
	$mq_lookup
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 *
cblock
)

917 
r
;

918 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

919 
íåy
 *
e
;

921 i‡(!
	`muãx_åylock
(&
mq
->
lock
))

922  -
EWOULDBLOCK
;

924 
e
 = 
	`hash_lookup
(
mq
, 
oblock
);

925 i‡(
e
 && 
	`ö_ˇche
(
mq
,É)) {

926 *
cblock
 = 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
e
);

927 
r
 = 0;

929 
r
 = -
ENOENT
;

931 
	`muãx_u∆ock
(&
mq
->
lock
);

933  
r
;

934 
	}
}

936 
	$__mq_£t_˛ór_dúty
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
, 
boﬁ
 
£t
)

938 
íåy
 *
e
;

940 
e
 = 
	`hash_lookup
(
mq
, 
oblock
);

941 
	`BUG_ON
(!
e
 || !
	`ö_ˇche
(
mq
,É));

943 
	`dñ
(
mq
, 
e
);

944 
e
->
dúty
 = 
£t
;

945 
	`push
(
mq
, 
e
);

946 
	}
}

948 
	$mq_£t_dúty
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

950 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

952 
	`muãx_lock
(&
mq
->
lock
);

953 
	`__mq_£t_˛ór_dúty
(
mq
, 
oblock
, 
åue
);

954 
	`muãx_u∆ock
(&
mq
->
lock
);

955 
	}
}

957 
	$mq_˛ór_dúty
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

959 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

961 
	`muãx_lock
(&
mq
->
lock
);

962 
	`__mq_£t_˛ór_dúty
(
mq
, 
oblock
, 
Ál£
);

963 
	`muãx_u∆ock
(&
mq
->
lock
);

964 
	}
}

966 
	$mq_lﬂd_m≠pög
(
dm_ˇche_pﬁicy
 *
p
,

967 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

968 
uöt32_t
 
höt
, 
boﬁ
 
höt_vÆid
)

970 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

971 
íåy
 *
e
;

973 
e
 = 
	`Æloc_∑πicuœr_íåy
(&
mq
->
ˇche_poﬁ
, 
cblock
);

974 
e
->
oblock
 = oblock;

975 
e
->
dúty
 = 
Ál£
;

976 
e
->
hô_cou¡
 = 
höt_vÆid
 ? 
höt
 : 1;

977 
e
->
gíî©i⁄
 = 
mq
->generation;

978 
	`push
(
mq
, 
e
);

981 
	}
}

983 
	$mq_ßve_höts
(
mq_pﬁicy
 *
mq
, 
queue
 *
q
,

984 
pﬁicy_wÆk_‚
 
‚
, *
c⁄ãxt
)

986 
r
;

987 
Àvñ
;

988 
íåy
 *
e
;

990 
Àvñ
 = 0;Üevñ < 
NR_QUEUE_LEVELS
;Üevel++)

991 
	`li°_f‹_óch_íåy
(
e
, 
q
->
qs
 + 
Àvñ
, 
li°
) {

992 
r
 = 
	`‚
(
c⁄ãxt
, 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
e
),

993 
e
->
oblock
,É->
hô_cou¡
);

994 i‡(
r
)

995  
r
;

999 
	}
}

1001 
	$mq_wÆk_m≠pögs
(
dm_ˇche_pﬁicy
 *
p
, 
pﬁicy_wÆk_‚
 
‚
,

1002 *
c⁄ãxt
)

1004 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1005 
r
 = 0;

1007 
	`muãx_lock
(&
mq
->
lock
);

1009 
r
 = 
	`mq_ßve_höts
(
mq
, &mq->
ˇche_˛ón
, 
‚
, 
c⁄ãxt
);

1010 i‡(!
r
)

1011 
r
 = 
	`mq_ßve_höts
(
mq
, &mq->
ˇche_dúty
, 
‚
, 
c⁄ãxt
);

1013 
	`muãx_u∆ock
(&
mq
->
lock
);

1015  
r
;

1016 
	}
}

1018 
	$__ªmove_m≠pög
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 
oblock
)

1020 
íåy
 *
e
;

1022 
e
 = 
	`hash_lookup
(
mq
, 
oblock
);

1023 
	`BUG_ON
(!
e
 || !
	`ö_ˇche
(
mq
,É));

1025 
	`dñ
(
mq
, 
e
);

1026 
	`‰ì_íåy
(&
mq
->
ˇche_poﬁ
, 
e
);

1027 
	}
}

1029 
	$mq_ªmove_m≠pög
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
)

1031 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1033 
	`muãx_lock
(&
mq
->
lock
);

1034 
	`__ªmove_m≠pög
(
mq
, 
oblock
);

1035 
	`muãx_u∆ock
(&
mq
->
lock
);

1036 
	}
}

1038 
	$__ªmove_cblock
(
mq_pﬁicy
 *
mq
, 
dm_cblock_t
 
cblock
)

1040 
íåy
 *
e
 = 
	`ïoﬁ_föd
(&
mq
->
ˇche_poﬁ
, 
cblock
);

1042 i‡(!
e
)

1043  -
ENODATA
;

1045 
	`dñ
(
mq
, 
e
);

1046 
	`‰ì_íåy
(&
mq
->
ˇche_poﬁ
, 
e
);

1049 
	}
}

1051 
	$mq_ªmove_cblock
(
dm_ˇche_pﬁicy
 *
p
, 
dm_cblock_t
 
cblock
)

1053 
r
;

1054 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1056 
	`muãx_lock
(&
mq
->
lock
);

1057 
r
 = 
	`__ªmove_cblock
(
mq
, 
cblock
);

1058 
	`muãx_u∆ock
(&
mq
->
lock
);

1060  
r
;

1061 
	}
}

1063 
	$__mq_wrôeback_w‹k
(
mq_pﬁicy
 *
mq
, 
dm_oblock_t
 *
oblock
,

1064 
dm_cblock_t
 *
cblock
)

1066 
íåy
 *
e
 = 
	`p›
(
mq
, &mq->
ˇche_dúty
);

1068 i‡(!
e
)

1069  -
ENODATA
;

1071 *
oblock
 = 
e
->oblock;

1072 *
cblock
 = 
	`ö„r_cblock
(&
mq
->
ˇche_poﬁ
, 
e
);

1073 
e
->
dúty
 = 
Ál£
;

1074 
	`push
(
mq
, 
e
);

1077 
	}
}

1079 
	$mq_wrôeback_w‹k
(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 *
oblock
,

1080 
dm_cblock_t
 *
cblock
)

1082 
r
;

1083 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1085 
	`muãx_lock
(&
mq
->
lock
);

1086 
r
 = 
	`__mq_wrôeback_w‹k
(
mq
, 
oblock
, 
cblock
);

1087 
	`muãx_u∆ock
(&
mq
->
lock
);

1089  
r
;

1090 
	}
}

1092 
	$__f‹˚_m≠pög
(
mq_pﬁicy
 *
mq
,

1093 
dm_oblock_t
 
cuºít_oblock
, dm_oblock_à
√w_oblock
)

1095 
íåy
 *
e
 = 
	`hash_lookup
(
mq
, 
cuºít_oblock
);

1097 i‡(
e
 && 
	`ö_ˇche
(
mq
,É)) {

1098 
	`dñ
(
mq
, 
e
);

1099 
e
->
oblock
 = 
√w_oblock
;

1100 
e
->
dúty
 = 
åue
;

1101 
	`push
(
mq
, 
e
);

1103 
	}
}

1105 
	$mq_f‹˚_m≠pög
(
dm_ˇche_pﬁicy
 *
p
,

1106 
dm_oblock_t
 
cuºít_oblock
, dm_oblock_à
√w_oblock
)

1108 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1110 
	`muãx_lock
(&
mq
->
lock
);

1111 
	`__f‹˚_m≠pög
(
mq
, 
cuºít_oblock
, 
√w_oblock
);

1112 
	`muãx_u∆ock
(&
mq
->
lock
);

1113 
	}
}

1115 
dm_cblock_t
 
	$mq_ªsidícy
(
dm_ˇche_pﬁicy
 *
p
)

1117 
dm_cblock_t
 
r
;

1118 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1120 
	`muãx_lock
(&
mq
->
lock
);

1121 
r
 = 
	`to_cblock
(
mq
->
ˇche_poﬁ
.
ƒ_Æloˇãd
);

1122 
	`muãx_u∆ock
(&
mq
->
lock
);

1124  
r
;

1125 
	}
}

1127 
	$mq_tick
(
dm_ˇche_pﬁicy
 *
p
)

1129 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1130 
Êags
;

1132 
	`•ö_lock_úqßve
(&
mq
->
tick_lock
, 
Êags
);

1133 
mq
->
tick_¥Ÿe˘ed
++;

1134 
	`•ö_u∆ock_úqª°‹e
(&
mq
->
tick_lock
, 
Êags
);

1135 
	}
}

1137 
	$mq_£t_c⁄fig_vÆue
(
dm_ˇche_pﬁicy
 *
p
,

1138 c⁄° *
key
, c⁄° *
vÆue
)

1140 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1141 
tmp
;

1143 i‡(
	`k°πoul
(
vÆue
, 10, &
tmp
))

1144  -
EINVAL
;

1146 i‡(!
	`°rˇ£cmp
(
key
, "random_threshold")) {

1147 
mq
->
åackî
.
thªshﬁds
[
PATTERN_RANDOM
] = 
tmp
;

1149 } i‡(!
	`°rˇ£cmp
(
key
, "sequential_threshold")) {

1150 
mq
->
åackî
.
thªshﬁds
[
PATTERN_SEQUENTIAL
] = 
tmp
;

1152 } i‡(!
	`°rˇ£cmp
(
key
, "discard_promote_adjustment"))

1153 
mq
->
disˇrd_¥omŸe_adju°mít
 = 
tmp
;

1155 i‡(!
	`°rˇ£cmp
(
key
, "read_promote_adjustment"))

1156 
mq
->
ªad_¥omŸe_adju°mít
 = 
tmp
;

1158 i‡(!
	`°rˇ£cmp
(
key
, "write_promote_adjustment"))

1159 
mq
->
wrôe_¥omŸe_adju°mít
 = 
tmp
;

1162  -
EINVAL
;

1165 
	}
}

1167 
	$mq_emô_c⁄fig_vÆues
(
dm_ˇche_pﬁicy
 *
p
, *
ªsu…
, 
maxÀn
)

1169 
ssize_t
 
sz
 = 0;

1170 
mq_pﬁicy
 *
mq
 = 
	`to_mq_pﬁicy
(
p
);

1172 
	`DMEMIT
("10Ñandom_threshold %u "

1177 
mq
->
åackî
.
thªshﬁds
[
PATTERN_RANDOM
],

1178 
mq
->
åackî
.
thªshﬁds
[
PATTERN_SEQUENTIAL
],

1179 
mq
->
disˇrd_¥omŸe_adju°mít
,

1180 
mq
->
ªad_¥omŸe_adju°mít
,

1181 
mq
->
wrôe_¥omŸe_adju°mít
);

1184 
	}
}

1187 
	$öô_pﬁicy_fun˘i⁄s
(
mq_pﬁicy
 *
mq
)

1189 
mq
->
pﬁicy
.
de°roy
 = 
mq_de°roy
;

1190 
mq
->
pﬁicy
.
m≠
 = 
mq_m≠
;

1191 
mq
->
pﬁicy
.
lookup
 = 
mq_lookup
;

1192 
mq
->
pﬁicy
.
£t_dúty
 = 
mq_£t_dúty
;

1193 
mq
->
pﬁicy
.
˛ór_dúty
 = 
mq_˛ór_dúty
;

1194 
mq
->
pﬁicy
.
lﬂd_m≠pög
 = 
mq_lﬂd_m≠pög
;

1195 
mq
->
pﬁicy
.
wÆk_m≠pögs
 = 
mq_wÆk_m≠pögs
;

1196 
mq
->
pﬁicy
.
ªmove_m≠pög
 = 
mq_ªmove_m≠pög
;

1197 
mq
->
pﬁicy
.
ªmove_cblock
 = 
mq_ªmove_cblock
;

1198 
mq
->
pﬁicy
.
wrôeback_w‹k
 = 
mq_wrôeback_w‹k
;

1199 
mq
->
pﬁicy
.
f‹˚_m≠pög
 = 
mq_f‹˚_m≠pög
;

1200 
mq
->
pﬁicy
.
ªsidícy
 = 
mq_ªsidícy
;

1201 
mq
->
pﬁicy
.
tick
 = 
mq_tick
;

1202 
mq
->
pﬁicy
.
emô_c⁄fig_vÆues
 = 
mq_emô_c⁄fig_vÆues
;

1203 
mq
->
pﬁicy
.
£t_c⁄fig_vÆue
 = 
mq_£t_c⁄fig_vÆue
;

1204 
	}
}

1206 
dm_ˇche_pﬁicy
 *
	$mq_¸óã
(
dm_cblock_t
 
ˇche_size
,

1207 
£˘‹_t
 
‹igö_size
,

1208 
£˘‹_t
 
ˇche_block_size
)

1210 
mq_pﬁicy
 *
mq
 = 
	`kzÆloc
((*mq), 
GFP_KERNEL
);

1212 i‡(!
mq
)

1213  
NULL
;

1215 
	`öô_pﬁicy_fun˘i⁄s
(
mq
);

1216 
	`iŸ_öô
(&
mq
->
åackî
, 
SEQUENTIAL_THRESHOLD_DEFAULT
, 
RANDOM_THRESHOLD_DEFAULT
);

1217 
mq
->
ˇche_size
 = cache_size;

1219 i‡(
	`ïoﬁ_öô
(&
mq
->
¥e_ˇche_poﬁ
, 
	`‰om_cblock
(
ˇche_size
))) {

1220 
	`DMERR
("couldn't initializeÖool ofÖre-cacheÉntries");

1221 
bad_¥e_ˇche_öô
;

1224 i‡(
	`ïoﬁ_öô
(&
mq
->
ˇche_poﬁ
, 
	`‰om_cblock
(
ˇche_size
))) {

1225 
	`DMERR
("couldn't initializeÖool of cacheÉntries");

1226 
bad_ˇche_öô
;

1229 
mq
->
tick_¥Ÿe˘ed
 = 0;

1230 
mq
->
tick
 = 0;

1231 
mq
->
hô_cou¡
 = 0;

1232 
mq
->
gíî©i⁄
 = 0;

1233 
mq
->
¥omŸe_thªshﬁd
 = 0;

1234 
mq
->
disˇrd_¥omŸe_adju°mít
 = 
DEFAULT_DISCARD_PROMOTE_ADJUSTMENT
;

1235 
mq
->
ªad_¥omŸe_adju°mít
 = 
DEFAULT_READ_PROMOTE_ADJUSTMENT
;

1236 
mq
->
wrôe_¥omŸe_adju°mít
 = 
DEFAULT_WRITE_PROMOTE_ADJUSTMENT
;

1237 
	`muãx_öô
(&
mq
->
lock
);

1238 
	`•ö_lock_öô
(&
mq
->
tick_lock
);

1240 
	`queue_öô
(&
mq
->
¥e_ˇche
);

1241 
	`queue_öô
(&
mq
->
ˇche_˛ón
);

1242 
	`queue_öô
(&
mq
->
ˇche_dúty
);

1244 
mq
->
gíî©i⁄_≥riod
 = 
	`max
((Ë
	`‰om_cblock
(
ˇche_size
), 1024U);

1246 
mq
->
ƒ_buckës
 = 
	`√xt_powî
(
	`‰om_cblock
(
ˇche_size
) / 2, 16);

1247 
mq
->
hash_bôs
 = 
	`ffs
(mq->
ƒ_buckës
) - 1;

1248 
mq
->
èbÀ
 = 
	`vzÆloc
((*mq->èbÀË* mq->
ƒ_buckës
);

1249 i‡(!
mq
->
èbÀ
)

1250 
bad_Æloc_èbÀ
;

1252  &
mq
->
pﬁicy
;

1254 
bad_Æloc_èbÀ
:

1255 
	`ïoﬁ_exô
(&
mq
->
ˇche_poﬁ
);

1256 
bad_ˇche_öô
:

1257 
	`ïoﬁ_exô
(&
mq
->
¥e_ˇche_poﬁ
);

1258 
bad_¥e_ˇche_öô
:

1259 
	`k‰ì
(
mq
);

1261  
NULL
;

1262 
	}
}

1266 
dm_ˇche_pﬁicy_ty≥
 
	gmq_pﬁicy_ty≥
 = {

1267 .
«me
 = "mq",

1268 .
	gvîsi⁄
 = {1, 2, 0},

1269 .
	ghöt_size
 = 4,

1270 .
	gow√r
 = 
THIS_MODULE
,

1271 .
	g¸óã
 = 
mq_¸óã


1274 
dm_ˇche_pﬁicy_ty≥
 
	gdeÁu…_pﬁicy_ty≥
 = {

1275 .
«me
 = "default",

1276 .
	gvîsi⁄
 = {1, 2, 0},

1277 .
	ghöt_size
 = 4,

1278 .
	gow√r
 = 
THIS_MODULE
,

1279 .
	g¸óã
 = 
mq_¸óã
,

1280 .
	gªÆ
 = &
mq_pﬁicy_ty≥


1283 
__öô
 
	$mq_öô
()

1285 
r
;

1287 
mq_íåy_ˇche
 = 
	`kmem_ˇche_¸óã
("dm_mq_policy_cache_entry",

1288 (
íåy
),

1289 
	`__Æignof__
(
íåy
),

1290 0, 
NULL
);

1291 i‡(!
mq_íåy_ˇche
)

1292 
bad
;

1294 
r
 = 
	`dm_ˇche_pﬁicy_ªgi°î
(&
mq_pﬁicy_ty≥
);

1295 i‡(
r
) {

1296 
	`DMERR
("ªgi°î faûed %d", 
r
);

1297 
bad_ªgi°î_mq
;

1300 
r
 = 
	`dm_ˇche_pﬁicy_ªgi°î
(&
deÁu…_pﬁicy_ty≥
);

1301 i‡(!
r
) {

1302 
	`DMINFO
("version %u.%u.%uÜoaded",

1303 
mq_pﬁicy_ty≥
.
vîsi⁄
[0],

1304 
mq_pﬁicy_ty≥
.
vîsi⁄
[1],

1305 
mq_pﬁicy_ty≥
.
vîsi⁄
[2]);

1309 
	`DMERR
("ªgi°î faûed (a†deÁu…Ë%d", 
r
);

1311 
	`dm_ˇche_pﬁicy_uƒegi°î
(&
mq_pﬁicy_ty≥
);

1312 
bad_ªgi°î_mq
:

1313 
	`kmem_ˇche_de°roy
(
mq_íåy_ˇche
);

1314 
bad
:

1315  -
ENOMEM
;

1316 
	}
}

1318 
__exô
 
	$mq_exô
()

1320 
	`dm_ˇche_pﬁicy_uƒegi°î
(&
mq_pﬁicy_ty≥
);

1321 
	`dm_ˇche_pﬁicy_uƒegi°î
(&
deÁu…_pﬁicy_ty≥
);

1323 
	`kmem_ˇche_de°roy
(
mq_íåy_ˇche
);

1324 
	}
}

1326 
moduÀ_öô
(
mq_öô
);

1327 
moduÀ_exô
(
mq_exô
);

1329 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

1330 
MODULE_LICENSE
("GPL");

1331 
MODULE_DESCRIPTION
("mq cacheÖolicy");

1333 
MODULE_ALIAS
("dm-cache-default");

	@dm-cache-policy.c

7 
	~"dm-ˇche-pﬁicy-öã∫Æ.h
"

8 
	~"dm.h
"

10 
	~<löux/moduÀ.h
>

11 
	~<löux/¶ab.h
>

15 
	#DM_MSG_PREFIX
 "ˇche-pﬁicy"

	)

17 
DEFINE_SPINLOCK
(
ªgi°î_lock
);

18 
LIST_HEAD
(
ªgi°î_li°
);

20 
dm_ˇche_pﬁicy_ty≥
 *
	$__föd_pﬁicy
(c⁄° *
«me
)

22 
dm_ˇche_pﬁicy_ty≥
 *
t
;

24 
	`li°_f‹_óch_íåy
(
t
, &
ªgi°î_li°
, 
li°
)

25 i‡(!
	`°rcmp
(
t
->
«me
,Çame))

26  
t
;

28  
NULL
;

29 
	}
}

31 
dm_ˇche_pﬁicy_ty≥
 *
	$__gë_pﬁicy_⁄˚
(c⁄° *
«me
)

33 
dm_ˇche_pﬁicy_ty≥
 *
t
 = 
	`__föd_pﬁicy
(
«me
);

35 i‡(
t
 && !
	`åy_moduÀ_gë
—->
ow√r
)) {

36 
	`DMWARN
("couldn'àgë moduÀ %s", 
«me
);

37 
t
 = 
	`ERR_PTR
(-
EINVAL
);

40  
t
;

41 
	}
}

43 
dm_ˇche_pﬁicy_ty≥
 *
	$gë_pﬁicy_⁄˚
(c⁄° *
«me
)

45 
dm_ˇche_pﬁicy_ty≥
 *
t
;

47 
	`•ö_lock
(&
ªgi°î_lock
);

48 
t
 = 
	`__gë_pﬁicy_⁄˚
(
«me
);

49 
	`•ö_u∆ock
(&
ªgi°î_lock
);

51  
t
;

52 
	}
}

54 
dm_ˇche_pﬁicy_ty≥
 *
	$gë_pﬁicy
(c⁄° *
«me
)

56 
dm_ˇche_pﬁicy_ty≥
 *
t
;

58 
t
 = 
	`gë_pﬁicy_⁄˚
(
«me
);

59 i‡(
	`IS_ERR
(
t
))

60  
NULL
;

62 i‡(
t
)

63  
t
;

65 
	`ªque°_moduÀ
("dm-ˇche-%s", 
«me
);

67 
t
 = 
	`gë_pﬁicy_⁄˚
(
«me
);

68 i‡(
	`IS_ERR
(
t
))

69  
NULL
;

71  
t
;

72 
	}
}

74 
	$put_pﬁicy
(
dm_ˇche_pﬁicy_ty≥
 *
t
)

76 
	`moduÀ_put
(
t
->
ow√r
);

77 
	}
}

79 
	$dm_ˇche_pﬁicy_ªgi°î
(
dm_ˇche_pﬁicy_ty≥
 *
ty≥
)

81 
r
;

84 i‡(
ty≥
->
höt_size
 != 0 &&Åype->hint_size != 4) {

85 
	`DMWARN
("höàsizêmu° bê0 o∏4 buà%Œu suµlõd.", (Ë
ty≥
->
höt_size
);

86  -
EINVAL
;

89 
	`•ö_lock
(&
ªgi°î_lock
);

90 i‡(
	`__föd_pﬁicy
(
ty≥
->
«me
)) {

91 
	`DMWARN
("©ãm±Åÿªgi°îÖﬁicy undî du∂iˇãÇamê%s", 
ty≥
->
«me
);

92 
r
 = -
EINVAL
;

94 
	`li°_add
(&
ty≥
->
li°
, &
ªgi°î_li°
);

95 
r
 = 0;

97 
	`•ö_u∆ock
(&
ªgi°î_lock
);

99  
r
;

100 
	}
}

101 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_ªgi°î
);

103 
	$dm_ˇche_pﬁicy_uƒegi°î
(
dm_ˇche_pﬁicy_ty≥
 *
ty≥
)

105 
	`•ö_lock
(&
ªgi°î_lock
);

106 
	`li°_dñ_öô
(&
ty≥
->
li°
);

107 
	`•ö_u∆ock
(&
ªgi°î_lock
);

108 
	}
}

109 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_uƒegi°î
);

111 
dm_ˇche_pﬁicy
 *
	$dm_ˇche_pﬁicy_¸óã
(c⁄° *
«me
,

112 
dm_cblock_t
 
ˇche_size
,

113 
£˘‹_t
 
‹igö_size
,

114 
£˘‹_t
 
ˇche_block_size
)

116 
dm_ˇche_pﬁicy
 *
p
 = 
NULL
;

117 
dm_ˇche_pﬁicy_ty≥
 *
ty≥
;

119 
ty≥
 = 
	`gë_pﬁicy
(
«me
);

120 i‡(!
ty≥
) {

121 
	`DMWARN
("unknownÖolicyÅype");

122  
	`ERR_PTR
(-
EINVAL
);

125 
p
 = 
ty≥
->
	`¸óã
(
ˇche_size
, 
‹igö_size
, 
ˇche_block_size
);

126 i‡(!
p
) {

127 
	`put_pﬁicy
(
ty≥
);

128  
	`ERR_PTR
(-
ENOMEM
);

130 
p
->
¥iv©e
 = 
ty≥
;

132  
p
;

133 
	}
}

134 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_¸óã
);

136 
	$dm_ˇche_pﬁicy_de°roy
(
dm_ˇche_pﬁicy
 *
p
)

138 
dm_ˇche_pﬁicy_ty≥
 *
t
 = 
p
->
¥iv©e
;

140 
p
->
	`de°roy
(p);

141 
	`put_pﬁicy
(
t
);

142 
	}
}

143 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_de°roy
);

145 c⁄° *
	$dm_ˇche_pﬁicy_gë_«me
(
dm_ˇche_pﬁicy
 *
p
)

147 
dm_ˇche_pﬁicy_ty≥
 *
t
 = 
p
->
¥iv©e
;

150 i‡(
t
->
ªÆ
)

151  
t
->
ªÆ
->
«me
;

153  
t
->
«me
;

154 
	}
}

155 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_gë_«me
);

157 c⁄° *
	$dm_ˇche_pﬁicy_gë_vîsi⁄
(
dm_ˇche_pﬁicy
 *
p
)

159 
dm_ˇche_pﬁicy_ty≥
 *
t
 = 
p
->
¥iv©e
;

161  
t
->
vîsi⁄
;

162 
	}
}

163 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_gë_vîsi⁄
);

165 
size_t
 
	$dm_ˇche_pﬁicy_gë_höt_size
(
dm_ˇche_pﬁicy
 *
p
)

167 
dm_ˇche_pﬁicy_ty≥
 *
t
 = 
p
->
¥iv©e
;

169  
t
->
höt_size
;

170 
	}
}

171 
EXPORT_SYMBOL_GPL
(
dm_ˇche_pﬁicy_gë_höt_size
);

	@dm-cache-policy.h

7 #i‚de‡
DM_CACHE_POLICY_H


8 
	#DM_CACHE_POLICY_H


	)

10 
	~"dm-ˇche-block-ty≥s.h
"

12 
	~<löux/devi˚-m≠≥r.h
>

65 
	epﬁicy_›î©i⁄
 {

66 
	mPOLICY_HIT
,

67 
	mPOLICY_MISS
,

68 
	mPOLICY_NEW
,

69 
	mPOLICY_REPLACE


75 
	spﬁicy_ªsu…
 {

76 
pﬁicy_›î©i⁄
 
	m›
;

77 
dm_oblock_t
 
	mﬁd_oblock
;

78 
dm_cblock_t
 
	mcblock
;

81 (*
	tpﬁicy_wÆk_‚
)(*
	tc⁄ãxt
, 
	tdm_cblock_t
 
	tcblock
,

82 
	tdm_oblock_t
 
	toblock
, 
	tuöt32_t
 
	thöt
);

89 
	sdm_ˇche_pﬁicy
 {

99 (*
de°roy
)(
dm_ˇche_pﬁicy
 *
p
);

123 (*
m≠
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
,

124 
boﬁ
 
ˇn_block
, boﬁ 
ˇn_migøã
, boﬁ 
disˇrded_oblock
,

125 
bio
 *bio, 
pﬁicy_ªsu…
 *
ªsu…
);

136 (*
lookup
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 *
cblock
);

138 (*
£t_dúty
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
);

139 (*
˛ór_dúty
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
);

145 (*
lﬂd_m≠pög
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
,

146 
dm_cblock_t
 
cblock
, 
uöt32_t
 
höt
, 
boﬁ
 
höt_vÆid
);

148 (*
wÆk_m≠pögs
)(
dm_ˇche_pﬁicy
 *
p
, 
pﬁicy_wÆk_‚
 
‚
,

149 *
c⁄ãxt
);

155 (*
ªmove_m≠pög
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
oblock
);

156 (*
f‹˚_m≠pög
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 
cuºít_oblock
,

157 
dm_oblock_t
 
√w_oblock
);

165 (*
ªmove_cblock
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_cblock_t
 
cblock
);

176 (*
wrôeback_w‹k
)(
dm_ˇche_pﬁicy
 *
p
, 
dm_oblock_t
 *
oblock
, 
dm_cblock_t
 *
cblock
);

181 
	`dm_cblock_t
 (*
ªsidícy
)(
dm_ˇche_pﬁicy
 *
p
);

190 (*
tick
)(
dm_ˇche_pﬁicy
 *
p
);

195 (*
emô_c⁄fig_vÆues
)(
dm_ˇche_pﬁicy
 *
p
,

196 *
ªsu…
, 
maxÀn
);

197 (*
£t_c⁄fig_vÆue
)(
dm_ˇche_pﬁicy
 *
p
,

198 c⁄° *
key
, c⁄° *
vÆue
);

203 *
¥iv©e
;

211 
	#CACHE_POLICY_NAME_SIZE
 16

	)

212 
	#CACHE_POLICY_VERSION_SIZE
 3

	)

214 
	sdm_ˇche_pﬁicy_ty≥
 {

216 
li°_hód
 
li°
;

222 
«me
[
CACHE_POLICY_NAME_SIZE
];

223 
vîsi⁄
[
CACHE_POLICY_VERSION_SIZE
];

229 
dm_ˇche_pﬁicy_ty≥
 *
ªÆ
;

236 
size_t
 
höt_size
;

238 
moduÀ
 *
ow√r
;

239 
dm_ˇche_pﬁicy
 *(*
¸óã
)(
dm_cblock_t
 
ˇche_size
,

240 
£˘‹_t
 
‹igö_size
,

241 
£˘‹_t
 
block_size
);

244 
	`dm_ˇche_pﬁicy_ªgi°î
(
dm_ˇche_pﬁicy_ty≥
 *
ty≥
);

245 
	`dm_ˇche_pﬁicy_uƒegi°î
(
dm_ˇche_pﬁicy_ty≥
 *
ty≥
);

	@dm-cache-target.c

7 
	~"dm.h
"

8 
	~"dm-bio-¥is⁄.h
"

9 
	~"dm-bio-ªc‹d.h
"

10 
	~"dm-ˇche-mëad©a.h
"

12 
	~<löux/dm-io.h
>

13 
	~<löux/dm-kc›yd.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/mempoﬁ.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/vmÆloc.h
>

20 
	#DM_MSG_PREFIX
 "ˇche"

	)

22 
DECLARE_DM_KCOPYD_THROTTLE_WITH_MODULE_PARM
(
ˇche_c›y_thrŸée
,

40 
size_t
 
	$bô£t_size_ö_byãs
(
ƒ_íåõs
)

42  (Ë* 
	`dm_div_up
(
ƒ_íåõs
, 
BITS_PER_LONG
);

43 
	}
}

45 *
	$Æloc_bô£t
(
ƒ_íåõs
)

47 
size_t
 
s
 = 
	`bô£t_size_ö_byãs
(
ƒ_íåõs
);

48  
	`vzÆloc
(
s
);

49 
	}
}

51 
	$˛ór_bô£t
(*
bô£t
, 
ƒ_íåõs
)

53 
size_t
 
s
 = 
	`bô£t_size_ö_byãs
(
ƒ_íåõs
);

54 
	`mem£t
(
bô£t
, 0, 
s
);

55 
	}
}

57 
	$‰ì_bô£t
(*
bôs
)

59 
	`v‰ì
(
bôs
);

60 
	}
}

69 
	sdm_hook_öfo
 {

70 
bio_íd_io_t
 *
	mbi_íd_io
;

71 *
	mbi_¥iv©e
;

74 
	$dm_hook_bio
(
dm_hook_öfo
 *
h
, 
bio
 *bio,

75 
bio_íd_io_t
 *
bi_íd_io
, *
bi_¥iv©e
)

77 
h
->
bi_íd_io
 = 
bio
->bi_end_io;

78 
h
->
bi_¥iv©e
 = 
bio
->bi_private;

80 
bio
->
bi_íd_io
 = bi_end_io;

81 
bio
->
bi_¥iv©e
 = bi_private;

82 
	}
}

84 
	$dm_unhook_bio
(
dm_hook_öfo
 *
h
, 
bio
 *bio)

86 
bio
->
bi_íd_io
 = 
h
->bi_end_io;

87 
bio
->
bi_¥iv©e
 = 
h
->bi_private;

93 
	`©omic_öc
(&
bio
->
bi_ªmaöög
);

94 
	}
}

98 
	#PRISON_CELLS
 1024

	)

99 
	#MIGRATION_POOL_SIZE
 128

	)

100 
	#COMMIT_PERIOD
 
HZ


	)

101 
	#MIGRATION_COUNT_WINDOW
 10

	)

107 
	#DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 (32 * 1024 >> 
SECTOR_SHIFT
)

	)

108 
	#DATA_DEV_BLOCK_SIZE_MAX_SECTORS
 (1024 * 1024 * 1024 >> 
SECTOR_SHIFT
)

	)

113 
	eˇche_mëad©a_mode
 {

114 
	mCM_WRITE
,

115 
	mCM_READ_ONLY
,

118 
	eˇche_io_mode
 {

124 
	mCM_IO_WRITEBACK
,

130 
	mCM_IO_WRITETHROUGH
,

138 
	mCM_IO_PASSTHROUGH


141 
	sˇche_„©uªs
 {

142 
ˇche_mëad©a_mode
 
	mmode
;

143 
ˇche_io_mode
 
	mio_mode
;

146 
	sˇche_°©s
 {

147 
©omic_t
 
	mªad_hô
;

148 
©omic_t
 
	mªad_miss
;

149 
©omic_t
 
	mwrôe_hô
;

150 
©omic_t
 
	mwrôe_miss
;

151 
©omic_t
 
	mdemŸi⁄
;

152 
©omic_t
 
	m¥omŸi⁄
;

153 
©omic_t
 
	mc›õs_avoided
;

154 
©omic_t
 
	mˇche_˚Œ_˛ash
;

155 
©omic_t
 
	mcommô_cou¡
;

156 
©omic_t
 
	mdisˇrd_cou¡
;

163 
	scblock_ønge
 {

164 
dm_cblock_t
 
	mbegö
;

165 
dm_cblock_t
 
	míd
;

168 
	sövÆid©i⁄_ªque°
 {

169 
li°_hód
 
	mli°
;

170 
cblock_ønge
 *
	mcblocks
;

172 
©omic_t
 
	mcom∂ëe
;

173 
	mîr
;

175 
waô_queue_hód_t
 
	mªsu…_waô
;

178 
	sˇche
 {

179 
dm_èrgë
 *
	mti
;

180 
dm_èrgë_ˇŒbacks
 
	mˇŒbacks
;

182 
dm_ˇche_mëad©a
 *
	mcmd
;

187 
dm_dev
 *
	mmëad©a_dev
;

192 
dm_dev
 *
	m‹igö_dev
;

197 
dm_dev
 *
	mˇche_dev
;

202 
dm_oblock_t
 
	m‹igö_blocks
;

203 
£˘‹_t
 
	m‹igö_£˘‹s
;

208 
dm_cblock_t
 
	mˇche_size
;

213 
uöt32_t
 
	m£˘‹s_≥r_block
;

214 
	m£˘‹s_≥r_block_shi·
;

216 
•ölock_t
 
	mlock
;

217 
bio_li°
 
	mde„ºed_bios
;

218 
bio_li°
 
	mde„ºed_Êush_bios
;

219 
bio_li°
 
	mde„ºed_wrôëhrough_bios
;

220 
li°_hód
 
	mquõs˚d_migøti⁄s
;

221 
li°_hód
 
	mcom∂ëed_migøti⁄s
;

222 
li°_hód
 
	m√ed_commô_migøti⁄s
;

223 
£˘‹_t
 
	mmigøti⁄_thªshﬁd
;

224 
waô_queue_hód_t
 
	mmigøti⁄_waô
;

225 
©omic_t
 
	mƒ_migøti⁄s
;

227 
waô_queue_hód_t
 
	mquõscög_waô
;

228 
©omic_t
 
	mquõscög
;

229 
©omic_t
 
	mquõscög_ack
;

234 
©omic_t
 
	mƒ_dúty
;

235 *
	mdúty_bô£t
;

240 
dm_oblock_t
 
	mdisˇrd_ƒ_blocks
;

241 *
	mdisˇrd_bô£t
;

247 
	mƒ_˘r_¨gs
;

248 c⁄° **
	m˘r_¨gs
;

250 
dm_kc›yd_˛õ¡
 *
	mc›õr
;

251 
w‹kqueue_°ru˘
 *
	mwq
;

252 
w‹k_°ru˘
 
	mw‹kî
;

254 
dñayed_w‹k
 
	mwakî
;

255 
	mœ°_commô_jiffõs
;

257 
dm_bio_¥is⁄
 *
	m¥is⁄
;

258 
dm_de„ºed_£t
 *
	mÆl_io_ds
;

260 
mempoﬁ_t
 *
	mmigøti⁄_poﬁ
;

261 
dm_ˇche_migøti⁄
 *
	m√xt_migøti⁄
;

263 
dm_ˇche_pﬁicy
 *
	mpﬁicy
;

264 
	mpﬁicy_ƒ_¨gs
;

266 
boﬁ
 
	m√ed_tick_bio
:1;

267 
boﬁ
 
	msized
:1;

268 
boﬁ
 
	mövÆid©e
:1;

269 
boﬁ
 
	mcommô_ªque°ed
:1;

270 
boﬁ
 
	mlﬂded_m≠pögs
:1;

271 
boﬁ
 
	mlﬂded_disˇrds
:1;

276 
ˇche_„©uªs
 
	m„©uªs
;

278 
ˇche_°©s
 
	m°©s
;

283 
•ölock_t
 
	mövÆid©i⁄_lock
;

284 
li°_hód
 
	mövÆid©i⁄_ªque°s
;

287 
	s≥r_bio_d©a
 {

288 
boﬁ
 
	mtick
:1;

289 
	mªq_ƒ
:2;

290 
dm_de„ºed_íåy
 *
	mÆl_io_íåy
;

291 
dm_hook_öfo
 
	mhook_öfo
;

298 
ˇche
 *
	mˇche
;

299 
dm_cblock_t
 
	mcblock
;

300 
dm_bio_dëaûs
 
	mbio_dëaûs
;

303 
	sdm_ˇche_migøti⁄
 {

304 
li°_hód
 
	mli°
;

305 
ˇche
 *
	mˇche
;

307 
	m°¨t_jiffõs
;

308 
dm_oblock_t
 
	mﬁd_oblock
;

309 
dm_oblock_t
 
	m√w_oblock
;

310 
dm_cblock_t
 
	mcblock
;

312 
boﬁ
 
	mîr
:1;

313 
boﬁ
 
	mwrôeback
:1;

314 
boﬁ
 
	mdemŸe
:1;

315 
boﬁ
 
	m¥omŸe
:1;

316 
boﬁ
 
	mªqueue_hﬁdî
:1;

317 
boﬁ
 
	mövÆid©e
:1;

319 
dm_bio_¥is⁄_˚Œ
 *
	mﬁd_o˚Œ
;

320 
dm_bio_¥is⁄_˚Œ
 *
	m√w_o˚Œ
;

328 
	s¥óŒoc
 {

329 
dm_ˇche_migøti⁄
 *
	mmg
;

330 
dm_bio_¥is⁄_˚Œ
 *
	m˚Œ1
;

331 
dm_bio_¥is⁄_˚Œ
 *
	m˚Œ2
;

334 
	$wake_w‹kî
(
ˇche
 *cache)

336 
	`queue_w‹k
(
ˇche
->
wq
, &ˇche->
w‹kî
);

337 
	}
}

341 
dm_bio_¥is⁄_˚Œ
 *
	$Æloc_¥is⁄_˚Œ
(
ˇche
 *cache)

344  
	`dm_bio_¥is⁄_Æloc_˚Œ
(
ˇche
->
¥is⁄
, 
GFP_NOWAIT
);

345 
	}
}

347 
	$‰ì_¥is⁄_˚Œ
(
ˇche
 *ˇche, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

349 
	`dm_bio_¥is⁄_‰ì_˚Œ
(
ˇche
->
¥is⁄
, 
˚Œ
);

350 
	}
}

352 
	$¥óŒoc_d©a_°ru˘s
(
ˇche
 *ˇche, 
¥óŒoc
 *
p
)

354 i‡(!
p
->
mg
) {

355 
p
->
mg
 = 
	`mempoﬁ_Æloc
(
ˇche
->
migøti⁄_poﬁ
, 
GFP_NOWAIT
);

356 i‡(!
p
->
mg
)

357  -
ENOMEM
;

360 i‡(!
p
->
˚Œ1
) {

361 
p
->
˚Œ1
 = 
	`Æloc_¥is⁄_˚Œ
(
ˇche
);

362 i‡(!
p
->
˚Œ1
)

363  -
ENOMEM
;

366 i‡(!
p
->
˚Œ2
) {

367 
p
->
˚Œ2
 = 
	`Æloc_¥is⁄_˚Œ
(
ˇche
);

368 i‡(!
p
->
˚Œ2
)

369  -
ENOMEM
;

373 
	}
}

375 
	$¥óŒoc_‰ì_°ru˘s
(
ˇche
 *ˇche, 
¥óŒoc
 *
p
)

377 i‡(
p
->
˚Œ2
)

378 
	`‰ì_¥is⁄_˚Œ
(
ˇche
, 
p
->
˚Œ2
);

380 i‡(
p
->
˚Œ1
)

381 
	`‰ì_¥is⁄_˚Œ
(
ˇche
, 
p
->
˚Œ1
);

383 i‡(
p
->
mg
)

384 
	`mempoﬁ_‰ì
(
p
->
mg
, 
ˇche
->
migøti⁄_poﬁ
);

385 
	}
}

387 
dm_ˇche_migøti⁄
 *
	$¥óŒoc_gë_migøti⁄
(
¥óŒoc
 *
p
)

389 
dm_ˇche_migøti⁄
 *
mg
 = 
p
->mg;

391 
	`BUG_ON
(!
mg
);

392 
p
->
mg
 = 
NULL
;

394  
mg
;

395 
	}
}

401 
dm_bio_¥is⁄_˚Œ
 *
	$¥óŒoc_gë_˚Œ
(
¥óŒoc
 *
p
)

403 
dm_bio_¥is⁄_˚Œ
 *
r
 = 
NULL
;

405 i‡(
p
->
˚Œ1
) {

406 
r
 = 
p
->
˚Œ1
;

407 
p
->
˚Œ1
 = 
NULL
;

409 } i‡(
p
->
˚Œ2
) {

410 
r
 = 
p
->
˚Œ2
;

411 
p
->
˚Œ2
 = 
NULL
;

413 
	`BUG
();

415  
r
;

416 
	}
}

422 
	$¥óŒoc_put_˚Œ
(
¥óŒoc
 *
p
, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

424 i‡(!
p
->
˚Œ2
)

425 
p
->
˚Œ2
 = 
˚Œ
;

427 i‡(!
p
->
˚Œ1
)

428 
p
->
˚Œ1
 = 
˚Œ
;

431 
	`BUG
();

432 
	}
}

436 
	$buûd_key
(
dm_oblock_t
 
oblock
, 
dm_˚Œ_key
 *
key
)

438 
key
->
vútuÆ
 = 0;

439 
key
->
dev
 = 0;

440 
key
->
block
 = 
	`‰om_oblock
(
oblock
);

441 
	}
}

448 (*
	t˚Œ_‰ì_‚
)(*
	tc⁄ãxt
, 
	tdm_bio_¥is⁄_˚Œ
 *
	t˚Œ
);

450 
	$bio_dëaö
(
ˇche
 *ˇche, 
dm_oblock_t
 
oblock
,

451 
bio
 *bio, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
,

452 
˚Œ_‰ì_‚
 
‰ì_‚
, *
‰ì_c⁄ãxt
,

453 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

455 
r
;

456 
dm_˚Œ_key
 
key
;

458 
	`buûd_key
(
oblock
, &
key
);

459 
r
 = 
	`dm_bio_dëaö
(
ˇche
->
¥is⁄
, &
key
, 
bio
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

460 i‡(
r
)

461 
	`‰ì_‚
(
‰ì_c⁄ãxt
, 
˚Œ_¥óŒoc
);

463  
r
;

464 
	}
}

466 
	$gë_˚Œ
(
ˇche
 *cache,

467 
dm_oblock_t
 
oblock
,

468 
¥óŒoc
 *
°ru˘s
,

469 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

471 
r
;

472 
dm_˚Œ_key
 
key
;

473 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
;

475 
˚Œ_¥óŒoc
 = 
	`¥óŒoc_gë_˚Œ
(
°ru˘s
);

477 
	`buûd_key
(
oblock
, &
key
);

478 
r
 = 
	`dm_gë_˚Œ
(
ˇche
->
¥is⁄
, &
key
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

479 i‡(
r
)

480 
	`¥óŒoc_put_˚Œ
(
°ru˘s
, 
˚Œ_¥óŒoc
);

482  
r
;

483 
	}
}

487 
boﬁ
 
	$is_dúty
(
ˇche
 *ˇche, 
dm_cblock_t
 
b
)

489  
	`ã°_bô
(
	`‰om_cblock
(
b
), 
ˇche
->
dúty_bô£t
);

490 
	}
}

492 
	$£t_dúty
(
ˇche
 *ˇche, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
)

494 i‡(!
	`ã°_™d_£t_bô
(
	`‰om_cblock
(
cblock
), 
ˇche
->
dúty_bô£t
)) {

495 
	`©omic_öc
(&
ˇche
->
ƒ_dúty
);

496 
	`pﬁicy_£t_dúty
(
ˇche
->
pﬁicy
, 
oblock
);

498 
	}
}

500 
	$˛ór_dúty
(
ˇche
 *ˇche, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
)

502 i‡(
	`ã°_™d_˛ór_bô
(
	`‰om_cblock
(
cblock
), 
ˇche
->
dúty_bô£t
)) {

503 
	`pﬁicy_˛ór_dúty
(
ˇche
->
pﬁicy
, 
oblock
);

504 i‡(
	`©omic_dec_ªtu∫
(&
ˇche
->
ƒ_dúty
) == 0)

505 
	`dm_èbÀ_evít
(
ˇche
->
ti
->
èbÀ
);

507 
	}
}

511 
boﬁ
 
	$block_size_is_powî_of_two
(
ˇche
 *cache)

513  
ˇche
->
£˘‹s_≥r_block_shi·
 >= 0;

514 
	}
}

517 #i‡
deföed
(
CONFIG_ARM
Ë&& 
__GNUC__
 =4 && 
__GNUC_MINOR__
 <= 6

518 
	g__Æways_ölöe


520 
dm_block_t
 
	$block_div
(
dm_block_t
 
b
, 
uöt32_t
 
n
)

522 
	`do_div
(
b
, 
n
);

524  
b
;

525 
	}
}

527 
	$£t_disˇrd
(
ˇche
 *ˇche, 
dm_oblock_t
 
b
)

529 
Êags
;

531 
	`©omic_öc
(&
ˇche
->
°©s
.
disˇrd_cou¡
);

533 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

534 
	`£t_bô
(
	`‰om_oblock
(
b
), 
ˇche
->
disˇrd_bô£t
);

535 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

536 
	}
}

538 
	$˛ór_disˇrd
(
ˇche
 *ˇche, 
dm_oblock_t
 
b
)

540 
Êags
;

542 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

543 
	`˛ór_bô
(
	`‰om_oblock
(
b
), 
ˇche
->
disˇrd_bô£t
);

544 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

545 
	}
}

547 
boﬁ
 
	$is_disˇrded
(
ˇche
 *ˇche, 
dm_oblock_t
 
b
)

549 
r
;

550 
Êags
;

552 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

553 
r
 = 
	`ã°_bô
(
	`‰om_oblock
(
b
), 
ˇche
->
disˇrd_bô£t
);

554 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

556  
r
;

557 
	}
}

559 
boﬁ
 
	$is_disˇrded_oblock
(
ˇche
 *ˇche, 
dm_oblock_t
 
b
)

561 
r
;

562 
Êags
;

564 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

565 
r
 = 
	`ã°_bô
(
	`‰om_oblock
(
b
), 
ˇche
->
disˇrd_bô£t
);

566 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

568  
r
;

569 
	}
}

573 
	$lﬂd_°©s
(
ˇche
 *cache)

575 
dm_ˇche_°©i°ics
 
°©s
;

577 
	`dm_ˇche_mëad©a_gë_°©s
(
ˇche
->
cmd
, &
°©s
);

578 
	`©omic_£t
(&
ˇche
->
°©s
.
ªad_hô
, sèts.
ªad_hôs
);

579 
	`©omic_£t
(&
ˇche
->
°©s
.
ªad_miss
, sèts.
ªad_mis£s
);

580 
	`©omic_£t
(&
ˇche
->
°©s
.
wrôe_hô
, sèts.
wrôe_hôs
);

581 
	`©omic_£t
(&
ˇche
->
°©s
.
wrôe_miss
, sèts.
wrôe_mis£s
);

582 
	}
}

584 
	$ßve_°©s
(
ˇche
 *cache)

586 
dm_ˇche_°©i°ics
 
°©s
;

588 
°©s
.
ªad_hôs
 = 
	`©omic_ªad
(&
ˇche
->°©s.
ªad_hô
);

589 
°©s
.
ªad_mis£s
 = 
	`©omic_ªad
(&
ˇche
->°©s.
ªad_miss
);

590 
°©s
.
wrôe_hôs
 = 
	`©omic_ªad
(&
ˇche
->°©s.
wrôe_hô
);

591 
°©s
.
wrôe_mis£s
 = 
	`©omic_ªad
(&
ˇche
->°©s.
wrôe_miss
);

593 
	`dm_ˇche_mëad©a_£t_°©s
(
ˇche
->
cmd
, &
°©s
);

594 
	}
}

603 
	#PB_DATA_SIZE_WB
 (
	`off£tof
(
≥r_bio_d©a
, 
ˇche
))

	)

604 
	#PB_DATA_SIZE_WT
 ((
≥r_bio_d©a
))

	)

606 
boﬁ
 
	$wrôëhrough_mode
(
ˇche_„©uªs
 *
f
)

608  
f
->
io_mode
 =
CM_IO_WRITETHROUGH
;

609 
	}
}

611 
boﬁ
 
	$wrôeback_mode
(
ˇche_„©uªs
 *
f
)

613  
f
->
io_mode
 =
CM_IO_WRITEBACK
;

614 
	}
}

616 
boﬁ
 
	$∑s°hrough_mode
(
ˇche_„©uªs
 *
f
)

618  
f
->
io_mode
 =
CM_IO_PASSTHROUGH
;

619 
	}
}

621 
size_t
 
	$gë_≥r_bio_d©a_size
(
ˇche
 *cache)

623  
	`wrôëhrough_mode
(&
ˇche
->
„©uªs
Ë? 
PB_DATA_SIZE_WT
 : 
PB_DATA_SIZE_WB
;

624 
	}
}

626 
≥r_bio_d©a
 *
	$gë_≥r_bio_d©a
(
bio
 *bio, 
size_t
 
d©a_size
)

628 
≥r_bio_d©a
 *
pb
 = 
	`dm_≥r_bio_d©a
(
bio
, 
d©a_size
);

629 
	`BUG_ON
(!
pb
);

630  
pb
;

631 
	}
}

633 
≥r_bio_d©a
 *
	$öô_≥r_bio_d©a
(
bio
 *bio, 
size_t
 
d©a_size
)

635 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
d©a_size
);

637 
pb
->
tick
 = 
Ál£
;

638 
pb
->
ªq_ƒ
 = 
	`dm_bio_gë_èrgë_bio_ƒ
(
bio
);

639 
pb
->
Æl_io_íåy
 = 
NULL
;

641  
pb
;

642 
	}
}

647 
	$ªm≠_to_‹igö
(
ˇche
 *ˇche, 
bio
 *bio)

649 
bio
->
bi_bdev
 = 
ˇche
->
‹igö_dev
->
bdev
;

650 
	}
}

652 
	$ªm≠_to_ˇche
(
ˇche
 *ˇche, 
bio
 *bio,

653 
dm_cblock_t
 
cblock
)

655 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

656 
£˘‹_t
 
block
 = 
	`‰om_cblock
(
cblock
);

658 
bio
->
bi_bdev
 = 
ˇche
->
ˇche_dev
->
bdev
;

659 i‡(!
	`block_size_is_powî_of_two
(
ˇche
))

660 
bio
->
bi_ôî
.
bi_£˘‹
 =

661 (
block
 * 
ˇche
->
£˘‹s_≥r_block
) +

662 
	`£˘‹_div
(
bi_£˘‹
, 
ˇche
->
£˘‹s_≥r_block
);

664 
bio
->
bi_ôî
.
bi_£˘‹
 =

665 (
block
 << 
ˇche
->
£˘‹s_≥r_block_shi·
) |

666 (
bi_£˘‹
 & (
ˇche
->
£˘‹s_≥r_block
 - 1));

667 
	}
}

669 
	$check_if_tick_bio_√eded
(
ˇche
 *ˇche, 
bio
 *bio)

671 
Êags
;

672 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

673 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

675 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

676 i‡(
ˇche
->
√ed_tick_bio
 &&

677 !(
bio
->
bi_rw
 & (
REQ_FUA
 | 
REQ_FLUSH
 | 
REQ_DISCARD
))) {

678 
pb
->
tick
 = 
åue
;

679 
ˇche
->
√ed_tick_bio
 = 
Ál£
;

681 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

682 
	}
}

684 
	$ªm≠_to_‹igö_˛ór_disˇrd
(
ˇche
 *ˇche, 
bio
 *bio,

685 
dm_oblock_t
 
oblock
)

687 
	`check_if_tick_bio_√eded
(
ˇche
, 
bio
);

688 
	`ªm≠_to_‹igö
(
ˇche
, 
bio
);

689 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
)

690 
	`˛ór_disˇrd
(
ˇche
, 
oblock
);

691 
	}
}

693 
	$ªm≠_to_ˇche_dúty
(
ˇche
 *ˇche, 
bio
 *bio,

694 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
)

696 
	`check_if_tick_bio_√eded
(
ˇche
, 
bio
);

697 
	`ªm≠_to_ˇche
(
ˇche
, 
bio
, 
cblock
);

698 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

699 
	`£t_dúty
(
ˇche
, 
oblock
, 
cblock
);

700 
	`˛ór_disˇrd
(
ˇche
, 
oblock
);

702 
	}
}

704 
dm_oblock_t
 
	$gë_bio_block
(
ˇche
 *ˇche, 
bio
 *bio)

706 
£˘‹_t
 
block_ƒ
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

708 i‡(!
	`block_size_is_powî_of_two
(
ˇche
))

709 (Ë
	`£˘‹_div
(
block_ƒ
, 
ˇche
->
£˘‹s_≥r_block
);

711 
block_ƒ
 >>
ˇche
->
£˘‹s_≥r_block_shi·
;

713  
	`to_oblock
(
block_ƒ
);

714 
	}
}

716 
	$bio_åiggîs_commô
(
ˇche
 *ˇche, 
bio
 *bio)

718  
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_FUA
);

719 
	}
}

725 
	$öc_ds
(
ˇche
 *ˇche, 
bio
 *bio,

726 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

728 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

729 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

731 
	`BUG_ON
(!
˚Œ
);

732 
	`BUG_ON
(
pb
->
Æl_io_íåy
);

734 
pb
->
Æl_io_íåy
 = 
	`dm_de„ºed_íåy_öc
(
ˇche
->
Æl_io_ds
);

735 
	}
}

737 
	$issue
(
ˇche
 *ˇche, 
bio
 *bio)

739 
Êags
;

741 i‡(!
	`bio_åiggîs_commô
(
ˇche
, 
bio
)) {

742 
	`gíîic_make_ªque°
(
bio
);

750 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

751 
ˇche
->
commô_ªque°ed
 = 
åue
;

752 
	`bio_li°_add
(&
ˇche
->
de„ºed_Êush_bios
, 
bio
);

753 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

754 
	}
}

756 
	$öc_™d_issue
(
ˇche
 *ˇche, 
bio
 *bio, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

758 
	`öc_ds
(
ˇche
, 
bio
, 
˚Œ
);

759 
	`issue
(
ˇche
, 
bio
);

760 
	}
}

762 
	$de„r_wrôëhrough_bio
(
ˇche
 *ˇche, 
bio
 *bio)

764 
Êags
;

766 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

767 
	`bio_li°_add
(&
ˇche
->
de„ºed_wrôëhrough_bios
, 
bio
);

768 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

770 
	`wake_w‹kî
(
ˇche
);

771 
	}
}

773 
	$wrôëhrough_ídio
(
bio
 *bio, 
îr
)

775 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
PB_DATA_SIZE_WT
);

777 
	`dm_unhook_bio
(&
pb
->
hook_öfo
, 
bio
);

779 i‡(
îr
) {

780 
	`bio_ídio
(
bio
, 
îr
);

784 
	`dm_bio_ª°‹e
(&
pb
->
bio_dëaûs
, 
bio
);

785 
	`ªm≠_to_ˇche
(
pb
->
ˇche
, 
bio
,Öb->
cblock
);

792 
	`de„r_wrôëhrough_bio
(
pb
->
ˇche
, 
bio
);

793 
	}
}

801 
	$ªm≠_to_‹igö_thí_ˇche
(
ˇche
 *ˇche, 
bio
 *bio,

802 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
)

804 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
PB_DATA_SIZE_WT
);

806 
pb
->
ˇche
 = cache;

807 
pb
->
cblock
 = cblock;

808 
	`dm_hook_bio
(&
pb
->
hook_öfo
, 
bio
, 
wrôëhrough_ídio
, 
NULL
);

809 
	`dm_bio_ªc‹d
(&
pb
->
bio_dëaûs
, 
bio
);

811 
	`ªm≠_to_‹igö_˛ór_disˇrd
(
pb
->
ˇche
, 
bio
, 
oblock
);

812 
	}
}

820 
	$‰ì_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

822 
	`mempoﬁ_‰ì
(
mg
, mg->
ˇche
->
migøti⁄_poﬁ
);

823 
	}
}

825 
	$öc_ƒ_migøti⁄s
(
ˇche
 *cache)

827 
	`©omic_öc
(&
ˇche
->
ƒ_migøti⁄s
);

828 
	}
}

830 
	$dec_ƒ_migøti⁄s
(
ˇche
 *cache)

832 
	`©omic_dec
(&
ˇche
->
ƒ_migøti⁄s
);

837 
	`wake_up
(&
ˇche
->
migøti⁄_waô
);

838 
	}
}

840 
	$__˚Œ_de„r
(
ˇche
 *ˇche, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

841 
boﬁ
 
hﬁdî
)

843 (
hﬁdî
 ? 
dm_˚Œ_ªÀa£
 : 
dm_˚Œ_ªÀa£_no_hﬁdî
)

844 (
ˇche
->
¥is⁄
, 
˚Œ
, &ˇche->
de„ºed_bios
);

845 
	`‰ì_¥is⁄_˚Œ
(
ˇche
, 
˚Œ
);

846 
	}
}

848 
	$˚Œ_de„r
(
ˇche
 *ˇche, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

849 
boﬁ
 
hﬁdî
)

851 
Êags
;

853 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

854 
	`__˚Œ_de„r
(
ˇche
, 
˚Œ
, 
hﬁdî
);

855 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

857 
	`wake_w‹kî
(
ˇche
);

858 
	}
}

860 
	$˛ónup_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

862 
ˇche
 *ˇchê
mg
->cache;

863 
	`‰ì_migøti⁄
(
mg
);

864 
	`dec_ƒ_migøti⁄s
(
ˇche
);

865 
	}
}

867 
	$migøti⁄_Áûuª
(
dm_ˇche_migøti⁄
 *
mg
)

869 
ˇche
 *ˇchê
mg
->cache;

871 i‡(
mg
->
wrôeback
) {

872 
	`DMWARN_LIMIT
("writeback failed; couldn't copy block");

873 
	`£t_dúty
(
ˇche
, 
mg
->
ﬁd_oblock
, mg->
cblock
);

874 
	`˚Œ_de„r
(
ˇche
, 
mg
->
ﬁd_o˚Œ
, 
Ál£
);

876 } i‡(
mg
->
demŸe
) {

877 
	`DMWARN_LIMIT
("demotion failed; couldn't copy block");

878 
	`pﬁicy_f‹˚_m≠pög
(
ˇche
->
pﬁicy
, 
mg
->
√w_oblock
, mg->
ﬁd_oblock
);

880 
	`˚Œ_de„r
(
ˇche
, 
mg
->
ﬁd_o˚Œ
, mg->
¥omŸe
 ? 
Ál£
 : 
åue
);

881 i‡(
mg
->
¥omŸe
)

882 
	`˚Œ_de„r
(
ˇche
, 
mg
->
√w_o˚Œ
, 
åue
);

884 
	`DMWARN_LIMIT
("promotion failed; couldn't copy block");

885 
	`pﬁicy_ªmove_m≠pög
(
ˇche
->
pﬁicy
, 
mg
->
√w_oblock
);

886 
	`˚Œ_de„r
(
ˇche
, 
mg
->
√w_o˚Œ
, 
åue
);

889 
	`˛ónup_migøti⁄
(
mg
);

890 
	}
}

892 
	$migøti⁄_suc˚ss_¥e_commô
(
dm_ˇche_migøti⁄
 *
mg
)

894 
Êags
;

895 
ˇche
 *ˇchê
mg
->cache;

897 i‡(
mg
->
wrôeback
) {

898 
	`˛ór_dúty
(
ˇche
, 
mg
->
ﬁd_oblock
, mg->
cblock
);

899 
	`˚Œ_de„r
(
ˇche
, 
mg
->
ﬁd_o˚Œ
, 
Ál£
);

900 
	`˛ónup_migøti⁄
(
mg
);

903 } i‡(
mg
->
demŸe
) {

904 i‡(
	`dm_ˇche_ªmove_m≠pög
(
ˇche
->
cmd
, 
mg
->
cblock
)) {

905 
	`DMWARN_LIMIT
("demotion failed; couldn't update on disk metadata");

906 
	`pﬁicy_f‹˚_m≠pög
(
ˇche
->
pﬁicy
, 
mg
->
√w_oblock
,

907 
mg
->
ﬁd_oblock
);

908 i‡(
mg
->
¥omŸe
)

909 
	`˚Œ_de„r
(
ˇche
, 
mg
->
√w_o˚Œ
, 
åue
);

910 
	`˛ónup_migøti⁄
(
mg
);

914 i‡(
	`dm_ˇche_ö£π_m≠pög
(
ˇche
->
cmd
, 
mg
->
cblock
, mg->
√w_oblock
)) {

915 
	`DMWARN_LIMIT
("promotion failed; couldn't update on disk metadata");

916 
	`pﬁicy_ªmove_m≠pög
(
ˇche
->
pﬁicy
, 
mg
->
√w_oblock
);

917 
	`˛ónup_migøti⁄
(
mg
);

922 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

923 
	`li°_add_èû
(&
mg
->
li°
, &
ˇche
->
√ed_commô_migøti⁄s
);

924 
ˇche
->
commô_ªque°ed
 = 
åue
;

925 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

926 
	}
}

928 
	$migøti⁄_suc˚ss_po°_commô
(
dm_ˇche_migøti⁄
 *
mg
)

930 
Êags
;

931 
ˇche
 *ˇchê
mg
->cache;

933 i‡(
mg
->
wrôeback
) {

934 
	`DMWARN
("writeback unexpectedlyÅriggered commit");

937 } i‡(
mg
->
demŸe
) {

938 
	`˚Œ_de„r
(
ˇche
, 
mg
->
ﬁd_o˚Œ
, mg->
¥omŸe
 ? 
Ál£
 : 
åue
);

940 i‡(
mg
->
¥omŸe
) {

941 
mg
->
demŸe
 = 
Ál£
;

943 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

944 
	`li°_add_èû
(&
mg
->
li°
, &
ˇche
->
quõs˚d_migøti⁄s
);

945 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

948 i‡(
mg
->
övÆid©e
)

949 
	`pﬁicy_ªmove_m≠pög
(
ˇche
->
pﬁicy
, 
mg
->
ﬁd_oblock
);

950 
	`˛ónup_migøti⁄
(
mg
);

954 
	`˛ór_dúty
(
ˇche
, 
mg
->
√w_oblock
, mg->
cblock
);

955 i‡(
mg
->
ªqueue_hﬁdî
)

956 
	`˚Œ_de„r
(
ˇche
, 
mg
->
√w_o˚Œ
, 
åue
);

958 
	`bio_ídio
(
mg
->
√w_o˚Œ
->
hﬁdî
, 0);

959 
	`˚Œ_de„r
(
ˇche
, 
mg
->
√w_o˚Œ
, 
Ál£
);

961 
	`˛ónup_migøti⁄
(
mg
);

963 
	}
}

965 
	$c›y_com∂ëe
(
ªad_îr
, 
wrôe_îr
, *
c⁄ãxt
)

967 
Êags
;

968 
dm_ˇche_migøti⁄
 *
mg
 = (dm_ˇche_migøti⁄ *Ë
c⁄ãxt
;

969 
ˇche
 *ˇchê
mg
->cache;

971 i‡(
ªad_îr
 || 
wrôe_îr
)

972 
mg
->
îr
 = 
åue
;

974 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

975 
	`li°_add_èû
(&
mg
->
li°
, &
ˇche
->
com∂ëed_migøti⁄s
);

976 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

978 
	`wake_w‹kî
(
ˇche
);

979 
	}
}

981 
	$issue_c›y_ªÆ
(
dm_ˇche_migøti⁄
 *
mg
)

983 
r
;

984 
dm_io_ªgi⁄
 
o_ªgi⁄
, 
c_ªgi⁄
;

985 
ˇche
 *ˇchê
mg
->cache;

986 
£˘‹_t
 
cblock
 = 
	`‰om_cblock
(
mg
->cblock);

988 
o_ªgi⁄
.
bdev
 = 
ˇche
->
‹igö_dev
->bdev;

989 
o_ªgi⁄
.
cou¡
 = 
ˇche
->
£˘‹s_≥r_block
;

991 
c_ªgi⁄
.
bdev
 = 
ˇche
->
ˇche_dev
->bdev;

992 
c_ªgi⁄
.
£˘‹
 = 
cblock
 * 
ˇche
->
£˘‹s_≥r_block
;

993 
c_ªgi⁄
.
cou¡
 = 
ˇche
->
£˘‹s_≥r_block
;

995 i‡(
mg
->
wrôeback
 || mg->
demŸe
) {

997 
o_ªgi⁄
.
£˘‹
 = 
	`‰om_oblock
(
mg
->
ﬁd_oblock
Ë* 
ˇche
->
£˘‹s_≥r_block
;

998 
r
 = 
	`dm_kc›yd_c›y
(
ˇche
->
c›õr
, &
c_ªgi⁄
, 1, &
o_ªgi⁄
, 0, 
c›y_com∂ëe
, 
mg
);

1001 
o_ªgi⁄
.
£˘‹
 = 
	`‰om_oblock
(
mg
->
√w_oblock
Ë* 
ˇche
->
£˘‹s_≥r_block
;

1002 
r
 = 
	`dm_kc›yd_c›y
(
ˇche
->
c›õr
, &
o_ªgi⁄
, 1, &
c_ªgi⁄
, 0, 
c›y_com∂ëe
, 
mg
);

1005 i‡(
r
 < 0) {

1006 
	`DMERR_LIMIT
("issuing migration failed");

1007 
	`migøti⁄_Áûuª
(
mg
);

1009 
	}
}

1011 
	$ovîwrôe_ídio
(
bio
 *bio, 
îr
)

1013 
dm_ˇche_migøti⁄
 *
mg
 = 
bio
->
bi_¥iv©e
;

1014 
ˇche
 *ˇchê
mg
->cache;

1015 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

1016 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

1017 
Êags
;

1019 
	`dm_unhook_bio
(&
pb
->
hook_öfo
, 
bio
);

1021 i‡(
îr
)

1022 
mg
->
îr
 = 
åue
;

1024 
mg
->
ªqueue_hﬁdî
 = 
Ál£
;

1026 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1027 
	`li°_add_èû
(&
mg
->
li°
, &
ˇche
->
com∂ëed_migøti⁄s
);

1028 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1030 
	`wake_w‹kî
(
ˇche
);

1031 
	}
}

1033 
	$issue_ovîwrôe
(
dm_ˇche_migøti⁄
 *
mg
, 
bio
 *bio)

1035 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
mg
->
ˇche
);

1036 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

1038 
	`dm_hook_bio
(&
pb
->
hook_öfo
, 
bio
, 
ovîwrôe_ídio
, 
mg
);

1039 
	`ªm≠_to_ˇche_dúty
(
mg
->
ˇche
, 
bio
, mg->
√w_oblock
, mg->
cblock
);

1045 
	`gíîic_make_ªque°
(
bio
);

1046 
	}
}

1048 
boﬁ
 
	$bio_wrôes_com∂ëe_block
(
ˇche
 *ˇche, 
bio
 *bio)

1050  (
	`bio_d©a_dú
(
bio
Ë=
WRITE
) &&

1051 (
bio
->
bi_ôî
.
bi_size
 =(
ˇche
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
));

1052 
	}
}

1054 
	$avoid_c›y
(
dm_ˇche_migøti⁄
 *
mg
)

1056 
	`©omic_öc
(&
mg
->
ˇche
->
°©s
.
c›õs_avoided
);

1057 
	`migøti⁄_suc˚ss_¥e_commô
(
mg
);

1058 
	}
}

1060 
	$issue_c›y
(
dm_ˇche_migøti⁄
 *
mg
)

1062 
boﬁ
 
avoid
;

1063 
ˇche
 *ˇchê
mg
->cache;

1065 i‡(
mg
->
wrôeback
 || mg->
demŸe
)

1066 
avoid
 = !
	`is_dúty
(
ˇche
, 
mg
->
cblock
) ||

1067 
	`is_disˇrded_oblock
(
ˇche
, 
mg
->
ﬁd_oblock
);

1069 
bio
 *biÿ
mg
->
√w_o˚Œ
->
hﬁdî
;

1071 
avoid
 = 
	`is_disˇrded_oblock
(
ˇche
, 
mg
->
√w_oblock
);

1073 i‡(!
avoid
 && 
	`bio_wrôes_com∂ëe_block
(
ˇche
, 
bio
)) {

1074 
	`issue_ovîwrôe
(
mg
, 
bio
);

1079 
avoid
 ? 
	`avoid_c›y
(
mg
Ë: 
	`issue_c›y_ªÆ
(mg);

1080 
	}
}

1082 
	$com∂ëe_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

1084 i‡(
mg
->
îr
)

1085 
	`migøti⁄_Áûuª
(
mg
);

1087 
	`migøti⁄_suc˚ss_¥e_commô
(
mg
);

1088 
	}
}

1090 
¥o˚ss_migøti⁄s
(
ˇche
 *ˇche, 
li°_hód
 *
hód
,

1091 (*
‚
)(
dm_ˇche_migøti⁄
 *))

1093 
Êags
;

1094 
li°_hód
 
li°
;

1095 
dm_ˇche_migøti⁄
 *
mg
, *
tmp
;

1097 
	`INIT_LIST_HEAD
(&
li°
);

1098 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1099 
	`li°_•li˚_öô
(
hód
, &
li°
);

1100 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1102 
	`li°_f‹_óch_íåy_ß„
(
mg
, 
tmp
, &
li°
,Üist)

1103 
	`‚
(
mg
);

1104 
	}
}

1106 
	$__queue_quõs˚d_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

1108 
	`li°_add_èû
(&
mg
->
li°
, &mg->
ˇche
->
quõs˚d_migøti⁄s
);

1109 
	}
}

1111 
	$queue_quõs˚d_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

1113 
Êags
;

1114 
ˇche
 *ˇchê
mg
->cache;

1116 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1117 
	`__queue_quõs˚d_migøti⁄
(
mg
);

1118 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1120 
	`wake_w‹kî
(
ˇche
);

1121 
	}
}

1123 
	$queue_quõs˚d_migøti⁄s
(
ˇche
 *ˇche, 
li°_hód
 *
w‹k
)

1125 
Êags
;

1126 
dm_ˇche_migøti⁄
 *
mg
, *
tmp
;

1128 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1129 
	`li°_f‹_óch_íåy_ß„
(
mg
, 
tmp
, 
w‹k
, 
li°
)

1130 
	`__queue_quõs˚d_migøti⁄
(
mg
);

1131 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1133 
	`wake_w‹kî
(
ˇche
);

1134 
	}
}

1136 
	$check_f‹_quõs˚d_migøti⁄s
(
ˇche
 *cache,

1137 
≥r_bio_d©a
 *
pb
)

1139 
li°_hód
 
w‹k
;

1141 i‡(!
pb
->
Æl_io_íåy
)

1144 
	`INIT_LIST_HEAD
(&
w‹k
);

1145 
	`dm_de„ºed_íåy_dec
(
pb
->
Æl_io_íåy
, &
w‹k
);

1147 i‡(!
	`li°_em±y
(&
w‹k
))

1148 
	`queue_quõs˚d_migøti⁄s
(
ˇche
, &
w‹k
);

1149 
	}
}

1151 
	$quõs˚_migøti⁄
(
dm_ˇche_migøti⁄
 *
mg
)

1153 i‡(!
	`dm_de„ºed_£t_add_w‹k
(
mg
->
ˇche
->
Æl_io_ds
, &mg->
li°
))

1154 
	`queue_quõs˚d_migøti⁄
(
mg
);

1155 
	}
}

1157 
	$¥omŸe
(
ˇche
 *ˇche, 
¥óŒoc
 *
°ru˘s
,

1158 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

1159 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1161 
dm_ˇche_migøti⁄
 *
mg
 = 
	`¥óŒoc_gë_migøti⁄
(
°ru˘s
);

1163 
mg
->
îr
 = 
Ál£
;

1164 
mg
->
wrôeback
 = 
Ál£
;

1165 
mg
->
demŸe
 = 
Ál£
;

1166 
mg
->
¥omŸe
 = 
åue
;

1167 
mg
->
ªqueue_hﬁdî
 = 
åue
;

1168 
mg
->
övÆid©e
 = 
Ál£
;

1169 
mg
->
ˇche
 = cache;

1170 
mg
->
√w_oblock
 = 
oblock
;

1171 
mg
->
cblock
 = cblock;

1172 
mg
->
ﬁd_o˚Œ
 = 
NULL
;

1173 
mg
->
√w_o˚Œ
 = 
˚Œ
;

1174 
mg
->
°¨t_jiffõs
 = 
jiffõs
;

1176 
	`öc_ƒ_migøti⁄s
(
ˇche
);

1177 
	`quõs˚_migøti⁄
(
mg
);

1178 
	}
}

1180 
	$wrôeback
(
ˇche
 *ˇche, 
¥óŒoc
 *
°ru˘s
,

1181 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

1182 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1184 
dm_ˇche_migøti⁄
 *
mg
 = 
	`¥óŒoc_gë_migøti⁄
(
°ru˘s
);

1186 
mg
->
îr
 = 
Ál£
;

1187 
mg
->
wrôeback
 = 
åue
;

1188 
mg
->
demŸe
 = 
Ál£
;

1189 
mg
->
¥omŸe
 = 
Ál£
;

1190 
mg
->
ªqueue_hﬁdî
 = 
åue
;

1191 
mg
->
övÆid©e
 = 
Ál£
;

1192 
mg
->
ˇche
 = cache;

1193 
mg
->
ﬁd_oblock
 = 
oblock
;

1194 
mg
->
cblock
 = cblock;

1195 
mg
->
ﬁd_o˚Œ
 = 
˚Œ
;

1196 
mg
->
√w_o˚Œ
 = 
NULL
;

1197 
mg
->
°¨t_jiffõs
 = 
jiffõs
;

1199 
	`öc_ƒ_migøti⁄s
(
ˇche
);

1200 
	`quõs˚_migøti⁄
(
mg
);

1201 
	}
}

1203 
	$demŸe_thí_¥omŸe
(
ˇche
 *ˇche, 
¥óŒoc
 *
°ru˘s
,

1204 
dm_oblock_t
 
ﬁd_oblock
, dm_oblock_à
√w_oblock
,

1205 
dm_cblock_t
 
cblock
,

1206 
dm_bio_¥is⁄_˚Œ
 *
ﬁd_o˚Œ
,

1207 
dm_bio_¥is⁄_˚Œ
 *
√w_o˚Œ
)

1209 
dm_ˇche_migøti⁄
 *
mg
 = 
	`¥óŒoc_gë_migøti⁄
(
°ru˘s
);

1211 
mg
->
îr
 = 
Ál£
;

1212 
mg
->
wrôeback
 = 
Ál£
;

1213 
mg
->
demŸe
 = 
åue
;

1214 
mg
->
¥omŸe
 = 
åue
;

1215 
mg
->
ªqueue_hﬁdî
 = 
åue
;

1216 
mg
->
övÆid©e
 = 
Ál£
;

1217 
mg
->
ˇche
 = cache;

1218 
mg
->
ﬁd_oblock
 = old_oblock;

1219 
mg
->
√w_oblock
 =Çew_oblock;

1220 
mg
->
cblock
 = cblock;

1221 
mg
->
ﬁd_o˚Œ
 = old_ocell;

1222 
mg
->
√w_o˚Œ
 =Çew_ocell;

1223 
mg
->
°¨t_jiffõs
 = 
jiffõs
;

1225 
	`öc_ƒ_migøti⁄s
(
ˇche
);

1226 
	`quõs˚_migøti⁄
(
mg
);

1227 
	}
}

1233 
	$övÆid©e
(
ˇche
 *ˇche, 
¥óŒoc
 *
°ru˘s
,

1234 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

1235 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1237 
dm_ˇche_migøti⁄
 *
mg
 = 
	`¥óŒoc_gë_migøti⁄
(
°ru˘s
);

1239 
mg
->
îr
 = 
Ál£
;

1240 
mg
->
wrôeback
 = 
Ál£
;

1241 
mg
->
demŸe
 = 
åue
;

1242 
mg
->
¥omŸe
 = 
Ál£
;

1243 
mg
->
ªqueue_hﬁdî
 = 
åue
;

1244 
mg
->
övÆid©e
 = 
åue
;

1245 
mg
->
ˇche
 = cache;

1246 
mg
->
ﬁd_oblock
 = 
oblock
;

1247 
mg
->
cblock
 = cblock;

1248 
mg
->
ﬁd_o˚Œ
 = 
˚Œ
;

1249 
mg
->
√w_o˚Œ
 = 
NULL
;

1250 
mg
->
°¨t_jiffõs
 = 
jiffõs
;

1252 
	`öc_ƒ_migøti⁄s
(
ˇche
);

1253 
	`quõs˚_migøti⁄
(
mg
);

1254 
	}
}

1259 
	$de„r_bio
(
ˇche
 *ˇche, 
bio
 *bio)

1261 
Êags
;

1263 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1264 
	`bio_li°_add
(&
ˇche
->
de„ºed_bios
, 
bio
);

1265 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1267 
	`wake_w‹kî
(
ˇche
);

1268 
	}
}

1270 
	$¥o˚ss_Êush_bio
(
ˇche
 *ˇche, 
bio
 *bio)

1272 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

1273 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

1275 
	`BUG_ON
(
bio
->
bi_ôî
.
bi_size
);

1276 i‡(!
pb
->
ªq_ƒ
)

1277 
	`ªm≠_to_‹igö
(
ˇche
, 
bio
);

1279 
	`ªm≠_to_ˇche
(
ˇche
, 
bio
, 0);

1286 
	`issue
(
ˇche
, 
bio
);

1287 
	}
}

1301 
	$¥o˚ss_disˇrd_bio
(
ˇche
 *ˇche, 
bio
 *bio)

1303 
dm_block_t
 
°¨t_block
 = 
	`dm_£˘‹_div_up
(
bio
->
bi_ôî
.
bi_£˘‹
,

1304 
ˇche
->
£˘‹s_≥r_block
);

1305 
dm_block_t
 
íd_block
 = 
	`bio_íd_£˘‹
(
bio
);

1306 
dm_block_t
 
b
;

1308 
íd_block
 = 
	`block_div
”nd_block, 
ˇche
->
£˘‹s_≥r_block
);

1310 
b
 = 
°¨t_block
; b < 
íd_block
; b++)

1311 
	`£t_disˇrd
(
ˇche
, 
	`to_oblock
(
b
));

1313 
	`bio_ídio
(
bio
, 0);

1314 
	}
}

1316 
boﬁ
 
	$•¨e_migøti⁄_b™dwidth
(
ˇche
 *cache)

1318 
£˘‹_t
 
cuºít_vﬁume
 = (
	`©omic_ªad
(&
ˇche
->
ƒ_migøti⁄s
) + 1) *

1319 
ˇche
->
£˘‹s_≥r_block
;

1320  
cuºít_vﬁume
 < 
ˇche
->
migøti⁄_thªshﬁd
;

1321 
	}
}

1323 
	$öc_hô_cou¡î
(
ˇche
 *ˇche, 
bio
 *bio)

1325 
	`©omic_öc
(
	`bio_d©a_dú
(
bio
Ë=
READ
 ?

1326 &
ˇche
->
°©s
.
ªad_hô
 : &ˇche->°©s.
wrôe_hô
);

1327 
	}
}

1329 
	$öc_miss_cou¡î
(
ˇche
 *ˇche, 
bio
 *bio)

1331 
	`©omic_öc
(
	`bio_d©a_dú
(
bio
Ë=
READ
 ?

1332 &
ˇche
->
°©s
.
ªad_miss
 : &ˇche->°©s.
wrôe_miss
);

1333 
	}
}

1335 
	$¥o˚ss_bio
(
ˇche
 *ˇche, 
¥óŒoc
 *
°ru˘s
,

1336 
bio
 *bio)

1338 
r
;

1339 
boﬁ
 
ªÀa£_˚Œ
 = 
åue
;

1340 
dm_oblock_t
 
block
 = 
	`gë_bio_block
(
ˇche
, 
bio
);

1341 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
, *
ﬁd_o˚Œ
, *
√w_o˚Œ
;

1342 
pﬁicy_ªsu…
 
lookup_ªsu…
;

1343 
boﬁ
 
disˇrded_block
 = 
	`is_disˇrded_oblock
(
ˇche
, 
block
);

1344 
boﬁ
 
∑s°hrough
 = 
	`∑s°hrough_mode
(&
ˇche
->
„©uªs
);

1345 
boﬁ
 
ˇn_migøã
 = !
∑s°hrough
 && (
disˇrded_block
 || 
	`•¨e_migøti⁄_b™dwidth
(
ˇche
));

1350 
˚Œ_¥óŒoc
 = 
	`¥óŒoc_gë_˚Œ
(
°ru˘s
);

1351 
r
 = 
	`bio_dëaö
(
ˇche
, 
block
, 
bio
, 
˚Œ_¥óŒoc
,

1352 (
˚Œ_‰ì_‚
Ë
¥óŒoc_put_˚Œ
,

1353 
°ru˘s
, &
√w_o˚Œ
);

1354 i‡(
r
 > 0)

1357 
r
 = 
	`pﬁicy_m≠
(
ˇche
->
pﬁicy
, 
block
, 
åue
, 
ˇn_migøã
, 
disˇrded_block
,

1358 
bio
, &
lookup_ªsu…
);

1360 i‡(
r
 =-
EWOULDBLOCK
)

1362 
lookup_ªsu…
.
›
 = 
POLICY_MISS
;

1364 
lookup_ªsu…
.
›
) {

1365 
POLICY_HIT
:

1366 i‡(
∑s°hrough
) {

1367 
	`öc_miss_cou¡î
(
ˇche
, 
bio
);

1375 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

1376 
	`©omic_öc
(&
ˇche
->
°©s
.
demŸi⁄
);

1377 
	`övÆid©e
(
ˇche
, 
°ru˘s
, 
block
, 
lookup_ªsu…
.
cblock
, 
√w_o˚Œ
);

1378 
ªÀa£_˚Œ
 = 
Ál£
;

1382 
	`ªm≠_to_‹igö_˛ór_disˇrd
(
ˇche
, 
bio
, 
block
);

1383 
	`öc_™d_issue
(
ˇche
, 
bio
, 
√w_o˚Œ
);

1386 
	`öc_hô_cou¡î
(
ˇche
, 
bio
);

1388 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
 &&

1389 
	`wrôëhrough_mode
(&
ˇche
->
„©uªs
) &&

1390 !
	`is_dúty
(
ˇche
, 
lookup_ªsu…
.
cblock
)) {

1391 
	`ªm≠_to_‹igö_thí_ˇche
(
ˇche
, 
bio
, 
block
, 
lookup_ªsu…
.
cblock
);

1392 
	`öc_™d_issue
(
ˇche
, 
bio
, 
√w_o˚Œ
);

1395 
	`ªm≠_to_ˇche_dúty
(
ˇche
, 
bio
, 
block
, 
lookup_ªsu…
.
cblock
);

1396 
	`öc_™d_issue
(
ˇche
, 
bio
, 
√w_o˚Œ
);

1402 
POLICY_MISS
:

1403 
	`öc_miss_cou¡î
(
ˇche
, 
bio
);

1404 
	`ªm≠_to_‹igö_˛ór_disˇrd
(
ˇche
, 
bio
, 
block
);

1405 
	`öc_™d_issue
(
ˇche
, 
bio
, 
√w_o˚Œ
);

1408 
POLICY_NEW
:

1409 
	`©omic_öc
(&
ˇche
->
°©s
.
¥omŸi⁄
);

1410 
	`¥omŸe
(
ˇche
, 
°ru˘s
, 
block
, 
lookup_ªsu…
.
cblock
, 
√w_o˚Œ
);

1411 
ªÀa£_˚Œ
 = 
Ál£
;

1414 
POLICY_REPLACE
:

1415 
˚Œ_¥óŒoc
 = 
	`¥óŒoc_gë_˚Œ
(
°ru˘s
);

1416 
r
 = 
	`bio_dëaö
(
ˇche
, 
lookup_ªsu…
.
ﬁd_oblock
, 
bio
, 
˚Œ_¥óŒoc
,

1417 (
˚Œ_‰ì_‚
Ë
¥óŒoc_put_˚Œ
,

1418 
°ru˘s
, &
ﬁd_o˚Œ
);

1419 i‡(
r
 > 0) {

1425 
	`pﬁicy_f‹˚_m≠pög
(
ˇche
->
pﬁicy
, 
block
,

1426 
lookup_ªsu…
.
ﬁd_oblock
);

1427 
	`©omic_öc
(&
ˇche
->
°©s
.
ˇche_˚Œ_˛ash
);

1430 
	`©omic_öc
(&
ˇche
->
°©s
.
demŸi⁄
);

1431 
	`©omic_öc
(&
ˇche
->
°©s
.
¥omŸi⁄
);

1433 
	`demŸe_thí_¥omŸe
(
ˇche
, 
°ru˘s
, 
lookup_ªsu…
.
ﬁd_oblock
,

1434 
block
, 
lookup_ªsu…
.
cblock
,

1435 
ﬁd_o˚Œ
, 
√w_o˚Œ
);

1436 
ªÀa£_˚Œ
 = 
Ál£
;

1440 
	`DMERR_LIMIT
("%s:Éº‹ög bio, unknow¿pﬁicy op: %u", 
__func__
,

1441 (Ë
lookup_ªsu…
.
›
);

1442 
	`bio_io_îr‹
(
bio
);

1445 i‡(
ªÀa£_˚Œ
)

1446 
	`˚Œ_de„r
(
ˇche
, 
√w_o˚Œ
, 
Ál£
);

1447 
	}
}

1449 
	$√ed_commô_due_to_time
(
ˇche
 *cache)

1451  
jiffõs
 < 
ˇche
->
œ°_commô_jiffõs
 ||

1452 
jiffõs
 > 
ˇche
->
œ°_commô_jiffõs
 + 
COMMIT_PERIOD
;

1453 
	}
}

1455 
	$commô_if_√eded
(
ˇche
 *cache)

1457 
r
 = 0;

1459 i‡((
ˇche
->
commô_ªque°ed
 || 
	`√ed_commô_due_to_time
(cache)) &&

1460 
	`dm_ˇche_ch™ged_this_å™ß˘i⁄
(
ˇche
->
cmd
)) {

1461 
	`©omic_öc
(&
ˇche
->
°©s
.
commô_cou¡
);

1462 
ˇche
->
commô_ªque°ed
 = 
Ál£
;

1463 
r
 = 
	`dm_ˇche_commô
(
ˇche
->
cmd
, 
Ál£
);

1464 
ˇche
->
œ°_commô_jiffõs
 = 
jiffõs
;

1467  
r
;

1468 
	}
}

1470 
	$¥o˚ss_de„ºed_bios
(
ˇche
 *cache)

1472 
Êags
;

1473 
bio_li°
 
bios
;

1474 
bio
 *bio;

1475 
¥óŒoc
 
°ru˘s
;

1477 
	`mem£t
(&
°ru˘s
, 0, (structs));

1478 
	`bio_li°_öô
(&
bios
);

1480 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1481 
	`bio_li°_mîge
(&
bios
, &
ˇche
->
de„ºed_bios
);

1482 
	`bio_li°_öô
(&
ˇche
->
de„ºed_bios
);

1483 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1485 !
	`bio_li°_em±y
(&
bios
)) {

1491 i‡(
	`¥óŒoc_d©a_°ru˘s
(
ˇche
, &
°ru˘s
)) {

1492 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1493 
	`bio_li°_mîge
(&
ˇche
->
de„ºed_bios
, &
bios
);

1494 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1498 
bio
 = 
	`bio_li°_p›
(&
bios
);

1500 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
)

1501 
	`¥o˚ss_Êush_bio
(
ˇche
, 
bio
);

1502 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

1503 
	`¥o˚ss_disˇrd_bio
(
ˇche
, 
bio
);

1505 
	`¥o˚ss_bio
(
ˇche
, &
°ru˘s
, 
bio
);

1508 
	`¥óŒoc_‰ì_°ru˘s
(
ˇche
, &
°ru˘s
);

1509 
	}
}

1511 
	$¥o˚ss_de„ºed_Êush_bios
(
ˇche
 *ˇche, 
boﬁ
 
submô_bios
)

1513 
Êags
;

1514 
bio_li°
 
bios
;

1515 
bio
 *bio;

1517 
	`bio_li°_öô
(&
bios
);

1519 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1520 
	`bio_li°_mîge
(&
bios
, &
ˇche
->
de„ºed_Êush_bios
);

1521 
	`bio_li°_öô
(&
ˇche
->
de„ºed_Êush_bios
);

1522 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1527 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1528 
submô_bios
 ? 
	`gíîic_make_ªque°
(
bio
Ë: 
	`bio_io_îr‹
(bio);

1529 
	}
}

1531 
	$¥o˚ss_de„ºed_wrôëhrough_bios
(
ˇche
 *cache)

1533 
Êags
;

1534 
bio_li°
 
bios
;

1535 
bio
 *bio;

1537 
	`bio_li°_öô
(&
bios
);

1539 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

1540 
	`bio_li°_mîge
(&
bios
, &
ˇche
->
de„ºed_wrôëhrough_bios
);

1541 
	`bio_li°_öô
(&
ˇche
->
de„ºed_wrôëhrough_bios
);

1542 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

1547 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1548 
	`gíîic_make_ªque°
(
bio
);

1549 
	}
}

1551 
	$wrôeback_some_dúty_blocks
(
ˇche
 *cache)

1553 
r
 = 0;

1554 
dm_oblock_t
 
oblock
;

1555 
dm_cblock_t
 
cblock
;

1556 
¥óŒoc
 
°ru˘s
;

1557 
dm_bio_¥is⁄_˚Œ
 *
ﬁd_o˚Œ
;

1559 
	`mem£t
(&
°ru˘s
, 0, (structs));

1561 
	`•¨e_migøti⁄_b™dwidth
(
ˇche
)) {

1562 i‡(
	`¥óŒoc_d©a_°ru˘s
(
ˇche
, &
°ru˘s
))

1565 
r
 = 
	`pﬁicy_wrôeback_w‹k
(
ˇche
->
pﬁicy
, &
oblock
, &
cblock
);

1566 i‡(
r
)

1569 
r
 = 
	`gë_˚Œ
(
ˇche
, 
oblock
, &
°ru˘s
, &
ﬁd_o˚Œ
);

1570 i‡(
r
) {

1571 
	`pﬁicy_£t_dúty
(
ˇche
->
pﬁicy
, 
oblock
);

1575 
	`wrôeback
(
ˇche
, &
°ru˘s
, 
oblock
, 
cblock
, 
ﬁd_o˚Œ
);

1578 
	`¥óŒoc_‰ì_°ru˘s
(
ˇche
, &
°ru˘s
);

1579 
	}
}

1586 
	$¥o˚ss_övÆid©i⁄_ªque°
(
ˇche
 *ˇche, 
övÆid©i⁄_ªque°
 *
ªq
)

1588 
r
 = 0;

1589 
uöt64_t
 
begö
 = 
	`‰om_cblock
(
ªq
->
cblocks
->begin);

1590 
uöt64_t
 
íd
 = 
	`‰om_cblock
(
ªq
->
cblocks
->end);

1592 
begö
 !
íd
) {

1593 
r
 = 
	`pﬁicy_ªmove_cblock
(
ˇche
->
pﬁicy
, 
	`to_cblock
(
begö
));

1594 i‡(!
r
) {

1595 
r
 = 
	`dm_ˇche_ªmove_m≠pög
(
ˇche
->
cmd
, 
	`to_cblock
(
begö
));

1596 i‡(
r
)

1599 } i‡(
r
 =-
ENODATA
) {

1601 
r
 = 0;

1604 
	`DMERR
("policy_remove_cblock failed");

1608 
begö
++;

1611 
ˇche
->
commô_ªque°ed
 = 
åue
;

1613 
ªq
->
îr
 = 
r
;

1614 
	`©omic_£t
(&
ªq
->
com∂ëe
, 1);

1616 
	`wake_up
(&
ªq
->
ªsu…_waô
);

1617 
	}
}

1619 
	$¥o˚ss_övÆid©i⁄_ªque°s
(
ˇche
 *cache)

1621 
li°_hód
 
li°
;

1622 
övÆid©i⁄_ªque°
 *
ªq
, *
tmp
;

1624 
	`INIT_LIST_HEAD
(&
li°
);

1625 
	`•ö_lock
(&
ˇche
->
övÆid©i⁄_lock
);

1626 
	`li°_•li˚_öô
(&
ˇche
->
övÆid©i⁄_ªque°s
, &
li°
);

1627 
	`•ö_u∆ock
(&
ˇche
->
övÆid©i⁄_lock
);

1629 
	`li°_f‹_óch_íåy_ß„
 (
ªq
, 
tmp
, &
li°
,Üist)

1630 
	`¥o˚ss_övÆid©i⁄_ªque°
(
ˇche
, 
ªq
);

1631 
	}
}

1636 
boﬁ
 
	$is_quõscög
(
ˇche
 *cache)

1638  
	`©omic_ªad
(&
ˇche
->
quõscög
);

1639 
	}
}

1641 
	$ack_quõscög
(
ˇche
 *cache)

1643 i‡(
	`is_quõscög
(
ˇche
)) {

1644 
	`©omic_öc
(&
ˇche
->
quõscög_ack
);

1645 
	`wake_up
(&
ˇche
->
quõscög_waô
);

1647 
	}
}

1649 
	$waô_f‹_quõscög_ack
(
ˇche
 *cache)

1651 
	`waô_evít
(
ˇche
->
quõscög_waô
, 
	`©omic_ªad
(&ˇche->
quõscög_ack
));

1652 
	}
}

1654 
	$°¨t_quõscög
(
ˇche
 *cache)

1656 
	`©omic_öc
(&
ˇche
->
quõscög
);

1657 
	`waô_f‹_quõscög_ack
(
ˇche
);

1658 
	}
}

1660 
	$°›_quõscög
(
ˇche
 *cache)

1662 
	`©omic_£t
(&
ˇche
->
quõscög
, 0);

1663 
	`©omic_£t
(&
ˇche
->
quõscög_ack
, 0);

1664 
	}
}

1666 
	$waô_f‹_migøti⁄s
(
ˇche
 *cache)

1668 
	`waô_evít
(
ˇche
->
migøti⁄_waô
, !
	`©omic_ªad
(&ˇche->
ƒ_migøti⁄s
));

1669 
	}
}

1671 
	$°›_w‹kî
(
ˇche
 *cache)

1673 
	`ˇn˚l_dñayed_w‹k
(&
ˇche
->
wakî
);

1674 
	`Êush_w‹kqueue
(
ˇche
->
wq
);

1675 
	}
}

1677 
	$ªqueue_de„ºed_io
(
ˇche
 *cache)

1679 
bio
 *bio;

1680 
bio_li°
 
bios
;

1682 
	`bio_li°_öô
(&
bios
);

1683 
	`bio_li°_mîge
(&
bios
, &
ˇche
->
de„ºed_bios
);

1684 
	`bio_li°_öô
(&
ˇche
->
de„ºed_bios
);

1686 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1687 
	`bio_ídio
(
bio
, 
DM_ENDIO_REQUEUE
);

1688 
	}
}

1690 
	$m‹e_w‹k
(
ˇche
 *cache)

1692 i‡(
	`is_quõscög
(
ˇche
))

1693  !
	`li°_em±y
(&
ˇche
->
quõs˚d_migøti⁄s
) ||

1694 !
	`li°_em±y
(&
ˇche
->
com∂ëed_migøti⁄s
) ||

1695 !
	`li°_em±y
(&
ˇche
->
√ed_commô_migøti⁄s
);

1697  !
	`bio_li°_em±y
(&
ˇche
->
de„ºed_bios
) ||

1698 !
	`bio_li°_em±y
(&
ˇche
->
de„ºed_Êush_bios
) ||

1699 !
	`bio_li°_em±y
(&
ˇche
->
de„ºed_wrôëhrough_bios
) ||

1700 !
	`li°_em±y
(&
ˇche
->
quõs˚d_migøti⁄s
) ||

1701 !
	`li°_em±y
(&
ˇche
->
com∂ëed_migøti⁄s
) ||

1702 !
	`li°_em±y
(&
ˇche
->
√ed_commô_migøti⁄s
) ||

1703 
ˇche
->
övÆid©e
;

1704 
	}
}

1706 
	$do_w‹kî
(
w‹k_°ru˘
 *
ws
)

1708 
ˇche
 *ˇchê
	`c⁄èöî_of
(
ws
, ˇche, 
w‹kî
);

1711 i‡(!
	`is_quõscög
(
ˇche
)) {

1712 
	`wrôeback_some_dúty_blocks
(
ˇche
);

1713 
	`¥o˚ss_de„ºed_wrôëhrough_bios
(
ˇche
);

1714 
	`¥o˚ss_de„ºed_bios
(
ˇche
);

1715 
	`¥o˚ss_övÆid©i⁄_ªque°s
(
ˇche
);

1718 
	`¥o˚ss_migøti⁄s
(
ˇche
, &ˇche->
quõs˚d_migøti⁄s
, 
issue_c›y
);

1719 
	`¥o˚ss_migøti⁄s
(
ˇche
, &ˇche->
com∂ëed_migøti⁄s
, 
com∂ëe_migøti⁄
);

1721 i‡(
	`commô_if_√eded
(
ˇche
)) {

1722 
	`¥o˚ss_de„ºed_Êush_bios
(
ˇche
, 
Ál£
);

1723 
	`¥o˚ss_migøti⁄s
(
ˇche
, &ˇche->
√ed_commô_migøti⁄s
, 
migøti⁄_Áûuª
);

1730 
	`¥o˚ss_de„ºed_Êush_bios
(
ˇche
, 
åue
);

1731 
	`¥o˚ss_migøti⁄s
(
ˇche
, &ˇche->
√ed_commô_migøti⁄s
,

1732 
migøti⁄_suc˚ss_po°_commô
);

1735 
	`ack_quõscög
(
ˇche
);

1737 } 
	`m‹e_w‹k
(
ˇche
));

1738 
	}
}

1744 
	$do_wakî
(
w‹k_°ru˘
 *
ws
)

1746 
ˇche
 *ˇchê
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
ws
), ˇche, 
wakî
);

1747 
	`pﬁicy_tick
(
ˇche
->
pﬁicy
);

1748 
	`wake_w‹kî
(
ˇche
);

1749 
	`queue_dñayed_w‹k
(
ˇche
->
wq
, &ˇche->
wakî
, 
COMMIT_PERIOD
);

1750 
	}
}

1754 
	$is_c⁄ge°ed
(
dm_dev
 *
dev
, 
bdi_bôs
)

1756 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1757  
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bdi_bôs
);

1758 
	}
}

1760 
	$ˇche_is_c⁄ge°ed
(
dm_èrgë_ˇŒbacks
 *
cb
, 
bdi_bôs
)

1762 
ˇche
 *ˇchê
	`c⁄èöî_of
(
cb
, ˇche, 
ˇŒbacks
);

1764  
	`is_c⁄ge°ed
(
ˇche
->
‹igö_dev
, 
bdi_bôs
) ||

1765 
	`is_c⁄ge°ed
(
ˇche
->
ˇche_dev
, 
bdi_bôs
);

1766 
	}
}

1776 
	$de°roy
(
ˇche
 *cache)

1778 
i
;

1780 i‡(
ˇche
->
√xt_migøti⁄
)

1781 
	`mempoﬁ_‰ì
(
ˇche
->
√xt_migøti⁄
, cache->
migøti⁄_poﬁ
);

1783 i‡(
ˇche
->
migøti⁄_poﬁ
)

1784 
	`mempoﬁ_de°roy
(
ˇche
->
migøti⁄_poﬁ
);

1786 i‡(
ˇche
->
Æl_io_ds
)

1787 
	`dm_de„ºed_£t_de°roy
(
ˇche
->
Æl_io_ds
);

1789 i‡(
ˇche
->
¥is⁄
)

1790 
	`dm_bio_¥is⁄_de°roy
(
ˇche
->
¥is⁄
);

1792 i‡(
ˇche
->
wq
)

1793 
	`de°roy_w‹kqueue
(
ˇche
->
wq
);

1795 i‡(
ˇche
->
dúty_bô£t
)

1796 
	`‰ì_bô£t
(
ˇche
->
dúty_bô£t
);

1798 i‡(
ˇche
->
disˇrd_bô£t
)

1799 
	`‰ì_bô£t
(
ˇche
->
disˇrd_bô£t
);

1801 i‡(
ˇche
->
c›õr
)

1802 
	`dm_kc›yd_˛õ¡_de°roy
(
ˇche
->
c›õr
);

1804 i‡(
ˇche
->
cmd
)

1805 
	`dm_ˇche_mëad©a_˛o£
(
ˇche
->
cmd
);

1807 i‡(
ˇche
->
mëad©a_dev
)

1808 
	`dm_put_devi˚
(
ˇche
->
ti
, cache->
mëad©a_dev
);

1810 i‡(
ˇche
->
‹igö_dev
)

1811 
	`dm_put_devi˚
(
ˇche
->
ti
, cache->
‹igö_dev
);

1813 i‡(
ˇche
->
ˇche_dev
)

1814 
	`dm_put_devi˚
(
ˇche
->
ti
, cache->
ˇche_dev
);

1816 i‡(
ˇche
->
pﬁicy
)

1817 
	`dm_ˇche_pﬁicy_de°roy
(
ˇche
->
pﬁicy
);

1819 
i
 = 0; i < 
ˇche
->
ƒ_˘r_¨gs
 ; i++)

1820 
	`k‰ì
(
ˇche
->
˘r_¨gs
[
i
]);

1821 
	`k‰ì
(
ˇche
->
˘r_¨gs
);

1823 
	`k‰ì
(
ˇche
);

1824 
	}
}

1826 
	$ˇche_då
(
dm_èrgë
 *
ti
)

1828 
ˇche
 *ˇchê
ti
->
¥iv©e
;

1830 
	`de°roy
(
ˇche
);

1831 
	}
}

1833 
£˘‹_t
 
	$gë_dev_size
(
dm_dev
 *
dev
)

1835  
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

1836 
	}
}

1869 
	sˇche_¨gs
 {

1870 
dm_èrgë
 *
	mti
;

1872 
dm_dev
 *
	mmëad©a_dev
;

1874 
dm_dev
 *
	mˇche_dev
;

1875 
£˘‹_t
 
	mˇche_£˘‹s
;

1877 
dm_dev
 *
	m‹igö_dev
;

1878 
£˘‹_t
 
	m‹igö_£˘‹s
;

1880 
uöt32_t
 
	mblock_size
;

1882 c⁄° *
	mpﬁicy_«me
;

1883 
	mpﬁicy_¨gc
;

1884 c⁄° **
	mpﬁicy_¨gv
;

1886 
ˇche_„©uªs
 
	m„©uªs
;

1889 
	$de°roy_ˇche_¨gs
(
ˇche_¨gs
 *
ˇ
)

1891 i‡(
ˇ
->
mëad©a_dev
)

1892 
	`dm_put_devi˚
(
ˇ
->
ti
, ca->
mëad©a_dev
);

1894 i‡(
ˇ
->
ˇche_dev
)

1895 
	`dm_put_devi˚
(
ˇ
->
ti
, ca->
ˇche_dev
);

1897 i‡(
ˇ
->
‹igö_dev
)

1898 
	`dm_put_devi˚
(
ˇ
->
ti
, ca->
‹igö_dev
);

1900 
	`k‰ì
(
ˇ
);

1901 
	}
}

1903 
boﬁ
 
	$©_Àa°_⁄e_¨g
(
dm_¨g_£t
 *
as
, **
îr‹
)

1905 i‡(!
as
->
¨gc
) {

1906 *
îr‹
 = "Insufficientárgs";

1907  
Ál£
;

1910  
åue
;

1911 
	}
}

1913 
	$∑r£_mëad©a_dev
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

1914 **
îr‹
)

1916 
r
;

1917 
£˘‹_t
 
mëad©a_dev_size
;

1918 
b
[
BDEVNAME_SIZE
];

1920 i‡(!
	`©_Àa°_⁄e_¨g
(
as
, 
îr‹
))

1921  -
EINVAL
;

1923 
r
 = 
	`dm_gë_devi˚
(
ˇ
->
ti
, 
	`dm_shi·_¨g
(
as
), 
FMODE_READ
 | 
FMODE_WRITE
,

1924 &
ˇ
->
mëad©a_dev
);

1925 i‡(
r
) {

1926 *
îr‹
 = "Error opening metadata device";

1927  
r
;

1930 
mëad©a_dev_size
 = 
	`gë_dev_size
(
ˇ
->
mëad©a_dev
);

1931 i‡(
mëad©a_dev_size
 > 
DM_CACHE_METADATA_MAX_SECTORS_WARNING
)

1932 
	`DMWARN
("Metadata device %s isÜargerÅhan %u sectors:Éxcess space willÇot be used.",

1933 
	`bdev«me
(
ˇ
->
mëad©a_dev
->
bdev
, 
b
), 
THIN_METADATA_MAX_SECTORS
);

1936 
	}
}

1938 
	$∑r£_ˇche_dev
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

1939 **
îr‹
)

1941 
r
;

1943 i‡(!
	`©_Àa°_⁄e_¨g
(
as
, 
îr‹
))

1944  -
EINVAL
;

1946 
r
 = 
	`dm_gë_devi˚
(
ˇ
->
ti
, 
	`dm_shi·_¨g
(
as
), 
FMODE_READ
 | 
FMODE_WRITE
,

1947 &
ˇ
->
ˇche_dev
);

1948 i‡(
r
) {

1949 *
îr‹
 = "Error opening cache device";

1950  
r
;

1952 
ˇ
->
ˇche_£˘‹s
 = 
	`gë_dev_size
(ˇ->
ˇche_dev
);

1955 
	}
}

1957 
	$∑r£_‹igö_dev
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

1958 **
îr‹
)

1960 
r
;

1962 i‡(!
	`©_Àa°_⁄e_¨g
(
as
, 
îr‹
))

1963  -
EINVAL
;

1965 
r
 = 
	`dm_gë_devi˚
(
ˇ
->
ti
, 
	`dm_shi·_¨g
(
as
), 
FMODE_READ
 | 
FMODE_WRITE
,

1966 &
ˇ
->
‹igö_dev
);

1967 i‡(
r
) {

1968 *
îr‹
 = "Error opening origin device";

1969  
r
;

1972 
ˇ
->
‹igö_£˘‹s
 = 
	`gë_dev_size
(ˇ->
‹igö_dev
);

1973 i‡(
ˇ
->
ti
->
Àn
 > ca->
‹igö_£˘‹s
) {

1974 *
îr‹
 = "Device sizeÜargerÅhan cached device";

1975  -
EINVAL
;

1979 
	}
}

1981 
	$∑r£_block_size
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

1982 **
îr‹
)

1984 
block_size
;

1986 i‡(!
	`©_Àa°_⁄e_¨g
(
as
, 
îr‹
))

1987  -
EINVAL
;

1989 i‡(
	`k°πoul
(
	`dm_shi·_¨g
(
as
), 10, &
block_size
) || !block_size ||

1990 
block_size
 < 
DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 ||

1991 
block_size
 > 
DATA_DEV_BLOCK_SIZE_MAX_SECTORS
 ||

1992 
block_size
 & (
DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 - 1)) {

1993 *
îr‹
 = "Invalid data block size";

1994  -
EINVAL
;

1997 i‡(
block_size
 > 
ˇ
->
ˇche_£˘‹s
) {

1998 *
îr‹
 = "Data block size isÜargerÅhanÅhe cache device";

1999  -
EINVAL
;

2002 
ˇ
->
block_size
 = block_size;

2005 
	}
}

2007 
	$öô_„©uªs
(
ˇche_„©uªs
 *
cf
)

2009 
cf
->
mode
 = 
CM_WRITE
;

2010 
cf
->
io_mode
 = 
CM_IO_WRITEBACK
;

2011 
	}
}

2013 
	$∑r£_„©uªs
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

2014 **
îr‹
)

2016 
dm_¨g
 
_¨gs
[] = {

2020 
r
;

2021 
¨gc
;

2022 c⁄° *
¨g
;

2023 
ˇche_„©uªs
 *
cf
 = &
ˇ
->
„©uªs
;

2025 
	`öô_„©uªs
(
cf
);

2027 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
¨gc
, 
îr‹
);

2028 i‡(
r
)

2029  -
EINVAL
;

2031 
¨gc
--) {

2032 
¨g
 = 
	`dm_shi·_¨g
(
as
);

2034 i‡(!
	`°rˇ£cmp
(
¨g
, "writeback"))

2035 
cf
->
io_mode
 = 
CM_IO_WRITEBACK
;

2037 i‡(!
	`°rˇ£cmp
(
¨g
, "writethrough"))

2038 
cf
->
io_mode
 = 
CM_IO_WRITETHROUGH
;

2040 i‡(!
	`°rˇ£cmp
(
¨g
, "passthrough"))

2041 
cf
->
io_mode
 = 
CM_IO_PASSTHROUGH
;

2044 *
îr‹
 = "Unrecognised cache featureÑequested";

2045  -
EINVAL
;

2050 
	}
}

2052 
	$∑r£_pﬁicy
(
ˇche_¨gs
 *
ˇ
, 
dm_¨g_£t
 *
as
,

2053 **
îr‹
)

2055 
dm_¨g
 
_¨gs
[] = {

2059 
r
;

2061 i‡(!
	`©_Àa°_⁄e_¨g
(
as
, 
îr‹
))

2062  -
EINVAL
;

2064 
ˇ
->
pﬁicy_«me
 = 
	`dm_shi·_¨g
(
as
);

2066 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
ˇ
->
pﬁicy_¨gc
, 
îr‹
);

2067 i‡(
r
)

2068  -
EINVAL
;

2070 
ˇ
->
pﬁicy_¨gv
 = (c⁄° **)
as
->
¨gv
;

2071 
	`dm_c⁄sume_¨gs
(
as
, 
ˇ
->
pﬁicy_¨gc
);

2074 
	}
}

2076 
	$∑r£_ˇche_¨gs
(
ˇche_¨gs
 *
ˇ
, 
¨gc
, **
¨gv
,

2077 **
îr‹
)

2079 
r
;

2080 
dm_¨g_£t
 
as
;

2082 
as
.
¨gc
 =árgc;

2083 
as
.
¨gv
 =árgv;

2085 
r
 = 
	`∑r£_mëad©a_dev
(
ˇ
, &
as
, 
îr‹
);

2086 i‡(
r
)

2087  
r
;

2089 
r
 = 
	`∑r£_ˇche_dev
(
ˇ
, &
as
, 
îr‹
);

2090 i‡(
r
)

2091  
r
;

2093 
r
 = 
	`∑r£_‹igö_dev
(
ˇ
, &
as
, 
îr‹
);

2094 i‡(
r
)

2095  
r
;

2097 
r
 = 
	`∑r£_block_size
(
ˇ
, &
as
, 
îr‹
);

2098 i‡(
r
)

2099  
r
;

2101 
r
 = 
	`∑r£_„©uªs
(
ˇ
, &
as
, 
îr‹
);

2102 i‡(
r
)

2103  
r
;

2105 
r
 = 
	`∑r£_pﬁicy
(
ˇ
, &
as
, 
îr‹
);

2106 i‡(
r
)

2107  
r
;

2110 
	}
}

2114 
kmem_ˇche
 *
	gmigøti⁄_ˇche
;

2116 
	#NOT_CORE_OPTION
 1

	)

2118 
	$¥o˚ss_c⁄fig_›ti⁄
(
ˇche
 *ˇche, c⁄° *
key
, c⁄° *
vÆue
)

2120 
tmp
;

2122 i‡(!
	`°rˇ£cmp
(
key
, "migration_threshold")) {

2123 i‡(
	`k°πoul
(
vÆue
, 10, &
tmp
))

2124  -
EINVAL
;

2126 
ˇche
->
migøti⁄_thªshﬁd
 = 
tmp
;

2130  
NOT_CORE_OPTION
;

2131 
	}
}

2133 
	$£t_c⁄fig_vÆue
(
ˇche
 *ˇche, c⁄° *
key
, c⁄° *
vÆue
)

2135 
r
 = 
	`¥o˚ss_c⁄fig_›ti⁄
(
ˇche
, 
key
, 
vÆue
);

2137 i‡(
r
 =
NOT_CORE_OPTION
)

2138 
r
 = 
	`pﬁicy_£t_c⁄fig_vÆue
(
ˇche
->
pﬁicy
, 
key
, 
vÆue
);

2140 i‡(
r
)

2141 
	`DMWARN
("bad c⁄fig vÆuêf‹ %s: %s", 
key
, 
vÆue
);

2143  
r
;

2144 
	}
}

2146 
	$£t_c⁄fig_vÆues
(
ˇche
 *ˇche, 
¨gc
, c⁄° **
¨gv
)

2148 
r
 = 0;

2150 i‡(
¨gc
 & 1) {

2151 
	`DMWARN
("OddÇumber ofÖolicyárguments given butÅhey should be <key> <value>Öairs.");

2152  -
EINVAL
;

2155 
¨gc
) {

2156 
r
 = 
	`£t_c⁄fig_vÆue
(
ˇche
, 
¨gv
[0],árgv[1]);

2157 i‡(
r
)

2160 
¨gc
 -= 2;

2161 
¨gv
 += 2;

2164  
r
;

2165 
	}
}

2167 
	$¸óã_ˇche_pﬁicy
(
ˇche
 *ˇche, 
ˇche_¨gs
 *
ˇ
,

2168 **
îr‹
)

2170 
dm_ˇche_pﬁicy
 *
p
 = 
	`dm_ˇche_pﬁicy_¸óã
(
ˇ
->
pﬁicy_«me
,

2171 
ˇche
->
ˇche_size
,

2172 
ˇche
->
‹igö_£˘‹s
,

2173 
ˇche
->
£˘‹s_≥r_block
);

2174 i‡(
	`IS_ERR
(
p
)) {

2175 *
îr‹
 = "Error creating cache'sÖolicy";

2176  
	`PTR_ERR
(
p
);

2178 
ˇche
->
pﬁicy
 = 
p
;

2181 
	}
}

2183 
	#DEFAULT_MIGRATION_THRESHOLD
 2048

	)

2185 
	$ˇche_¸óã
(
ˇche_¨gs
 *
ˇ
, 
ˇche
 **
ªsu…
)

2187 
r
 = 0;

2188 **
îr‹
 = &
ˇ
->
ti
->error;

2189 
ˇche
 *cache;

2190 
dm_èrgë
 *
ti
 = 
ˇ
->ti;

2191 
dm_block_t
 
‹igö_blocks
;

2192 
dm_ˇche_mëad©a
 *
cmd
;

2193 
boﬁ
 
may_f‹m©
 = 
ˇ
->
„©uªs
.
mode
 =
CM_WRITE
;

2195 
ˇche
 = 
	`kzÆloc
((*ˇche), 
GFP_KERNEL
);

2196 i‡(!
ˇche
)

2197  -
ENOMEM
;

2199 
ˇche
->
ti
 = 
ˇ
->ti;

2200 
ti
->
¥iv©e
 = 
ˇche
;

2201 
ti
->
num_Êush_bios
 = 2;

2202 
ti
->
Êush_suµ‹ãd
 = 
åue
;

2204 
ti
->
num_disˇrd_bios
 = 1;

2205 
ti
->
disˇrds_suµ‹ãd
 = 
åue
;

2206 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

2208 
ti
->
•lô_disˇrd_bios
 = 
åue
;

2210 
ˇche
->
„©uªs
 = 
ˇ
->features;

2211 
ti
->
≥r_bio_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

2213 
ˇche
->
ˇŒbacks
.
c⁄ge°ed_‚
 = 
ˇche_is_c⁄ge°ed
;

2214 
	`dm_èbÀ_add_èrgë_ˇŒbacks
(
ti
->
èbÀ
, &
ˇche
->
ˇŒbacks
);

2216 
ˇche
->
mëad©a_dev
 = 
ˇ
->metadata_dev;

2217 
ˇche
->
‹igö_dev
 = 
ˇ
->origin_dev;

2218 
ˇche
->
ˇche_dev
 = 
ˇ
->cache_dev;

2220 
ˇ
->
mëad©a_dev
 = ca->
‹igö_dev
 = ca->
ˇche_dev
 = 
NULL
;

2223 
‹igö_blocks
 = 
ˇche
->
‹igö_£˘‹s
 = 
ˇ
->origin_sectors;

2224 
‹igö_blocks
 = 
	`block_div
(‹igö_blocks, 
ˇ
->
block_size
);

2225 
ˇche
->
‹igö_blocks
 = 
	`to_oblock
(origin_blocks);

2227 
ˇche
->
£˘‹s_≥r_block
 = 
ˇ
->
block_size
;

2228 i‡(
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
ˇche
->
£˘‹s_≥r_block
)) {

2229 
r
 = -
EINVAL
;

2230 
bad
;

2233 i‡(
ˇ
->
block_size
 & (ca->block_size - 1)) {

2234 
dm_block_t
 
ˇche_size
 = 
ˇ
->
ˇche_£˘‹s
;

2236 
ˇche
->
£˘‹s_≥r_block_shi·
 = -1;

2237 
ˇche_size
 = 
	`block_div
(ˇche_size, 
ˇ
->
block_size
);

2238 
ˇche
->
ˇche_size
 = 
	`to_cblock
(cache_size);

2240 
ˇche
->
£˘‹s_≥r_block_shi·
 = 
	`__ffs
(
ˇ
->
block_size
);

2241 
ˇche
->
ˇche_size
 = 
	`to_cblock
(
ˇ
->
ˇche_£˘‹s
 >> cache->
£˘‹s_≥r_block_shi·
);

2244 
r
 = 
	`¸óã_ˇche_pﬁicy
(
ˇche
, 
ˇ
, 
îr‹
);

2245 i‡(
r
)

2246 
bad
;

2248 
ˇche
->
pﬁicy_ƒ_¨gs
 = 
ˇ
->
pﬁicy_¨gc
;

2249 
ˇche
->
migøti⁄_thªshﬁd
 = 
DEFAULT_MIGRATION_THRESHOLD
;

2251 
r
 = 
	`£t_c⁄fig_vÆues
(
ˇche
, 
ˇ
->
pﬁicy_¨gc
, ca->
pﬁicy_¨gv
);

2252 i‡(
r
) {

2253 *
îr‹
 = "Error setting cacheÖolicy's config values";

2254 
bad
;

2257 
cmd
 = 
	`dm_ˇche_mëad©a_›í
(
ˇche
->
mëad©a_dev
->
bdev
,

2258 
ˇ
->
block_size
, 
may_f‹m©
,

2259 
	`dm_ˇche_pﬁicy_gë_höt_size
(
ˇche
->
pﬁicy
));

2260 i‡(
	`IS_ERR
(
cmd
)) {

2261 *
îr‹
 = "Error creating metadata object";

2262 
r
 = 
	`PTR_ERR
(
cmd
);

2263 
bad
;

2265 
ˇche
->
cmd
 = cmd;

2267 i‡(
	`∑s°hrough_mode
(&
ˇche
->
„©uªs
)) {

2268 
boﬁ
 
Æl_˛ón
;

2270 
r
 = 
	`dm_ˇche_mëad©a_Æl_˛ón
(
ˇche
->
cmd
, &
Æl_˛ón
);

2271 i‡(
r
) {

2272 *
îr‹
 = "dm_cache_metadata_all_clean() failed";

2273 
bad
;

2276 i‡(!
Æl_˛ón
) {

2277 *
îr‹
 = "CannotÉnterÖassthrough mode unlessáll blocksáre clean";

2278 
r
 = -
EINVAL
;

2279 
bad
;

2283 
	`•ö_lock_öô
(&
ˇche
->
lock
);

2284 
	`bio_li°_öô
(&
ˇche
->
de„ºed_bios
);

2285 
	`bio_li°_öô
(&
ˇche
->
de„ºed_Êush_bios
);

2286 
	`bio_li°_öô
(&
ˇche
->
de„ºed_wrôëhrough_bios
);

2287 
	`INIT_LIST_HEAD
(&
ˇche
->
quõs˚d_migøti⁄s
);

2288 
	`INIT_LIST_HEAD
(&
ˇche
->
com∂ëed_migøti⁄s
);

2289 
	`INIT_LIST_HEAD
(&
ˇche
->
√ed_commô_migøti⁄s
);

2290 
	`©omic_£t
(&
ˇche
->
ƒ_migøti⁄s
, 0);

2291 
	`öô_waôqueue_hód
(&
ˇche
->
migøti⁄_waô
);

2293 
	`öô_waôqueue_hód
(&
ˇche
->
quõscög_waô
);

2294 
	`©omic_£t
(&
ˇche
->
quõscög
, 0);

2295 
	`©omic_£t
(&
ˇche
->
quõscög_ack
, 0);

2297 
r
 = -
ENOMEM
;

2298 
	`©omic_£t
(&
ˇche
->
ƒ_dúty
, 0);

2299 
ˇche
->
dúty_bô£t
 = 
	`Æloc_bô£t
(
	`‰om_cblock
(ˇche->
ˇche_size
));

2300 i‡(!
ˇche
->
dúty_bô£t
) {

2301 *
îr‹
 = "couldÇotállocate dirty bitset";

2302 
bad
;

2304 
	`˛ór_bô£t
(
ˇche
->
dúty_bô£t
, 
	`‰om_cblock
(ˇche->
ˇche_size
));

2306 
ˇche
->
disˇrd_ƒ_blocks
 = cache->
‹igö_blocks
;

2307 
ˇche
->
disˇrd_bô£t
 = 
	`Æloc_bô£t
(
	`‰om_oblock
(ˇche->
disˇrd_ƒ_blocks
));

2308 i‡(!
ˇche
->
disˇrd_bô£t
) {

2309 *
îr‹
 = "couldÇotállocate discard bitset";

2310 
bad
;

2312 
	`˛ór_bô£t
(
ˇche
->
disˇrd_bô£t
, 
	`‰om_oblock
(ˇche->
disˇrd_ƒ_blocks
));

2314 
ˇche
->
c›õr
 = 
	`dm_kc›yd_˛õ¡_¸óã
(&
dm_kc›yd_thrŸée
);

2315 i‡(
	`IS_ERR
(
ˇche
->
c›õr
)) {

2316 *
îr‹
 = "couldÇot create kcopyd client";

2317 
r
 = 
	`PTR_ERR
(
ˇche
->
c›õr
);

2318 
bad
;

2321 
ˇche
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("dm-" 
DM_MSG_PREFIX
, 
WQ_MEM_RECLAIM
);

2322 i‡(!
ˇche
->
wq
) {

2323 *
îr‹
 = "couldÇot create workqueue for metadata object";

2324 
bad
;

2326 
	`INIT_WORK
(&
ˇche
->
w‹kî
, 
do_w‹kî
);

2327 
	`INIT_DELAYED_WORK
(&
ˇche
->
wakî
, 
do_wakî
);

2328 
ˇche
->
œ°_commô_jiffõs
 = 
jiffõs
;

2330 
ˇche
->
¥is⁄
 = 
	`dm_bio_¥is⁄_¸óã
(
PRISON_CELLS
);

2331 i‡(!
ˇche
->
¥is⁄
) {

2332 *
îr‹
 = "couldÇot create bioÖrison";

2333 
bad
;

2336 
ˇche
->
Æl_io_ds
 = 
	`dm_de„ºed_£t_¸óã
();

2337 i‡(!
ˇche
->
Æl_io_ds
) {

2338 *
îr‹
 = "couldÇot createáll_io deferred set";

2339 
bad
;

2342 
ˇche
->
migøti⁄_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
MIGRATION_POOL_SIZE
,

2343 
migøti⁄_ˇche
);

2344 i‡(!
ˇche
->
migøti⁄_poﬁ
) {

2345 *
îr‹
 = "Error creating cache's migration mempool";

2346 
bad
;

2349 
ˇche
->
√xt_migøti⁄
 = 
NULL
;

2351 
ˇche
->
√ed_tick_bio
 = 
åue
;

2352 
ˇche
->
sized
 = 
Ál£
;

2353 
ˇche
->
övÆid©e
 = 
Ál£
;

2354 
ˇche
->
commô_ªque°ed
 = 
Ál£
;

2355 
ˇche
->
lﬂded_m≠pögs
 = 
Ál£
;

2356 
ˇche
->
lﬂded_disˇrds
 = 
Ál£
;

2358 
	`lﬂd_°©s
(
ˇche
);

2360 
	`©omic_£t
(&
ˇche
->
°©s
.
demŸi⁄
, 0);

2361 
	`©omic_£t
(&
ˇche
->
°©s
.
¥omŸi⁄
, 0);

2362 
	`©omic_£t
(&
ˇche
->
°©s
.
c›õs_avoided
, 0);

2363 
	`©omic_£t
(&
ˇche
->
°©s
.
ˇche_˚Œ_˛ash
, 0);

2364 
	`©omic_£t
(&
ˇche
->
°©s
.
commô_cou¡
, 0);

2365 
	`©omic_£t
(&
ˇche
->
°©s
.
disˇrd_cou¡
, 0);

2367 
	`•ö_lock_öô
(&
ˇche
->
övÆid©i⁄_lock
);

2368 
	`INIT_LIST_HEAD
(&
ˇche
->
övÆid©i⁄_ªque°s
);

2370 *
ªsu…
 = 
ˇche
;

2373 
bad
:

2374 
	`de°roy
(
ˇche
);

2375  
r
;

2376 
	}
}

2378 
	$c›y_˘r_¨gs
(
ˇche
 *ˇche, 
¨gc
, c⁄° **
¨gv
)

2380 
i
;

2381 c⁄° **
c›y
;

2383 
c›y
 = 
	`kˇŒoc
(
¨gc
, (*c›y), 
GFP_KERNEL
);

2384 i‡(!
c›y
)

2385  -
ENOMEM
;

2386 
i
 = 0; i < 
¨gc
; i++) {

2387 
c›y
[
i
] = 
	`k°rdup
(
¨gv
[i], 
GFP_KERNEL
);

2388 i‡(!
c›y
[
i
]) {

2389 
i
--)

2390 
	`k‰ì
(
c›y
[
i
]);

2391 
	`k‰ì
(
c›y
);

2392  -
ENOMEM
;

2396 
ˇche
->
ƒ_˘r_¨gs
 = 
¨gc
;

2397 
ˇche
->
˘r_¨gs
 = 
c›y
;

2400 
	}
}

2402 
	$ˇche_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

2404 
r
 = -
EINVAL
;

2405 
ˇche_¨gs
 *
ˇ
;

2406 
ˇche
 *ˇchê
NULL
;

2408 
ˇ
 = 
	`kzÆloc
((*ˇ), 
GFP_KERNEL
);

2409 i‡(!
ˇ
) {

2410 
ti
->
îr‹
 = "Errorállocating memory for cache";

2411  -
ENOMEM
;

2413 
ˇ
->
ti
 =Åi;

2415 
r
 = 
	`∑r£_ˇche_¨gs
(
ˇ
, 
¨gc
, 
¨gv
, &
ti
->
îr‹
);

2416 i‡(
r
)

2417 
out
;

2419 
r
 = 
	`ˇche_¸óã
(
ˇ
, &
ˇche
);

2420 i‡(
r
)

2421 
out
;

2423 
r
 = 
	`c›y_˘r_¨gs
(
ˇche
, 
¨gc
 - 3, (c⁄° **)
¨gv
 + 3);

2424 i‡(
r
) {

2425 
	`de°roy
(
ˇche
);

2426 
out
;

2429 
ti
->
¥iv©e
 = 
ˇche
;

2431 
out
:

2432 
	`de°roy_ˇche_¨gs
(
ˇ
);

2433  
r
;

2434 
	}
}

2436 
	$__ˇche_m≠
(
ˇche
 *ˇche, 
bio
 *bio, 
dm_bio_¥is⁄_˚Œ
 **
˚Œ
)

2438 
r
;

2439 
dm_oblock_t
 
block
 = 
	`gë_bio_block
(
ˇche
, 
bio
);

2440 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

2441 
boﬁ
 
ˇn_migøã
 = 
Ál£
;

2442 
boﬁ
 
disˇrded_block
;

2443 
pﬁicy_ªsu…
 
lookup_ªsu…
;

2444 
≥r_bio_d©a
 *
pb
 = 
	`öô_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

2446 i‡(
	`u∆ikñy
(
	`‰om_oblock
(
block
Ë>‰om_oblock(
ˇche
->
‹igö_blocks
))) {

2452 
	`ªm≠_to_‹igö
(
ˇche
, 
bio
);

2453  
DM_MAPIO_REMAPPED
;

2456 i‡(
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_FUA
 | 
REQ_DISCARD
)) {

2457 
	`de„r_bio
(
ˇche
, 
bio
);

2458  
DM_MAPIO_SUBMITTED
;

2464 *
˚Œ
 = 
	`Æloc_¥is⁄_˚Œ
(
ˇche
);

2465 i‡(!*
˚Œ
) {

2466 
	`de„r_bio
(
ˇche
, 
bio
);

2467  
DM_MAPIO_SUBMITTED
;

2470 
r
 = 
	`bio_dëaö
(
ˇche
, 
block
, 
bio
, *
˚Œ
,

2471 (
˚Œ_‰ì_‚
Ë
‰ì_¥is⁄_˚Œ
,

2472 
ˇche
, 
˚Œ
);

2473 i‡(
r
) {

2474 i‡(
r
 < 0)

2475 
	`de„r_bio
(
ˇche
, 
bio
);

2477  
DM_MAPIO_SUBMITTED
;

2480 
disˇrded_block
 = 
	`is_disˇrded_oblock
(
ˇche
, 
block
);

2482 
r
 = 
	`pﬁicy_m≠
(
ˇche
->
pﬁicy
, 
block
, 
Ál£
, 
ˇn_migøã
, 
disˇrded_block
,

2483 
bio
, &
lookup_ªsu…
);

2484 i‡(
r
 =-
EWOULDBLOCK
) {

2485 
	`˚Œ_de„r
(
ˇche
, *
˚Œ
, 
åue
);

2486  
DM_MAPIO_SUBMITTED
;

2488 } i‡(
r
) {

2489 
	`DMERR_LIMIT
("U√x≥˘edÑëu∫ from cachêª∂a˚míàpﬁicy: %d", 
r
);

2490 
	`˚Œ_de„r
(
ˇche
, *
˚Œ
, 
Ál£
);

2491 
	`bio_io_îr‹
(
bio
);

2492  
DM_MAPIO_SUBMITTED
;

2495 
r
 = 
DM_MAPIO_REMAPPED
;

2496 
lookup_ªsu…
.
›
) {

2497 
POLICY_HIT
:

2498 i‡(
	`∑s°hrough_mode
(&
ˇche
->
„©uªs
)) {

2499 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

2504 
	`˚Œ_de„r
(
ˇche
, *
˚Œ
, 
åue
);

2505 
r
 = 
DM_MAPIO_SUBMITTED
;

2508 
	`öc_miss_cou¡î
(
ˇche
, 
bio
);

2509 
	`ªm≠_to_‹igö_˛ór_disˇrd
(
ˇche
, 
bio
, 
block
);

2513 
	`öc_hô_cou¡î
(
ˇche
, 
bio
);

2514 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
 && 
	`wrôëhrough_mode
(&
ˇche
->
„©uªs
) &&

2515 !
	`is_dúty
(
ˇche
, 
lookup_ªsu…
.
cblock
))

2516 
	`ªm≠_to_‹igö_thí_ˇche
(
ˇche
, 
bio
, 
block
, 
lookup_ªsu…
.
cblock
);

2518 
	`ªm≠_to_ˇche_dúty
(
ˇche
, 
bio
, 
block
, 
lookup_ªsu…
.
cblock
);

2522 
POLICY_MISS
:

2523 
	`öc_miss_cou¡î
(
ˇche
, 
bio
);

2524 i‡(
pb
->
ªq_ƒ
 != 0) {

2529 
	`bio_ídio
(
bio
, 0);

2530 
	`˚Œ_de„r
(
ˇche
, *
˚Œ
, 
Ál£
);

2531 
r
 = 
DM_MAPIO_SUBMITTED
;

2534 
	`ªm≠_to_‹igö_˛ór_disˇrd
(
ˇche
, 
bio
, 
block
);

2539 
	`DMERR_LIMIT
("%s:Éº‹ög bio: unknow¿pﬁicy op: %u", 
__func__
,

2540 (Ë
lookup_ªsu…
.
›
);

2541 
	`˚Œ_de„r
(
ˇche
, *
˚Œ
, 
Ál£
);

2542 
	`bio_io_îr‹
(
bio
);

2543 
r
 = 
DM_MAPIO_SUBMITTED
;

2546  
r
;

2547 
	}
}

2549 
	$ˇche_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

2551 
r
;

2552 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
;

2553 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2555 
r
 = 
	`__ˇche_m≠
(
ˇche
, 
bio
, &
˚Œ
);

2556 i‡(
r
 =
DM_MAPIO_REMAPPED
) {

2557 
	`öc_ds
(
ˇche
, 
bio
, 
˚Œ
);

2558 
	`˚Œ_de„r
(
ˇche
, 
˚Œ
, 
Ál£
);

2561  
r
;

2562 
	}
}

2564 
	$ˇche_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

2566 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2567 
Êags
;

2568 
size_t
 
pb_d©a_size
 = 
	`gë_≥r_bio_d©a_size
(
ˇche
);

2569 
≥r_bio_d©a
 *
pb
 = 
	`gë_≥r_bio_d©a
(
bio
, 
pb_d©a_size
);

2571 i‡(
pb
->
tick
) {

2572 
	`pﬁicy_tick
(
ˇche
->
pﬁicy
);

2574 
	`•ö_lock_úqßve
(&
ˇche
->
lock
, 
Êags
);

2575 
ˇche
->
√ed_tick_bio
 = 
åue
;

2576 
	`•ö_u∆ock_úqª°‹e
(&
ˇche
->
lock
, 
Êags
);

2579 
	`check_f‹_quõs˚d_migøti⁄s
(
ˇche
, 
pb
);

2582 
	}
}

2584 
	$wrôe_dúty_bô£t
(
ˇche
 *cache)

2586 
i
, 
r
;

2588 
i
 = 0; i < 
	`‰om_cblock
(
ˇche
->
ˇche_size
); i++) {

2589 
r
 = 
	`dm_ˇche_£t_dúty
(
ˇche
->
cmd
, 
	`to_cblock
(
i
),

2590 
	`is_dúty
(
ˇche
, 
	`to_cblock
(
i
)));

2591 i‡(
r
)

2592  
r
;

2596 
	}
}

2598 
	$wrôe_disˇrd_bô£t
(
ˇche
 *cache)

2600 
i
, 
r
;

2602 
r
 = 
	`dm_ˇche_disˇrd_bô£t_ªsize
(
ˇche
->
cmd
, cache->
£˘‹s_≥r_block
,

2603 
ˇche
->
‹igö_blocks
);

2604 i‡(
r
) {

2605 
	`DMERR
("couldÇotÑesize on-disk discard bitset");

2606  
r
;

2609 
i
 = 0; i < 
	`‰om_oblock
(
ˇche
->
disˇrd_ƒ_blocks
); i++) {

2610 
r
 = 
	`dm_ˇche_£t_disˇrd
(
ˇche
->
cmd
, 
	`to_oblock
(
i
),

2611 
	`is_disˇrded
(
ˇche
, 
	`to_oblock
(
i
)));

2612 i‡(
r
)

2613  
r
;

2617 
	}
}

2622 
boﬁ
 
	$sync_mëad©a
(
ˇche
 *cache)

2624 
r1
, 
r2
, 
r3
, 
r4
;

2626 
r1
 = 
	`wrôe_dúty_bô£t
(
ˇche
);

2627 i‡(
r1
)

2628 
	`DMERR
("couldÇot write dirty bitset");

2630 
r2
 = 
	`wrôe_disˇrd_bô£t
(
ˇche
);

2631 i‡(
r2
)

2632 
	`DMERR
("couldÇot write discard bitset");

2634 
	`ßve_°©s
(
ˇche
);

2636 
r3
 = 
	`dm_ˇche_wrôe_höts
(
ˇche
->
cmd
, cache->
pﬁicy
);

2637 i‡(
r3
)

2638 
	`DMERR
("couldÇot write hints");

2645 
r4
 = 
	`dm_ˇche_commô
(
ˇche
->
cmd
, !
r1
 && !
r2
 && !
r3
);

2646 i‡(
r4
)

2647 
	`DMERR
("couldÇot write cache metadata. DataÜoss may occur.");

2649  !
r1
 && !
r2
 && !
r3
 && !
r4
;

2650 
	}
}

2652 
	$ˇche_po°su•íd
(
dm_èrgë
 *
ti
)

2654 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2656 
	`°¨t_quõscög
(
ˇche
);

2657 
	`waô_f‹_migøti⁄s
(
ˇche
);

2658 
	`°›_w‹kî
(
ˇche
);

2659 
	`ªqueue_de„ºed_io
(
ˇche
);

2660 
	`°›_quõscög
(
ˇche
);

2662 (Ë
	`sync_mëad©a
(
ˇche
);

2663 
	}
}

2665 
	$lﬂd_m≠pög
(*
c⁄ãxt
, 
dm_oblock_t
 
oblock
, 
dm_cblock_t
 
cblock
,

2666 
boﬁ
 
dúty
, 
uöt32_t
 
höt
, boﬁ 
höt_vÆid
)

2668 
r
;

2669 
ˇche
 *ˇchê
c⁄ãxt
;

2671 
r
 = 
	`pﬁicy_lﬂd_m≠pög
(
ˇche
->
pﬁicy
, 
oblock
, 
cblock
, 
höt
, 
höt_vÆid
);

2672 i‡(
r
)

2673  
r
;

2675 i‡(
dúty
)

2676 
	`£t_dúty
(
ˇche
, 
oblock
, 
cblock
);

2678 
	`˛ór_dúty
(
ˇche
, 
oblock
, 
cblock
);

2681 
	}
}

2683 
	$lﬂd_disˇrd
(*
c⁄ãxt
, 
£˘‹_t
 
disˇrd_block_size
,

2684 
dm_oblock_t
 
oblock
, 
boﬁ
 
disˇrd
)

2686 
ˇche
 *ˇchê
c⁄ãxt
;

2688 i‡(
disˇrd
)

2689 
	`£t_disˇrd
(
ˇche
, 
oblock
);

2691 
	`˛ór_disˇrd
(
ˇche
, 
oblock
);

2694 
	}
}

2696 
dm_cblock_t
 
	$gë_ˇche_dev_size
(
ˇche
 *cache)

2698 
£˘‹_t
 
size
 = 
	`gë_dev_size
(
ˇche
->
ˇche_dev
);

2699 (Ë
	`£˘‹_div
(
size
, 
ˇche
->
£˘‹s_≥r_block
);

2700  
	`to_cblock
(
size
);

2701 
	}
}

2703 
boﬁ
 
	$ˇn_ªsize
(
ˇche
 *ˇche, 
dm_cblock_t
 
√w_size
)

2705 i‡(
	`‰om_cblock
(
√w_size
Ë> from_cblock(
ˇche
->
ˇche_size
))

2706  
åue
;

2711 
	`‰om_cblock
(
√w_size
Ë< from_cblock(
ˇche
->
ˇche_size
)) {

2712 
√w_size
 = 
	`to_cblock
(
	`‰om_cblock
(new_size) + 1);

2713 i‡(
	`is_dúty
(
ˇche
, 
√w_size
)) {

2714 
	`DMERR
("unableÅo shrink cache; cache block %llu is dirty",

2715 (Ë
	`‰om_cblock
(
√w_size
));

2716  
Ál£
;

2720  
åue
;

2721 
	}
}

2723 
	$ªsize_ˇche_dev
(
ˇche
 *ˇche, 
dm_cblock_t
 
√w_size
)

2725 
r
;

2727 
r
 = 
	`dm_ˇche_ªsize
(
ˇche
->
cmd
, 
√w_size
);

2728 i‡(
r
) {

2729 
	`DMERR
("couldÇotÑesize cache metadata");

2730  
r
;

2733 
ˇche
->
ˇche_size
 = 
√w_size
;

2736 
	}
}

2738 
	$ˇche_¥îesume
(
dm_èrgë
 *
ti
)

2740 
r
 = 0;

2741 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2742 
dm_cblock_t
 
csize
 = 
	`gë_ˇche_dev_size
(
ˇche
);

2747 i‡(!
ˇche
->
sized
) {

2748 
r
 = 
	`ªsize_ˇche_dev
(
ˇche
, 
csize
);

2749 i‡(
r
)

2750  
r
;

2752 
ˇche
->
sized
 = 
åue
;

2754 } i‡(
csize
 !
ˇche
->
ˇche_size
) {

2755 i‡(!
	`ˇn_ªsize
(
ˇche
, 
csize
))

2756  -
EINVAL
;

2758 
r
 = 
	`ªsize_ˇche_dev
(
ˇche
, 
csize
);

2759 i‡(
r
)

2760  
r
;

2763 i‡(!
ˇche
->
lﬂded_m≠pögs
) {

2764 
r
 = 
	`dm_ˇche_lﬂd_m≠pögs
(
ˇche
->
cmd
, cache->
pﬁicy
,

2765 
lﬂd_m≠pög
, 
ˇche
);

2766 i‡(
r
) {

2767 
	`DMERR
("couldÇotÜoad cache mappings");

2768  
r
;

2771 
ˇche
->
lﬂded_m≠pögs
 = 
åue
;

2774 i‡(!
ˇche
->
lﬂded_disˇrds
) {

2775 
r
 = 
	`dm_ˇche_lﬂd_disˇrds
(
ˇche
->
cmd
, 
lﬂd_disˇrd
, cache);

2776 i‡(
r
) {

2777 
	`DMERR
("couldÇotÜoad origin discards");

2778  
r
;

2781 
ˇche
->
lﬂded_disˇrds
 = 
åue
;

2784  
r
;

2785 
	}
}

2787 
	$ˇche_ªsume
(
dm_èrgë
 *
ti
)

2789 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2791 
ˇche
->
√ed_tick_bio
 = 
åue
;

2792 
	`do_wakî
(&
ˇche
->
wakî
.
w‹k
);

2793 
	}
}

2806 
	$ˇche_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

2807 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

2809 
r
 = 0;

2810 
i
;

2811 
ssize_t
 
sz
 = 0;

2812 
dm_block_t
 
ƒ_‰ì_blocks_mëad©a
 = 0;

2813 
dm_block_t
 
ƒ_blocks_mëad©a
 = 0;

2814 
buf
[
BDEVNAME_SIZE
];

2815 
ˇche
 *ˇchê
ti
->
¥iv©e
;

2816 
dm_cblock_t
 
ªsidícy
;

2818 
ty≥
) {

2819 
STATUSTYPE_INFO
:

2821 i‡(!(
°©us_Êags
 & 
DM_STATUS_NOFLUSH_FLAG
Ë&& !
	`dm_su•íded
(
ti
)) {

2822 
r
 = 
	`dm_ˇche_commô
(
ˇche
->
cmd
, 
Ál£
);

2823 i‡(
r
)

2824 
	`DMERR
("couldÇot commit metadata foráccurate status");

2827 
r
 = 
	`dm_ˇche_gë_‰ì_mëad©a_block_cou¡
(
ˇche
->
cmd
,

2828 &
ƒ_‰ì_blocks_mëad©a
);

2829 i‡(
r
) {

2830 
	`DMERR
("couldÇot get metadata free block count");

2831 
îr
;

2834 
r
 = 
	`dm_ˇche_gë_mëad©a_dev_size
(
ˇche
->
cmd
, &
ƒ_blocks_mëad©a
);

2835 i‡(
r
) {

2836 
	`DMERR
("couldÇot get metadata device size");

2837 
îr
;

2840 
ªsidícy
 = 
	`pﬁicy_ªsidícy
(
ˇche
->
pﬁicy
);

2842 
	`DMEMIT
("%u %llu/%llu %u %llu/%llu %u %u %u %u %u %u %lu ",

2843 ()
DM_CACHE_METADATA_BLOCK_SIZE
,

2844 ()(
ƒ_blocks_mëad©a
 - 
ƒ_‰ì_blocks_mëad©a
),

2845 ()
ƒ_blocks_mëad©a
,

2846 
ˇche
->
£˘‹s_≥r_block
,

2847 (Ë
	`‰om_cblock
(
ªsidícy
),

2848 (Ë
	`‰om_cblock
(
ˇche
->
ˇche_size
),

2849 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
ªad_hô
),

2850 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
ªad_miss
),

2851 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
wrôe_hô
),

2852 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
wrôe_miss
),

2853 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
demŸi⁄
),

2854 (Ë
	`©omic_ªad
(&
ˇche
->
°©s
.
¥omŸi⁄
),

2855 (Ë
	`©omic_ªad
(&
ˇche
->
ƒ_dúty
));

2857 i‡(
	`wrôëhrough_mode
(&
ˇche
->
„©uªs
))

2858 
	`DMEMIT
("1 writethrough ");

2860 i‡(
	`∑s°hrough_mode
(&
ˇche
->
„©uªs
))

2861 
	`DMEMIT
("1Öassthrough ");

2863 i‡(
	`wrôeback_mode
(&
ˇche
->
„©uªs
))

2864 
	`DMEMIT
("1 writeback ");

2867 
	`DMERR
("öã∫ÆÉº‹: unknow¿iÿmode: %d", (Ë
ˇche
->
„©uªs
.
io_mode
);

2868 
îr
;

2871 
	`DMEMIT
("2 migøti⁄_thªshﬁd %Œu ", (Ë
ˇche
->
migøti⁄_thªshﬁd
);

2873 
	`DMEMIT
("%†", 
	`dm_ˇche_pﬁicy_gë_«me
(
ˇche
->
pﬁicy
));

2874 i‡(
sz
 < 
maxÀn
) {

2875 
r
 = 
	`pﬁicy_emô_c⁄fig_vÆues
(
ˇche
->
pﬁicy
, 
ªsu…
 + 
sz
, 
maxÀn
 - sz);

2876 i‡(
r
)

2877 
	`DMERR
("pﬁicy_emô_c⁄fig_vÆue†ªtu∫ed %d", 
r
);

2882 
STATUSTYPE_TABLE
:

2883 
	`f‹m©_dev_t
(
buf
, 
ˇche
->
mëad©a_dev
->
bdev
->
bd_dev
);

2884 
	`DMEMIT
("%†", 
buf
);

2885 
	`f‹m©_dev_t
(
buf
, 
ˇche
->
ˇche_dev
->
bdev
->
bd_dev
);

2886 
	`DMEMIT
("%†", 
buf
);

2887 
	`f‹m©_dev_t
(
buf
, 
ˇche
->
‹igö_dev
->
bdev
->
bd_dev
);

2888 
	`DMEMIT
("%s", 
buf
);

2890 
i
 = 0; i < 
ˇche
->
ƒ_˘r_¨gs
 - 1; i++)

2891 
	`DMEMIT
(" %s", 
ˇche
->
˘r_¨gs
[
i
]);

2892 i‡(
ˇche
->
ƒ_˘r_¨gs
)

2893 
	`DMEMIT
(" %s", 
ˇche
->
˘r_¨gs
[ˇche->
ƒ_˘r_¨gs
 - 1]);

2898 
îr
:

2899 
	`DMEMIT
("Error");

2900 
	}
}

2908 
	$∑r£_cblock_ønge
(
ˇche
 *ˇche, c⁄° *
°r
,

2909 
cblock_ønge
 *
ªsu…
)

2911 
dummy
;

2912 
uöt64_t
 
b
, 
e
;

2913 
r
;

2918 
r
 = 
	`ssˇnf
(
°r
, "%Œu-%Œu%c", &
b
, &
e
, &
dummy
);

2919 i‡(
r
 < 0)

2920  
r
;

2922 i‡(
r
 == 2) {

2923 
ªsu…
->
begö
 = 
	`to_cblock
(
b
);

2924 
ªsu…
->
íd
 = 
	`to_cblock
(
e
);

2931 
r
 = 
	`ssˇnf
(
°r
, "%Œu%c", &
b
, &
dummy
);

2932 i‡(
r
 < 0)

2933  
r
;

2935 i‡(
r
 == 1) {

2936 
ªsu…
->
begö
 = 
	`to_cblock
(
b
);

2937 
ªsu…
->
íd
 = 
	`to_cblock
(
	`‰om_cblock
‘esu…->
begö
) + 1u);

2941 
	`DMERR
("övÆid cblockÑ™gê'%s'", 
°r
);

2942  -
EINVAL
;

2943 
	}
}

2945 
	$vÆid©e_cblock_ønge
(
ˇche
 *ˇche, 
cblock_ønge
 *
ønge
)

2947 
uöt64_t
 
b
 = 
	`‰om_cblock
(
ønge
->
begö
);

2948 
uöt64_t
 
e
 = 
	`‰om_cblock
(
ønge
->
íd
);

2949 
uöt64_t
 
n
 = 
	`‰om_cblock
(
ˇche
->
ˇche_size
);

2951 i‡(
b
 >
n
) {

2952 
	`DMERR
("begö cblock ouào‡ønge: %Œu >%Œu", 
b
, 
n
);

2953  -
EINVAL
;

2956 i‡(
e
 > 
n
) {

2957 
	`DMERR
("íd cblock ouào‡ønge: %Œu > %Œu", 
e
, 
n
);

2958  -
EINVAL
;

2961 i‡(
b
 >
e
) {

2962 
	`DMERR
("övÆid cblockÑ™ge: %Œu >%Œu", 
b
, 
e
);

2963  -
EINVAL
;

2967 
	}
}

2969 
	$ªque°_övÆid©i⁄
(
ˇche
 *ˇche, 
cblock_ønge
 *
ønge
)

2971 
övÆid©i⁄_ªque°
 
ªq
;

2973 
	`INIT_LIST_HEAD
(&
ªq
.
li°
);

2974 
ªq
.
cblocks
 = 
ønge
;

2975 
	`©omic_£t
(&
ªq
.
com∂ëe
, 0);

2976 
ªq
.
îr
 = 0;

2977 
	`öô_waôqueue_hód
(&
ªq
.
ªsu…_waô
);

2979 
	`•ö_lock
(&
ˇche
->
övÆid©i⁄_lock
);

2980 
	`li°_add
(&
ªq
.
li°
, &
ˇche
->
övÆid©i⁄_ªque°s
);

2981 
	`•ö_u∆ock
(&
ˇche
->
övÆid©i⁄_lock
);

2982 
	`wake_w‹kî
(
ˇche
);

2984 
	`waô_evít
(
ªq
.
ªsu…_waô
, 
	`©omic_ªad
(&ªq.
com∂ëe
));

2985  
ªq
.
îr
;

2986 
	}
}

2988 
	$¥o˚ss_övÆid©e_cblocks_mesßge
(
ˇche
 *ˇche, 
cou¡
,

2989 c⁄° **
cblock_ønges
)

2991 
r
 = 0;

2992 
i
;

2993 
cblock_ønge
 
ønge
;

2995 i‡(!
	`∑s°hrough_mode
(&
ˇche
->
„©uªs
)) {

2996 
	`DMERR
("cache hasÅo be inÖassthrough mode for invalidation");

2997  -
EPERM
;

3000 
i
 = 0; i < 
cou¡
; i++) {

3001 
r
 = 
	`∑r£_cblock_ønge
(
ˇche
, 
cblock_ønges
[
i
], &
ønge
);

3002 i‡(
r
)

3005 
r
 = 
	`vÆid©e_cblock_ønge
(
ˇche
, &
ønge
);

3006 i‡(
r
)

3012 
r
 = 
	`ªque°_övÆid©i⁄
(
ˇche
, &
ønge
);

3013 i‡(
r
)

3017  
r
;

3018 
	}
}

3028 
	$ˇche_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

3030 
ˇche
 *ˇchê
ti
->
¥iv©e
;

3032 i‡(!
¨gc
)

3033  -
EINVAL
;

3035 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "invalidate_cblocks"))

3036  
	`¥o˚ss_övÆid©e_cblocks_mesßge
(
ˇche
, 
¨gc
 - 1, (c⁄° **Ë
¨gv
 + 1);

3038 i‡(
¨gc
 != 2)

3039  -
EINVAL
;

3041  
	`£t_c⁄fig_vÆue
(
ˇche
, 
¨gv
[0],árgv[1]);

3042 
	}
}

3044 
	$ˇche_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

3045 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

3047 
r
 = 0;

3048 
ˇche
 *ˇchê
ti
->
¥iv©e
;

3050 
r
 = 
	`‚
(
ti
, 
ˇche
->
ˇche_dev
, 0, 
	`gë_dev_size
(ˇche->ˇche_dev), 
d©a
);

3051 i‡(!
r
)

3052 
r
 = 
	`‚
(
ti
, 
ˇche
->
‹igö_dev
, 0,Åi->
Àn
, 
d©a
);

3054  
r
;

3055 
	}
}

3063 
	$ˇche_bvec_mîge
(
dm_èrgë
 *
ti
,

3064 
bvec_mîge_d©a
 *
bvm
,

3065 
bio_vec
 *
biovec
, 
max_size
)

3067 
ˇche
 *ˇchê
ti
->
¥iv©e
;

3068 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
ˇche
->
‹igö_dev
->
bdev
);

3070 i‡(!
q
->
mîge_bvec_‚
)

3071  
max_size
;

3073 
bvm
->
bi_bdev
 = 
ˇche
->
‹igö_dev
->
bdev
;

3074  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

3075 
	}
}

3077 
	$£t_disˇrd_limôs
(
ˇche
 *ˇche, 
queue_limôs
 *
limôs
)

3082 
limôs
->
max_disˇrd_£˘‹s
 = 
ˇche
->
£˘‹s_≥r_block
;

3083 
limôs
->
disˇrd_gønuœrôy
 = 
ˇche
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
;

3084 
	}
}

3086 
	$ˇche_io_höts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

3088 
ˇche
 *ˇchê
ti
->
¥iv©e
;

3089 
uöt64_t
 
io_›t_£˘‹s
 = 
limôs
->
io_›t
 >> 
SECTOR_SHIFT
;

3095 i‡(
io_›t_£˘‹s
 < 
ˇche
->
£˘‹s_≥r_block
 ||

3096 
	`do_div
(
io_›t_£˘‹s
, 
ˇche
->
£˘‹s_≥r_block
)) {

3097 
	`blk_limôs_io_mö
(
limôs
, 
ˇche
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

3098 
	`blk_limôs_io_›t
(
limôs
, 
ˇche
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

3100 
	`£t_disˇrd_limôs
(
ˇche
, 
limôs
);

3101 
	}
}

3105 
èrgë_ty≥
 
	gˇche_èrgë
 = {

3106 .
«me
 = "cache",

3107 .
	gvîsi⁄
 = {1, 5, 0},

3108 .
	gmoduÀ
 = 
THIS_MODULE
,

3109 .
	g˘r
 = 
ˇche_˘r
,

3110 .
	gdå
 = 
ˇche_då
,

3111 .
	gm≠
 = 
ˇche_m≠
,

3112 .
	gíd_io
 = 
ˇche_íd_io
,

3113 .
	gpo°su•íd
 = 
ˇche_po°su•íd
,

3114 .
	g¥îesume
 = 
ˇche_¥îesume
,

3115 .
	gªsume
 = 
ˇche_ªsume
,

3116 .
	g°©us
 = 
ˇche_°©us
,

3117 .
	gmesßge
 = 
ˇche_mesßge
,

3118 .
	gôî©e_devi˚s
 = 
ˇche_ôî©e_devi˚s
,

3119 .
	gmîge
 = 
ˇche_bvec_mîge
,

3120 .
	gio_höts
 = 
ˇche_io_höts
,

3123 
__öô
 
	$dm_ˇche_öô
()

3125 
r
;

3127 
r
 = 
	`dm_ªgi°î_èrgë
(&
ˇche_èrgë
);

3128 i‡(
r
) {

3129 
	`DMERR
("ˇchêèrgëÑegi°øti⁄ faûed: %d", 
r
);

3130  
r
;

3133 
migøti⁄_ˇche
 = 
	`KMEM_CACHE
(
dm_ˇche_migøti⁄
, 0);

3134 i‡(!
migøti⁄_ˇche
) {

3135 
	`dm_uƒegi°î_èrgë
(&
ˇche_èrgë
);

3136  -
ENOMEM
;

3140 
	}
}

3142 
__exô
 
	$dm_ˇche_exô
()

3144 
	`dm_uƒegi°î_èrgë
(&
ˇche_èrgë
);

3145 
	`kmem_ˇche_de°roy
(
migøti⁄_ˇche
);

3146 
	}
}

3148 
moduÀ_öô
(
dm_ˇche_öô
);

3149 
moduÀ_exô
(
dm_ˇche_exô
);

3151 
MODULE_DESCRIPTION
(
DM_NAME
 " cacheÅarget");

3152 
MODULE_AUTHOR
("Joe Thornber <ejt@redhat.com>");

3153 
MODULE_LICENSE
("GPL");

	@dm-cache.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x827a42f4, 
__VMLINUX_SYMBOL_STR
(
dm_tm_›í_wôh_sm
) },

24 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

25 { 0x402b8281, 
__VMLINUX_SYMBOL_STR
(
__ªque°_moduÀ
) },

26 { 0xd041d62b, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_gë_vÆue
) },

27 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

28 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

29 { 0x7deff673, 
__VMLINUX_SYMBOL_STR
(
dm_c⁄sume_¨gs
) },

30 { 0xb7bad799, 
__VMLINUX_SYMBOL_STR
(
dm_bm_u∆ock
) },

31 { 0x5876c094, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

32 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

33 { 0x23e3b40d, 
__VMLINUX_SYMBOL_STR
(
dm_gë_˚Œ
) },

34 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
°æí
) },

35 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

36 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

37 { 0x24Á6664, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_£t_bô
) },

38 { 0xd75f42b2, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_›t
) },

39 { 0x688d422d, 
__VMLINUX_SYMBOL_STR
(
dm_bm_block_size
) },

40 { 0xd00dbc46, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_‰ì_˚Œ
) },

41 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

42 { 0x154c6338, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_de°roy
) },

43 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

44 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

45 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

46 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

47 { 0xeˇb91e1, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_c›y
) },

48 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

49 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

50 { 0x118a5e56, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_mö
) },

51 { 0xd163ˇde, 
__VMLINUX_SYMBOL_STR
(
dm_tm_commô
) },

52 { 0x6791a44e, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_íåy_dec
) },

53 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

54 { 0x5´d1dd7, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_Êush
) },

55 { 0xf96cc7e, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

56 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

57 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

58 { 0xb70b342a, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_de°roy
) },

59 { 0xd292ed14, 
__VMLINUX_SYMBOL_STR
(
dm_˚Œ_ªÀa£
) },

60 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

61 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

62 { 0xffff2ac3, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_ªsize
) },

63 { 0x832bf228, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_dñ
) },

64 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

65 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

66 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

67 { 0x5991219c, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k
) },

68 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

69 { 0x17c36f29, 
__VMLINUX_SYMBOL_STR
(
dm_bm_checksum
) },

70 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

71 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

72 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

73 { 0x62c1b9ì, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_wÆk
) },

74 { 0x72289260, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_de°roy
) },

75 { 0xed58cÁ1, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_em±y
) },

76 { 0xb138d0bf, 
__VMLINUX_SYMBOL_STR
(
dm_øãlimô_°©e
) },

77 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

78 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

79 { 0xˇ2e3a88, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_íåy_öc
) },

80 { 0x9166Áda, 
__VMLINUX_SYMBOL_STR
(
°∫˝y
) },

81 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

82 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
°∫cmp
) },

83 { 0x32b5f546, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_em±y
) },

84 { 0xf375d009, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock
) },

85 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

86 { 0x960f071e, 
__VMLINUX_SYMBOL_STR
(
dm_su•íded
) },

87 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

88 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

89 { 0x6e5db7e4, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

90 { 0x2ed55c8e, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

91 { 0xab96bd2d, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_ã°_bô
) },

92 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

93 { 0x858c8d94, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_£t_vÆue
) },

94 { 0x8e4150e1, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_Æloc_˚Œ
) },

95 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

96 { 0x7ade1071, 
__VMLINUX_SYMBOL_STR
(
dm_tm_de°roy
) },

97 { 0xf12ec3cd, 
__VMLINUX_SYMBOL_STR
(
dm_disk_bô£t_öô
) },

98 { 0x7657e859, 
__VMLINUX_SYMBOL_STR
(
dm_bô£t_˛ór_bô
) },

99 { 0xa„da29f, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock_zîo
) },

100 { 0xbe0498f3, 
__VMLINUX_SYMBOL_STR
(
moduÀ_put
) },

101 { 0xb968aˇ0, 
__VMLINUX_SYMBOL_STR
(
dm_˚Œ_ªÀa£_no_hﬁdî
) },

102 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

103 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

104 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

105 { 0xa87c5b4d, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_ªsize
) },

106 { 0x55b4bd4d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¸óã_wôh_sm
) },

107 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

108 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

109 { 0xf5455120, 
__VMLINUX_SYMBOL_STR
(
dm_bm_ªad_lock
) },

110 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

111 { 0xd688716b, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_¸óã
) },

112 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

113 { 0x2eb01e04, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_de°roy
) },

114 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

115 { 0x3ad0f55b, 
__VMLINUX_SYMBOL_STR
(
dm_bm_Êush
) },

116 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

117 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

118 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

119 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

120 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

121 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

122 { 0x54f69d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¥e_commô
) },

123 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

124 { 0x2c112836, 
__VMLINUX_SYMBOL_STR
(
dm_block_loˇti⁄
) },

125 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

126 { 0xb6d5c65d, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_add_w‹k
) },

127 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

128 { 0xebd06óf, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_¸óã
) },

129 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

130 { 0xd091cdcf, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_¸óã
) },

131 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

132 { 0x1e3f728d, 
__VMLINUX_SYMBOL_STR
(
dm_block_d©a
) },

133 { 0x2025e954, 
__VMLINUX_SYMBOL_STR
(
dm_¨øy_öfo_öô
) },

134 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

135 { 0xb1425b32, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_add_èrgë_ˇŒbacks
) },

136 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

137 { 0xa88bd3e3, 
__VMLINUX_SYMBOL_STR
(
__öô_rw£m
) },

138 { 0x8ó31722, 
__VMLINUX_SYMBOL_STR
(
åy_moduÀ_gë
) },

139 { 0x17dd39d6, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_¸óã
) },

140 { 0xa4fd3f13, 
__VMLINUX_SYMBOL_STR
(
dm_bio_dëaö
) },

143 c⁄° 
	g__moduÀ_dïíds
[]

144 
__u£d


145 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

149 
MODULE_INFO
(
§cvîsi⁄
, "93EE58CD52FCC5AD620B7A1");

	@dm-crypt.c

10 
	~<löux/com∂ëi⁄.h
>

11 
	~<löux/îr.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/kî√l.h
>

15 
	~<löux/bio.h
>

16 
	~<löux/blkdev.h
>

17 
	~<löux/mempoﬁ.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/¸y±o.h
>

20 
	~<löux/w‹kqueue.h
>

21 
	~<löux/backög-dev.h
>

22 
	~<löux/©omic.h
>

23 
	~<löux/sˇâîli°.h
>

24 
	~<asm/∑ge.h
>

25 
	~<asm/u«lig√d.h
>

26 
	~<¸y±o/hash.h
>

27 
	~<¸y±o/md5.h
>

28 
	~<¸y±o/Æg≠i.h
>

30 
	~<löux/devi˚-m≠≥r.h
>

32 
	#DM_MSG_PREFIX
 "¸y±"

	)

37 
	sc⁄vît_c⁄ãxt
 {

38 
com∂ëi⁄
 
	mª°¨t
;

39 
bio
 *
	mbio_ö
;

40 
bio
 *
	mbio_out
;

41 
bvec_ôî
 
	môî_ö
;

42 
bvec_ôî
 
	môî_out
;

43 
£˘‹_t
 
	mcc_£˘‹
;

44 
©omic_t
 
	mcc_≥ndög
;

45 
ablkcùhî_ªque°
 *
	mªq
;

51 
	sdm_¸y±_io
 {

52 
¸y±_c⁄fig
 *
	mcc
;

53 
bio
 *
	mba£_bio
;

54 
w‹k_°ru˘
 
	mw‹k
;

56 
c⁄vît_c⁄ãxt
 
	m˘x
;

58 
©omic_t
 
	mio_≥ndög
;

59 
	mîr‹
;

60 
£˘‹_t
 
	m£˘‹
;

61 
dm_¸y±_io
 *
	mba£_io
;

62 } 
	gCRYPTO_MINALIGN_ATTR
;

64 
	sdm_¸y±_ªque°
 {

65 
c⁄vît_c⁄ãxt
 *
	m˘x
;

66 
sˇâîli°
 
	msg_ö
;

67 
sˇâîli°
 
	msg_out
;

68 
£˘‹_t
 
	miv_£˘‹
;

71 
	g¸y±_c⁄fig
;

73 
	s¸y±_iv_›î©i⁄s
 {

74 (*
	m˘r
)(
¸y±_c⁄fig
 *
	mcc
, 
dm_èrgë
 *
	mti
,

75 c⁄° *
	m›ts
);

76 (*
	mdå
)(
¸y±_c⁄fig
 *
	mcc
);

77 (*
	möô
)(
¸y±_c⁄fig
 *
	mcc
);

78 (*
	mwùe
)(
¸y±_c⁄fig
 *
	mcc
);

79 (*
	mgíî©‹
)(
¸y±_c⁄fig
 *
	mcc
, 
u8
 *
	miv
,

80 
dm_¸y±_ªque°
 *
	mdmªq
);

81 (*
	mpo°
)(
¸y±_c⁄fig
 *
	mcc
, 
u8
 *
	miv
,

82 
dm_¸y±_ªque°
 *
	mdmªq
);

85 
	siv_essiv_¥iv©e
 {

86 
¸y±o_hash
 *
	mhash_tfm
;

87 
u8
 *
	mß…
;

90 
	siv_bíbi_¥iv©e
 {

91 
	mshi·
;

94 
	#LMK_SEED_SIZE
 64

	)

95 
	siv_lmk_¥iv©e
 {

96 
¸y±o_shash
 *
	mhash_tfm
;

97 
u8
 *
	m£ed
;

100 
	#TCW_WHITENING_SIZE
 16

	)

101 
	siv_tcw_¥iv©e
 {

102 
¸y±o_shash
 *
	m¸c32_tfm
;

103 
u8
 *
	miv_£ed
;

104 
u8
 *
	mwhôíög
;

111 
	eÊags
 { 
	mDM_CRYPT_SUSPENDED
, 
	mDM_CRYPT_KEY_VALID
 };

116 
	s¸y±_c⁄fig
 {

117 
dm_dev
 *
	mdev
;

118 
£˘‹_t
 
	m°¨t
;

124 
mempoﬁ_t
 *
	mio_poﬁ
;

125 
mempoﬁ_t
 *
	mªq_poﬁ
;

126 
mempoﬁ_t
 *
	m∑ge_poﬁ
;

127 
bio_£t
 *
	mbs
;

129 
w‹kqueue_°ru˘
 *
	mio_queue
;

130 
w‹kqueue_°ru˘
 *
	m¸y±_queue
;

132 *
	mcùhî
;

133 *
	mcùhî_°rög
;

135 
¸y±_iv_›î©i⁄s
 *
	miv_gí_›s
;

137 
iv_essiv_¥iv©e
 
	messiv
;

138 
iv_bíbi_¥iv©e
 
	mbíbi
;

139 
iv_lmk_¥iv©e
 
	mlmk
;

140 
iv_tcw_¥iv©e
 
	mtcw
;

141 } 
	miv_gí_¥iv©e
;

142 
£˘‹_t
 
	miv_off£t
;

143 
	miv_size
;

146 *
	miv_¥iv©e
;

147 
¸y±o_ablkcùhî
 **
	mtfms
;

148 
	mtfms_cou¡
;

163 
	mdmªq_°¨t
;

165 
	m≥r_bio_d©a_size
;

167 
	mÊags
;

168 
	mkey_size
;

169 
	mkey_∑πs
;

170 
	mkey_exåa_size
;

171 
u8
 
	mkey
[0];

174 
	#MIN_IOS
 16

	)

175 
	#MIN_POOL_PAGES
 32

	)

177 
kmem_ˇche
 *
	g_¸y±_io_poﬁ
;

179 
˛⁄e_öô
(
dm_¸y±_io
 *, 
bio
 *);

180 
k¸y±d_queue_¸y±
(
dm_¸y±_io
 *
io
);

181 
u8
 *
iv_of_dmªq
(
¸y±_c⁄fig
 *
cc
, 
dm_¸y±_ªque°
 *
dmªq
);

186 
¸y±o_ablkcùhî
 *
	$™y_tfm
(
¸y±_c⁄fig
 *
cc
)

188  
cc
->
tfms
[0];

189 
	}
}

238 
	$¸y±_iv_∂aö_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

239 
dm_¸y±_ªque°
 *
dmªq
)

241 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
);

242 *(
__À32
 *)
iv
 = 
	`˝u_to_À32
(
dmªq
->
iv_£˘‹
 & 0xffffffff);

245 
	}
}

247 
	$¸y±_iv_∂aö64_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

248 
dm_¸y±_ªque°
 *
dmªq
)

250 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
);

251 *(
__À64
 *)
iv
 = 
	`˝u_to_À64
(
dmªq
->
iv_£˘‹
);

254 
	}
}

257 
	$¸y±_iv_essiv_öô
(
¸y±_c⁄fig
 *
cc
)

259 
iv_essiv_¥iv©e
 *
essiv
 = &
cc
->
iv_gí_¥iv©e
.essiv;

260 
hash_desc
 
desc
;

261 
sˇâîli°
 
sg
;

262 
¸y±o_cùhî
 *
essiv_tfm
;

263 
îr
;

265 
	`sg_öô_⁄e
(&
sg
, 
cc
->
key
, cc->
key_size
);

266 
desc
.
tfm
 = 
essiv
->
hash_tfm
;

267 
desc
.
Êags
 = 
CRYPTO_TFM_REQ_MAY_SLEEP
;

269 
îr
 = 
	`¸y±o_hash_dige°
(&
desc
, &
sg
, 
cc
->
key_size
, 
essiv
->
ß…
);

270 i‡(
îr
)

271  
îr
;

273 
essiv_tfm
 = 
cc
->
iv_¥iv©e
;

275 
îr
 = 
	`¸y±o_cùhî_£tkey
(
essiv_tfm
, 
essiv
->
ß…
,

276 
	`¸y±o_hash_dige°size
(
essiv
->
hash_tfm
));

277 i‡(
îr
)

278  
îr
;

281 
	}
}

284 
	$¸y±_iv_essiv_wùe
(
¸y±_c⁄fig
 *
cc
)

286 
iv_essiv_¥iv©e
 *
essiv
 = &
cc
->
iv_gí_¥iv©e
.essiv;

287 
ß…_size
 = 
	`¸y±o_hash_dige°size
(
essiv
->
hash_tfm
);

288 
¸y±o_cùhî
 *
essiv_tfm
;

289 
r
, 
îr
 = 0;

291 
	`mem£t
(
essiv
->
ß…
, 0, 
ß…_size
);

293 
essiv_tfm
 = 
cc
->
iv_¥iv©e
;

294 
r
 = 
	`¸y±o_cùhî_£tkey
(
essiv_tfm
, 
essiv
->
ß…
, 
ß…_size
);

295 i‡(
r
)

296 
îr
 = 
r
;

298  
îr
;

299 
	}
}

302 
¸y±o_cùhî
 *
	$£tup_essiv_˝u
(
¸y±_c⁄fig
 *
cc
,

303 
dm_èrgë
 *
ti
,

304 
u8
 *
ß…
, 
ß…size
)

306 
¸y±o_cùhî
 *
essiv_tfm
;

307 
îr
;

310 
essiv_tfm
 = 
	`¸y±o_Æloc_cùhî
(
cc
->
cùhî
, 0, 
CRYPTO_ALG_ASYNC
);

311 i‡(
	`IS_ERR
(
essiv_tfm
)) {

312 
ti
->
îr‹
 = "Errorállocating cryptoÅfm for ESSIV";

313  
essiv_tfm
;

316 i‡(
	`¸y±o_cùhî_blocksize
(
essiv_tfm
) !=

317 
	`¸y±o_ablkcùhî_ivsize
(
	`™y_tfm
(
cc
))) {

318 
ti
->
îr‹
 = "Block size of ESSIV cipher does "

320 
	`¸y±o_‰ì_cùhî
(
essiv_tfm
);

321  
	`ERR_PTR
(-
EINVAL
);

324 
îr
 = 
	`¸y±o_cùhî_£tkey
(
essiv_tfm
, 
ß…
, 
ß…size
);

325 i‡(
îr
) {

326 
ti
->
îr‹
 = "FailedÅo set key for ESSIV cipher";

327 
	`¸y±o_‰ì_cùhî
(
essiv_tfm
);

328  
	`ERR_PTR
(
îr
);

331  
essiv_tfm
;

332 
	}
}

334 
	$¸y±_iv_essiv_då
(
¸y±_c⁄fig
 *
cc
)

336 
¸y±o_cùhî
 *
essiv_tfm
;

337 
iv_essiv_¥iv©e
 *
essiv
 = &
cc
->
iv_gí_¥iv©e
.essiv;

339 
	`¸y±o_‰ì_hash
(
essiv
->
hash_tfm
);

340 
essiv
->
hash_tfm
 = 
NULL
;

342 
	`kz‰ì
(
essiv
->
ß…
);

343 
essiv
->
ß…
 = 
NULL
;

345 
essiv_tfm
 = 
cc
->
iv_¥iv©e
;

347 i‡(
essiv_tfm
)

348 
	`¸y±o_‰ì_cùhî
(
essiv_tfm
);

350 
cc
->
iv_¥iv©e
 = 
NULL
;

351 
	}
}

353 
	$¸y±_iv_essiv_˘r
(
¸y±_c⁄fig
 *
cc
, 
dm_èrgë
 *
ti
,

354 c⁄° *
›ts
)

356 
¸y±o_cùhî
 *
essiv_tfm
 = 
NULL
;

357 
¸y±o_hash
 *
hash_tfm
 = 
NULL
;

358 
u8
 *
ß…
 = 
NULL
;

359 
îr
;

361 i‡(!
›ts
) {

362 
ti
->
îr‹
 = "Digestálgorithm missing for ESSIV mode";

363  -
EINVAL
;

367 
hash_tfm
 = 
	`¸y±o_Æloc_hash
(
›ts
, 0, 
CRYPTO_ALG_ASYNC
);

368 i‡(
	`IS_ERR
(
hash_tfm
)) {

369 
ti
->
îr‹
 = "Error initializing ESSIV hash";

370 
îr
 = 
	`PTR_ERR
(
hash_tfm
);

371 
bad
;

374 
ß…
 = 
	`kzÆloc
(
	`¸y±o_hash_dige°size
(
hash_tfm
), 
GFP_KERNEL
);

375 i‡(!
ß…
) {

376 
ti
->
îr‹
 = "Error kmallocing salt storage in ESSIV";

377 
îr
 = -
ENOMEM
;

378 
bad
;

381 
cc
->
iv_gí_¥iv©e
.
essiv
.
ß…
 = salt;

382 
cc
->
iv_gí_¥iv©e
.
essiv
.
hash_tfm
 = hash_tfm;

384 
essiv_tfm
 = 
	`£tup_essiv_˝u
(
cc
, 
ti
, 
ß…
,

385 
	`¸y±o_hash_dige°size
(
hash_tfm
));

386 i‡(
	`IS_ERR
(
essiv_tfm
)) {

387 
	`¸y±_iv_essiv_då
(
cc
);

388  
	`PTR_ERR
(
essiv_tfm
);

390 
cc
->
iv_¥iv©e
 = 
essiv_tfm
;

394 
bad
:

395 i‡(
hash_tfm
 && !
	`IS_ERR
(hash_tfm))

396 
	`¸y±o_‰ì_hash
(
hash_tfm
);

397 
	`k‰ì
(
ß…
);

398  
îr
;

399 
	}
}

401 
	$¸y±_iv_essiv_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

402 
dm_¸y±_ªque°
 *
dmªq
)

404 
¸y±o_cùhî
 *
essiv_tfm
 = 
cc
->
iv_¥iv©e
;

406 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
);

407 *(
__À64
 *)
iv
 = 
	`˝u_to_À64
(
dmªq
->
iv_£˘‹
);

408 
	`¸y±o_cùhî_í¸y±_⁄e
(
essiv_tfm
, 
iv
, iv);

411 
	}
}

413 
	$¸y±_iv_bíbi_˘r
(
¸y±_c⁄fig
 *
cc
, 
dm_èrgë
 *
ti
,

414 c⁄° *
›ts
)

416 
bs
 = 
	`¸y±o_ablkcùhî_blocksize
(
	`™y_tfm
(
cc
));

417 
log
 = 
	`ûog2
(
bs
);

422 i‡(1 << 
log
 !
bs
) {

423 
ti
->
îr‹
 = "cypher blocksize isÇotáÖower of 2";

424  -
EINVAL
;

427 i‡(
log
 > 9) {

428 
ti
->
îr‹
 = "cypher blocksize is > 512";

429  -
EINVAL
;

432 
cc
->
iv_gí_¥iv©e
.
bíbi
.
shi·
 = 9 - 
log
;

435 
	}
}

437 
	$¸y±_iv_bíbi_då
(
¸y±_c⁄fig
 *
cc
)

439 
	}
}

441 
	$¸y±_iv_bíbi_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

442 
dm_¸y±_ªque°
 *
dmªq
)

444 
__be64
 
vÆ
;

446 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
 - (
u64
));

448 
vÆ
 = 
	`˝u_to_be64
(((
u64
)
dmªq
->
iv_£˘‹
 << 
cc
->
iv_gí_¥iv©e
.
bíbi
.
shi·
) + 1);

449 
	`put_u«lig√d
(
vÆ
, (
__be64
 *)(
iv
 + 
cc
->
iv_size
 - (
u64
)));

452 
	}
}

454 
	$¸y±_iv_nuŒ_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

455 
dm_¸y±_ªque°
 *
dmªq
)

457 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
);

460 
	}
}

462 
	$¸y±_iv_lmk_då
(
¸y±_c⁄fig
 *
cc
)

464 
iv_lmk_¥iv©e
 *
lmk
 = &
cc
->
iv_gí_¥iv©e
.lmk;

466 i‡(
lmk
->
hash_tfm
 && !
	`IS_ERR
(lmk->hash_tfm))

467 
	`¸y±o_‰ì_shash
(
lmk
->
hash_tfm
);

468 
lmk
->
hash_tfm
 = 
NULL
;

470 
	`kz‰ì
(
lmk
->
£ed
);

471 
lmk
->
£ed
 = 
NULL
;

472 
	}
}

474 
	$¸y±_iv_lmk_˘r
(
¸y±_c⁄fig
 *
cc
, 
dm_èrgë
 *
ti
,

475 c⁄° *
›ts
)

477 
iv_lmk_¥iv©e
 *
lmk
 = &
cc
->
iv_gí_¥iv©e
.lmk;

479 
lmk
->
hash_tfm
 = 
	`¸y±o_Æloc_shash
("md5", 0, 0);

480 i‡(
	`IS_ERR
(
lmk
->
hash_tfm
)) {

481 
ti
->
îr‹
 = "Error initializing LMK hash";

482  
	`PTR_ERR
(
lmk
->
hash_tfm
);

486 i‡(
cc
->
key_∑πs
 =cc->
tfms_cou¡
) {

487 
lmk
->
£ed
 = 
NULL
;

491 
lmk
->
£ed
 = 
	`kzÆloc
(
LMK_SEED_SIZE
, 
GFP_KERNEL
);

492 i‡(!
lmk
->
£ed
) {

493 
	`¸y±_iv_lmk_då
(
cc
);

494 
ti
->
îr‹
 = "Error kmallocing seed storage in LMK";

495  -
ENOMEM
;

499 
	}
}

501 
	$¸y±_iv_lmk_öô
(
¸y±_c⁄fig
 *
cc
)

503 
iv_lmk_¥iv©e
 *
lmk
 = &
cc
->
iv_gí_¥iv©e
.lmk;

504 
subkey_size
 = 
cc
->
key_size
 / cc->
key_∑πs
;

507 i‡(
lmk
->
£ed
)

508 
	`mem˝y
(
lmk
->
£ed
, 
cc
->
key
 + (cc->
tfms_cou¡
 * 
subkey_size
),

509 
	`¸y±o_shash_dige°size
(
lmk
->
hash_tfm
));

512 
	}
}

514 
	$¸y±_iv_lmk_wùe
(
¸y±_c⁄fig
 *
cc
)

516 
iv_lmk_¥iv©e
 *
lmk
 = &
cc
->
iv_gí_¥iv©e
.lmk;

518 i‡(
lmk
->
£ed
)

519 
	`mem£t
(
lmk
->
£ed
, 0, 
LMK_SEED_SIZE
);

522 
	}
}

524 
	$¸y±_iv_lmk_⁄e
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

525 
dm_¸y±_ªque°
 *
dmªq
,

526 
u8
 *
d©a
)

528 
iv_lmk_¥iv©e
 *
lmk
 = &
cc
->
iv_gí_¥iv©e
.lmk;

530 
shash_desc
 
desc
;

531 
˘x
[
	`¸y±o_shash_descsize
(
lmk
->
hash_tfm
)];

532 } 
sdesc
;

533 
md5_°©e
 
md5°©e
;

534 
__À32
 
buf
[4];

535 
i
, 
r
;

537 
sdesc
.
desc
.
tfm
 = 
lmk
->
hash_tfm
;

538 
sdesc
.
desc
.
Êags
 = 
CRYPTO_TFM_REQ_MAY_SLEEP
;

540 
r
 = 
	`¸y±o_shash_öô
(&
sdesc
.
desc
);

541 i‡(
r
)

542  
r
;

544 i‡(
lmk
->
£ed
) {

545 
r
 = 
	`¸y±o_shash_upd©e
(&
sdesc
.
desc
, 
lmk
->
£ed
, 
LMK_SEED_SIZE
);

546 i‡(
r
)

547  
r
;

551 
r
 = 
	`¸y±o_shash_upd©e
(&
sdesc
.
desc
, 
d©a
 + 16, 16 * 31);

552 i‡(
r
)

553  
r
;

556 
buf
[0] = 
	`˝u_to_À32
(
dmªq
->
iv_£˘‹
 & 0xFFFFFFFF);

557 
buf
[1] = 
	`˝u_to_À32
((((
u64
)
dmªq
->
iv_£˘‹
 >> 32) & 0x00FFFFFF) | 0x80000000);

558 
buf
[2] = 
	`˝u_to_À32
(4024);

559 
buf
[3] = 0;

560 
r
 = 
	`¸y±o_shash_upd©e
(&
sdesc
.
desc
, (
u8
 *)
buf
, (buf));

561 i‡(
r
)

562  
r
;

565 
r
 = 
	`¸y±o_shash_exp‹t
(&
sdesc
.
desc
, &
md5°©e
);

566 i‡(
r
)

567  
r
;

569 
i
 = 0; i < 
MD5_HASH_WORDS
; i++)

570 
	`__˝u_to_À32s
(&
md5°©e
.
hash
[
i
]);

571 
	`mem˝y
(
iv
, &
md5°©e
.
hash
, 
cc
->
iv_size
);

574 
	}
}

576 
	$¸y±_iv_lmk_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

577 
dm_¸y±_ªque°
 *
dmªq
)

579 
u8
 *
§c
;

580 
r
 = 0;

582 i‡(
	`bio_d©a_dú
(
dmªq
->
˘x
->
bio_ö
Ë=
WRITE
) {

583 
§c
 = 
	`km≠_©omic
(
	`sg_∑ge
(&
dmªq
->
sg_ö
));

584 
r
 = 
	`¸y±_iv_lmk_⁄e
(
cc
, 
iv
, 
dmªq
, 
§c
 + dmªq->
sg_ö
.
off£t
);

585 
	`kunm≠_©omic
(
§c
);

587 
	`mem£t
(
iv
, 0, 
cc
->
iv_size
);

589  
r
;

590 
	}
}

592 
	$¸y±_iv_lmk_po°
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

593 
dm_¸y±_ªque°
 *
dmªq
)

595 
u8
 *
d°
;

596 
r
;

598 i‡(
	`bio_d©a_dú
(
dmªq
->
˘x
->
bio_ö
Ë=
WRITE
)

601 
d°
 = 
	`km≠_©omic
(
	`sg_∑ge
(&
dmªq
->
sg_out
));

602 
r
 = 
	`¸y±_iv_lmk_⁄e
(
cc
, 
iv
, 
dmªq
, 
d°
 + dmªq->
sg_out
.
off£t
);

605 i‡(!
r
)

606 
	`¸y±o_x‹
(
d°
 + 
dmªq
->
sg_out
.
off£t
, 
iv
, 
cc
->
iv_size
);

608 
	`kunm≠_©omic
(
d°
);

609  
r
;

610 
	}
}

612 
	$¸y±_iv_tcw_då
(
¸y±_c⁄fig
 *
cc
)

614 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

616 
	`kz‰ì
(
tcw
->
iv_£ed
);

617 
tcw
->
iv_£ed
 = 
NULL
;

618 
	`kz‰ì
(
tcw
->
whôíög
);

619 
tcw
->
whôíög
 = 
NULL
;

621 i‡(
tcw
->
¸c32_tfm
 && !
	`IS_ERR
(tcw->crc32_tfm))

622 
	`¸y±o_‰ì_shash
(
tcw
->
¸c32_tfm
);

623 
tcw
->
¸c32_tfm
 = 
NULL
;

624 
	}
}

626 
	$¸y±_iv_tcw_˘r
(
¸y±_c⁄fig
 *
cc
, 
dm_èrgë
 *
ti
,

627 c⁄° *
›ts
)

629 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

631 i‡(
cc
->
key_size
 <(cc->
iv_size
 + 
TCW_WHITENING_SIZE
)) {

632 
ti
->
îr‹
 = "Wrong key size for TCW";

633  -
EINVAL
;

636 
tcw
->
¸c32_tfm
 = 
	`¸y±o_Æloc_shash
("crc32", 0, 0);

637 i‡(
	`IS_ERR
(
tcw
->
¸c32_tfm
)) {

638 
ti
->
îr‹
 = "Error initializing CRC32 in TCW";

639  
	`PTR_ERR
(
tcw
->
¸c32_tfm
);

642 
tcw
->
iv_£ed
 = 
	`kzÆloc
(
cc
->
iv_size
, 
GFP_KERNEL
);

643 
tcw
->
whôíög
 = 
	`kzÆloc
(
TCW_WHITENING_SIZE
, 
GFP_KERNEL
);

644 i‡(!
tcw
->
iv_£ed
 || !tcw->
whôíög
) {

645 
	`¸y±_iv_tcw_då
(
cc
);

646 
ti
->
îr‹
 = "Errorállocating seed storage in TCW";

647  -
ENOMEM
;

651 
	}
}

653 
	$¸y±_iv_tcw_öô
(
¸y±_c⁄fig
 *
cc
)

655 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

656 
key_off£t
 = 
cc
->
key_size
 - cc->
iv_size
 - 
TCW_WHITENING_SIZE
;

658 
	`mem˝y
(
tcw
->
iv_£ed
, &
cc
->
key
[
key_off£t
], cc->
iv_size
);

659 
	`mem˝y
(
tcw
->
whôíög
, &
cc
->
key
[
key_off£t
 + cc->
iv_size
],

660 
TCW_WHITENING_SIZE
);

663 
	}
}

665 
	$¸y±_iv_tcw_wùe
(
¸y±_c⁄fig
 *
cc
)

667 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

669 
	`mem£t
(
tcw
->
iv_£ed
, 0, 
cc
->
iv_size
);

670 
	`mem£t
(
tcw
->
whôíög
, 0, 
TCW_WHITENING_SIZE
);

673 
	}
}

675 
	$¸y±_iv_tcw_whôíög
(
¸y±_c⁄fig
 *
cc
,

676 
dm_¸y±_ªque°
 *
dmªq
,

677 
u8
 *
d©a
)

679 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

680 
u64
 
£˘‹
 = 
	`˝u_to_À64
((u64)
dmªq
->
iv_£˘‹
);

681 
u8
 
buf
[
TCW_WHITENING_SIZE
];

683 
shash_desc
 
desc
;

684 
˘x
[
	`¸y±o_shash_descsize
(
tcw
->
¸c32_tfm
)];

685 } 
sdesc
;

686 
i
, 
r
;

689 
	`mem˝y
(
buf
, 
tcw
->
whôíög
, 
TCW_WHITENING_SIZE
);

690 
	`¸y±o_x‹
(
buf
, (
u8
 *)&
£˘‹
, 8);

691 
	`¸y±o_x‹
(&
buf
[8], (
u8
 *)&
£˘‹
, 8);

694 
sdesc
.
desc
.
tfm
 = 
tcw
->
¸c32_tfm
;

695 
sdesc
.
desc
.
Êags
 = 
CRYPTO_TFM_REQ_MAY_SLEEP
;

696 
i
 = 0; i < 4; i++) {

697 
r
 = 
	`¸y±o_shash_öô
(&
sdesc
.
desc
);

698 i‡(
r
)

699 
out
;

700 
r
 = 
	`¸y±o_shash_upd©e
(&
sdesc
.
desc
, &
buf
[
i
 * 4], 4);

701 i‡(
r
)

702 
out
;

703 
r
 = 
	`¸y±o_shash_föÆ
(&
sdesc
.
desc
, &
buf
[
i
 * 4]);

704 i‡(
r
)

705 
out
;

707 
	`¸y±o_x‹
(&
buf
[0], &buf[12], 4);

708 
	`¸y±o_x‹
(&
buf
[4], &buf[8], 4);

711 
i
 = 0; i < ((1 << 
SECTOR_SHIFT
) / 8); i++)

712 
	`¸y±o_x‹
(
d©a
 + 
i
 * 8, 
buf
, 8);

713 
out
:

714 
	`mem£t
(
buf
, 0, (buf));

715  
r
;

716 
	}
}

718 
	$¸y±_iv_tcw_gí
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

719 
dm_¸y±_ªque°
 *
dmªq
)

721 
iv_tcw_¥iv©e
 *
tcw
 = &
cc
->
iv_gí_¥iv©e
.tcw;

722 
u64
 
£˘‹
 = 
	`˝u_to_À64
((u64)
dmªq
->
iv_£˘‹
);

723 
u8
 *
§c
;

724 
r
 = 0;

727 i‡(
	`bio_d©a_dú
(
dmªq
->
˘x
->
bio_ö
Ë!
WRITE
) {

728 
§c
 = 
	`km≠_©omic
(
	`sg_∑ge
(&
dmªq
->
sg_ö
));

729 
r
 = 
	`¸y±_iv_tcw_whôíög
(
cc
, 
dmªq
, 
§c
 + dmªq->
sg_ö
.
off£t
);

730 
	`kunm≠_©omic
(
§c
);

734 
	`mem˝y
(
iv
, 
tcw
->
iv_£ed
, 
cc
->
iv_size
);

735 
	`¸y±o_x‹
(
iv
, (
u8
 *)&
£˘‹
, 8);

736 i‡(
cc
->
iv_size
 > 8)

737 
	`¸y±o_x‹
(&
iv
[8], (
u8
 *)&
£˘‹
, 
cc
->
iv_size
 - 8);

739  
r
;

740 
	}
}

742 
	$¸y±_iv_tcw_po°
(
¸y±_c⁄fig
 *
cc
, 
u8
 *
iv
,

743 
dm_¸y±_ªque°
 *
dmªq
)

745 
u8
 *
d°
;

746 
r
;

748 i‡(
	`bio_d©a_dú
(
dmªq
->
˘x
->
bio_ö
Ë!
WRITE
)

752 
d°
 = 
	`km≠_©omic
(
	`sg_∑ge
(&
dmªq
->
sg_out
));

753 
r
 = 
	`¸y±_iv_tcw_whôíög
(
cc
, 
dmªq
, 
d°
 + dmªq->
sg_out
.
off£t
);

754 
	`kunm≠_©omic
(
d°
);

756  
r
;

757 
	}
}

759 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_∂aö_›s
 = {

760 .
gíî©‹
 = 
¸y±_iv_∂aö_gí


763 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_∂aö64_›s
 = {

764 .
gíî©‹
 = 
¸y±_iv_∂aö64_gí


767 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_essiv_›s
 = {

768 .
˘r
 = 
¸y±_iv_essiv_˘r
,

769 .
	gdå
 = 
¸y±_iv_essiv_då
,

770 .
	göô
 = 
¸y±_iv_essiv_öô
,

771 .
	gwùe
 = 
¸y±_iv_essiv_wùe
,

772 .
	ggíî©‹
 = 
¸y±_iv_essiv_gí


775 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_bíbi_›s
 = {

776 .
˘r
 = 
¸y±_iv_bíbi_˘r
,

777 .
	gdå
 = 
¸y±_iv_bíbi_då
,

778 .
	ggíî©‹
 = 
¸y±_iv_bíbi_gí


781 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_nuŒ_›s
 = {

782 .
gíî©‹
 = 
¸y±_iv_nuŒ_gí


785 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_lmk_›s
 = {

786 .
˘r
 = 
¸y±_iv_lmk_˘r
,

787 .
	gdå
 = 
¸y±_iv_lmk_då
,

788 .
	göô
 = 
¸y±_iv_lmk_öô
,

789 .
	gwùe
 = 
¸y±_iv_lmk_wùe
,

790 .
	ggíî©‹
 = 
¸y±_iv_lmk_gí
,

791 .
	gpo°
 = 
¸y±_iv_lmk_po°


794 
¸y±_iv_›î©i⁄s
 
	g¸y±_iv_tcw_›s
 = {

795 .
˘r
 = 
¸y±_iv_tcw_˘r
,

796 .
	gdå
 = 
¸y±_iv_tcw_då
,

797 .
	göô
 = 
¸y±_iv_tcw_öô
,

798 .
	gwùe
 = 
¸y±_iv_tcw_wùe
,

799 .
	ggíî©‹
 = 
¸y±_iv_tcw_gí
,

800 .
	gpo°
 = 
¸y±_iv_tcw_po°


803 
	$¸y±_c⁄vît_öô
(
¸y±_c⁄fig
 *
cc
,

804 
c⁄vît_c⁄ãxt
 *
˘x
,

805 
bio
 *
bio_out
, biÿ*
bio_ö
,

806 
£˘‹_t
 
£˘‹
)

808 
˘x
->
bio_ö
 = bio_in;

809 
˘x
->
bio_out
 = bio_out;

810 i‡(
bio_ö
)

811 
˘x
->
ôî_ö
 = 
bio_ö
->
bi_ôî
;

812 i‡(
bio_out
)

813 
˘x
->
ôî_out
 = 
bio_out
->
bi_ôî
;

814 
˘x
->
cc_£˘‹
 = 
£˘‹
 + 
cc
->
iv_off£t
;

815 
	`öô_com∂ëi⁄
(&
˘x
->
ª°¨t
);

816 
	}
}

818 
dm_¸y±_ªque°
 *
	$dmªq_of_ªq
(
¸y±_c⁄fig
 *
cc
,

819 
ablkcùhî_ªque°
 *
ªq
)

821  (
dm_¸y±_ªque°
 *)((*)
ªq
 + 
cc
->
dmªq_°¨t
);

822 
	}
}

824 
ablkcùhî_ªque°
 *
	$ªq_of_dmªq
(
¸y±_c⁄fig
 *
cc
,

825 
dm_¸y±_ªque°
 *
dmªq
)

827  (
ablkcùhî_ªque°
 *)((*)
dmªq
 - 
cc
->
dmªq_°¨t
);

828 
	}
}

830 
u8
 *
	$iv_of_dmªq
(
¸y±_c⁄fig
 *
cc
,

831 
dm_¸y±_ªque°
 *
dmªq
)

833  (
u8
 *)
	`ALIGN
(()(
dmªq
 + 1),

834 
	`¸y±o_ablkcùhî_Æignmask
(
	`™y_tfm
(
cc
)) + 1);

835 
	}
}

837 
	$¸y±_c⁄vît_block
(
¸y±_c⁄fig
 *
cc
,

838 
c⁄vît_c⁄ãxt
 *
˘x
,

839 
ablkcùhî_ªque°
 *
ªq
)

841 
bio_vec
 
bv_ö
 = 
	`bio_ôî_iovec
(
˘x
->
bio_ö
, ctx->
ôî_ö
);

842 
bio_vec
 
bv_out
 = 
	`bio_ôî_iovec
(
˘x
->
bio_out
, ctx->
ôî_out
);

843 
dm_¸y±_ªque°
 *
dmªq
;

844 
u8
 *
iv
;

845 
r
;

847 
dmªq
 = 
	`dmªq_of_ªq
(
cc
, 
ªq
);

848 
iv
 = 
	`iv_of_dmªq
(
cc
, 
dmªq
);

850 
dmªq
->
iv_£˘‹
 = 
˘x
->
cc_£˘‹
;

851 
dmªq
->
˘x
 = ctx;

852 
	`sg_öô_èbÀ
(&
dmªq
->
sg_ö
, 1);

853 
	`sg_£t_∑ge
(&
dmªq
->
sg_ö
, 
bv_ö
.
bv_∑ge
, 1 << 
SECTOR_SHIFT
,

854 
bv_ö
.
bv_off£t
);

856 
	`sg_öô_èbÀ
(&
dmªq
->
sg_out
, 1);

857 
	`sg_£t_∑ge
(&
dmªq
->
sg_out
, 
bv_out
.
bv_∑ge
, 1 << 
SECTOR_SHIFT
,

858 
bv_out
.
bv_off£t
);

860 
	`bio_adv™˚_ôî
(
˘x
->
bio_ö
, &˘x->
ôî_ö
, 1 << 
SECTOR_SHIFT
);

861 
	`bio_adv™˚_ôî
(
˘x
->
bio_out
, &˘x->
ôî_out
, 1 << 
SECTOR_SHIFT
);

863 i‡(
cc
->
iv_gí_›s
) {

864 
r
 = 
cc
->
iv_gí_›s
->
	`gíî©‹
(cc, 
iv
, 
dmªq
);

865 i‡(
r
 < 0)

866  
r
;

869 
	`ablkcùhî_ªque°_£t_¸y±
(
ªq
, &
dmªq
->
sg_ö
, &dmªq->
sg_out
,

870 1 << 
SECTOR_SHIFT
, 
iv
);

872 i‡(
	`bio_d©a_dú
(
˘x
->
bio_ö
Ë=
WRITE
)

873 
r
 = 
	`¸y±o_ablkcùhî_í¸y±
(
ªq
);

875 
r
 = 
	`¸y±o_ablkcùhî_de¸y±
(
ªq
);

877 i‡(!
r
 && 
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
po°
)

878 
r
 = 
cc
->
iv_gí_›s
->
	`po°
(cc, 
iv
, 
dmªq
);

880  
r
;

881 
	}
}

883 
k¸y±d_async_d⁄e
(
¸y±o_async_ªque°
 *
async_ªq
,

884 
îr‹
);

886 
	$¸y±_Æloc_ªq
(
¸y±_c⁄fig
 *
cc
,

887 
c⁄vît_c⁄ãxt
 *
˘x
)

889 
key_ödex
 = 
˘x
->
cc_£˘‹
 & (
cc
->
tfms_cou¡
 - 1);

891 i‡(!
˘x
->
ªq
)

892 
˘x
->
ªq
 = 
	`mempoﬁ_Æloc
(
cc
->
ªq_poﬁ
, 
GFP_NOIO
);

894 
	`ablkcùhî_ªque°_£t_tfm
(
˘x
->
ªq
, 
cc
->
tfms
[
key_ödex
]);

895 
	`ablkcùhî_ªque°_£t_ˇŒback
(
˘x
->
ªq
,

896 
CRYPTO_TFM_REQ_MAY_BACKLOG
 | 
CRYPTO_TFM_REQ_MAY_SLEEP
,

897 
k¸y±d_async_d⁄e
, 
	`dmªq_of_ªq
(
cc
, 
˘x
->
ªq
));

898 
	}
}

900 
	$¸y±_‰ì_ªq
(
¸y±_c⁄fig
 *
cc
,

901 
ablkcùhî_ªque°
 *
ªq
, 
bio
 *
ba£_bio
)

903 
dm_¸y±_io
 *
io
 = 
	`dm_≥r_bio_d©a
(
ba£_bio
, 
cc
->
≥r_bio_d©a_size
);

905 i‡((
ablkcùhî_ªque°
 *)(
io
 + 1Ë!
ªq
)

906 
	`mempoﬁ_‰ì
(
ªq
, 
cc
->
ªq_poﬁ
);

907 
	}
}

912 
	$¸y±_c⁄vît
(
¸y±_c⁄fig
 *
cc
,

913 
c⁄vît_c⁄ãxt
 *
˘x
)

915 
r
;

917 
	`©omic_£t
(&
˘x
->
cc_≥ndög
, 1);

919 
˘x
->
ôî_ö
.
bi_size
 && ctx->
ôî_out
.bi_size) {

921 
	`¸y±_Æloc_ªq
(
cc
, 
˘x
);

923 
	`©omic_öc
(&
˘x
->
cc_≥ndög
);

925 
r
 = 
	`¸y±_c⁄vît_block
(
cc
, 
˘x
, ctx->
ªq
);

927 
r
) {

929 -
EBUSY
:

930 
	`waô_f‹_com∂ëi⁄
(&
˘x
->
ª°¨t
);

931 
	`ªöô_com∂ëi⁄
(&
˘x
->
ª°¨t
);

933 -
EINPROGRESS
:

934 
˘x
->
ªq
 = 
NULL
;

935 
˘x
->
cc_£˘‹
++;

940 
	`©omic_dec
(&
˘x
->
cc_≥ndög
);

941 
˘x
->
cc_£˘‹
++;

942 
	`c⁄d_ªsched
();

947 
	`©omic_dec
(&
˘x
->
cc_≥ndög
);

948  
r
;

953 
	}
}

961 
bio
 *
	$¸y±_Æloc_buf„r
(
dm_¸y±_io
 *
io
, 
size
,

962 *
out_of_∑ges
)

964 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

965 
bio
 *
˛⁄e
;

966 
ƒ_iovecs
 = (
size
 + 
PAGE_SIZE
 - 1Ë>> 
PAGE_SHIFT
;

967 
gÂ_t
 
gÂ_mask
 = 
GFP_NOIO
 | 
__GFP_HIGHMEM
;

968 
i
, 
Àn
;

969 
∑ge
 *page;

971 
˛⁄e
 = 
	`bio_Æloc_bio£t
(
GFP_NOIO
, 
ƒ_iovecs
, 
cc
->
bs
);

972 i‡(!
˛⁄e
)

973  
NULL
;

975 
	`˛⁄e_öô
(
io
, 
˛⁄e
);

976 *
out_of_∑ges
 = 0;

978 
i
 = 0; i < 
ƒ_iovecs
; i++) {

979 
∑ge
 = 
	`mempoﬁ_Æloc
(
cc
->
∑ge_poﬁ
, 
gÂ_mask
);

980 i‡(!
∑ge
) {

981 *
out_of_∑ges
 = 1;

990 
gÂ_mask
 = (gÂ_mask | 
__GFP_NOWARN
Ë& ~
__GFP_WAIT
;

992 
Àn
 = (
size
 > 
PAGE_SIZE
) ? PAGE_SIZE : size;

994 i‡(!
	`bio_add_∑ge
(
˛⁄e
, 
∑ge
, 
Àn
, 0)) {

995 
	`mempoﬁ_‰ì
(
∑ge
, 
cc
->
∑ge_poﬁ
);

999 
size
 -
Àn
;

1002 i‡(!
˛⁄e
->
bi_ôî
.
bi_size
) {

1003 
	`bio_put
(
˛⁄e
);

1004  
NULL
;

1007  
˛⁄e
;

1008 
	}
}

1010 
	$¸y±_‰ì_buf„r_∑ges
(
¸y±_c⁄fig
 *
cc
, 
bio
 *
˛⁄e
)

1012 
i
;

1013 
bio_vec
 *
bv
;

1015 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
˛⁄e
, 
i
) {

1016 
	`BUG_ON
(!
bv
->
bv_∑ge
);

1017 
	`mempoﬁ_‰ì
(
bv
->
bv_∑ge
, 
cc
->
∑ge_poﬁ
);

1018 
bv
->
bv_∑ge
 = 
NULL
;

1020 
	}
}

1022 
	$¸y±_io_öô
(
dm_¸y±_io
 *
io
, 
¸y±_c⁄fig
 *
cc
,

1023 
bio
 *bio, 
£˘‹_t
 
£˘‹
)

1025 
io
->
cc
 = cc;

1026 
io
->
ba£_bio
 = 
bio
;

1027 
io
->
£˘‹
 = sector;

1028 
io
->
îr‹
 = 0;

1029 
io
->
ba£_io
 = 
NULL
;

1030 
io
->
˘x
.
ªq
 = 
NULL
;

1031 
	`©omic_£t
(&
io
->
io_≥ndög
, 0);

1032 
	}
}

1034 
	$¸y±_öc_≥ndög
(
dm_¸y±_io
 *
io
)

1036 
	`©omic_öc
(&
io
->
io_≥ndög
);

1037 
	}
}

1044 
	$¸y±_dec_≥ndög
(
dm_¸y±_io
 *
io
)

1046 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1047 
bio
 *
ba£_bio
 = 
io
->base_bio;

1048 
dm_¸y±_io
 *
ba£_io
 = 
io
->base_io;

1049 
îr‹
 = 
io
->error;

1051 i‡(!
	`©omic_dec_™d_ã°
(&
io
->
io_≥ndög
))

1054 i‡(
io
->
˘x
.
ªq
)

1055 
	`¸y±_‰ì_ªq
(
cc
, 
io
->
˘x
.
ªq
, 
ba£_bio
);

1056 i‡(
io
 !
	`dm_≥r_bio_d©a
(
ba£_bio
, 
cc
->
≥r_bio_d©a_size
))

1057 
	`mempoﬁ_‰ì
(
io
, 
cc
->
io_poﬁ
);

1059 i‡(
	`likñy
(!
ba£_io
))

1060 
	`bio_ídio
(
ba£_bio
, 
îr‹
);

1062 i‡(
îr‹
 && !
ba£_io
->error)

1063 
ba£_io
->
îr‹
 =Érror;

1064 
	`¸y±_dec_≥ndög
(
ba£_io
);

1066 
	}
}

1085 
	$¸y±_ídio
(
bio
 *
˛⁄e
, 
îr‹
)

1087 
dm_¸y±_io
 *
io
 = 
˛⁄e
->
bi_¥iv©e
;

1088 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1089 
rw
 = 
	`bio_d©a_dú
(
˛⁄e
);

1091 i‡(
	`u∆ikñy
(!
	`bio_Êagged
(
˛⁄e
, 
BIO_UPTODATE
Ë&& !
îr‹
))

1092 
îr‹
 = -
EIO
;

1097 i‡(
rw
 =
WRITE
)

1098 
	`¸y±_‰ì_buf„r_∑ges
(
cc
, 
˛⁄e
);

1100 
	`bio_put
(
˛⁄e
);

1102 i‡(
rw
 =
READ
 && !
îr‹
) {

1103 
	`k¸y±d_queue_¸y±
(
io
);

1107 i‡(
	`u∆ikñy
(
îr‹
))

1108 
io
->
îr‹
 =Érror;

1110 
	`¸y±_dec_≥ndög
(
io
);

1111 
	}
}

1113 
	$˛⁄e_öô
(
dm_¸y±_io
 *
io
, 
bio
 *
˛⁄e
)

1115 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1117 
˛⁄e
->
bi_¥iv©e
 = 
io
;

1118 
˛⁄e
->
bi_íd_io
 = 
¸y±_ídio
;

1119 
˛⁄e
->
bi_bdev
 = 
cc
->
dev
->
bdev
;

1120 
˛⁄e
->
bi_rw
 = 
io
->
ba£_bio
->bi_rw;

1121 
	}
}

1123 
	$k¸y±d_io_ªad
(
dm_¸y±_io
 *
io
, 
gÂ_t
 
gÂ
)

1125 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1126 
bio
 *
ba£_bio
 = 
io
->base_bio;

1127 
bio
 *
˛⁄e
;

1134 
˛⁄e
 = 
	`bio_˛⁄e_bio£t
(
ba£_bio
, 
gÂ
, 
cc
->
bs
);

1135 i‡(!
˛⁄e
)

1138 
	`¸y±_öc_≥ndög
(
io
);

1140 
	`˛⁄e_öô
(
io
, 
˛⁄e
);

1141 
˛⁄e
->
bi_ôî
.
bi_£˘‹
 = 
cc
->
°¨t
 + 
io
->
£˘‹
;

1143 
	`gíîic_make_ªque°
(
˛⁄e
);

1145 
	}
}

1147 
	$k¸y±d_io_wrôe
(
dm_¸y±_io
 *
io
)

1149 
bio
 *
˛⁄e
 = 
io
->
˘x
.
bio_out
;

1150 
	`gíîic_make_ªque°
(
˛⁄e
);

1151 
	}
}

1153 
	$k¸y±d_io
(
w‹k_°ru˘
 *
w‹k
)

1155 
dm_¸y±_io
 *
io
 = 
	`c⁄èöî_of
(
w‹k
, dm_crypt_io, work);

1157 i‡(
	`bio_d©a_dú
(
io
->
ba£_bio
Ë=
READ
) {

1158 
	`¸y±_öc_≥ndög
(
io
);

1159 i‡(
	`k¸y±d_io_ªad
(
io
, 
GFP_NOIO
))

1160 
io
->
îr‹
 = -
ENOMEM
;

1161 
	`¸y±_dec_≥ndög
(
io
);

1163 
	`k¸y±d_io_wrôe
(
io
);

1164 
	}
}

1166 
	$k¸y±d_queue_io
(
dm_¸y±_io
 *
io
)

1168 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1170 
	`INIT_WORK
(&
io
->
w‹k
, 
k¸y±d_io
);

1171 
	`queue_w‹k
(
cc
->
io_queue
, &
io
->
w‹k
);

1172 
	}
}

1174 
	$k¸y±d_¸y±_wrôe_io_submô
(
dm_¸y±_io
 *
io
, 
async
)

1176 
bio
 *
˛⁄e
 = 
io
->
˘x
.
bio_out
;

1177 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1179 i‡(
	`u∆ikñy
(
io
->
îr‹
 < 0)) {

1180 
	`¸y±_‰ì_buf„r_∑ges
(
cc
, 
˛⁄e
);

1181 
	`bio_put
(
˛⁄e
);

1182 
	`¸y±_dec_≥ndög
(
io
);

1187 
	`BUG_ON
(
io
->
˘x
.
ôî_out
.
bi_size
);

1189 
˛⁄e
->
bi_ôî
.
bi_£˘‹
 = 
cc
->
°¨t
 + 
io
->
£˘‹
;

1191 i‡(
async
)

1192 
	`k¸y±d_queue_io
(
io
);

1194 
	`gíîic_make_ªque°
(
˛⁄e
);

1195 
	}
}

1197 
	$k¸y±d_¸y±_wrôe_c⁄vît
(
dm_¸y±_io
 *
io
)

1199 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1200 
bio
 *
˛⁄e
;

1201 
dm_¸y±_io
 *
√w_io
;

1202 
¸y±_föished
;

1203 
out_of_∑ges
 = 0;

1204 
ªmaöög
 = 
io
->
ba£_bio
->
bi_ôî
.
bi_size
;

1205 
£˘‹_t
 
£˘‹
 = 
io
->sector;

1206 
r
;

1211 
	`¸y±_öc_≥ndög
(
io
);

1212 
	`¸y±_c⁄vît_öô
(
cc
, &
io
->
˘x
, 
NULL
, io->
ba£_bio
, 
£˘‹
);

1218 
ªmaöög
) {

1219 
˛⁄e
 = 
	`¸y±_Æloc_buf„r
(
io
, 
ªmaöög
, &
out_of_∑ges
);

1220 i‡(
	`u∆ikñy
(!
˛⁄e
)) {

1221 
io
->
îr‹
 = -
ENOMEM
;

1225 
io
->
˘x
.
bio_out
 = 
˛⁄e
;

1226 
io
->
˘x
.
ôî_out
 = 
˛⁄e
->
bi_ôî
;

1228 
ªmaöög
 -
˛⁄e
->
bi_ôî
.
bi_size
;

1229 
£˘‹
 +
	`bio_£˘‹s
(
˛⁄e
);

1231 
	`¸y±_öc_≥ndög
(
io
);

1233 
r
 = 
	`¸y±_c⁄vît
(
cc
, &
io
->
˘x
);

1234 i‡(
r
 < 0)

1235 
io
->
îr‹
 = -
EIO
;

1237 
¸y±_föished
 = 
	`©omic_dec_™d_ã°
(&
io
->
˘x
.
cc_≥ndög
);

1240 i‡(
¸y±_föished
) {

1241 
	`k¸y±d_¸y±_wrôe_io_submô
(
io
, 0);

1247 i‡(
	`u∆ikñy
(
r
 < 0))

1250 
io
->
£˘‹
 = sector;

1257 i‡(
	`u∆ikñy
(
out_of_∑ges
))

1258 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/100);

1264 i‡(
	`u∆ikñy
(!
¸y±_föished
 && 
ªmaöög
)) {

1265 
√w_io
 = 
	`mempoﬁ_Æloc
(
cc
->
io_poﬁ
, 
GFP_NOIO
);

1266 
	`¸y±_io_öô
(
√w_io
, 
io
->
cc
, io->
ba£_bio
, 
£˘‹
);

1267 
	`¸y±_öc_≥ndög
(
√w_io
);

1268 
	`¸y±_c⁄vît_öô
(
cc
, &
√w_io
->
˘x
, 
NULL
,

1269 
io
->
ba£_bio
, 
£˘‹
);

1270 
√w_io
->
˘x
.
ôî_ö
 = 
io
->ctx.iter_in;

1276 i‡(!
io
->
ba£_io
)

1277 
√w_io
->
ba£_io
 = 
io
;

1279 
√w_io
->
ba£_io
 = 
io
->base_io;

1280 
	`¸y±_öc_≥ndög
(
io
->
ba£_io
);

1281 
	`¸y±_dec_≥ndög
(
io
);

1284 
io
 = 
√w_io
;

1288 
	`¸y±_dec_≥ndög
(
io
);

1289 
	}
}

1291 
	$k¸y±d_¸y±_ªad_d⁄e
(
dm_¸y±_io
 *
io
)

1293 
	`¸y±_dec_≥ndög
(
io
);

1294 
	}
}

1296 
	$k¸y±d_¸y±_ªad_c⁄vît
(
dm_¸y±_io
 *
io
)

1298 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1299 
r
 = 0;

1301 
	`¸y±_öc_≥ndög
(
io
);

1303 
	`¸y±_c⁄vît_öô
(
cc
, &
io
->
˘x
, io->
ba£_bio
, io->base_bio,

1304 
io
->
£˘‹
);

1306 
r
 = 
	`¸y±_c⁄vît
(
cc
, &
io
->
˘x
);

1307 i‡(
r
 < 0)

1308 
io
->
îr‹
 = -
EIO
;

1310 i‡(
	`©omic_dec_™d_ã°
(&
io
->
˘x
.
cc_≥ndög
))

1311 
	`k¸y±d_¸y±_ªad_d⁄e
(
io
);

1313 
	`¸y±_dec_≥ndög
(
io
);

1314 
	}
}

1316 
	$k¸y±d_async_d⁄e
(
¸y±o_async_ªque°
 *
async_ªq
,

1317 
îr‹
)

1319 
dm_¸y±_ªque°
 *
dmªq
 = 
async_ªq
->
d©a
;

1320 
c⁄vît_c⁄ãxt
 *
˘x
 = 
dmªq
->ctx;

1321 
dm_¸y±_io
 *
io
 = 
	`c⁄èöî_of
(
˘x
, dm_crypt_io, ctx);

1322 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1324 i‡(
îr‹
 =-
EINPROGRESS
) {

1325 
	`com∂ëe
(&
˘x
->
ª°¨t
);

1329 i‡(!
îr‹
 && 
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
po°
)

1330 
îr‹
 = 
cc
->
iv_gí_›s
->
	`po°
(cc, 
	`iv_of_dmªq
(cc, 
dmªq
), dmreq);

1332 i‡(
îr‹
 < 0)

1333 
io
->
îr‹
 = -
EIO
;

1335 
	`¸y±_‰ì_ªq
(
cc
, 
	`ªq_of_dmªq
(cc, 
dmªq
), 
io
->
ba£_bio
);

1337 i‡(!
	`©omic_dec_™d_ã°
(&
˘x
->
cc_≥ndög
))

1340 i‡(
	`bio_d©a_dú
(
io
->
ba£_bio
Ë=
READ
)

1341 
	`k¸y±d_¸y±_ªad_d⁄e
(
io
);

1343 
	`k¸y±d_¸y±_wrôe_io_submô
(
io
, 1);

1344 
	}
}

1346 
	$k¸y±d_¸y±
(
w‹k_°ru˘
 *
w‹k
)

1348 
dm_¸y±_io
 *
io
 = 
	`c⁄èöî_of
(
w‹k
, dm_crypt_io, work);

1350 i‡(
	`bio_d©a_dú
(
io
->
ba£_bio
Ë=
READ
)

1351 
	`k¸y±d_¸y±_ªad_c⁄vît
(
io
);

1353 
	`k¸y±d_¸y±_wrôe_c⁄vît
(
io
);

1354 
	}
}

1356 
	$k¸y±d_queue_¸y±
(
dm_¸y±_io
 *
io
)

1358 
¸y±_c⁄fig
 *
cc
 = 
io
->cc;

1360 
	`INIT_WORK
(&
io
->
w‹k
, 
k¸y±d_¸y±
);

1361 
	`queue_w‹k
(
cc
->
¸y±_queue
, &
io
->
w‹k
);

1362 
	}
}

1367 
	$¸y±_decode_key
(
u8
 *
key
, *
hex
, 
size
)

1369 
buf„r
[3];

1370 
i
;

1372 
buf„r
[2] = '\0';

1374 
i
 = 0; i < 
size
; i++) {

1375 
buf„r
[0] = *
hex
++;

1376 
buf„r
[1] = *
hex
++;

1378 i‡(
	`k°πou8
(
buf„r
, 16, &
key
[
i
]))

1379  -
EINVAL
;

1382 i‡(*
hex
 != '\0')

1383  -
EINVAL
;

1386 
	}
}

1388 
	$¸y±_‰ì_tfms
(
¸y±_c⁄fig
 *
cc
)

1390 
i
;

1392 i‡(!
cc
->
tfms
)

1395 
i
 = 0; i < 
cc
->
tfms_cou¡
; i++)

1396 i‡(
cc
->
tfms
[
i
] && !
	`IS_ERR
(cc->tfms[i])) {

1397 
	`¸y±o_‰ì_ablkcùhî
(
cc
->
tfms
[
i
]);

1398 
cc
->
tfms
[
i
] = 
NULL
;

1401 
	`k‰ì
(
cc
->
tfms
);

1402 
cc
->
tfms
 = 
NULL
;

1403 
	}
}

1405 
	$¸y±_Æloc_tfms
(
¸y±_c⁄fig
 *
cc
, *
cùhîmode
)

1407 
i
;

1408 
îr
;

1410 
cc
->
tfms
 = 
	`kmÆloc
(cc->
tfms_cou¡
 * (
¸y±o_ablkcùhî
 *),

1411 
GFP_KERNEL
);

1412 i‡(!
cc
->
tfms
)

1413  -
ENOMEM
;

1415 
i
 = 0; i < 
cc
->
tfms_cou¡
; i++) {

1416 
cc
->
tfms
[
i
] = 
	`¸y±o_Æloc_ablkcùhî
(
cùhîmode
, 0, 0);

1417 i‡(
	`IS_ERR
(
cc
->
tfms
[
i
])) {

1418 
îr
 = 
	`PTR_ERR
(
cc
->
tfms
[
i
]);

1419 
	`¸y±_‰ì_tfms
(
cc
);

1420  
îr
;

1425 
	}
}

1427 
	$¸y±_£tkey_Æl˝us
(
¸y±_c⁄fig
 *
cc
)

1429 
subkey_size
;

1430 
îr
 = 0, 
i
, 
r
;

1433 
subkey_size
 = (
cc
->
key_size
 - cc->
key_exåa_size
Ë>> 
	`ûog2
(cc->
tfms_cou¡
);

1435 
i
 = 0; i < 
cc
->
tfms_cou¡
; i++) {

1436 
r
 = 
	`¸y±o_ablkcùhî_£tkey
(
cc
->
tfms
[
i
],

1437 
cc
->
key
 + (
i
 * 
subkey_size
),

1438 
subkey_size
);

1439 i‡(
r
)

1440 
îr
 = 
r
;

1443  
îr
;

1444 
	}
}

1446 
	$¸y±_£t_key
(
¸y±_c⁄fig
 *
cc
, *
key
)

1448 
r
 = -
EINVAL
;

1449 
key_°rög_Àn
 = 
	`°æí
(
key
);

1452 i‡(
cc
->
key_size
 !(
key_°rög_Àn
 >> 1))

1453 
out
;

1456 i‡(!
cc
->
key_size
 && 
	`°rcmp
(
key
, "-"))

1457 
out
;

1459 i‡(
cc
->
key_size
 && 
	`¸y±_decode_key
(cc->
key
, key, cc->key_size) < 0)

1460 
out
;

1462 
	`£t_bô
(
DM_CRYPT_KEY_VALID
, &
cc
->
Êags
);

1464 
r
 = 
	`¸y±_£tkey_Æl˝us
(
cc
);

1466 
out
:

1468 
	`mem£t
(
key
, '0', 
key_°rög_Àn
);

1470  
r
;

1471 
	}
}

1473 
	$¸y±_wùe_key
(
¸y±_c⁄fig
 *
cc
)

1475 
	`˛ór_bô
(
DM_CRYPT_KEY_VALID
, &
cc
->
Êags
);

1476 
	`mem£t
(&
cc
->
key
, 0, cc->
key_size
 * (
u8
));

1478  
	`¸y±_£tkey_Æl˝us
(
cc
);

1479 
	}
}

1481 
	$¸y±_då
(
dm_èrgë
 *
ti
)

1483 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1485 
ti
->
¥iv©e
 = 
NULL
;

1487 i‡(!
cc
)

1490 i‡(
cc
->
io_queue
)

1491 
	`de°roy_w‹kqueue
(
cc
->
io_queue
);

1492 i‡(
cc
->
¸y±_queue
)

1493 
	`de°roy_w‹kqueue
(
cc
->
¸y±_queue
);

1495 
	`¸y±_‰ì_tfms
(
cc
);

1497 i‡(
cc
->
bs
)

1498 
	`bio£t_‰ì
(
cc
->
bs
);

1500 i‡(
cc
->
∑ge_poﬁ
)

1501 
	`mempoﬁ_de°roy
(
cc
->
∑ge_poﬁ
);

1502 i‡(
cc
->
ªq_poﬁ
)

1503 
	`mempoﬁ_de°roy
(
cc
->
ªq_poﬁ
);

1504 i‡(
cc
->
io_poﬁ
)

1505 
	`mempoﬁ_de°roy
(
cc
->
io_poﬁ
);

1507 i‡(
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
då
)

1508 
cc
->
iv_gí_›s
->
	`då
(cc);

1510 i‡(
cc
->
dev
)

1511 
	`dm_put_devi˚
(
ti
, 
cc
->
dev
);

1513 
	`kz‰ì
(
cc
->
cùhî
);

1514 
	`kz‰ì
(
cc
->
cùhî_°rög
);

1517 
	`kz‰ì
(
cc
);

1518 
	}
}

1520 
	$¸y±_˘r_cùhî
(
dm_èrgë
 *
ti
,

1521 *
cùhî_ö
, *
key
)

1523 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1524 *
tmp
, *
cùhî
, *
chaömode
, *
ivmode
, *
iv›ts
, *
keycou¡
;

1525 *
cùhî_≠i
 = 
NULL
;

1526 
ªt
 = -
EINVAL
;

1527 
dummy
;

1530 i‡(
	`°rchr
(
cùhî_ö
, '(')) {

1531 
ti
->
îr‹
 = "Bad cipher specification";

1532  -
EINVAL
;

1535 
cc
->
cùhî_°rög
 = 
	`k°rdup
(
cùhî_ö
, 
GFP_KERNEL
);

1536 i‡(!
cc
->
cùhî_°rög
)

1537 
bad_mem
;

1543 
tmp
 = 
cùhî_ö
;

1544 
keycou¡
 = 
	`°r£p
(&
tmp
, "-");

1545 
cùhî
 = 
	`°r£p
(&
keycou¡
, ":");

1547 i‡(!
keycou¡
)

1548 
cc
->
tfms_cou¡
 = 1;

1549 i‡(
	`ssˇnf
(
keycou¡
, "%u%c", &
cc
->
tfms_cou¡
, &
dummy
) != 1 ||

1550 !
	`is_powî_of_2
(
cc
->
tfms_cou¡
)) {

1551 
ti
->
îr‹
 = "Bad cipher key count specification";

1552  -
EINVAL
;

1554 
cc
->
key_∑πs
 = cc->
tfms_cou¡
;

1555 
cc
->
key_exåa_size
 = 0;

1557 
cc
->
cùhî
 = 
	`k°rdup
(cùhî, 
GFP_KERNEL
);

1558 i‡(!
cc
->
cùhî
)

1559 
bad_mem
;

1561 
chaömode
 = 
	`°r£p
(&
tmp
, "-");

1562 
iv›ts
 = 
	`°r£p
(&
tmp
, "-");

1563 
ivmode
 = 
	`°r£p
(&
iv›ts
, ":");

1565 i‡(
tmp
)

1566 
	`DMWARN
("Ignoring unexpectedádditional cipher options");

1572 i‡(!
chaömode
 || (!
	`°rcmp
(chaömode, "∂aö"Ë&& !
ivmode
)) {

1573 
chaömode
 = "cbc";

1574 
ivmode
 = "plain";

1577 i‡(
	`°rcmp
(
chaömode
, "ecb"Ë&& !
ivmode
) {

1578 
ti
->
îr‹
 = "IV mechanismÑequired";

1579  -
EINVAL
;

1582 
cùhî_≠i
 = 
	`kmÆloc
(
CRYPTO_MAX_ALG_NAME
, 
GFP_KERNEL
);

1583 i‡(!
cùhî_≠i
)

1584 
bad_mem
;

1586 
ªt
 = 
	`¢¥ötf
(
cùhî_≠i
, 
CRYPTO_MAX_ALG_NAME
,

1587 "%s(%s)", 
chaömode
, 
cùhî
);

1588 i‡(
ªt
 < 0) {

1589 
	`k‰ì
(
cùhî_≠i
);

1590 
bad_mem
;

1594 
ªt
 = 
	`¸y±_Æloc_tfms
(
cc
, 
cùhî_≠i
);

1595 i‡(
ªt
 < 0) {

1596 
ti
->
îr‹
 = "Errorállocating cryptoÅfm";

1597 
bad
;

1601 
cc
->
iv_size
 = 
	`¸y±o_ablkcùhî_ivsize
(
	`™y_tfm
(cc));

1602 i‡(
cc
->
iv_size
)

1604 
cc
->
iv_size
 = 
	`max
(cc->iv_size,

1605 ()((
u64
Ë/ (
u8
)));

1606 i‡(
ivmode
) {

1607 
	`DMWARN
("Selected cipher doesÇot support IVs");

1608 
ivmode
 = 
NULL
;

1612 i‡(
ivmode
 =
NULL
)

1613 
cc
->
iv_gí_›s
 = 
NULL
;

1614 i‡(
	`°rcmp
(
ivmode
, "plain") == 0)

1615 
cc
->
iv_gí_›s
 = &
¸y±_iv_∂aö_›s
;

1616 i‡(
	`°rcmp
(
ivmode
, "plain64") == 0)

1617 
cc
->
iv_gí_›s
 = &
¸y±_iv_∂aö64_›s
;

1618 i‡(
	`°rcmp
(
ivmode
, "essiv") == 0)

1619 
cc
->
iv_gí_›s
 = &
¸y±_iv_essiv_›s
;

1620 i‡(
	`°rcmp
(
ivmode
, "benbi") == 0)

1621 
cc
->
iv_gí_›s
 = &
¸y±_iv_bíbi_›s
;

1622 i‡(
	`°rcmp
(
ivmode
, "null") == 0)

1623 
cc
->
iv_gí_›s
 = &
¸y±_iv_nuŒ_›s
;

1624 i‡(
	`°rcmp
(
ivmode
, "lmk") == 0) {

1625 
cc
->
iv_gí_›s
 = &
¸y±_iv_lmk_›s
;

1632 i‡(
cc
->
key_size
 % cc->
key_∑πs
) {

1633 
cc
->
key_∑πs
++;

1634 
cc
->
key_exåa_size
 = cc->
key_size
 / cc->
key_∑πs
;

1636 } i‡(
	`°rcmp
(
ivmode
, "tcw") == 0) {

1637 
cc
->
iv_gí_›s
 = &
¸y±_iv_tcw_›s
;

1638 
cc
->
key_∑πs
 += 2;

1639 
cc
->
key_exåa_size
 = cc->
iv_size
 + 
TCW_WHITENING_SIZE
;

1641 
ªt
 = -
EINVAL
;

1642 
ti
->
îr‹
 = "Invalid IV mode";

1643 
bad
;

1647 
ªt
 = 
	`¸y±_£t_key
(
cc
, 
key
);

1648 i‡(
ªt
 < 0) {

1649 
ti
->
îr‹
 = "Error decodingánd setting key";

1650 
bad
;

1654 i‡(
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
˘r
) {

1655 
ªt
 = 
cc
->
iv_gí_›s
->
	`˘r
(cc, 
ti
, 
iv›ts
);

1656 i‡(
ªt
 < 0) {

1657 
ti
->
îr‹
 = "Error creating IV";

1658 
bad
;

1663 i‡(
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
öô
) {

1664 
ªt
 = 
cc
->
iv_gí_›s
->
	`öô
(cc);

1665 i‡(
ªt
 < 0) {

1666 
ti
->
îr‹
 = "Error initialising IV";

1667 
bad
;

1671 
ªt
 = 0;

1672 
bad
:

1673 
	`k‰ì
(
cùhî_≠i
);

1674  
ªt
;

1676 
bad_mem
:

1677 
ti
->
îr‹
 = "Cannotállocate cipher strings";

1678  -
ENOMEM
;

1679 
	}
}

1685 
	$¸y±_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1687 
¸y±_c⁄fig
 *
cc
;

1688 
key_size
, 
›t_∑øms
;

1689 
tm∂l
;

1690 
ªt
;

1691 
size_t
 
iv_size_∑ddög
;

1692 
dm_¨g_£t
 
as
;

1693 c⁄° *
›t_°rög
;

1694 
dummy
;

1696 
dm_¨g
 
_¨gs
[] = {

1700 i‡(
¨gc
 < 5) {

1701 
ti
->
îr‹
 = "NotÉnoughárguments";

1702  -
EINVAL
;

1705 
key_size
 = 
	`°æí
(
¨gv
[1]) >> 1;

1707 
cc
 = 
	`kzÆloc
((*ccË+ 
key_size
 * (
u8
), 
GFP_KERNEL
);

1708 i‡(!
cc
) {

1709 
ti
->
îr‹
 = "CannotállocateÉncryption context";

1710  -
ENOMEM
;

1712 
cc
->
key_size
 = key_size;

1714 
ti
->
¥iv©e
 = 
cc
;

1715 
ªt
 = 
	`¸y±_˘r_cùhî
(
ti
, 
¨gv
[0],árgv[1]);

1716 i‡(
ªt
 < 0)

1717 
bad
;

1719 
ªt
 = -
ENOMEM
;

1720 
cc
->
io_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
MIN_IOS
, 
_¸y±_io_poﬁ
);

1721 i‡(!
cc
->
io_poﬁ
) {

1722 
ti
->
îr‹
 = "Cannotállocate crypt io mempool";

1723 
bad
;

1726 
cc
->
dmªq_°¨t
 = (
ablkcùhî_ªque°
);

1727 
cc
->
dmªq_°¨t
 +
	`¸y±o_ablkcùhî_ªqsize
(
	`™y_tfm
(cc));

1728 
cc
->
dmªq_°¨t
 = 
	`ALIGN
(cc->dmªq_°¨t, 
	`__Æignof__
(
dm_¸y±_ªque°
));

1730 i‡(
	`¸y±o_ablkcùhî_Æignmask
(
	`™y_tfm
(
cc
)Ë< 
CRYPTO_MINALIGN
) {

1732 
iv_size_∑ddög
 = -(
cc
->
dmªq_°¨t
 + (
dm_¸y±_ªque°
))

1733 & 
	`¸y±o_ablkcùhî_Æignmask
(
	`™y_tfm
(
cc
));

1740 
iv_size_∑ddög
 = 
	`¸y±o_ablkcùhî_Æignmask
(
	`™y_tfm
(
cc
));

1743 
cc
->
ªq_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
MIN_IOS
, cc->
dmªq_°¨t
 +

1744 (
dm_¸y±_ªque°
Ë+ 
iv_size_∑ddög
 + 
cc
->
iv_size
);

1745 i‡(!
cc
->
ªq_poﬁ
) {

1746 
ti
->
îr‹
 = "Cannotállocate cryptÑequest mempool";

1747 
bad
;

1750 
cc
->
≥r_bio_d©a_size
 = 
ti
->per_bio_data_size =

1751 
	`ALIGN
((
dm_¸y±_io
Ë+ 
cc
->
dmªq_°¨t
 +

1752 (
dm_¸y±_ªque°
Ë+ 
iv_size_∑ddög
 + 
cc
->
iv_size
,

1753 
ARCH_KMALLOC_MINALIGN
);

1755 
cc
->
∑ge_poﬁ
 = 
	`mempoﬁ_¸óã_∑ge_poﬁ
(
MIN_POOL_PAGES
, 0);

1756 i‡(!
cc
->
∑ge_poﬁ
) {

1757 
ti
->
îr‹
 = "CannotállocateÖage mempool";

1758 
bad
;

1761 
cc
->
bs
 = 
	`bio£t_¸óã
(
MIN_IOS
, 0);

1762 i‡(!
cc
->
bs
) {

1763 
ti
->
îr‹
 = "Cannotállocate crypt bioset";

1764 
bad
;

1767 
ªt
 = -
EINVAL
;

1768 i‡(
	`ssˇnf
(
¨gv
[2], "%Œu%c", &
tm∂l
, &
dummy
) != 1) {

1769 
ti
->
îr‹
 = "Invalid iv_offset sector";

1770 
bad
;

1772 
cc
->
iv_off£t
 = 
tm∂l
;

1774 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[3], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
cc
->
dev
)) {

1775 
ti
->
îr‹
 = "DeviceÜookup failed";

1776 
bad
;

1779 i‡(
	`ssˇnf
(
¨gv
[4], "%Œu%c", &
tm∂l
, &
dummy
) != 1) {

1780 
ti
->
îr‹
 = "Invalid device sector";

1781 
bad
;

1783 
cc
->
°¨t
 = 
tm∂l
;

1785 
¨gv
 += 5;

1786 
¨gc
 -= 5;

1789 i‡(
¨gc
) {

1790 
as
.
¨gc
 =árgc;

1791 
as
.
¨gv
 =árgv;

1793 
ªt
 = 
	`dm_ªad_¨g_group
(
_¨gs
, &
as
, &
›t_∑øms
, &
ti
->
îr‹
);

1794 i‡(
ªt
)

1795 
bad
;

1797 
›t_°rög
 = 
	`dm_shi·_¨g
(&
as
);

1799 i‡(
›t_∑øms
 =1 && 
›t_°rög
 &&

1800 !
	`°rˇ£cmp
(
›t_°rög
, "allow_discards"))

1801 
ti
->
num_disˇrd_bios
 = 1;

1802 i‡(
›t_∑øms
) {

1803 
ªt
 = -
EINVAL
;

1804 
ti
->
îr‹
 = "Invalid featureárguments";

1805 
bad
;

1809 
ªt
 = -
ENOMEM
;

1810 
cc
->
io_queue
 = 
	`Æloc_w‹kqueue
("k¸y±d_io", 
WQ_MEM_RECLAIM
, 1);

1811 i‡(!
cc
->
io_queue
) {

1812 
ti
->
îr‹
 = "Couldn't create kcryptd io queue";

1813 
bad
;

1816 
cc
->
¸y±_queue
 = 
	`Æloc_w‹kqueue
("kcryptd",

1817 
WQ_CPU_INTENSIVE
 | 
WQ_MEM_RECLAIM
, 1);

1818 i‡(!
cc
->
¸y±_queue
) {

1819 
ti
->
îr‹
 = "Couldn't create kcryptd queue";

1820 
bad
;

1823 
ti
->
num_Êush_bios
 = 1;

1824 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

1828 
bad
:

1829 
	`¸y±_då
(
ti
);

1830  
ªt
;

1831 
	}
}

1833 
	$¸y±_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1835 
dm_¸y±_io
 *
io
;

1836 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1843 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_DISCARD
))) {

1844 
bio
->
bi_bdev
 = 
cc
->
dev
->
bdev
;

1845 i‡(
	`bio_£˘‹s
(
bio
))

1846 
bio
->
bi_ôî
.
bi_£˘‹
 = 
cc
->
°¨t
 +

1847 
	`dm_èrgë_off£t
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

1848  
DM_MAPIO_REMAPPED
;

1851 
io
 = 
	`dm_≥r_bio_d©a
(
bio
, 
cc
->
≥r_bio_d©a_size
);

1852 
	`¸y±_io_öô
(
io
, 
cc
, 
bio
, 
	`dm_èrgë_off£t
(
ti
, bio->
bi_ôî
.
bi_£˘‹
));

1853 
io
->
˘x
.
ªq
 = (
ablkcùhî_ªque°
 *)(io + 1);

1855 i‡(
	`bio_d©a_dú
(
io
->
ba£_bio
Ë=
READ
) {

1856 i‡(
	`k¸y±d_io_ªad
(
io
, 
GFP_NOWAIT
))

1857 
	`k¸y±d_queue_io
(
io
);

1859 
	`k¸y±d_queue_¸y±
(
io
);

1861  
DM_MAPIO_SUBMITTED
;

1862 
	}
}

1864 
	$¸y±_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1865 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1867 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1868 
i
, 
sz
 = 0;

1870 
ty≥
) {

1871 
STATUSTYPE_INFO
:

1872 
ªsu…
[0] = '\0';

1875 
STATUSTYPE_TABLE
:

1876 
	`DMEMIT
("%†", 
cc
->
cùhî_°rög
);

1878 i‡(
cc
->
key_size
 > 0)

1879 
i
 = 0; i < 
cc
->
key_size
; i++)

1880 
	`DMEMIT
("%02x", 
cc
->
key
[
i
]);

1882 
	`DMEMIT
("-");

1884 
	`DMEMIT
(" %Œu %†%Œu", ()
cc
->
iv_off£t
,

1885 
cc
->
dev
->
«me
, ()cc->
°¨t
);

1887 i‡(
ti
->
num_disˇrd_bios
)

1888 
	`DMEMIT
(" 1állow_discards");

1892 
	}
}

1894 
	$¸y±_po°su•íd
(
dm_èrgë
 *
ti
)

1896 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1898 
	`£t_bô
(
DM_CRYPT_SUSPENDED
, &
cc
->
Êags
);

1899 
	}
}

1901 
	$¸y±_¥îesume
(
dm_èrgë
 *
ti
)

1903 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1905 i‡(!
	`ã°_bô
(
DM_CRYPT_KEY_VALID
, &
cc
->
Êags
)) {

1906 
	`DMERR
("abortingÑesume - crypt key isÇot set.");

1907  -
EAGAIN
;

1911 
	}
}

1913 
	$¸y±_ªsume
(
dm_èrgë
 *
ti
)

1915 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1917 
	`˛ór_bô
(
DM_CRYPT_SUSPENDED
, &
cc
->
Êags
);

1918 
	}
}

1924 
	$¸y±_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1926 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1927 
ªt
 = -
EINVAL
;

1929 i‡(
¨gc
 < 2)

1930 
îr‹
;

1932 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "key")) {

1933 i‡(!
	`ã°_bô
(
DM_CRYPT_SUSPENDED
, &
cc
->
Êags
)) {

1934 
	`DMWARN
("not suspended during key manipulation.");

1935  -
EINVAL
;

1937 i‡(
¨gc
 =3 && !
	`°rˇ£cmp
(
¨gv
[1], "set")) {

1938 
ªt
 = 
	`¸y±_£t_key
(
cc
, 
¨gv
[2]);

1939 i‡(
ªt
)

1940  
ªt
;

1941 i‡(
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
öô
)

1942 
ªt
 = 
cc
->
iv_gí_›s
->
	`öô
(cc);

1943  
ªt
;

1945 i‡(
¨gc
 =2 && !
	`°rˇ£cmp
(
¨gv
[1], "wipe")) {

1946 i‡(
cc
->
iv_gí_›s
 && cc->iv_gí_›s->
wùe
) {

1947 
ªt
 = 
cc
->
iv_gí_›s
->
	`wùe
(cc);

1948 i‡(
ªt
)

1949  
ªt
;

1951  
	`¸y±_wùe_key
(
cc
);

1955 
îr‹
:

1956 
	`DMWARN
("unrecognised messageÑeceived.");

1957  -
EINVAL
;

1958 
	}
}

1960 
	$¸y±_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

1961 
bio_vec
 *
biovec
, 
max_size
)

1963 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1964 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
cc
->
dev
->
bdev
);

1966 i‡(!
q
->
mîge_bvec_‚
)

1967  
max_size
;

1969 
bvm
->
bi_bdev
 = 
cc
->
dev
->
bdev
;

1970 
bvm
->
bi_£˘‹
 = 
cc
->
°¨t
 + 
	`dm_èrgë_off£t
(
ti
, bvm->bi_sector);

1972  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

1973 
	}
}

1975 
	$¸y±_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1976 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1978 
¸y±_c⁄fig
 *
cc
 = 
ti
->
¥iv©e
;

1980  
	`‚
(
ti
, 
cc
->
dev
, cc->
°¨t
,Åi->
Àn
, 
d©a
);

1981 
	}
}

1983 
èrgë_ty≥
 
	g¸y±_èrgë
 = {

1984 .
«me
 = "crypt",

1985 .
	gvîsi⁄
 = {1, 13, 0},

1986 .
	gmoduÀ
 = 
THIS_MODULE
,

1987 .
	g˘r
 = 
¸y±_˘r
,

1988 .
	gdå
 = 
¸y±_då
,

1989 .
	gm≠
 = 
¸y±_m≠
,

1990 .
	g°©us
 = 
¸y±_°©us
,

1991 .
	gpo°su•íd
 = 
¸y±_po°su•íd
,

1992 .
	g¥îesume
 = 
¸y±_¥îesume
,

1993 .
	gªsume
 = 
¸y±_ªsume
,

1994 .
	gmesßge
 = 
¸y±_mesßge
,

1995 .
	gmîge
 = 
¸y±_mîge
,

1996 .
	gôî©e_devi˚s
 = 
¸y±_ôî©e_devi˚s
,

1999 
__öô
 
	$dm_¸y±_öô
()

2001 
r
;

2003 
_¸y±_io_poﬁ
 = 
	`KMEM_CACHE
(
dm_¸y±_io
, 0);

2004 i‡(!
_¸y±_io_poﬁ
)

2005  -
ENOMEM
;

2007 
r
 = 
	`dm_ªgi°î_èrgë
(&
¸y±_èrgë
);

2008 i‡(
r
 < 0) {

2009 
	`DMERR
("ªgi°î faûed %d", 
r
);

2010 
	`kmem_ˇche_de°roy
(
_¸y±_io_poﬁ
);

2013  
r
;

2014 
	}
}

2016 
__exô
 
	$dm_¸y±_exô
()

2018 
	`dm_uƒegi°î_èrgë
(&
¸y±_èrgë
);

2019 
	`kmem_ˇche_de°roy
(
_¸y±_io_poﬁ
);

2020 
	}
}

2022 
moduÀ_öô
(
dm_¸y±_öô
);

2023 
moduÀ_exô
(
dm_¸y±_exô
);

2025 
MODULE_AUTHOR
("Jana Saout <jana@saout.de>");

2026 
MODULE_DESCRIPTION
(
DM_NAME
 "Åarget forÅransparentÉncryption / decryption");

2027 
MODULE_LICENSE
("GPL");

	@dm-crypt.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

25 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

26 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

27 { 0x66051eb6, 
__VMLINUX_SYMBOL_STR
(
¸y±o_Æloc_ba£
) },

28 { 0x82cb7df, 
__VMLINUX_SYMBOL_STR
(
¸y±o_Æloc_shash
) },

29 { 0x64999478, 
__VMLINUX_SYMBOL_STR
(
c⁄ge°i⁄_waô
) },

30 { 0xd14e5bc6, 
__VMLINUX_SYMBOL_STR
(
bio_add_∑ge
) },

31 { 0x3d69f5a0, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

32 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

33 { 0x4b06d2e7, 
__VMLINUX_SYMBOL_STR
(
com∂ëe
) },

34 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

35 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

36 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

37 { 0x6d0aba34, 
__VMLINUX_SYMBOL_STR
(
waô_f‹_com∂ëi⁄
) },

38 { 0xc897c382, 
__VMLINUX_SYMBOL_STR
(
sg_öô_èbÀ
) },

39 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

40 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

41 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

42 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

43 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

44 { 0x155cb2eb, 
__VMLINUX_SYMBOL_STR
(
bio£t_¸óã
) },

45 { 0x53326531, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_∑ges
) },

46 { 0xd985dc99, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_∑ges
) },

47 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

48 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

49 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

50 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

51 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

52 { 0xed4baf13, 
__VMLINUX_SYMBOL_STR
(
¸y±o_Æloc_ablkcùhî
) },

53 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢¥ötf
) },

54 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

55 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

56 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

57 { 0x85df9b6c, 
__VMLINUX_SYMBOL_STR
(
°r£p
) },

58 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

59 { 0x349cba85, 
__VMLINUX_SYMBOL_STR
(
°rchr
) },

60 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

61 { 0xb6244511, 
__VMLINUX_SYMBOL_STR
(
sg_öô_⁄e
) },

62 { 0x4629334c, 
__VMLINUX_SYMBOL_STR
(
__¥ìm±_cou¡
) },

63 { 0xf7026158, 
__VMLINUX_SYMBOL_STR
(
¸y±o_shash_föÆ
) },

64 { 0xfdc8de49, 
__VMLINUX_SYMBOL_STR
(
¸y±o_shash_upd©e
) },

65 { 0x8810ad5e, 
__VMLINUX_SYMBOL_STR
(
¸y±o_x‹
) },

66 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

67 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

68 { 0x6ab31aba, 
__VMLINUX_SYMBOL_STR
(
bio£t_‰ì
) },

69 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

70 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

71 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

72 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

73 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

74 { 0x7a4497db, 
__VMLINUX_SYMBOL_STR
(
kz‰ì
) },

75 { 0x18489876, 
__VMLINUX_SYMBOL_STR
(
¸y±o_de°roy_tfm
) },

76 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

77 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

78 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

79 { 0xa068´96, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_bio£t
) },

80 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

81 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

82 { 0x5f005368, 
__VMLINUX_SYMBOL_STR
(
k°πou8
) },

83 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
°æí
) },

84 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

85 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

86 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

89 c⁄° 
	g__moduÀ_dïíds
[]

90 
__u£d


91 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

95 
MODULE_INFO
(
§cvîsi⁄
, "3337089129FD0E57B4E6DF5");

	@dm-dedup-backend.h

13 #i‚de‡
BACKEND_H


14 
	#BACKEND_H


	)

16 
	gmëad©a
;

17 
	gkv°‹e
;

19 
	#BF_NEGATIVE
 -1

	)

20 
	#BF_POSITIVE
 0

	)

22 
	smëad©a_›s
 {

27 
	mmëad©a
 * (*
	möô_mëa
)(*
	möô_∑øm
, 
boﬁ
 *
	munf‹m©ãd
);

29 (*
	mexô_mëa
)(
mëad©a
 *
	mmd
);

41 
	mkv°‹e
 * (*
	mkvs_¸óã_löór
)(
mëad©a
 *
	mmd
,

42 
uöt32_t
 
	mksize
, uöt32_à
	mvsize
, uöt32_à
	mkmax
,

43 
boﬁ
 
	munf‹m©ãd
);

54 
	mkv°‹e
 * (*
	mkvs_¸óã_•¨£
)(
mëad©a
 *
	mmd
,

55 
uöt32_t
 
	mksize
, uöt32_à
	mvsize
, uöt32_à
	mknummax
,

56 
boﬁ
 
	munf‹m©ãd
);

63 (*
	mÆloc_d©a_block
)(
mëad©a
 *
	mmd
, 
uöt64_t
 *
	mblockn
);

69 (*
	möc_ªfcou¡
)(
mëad©a
 *
	mmd
, 
uöt64_t
 
	mblockn
);

75 (*
	mdec_ªfcou¡
)(
mëad©a
 *
	mmd
, 
uöt64_t
 
	mblockn
);

81 (*
	mgë_ªfcou¡
)(
mëad©a
 *
	mmd
, 
uöt64_t
 
	mblockn
);

87 (*
	mÊush_mëa
)(
mëad©a
 *
	mmd
);

95 (*
	mgë_¥iv©e_d©a
)(
mëad©a
 *
	mmd
, **
	md©a
,

96 
uöt32_t
 
	msize
);

104 (*
	m£t_¥iv©e_d©a
)(
mëad©a
 *
	mmd
, *
	md©a
, 
uöt32_t
 
	msize
);

111 (*
	mÊush_bufio_ˇche
)(
mëad©a
 *
	mmd
);

	@dm-dedup-cbt.c

13 
	~<löux/î∫o.h
>

14 
	~"≥rsi°ít-d©a/dm-båì.h
"

15 
	~"≥rsi°ít-d©a/dm-•a˚-m≠.h
"

16 
	~"≥rsi°ít-d©a/dm-•a˚-m≠-disk.h
"

17 
	~"≥rsi°ít-d©a/dm-block-m™agî.h
"

18 
	~"≥rsi°ít-d©a/dm-å™ß˘i⁄-m™agî.h
"

20 
	~"dm-dedup-cbt.h
"

21 
	~"dm-dedup-backíd.h
"

22 
	~"dm-dedup-kv°‹e.h
"

24 
	#EMPTY_ENTRY
 -5

	)

25 
	#DELETED_ENTRY
 -6

	)

27 
	#UINT32_MAX
 (4294967295U)

	)

29 
	#METADATA_BSIZE
 4096

	)

30 
	#METADATA_CACHESIZE
 64

	)

31 
	#METADATA_MAXLOCKS
 5

	)

32 
	#METADATA_SUPERBLOCK_LOCATION
 0

	)

34 
	smëad©a
 {

35 
dm_block_m™agî
 *
	mmëa_bm
;

36 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

37 
dm_•a˚_m≠
 *
	md©a_sm
;

38 
dm_•a˚_m≠
 *
	mmëa_sm
;

43 
kv°‹e_cbt
 *
	mkvs_löór
;

44 
kv°‹e_cbt
 *
	mkvs_•¨£
;

47 
	skv°‹e_cbt
 {

48 
kv°‹e
 
	mckvs
;

49 
uöt32_t
 
	míåy_size
;

51 
dm_båì_öfo
 
	möfo
;

52 
uöt64_t
 
	mroŸ
;

55 
	#SPACE_MAP_ROOT_SIZE
 128

	)

57 
	smëad©a_su≥rblock
 {

58 
__À32
 
	mcsum
;

59 
__À32
 
	mÊags
;

60 
__À64
 
	mblockƒ
;

61 
__u8
 
	muuid
[16];

62 
__À64
 
	mmagic
;

63 
__À32
 
	mvîsi⁄
;

64 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

66 
__u8
 
	md©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

67 
__À64
 
	mlbn_pbn_roŸ
;

68 
__À64
 
	mhash_pbn_roŸ
;

69 
__À32
 
	md©a_block_size
;

70 
__À32
 
	mmëad©a_block_size
;

71 
__À64
 
	mmëad©a_ƒ_blocks
;

72 } 
	g__∑cked
;

74 
	$__begö_å™ß˘i⁄
(
mëad©a
 *
md
)

76 
r
;

77 
mëad©a_su≥rblock
 *
disk_su≥r
;

78 
dm_block
 *
sblock
;

80 
r
 = 
	`dm_bm_ªad_lock
(
md
->
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

81 
NULL
, &
sblock
);

82 i‡(
r
)

83  
r
;

85 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

87 i‡(
md
->
kvs_löór
)

88 
md
->
kvs_löór
->
roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->
lbn_pbn_roŸ
);

90 i‡(
md
->
kvs_•¨£
)

91 
md
->
kvs_•¨£
->
roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->
hash_pbn_roŸ
);

93 
	`dm_bm_u∆ock
(
sblock
);

95  
r
;

96 
	}
}

98 
	$__commô_å™ß˘i⁄
(
mëad©a
 *
md
)

100 
r
 = 0;

101 
size_t
 
mëad©a_Àn
, 
d©a_Àn
;

102 
mëad©a_su≥rblock
 *
disk_su≥r
;

103 
dm_block
 *
sblock
;

105 
	`BUILD_BUG_ON
((
mëad©a_su≥rblock
) > 512);

107 
r
 = 
	`dm_sm_commô
(
md
->
d©a_sm
);

108 i‡(
r
 < 0)

109 
out
;

111 
r
 = 
	`dm_tm_¥e_commô
(
md
->
tm
);

112 i‡(
r
 < 0)

113 
out
;

115 
r
 = 
	`dm_sm_roŸ_size
(
md
->
mëa_sm
, &
mëad©a_Àn
);

116 i‡(
r
 < 0)

117 
out
;

119 
r
 = 
	`dm_sm_roŸ_size
(
md
->
d©a_sm
, &
d©a_Àn
);

120 i‡(
r
 < 0)

121 
out
;

123 
r
 = 
	`dm_bm_wrôe_lock
(
md
->
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

124 
NULL
, &
sblock
);

125 i‡(
r
)

126 
out
;

128 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

130 i‡(
md
->
kvs_löór
)

131 
disk_su≥r
->
lbn_pbn_roŸ
 = 
	`˝u_to_À64
(
md
->
kvs_löór
->
roŸ
);

133 i‡(
md
->
kvs_•¨£
)

134 
disk_su≥r
->
hash_pbn_roŸ
 = 
	`˝u_to_À64
(
md
->
kvs_•¨£
->
roŸ
);

136 
r
 = 
	`dm_sm_c›y_roŸ
(
md
->
mëa_sm
,

137 &
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
, 
mëad©a_Àn
);

138 i‡(
r
 < 0)

139 
out_locked
;

141 
r
 = 
	`dm_sm_c›y_roŸ
(
md
->
d©a_sm
, &
disk_su≥r
->
d©a_•a˚_m≠_roŸ
,

142 
d©a_Àn
);

143 i‡(
r
 < 0)

144 
out_locked
;

146 
r
 = 
	`dm_tm_commô
(
md
->
tm
, 
sblock
);

148 
out
:

149  
r
;

151 
out_locked
:

152 
	`dm_bm_u∆ock
(
sblock
);

153  
r
;

154 
	}
}

156 
	$wrôe_öôül_su≥rblock
(
mëad©a
 *
md
)

158 
r
;

159 
size_t
 
mëa_Àn
, 
d©a_Àn
;

160 
dm_block
 *
sblock
;

161 
mëad©a_su≥rblock
 *
disk_su≥r
;

163 
r
 = 
	`dm_sm_roŸ_size
(
md
->
mëa_sm
, &
mëa_Àn
);

164 i‡(
r
 < 0)

165  
r
;

167 
r
 = 
	`dm_sm_roŸ_size
(
md
->
d©a_sm
, &
d©a_Àn
);

168 i‡(
r
 < 0)

169  
r
;

171 
r
 = 
	`dm_sm_commô
(
md
->
d©a_sm
);

172 i‡(
r
 < 0)

173  
r
;

175 
r
 = 
	`dm_tm_¥e_commô
(
md
->
tm
);

176 i‡(
r
 < 0)

177  
r
;

179 
r
 = 
	`dm_bm_wrôe_lock_zîo
(
md
->
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

180 
NULL
, &
sblock
);

181 i‡(
r
 < 0)

182  
r
;

184 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

186 
r
 = 
	`dm_sm_c›y_roŸ
(
md
->
mëa_sm
, &
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
,

187 
mëa_Àn
);

188 i‡(
r
 < 0)

189 
bad_locked
;

191 
r
 = 
	`dm_sm_c›y_roŸ
(
md
->
d©a_sm
, &
disk_su≥r
->
d©a_•a˚_m≠_roŸ
,

192 
d©a_Àn
);

193 i‡(
r
 < 0)

194 
bad_locked
;

196  
	`dm_tm_commô
(
md
->
tm
, 
sblock
);

198 
bad_locked
:

199 
	`dm_bm_u∆ock
(
sblock
);

200  
r
;

201 
	}
}

203 
	$su≥rblock_Æl_zî€s
(
dm_block_m™agî
 *
bm
, 
boﬁ
 *
ªsu…
)

205 
r
;

206 
i
;

207 
dm_block
 *
b
;

208 
__À64
 *
d©a_À
, 
zîo
 = 
	`˝u_to_À64
(0);

209 
sb_block_size
 = 
	`dm_bm_block_size
(
bm
Ë/ (
__À64
);

214 
r
 = 
	`dm_bm_ªad_lock
(
bm
, 
METADATA_SUPERBLOCK_LOCATION
, 
NULL
, &
b
);

215 i‡(
r
)

216  
r
;

218 
d©a_À
 = 
	`dm_block_d©a
(
b
);

219 *
ªsu…
 = 
åue
;

220 
i
 = 0; i < 
sb_block_size
; i++) {

221 i‡(
d©a_À
[
i
] !
zîo
) {

222 *
ªsu…
 = 
Ál£
;

227  
	`dm_bm_u∆ock
(
b
);

228 
	}
}

230 
mëad©a
 *
	$öô_mëa_cowbåì
(*
öput_∑øm
, 
boﬁ
 *
unf‹m©ãd
)

232 
ªt
;

233 
mëad©a
 *
md
;

234 
dm_block_m™agî
 *
mëa_bm
;

235 
dm_•a˚_m≠
 *
mëa_sm
;

236 
dm_•a˚_m≠
 *
d©a_sm
 = 
NULL
;

237 
dm_å™ß˘i⁄_m™agî
 *
tm
;

238 
öô_∑øm_cowbåì
 *
p
 =

239 (
öô_∑øm_cowbåì
 *)
öput_∑øm
;

241 
	`DMINFO
("Initializing COWBTREE backend");

243 
md
 = 
	`kzÆloc
((*md), 
GFP_NOIO
);

244 i‡(!
md
)

245  
	`ERR_PTR
(-
ENOMEM
);

247 
mëa_bm
 = 
	`dm_block_m™agî_¸óã
(
p
->
mëad©a_bdev
, 
METADATA_BSIZE
,

248 
METADATA_CACHESIZE
, 
METADATA_MAXLOCKS
);

249 i‡(
	`IS_ERR
(
mëa_bm
)) {

250 
md
 = (
mëad©a
 *)
mëa_bm
;

251 
badbm
;

254 
ªt
 = 
	`su≥rblock_Æl_zî€s
(
mëa_bm
, 
unf‹m©ãd
);

255 i‡(
ªt
) {

256 
md
 = 
	`ERR_PTR
(
ªt
);

257 
badtm
;

260 i‡(!*
unf‹m©ãd
) {

261 
dm_block
 *
sblock
;

262 
mëad©a_su≥rblock
 *
disk_su≥r
;

264 
md
->
mëa_bm
 = meta_bm;

266 
ªt
 = 
	`dm_bm_ªad_lock
(
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

267 
NULL
, &
sblock
);

268 i‡(
ªt
 < 0) {

269 
	`DMERR
("couldÇotÑead_lock superblock");

273 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

275 
ªt
 = 
	`dm_tm_›í_wôh_sm
(
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

276 
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
,

277 (
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
),

278 &
md
->
tm
, &md->
mëa_sm
);

279 i‡(
ªt
 < 0) {

280 
	`DMERR
("couldÇot open_with_sm superblock");

285 
md
->
d©a_sm
 = 
	`dm_sm_disk_›í
(md->
tm
, 
disk_su≥r
->
d©a_•a˚_m≠_roŸ
,

286 (
disk_su≥r
->
d©a_•a˚_m≠_roŸ
));

287 i‡(
	`IS_ERR
(
md
->
d©a_sm
)) {

288 
	`DMERR
("dm_disk_open failed");

292 
	`dm_bm_u∆ock
(
sblock
);

294 
begö_å™s
;

297 
ªt
 = 
	`dm_tm_¸óã_wôh_sm
(
mëa_bm
, 
METADATA_SUPERBLOCK_LOCATION
,

298 &
tm
, &
mëa_sm
);

299 i‡(
ªt
 < 0) {

300 
md
 = 
	`ERR_PTR
(
ªt
);

301 
badtm
;

304 
d©a_sm
 = 
	`dm_sm_disk_¸óã
(
tm
, 
p
->
blocks
);

305 i‡(
	`IS_ERR
(
d©a_sm
)) {

306 
md
 = (
mëad©a
 *)
d©a_sm
;

307 
badsm
;

310 
md
->
mëa_bm
 = meta_bm;

311 
md
->
tm
 =Åm;

312 
md
->
mëa_sm
 = meta_sm;

313 
md
->
d©a_sm
 = data_sm;

315 
ªt
 = 
	`wrôe_öôül_su≥rblock
(
md
);

316 i‡(
ªt
 < 0) {

317 
md
 = 
	`ERR_PTR
(
ªt
);

318 
badwrôesu≥r
;

321 
begö_å™s
:

322 
ªt
 = 
	`__begö_å™ß˘i⁄
(
md
);

323 i‡(
ªt
 < 0) {

324 
md
 = 
	`ERR_PTR
(
ªt
);

325 
badwrôesu≥r
;

328 
md
->
kvs_löór
 = 
NULL
;

329 
md
->
kvs_•¨£
 = 
NULL
;

331  
md
;

333 
badwrôesu≥r
:

334 
	`dm_sm_de°roy
(
d©a_sm
);

335 
badsm
:

336 
	`dm_tm_de°roy
(
tm
);

337 
	`dm_sm_de°roy
(
mëa_sm
);

338 
badtm
:

339 
	`dm_block_m™agî_de°roy
(
mëa_bm
);

340 
badbm
:

341 
	`k‰ì
(
md
);

342  
md
;

343 
	}
}

345 
	$exô_mëa_cowbåì
(
mëad©a
 *
md
)

347 
ªt
;

349 
ªt
 = 
	`__commô_å™ß˘i⁄
(
md
);

350 i‡(
ªt
 < 0)

351 
	`DMWARN
("%s: __commit_transaction() failed,Érror = %d.",

352 
__func__
, 
ªt
);

354 
	`dm_sm_de°roy
(
md
->
d©a_sm
);

355 
	`dm_tm_de°roy
(
md
->
tm
);

356 
	`dm_sm_de°roy
(
md
->
mëa_sm
);

357 
	`dm_block_m™agî_de°roy
(
md
->
mëa_bm
);

359 
	`k‰ì
(
md
->
kvs_löór
);

360 
	`k‰ì
(
md
->
kvs_•¨£
);

362 
	`k‰ì
(
md
);

363 
	}
}

365 
	$Êush_mëa_cowbåì
(
mëad©a
 *
md
)

367 
r
;

369 
r
 = 
	`__commô_å™ß˘i⁄
(
md
);

370 i‡(
r
 < 0)

371  
r
;

373 
r
 = 
	`__begö_å™ß˘i⁄
(
md
);

375  
r
;

376 
	}
}

382 
	$Æloc_d©a_block_cowbåì
(
mëad©a
 *
md
, 
uöt64_t
 *
blockn
)

385  
	`dm_sm_√w_block
(
md
->
d©a_sm
, 
blockn
);

386 
	}
}

388 
	$öc_ªfcou¡_cowbåì
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

390  
	`dm_sm_öc_block
(
md
->
d©a_sm
, 
blockn
);

391 
	}
}

393 
	$dec_ªfcou¡_cowbåì
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

395  
	`dm_sm_dec_block
(
md
->
d©a_sm
, 
blockn
);

396 
	}
}

398 
	$gë_ªfcou¡_cowbåì
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

400 
uöt32_t
 
ªfcou¡
;

401 
r
;

403 
r
 = 
	`dm_sm_gë_cou¡
(
md
->
d©a_sm
, 
blockn
, &
ªfcou¡
);

404 i‡(
r
 < 0)

405  
r
;

407  ()
ªfcou¡
;

408 
	}
}

414 
	$kvs_dñëe_löór_cowbåì
(
kv°‹e
 *
kvs
,

415 *
key
, 
öt32_t
 
ksize
)

417 
r
;

418 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

420 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

422 i‡(
ksize
 !
kvs
->ksize)

423  -
EINVAL
;

425 
r
 = 
	`dm_båì_ªmove
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, 
key
, &(kvcbt->root));

427 i‡(
r
 =-
ENODATA
)

428  -
ENODEV
;

429 i‡(
r
 >= 0)

432  
r
;

433 
	}
}

440 
	$kvs_lookup_löór_cowbåì
(
kv°‹e
 *
kvs
, *
key
,

441 
öt32_t
 
ksize
, *
vÆue
, i¡32_à*
vsize
)

443 
r
;

444 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

446 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

448 i‡(
ksize
 !
kvs
->ksize)

449  -
EINVAL
;

451 
r
 = 
	`dm_båì_lookup
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, 
key
, 
vÆue
);

453 i‡(
r
 =-
ENODATA
)

455 i‡(
r
 >= 0)

458  
r
;

459 
	}
}

465 
kvs_ôî©e_löór_cowbåì
(
kv°‹e
 *
kvs
,

466 (*
‚
)(*
c⁄ãxt
, 
uöt64_t
 *
keys
, *
Àaf
),

467 *
c⁄ãxt
)

469 
r
;

470 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

472 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

474 
r
 =
	`dm_båì_wÆk
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, 
‚
, 
c⁄ãxt
);

475 i‡(
r
 =-
ENODATA
)

477 i‡(
r
 >= 0)

480  
r
;

481 
	}
}

538 
	$kvs_ö£π_löór_cowbåì
(
kv°‹e
 *
kvs
, *
key
,

539 
öt32_t
 
ksize
, *
vÆue
,

540 
öt32_t
 
vsize
)

542 
ö£πed
;

543 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

545 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

547 i‡(
ksize
 !
kvs
->ksize)

548  -
EINVAL
;

550 i‡(
vsize
 !
kvs
->vsize)

551  -
EINVAL
;

553 
	`__dm_bÀss_f‹_disk
(
vÆue
);

554  
	`dm_båì_ö£π_nŸify
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, 
key
,

555 
vÆue
, &(
kvcbt
->
roŸ
), &
ö£πed
);

557 
	}
}

559 
kv°‹e
 * 
	$kvs_¸óã_löór_cowbåì
(
mëad©a
 *
md
,

560 
uöt32_t
 
ksize
, uöt32_à
vsize
, uöt32_à
kmax
,

561 
boﬁ
 
unf‹m©ãd
)

563 
kv°‹e_cbt
 *
kvs
;

564 
r
;

566 i‡(!
vsize
 || !
ksize
)

567  
	`ERR_PTR
(-
ENOTSUPP
);

570 i‡(
ksize
 != 8)

571  
	`ERR_PTR
(-
ENOTSUPP
);

574 i‡(
md
->
kvs_löór
)

575  
	`ERR_PTR
(-
EBUSY
);

577 
kvs
 = 
	`kmÆloc
((*kvs), 
GFP_NOIO
);

578 i‡(!
kvs
)

579  
	`ERR_PTR
(-
ENOMEM
);

581 
kvs
->
ckvs
.
ksize
 = ksize;

582 
kvs
->
ckvs
.
vsize
 = vsize;

584 
kvs
->
öfo
.
tm
 = 
md
->tm;

585 
kvs
->
öfo
.
Àvñs
 = 1;

586 
kvs
->
öfo
.
vÆue_ty≥
.
c⁄ãxt
 = 
NULL
;

587 
kvs
->
öfo
.
vÆue_ty≥
.
size
 = 
vsize
;

588 
kvs
->
öfo
.
vÆue_ty≥
.
öc
 = 
NULL
;

589 
kvs
->
öfo
.
vÆue_ty≥
.
dec
 = 
NULL
;

590 
kvs
->
öfo
.
vÆue_ty≥
.
equÆ
 = 
NULL
;

592 i‡(!
unf‹m©ãd
) {

593 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_löór_cowbåì
;

594 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_löór_cowbåì
;

595 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_löór_cowbåì
;

596 
kvs
->
ckvs
.
kvs_ôî©e
 = 
kvs_ôî©e_löór_cowbåì
;

598 
md
->
kvs_löór
 = 
kvs
;

599 
	`__begö_å™ß˘i⁄
(
md
);

601 
r
 = 
	`dm_båì_em±y
(&(
kvs
->
öfo
), &(kvs->
roŸ
));

602 i‡(
r
 < 0) {

603 
kvs
 = 
	`ERR_PTR
(
r
);

604 
badåì
;

608 
	`Êush_mëa_cowbåì
(
md
);

610 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_löór_cowbåì
;

611 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_löór_cowbåì
;

612 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_löór_cowbåì
;

613 
kvs
->
ckvs
.
kvs_ôî©e
 = 
kvs_ôî©e_löór_cowbåì
;

615 
md
->
kvs_löór
 = 
kvs
;

618  &(
kvs
->
ckvs
);

620 
badåì
:

621 
	`k‰ì
(
kvs
);

622  (
kv°‹e
 *Ë
kvs
;

623 
	}
}

629 
	$kvs_dñëe_•¨£_cowbåì
(
kv°‹e
 *
kvs
,

630 *
key
, 
öt32_t
 
ksize
)

632 *
íåy
;

633 
uöt64_t
 
key_vÆ
;

634 
r
;

635 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

637 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

639 i‡(
ksize
 !
kvs
->ksize)

640  -
EINVAL
;

642 
íåy
 = 
	`kmÆloc
(
kvcbt
->
íåy_size
, 
GFP_NOIO
);

643 i‡(!
íåy
)

644  -
ENOMEM
;

646 
key_vÆ
 = (*(
uöt64_t
 *)
key
);

648 
ª≥©
:

650 
r
 = 
	`dm_båì_lookup
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, &
key_vÆ
, 
íåy
);

651 i‡(
r
 =-
ENODATA
)

652  -
ENODEV
;

653 i‡(
r
 >= 0) {

654 i‡(!
	`memcmp
(
íåy
, 
key
, 
ksize
)) {

655 
r
 = 
	`dm_båì_ªmove
(&(
kvcbt
->
öfo
),

656 
kvcbt
->
roŸ
, &
key_vÆ
, &(kvcbt->root));

657 
	`k‰ì
(
íåy
);

658  
r
;

660 
key_vÆ
++;

661 
ª≥©
;

663 
	`k‰ì
(
íåy
);

664  
r
;

666 
	}
}

673 
	$kvs_lookup_•¨£_cowbåì
(
kv°‹e
 *
kvs
, *
key
,

674 
öt32_t
 
ksize
, *
vÆue
, i¡32_à*
vsize
)

676 *
íåy
;

677 
uöt64_t
 
key_vÆ
;

678 
r
;

679 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

681 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

683 i‡(
ksize
 !
kvs
->ksize)

684  -
EINVAL
;

686 
íåy
 = 
	`kmÆloc
(
kvcbt
->
íåy_size
, 
GFP_NOIO
);

687 i‡(!
íåy
)

688  -
ENOMEM
;

690 
key_vÆ
 = (*(
uöt64_t
 *)
key
);

692 
ª≥©
:

694 
r
 = 
	`dm_båì_lookup
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, &
key_vÆ
, 
íåy
);

695 i‡(
r
 =-
ENODATA
) {

696 
	`k‰ì
(
íåy
);

698 } i‡(
r
 >= 0) {

699 i‡(!
	`memcmp
(
íåy
, 
key
, 
ksize
)) {

700 
	`mem˝y
(
vÆue
, 
íåy
 + 
ksize
, 
kvs
->
vsize
);

701 
	`k‰ì
(
íåy
);

704 
key_vÆ
++;

705 
ª≥©
;

707 
	`k‰ì
(
íåy
);

708  
r
;

710 
	}
}

712 
	$kvs_ö£π_•¨£_cowbåì
(
kv°‹e
 *
kvs
, *
key
,

713 
öt32_t
 
ksize
, *
vÆue
,

714 
öt32_t
 
vsize
)

716 *
íåy
;

717 
uöt64_t
 
key_vÆ
;

718 
r
;

719 
kv°‹e_cbt
 *
kvcbt
 = 
NULL
;

720 
	`¥ötk
(
KERN_ALERT
 "Insert sparse cow\n");

721 
kvcbt
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_cbt
, 
ckvs
);

723 i‡(
ksize
 !
kvs
->ksize)

724  -
EINVAL
;

726 i‡(
vsize
 !
kvs
->vsize)

727  -
EINVAL
;

729 
íåy
 = 
	`kmÆloc
(
kvcbt
->
íåy_size
, 
GFP_NOIO
);

730 i‡(!
íåy
)

731  -
ENOMEM
;

733 
key_vÆ
 = (*(
uöt64_t
 *)
key
);

736 
ª≥©
:

738 
r
 = 
	`dm_båì_lookup
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, &
key_vÆ
, 
íåy
);

739 i‡(
r
 =-
ENODATA
) {

740 
	`mem˝y
(
íåy
, 
key
, 
ksize
);

741 
	`mem˝y
(
íåy
 + 
ksize
, 
vÆue
, 
vsize
);

742 
	`__dm_bÀss_f‹_disk
(&
key_vÆ
);

743 
r
 = 
	`dm_båì_ö£π
(&(
kvcbt
->
öfo
), kvcbt->
roŸ
, &
key_vÆ
,

744 
íåy
, &(
kvcbt
->
roŸ
));

745 
	`k‰ì
(
íåy
);

746  
r
;

747 } i‡(
r
 >= 0) {

748 
key_vÆ
++;

749 
ª≥©
;

751 
	`k‰ì
(
íåy
);

752  
r
;

754 
	}
}

756 
kv°‹e
 *
	$kvs_¸óã_•¨£_cowbåì
(
mëad©a
 *
md
,

757 
uöt32_t
 
ksize
, uöt32_à
vsize
, uöt32_à
knummax
,

758 
boﬁ
 
unf‹m©ãd
)

760 
kv°‹e_cbt
 *
kvs
;

761 
r
;

763 i‡(!
vsize
 || !
ksize
)

764  
	`ERR_PTR
(-
ENOTSUPP
);

767 i‡(
md
->
kvs_•¨£
)

768  
	`ERR_PTR
(-
EBUSY
);

770 
kvs
 = 
	`kmÆloc
((*kvs), 
GFP_NOIO
);

771 i‡(!
kvs
)

772  
	`ERR_PTR
(-
ENOMEM
);

774 
kvs
->
ckvs
.
vsize
 = vsize;

775 
kvs
->
ckvs
.
ksize
 = ksize;

776 
kvs
->
íåy_size
 = 
vsize
 + 
ksize
;

778 
kvs
->
öfo
.
tm
 = 
md
->tm;

779 
kvs
->
öfo
.
Àvñs
 = 1;

780 
kvs
->
öfo
.
vÆue_ty≥
.
c⁄ãxt
 = 
NULL
;

781 
kvs
->
öfo
.
vÆue_ty≥
.
size
 = kvs->
íåy_size
;

782 
kvs
->
öfo
.
vÆue_ty≥
.
öc
 = 
NULL
;

783 
kvs
->
öfo
.
vÆue_ty≥
.
dec
 = 
NULL
;

784 
kvs
->
öfo
.
vÆue_ty≥
.
equÆ
 = 
NULL
;

786 i‡(!
unf‹m©ãd
) {

787 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_•¨£_cowbåì
;

788 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_•¨£_cowbåì
;

789 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_•¨£_cowbåì
;

790 
kvs
->
ckvs
.
kvs_ôî©e
 = 
NULL
;

792 
md
->
kvs_•¨£
 = 
kvs
;

793 
	`__begö_å™ß˘i⁄
(
md
);

795 
r
 = 
	`dm_båì_em±y
(&(
kvs
->
öfo
), &(kvs->
roŸ
));

796 i‡(
r
 < 0) {

797 
kvs
 = 
	`ERR_PTR
(
r
);

798 
badåì
;

802 
	`Êush_mëa_cowbåì
(
md
);

804 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_•¨£_cowbåì
;

805 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_•¨£_cowbåì
;

806 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_•¨£_cowbåì
;

807 
kvs
->
ckvs
.
kvs_ôî©e
 = 
NULL
;

809 
md
->
kvs_•¨£
 = 
kvs
;

812  &(
kvs
->
ckvs
);

814 
badåì
:

815 
	`k‰ì
(
kvs
);

816  (
kv°‹e
 *Ë
kvs
;

817 
	}
}

819 
mëad©a_›s
 
	gmëad©a_›s_cowbåì
 = {

820 .
öô_mëa
 = 
öô_mëa_cowbåì
,

821 .
	gexô_mëa
 = 
exô_mëa_cowbåì
,

822 .
	gkvs_¸óã_löór
 = 
kvs_¸óã_löór_cowbåì
,

823 .
	gkvs_¸óã_•¨£
 = 
kvs_¸óã_•¨£_cowbåì
,

825 .
	gÆloc_d©a_block
 = 
Æloc_d©a_block_cowbåì
,

826 .
	göc_ªfcou¡
 = 
öc_ªfcou¡_cowbåì
,

827 .
	gdec_ªfcou¡
 = 
dec_ªfcou¡_cowbåì
,

828 .
	ggë_ªfcou¡
 = 
gë_ªfcou¡_cowbåì
,

830 .
	gÊush_mëa
 = 
Êush_mëa_cowbåì
,

832 .
	gÊush_bufio_ˇche
 = 
NULL
,

	@dm-dedup-cbt.h

13 #i‚de‡
COWBTREE_BACKEND_H


14 
	#COWBTREE_BACKEND_H


	)

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/devi˚-m≠≥r.h
>

20 
	~<löux/dm-io.h
>

21 
	~<löux/dm-kc›yd.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/îr.h
>

24 
	~<asm/cuºít.h
>

25 
	~<löux/°rög.h
>

26 
	~<löux/gÂ.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/u«lig√d.h
>

31 
	~<¸y±o/hash.h
>

32 
	~<¸y±o/md5.h
>

33 
	~<¸y±o/Æg≠i.h
>

35 
	~"dm-dedup-èrgë.h
"

37 
mëad©a_›s
 
mëad©a_›s_cowbåì
;

39 
	söô_∑øm_cowbåì
 {

40 
block_devi˚
 *
	mmëad©a_bdev
;

41 
uöt64_t
 
	mblocks
;

	@dm-dedup-hash.c

13 
	~"dm-dedup-èrgë.h
"

14 
	~"dm-dedup-hash.h
"

15 
	~<löux/©omic.h
>

16 
	~<löux/blk_ty≥s.h
>

29 
hash_desc
 *
	$¶Ÿ_to_desc
(
hash_desc_èbÀ
 *
desc_èbÀ
,

30 
¶Ÿ
)

32 
	`BUG_ON
(
¶Ÿ
 >
DEDUP_HASH_DESC_COUNT
);

33  &(
desc_èbÀ
->
desc
[
¶Ÿ
]);

34 
	}
}

36 
hash_desc_èbÀ
 *
	$desc_èbÀ_öô
(*
hash_Æg
)

38 
i
 = 0;

39 
hash_desc
 *
desc
;

40 
hash_desc_èbÀ
 *
desc_èbÀ
;

42 
desc_èbÀ
 = 
	`kmÆloc
((
hash_desc_èbÀ
), 
GFP_NOIO
);

43 i‡(!
desc_èbÀ
)

44  
	`ERR_PTR
(-
ENOMEM
);

46 
i
 = 0; i < 
DEDUP_HASH_DESC_COUNT
; i++) {

47 
desc_èbÀ
->
‰ì_bôm≠
[
i
] = 
åue
;

48 
desc
 = 
desc_èbÀ
->des¯+ 
i
;

49 
desc
->
Êags
 = 0;

50 
desc
->
tfm
 = 
	`¸y±o_Æloc_hash
(
hash_Æg
, 0, 
CRYPTO_ALG_ASYNC
);

51 i‡(
	`IS_ERR
(
desc
->
tfm
))

52  (
hash_desc_èbÀ
 *)
desc
->
tfm
;

55 
	`©omic_l⁄g_£t
(&(
desc_èbÀ
->
¶Ÿ_cou¡î
), 0);

57  
desc_èbÀ
;

58 
	}
}

60 
	$desc_èbÀ_deöô
(
hash_desc_èbÀ
 *
desc_èbÀ
)

62 
i
 = 0;

63 
hash_desc
 *
desc
;

65 
i
 = 0; i < 
DEDUP_HASH_DESC_COUNT
; i++) {

66 
desc
 = 
desc_èbÀ
->des¯+ 
i
;

67 
	`¸y±o_‰ì_hash
(
desc
->
tfm
);

70 
	`k‰ì
(
desc_èbÀ
);

71 
desc_èbÀ
 = 
NULL
;

72 
	}
}

74 
	$gë_√xt_¶Ÿ
(
hash_desc_èbÀ
 *
desc_èbÀ
)

76 
num
 = 0;

77 
cou¡
 = 0;

80 i‡(
cou¡
 =
DEDUP_HASH_DESC_COUNT
)

81  -
EBUSY
;

83 
cou¡
++;

84 
num
 = 
	`©omic_l⁄g_öc_ªtu∫
(&(
desc_èbÀ
->
¶Ÿ_cou¡î
));

85 
num
 =Çum % 
DEDUP_HASH_DESC_COUNT
;

87 } !
desc_èbÀ
->
‰ì_bôm≠
[
num
]);

94 
desc_èbÀ
->
‰ì_bôm≠
[
num
] = 
Ál£
;

96  
num
;

97 
	}
}

99 
	$put_¶Ÿ
(
hash_desc_èbÀ
 *
desc_èbÀ
, 
¶Ÿ
)

101 
	`BUG_ON
(
¶Ÿ
 >
DEDUP_HASH_DESC_COUNT
);

102 
	`BUG_ON
(
desc_èbÀ
->
‰ì_bôm≠
[
¶Ÿ
]);

103 
desc_èbÀ
->
‰ì_bôm≠
[
¶Ÿ
] = 
åue
;

104 
	}
}

106 
	$gë_hash_dige°size
(
hash_desc_èbÀ
 *
desc_èbÀ
)

108 
¶Ÿ
;

109 
hash_desc
 *
desc
;

111 
¶Ÿ
 = 
	`gë_√xt_¶Ÿ
(
desc_èbÀ
);

112 
desc
 = 
	`¶Ÿ_to_desc
(
desc_èbÀ
, 
¶Ÿ
);

114  
	`¸y±o_hash_dige°size
(
desc
->
tfm
);

115 
	}
}

117 
	$compuã_hash_bio
(
hash_desc_èbÀ
 *
desc_èbÀ
,

118 
bio
 *bio, *
hash
)

120 
sˇâîli°
 
sg
;

121 
ªt
 = 0;

122 
¶Ÿ
;

123 
bio_vec
 
bvec
;

124 
bvec_ôî
 
ôî
;

125 
hash_desc
 *
desc
;

127 
¶Ÿ
 = 
	`gë_√xt_¶Ÿ
(
desc_èbÀ
);

128 
desc
 = 
	`¶Ÿ_to_desc
(
desc_èbÀ
, 
¶Ÿ
);

130 
ªt
 = 
	`¸y±o_hash_öô
(
desc
);

131 i‡(
ªt
)

132 
out
;

134 
	`sg_öô_èbÀ
(&
sg
, 1);

135 
	`__bio_f‹_óch_£gmít
(
bvec
, 
bio
, 
ôî
, bio->
bi_ôî
) {

136 
	`sg_£t_∑ge
(&
sg
, 
bvec
.
bv_∑ge
, bvec.
bv_Àn
,

137 
bvec
.
bv_off£t
);

138 
	`¸y±o_hash_upd©e
(
desc
, &
sg
, sg.
Àngth
);

141 
	`¸y±o_hash_föÆ
(
desc
, 
hash
);

142 
out
:

143 
	`put_¶Ÿ
(
desc_èbÀ
, 
¶Ÿ
);

144  
ªt
;

145 
	}
}

151 
	$compuã_∑ge_hash
(
hash_desc_èbÀ
 *
desc_èbÀ
,

152 
∑ge
*Öage, *
hash
)

154 
sˇâîli°
 
sg
;

155 
ªt
 = 0;

156 
¶Ÿ
;

157 
hash_desc
 *
desc
;

159 
¶Ÿ
 = 
	`gë_√xt_¶Ÿ
(
desc_èbÀ
);

160 
desc
 = 
	`¶Ÿ_to_desc
(
desc_èbÀ
, 
¶Ÿ
);

162 
ªt
 = 
	`¸y±o_hash_öô
(
desc
);

163 i‡(
ªt
)

164 
out
;

166 
	`sg_öô_èbÀ
(&
sg
, 1);

167 
	`sg_£t_∑ge
(&
sg
, 
∑ge
, 4096 , 0);

168 
	`¸y±o_hash_upd©e
(
desc
, &
sg
, sg.
Àngth
);

169 
	`¸y±o_hash_föÆ
(
desc
, 
hash
);

170 
out
:

171 
	`put_¶Ÿ
(
desc_èbÀ
, 
¶Ÿ
);

172  
ªt
;

173 
	}
}

	@dm-dedup-hash.h

13 #i‚de‡
DM_DEDUP_HASH_H


14 
	#DM_DEDUP_HASH_H


	)

16 
	#DEDUP_HASH_DESC_COUNT
 128

	)

18 
	shash_desc_èbÀ
 {

19 
hash_desc
 
	mdesc
[
DEDUP_HASH_DESC_COUNT
];

20 
boﬁ
 
	m‰ì_bôm≠
[
DEDUP_HASH_DESC_COUNT
];

21 
©omic_l⁄g_t
 
	m¶Ÿ_cou¡î
;

24 
desc_èbÀ_deöô
(
hash_desc_èbÀ
 *
desc_èbÀ
);

25 
hash_desc_èbÀ
 *
desc_èbÀ_öô
(*
¸y±_Æg
);

26 
compuã_hash_bio
(
hash_desc_èbÀ
 *
desc_èbÀ
,

27 
bio
 *bio, *
hash
);

28 
gë_hash_dige°size
(
hash_desc_èbÀ
 *
desc_èbÀ
);

32 
compuã_∑ge_hash
(
hash_desc_èbÀ
 *
desc_èbÀ
,

33 
∑ge
*Öage, *
hash
);

	@dm-dedup-kvstore.h

13 #i‚de‡
KVSTORE_H


14 
	#KVSTORE_H


	)

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/devi˚-m≠≥r.h
>

20 
	~<löux/dm-io.h
>

21 
	~<löux/dm-kc›yd.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/îr.h
>

24 
	~<asm/cuºít.h
>

25 
	~<löux/°rög.h
>

26 
	~<löux/gÂ.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/u«lig√d.h
>

31 
	~<¸y±o/hash.h
>

32 
	~<¸y±o/md5.h
>

33 
	~<¸y±o/Æg≠i.h
>

35 
	~"dm-dedup-èrgë.h
"

37 
	skv°‹e
 {

38 
uöt32_t
 
	mvsize
;

39 
uöt32_t
 
	mksize
;

41 (*
	mkvs_dñëe
)(
kv°‹e
 *
	mkvs
, *
	mkey
, 
öt32_t
 
	mksize
);

42 (*
	mkvs_lookup
)(
kv°‹e
 *
	mkvs
, *
	mkey
, 
öt32_t
 
	mksize
,

43 *
	mvÆue
, 
öt32_t
 *
	mvsize
);

44 (*
	mkvs_ö£π
)(
kv°‹e
 *
	mkvs
, *
	mkey
, 
öt32_t
 
	mksize
,

45 *
	mvÆue
, 
öt32_t
 
	mvsize
);

46 (*
	mkvs_ôî©e
)(
kv°‹e
 *
	mkvs
, (*
	môr_a˘i⁄
)

47 (*
	mkey
, 
öt32_t
 
	mksize
, *
	mvÆue
,

48 
öt32_t
 
	mvsize
, *
	md©a
), *data);

	@dm-dedup-ram.c

13 
	~<löux/vmÆloc.h
>

14 
	~<löux/î∫o.h
>

16 
	~"dm-dedup-kv°‹e.h
"

17 
	~"dm-dedup-øm.h
"

18 
	~"dm-dedup-backíd.h
"

20 
	#EMPTY_ENTRY
 -5

	)

21 
	#DELETED_ENTRY
 -6

	)

23 
	#UINT32_MAX
 (4294967295U)

	)

24 
	#HASHTABLE_OVERPROV
 (10)

	)

26 
	smëad©a
 {

28 
uöt32_t
 *
	msm≠
;

29 
uöt64_t
 
	msmax
;

30 
uöt64_t
 
	mÆlo˝å
;

35 
kv°‹e_öøm
 *
	mkvs_löór
;

36 
kv°‹e_öøm
 *
	mkvs_•¨£
;

39 
	skv°‹e_öøm
 {

40 
kv°‹e
 
	mckvs
;

41 
uöt32_t
 
	mkmax
;

42 *
	m°‹e
;

45 
mëad©a
 *
	$öô_mëa_öøm
(*
öô_∑øm
, 
boﬁ
 *
unf‹m©ãd
)

47 
uöt64_t
 
sm≠_size
, 
tmp
;

48 
mëad©a
 *
md
;

49 
öô_∑øm_öøm
 *
p
 = (öô_∑øm_öøm *)
öô_∑øm
;

51 
	`DMINFO
("Initializing INRAM backend");

53 *
unf‹m©ãd
 = 
åue
;

55 
md
 = 
	`kmÆloc
((*md), 
GFP_NOIO
);

56 i‡(!
md
)

57  
	`ERR_PTR
(-
ENOMEM
);

59 
sm≠_size
 = 
p
->
blocks
 * (
uöt32_t
);

61 
md
->
sm≠
 = 
	`vmÆloc
(
sm≠_size
);

62 i‡(!
md
->
sm≠
) {

63 
	`k‰ì
(
md
);

64  
	`ERR_PTR
(-
ENOMEM
);

67 
tmp
 = 
sm≠_size
;

68 (Ë
	`do_div
(
tmp
, (1024 * 1024));

69 
	`DMINFO
("Spaceállocated forÖbnÑeference count map: %llu.%06llu MB\n",

70 
tmp
, 
sm≠_size
 - (tmp * (1024 * 1024)));

72 
	`mem£t
(
md
->
sm≠
, 0, 
sm≠_size
);

74 
md
->
smax
 = 
p
->
blocks
;

75 
md
->
Ælo˝å
 = 0;

76 
md
->
kvs_löór
 = 
NULL
;

77 
md
->
kvs_•¨£
 = 
NULL
;

79  
md
;

80 
	}
}

82 
	$exô_mëa_öøm
(
mëad©a
 *
md
)

84 i‡(
md
->
sm≠
)

85 
	`v‰ì
(
md
->
sm≠
);

87 i‡(
md
->
kvs_löór
) {

88 i‡(
md
->
kvs_löór
->
°‹e
)

89 
	`v‰ì
(
md
->
kvs_löór
->
°‹e
);

90 
	`k‰ì
(
md
->
kvs_löór
);

93 i‡(
md
->
kvs_•¨£
) {

94 i‡(
md
->
kvs_•¨£
->
°‹e
)

95 
	`v‰ì
(
md
->
kvs_•¨£
->
°‹e
);

96 
	`k‰ì
(
md
->
kvs_•¨£
);

99 
	`k‰ì
(
md
);

100 
	}
}

103 
	$Êush_mëa_öøm
(
mëad©a
 *
md
)

106 
	}
}

112 
uöt64_t
 
	$√xt_hód
(
uöt64_t
 
cuºít_hód
, uöt64_à
smax
)

114 
cuºít_hód
 += 1;

115  
	`dm_£˘‹_div64
(
cuºít_hód
, 
smax
);

116 
	}
}

118 
	$Æloc_d©a_block_öøm
(
mëad©a
 *
md
, 
uöt64_t
 *
blockn
)

120 
uöt64_t
 
hód
, 
èû
;

122 
hód
 = 
èû
 = 
md
->
Ælo˝å
;

125 i‡(!
md
->
sm≠
[
hód
]) {

126 
md
->
sm≠
[
hód
] = 1;

127 *
blockn
 = 
hód
;

128 
md
->
Ælo˝å
 = 
	`√xt_hód
(
hód
, md->
smax
);

132 
hód
 = 
	`√xt_hód
(hód, 
md
->
smax
);

134 } 
hód
 !
èû
);

136  -
ENOSPC
;

137 
	}
}

139 
	$öc_ªfcou¡_öøm
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

141 i‡(
blockn
 >
md
->
smax
)

142  -
ERANGE
;

144 i‡(
md
->
sm≠
[
blockn
] !
UINT32_MAX
)

145 
md
->
sm≠
[
blockn
]++;

147  -
E2BIG
;

150 
	}
}

152 
	$dec_ªfcou¡_öøm
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

154 i‡(
blockn
 >
md
->
smax
)

155  -
ERANGE
;

157 i‡(
md
->
sm≠
[
blockn
])

158 
md
->
sm≠
[
blockn
]--;

160  -
EFAULT
;

163 
	}
}

165 
	$gë_ªfcou¡_öøm
(
mëad©a
 *
md
, 
uöt64_t
 
blockn
)

167 i‡(
blockn
 >
md
->
smax
)

168  -
ERANGE
;

170  
md
->
sm≠
[
blockn
];

171 
	}
}

177 
	$is_em±y
(*
±r
, 
Àngth
)

179 
i
 = 0;

181 (
i
 < 
Àngth
Ë&& (
±r
[i] =
EMPTY_ENTRY
))

182 
i
++;

184  
i
 =
Àngth
;

185 
	}
}

187 
	$is_dñëed
(*
±r
, 
Àngth
)

189 
i
 = 0;

191 (
i
 < 
Àngth
Ë&& (
±r
[i] =
DELETED_ENTRY
))

192 
i
++;

194  
i
 =
Àngth
;

195 
	}
}

201 
	$kvs_dñëe_löór_öøm
(
kv°‹e
 *
kvs
,

202 *
key
, 
öt32_t
 
ksize
)

204 
uöt64_t
 
idx
;

205 *
±r
;

206 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

208 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

210 i‡(
ksize
 !
kvs
->ksize)

211  -
EINVAL
;

213 
idx
 = *((
uöt64_t
 *)
key
);

215 i‡(
idx
 > 
kvöøm
->
kmax
)

216  -
ERANGE
;

218 
±r
 = 
kvöøm
->
°‹e
 + 
kvs
->
vsize
 * 
idx
;

220 i‡(
	`is_em±y
(
±r
, 
kvs
->
vsize
))

221  -
ENODEV
;

223 
	`mem£t
(
±r
, 
EMPTY_ENTRY
, 
kvs
->
vsize
);

226 
	}
}

233 
	$kvs_lookup_löór_öøm
(
kv°‹e
 *
kvs
, *
key
,

234 
öt32_t
 
ksize
, *
vÆue
, i¡32_à*
vsize
)

236 
uöt64_t
 
idx
;

237 *
±r
;

238 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

240 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

242 i‡(
ksize
 !
kvs
->ksize)

243  -
EINVAL
;

245 
idx
 = *((
uöt64_t
 *)
key
);

247 i‡(
idx
 > 
kvöøm
->
kmax
)

248  -
ERANGE
;

250 
±r
 = 
kvöøm
->
°‹e
 + 
kvs
->
vsize
 * 
idx
;

252 i‡(
	`is_em±y
(
±r
, 
kvs
->
vsize
))

255 
	`mem˝y
(
vÆue
, 
±r
, 
kvs
->
vsize
);

256 *
vsize
 = 
kvs
->vsize;

259 
	}
}

261 
	$kvs_ö£π_löór_öøm
(
kv°‹e
 *
kvs
, *
key
,

262 
öt32_t
 
ksize
, *
vÆue
,

263 
öt32_t
 
vsize
)

265 
uöt64_t
 
idx
;

266 *
±r
;

267 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

269 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

271 i‡(
ksize
 !
kvs
->ksize)

272  -
EINVAL
;

274 i‡(
vsize
 !
kvs
->vsize)

275  -
EINVAL
;

277 
idx
 = *((
uöt64_t
 *)
key
);

279 i‡(
idx
 > 
kvöøm
->
kmax
)

280  -
ERANGE
;

282 
±r
 = 
kvöøm
->
°‹e
 + 
kvs
->
vsize
 * 
idx
;

284 
	`mem˝y
(
±r
, 
vÆue
, 
kvs
->
vsize
);

287 
	}
}

294 
kvs_ôî©e_löór_öøm
(
kv°‹e
 *
kvs
,

295 (*
ôî©i⁄_a˘i⁄
)(*
key
, 
öt32_t
 
ksize
,

296 *
vÆue
, 
öt32_t
 
vsize
, *
d©a
), *data)

298 
ªt
 = 0;

299 
uöt64_t
 
i
 = 0;

300 *
±r
 = 
NULL
;

301 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

303 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

305 
i
 = 0; i < 
kvöøm
->
kmax
; i++) {

306 
±r
 = 
kvöøm
->
°‹e
 + (
i
 * 
kvs
->
vsize
);

308 
ªt
 = 
	`is_em±y
(
±r
, 
kvs
->
vsize
);

310 i‡(!
ªt
) {

311 
ªt
 = 
	`ôî©i⁄_a˘i⁄
((*)&
i
, 
kvs
->
ksize
,

312 (*)
±r
, 
kvs
->
vsize
, 
d©a
);

313 i‡(
ªt
 < 0)

314 
out
;

318 
out
:

319  
ªt
;

320 
	}
}

322 
kv°‹e
 *
	$kvs_¸óã_löór_öøm
(
mëad©a
 *
md
,

323 
uöt32_t
 
ksize
, uöt32_à
vsize
, uöt32_à
kmax
,

324 
boﬁ
 
unf‹m©ãd
)

326 
kv°‹e_öøm
 *
kvs
;

327 
uöt64_t
 
kv°‹e_size
, 
tmp
;

329 i‡(!
vsize
 || !
ksize
 || !
kmax
)

330  
	`ERR_PTR
(-
ENOTSUPP
);

333 i‡(
ksize
 != 8)

334  
	`ERR_PTR
(-
ENOTSUPP
);

337 i‡(
md
->
kvs_löór
)

338  
	`ERR_PTR
(-
EBUSY
);

340 
kvs
 = 
	`kmÆloc
((*kvs), 
GFP_NOIO
);

341 i‡(!
kvs
)

342  
	`ERR_PTR
(-
ENOMEM
);

344 
kv°‹e_size
 = (
kmax
 + 1Ë* 
vsize
;

345 
kvs
->
°‹e
 = 
	`vmÆloc
(
kv°‹e_size
);

346 i‡(!
kvs
->
°‹e
) {

347 
	`k‰ì
(
kvs
);

348  
	`ERR_PTR
(-
ENOMEM
);

351 
tmp
 = 
kv°‹e_size
;

352 (Ë
	`do_div
(
tmp
, (1024 * 1024));

353 
	`DMINFO
("Spaceállocated forÜinear key value store: %llu.%06llu MB\n",

354 
tmp
, 
kv°‹e_size
 - (tmp * (1024 * 1024)));

356 
	`mem£t
(
kvs
->
°‹e
, 
EMPTY_ENTRY
, 
kv°‹e_size
);

358 
kvs
->
ckvs
.
vsize
 = vsize;

359 
kvs
->
ckvs
.
ksize
 = ksize;

360 
kvs
->
kmax
 = kmax;

362 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_löór_öøm
;

363 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_löór_öøm
;

364 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_löór_öøm
;

365 
kvs
->
ckvs
.
kvs_ôî©e
 = 
kvs_ôî©e_löór_öøm
;

366 
md
->
kvs_löór
 = 
kvs
;

368  &(
kvs
->
ckvs
);

369 
	}
}

375 
	$kvs_dñëe_•¨£_öøm
(
kv°‹e
 *
kvs
,

376 *
key
, 
öt32_t
 
ksize
)

378 
uöt64_t
 
idxhód
 = *((uöt64_à*)
key
);

379 
uöt32_t
 
íåy_size
, 
hód
, 
èû
;

380 *
±r
;

381 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

383 i‡(
ksize
 !
kvs
->ksize)

384  -
EINVAL
;

386 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

388 
íåy_size
 = 
kvs
->
vsize
 + kvs->
ksize
;

389 
hód
 = 
	`do_div
(
idxhód
, 
kvöøm
->
kmax
);

390 
èû
 = 
hód
;

393 
±r
 = 
kvöøm
->
°‹e
 + 
íåy_size
 * 
hód
;

395 i‡(
	`is_em±y
(
±r
, 
íåy_size
))

396 
d€¢Ÿexi°
;

398 i‡(
	`memcmp
(
±r
, 
key
, 
kvs
->
ksize
))

399 
hód
 = 
	`√xt_hód
(hód, 
kvöøm
->
kmax
);

401 
	`mem£t
(
±r
, 
DELETED_ENTRY
, 
íåy_size
);

404 } 
hód
 !
èû
);

406 
d€¢Ÿexi°
:

407  -
ENODEV
;

408 
	}
}

415 
	$kvs_lookup_•¨£_öøm
(
kv°‹e
 *
kvs
, *
key
,

416 
öt32_t
 
ksize
, *
vÆue
, i¡32_à*
vsize
)

418 
uöt64_t
 
idxhód
 = *((uöt64_à*)
key
);

419 
uöt32_t
 
íåy_size
, 
hód
, 
èû
;

420 *
±r
;

421 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

423 i‡(
ksize
 !
kvs
->ksize)

424  -
EINVAL
;

426 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

428 
íåy_size
 = 
kvs
->
vsize
 + kvs->
ksize
;

429 
hód
 = 
	`do_div
(
idxhód
, 
kvöøm
->
kmax
);

430 
èû
 = 
hód
;

433 
±r
 = 
kvöøm
->
°‹e
 + 
íåy_size
 * 
hód
;

435 i‡(
	`is_em±y
(
±r
, 
íåy_size
))

438 i‡(
	`memcmp
(
±r
, 
key
, 
kvs
->
ksize
))

439 
hód
 = 
	`√xt_hód
(hód, 
kvöøm
->
kmax
);

441 
	`mem˝y
(
vÆue
, 
±r
 + 
kvs
->
ksize
, kvs->
vsize
);

445 } 
hód
 !
èû
);

448 
	}
}

450 
	$kvs_ö£π_•¨£_öøm
(
kv°‹e
 *
kvs
, *
key
,

451 
öt32_t
 
ksize
, *
vÆue
, i¡32_à
vsize
)

453 
uöt64_t
 
idxhód
 = *((uöt64_à*)
key
);

454 
uöt32_t
 
íåy_size
, 
hód
, 
èû
;

455 *
±r
;

456 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

458 
	`BUG_ON
(!
kvs
);

460 i‡(
ksize
 > 
kvs
->ksize)

461  -
EINVAL
;

463 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

465 
íåy_size
 = 
kvs
->
vsize
 + kvs->
ksize
;

466 
hód
 = 
	`do_div
(
idxhód
, 
kvöøm
->
kmax
);

467 
èû
 = 
hód
;

470 
±r
 = 
kvöøm
->
°‹e
 + 
íåy_size
 * 
hód
;

472 i‡(
	`is_em±y
(
±r
, 
íåy_size
Ë|| 
	`is_dñëed
(ptr,Éntry_size)) {

473 
	`mem˝y
(
±r
, 
key
, 
kvs
->
ksize
);

474 
	`mem˝y
(
±r
 + 
kvs
->
ksize
, 
vÆue
, kvs->
vsize
);

478 
hód
 = 
	`√xt_hód
(hód, 
kvöøm
->
kmax
);

480 } 
hód
 !
èû
);

482  -
ENOSPC
;

483 
	}
}

491 
kvs_ôî©e_•¨£_öøm
(
kv°‹e
 *
kvs
,

492 (*
ôî©i⁄_a˘i⁄
)(*
key
, 
öt32_t
 
ksize
,

493 *
vÆue
, 
öt32_t
 
vsize
, *
d©a
), *data)

495 
îr
 = 0;

496 
uöt32_t
 
kvÆue_size
, 
hód
 = 0;

497 *
±r
 = 
NULL
;

498 
kv°‹e_öøm
 *
kvöøm
 = 
NULL
;

500 
	`BUG_ON
(!
kvs
);

502 
kvöøm
 = 
	`c⁄èöî_of
(
kvs
, 
kv°‹e_öøm
, 
ckvs
);

504 
kvÆue_size
 = 
kvs
->
vsize
 + kvs->
ksize
;

507 
±r
 = 
kvöøm
->
°‹e
 + (
hód
 * 
kvÆue_size
);

509 i‡(!
	`is_em±y
(
±r
, 
kvÆue_size
) &&

510 !
	`is_dñëed
(
±r
, 
kvÆue_size
)) {

511 
îr
 = 
	`ôî©i⁄_a˘i⁄
((*)
±r
, 
kvs
->
ksize
,

512 (*)(
±r
 + 
kvs
->
ksize
),

513 
kvs
->
vsize
, 
d©a
);

515 i‡(
îr
 < 0)

516 
out
;

519 
hód
 = 
	`√xt_hód
(hód, 
kvöøm
->
kmax
);

520 } 
hód
);

522 
out
:

523  
îr
;

524 
	}
}

526 
kv°‹e
 *
	$kvs_¸óã_•¨£_öøm
(
mëad©a
 *
md
,

527 
uöt32_t
 
ksize
, uöt32_à
vsize
, uöt32_à
knummax
,

528 
boﬁ
 
unf‹m©ãd
)

530 
kv°‹e_öøm
 *
kvs
;

531 
uöt64_t
 
kv°‹e_size
, 
tmp
;

533 i‡(!
vsize
 || !
ksize
 || !
knummax
)

534  
	`ERR_PTR
(-
ENOTSUPP
);

537 i‡(
md
->
kvs_•¨£
)

538  
	`ERR_PTR
(-
EBUSY
);

540 
kvs
 = 
	`kmÆloc
((*kvs), 
GFP_NOIO
);

541 i‡(!
kvs
)

542  
	`ERR_PTR
(-
ENOMEM
);

544 
knummax
 +(knummax * 
HASHTABLE_OVERPROV
) / 100;

546 
kv°‹e_size
 = (
knummax
 * (
vsize
 + 
ksize
));

548 
kvs
->
°‹e
 = 
	`vmÆloc
(
kv°‹e_size
);

549 i‡(!
kvs
->
°‹e
) {

550 
	`k‰ì
(
kvs
);

551  
	`ERR_PTR
(-
ENOMEM
);

554 
tmp
 = 
kv°‹e_size
;

555 (Ë
	`do_div
(
tmp
, (1024 * 1024));

556 
	`DMINFO
("Spaceállocated for sparse key value store: %llu.%06llu MB\n",

557 
tmp
, 
kv°‹e_size
 - (tmp * (1024 * 1024)));

559 
	`mem£t
(
kvs
->
°‹e
, 
EMPTY_ENTRY
, 
kv°‹e_size
);

561 
kvs
->
ckvs
.
vsize
 = vsize;

562 
kvs
->
ckvs
.
ksize
 = ksize;

563 
kvs
->
kmax
 = 
knummax
;

565 
kvs
->
ckvs
.
kvs_ö£π
 = 
kvs_ö£π_•¨£_öøm
;

566 
kvs
->
ckvs
.
kvs_lookup
 = 
kvs_lookup_•¨£_öøm
;

567 
kvs
->
ckvs
.
kvs_dñëe
 = 
kvs_dñëe_•¨£_öøm
;

568 
kvs
->
ckvs
.
kvs_ôî©e
 = 
kvs_ôî©e_•¨£_öøm
;

570 
md
->
kvs_•¨£
 = 
kvs
;

572  &(
kvs
->
ckvs
);

573 
	}
}

575 
mëad©a_›s
 
	gmëad©a_›s_öøm
 = {

576 .
öô_mëa
 = 
öô_mëa_öøm
,

577 .
	gexô_mëa
 = 
exô_mëa_öøm
,

578 .
	gkvs_¸óã_löór
 = 
kvs_¸óã_löór_öøm
,

579 .
	gkvs_¸óã_•¨£
 = 
kvs_¸óã_•¨£_öøm
,

581 .
	gÆloc_d©a_block
 = 
Æloc_d©a_block_öøm
,

582 .
	göc_ªfcou¡
 = 
öc_ªfcou¡_öøm
,

583 .
	gdec_ªfcou¡
 = 
dec_ªfcou¡_öøm
,

584 .
	ggë_ªfcou¡
 = 
gë_ªfcou¡_öøm
,

586 .
	gÊush_mëa
 = 
Êush_mëa_öøm
,

588 .
	gÊush_bufio_ˇche
 = 
NULL
,

	@dm-dedup-ram.h

13 #i‚de‡
INRAM_BACKEND_H


14 
	#INRAM_BACKEND_H


	)

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/devi˚-m≠≥r.h
>

20 
	~<löux/dm-io.h
>

21 
	~<löux/dm-kc›yd.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/îr.h
>

24 
	~<asm/cuºít.h
>

25 
	~<löux/°rög.h
>

26 
	~<löux/gÂ.h
>

28 
	~<löux/sˇâîli°.h
>

29 
	~<asm/∑ge.h
>

30 
	~<asm/u«lig√d.h
>

31 
	~<¸y±o/hash.h
>

32 
	~<¸y±o/md5.h
>

33 
	~<¸y±o/Æg≠i.h
>

35 
	~"dm-dedup-èrgë.h
"

37 
mëad©a_›s
 
mëad©a_›s_öøm
;

39 
	söô_∑øm_öøm
 {

40 
uöt64_t
 
	mblocks
;

	@dm-dedup-rw.c

13 
	~"dm-dedup-èrgë.h
"

14 
	~"dm-dedup-rw.h
"

15 
	~"dm-dedup-kv°‹e.h
"

17 
	#DMD_IO_SIZE
 4096

	)

19 
£˘‹_t
 
	$compuã_£˘‹
(
bio
 *bio,

20 
dedup_c⁄fig
 *
dc
)

22 
£˘‹_t
 
to_be_lbn
;

24 
to_be_lbn
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

25 (Ë
	`£˘‹_div
(
to_be_lbn
, 
dc
->
£˘‹s_≥r_block
);

26 
to_be_lbn
 *
dc
->
£˘‹s_≥r_block
;

28  
to_be_lbn
;

29 
	}
}

31 
	$„tch_whﬁe_block
(
dedup_c⁄fig
 *
dc
,

32 
uöt64_t
 
pbn
, 
∑ge_li°
 *
∂
)

34 
dm_io_ªque°
 
i‹q
;

35 
dm_io_ªgi⁄
 
whîe
;

36 
îr‹_bôs
;

38 
whîe
.
bdev
 = 
dc
->
d©a_dev
->bdev;

39 
whîe
.
£˘‹
 = 
pbn
;

40 
whîe
.
cou¡
 = 
dc
->
£˘‹s_≥r_block
;

42 
i‹q
.
bi_rw
 = 
READ
;

43 
i‹q
.
mem
.
ty≥
 = 
DM_IO_PAGE_LIST
;

44 
i‹q
.
mem
.
±r
.
∂
 =Öl;

45 
i‹q
.
mem
.
off£t
 = 0;

46 
i‹q
.
nŸify
.
‚
 = 
NULL
;

47 
i‹q
.
˛õ¡
 = 
dc
->
io_˛õ¡
;

49  
	`dm_io
(&
i‹q
, 1, &
whîe
, &
îr‹_bôs
);

50 
	}
}

55 
∑ge
* 
	$ªad_pbn
(
dedup_c⁄fig
 *
dc
, 
uöt64_t
 
pbn
)

57 
r
 = 0;

58 
∑ge_li°
 *
∂
;

60 
∂
 = 
	`kmÆloc
(’l), 
GFP_NOIO
);

61 i‡(!
∂
)

62 
out
;

64 
∂
->
∑ge
 = 
	`Æloc_∑ges
(
GFP_NOIO
, 0);

65 i‡(!
∂
->
∑ge
)

66 
out_ÆlocÁû
;

68 
∂
->
√xt
 = 
NULL
;

69 
r
 = 
	`„tch_whﬁe_block
(
dc
, 
pbn
, 
∂
);

70 i‡(
r
 < 0)

71 
out_Áû
;

73  
∂
->
∑ge
;

75 
out_Áû
:

76 
	`‰ì_∑ges
((Ë
	`∑ge_addªss
(
∂
->
∑ge
), 0);

77 
out_ÆlocÁû
:

78 
	`k‰ì
(
∂
);

79 
out
:

80 i‡(
r
 < 0)

81  
	`ERR_PTR
(
r
);

83  
NULL
;

84 
	}
}

90 
	$mîge_d©a
(
dedup_c⁄fig
 *
dc
, 
∑ge
 *page,

91 
bio
 *bio)

93 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

94 *
§c_∑ge_vaddr
, *
de°_∑ge_vaddr
;

95 
posôi⁄
, 
îr
 = 0;

98 
posôi⁄
 = 
	`£˘‹_div
(
bi_£˘‹
, 
dc
->
£˘‹s_≥r_block
);

100 i‡(!
∑ge
 || !
bio
->
bi_io_vec
->
bv_∑ge
) {

101 
îr
 = -
EINVAL
;

102 
out
;

105 
§c_∑ge_vaddr
 = 
	`∑ge_addªss
(
bio
->
bi_io_vec
->
bv_∑ge
);

106 
de°_∑ge_vaddr
 = 
	`∑ge_addªss
(
∑ge
);

108 
§c_∑ge_vaddr
 = src_∑ge_vadd∏+ 
bio
->
bi_io_vec
->
bv_off£t
;

110 
de°_∑ge_vaddr
 = de°_∑ge_vadd∏+ (
	`to_byãs
(
posôi⁄
));

113 
	`memmove
(
de°_∑ge_vaddr
, 
§c_∑ge_vaddr
, 
bio
->
bi_io_vec
->
bv_Àn
);

114 
out
:

115  
îr
;

116 
	}
}

118 
	$c›y_∑ges
(
∑ge
 *
§c
, 
bio
 *
˛⁄e
)

120 *
§c_∑ge_vaddr
, *
de°_∑ge_vaddr
;

122 
§c_∑ge_vaddr
 = 
	`∑ge_addªss
(
§c
);

123 
de°_∑ge_vaddr
 = 
	`∑ge_addªss
(
˛⁄e
->
bi_io_vec
->
bv_∑ge
);

125 
	`memmove
(
de°_∑ge_vaddr
, 
§c_∑ge_vaddr
, 
DMD_IO_SIZE
);

126 
	}
}

128 
	$my_ídio
(
bio
 *
˛⁄e
, 
îr‹
)

130 
rw
 = 
	`bio_d©a_dú
(
˛⁄e
);

131 
bio
 *
‹ig
;

132 
bio_vec
 
bv
;

134 i‡(!
îr‹
 && !
	`bio_Êagged
(
˛⁄e
, 
BIO_UPTODATE
))

135 
îr‹
 = -
EIO
;

138 i‡(
rw
 =
WRITE
 ||Ñw =
READ
) {

139 
bv
 = 
	`bio_iovec
(
˛⁄e
);

140 i‡(
bv
.
bv_∑ge
) {

141 
	`‰ì_∑ges
(()
	`∑ge_addªss
(
bv
.
bv_∑ge
), 0);

142 
bv
.
bv_∑ge
 = 
NULL
;

146 
‹ig
 = 
˛⁄e
->
bi_¥iv©e
;

147 
	`bio_ídio
(
‹ig
, 0);

149 
	`bio_put
(
˛⁄e
);

150 
	}
}

156 
	$my_zîo_fûl_bio
(
bio
 *bio)

158 *
d©a
;

159 
Àngth
;

161 
d©a
 = 
	`bio_d©a
(
bio
);

162 
Àngth
 = 
	`bio_cur_byãs
(
bio
);

163 
	`mem£t
(
d©a
, 0, 
Àngth
);

164 
	}
}

166 
bio
 *
	$¸óã_bio
(
dedup_c⁄fig
 *
dc
,

167 
bio
 *bio)

169 
bio
 *
˛⁄e
;

170 
∑ge
 *page;

172 
˛⁄e
 = 
	`bio_kmÆloc
(
GFP_NOIO
, 1);

173 i‡(!
˛⁄e
)

174 
out
;

176 
˛⁄e
->
bi_bdev
 = 
bio
->bi_bdev;

177 
˛⁄e
->
bi_rw
 = 
bio
->bi_rw;

178 
˛⁄e
->
bi_ôî
.
bi_£˘‹
 = 
	`compuã_£˘‹
(
bio
, 
dc
);

179 
˛⁄e
->
bi_¥iv©e
 = 
bio
;

180 
˛⁄e
->
bi_íd_io
 = 
my_ídio
;

182 
∑ge
 = 
	`Æloc_∑ges
(
GFP_NOIO
, 0);

183 i‡(!
∑ge
)

184 
bad_putbio
;

186 i‡(!
	`bio_add_∑ge
(
˛⁄e
, 
∑ge
, 
DMD_IO_SIZE
, 0))

187 
bad_‰ì∑ge
;

189 
out
;

191 
bad_‰ì∑ge
:

192 
	`‰ì_∑ges
((Ë
	`∑ge_addªss
(
∑ge
), 0);

193 
bad_putbio
:

194 
	`bio_put
(
˛⁄e
);

195 
˛⁄e
 = 
NULL
;

196 
out
:

197  
˛⁄e
;

198 
	}
}

200 
bio
 *
	$¥ï¨e_bio_wôh_pbn
(
dedup_c⁄fig
 *
dc
,

201 
bio
 *bio, 
uöt64_t
 
pbn
)

203 
r
 = 0;

204 
∑ge_li°
 *
∂
;

205 
bio
 *
˛⁄e
 = 
NULL
;

207 
∂
 = 
	`kmÆloc
(’l), 
GFP_NOIO
);

208 i‡(!
∂
)

209 
out
;

216 
∂
->
∑ge
 = 
	`Æloc_∑ges
(
GFP_NOIO
, 0);

217 i‡(!
∂
->
∑ge
)

218 
out_ÆlocÁû
;

220 
∂
->
√xt
 = 
NULL
;

222 
r
 = 
	`„tch_whﬁe_block
(
dc
, 
pbn
, 
∂
);

223 i‡(
r
 < 0)

224 
out_Áû
;

226 
r
 = 
	`mîge_d©a
(
dc
, 
∂
->
∑ge
, 
bio
);

227 i‡(
r
 < 0)

228 
out_Áû
;

230 
˛⁄e
 = 
	`¸óã_bio
(
dc
, 
bio
);

231 i‡(!
˛⁄e
)

232 
out_Áû
;

234 
	`c›y_∑ges
(
∂
->
∑ge
, 
˛⁄e
);

236 
out_Áû
:

237 
	`‰ì_∑ges
((Ë
	`∑ge_addªss
(
∂
->
∑ge
), 0);

238 
out_ÆlocÁû
:

239 
	`k‰ì
(
∂
);

240 
out
:

241 i‡(
r
 < 0)

242  
	`ERR_PTR
(
r
);

244  
˛⁄e
;

245 
	}
}

247 
bio
 *
	$¥ï¨e_bio_wôhout_pbn
(
dedup_c⁄fig
 *
dc
,

248 
bio
 *bio)

250 
r
 = 0;

251 
bio
 *
˛⁄e
 = 
NULL
;

253 
˛⁄e
 = 
	`¸óã_bio
(
dc
, 
bio
);

254 i‡(!
˛⁄e
)

255 
out
;

257 
	`my_zîo_fûl_bio
(
˛⁄e
);

259 
r
 = 
	`mîge_d©a
(
dc
, 
˛⁄e
->
bi_io_vec
->
bv_∑ge
, 
bio
);

260 i‡(
r
 < 0)

261  
	`ERR_PTR
(
r
);

262 
out
:

263  
˛⁄e
;

264 
	}
}

266 
bio
 *
	$¥ï¨e_bio_⁄_wrôe
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

268 
r
;

269 
£˘‹_t
 
lbn
;

270 
uöt32_t
 
vsize
;

271 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

272 
bio
 *
˛⁄e
;

274 
lbn
 = 
	`compuã_£˘‹
(
bio
, 
dc
);

275 (Ë
	`£˘‹_div
(
lbn
, 
dc
->
£˘‹s_≥r_block
);

278 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
,

279 (
lbn
), (*)&
lb≈bn_vÆue
, &
vsize
);

280 i‡(
r
 == 0)

281 
˛⁄e
 = 
	`¥ï¨e_bio_wôhout_pbn
(
dc
, 
bio
);

282 i‡(
r
 == 1)

283 
˛⁄e
 = 
	`¥ï¨e_bio_wôh_pbn
(
dc
, 
bio
,

284 
lb≈bn_vÆue
.
pbn
 * 
dc
->
£˘‹s_≥r_block
);

286  
	`ERR_PTR
(
r
);

288  
˛⁄e
;

289 
	}
}

	@dm-dedup-rw.h

13 #i‚de‡
DM_DEDUP_RW_H


14 
	#DM_DEDUP_RW_H


	)

16 
bio
 *
¥ï¨e_bio_⁄_wrôe
(
dedup_c⁄fig
 *
dc
,

17 
bio
 *bio);

21 
∑ge
* 
ªad_pbn
(
dedup_c⁄fig
 *
dc
, 
uöt64_t
 
pbn
);

	@dm-dedup-target.c

13 
	~<löux/vmÆloc.h
>

15 
	~"dm-dedup-èrgë.h
"

16 
	~"dm-dedup-rw.h
"

17 
	~"dm-dedup-hash.h
"

18 
	~"dm-dedup-backíd.h
"

19 
	~"dm-dedup-øm.h
"

20 
	~"dm-dedup-cbt.h
"

21 
	~"dm-dedup-kv°‹e.h
"

22 
	~<löux/buf„r_hód.h
>

24 
	#MAX_DEV_NAME_LEN
 (64)

	)

26 
	#MIN_DATA_DEV_BLOCK_SIZE
 (4 * 1024)

	)

27 
	#MAX_DATA_DEV_BLOCK_SIZE
 (1024 * 1024)

	)

28 
	#BIO_NO_DEDUP
 1

	)

31 
	s⁄_disk_°©s
 {

32 
uöt64_t
 
	mphysiˇl_block_cou¡î
;

33 
uöt64_t
 
	mlogiˇl_block_cou¡î
;

40 
	sdedup_w‹k
 {

41 
w‹k_°ru˘
 
	mw‹kî
;

42 
dedup_c⁄fig
 *
	mc⁄fig
;

43 
bio
 *
	mbio
;

46 
	ebackíd
 {

47 
	mBKND_INRAM
,

48 
	mBKND_COWBTREE


51 
	$bio_zîo_ídio
(
bio
 *bio)

53 
	`zîo_fûl_bio
(
bio
);

54 
	`bio_ídio
(
bio
, 0);

55 
	}
}

57 
uöt64_t
 
	$bio_lbn
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

59 
£˘‹_t
 
lbn
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

61 
	`£˘‹_div
(
lbn
, 
dc
->
£˘‹s_≥r_block
);

64  
lbn
;

65 
	}
}

67 
	$do_io
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio, 
uöt64_t
 
pbn
)

69 
off£t
;

71 
off£t
 = 
	`£˘‹_div
(
bio
->
bi_ôî
.
bi_£˘‹
, 
dc
->
£˘‹s_≥r_block
);

72 
bio
->
bi_ôî
.
bi_£˘‹
 = (
£˘‹_t
)
pbn
 * 
dc
->
£˘‹s_≥r_block
 + 
off£t
;

74 
bio
->
bi_bdev
 = 
dc
->
d©a_dev
->
bdev
;

76 
	`gíîic_make_ªque°
(
bio
);

77 
	}
}

79 
	$h™dÀ_ªad
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

81 
uöt64_t
 
lbn
;

82 
uöt32_t
 
vsize
;

83 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

84 
r
;

86 
lbn
 = 
	`bio_lbn
(
dc
, 
bio
);

89 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
,

90 (
lbn
), (*)&
lb≈bn_vÆue
, &
vsize
);

91 
	`¥ötk
(
KERN_ALERT
 " h™dÀªad %Œu %Œu %Œu %Œu %Œu %Œu \n", 
bio
->
bi_v˙t
 , bio->
bi_phys_£gmíts
, bio->
bi_rw
, bio->
bi_ôî
.
bi_£˘‹
, 
lbn
, 
lb≈bn_vÆue
.
pbn
 );

92 i‡(
r
 == 0)

93 
	`bio_zîo_ídio
(
bio
);

94 i‡(
r
 == 1)

95 
	`do_io
(
dc
, 
bio
, 
lb≈bn_vÆue
.
pbn
);

97  
r
;

100 
	}
}

102 
	$Æloˇã_block
(
dedup_c⁄fig
 *
dc
, 
uöt64_t
 *
pbn_√w
)

104 
r
;

106 
r
 = 
dc
->
md›s
->
	`Æloc_d©a_block
(dc->
bmd
, 
pbn_√w
);

108 i‡(!
r
) {

109 
dc
->
logiˇl_block_cou¡î
++;

110 
dc
->
physiˇl_block_cou¡î
++;

113  
r
;

114 
	}
}

116 
	$wrôe_to_√w_block
(
dedup_c⁄fig
 *
dc
, 
uöt64_t
 *
pbn_√w
,

117 
bio
 *bio, 
uöt64_t
 
lbn
)

119 
r
 = 0;

120 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

122 
r
 = 
	`Æloˇã_block
(
dc
, 
pbn_√w
);

123 i‡(
r
 < 0) {

124 
r
 = -
EIO
;

125  
r
;

128 
lb≈bn_vÆue
.
pbn
 = *
pbn_√w
;

130 
	`¥ötk
(
KERN_ALERT
 " wrôë⁄ewblock %Œu %Œu %Œu \n",
lbn
, 
lb≈bn_vÆue
.
pbn
, 
bio
->
bi_ôî
.
bi_£˘‹
);

132 
	`do_io
(
dc
, 
bio
, *
pbn_√w
);

134 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

135 (
lbn
), (*)&
lb≈bn_vÆue
, (lbnpbn_value));

136 i‡(
r
 < 0)

137 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, *
pbn_√w
);

139  
r
;

140 
	}
}

142 
	$h™dÀ_wrôe_nodedup
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio,

143 
uöt64_t
 
lbn
)

145 
r
, 
ªt
;

146 
uöt32_t
 
vsize
;

147 
uöt64_t
 
pbn_√w
, 
pbn_ﬁd
;

148 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

150 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
, (lbn),

151 (*)&
lb≈bn_vÆue
, &
vsize
);

152 i‡(
r
 == 0) {

154 
r
 = 
	`wrôe_to_√w_block
(
dc
, &
pbn_√w
, 
bio
, 
lbn
);

155 
out
;

156 } i‡(
r
 < 0)

157 
	`BUG
();

159 
pbn_ﬁd
 = 
lb≈bn_vÆue
.
pbn
;

162 
r
 = 
	`wrôe_to_√w_block
(
dc
, &
pbn_√w
, 
bio
, 
lbn
);

163 i‡(
r
 < 0)

164 
out
;

166 
ªt
 = 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_ﬁd
);

167 i‡(
ªt
 < 0)

168 
	`BUG
();

170 
dc
->
logiˇl_block_cou¡î
--;

172 
out
:

173  
r
;

174 
	}
}

176 
	$h™dÀ_wrôe_no_hash
(
dedup_c⁄fig
 *
dc
,

177 
bio
 *bio, 
uöt64_t
 
lbn
, 
u8
 *
hash
)

179 
r
;

180 
uöt32_t
 
vsize
;

181 
uöt64_t
 
pbn_√w
, 
pbn_ﬁd
;

182 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

183 
hash_pbn_vÆue
 
hashpbn_vÆue
;

185 
dc
->
uniqwrôes
++;

187 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
,

188 (
lbn
), (*)&
lb≈bn_vÆue
, &
vsize
);

189 i‡(
r
 == 0) {

191 
dc
->
√wwrôes
++;

192 
r
 = 
	`wrôe_to_√w_block
(
dc
, &
pbn_√w
, 
bio
, 
lbn
);

193 i‡(
r
 < 0)

194 
out_wrôe_√w_block_1
;

196 
hashpbn_vÆue
.
pbn
 = 
pbn_√w
;

198 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_ö£π
(dc->kvs_hash_pbn, (*)
hash
,

199 
dc
->
¸y±o_key_size
, (*)&
hashpbn_vÆue
,

200 (
hashpbn_vÆue
));

201 i‡(
r
 < 0)

202 
out_kvs_ö£π_1
;

204 
r
 = 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

205 i‡(
r
 < 0)

206 
out_öc_ªfcou¡_1
;

208 
out_1
;

210 
out_öc_ªfcou¡_1
:

211 
dc
->
kvs_hash_pbn
->
	`kvs_dñëe
(dc->kvs_hash_pbn,

212 (*)
hash
, 
dc
->
¸y±o_key_size
);

213 
out_kvs_ö£π_1
:

214 
dc
->
kvs_lbn_pbn
->
	`kvs_dñëe
(dc->kvs_lbn_pbn,

215 (*)&
lbn
, (lbn));

216 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

217 
out_wrôe_√w_block_1
:

218 
dc
->
√wwrôes
--;

219 
out_1
:

220 i‡(
r
 < 0)

221 
dc
->
uniqwrôes
--;

222  
r
;

223 } i‡(
r
 < 0)

224 
out_2
;

227 
dc
->
ovîwrôes
++;

228 
r
 = 
	`wrôe_to_√w_block
(
dc
, &
pbn_√w
, 
bio
, 
lbn
);

229 i‡(
r
 < 0)

230 
out_wrôe_√w_block_2
;

232 
pbn_ﬁd
 = 
lb≈bn_vÆue
.
pbn
;

233 
r
 = 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_ﬁd
);

234 i‡(
r
 < 0)

235 
out_dec_ªfcou¡_2
;

237 
dc
->
logiˇl_block_cou¡î
--;

239 
hashpbn_vÆue
.
pbn
 = 
pbn_√w
;

241 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_ö£π
(dc->kvs_hash_pbn, (*)
hash
,

242 
dc
->
¸y±o_key_size
, (*)&
hashpbn_vÆue
,

243 (
hashpbn_vÆue
));

244 i‡(
r
 < 0)

245 
out_kvs_ö£π_2
;

247 
r
 = 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

248 i‡(
r
 < 0)

249 
out_öc_ªfcou¡_2
;

251 
out_2
;

253 
out_öc_ªfcou¡_2
:

254 
dc
->
kvs_hash_pbn
->
	`kvs_dñëe
(dc->kvs_hash_pbn,

255 (*)
hash
, 
dc
->
¸y±o_key_size
);

256 
out_kvs_ö£π_2
:

257 
dc
->
logiˇl_block_cou¡î
++;

258 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
pbn_ﬁd
);

259 
out_dec_ªfcou¡_2
:

260 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

261 (
lbn
), (*)&
lb≈bn_vÆue
,

262 (
lb≈bn_vÆue
));

263 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

264 
out_wrôe_√w_block_2
:

265 
dc
->
ovîwrôes
--;

266 
out_2
:

267 i‡(
r
 < 0)

268 
dc
->
uniqwrôes
--;

269  
r
;

270 
	}
}

272 
	$h™dÀ_wrôe_wôh_hash
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio,

273 
uöt64_t
 
lbn
, 
u8
 *
föÆ_hash
,

274 
hash_pbn_vÆue
 
hashpbn_vÆue
)

276 
r
;

277 
uöt32_t
 
vsize
;

278 
uöt64_t
 
pbn_√w
, 
pbn_ﬁd
;

279 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

280 
lbn_pbn_vÆue
 
√w_lb≈bn_vÆue
;

282 
dc
->
dupwrôes
++;

284 
pbn_√w
 = 
hashpbn_vÆue
.
pbn
;

285 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
,

286 (
lbn
), (*)&
lb≈bn_vÆue
, &
vsize
);

287 i‡(
r
 == 0) {

289 
dc
->
√wwrôes
++;

291 
r
 = 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

292 i‡(
r
 < 0)

293 
out_öc_ªfcou¡_1
;

295 
lb≈bn_vÆue
.
pbn
 = 
pbn_√w
;

297 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

298 (
lbn
), (*)&
lb≈bn_vÆue
,

299 (
lb≈bn_vÆue
));

300 i‡(
r
 < 0)

301 
out_kvs_ö£π_1
;

303 
dc
->
logiˇl_block_cou¡î
++;

305 
out_1
;

307 
out_kvs_ö£π_1
:

308 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

309 
out_öc_ªfcou¡_1
:

310 
dc
->
√wwrôes
--;

311 
out_1
:

312 i‡(
r
 >= 0)

313 
	`bio_ídio
(
bio
, 0);

315 
dc
->
dupwrôes
--;

316  
r
;

317 } i‡(
r
 < 0)

318 
out_2
;

321 
dc
->
ovîwrôes
++;

322 
pbn_ﬁd
 = 
lb≈bn_vÆue
.
pbn
;

323 i‡(
pbn_√w
 !
pbn_ﬁd
) {

324 
r
 = 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

325 i‡(
r
 < 0)

326 
out_öc_ªfcou¡_2
;

328 
√w_lb≈bn_vÆue
.
pbn
 = 
pbn_√w
;

330 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

331 (
lbn
), (*)&
√w_lb≈bn_vÆue
,

332 (
√w_lb≈bn_vÆue
));

333 i‡(
r
 < 0)

334 
out_kvs_ö£π_2
;

336 
r
 = 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_ﬁd
);

337 i‡(
r
 < 0)

338 
out_dec_ªfcou¡_2
;

342 
out_2
;

344 
out_dec_ªfcou¡_2
:

345 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

346 (
lbn
), (*)&
lb≈bn_vÆue
,

347 (
lb≈bn_vÆue
));

348 
out_kvs_ö£π_2
:

349 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_√w
);

350 
out_öc_ªfcou¡_2
:

351 
dc
->
ovîwrôes
--;

352 
out_2
:

353 i‡(
r
 >= 0)

354 
	`bio_ídio
(
bio
, 0);

356 
dc
->
dupwrôes
--;

357  
r
;

358 
	}
}

470 
	$h™dÀ_ofÊöe_dedup
(
dedup_c⁄fig
 *
dc
)

472 
r
;

473 
u8
 
hash
[
MAX_DIGEST_SIZE
];

474 
uöt32_t
 
vsize
;

475 
lbn_pbn_vÆue
 
lb≈bn_vÆue
;

476 
uöt64_t
 
lbn
, 
pbn
;

477 
∑ge
 *page;

478 
hash_pbn_vÆue
 
cuº_pbn
, 
hash_pbn
;

479 
	`¥ötk
(
KERN_ALERT
 "Anshul -- handle_offline_dedup \n");

482 
lbn
 =0;Übn<100000;Übn++)

484 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_lookup
(dc->kvs_lbn_pbn, (*)&
lbn
,

485 (
lbn
), (*)&
lb≈bn_vÆue
, &
vsize
);

486 if(
r
 == 1)

488 
pbn
 = 
lb≈bn_vÆue
.pbn;

490 
buf„r_hód
 *
bh
 = 
	`__bªad
(
dc
->
d©a_dev
->
bdev
, 
pbn
, 4096);

493 
bio
 *bio;

494 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 1);

496 
bio
->
bi_ôî
.
bi_£˘‹
 = 
lbn
;

498 
bio
->
bi_bdev
 = 
bh
->
b_bdev
;

499 
bio
->
bi_io_vec
[0].
bv_∑ge
 = 
bh
->
b_∑ge
;

500 
bio
->
bi_io_vec
[0].
bv_Àn
 = 
bh
->
b_size
;

501 
bio
->
bi_io_vec
[0].
bv_off£t
 = 
	`bh_off£t
(
bh
);

502 
bio
->
bi_v˙t
 = 1;

503 
bio
->
bi_ôî
.
bi_size
 = 
bh
->
b_size
;

505 
bio
->
bi_¥iv©e
 = 
bh
;

506 
bio
->
bi_Êags
 |= 0;

511 
	`bio_gë
(
bio
);

514 
	`submô_bio
(
READ
, 
bio
);

515 
r
 = 
	`compuã_hash_bio
(
dc
->
desc_èbÀ
, 
bio
, 
hash
);

516 i‡(
r
)

517  
r
;

520 
	`bio_put
(
bio
);

529 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_lookup
(dc->kvs_hash_pbn, 
hash
,

530 
dc
->
¸y±o_key_size
, &
hash_pbn
, &
vsize
);

531 
cuº_pbn
.
pbn
 =Öbn;

532 i‡(
r
 == 0)

534 
	`¥ötk
(
KERN_ALERT
 "R=0 %Œu %Œu -hashvÆ %u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u \n", 
lbn
, 
pbn
 ,
hash
[0], hash[1], hash[2], hash[3], hash[4], hash[5], hash[6], hash[7], hash[8 + 0], hash[8 + 1], hash[8 + 2],hash[8 + 3], hash[8 + 4], hash[8 + 5], hash[8 + 6], hash[8 + 7], hash[16+0], hash[16+1], hash[16+2],hash[16+3],hash[16+4],hash[16+5],hash[16+6],hash[16+7], hash[24+0], hash[24+1], hash[24+2],hash[24+3],hash[24+4],hash[24+5],hash[24+6],hash[24+7]);

536 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_ö£π
(dc->kvs_hash_pbn, (*)
hash
,

537 
dc
->
¸y±o_key_size
, (*)&
cuº_pbn
,

538 (
cuº_pbn
));

539 
	`¥ötk
(
KERN_ALERT
 " %Œu \n", 
r
);

542 if(
r
 > 0)

544 if(
hash_pbn
.
pbn
 !
cuº_pbn
.pbn)

546 
	`¥ötk
(
KERN_ALERT
 "R=1 %Œu %Œu %Œu -hashvÆ %u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u \n", 
lbn
, 
cuº_pbn
.
pbn
 , 
hash_pbn
.pbn, 
hash
[0], hash[1], hash[2], hash[3], hash[4], hash[5], hash[6], hash[7], hash[8 + 0], hash[8 + 1], hash[8 + 2],hash[8 + 3], hash[8 + 4], hash[8 + 5], hash[8 + 6], hash[8 + 7], hash[16+0], hash[16+1], hash[16+2],hash[16+3],hash[16+4],hash[16+5],hash[16+6],hash[16+7], hash[24+0], hash[24+1], hash[24+2],hash[24+3],hash[24+4],hash[24+5],hash[24+6],hash[24+7]);

548 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_dñëe
(dc->kvs_lbn_pbn,

549 (*)&
lbn
, (lbn));

550 
r
 = 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
cuº_pbn
.
pbn
);

551 
r
 = 
dc
->
kvs_lbn_pbn
->
	`kvs_ö£π
(dc->kvs_lbn_pbn, (*)&
lbn
,

552 (
lbn
), (*)&
hash_pbn
,

553 (
hash_pbn
));

554 
r
 = 
dc
->
md›s
->
	`öc_ªfcou¡
(dc->
bmd
, 
hash_pbn
.
pbn
);

558 
	`¥ötk
(
KERN_ALERT
 "R=2 %Œu %Œu -hashvÆ %u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u%u \n", 
lbn
, 
pbn
 ,
hash
[0], hash[1], hash[2], hash[3], hash[4], hash[5], hash[6], hash[7], hash[8 + 0], hash[8 + 1], hash[8 + 2],hash[8 + 3], hash[8 + 4], hash[8 + 5], hash[8 + 6], hash[8 + 7], hash[16+0], hash[16+1], hash[16+2],hash[16+3],hash[16+4],hash[16+5],hash[16+6],hash[16+7], hash[24+0], hash[24+1], hash[24+2],hash[24+3],hash[24+4],hash[24+5],hash[24+6],hash[24+7]);

567  
r
;

568 
	}
}

576 
	$h™dÀ_wrôe
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

578 
uöt64_t
 
lbn
;

579 
u8
 
hash
[
MAX_DIGEST_SIZE
];

580 
hash_pbn_vÆue
 
hashpbn_vÆue
;

581 
uöt32_t
 
vsize
;

582 
bio
 *
√w_bio
 = 
NULL
;

583 
r
;

585 
dc
->
wrôes
++;

588 i‡(
bio
->
bi_ôî
.
bi_size
 < 
dc
->
block_size
) {

589 
	`¥ötk
(
KERN_ALERT
 "when is Read_on_write handling \n");

590 
dc
->
ªads_⁄_wrôes
++;

591 
√w_bio
 = 
	`¥ï¨e_bio_⁄_wrôe
(
dc
, 
bio
);

592 i‡(!
√w_bio
 || 
	`IS_ERR
(new_bio))

593  -
ENOMEM
;

594 
bio
 = 
√w_bio
;

597 
lbn
 = 
	`bio_lbn
(
dc
, 
bio
);

599 i‡(
	`bio_Êagged
(
bio
, 
BIO_NO_DEDUP
)) {

600 
dc
->
nodedup_wrôes
++;

601 ()
	`h™dÀ_wrôe_nodedup
(
dc
, 
bio
, 
lbn
);

602 
Êush
;

605 
r
 = 
	`compuã_hash_bio
(
dc
->
desc_èbÀ
, 
bio
, 
hash
);

606 i‡(
r
)

607  
r
;

609 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_lookup
(dc->kvs_hash_pbn, 
hash
,

610 
dc
->
¸y±o_key_size
, &
hashpbn_vÆue
, &
vsize
);

612 i‡(
r
 == 0)

613 
r
 = 
	`h™dÀ_wrôe_no_hash
(
dc
, 
bio
, 
lbn
, 
hash
);

614 i‡(
r
 > 0)

615 
r
 = 
	`h™dÀ_wrôe_wôh_hash
(
dc
, 
bio
, 
lbn
, 
hash
,

616 
hashpbn_vÆue
);

618 i‡(
r
 < 0)

619  
r
;

620 
Êush
:

621 
dc
->
wrôes_a·î_Êush
++;

622 i‡((
dc
->
Êushrq
 && dc->
wrôes_a·î_Êush
 >= dc->flushrq) ||

623 (
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_FUA
))) {

624 
r
 = 
dc
->
md›s
->
	`Êush_mëa
(dc->
bmd
);

625 i‡(
r
 < 0)

626  
r
;

627 
dc
->
wrôes_a·î_Êush
 = 0;

631 
	}
}

633 
	$¥o˚ss_bio
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

635 
r
;

637 
	`bio_d©a_dú
(
bio
)) {

638 
READ
:

639 
r
 = 
	`h™dÀ_ªad
(
dc
, 
bio
);

641 
WRITE
:

642 
r
 = 
	`h™dÀ_wrôe
(
dc
, 
bio
);

645 i‡(
r
 < 0)

646 
	`bio_ídio
(
bio
, 
r
);

647 
	}
}

649 
	$do_w‹k
(
w‹k_°ru˘
 *
ws
)

651 
dedup_w‹k
 *
d©a
 = 
	`c⁄èöî_of
(
ws
, dedup_w‹k, 
w‹kî
);

652 
dedup_c⁄fig
 *
dc
 = (dedup_c⁄fig *)
d©a
->
c⁄fig
;

653 
bio
 *biÿ(biÿ*)
d©a
->bio;

655 
	`mempoﬁ_‰ì
(
d©a
, 
dc
->
dedup_w‹k_poﬁ
);

657 
	`¥o˚ss_bio
(
dc
, 
bio
);

658 
	}
}

660 
	$£t_nodedup_Êag
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

662 i‡(
dc
->
nodedup_Æl
)

663 
bio
->
bi_Êags
 |(1 << 
BIO_NO_DEDUP
);

664 
	}
}

666 
	$dedup_de„r_bio
(
dedup_c⁄fig
 *
dc
, 
bio
 *bio)

668 
dedup_w‹k
 *
d©a
;

670 
d©a
 = 
	`mempoﬁ_Æloc
(
dc
->
dedup_w‹k_poﬁ
, 
GFP_NOIO
);

671 i‡(!
d©a
) {

672 
	`bio_ídio
(
bio
, -
ENOMEM
);

676 
	`£t_nodedup_Êag
(
dc
, 
bio
);

678 
d©a
->
bio
 = bio;

679 
d©a
->
c⁄fig
 = 
dc
;

681 
	`INIT_WORK
(&(
d©a
->
w‹kî
), 
do_w‹k
);

683 
	`queue_w‹k
(
dc
->
w‹kqueue
, &(
d©a
->
w‹kî
));

684 
	}
}

686 
	$dm_dedup_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

688 
	`dedup_de„r_bio
(
ti
->
¥iv©e
, 
bio
);

690  
DM_MAPIO_SUBMITTED
;

691 
	}
}

693 
	sdedup_¨gs
 {

694 
dm_èrgë
 *
	mti
;

696 
dm_dev
 *
	mmëa_dev
;

698 
dm_dev
 *
	md©a_dev
;

699 
uöt64_t
 
	md©a_size
;

701 
uöt32_t
 
	mblock_size
;

703 
	mhash_Ægo
[
CRYPTO_ALG_NAME_LEN
];

705 
backíd
 
	mbackíd
;

706 
	mbackíd_°r
[
MAX_BACKEND_NAME_LEN
];

708 
uöt32_t
 
	mÊushrq
;

710 
	mnodedup_Æl
;

713 
	$∑r£_nodedup_höt_Æl
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

714 **
îr
)

716 i‡(
	`k°πoöt
(
	`dm_shi·_¨g
(
as
), 10, &
da
->
nodedup_Æl
) ||

717 (
da
->
nodedup_Æl
 != 0 && da->nodedup_all != 1)) {

718 *
îr
 = "Invalid value forÇodedupáll hint";

719  -
EINVAL
;

723 
	}
}

725 
	$∑r£_mëa_dev
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

726 **
îr
)

728 
r
;

730 
r
 = 
	`dm_gë_devi˚
(
da
->
ti
, 
	`dm_shi·_¨g
(
as
),

731 
	`dm_èbÀ_gë_mode
(
da
->
ti
->
èbÀ
), &da->
mëa_dev
);

732 i‡(
r
)

733 *
îr
 = "Error opening metadata device";

735  
r
;

736 
	}
}

738 
	$∑r£_d©a_dev
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

739 **
îr
)

741 
r
;

743 
r
 = 
	`dm_gë_devi˚
(
da
->
ti
, 
	`dm_shi·_¨g
(
as
),

744 
	`dm_èbÀ_gë_mode
(
da
->
ti
->
èbÀ
), &da->
d©a_dev
);

745 i‡(
r
)

746 *
îr
 = "Error opening data device";

748 
da
->
d©a_size
 = 
	`i_size_ªad
(da->
d©a_dev
->
bdev
->
bd_öode
);

750  
r
;

751 
	}
}

753 
	$∑r£_block_size
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

754 **
îr
)

756 
uöt32_t
 
block_size
;

758 i‡(
	`k°πou32
(
	`dm_shi·_¨g
(
as
), 10, &
block_size
) ||

759 !
block_size
 ||

760 
block_size
 < 
MIN_DATA_DEV_BLOCK_SIZE
 ||

761 
block_size
 > 
MAX_DATA_DEV_BLOCK_SIZE
 ||

762 !
	`is_powî_of_2
(
block_size
)) {

763 *
îr
 = "Invalid data block size";

764  -
EINVAL
;

767 i‡(
block_size
 > 
da
->
d©a_size
) {

768 *
îr
 = "Data block size isÜargerÅhanÅhe data device";

769  -
EINVAL
;

772 
da
->
block_size
 = block_size;

775 
	}
}

777 
	$∑r£_hash_Ægo
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

778 **
îr
)

780 
	`°æ˝y
(
da
->
hash_Ægo
, 
	`dm_shi·_¨g
(
as
), 
CRYPTO_ALG_NAME_LEN
);

782 i‡(!
	`¸y±o_has_hash
(
da
->
hash_Ægo
, 0, 
CRYPTO_ALG_ASYNC
)) {

783 *
îr
 = "Unrecognized hashálgorithm";

784  -
EINVAL
;

788 
	}
}

790 
	$∑r£_backíd
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

791 **
îr
)

793 
backíd
[
MAX_BACKEND_NAME_LEN
];

795 
	`°æ˝y
(
backíd
, 
	`dm_shi·_¨g
(
as
), 
MAX_BACKEND_NAME_LEN
);

797 i‡(!
	`°rcmp
(
backíd
, "inram"))

798 
da
->
backíd
 = 
BKND_INRAM
;

799 i‡(!
	`°rcmp
(
backíd
, "cowbtree"))

800 
da
->
backíd
 = 
BKND_COWBTREE
;

802 *
îr
 = "Unsupported metadata backend";

803  -
EINVAL
;

806 
	`°æ˝y
(
da
->
backíd_°r
, 
backíd
, 
MAX_BACKEND_NAME_LEN
);

809 
	}
}

811 
	$∑r£_Êushrq
(
dedup_¨gs
 *
da
, 
dm_¨g_£t
 *
as
,

812 **
îr
)

814 i‡(
	`k°πou32
(
	`dm_shi·_¨g
(
as
), 10, &
da
->
Êushrq
))

815  -
EINVAL
;

818 
	}
}

820 
	$∑r£_dedup_¨gs
(
dedup_¨gs
 *
da
, 
¨gc
,

821 **
¨gv
, **
îr
)

823 
dm_¨g_£t
 
as
;

824 
r
;

826 i‡(
¨gc
 < 7) {

827 *
îr
 = "Insufficientárgs";

828  -
EINVAL
;

831 i‡(
¨gc
 > 7) {

832 *
îr
 = "Too manyárgs";

833  -
EINVAL
;

836 
as
.
¨gc
 =árgc;

837 
as
.
¨gv
 =árgv;

839 
r
 = 
	`∑r£_mëa_dev
(
da
, &
as
, 
îr
);

840 i‡(
r
)

841  
r
;

843 
r
 = 
	`∑r£_d©a_dev
(
da
, &
as
, 
îr
);

844 i‡(
r
)

845  
r
;

847 
r
 = 
	`∑r£_block_size
(
da
, &
as
, 
îr
);

848 i‡(
r
)

849  
r
;

851 
r
 = 
	`∑r£_hash_Ægo
(
da
, &
as
, 
îr
);

852 i‡(
r
)

853  
r
;

855 
r
 = 
	`∑r£_backíd
(
da
, &
as
, 
îr
);

856 i‡(
r
)

857  
r
;

859 
r
 = 
	`∑r£_Êushrq
(
da
, &
as
, 
îr
);

860 i‡(
r
)

861  
r
;

863 
r
 = 
	`∑r£_nodedup_höt_Æl
(
da
, &
as
, 
îr
);

864 i‡(
r
)

865  
r
;

868 
	}
}

870 
	$de°roy_dedup_¨gs
(
dedup_¨gs
 *
da
)

872 i‡(
da
->
mëa_dev
)

873 
	`dm_put_devi˚
(
da
->
ti
, da->
mëa_dev
);

875 i‡(
da
->
d©a_dev
)

876 
	`dm_put_devi˚
(
da
->
ti
, da->
d©a_dev
);

877 
	}
}

879 
	$dm_dedup_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

881 
dedup_¨gs
 
da
;

882 
dedup_c⁄fig
 *
dc
;

883 
w‹kqueue_°ru˘
 *
wq
;

885 
öô_∑øm_öøm
 
ù¨am_öøm
;

886 
öô_∑øm_cowbåì
 
ù¨am_cowbåì
;

887 *
ù¨am
 = 
NULL
;

888 
mëad©a
 *
md
 = 
NULL
;

890 
£˘‹_t
 
d©a_size
;

891 
r
;

892 
¸y±o_key_size
;

894 
⁄_disk_°©s
 *
d©a
 = 
NULL
;

895 
uöt64_t
 
logiˇl_block_cou¡î
 = 0;

896 
uöt64_t
 
physiˇl_block_cou¡î
 = 0;

898 
mempoﬁ_t
 *
dedup_w‹k_poﬁ
 = 
NULL
;

900 
boﬁ
 
unf‹m©ãd
;

902 
	`mem£t
(&
da
, 0, (
dedup_¨gs
));

903 
da
.
ti
 =Åi;

905 
r
 = 
	`∑r£_dedup_¨gs
(&
da
, 
¨gc
, 
¨gv
, &
ti
->
îr‹
);

906 i‡(
r
)

907 
out
;

909 
dc
 = 
	`kzÆloc
((*dc), 
GFP_KERNEL
);

910 i‡(!
dc
) {

911 
ti
->
îr‹
 = "Errorállocating memory for dedup config";

912 
r
 = -
ENOMEM
;

913 
out
;

916 
wq
 = 
	`¸óã_sögÀthªad_w‹kqueue
("dm-dedup");

917 i‡(!
wq
) {

918 
ti
->
îr‹
 = "failedÅo create workqueue";

919 
r
 = -
ENOMEM
;

920 
bad_wq
;

923 
dedup_w‹k_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
MIN_DEDUP_WORK_IO
,

924 (
dedup_w‹k
));

925 i‡(!
dedup_w‹k_poﬁ
) {

926 
r
 = -
ENOMEM
;

927 
ti
->
îr‹
 = "failedÅo create mempool";

928 
bad_mempoﬁ
;

931 
dc
->
io_˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

932 i‡(
	`IS_ERR
(
dc
->
io_˛õ¡
)) {

933 
r
 = 
	`PTR_ERR
(
dc
->
io_˛õ¡
);

934 
ti
->
îr‹
 = "failedÅo create dm_io_client";

935 
bad_io_˛õ¡
;

938 
dc
->
block_size
 = 
da
.block_size;

939 
dc
->
£˘‹s_≥r_block
 = 
	`to_£˘‹
(
da
.
block_size
);

940 
d©a_size
 = 
ti
->
Àn
;

941 (Ë
	`£˘‹_div
(
d©a_size
, 
dc
->
£˘‹s_≥r_block
);

942 
dc
->
lblocks
 = 
d©a_size
;

944 
d©a_size
 = 
	`i_size_ªad
(
da
.
d©a_dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

945 (Ë
	`£˘‹_div
(
d©a_size
, 
dc
->
£˘‹s_≥r_block
);

946 
dc
->
pblocks
 = 
d©a_size
;

949 
da
.
backíd
) {

950 
BKND_INRAM
:

951 
dc
->
md›s
 = &
mëad©a_›s_öøm
;

952 
ù¨am_öøm
.
blocks
 = 
dc
->
pblocks
;

953 
ù¨am
 = &
ù¨am_öøm
;

955 
BKND_COWBTREE
:

956 
dc
->
md›s
 = &
mëad©a_›s_cowbåì
;

957 
ù¨am_cowbåì
.
blocks
 = 
dc
->
pblocks
;

958 
ù¨am_cowbåì
.
mëad©a_bdev
 = 
da
.
mëa_dev
->
bdev
;

959 
ù¨am
 = &
ù¨am_cowbåì
;

962 
	`°r˝y
(
dc
->
backíd_°r
, 
da
.backend_str);

964 
md
 = 
dc
->
md›s
->
	`öô_mëa
(
ù¨am
, &
unf‹m©ãd
);

965 i‡(
	`IS_ERR
(
md
)) {

966 
ti
->
îr‹
 = "failedÅo initialize backend metadata";

967 
r
 = 
	`PTR_ERR
(
md
);

968 
bad_mëad©a_öô
;

971 
dc
->
desc_èbÀ
 = 
	`desc_èbÀ_öô
(
da
.
hash_Ægo
);

972 i‡(!
dc
->
desc_èbÀ
 || 
	`IS_ERR
(dc->desc_table)) {

973 
ti
->
îr‹
 = "failedÅo initialize crypto API";

974 
r
 = 
	`PTR_ERR
(
dc
->
desc_èbÀ
);

975 
bad_mëad©a_öô
;

978 
¸y±o_key_size
 = 
	`gë_hash_dige°size
(
dc
->
desc_èbÀ
);

980 
dc
->
kvs_hash_pbn
 = dc->
md›s
->
	`kvs_¸óã_•¨£
(
md
, 
¸y±o_key_size
,

981 (
hash_pbn_vÆue
),

982 
dc
->
pblocks
, 
unf‹m©ãd
);

983 i‡(
	`IS_ERR
(
dc
->
kvs_hash_pbn
)) {

984 
r
 = 
	`PTR_ERR
(
dc
->
kvs_hash_pbn
);

985 
ti
->
îr‹
 = "failedÅo create sparse KVS";

986 
bad_kv°‹e_öô
;

989 
dc
->
kvs_lbn_pbn
 = dc->
md›s
->
	`kvs_¸óã_löór
(
md
, 8,

990 (
lbn_pbn_vÆue
), 
dc
->
lblocks
, 
unf‹m©ãd
);

991 i‡(
	`IS_ERR
(
dc
->
kvs_lbn_pbn
)) {

992 
ti
->
îr‹
 = "failedÅo createÜinear KVS";

993 
r
 = 
	`PTR_ERR
(
dc
->
kvs_lbn_pbn
);

994 
bad_kv°‹e_öô
;

997 
r
 = 
dc
->
md›s
->
	`Êush_mëa
(
md
);

998 i‡(
r
 < 0) {

999 
ti
->
îr‹
 = "failedÅo flush metadata";

1000 
bad_kv°‹e_öô
;

1003 i‡(!
unf‹m©ãd
 && 
dc
->
md›s
->
gë_¥iv©e_d©a
) {

1004 
r
 = 
dc
->
md›s
->
	`gë_¥iv©e_d©a
(
md
, (**)&
d©a
,

1005 (
⁄_disk_°©s
));

1006 i‡(
r
 < 0) {

1007 
ti
->
îr‹
 = "failedÅo getÖrivate data from superblock";

1008 
bad_kv°‹e_öô
;

1011 
logiˇl_block_cou¡î
 = 
d©a
->logical_block_counter;

1012 
physiˇl_block_cou¡î
 = 
d©a
->physical_block_counter;

1015 
dc
->
d©a_dev
 = 
da
.data_dev;

1016 
dc
->
mëad©a_dev
 = 
da
.
mëa_dev
;

1018 
dc
->
w‹kqueue
 = 
wq
;

1019 
dc
->
dedup_w‹k_poﬁ
 = dedup_work_pool;

1020 
dc
->
bmd
 = 
md
;

1022 
dc
->
nodedup_Æl
 = 
da
.nodedup_all;

1024 
dc
->
logiˇl_block_cou¡î
 =Üogical_block_counter;

1025 
dc
->
physiˇl_block_cou¡î
 =Öhysical_block_counter;

1027 
dc
->
wrôes
 = 0;

1028 
dc
->
dupwrôes
 = 0;

1029 
dc
->
uniqwrôes
 = 0;

1030 
dc
->
ªads_⁄_wrôes
 = 0;

1031 
dc
->
ovîwrôes
 = 0;

1032 
dc
->
√wwrôes
 = 0;

1033 
dc
->
nodedup_wrôes
 = 0;

1035 
	`°r˝y
(
dc
->
¸y±o_Æg
, 
da
.
hash_Ægo
);

1036 
dc
->
¸y±o_key_size
 = crypto_key_size;

1038 
dc
->
Êushrq
 = 
da
.flushrq;

1039 
dc
->
wrôes_a·î_Êush
 = 0;

1041 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
dc
->
£˘‹s_≥r_block
);

1042 i‡(
r
)

1043 
bad_kv°‹e_öô
;

1045 
ti
->
¥iv©e
 = 
dc
;

1049 
bad_kv°‹e_öô
:

1050 
	`desc_èbÀ_deöô
(
dc
->
desc_èbÀ
);

1051 
bad_mëad©a_öô
:

1052 i‡(
md
 && !
	`IS_ERR
(md))

1053 
dc
->
md›s
->
	`exô_mëa
(
md
);

1054 
	`dm_io_˛õ¡_de°roy
(
dc
->
io_˛õ¡
);

1055 
bad_io_˛õ¡
:

1056 
	`mempoﬁ_de°roy
(
dedup_w‹k_poﬁ
);

1057 
bad_mempoﬁ
:

1058 
	`de°roy_w‹kqueue
(
wq
);

1059 
bad_wq
:

1060 
	`k‰ì
(
dc
);

1061 
out
:

1062 
	`de°roy_dedup_¨gs
(&
da
);

1063  
r
;

1064 
	}
}

1066 
	$dm_dedup_då
(
dm_èrgë
 *
ti
)

1068 
dedup_c⁄fig
 *
dc
 = 
ti
->
¥iv©e
;

1069 
⁄_disk_°©s
 
d©a
;

1070 
ªt
;

1072 i‡(
dc
->
md›s
->
£t_¥iv©e_d©a
) {

1073 
d©a
.
physiˇl_block_cou¡î
 = 
dc
->physical_block_counter;

1074 
d©a
.
logiˇl_block_cou¡î
 = 
dc
->logical_block_counter;

1076 
ªt
 = 
dc
->
md›s
->
	`£t_¥iv©e_d©a
(dc->
bmd
, &
d©a
,

1077 (
⁄_disk_°©s
));

1078 i‡(
ªt
 < 0)

1079 
	`DMERR
("FailedÅo setÅheÖrivate data in superblock.");

1082 
ªt
 = 
dc
->
md›s
->
	`Êush_mëa
(dc->
bmd
);

1083 i‡(
ªt
 < 0)

1084 
	`DMERR
("FailedÅo flushÅhe metadataÅo disk.");

1086 
	`Êush_w‹kqueue
(
dc
->
w‹kqueue
);

1087 
	`de°roy_w‹kqueue
(
dc
->
w‹kqueue
);

1089 
	`mempoﬁ_de°roy
(
dc
->
dedup_w‹k_poﬁ
);

1091 
dc
->
md›s
->
	`exô_mëa
(dc->
bmd
);

1093 
	`dm_io_˛õ¡_de°roy
(
dc
->
io_˛õ¡
);

1095 
	`dm_put_devi˚
(
ti
, 
dc
->
d©a_dev
);

1096 
	`dm_put_devi˚
(
ti
, 
dc
->
mëad©a_dev
);

1097 
	`desc_èbÀ_deöô
(
dc
->
desc_èbÀ
);

1099 
	`k‰ì
(
dc
);

1100 
	}
}

1102 
	$dm_dedup_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
°©us_ty≥
,

1103 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1105 
dedup_c⁄fig
 *
dc
 = 
ti
->
¥iv©e
;

1106 
uöt64_t
 
d©a_tŸÆ_block_cou¡
;

1107 
uöt64_t
 
d©a_u£d_block_cou¡
;

1108 
uöt64_t
 
d©a_‰ì_block_cou¡
;

1109 
uöt64_t
 
d©a_a˘uÆ_block_cou¡
;

1110 
sz
 = 0;

1112 
	`¥ötk
(
KERN_ALERT
 "Anshul -> dm_dedup_status\n");

1114 
°©us_ty≥
) {

1115 
STATUSTYPE_INFO
:

1116 
d©a_u£d_block_cou¡
 = 
dc
->
physiˇl_block_cou¡î
;

1117 
d©a_a˘uÆ_block_cou¡
 = 
dc
->
logiˇl_block_cou¡î
;

1118 
d©a_tŸÆ_block_cou¡
 = 
dc
->
pblocks
;

1120 
d©a_‰ì_block_cou¡
 =

1121 
d©a_tŸÆ_block_cou¡
 - 
d©a_u£d_block_cou¡
;

1123 
	`DMEMIT
("%llu %llu %llu %llu ",

1124 
d©a_tŸÆ_block_cou¡
, 
d©a_‰ì_block_cou¡
,

1125 
d©a_u£d_block_cou¡
, 
d©a_a˘uÆ_block_cou¡
);

1127 
	`DMEMIT
("%u %†%†", 
dc
->
block_size
,

1128 
dc
->
d©a_dev
->
«me
, dc->
mëad©a_dev
->name);

1130 
	`DMEMIT
("%llu %llu %llu %llu %llu %llu %llu",

1131 
dc
->
wrôes
, dc->
uniqwrôes
, dc->
dupwrôes
,

1132 
dc
->
ªads_⁄_wrôes
, dc->
ovîwrôes
, dc->
√wwrôes
, dc->
nodedup_wrôes
);

1134 
STATUSTYPE_TABLE
:

1135 
	`DMEMIT
("%s %s %u %s %s %u",

1136 
dc
->
mëad©a_dev
->
«me
, dc->
d©a_dev
->«me, dc->
block_size
,

1137 
dc
->
¸y±o_Æg
, dc->
backíd_°r
, dc->
Êushrq
);

1139 
	`h™dÀ_ofÊöe_dedup
(
ti
->
¥iv©e
);

1141 
	}
}

1143 
	$˛ónup_hash_pbn
(*
key
, 
öt32_t
 
ksize
, *
vÆue
,

1144 
öt32_t
 
vsize
, *
d©a
)

1146 
r
 = 0;

1147 
uöt64_t
 
pbn_vÆ
 = 0;

1148 
hash_pbn_vÆue
 
hashpbn_vÆue
 = *((hash_pbn_vÆuê*)
vÆue
);

1149 
dedup_c⁄fig
 *
dc
 = (dedup_c⁄fig *)
d©a
;

1151 
	`BUG_ON
(!
d©a
);

1153 
pbn_vÆ
 = 
hashpbn_vÆue
.
pbn
;

1155 i‡(
dc
->
md›s
->
	`gë_ªfcou¡
(dc->
bmd
, 
pbn_vÆ
) == 1) {

1156 
r
 = 
dc
->
kvs_hash_pbn
->
	`kvs_dñëe
(dc->kvs_hash_pbn,

1157 
key
, 
ksize
);

1158 i‡(
r
 < 0)

1159 
out
;

1161 
r
 = 
dc
->
md›s
->
	`dec_ªfcou¡
(dc->
bmd
, 
pbn_vÆ
);

1162 i‡(
r
 < 0)

1163 
out_dec_ªfcou¡
;

1165 
dc
->
physiˇl_block_cou¡î
 -= 1;

1168 
out
;

1170 
out_dec_ªfcou¡
:

1171 
dc
->
kvs_hash_pbn
->
	`kvs_ö£π
(dc->kvs_hash_pbn, 
key
,

1172 
ksize
, (*)&
hashpbn_vÆue
,

1173 (
hashpbn_vÆue
));

1174 
out
:

1175  
r
;

1176 
	}
}

1178 
	$g¨bage_cﬁÀ˘
(
dedup_c⁄fig
 *
dc
)

1180 
îr
 = 0;

1182 
	`BUG_ON
(!
dc
);

1185 
îr
 = 
dc
->
kvs_hash_pbn
->
	`kvs_ôî©e
(dc->kvs_hash_pbn,

1186 &
˛ónup_hash_pbn
, (*)
dc
);

1188  
îr
;

1189 
	}
}

1191 
	$dm_dedup_mesßge
(
dm_èrgë
 *
ti
,

1192 
¨gc
, **
¨gv
)

1194 
r
 = 0;

1196 
dedup_c⁄fig
 *
dc
 = 
ti
->
¥iv©e
;

1198 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "garbage_collect")) {

1199 
r
 = 
	`g¨bage_cﬁÀ˘
(
dc
);

1200 i‡(
r
 < 0)

1201 
	`DMERR
("Eº‹ i¿≥rf‹mög g¨bage_cﬁÀ˘: %d.", 
r
);

1202 } i‡(!
	`°rˇ£cmp
(
¨gv
[0], "drop_bufio_cache")) {

1203 i‡(
dc
->
md›s
->
Êush_bufio_ˇche
)

1204 
dc
->
md›s
->
	`Êush_bufio_ˇche
(dc->
bmd
);

1206 
r
 = -
ENOTSUPP
;

1208 
r
 = -
EINVAL
;

1210  
r
;

1211 
	}
}

1213 
	$dm_dedup_ídio
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

1215 i‡(
îr‹
 || 
	`bio_d©a_dú
(
bio
Ë!
READ
)

1219 
	}
}

1221 
èrgë_ty≥
 
	gdm_dedup_èrgë
 = {

1222 .
«me
 = "dedup",

1223 .
	gvîsi⁄
 = {1, 0, 0},

1224 .
	gmoduÀ
 = 
THIS_MODULE
,

1225 .
	g˘r
 = 
dm_dedup_˘r
,

1226 .
	gdå
 = 
dm_dedup_då
,

1227 .
	gm≠
 = 
dm_dedup_m≠
,

1228 .
	gíd_io
 = 
dm_dedup_ídio
,

1229 .
	gmesßge
 = 
dm_dedup_mesßge
,

1230 .
	g°©us
 = 
dm_dedup_°©us
,

1233 
__öô
 
	$dm_dedup_öô
()

1235 
r
;

1237 
r
 = 
	`dm_ªgi°î_èrgë
(&
dm_dedup_èrgë
);

1238 i‡(
r
)

1239  
r
;

1242 
	}
}

1244 
__exô
 
	$dm_dedup_exô
()

1246 
	`dm_uƒegi°î_èrgë
(&
dm_dedup_èrgë
);

1247 
	}
}

1249 
moduÀ_öô
(
dm_dedup_öô
);

1250 
moduÀ_exô
(
dm_dedup_exô
);

1252 
MODULE_DESCRIPTION
(
DM_NAME
 "Åarget for data deduplication");

1253 
MODULE_LICENSE
("GPL");

	@dm-dedup-target.h

13 #i‚de‡
DM_DEDUP_H


14 
	#DM_DEDUP_H


	)

16 
	~<löux/moduÀ.h
>

17 
	~<löux/öô.h
>

18 
	~<löux/kî√l.h
>

19 
	~<löux/devi˚-m≠≥r.h
>

20 
	~<löux/dm-io.h
>

21 
	~<löux/dm-kc›yd.h
>

22 
	~<löux/li°.h
>

23 
	~<löux/îr.h
>

24 
	~<asm/cuºít.h
>

25 
	~<löux/°rög.h
>

26 
	~<löux/gÂ.h
>

27 
	~<löux/dñay.h
>

28 
	~<löux/time.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/blk_ty≥s.h
>

31 
	~<löux/mempoﬁ.h
>

33 
	~<löux/sˇâîli°.h
>

34 
	~<asm/∑ge.h
>

35 
	~<asm/u«lig√d.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<¸y±o/md5.h
>

38 
	~<¸y±o/sha.h
>

39 
	~<¸y±o/Æg≠i.h
>

41 
	#DM_MSG_PREFIX
 "dedup-mod"

	)

43 
	#CRYPTO_ALG_NAME_LEN
 16

	)

44 
	#MAX_DIGEST_SIZE
 
SHA256_DIGEST_SIZE


	)

46 
	#MAX_BACKEND_NAME_LEN
 (64)

	)

48 
	#MIN_DEDUP_WORK_IO
 16

	)

51 
	sdedup_c⁄fig
 {

52 
dm_dev
 *
	md©a_dev
;

53 
dm_dev
 *
	mmëad©a_dev
;

55 
uöt32_t
 
	mblock_size
;

56 
uöt32_t
 
	m£˘‹s_≥r_block
;

58 
uöt32_t
 
	mpblocks
;

59 
uöt32_t
 
	mlblocks
;

61 
w‹kqueue_°ru˘
 *
	mw‹kqueue
;

63 
hash_desc_èbÀ
 *
	mdesc_èbÀ
;

65 
uöt64_t
 
	mlogiˇl_block_cou¡î
;

66 
uöt64_t
 
	mphysiˇl_block_cou¡î
;

68 
uöt64_t
 
	mwrôes
;

69 
uöt64_t
 
	mdupwrôes
;

70 
uöt64_t
 
	muniqwrôes
;

71 
uöt64_t
 
	mªads_⁄_wrôes
;

72 
uöt64_t
 
	movîwrôes
;

73 
uöt64_t
 
	m√wwrôes
;

74 
uöt64_t
 
	mnodedup_wrôes
;

76 
	mnodedup_Æl
;

78 
dm_io_˛õ¡
 *
	mio_˛õ¡
;

81 
	mbackíd_°r
[
MAX_BACKEND_NAME_LEN
];

82 
mëad©a_›s
 *
	mmd›s
;

83 
mëad©a
 *
	mbmd
;

84 
kv°‹e
 *
	mkvs_hash_pbn
;

85 
kv°‹e
 *
	mkvs_lbn_pbn
;

87 
	m¸y±o_Æg
[
CRYPTO_ALG_NAME_LEN
];

88 
	m¸y±o_key_size
;

90 
uöt32_t
 
	mÊushrq
;

91 
uöt64_t
 
	mwrôes_a·î_Êush
;

93 
mempoﬁ_t
 *
	mdedup_w‹k_poﬁ
;

97 
	shash_pbn_vÆue
 {

98 
uöt64_t
 
	mpbn
;

102 
	slbn_pbn_vÆue
 {

103 
uöt64_t
 
	mpbn
;

	@dm-dedup.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x827a42f4, 
__VMLINUX_SYMBOL_STR
(
dm_tm_›í_wôh_sm
) },

24 { 0x543b4234, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

25 { 0x153e70d9, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

26 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

27 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

28 { 0xc897c382, 
__VMLINUX_SYMBOL_STR
(
sg_öô_èbÀ
) },

29 { 0xb7bad799, 
__VMLINUX_SYMBOL_STR
(
dm_bm_u∆ock
) },

30 { 0x96d19383, 
__VMLINUX_SYMBOL_STR
(
__bªad
) },

31 { 0x3d69f5a0, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

32 { 0xed1e1f96, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ªmove
) },

33 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

34 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

35 { 0x2b5a58a3, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

36 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

37 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

38 { 0x688d422d, 
__VMLINUX_SYMBOL_STR
(
dm_bm_block_size
) },

39 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

40 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

41 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

42 { 0xd163ˇde, 
__VMLINUX_SYMBOL_STR
(
dm_tm_commô
) },

43 { 0x9f624559, 
__VMLINUX_SYMBOL_STR
(
dm_sm_disk_›í
) },

44 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

45 { 0x´e02382, 
__VMLINUX_SYMBOL_STR
(
dm_båì_em±y
) },

46 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

47 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

48 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

49 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

50 { 0x72289260, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_de°roy
) },

51 { 0xd14e5bc6, 
__VMLINUX_SYMBOL_STR
(
bio_add_∑ge
) },

52 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

53 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

54 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

55 { 0x5792f848, 
__VMLINUX_SYMBOL_STR
(
°æ˝y
) },

56 { 0xf375d009, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock
) },

57 { 0x5e6´a80, 
__VMLINUX_SYMBOL_STR
(
dm_båì_wÆk
) },

58 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

59 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

60 { 0x2276db98, 
__VMLINUX_SYMBOL_STR
(
k°πoöt
) },

61 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

62 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

63 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

64 { 0x7ade1071, 
__VMLINUX_SYMBOL_STR
(
dm_tm_de°roy
) },

65 { 0x966a8838, 
__VMLINUX_SYMBOL_STR
(
dm_båì_lookup
) },

66 { 0xa„da29f, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock_zîo
) },

67 { 0x63d68f9d, 
__VMLINUX_SYMBOL_STR
(
submô_bio
) },

68 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

69 { 0x49b35849, 
__VMLINUX_SYMBOL_STR
(
dm_sm_disk_¸óã
) },

70 { 0x55b4bd4d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¸óã_wôh_sm
) },

71 { 0xf5455120, 
__VMLINUX_SYMBOL_STR
(
dm_bm_ªad_lock
) },

72 { 0x89f1e1cc, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ö£π_nŸify
) },

73 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

74 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

75 { 0x18489876, 
__VMLINUX_SYMBOL_STR
(
¸y±o_de°roy_tfm
) },

76 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

77 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

78 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

79 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
‰ì_∑ges
) },

80 { 0x54f69d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¥e_commô
) },

81 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

82 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

83 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

84 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

85 { 0x69ad2f20, 
__VMLINUX_SYMBOL_STR
(
k°πouöt
) },

86 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

87 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

88 { 0xd091cdcf, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_¸óã
) },

89 { 0x90a1004a, 
__VMLINUX_SYMBOL_STR
(
¸y±o_has_Æg
) },

90 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

91 { 0x1e3f728d, 
__VMLINUX_SYMBOL_STR
(
dm_block_d©a
) },

92 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

93 { 0xb0e602eb, 
__VMLINUX_SYMBOL_STR
(
memmove
) },

94 { 0xˇ40abd5, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ö£π
) },

95 { 0x869526c5, 
__VMLINUX_SYMBOL_STR
(
zîo_fûl_bio
) },

96 { 0x66051eb6, 
__VMLINUX_SYMBOL_STR
(
¸y±o_Æloc_ba£
) },

97 { 0xe914e41e, 
__VMLINUX_SYMBOL_STR
(
°r˝y
) },

100 c⁄° 
	g__moduÀ_dïíds
[]

101 
__u£d


102 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

106 
MODULE_INFO
(
§cvîsi⁄
, "091B5CE6F7B97E1B922559C");

	@dm-delay.c

10 
	~<löux/moduÀ.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/blkdev.h
>

13 
	~<löux/bio.h
>

14 
	~<löux/¶ab.h
>

16 
	~<löux/devi˚-m≠≥r.h
>

18 
	#DM_MSG_PREFIX
 "dñay"

	)

20 
	sdñay_c
 {

21 
timî_li°
 
	mdñay_timî
;

22 
muãx
 
	mtimî_lock
;

23 
w‹kqueue_°ru˘
 *
	mkdñayd_wq
;

24 
w‹k_°ru˘
 
	mÊush_expúed_bios
;

25 
li°_hód
 
	mdñayed_bios
;

26 
©omic_t
 
	mmay_dñay
;

28 
dm_dev
 *
	mdev_ªad
;

29 
£˘‹_t
 
	m°¨t_ªad
;

30 
	mªad_dñay
;

31 
	mªads
;

33 
dm_dev
 *
	mdev_wrôe
;

34 
£˘‹_t
 
	m°¨t_wrôe
;

35 
	mwrôe_dñay
;

36 
	mwrôes
;

39 
	sdm_dñay_öfo
 {

40 
dñay_c
 *
	mc⁄ãxt
;

41 
li°_hód
 
	mli°
;

42 
	mexpúes
;

45 
DEFINE_MUTEX
(
dñayed_bios_lock
);

47 
	$h™dÀ_dñayed_timî
(
d©a
)

49 
dñay_c
 *
dc
 = (dñay_¯*)
d©a
;

51 
	`queue_w‹k
(
dc
->
kdñayd_wq
, &dc->
Êush_expúed_bios
);

52 
	}
}

54 
	$queue_timeout
(
dñay_c
 *
dc
, 
expúes
)

56 
	`muãx_lock
(&
dc
->
timî_lock
);

58 i‡(!
	`timî_≥ndög
(&
dc
->
dñay_timî
Ë|| 
expúes
 < dc->delay_timer.expires)

59 
	`mod_timî
(&
dc
->
dñay_timî
, 
expúes
);

61 
	`muãx_u∆ock
(&
dc
->
timî_lock
);

62 
	}
}

64 
	$Êush_bios
(
bio
 *bio)

66 
bio
 *
n
;

68 
bio
) {

69 
n
 = 
bio
->
bi_√xt
;

70 
bio
->
bi_√xt
 = 
NULL
;

71 
	`gíîic_make_ªque°
(
bio
);

72 
bio
 = 
n
;

74 
	}
}

76 
bio
 *
	$Êush_dñayed_bios
(
dñay_c
 *
dc
, 
Êush_Æl
)

78 
dm_dñay_öfo
 *
dñayed
, *
√xt
;

79 
√xt_expúes
 = 0;

80 
°¨t_timî
 = 0;

81 
bio_li°
 
Êush_bios
 = { };

83 
	`muãx_lock
(&
dñayed_bios_lock
);

84 
	`li°_f‹_óch_íåy_ß„
(
dñayed
, 
√xt
, &
dc
->
dñayed_bios
, 
li°
) {

85 i‡(
Êush_Æl
 || 
	`time_a·î_eq
(
jiffõs
, 
dñayed
->
expúes
)) {

86 
bio
 *biÿ
	`dm_bio_‰om_≥r_bio_d©a
(
dñayed
,

87 (
dm_dñay_öfo
));

88 
	`li°_dñ
(&
dñayed
->
li°
);

89 
	`bio_li°_add
(&
Êush_bios
, 
bio
);

90 i‡((
	`bio_d©a_dú
(
bio
Ë=
WRITE
))

91 
dñayed
->
c⁄ãxt
->
wrôes
--;

93 
dñayed
->
c⁄ãxt
->
ªads
--;

97 i‡(!
°¨t_timî
) {

98 
°¨t_timî
 = 1;

99 
√xt_expúes
 = 
dñayed
->
expúes
;

101 
√xt_expúes
 = 
	`mö
“ext_expúes, 
dñayed
->
expúes
);

104 
	`muãx_u∆ock
(&
dñayed_bios_lock
);

106 i‡(
°¨t_timî
)

107 
	`queue_timeout
(
dc
, 
√xt_expúes
);

109  
	`bio_li°_gë
(&
Êush_bios
);

110 
	}
}

112 
	$Êush_expúed_bios
(
w‹k_°ru˘
 *
w‹k
)

114 
dñay_c
 *
dc
;

116 
dc
 = 
	`c⁄èöî_of
(
w‹k
, 
dñay_c
, 
Êush_expúed_bios
);

117 
	`Êush_bios
(
	`Êush_dñayed_bios
(
dc
, 0));

118 
	}
}

127 
	$dñay_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

129 
dñay_c
 *
dc
;

130 
tm∂l
;

131 
dummy
;

133 i‡(
¨gc
 != 3 &&árgc != 6) {

134 
ti
->
îr‹
 = "requiresÉxactly 3 or 6árguments";

135  -
EINVAL
;

138 
dc
 = 
	`kmÆloc
((*dc), 
GFP_KERNEL
);

139 i‡(!
dc
) {

140 
ti
->
îr‹
 = "Cannotállocate context";

141  -
ENOMEM
;

144 
dc
->
ªads
 = dc->
wrôes
 = 0;

146 i‡(
	`ssˇnf
(
¨gv
[1], "%Œu%c", &
tm∂l
, &
dummy
) != 1) {

147 
ti
->
îr‹
 = "Invalid device sector";

148 
bad
;

150 
dc
->
°¨t_ªad
 = 
tm∂l
;

152 i‡(
	`ssˇnf
(
¨gv
[2], "%u%c", &
dc
->
ªad_dñay
, &
dummy
) != 1) {

153 
ti
->
îr‹
 = "Invalid delay";

154 
bad
;

157 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

158 &
dc
->
dev_ªad
)) {

159 
ti
->
îr‹
 = "DeviceÜookup failed";

160 
bad
;

163 
dc
->
dev_wrôe
 = 
NULL
;

164 i‡(
¨gc
 == 3)

165 
out
;

167 i‡(
	`ssˇnf
(
¨gv
[4], "%Œu%c", &
tm∂l
, &
dummy
) != 1) {

168 
ti
->
îr‹
 = "Invalid write device sector";

169 
bad_dev_ªad
;

171 
dc
->
°¨t_wrôe
 = 
tm∂l
;

173 i‡(
	`ssˇnf
(
¨gv
[5], "%u%c", &
dc
->
wrôe_dñay
, &
dummy
) != 1) {

174 
ti
->
îr‹
 = "Invalid write delay";

175 
bad_dev_ªad
;

178 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[3], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

179 &
dc
->
dev_wrôe
)) {

180 
ti
->
îr‹
 = "Write deviceÜookup failed";

181 
bad_dev_ªad
;

184 
out
:

185 
dc
->
kdñayd_wq
 = 
	`Æloc_w‹kqueue
("kdñayd", 
WQ_MEM_RECLAIM
, 0);

186 i‡(!
dc
->
kdñayd_wq
) {

187 
	`DMERR
("Couldn't start kdelayd");

188 
bad_queue
;

191 
	`£tup_timî
(&
dc
->
dñay_timî
, 
h™dÀ_dñayed_timî
, ()dc);

193 
	`INIT_WORK
(&
dc
->
Êush_expúed_bios
, flush_expired_bios);

194 
	`INIT_LIST_HEAD
(&
dc
->
dñayed_bios
);

195 
	`muãx_öô
(&
dc
->
timî_lock
);

196 
	`©omic_£t
(&
dc
->
may_dñay
, 1);

198 
ti
->
num_Êush_bios
 = 1;

199 
ti
->
num_disˇrd_bios
 = 1;

200 
ti
->
≥r_bio_d©a_size
 = (
dm_dñay_öfo
);

201 
ti
->
¥iv©e
 = 
dc
;

204 
bad_queue
:

205 i‡(
dc
->
dev_wrôe
)

206 
	`dm_put_devi˚
(
ti
, 
dc
->
dev_wrôe
);

207 
bad_dev_ªad
:

208 
	`dm_put_devi˚
(
ti
, 
dc
->
dev_ªad
);

209 
bad
:

210 
	`k‰ì
(
dc
);

211  -
EINVAL
;

212 
	}
}

214 
	$dñay_då
(
dm_èrgë
 *
ti
)

216 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

218 
	`de°roy_w‹kqueue
(
dc
->
kdñayd_wq
);

220 
	`dm_put_devi˚
(
ti
, 
dc
->
dev_ªad
);

222 i‡(
dc
->
dev_wrôe
)

223 
	`dm_put_devi˚
(
ti
, 
dc
->
dev_wrôe
);

225 
	`k‰ì
(
dc
);

226 
	}
}

228 
	$dñay_bio
(
dñay_c
 *
dc
, 
dñay
, 
bio
 *bio)

230 
dm_dñay_öfo
 *
dñayed
;

231 
expúes
 = 0;

233 i‡(!
dñay
 || !
	`©omic_ªad
(&
dc
->
may_dñay
))

236 
dñayed
 = 
	`dm_≥r_bio_d©a
(
bio
, (
dm_dñay_öfo
));

238 
dñayed
->
c⁄ãxt
 = 
dc
;

239 
dñayed
->
expúes
 =Éxpúe†
jiffõs
 + (
dñay
 * 
HZ
 / 1000);

241 
	`muãx_lock
(&
dñayed_bios_lock
);

243 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
)

244 
dc
->
wrôes
++;

246 
dc
->
ªads
++;

248 
	`li°_add_èû
(&
dñayed
->
li°
, &
dc
->
dñayed_bios
);

250 
	`muãx_u∆ock
(&
dñayed_bios_lock
);

252 
	`queue_timeout
(
dc
, 
expúes
);

255 
	}
}

257 
	$dñay_¥esu•íd
(
dm_èrgë
 *
ti
)

259 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

261 
	`©omic_£t
(&
dc
->
may_dñay
, 0);

262 
	`dñ_timî_sync
(&
dc
->
dñay_timî
);

263 
	`Êush_bios
(
	`Êush_dñayed_bios
(
dc
, 1));

264 
	}
}

266 
	$dñay_ªsume
(
dm_èrgë
 *
ti
)

268 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

270 
	`©omic_£t
(&
dc
->
may_dñay
, 1);

271 
	}
}

273 
	$dñay_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

275 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

277 i‡((
	`bio_d©a_dú
(
bio
Ë=
WRITE
Ë&& (
dc
->
dev_wrôe
)) {

278 
bio
->
bi_bdev
 = 
dc
->
dev_wrôe
->
bdev
;

279 i‡(
	`bio_£˘‹s
(
bio
))

280 
bio
->
bi_ôî
.
bi_£˘‹
 = 
dc
->
°¨t_wrôe
 +

281 
	`dm_èrgë_off£t
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

283  
	`dñay_bio
(
dc
, dc->
wrôe_dñay
, 
bio
);

286 
bio
->
bi_bdev
 = 
dc
->
dev_ªad
->
bdev
;

287 
bio
->
bi_ôî
.
bi_£˘‹
 = 
dc
->
°¨t_ªad
 +

288 
	`dm_èrgë_off£t
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

290  
	`dñay_bio
(
dc
, dc->
ªad_dñay
, 
bio
);

291 
	}
}

293 
	$dñay_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

294 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

296 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

297 
sz
 = 0;

299 
ty≥
) {

300 
STATUSTYPE_INFO
:

301 
	`DMEMIT
("%u %u", 
dc
->
ªads
, dc->
wrôes
);

304 
STATUSTYPE_TABLE
:

305 
	`DMEMIT
("%†%Œu %u", 
dc
->
dev_ªad
->
«me
,

306 (Ë
dc
->
°¨t_ªad
,

307 
dc
->
ªad_dñay
);

308 i‡(
dc
->
dev_wrôe
)

309 
	`DMEMIT
(" %†%Œu %u", 
dc
->
dev_wrôe
->
«me
,

310 (Ë
dc
->
°¨t_wrôe
,

311 
dc
->
wrôe_dñay
);

314 
	}
}

316 
	$dñay_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

317 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

319 
dñay_c
 *
dc
 = 
ti
->
¥iv©e
;

320 
ªt
 = 0;

322 
ªt
 = 
	`‚
(
ti
, 
dc
->
dev_ªad
, dc->
°¨t_ªad
,Åi->
Àn
, 
d©a
);

323 i‡(
ªt
)

324 
out
;

326 i‡(
dc
->
dev_wrôe
)

327 
ªt
 = 
	`‚
(
ti
, 
dc
->
dev_wrôe
, dc->
°¨t_wrôe
,Åi->
Àn
, 
d©a
);

329 
out
:

330  
ªt
;

331 
	}
}

333 
èrgë_ty≥
 
	gdñay_èrgë
 = {

334 .
«me
 = "delay",

335 .
	gvîsi⁄
 = {1, 2, 1},

336 .
	gmoduÀ
 = 
THIS_MODULE
,

337 .
	g˘r
 = 
dñay_˘r
,

338 .
	gdå
 = 
dñay_då
,

339 .
	gm≠
 = 
dñay_m≠
,

340 .
	g¥esu•íd
 = 
dñay_¥esu•íd
,

341 .
	gªsume
 = 
dñay_ªsume
,

342 .
	g°©us
 = 
dñay_°©us
,

343 .
	gôî©e_devi˚s
 = 
dñay_ôî©e_devi˚s
,

346 
__öô
 
	$dm_dñay_öô
()

348 
r
;

350 
r
 = 
	`dm_ªgi°î_èrgë
(&
dñay_èrgë
);

351 i‡(
r
 < 0) {

352 
	`DMERR
("ªgi°î faûed %d", 
r
);

353 
bad_ªgi°î
;

358 
bad_ªgi°î
:

359  
r
;

360 
	}
}

362 
__exô
 
	$dm_dñay_exô
()

364 
	`dm_uƒegi°î_èrgë
(&
dñay_èrgë
);

365 
	}
}

368 
moduÀ_öô
(
dm_dñay_öô
);

369 
moduÀ_exô
(
dm_dñay_exô
);

371 
MODULE_DESCRIPTION
(
DM_NAME
 " delayÅarget");

372 
MODULE_AUTHOR
("Heinz Mauelshagen <mauelshagen@redhat.com>");

373 
MODULE_LICENSE
("GPL");

	@dm-delay.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

25 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

26 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

27 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

28 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

29 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

30 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

31 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

32 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

33 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

34 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

35 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

36 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

37 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

38 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

39 { 0xd5f2172f, 
__VMLINUX_SYMBOL_STR
(
dñ_timî_sync
) },

40 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

41 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

42 { 0x8834396c, 
__VMLINUX_SYMBOL_STR
(
mod_timî
) },

43 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

44 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

45 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

48 c⁄° 
	g__moduÀ_dïíds
[]

49 
__u£d


50 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

54 
MODULE_INFO
(
§cvîsi⁄
, "A269EE8143A5E63BFF00C18");

	@dm-era-target.c

1 
	~"dm.h
"

2 
	~"≥rsi°ít-d©a/dm-å™ß˘i⁄-m™agî.h
"

3 
	~"≥rsi°ít-d©a/dm-bô£t.h
"

4 
	~"≥rsi°ít-d©a/dm-•a˚-m≠.h
"

6 
	~<löux/dm-io.h
>

7 
	~<löux/dm-kc›yd.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/mempoﬁ.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/vmÆloc.h
>

14 
	#DM_MSG_PREFIX
 "îa"

	)

16 
	#SUPERBLOCK_LOCATION
 0

	)

17 
	#SUPERBLOCK_MAGIC
 2126579579

	)

18 
	#SUPERBLOCK_CSUM_XOR
 146538381

	)

19 
	#MIN_ERA_VERSION
 1

	)

20 
	#MAX_ERA_VERSION
 1

	)

21 
	#INVALID_WRITESET_ROOT
 
SUPERBLOCK_LOCATION


	)

22 
	#MIN_BLOCK_SIZE
 8

	)

27 
	swrôe£t_mëad©a
 {

28 
uöt32_t
 
	mƒ_bôs
;

29 
dm_block_t
 
	mroŸ
;

32 
	swrôe£t
 {

33 
wrôe£t_mëad©a
 
	mmd
;

39 *
	mbôs
;

46 
	$wrôe£t_‰ì
(
wrôe£t
 *
ws
)

48 
	`v‰ì
(
ws
->
bôs
);

49 
	}
}

51 
	$£tup_⁄_disk_bô£t
(
dm_disk_bô£t
 *
öfo
,

52 
ƒ_bôs
, 
dm_block_t
 *
roŸ
)

54 
r
;

56 
r
 = 
	`dm_bô£t_em±y
(
öfo
, 
roŸ
);

57 i‡(
r
)

58  
r
;

60  
	`dm_bô£t_ªsize
(
öfo
, *
roŸ
, 0, 
ƒ_bôs
, 
Ál£
,Ñoot);

61 
	}
}

63 
size_t
 
	$bô£t_size
(
ƒ_bôs
)

65  (Ë* 
	`dm_div_up
(
ƒ_bôs
, 
BITS_PER_LONG
);

66 
	}
}

71 
	$wrôe£t_Æloc
(
wrôe£t
 *
ws
, 
dm_block_t
 
ƒ_blocks
)

73 
ws
->
md
.
ƒ_bôs
 = 
ƒ_blocks
;

74 
ws
->
md
.
roŸ
 = 
INVALID_WRITESET_ROOT
;

75 
ws
->
bôs
 = 
	`vzÆloc
(
	`bô£t_size
(
ƒ_blocks
));

76 i‡(!
ws
->
bôs
) {

77 
	`DMERR
("%s: couldn'àÆloˇã i¿mem‹y bô£t", 
__func__
);

78  -
ENOMEM
;

82 
	}
}

87 
	$wrôe£t_öô
(
dm_disk_bô£t
 *
öfo
, 
wrôe£t
 *
ws
)

89 
r
;

91 
	`mem£t
(
ws
->
bôs
, 0, 
	`bô£t_size
(ws->
md
.
ƒ_bôs
));

93 
r
 = 
	`£tup_⁄_disk_bô£t
(
öfo
, 
ws
->
md
.
ƒ_bôs
, &ws->md.
roŸ
);

94 i‡(
r
) {

95 
	`DMERR
("%s: sëup_⁄_disk_bô£àÁûed", 
__func__
);

96  
r
;

100 
	}
}

102 
boﬁ
 
	$wrôe£t_m¨ked
(
wrôe£t
 *
ws
, 
dm_block_t
 
block
)

104  
	`ã°_bô
(
block
, 
ws
->
bôs
);

105 
	}
}

107 
	$wrôe£t_m¨ked_⁄_disk
(
dm_disk_bô£t
 *
öfo
,

108 
wrôe£t_mëad©a
 *
m
, 
dm_block_t
 
block
,

109 
boﬁ
 *
ªsu…
)

111 
dm_block_t
 
ﬁd
 = 
m
->
roŸ
;

117 
r
 = 
	`dm_bô£t_ã°_bô
(
öfo
, 
m
->
roŸ
, 
block
, &m->roŸ, 
ªsu…
);

118 i‡(
r
) {

119 
	`DMERR
("%s: dm_bô£t_ã°_bô faûed", 
__func__
);

120  
r
;

123 
	`BUG_ON
(
m
->
roŸ
 !
ﬁd
);

125  
r
;

126 
	}
}

131 
	$wrôe£t_ã°_™d_£t
(
dm_disk_bô£t
 *
öfo
,

132 
wrôe£t
 *
ws
, 
uöt32_t
 
block
)

134 
r
;

136 i‡(!
	`ã°_™d_£t_bô
(
block
, 
ws
->
bôs
)) {

137 
r
 = 
	`dm_bô£t_£t_bô
(
öfo
, 
ws
->
md
.
roŸ
, 
block
, &ws->md.root);

138 i‡(
r
) {

140  
r
;

147 
	}
}

152 
	#SPACE_MAP_ROOT_SIZE
 128

	)

153 
	#UUID_LEN
 16

	)

155 
	swrôe£t_disk
 {

156 
__À32
 
	mƒ_bôs
;

157 
__À64
 
	mroŸ
;

158 } 
	g__∑cked
;

160 
	ssu≥rblock_disk
 {

161 
__À32
 
	mcsum
;

162 
__À32
 
	mÊags
;

163 
__À64
 
	mblockƒ
;

165 
__u8
 
	muuid
[
UUID_LEN
];

166 
__À64
 
	mmagic
;

167 
__À32
 
	mvîsi⁄
;

169 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

171 
__À32
 
	md©a_block_size
;

172 
__À32
 
	mmëad©a_block_size
;

173 
__À32
 
	mƒ_blocks
;

175 
__À32
 
	mcuºít_îa
;

176 
wrôe£t_disk
 
	mcuºít_wrôe£t
;

181 
__À64
 
	mwrôe£t_åì_roŸ
;

182 
__À64
 
	mîa_¨øy_roŸ
;

184 
__À64
 
	mmëad©a_¢≠
;

185 } 
	g__∑cked
;

190 
	$sb_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

191 
dm_block
 *
b
,

192 
size_t
 
sb_block_size
)

194 
su≥rblock_disk
 *
disk
 = 
	`dm_block_d©a
(
b
);

196 
disk
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

197 
disk
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&disk->
Êags
,

198 
sb_block_size
 - (
__À32
),

199 
SUPERBLOCK_CSUM_XOR
));

200 
	}
}

202 
	$check_mëad©a_vîsi⁄
(
su≥rblock_disk
 *
disk
)

204 
uöt32_t
 
mëad©a_vîsi⁄
 = 
	`À32_to_˝u
(
disk
->
vîsi⁄
);

205 i‡(
mëad©a_vîsi⁄
 < 
MIN_ERA_VERSION
 || mëad©a_vîsi⁄ > 
MAX_ERA_VERSION
) {

206 
	`DMERR
("Era metadata version %u found, but only versions between %uánd %u supported.",

207 
mëad©a_vîsi⁄
, 
MIN_ERA_VERSION
, 
MAX_ERA_VERSION
);

208  -
EINVAL
;

212 
	}
}

214 
	$sb_check
(
dm_block_vÆid©‹
 *
v
,

215 
dm_block
 *
b
,

216 
size_t
 
sb_block_size
)

218 
su≥rblock_disk
 *
disk
 = 
	`dm_block_d©a
(
b
);

219 
__À32
 
csum_À
;

221 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
disk
->
blockƒ
)) {

222 
	`DMERR
("sb_check failed: blocknr %llu: wanted %llu",

223 
	`À64_to_˝u
(
disk
->
blockƒ
),

224 ()
	`dm_block_loˇti⁄
(
b
));

225  -
ENOTBLK
;

228 i‡(
	`À64_to_˝u
(
disk
->
magic
Ë!
SUPERBLOCK_MAGIC
) {

229 
	`DMERR
("sb_check failed: magic %llu: wanted %llu",

230 
	`À64_to_˝u
(
disk
->
magic
),

231 (Ë
SUPERBLOCK_MAGIC
);

232  -
EILSEQ
;

235 
csum_À
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
disk
->
Êags
,

236 
sb_block_size
 - (
__À32
),

237 
SUPERBLOCK_CSUM_XOR
));

238 i‡(
csum_À
 !
disk
->
csum
) {

239 
	`DMERR
("sb_check failed: csum %u: wanted %u",

240 
	`À32_to_˝u
(
csum_À
),Üe32_to_˝u(
disk
->
csum
));

241  -
EILSEQ
;

244  
	`check_mëad©a_vîsi⁄
(
disk
);

245 
	}
}

247 
dm_block_vÆid©‹
 
	gsb_vÆid©‹
 = {

248 .
«me
 = "superblock",

249 .
	g¥ï¨e_f‹_wrôe
 = 
sb_¥ï¨e_f‹_wrôe
,

250 .
	gcheck
 = 
sb_check


256 
	#DM_ERA_METADATA_BLOCK_SIZE
 4096

	)

257 
	#DM_ERA_METADATA_CACHE_SIZE
 64

	)

258 
	#ERA_MAX_CONCURRENT_LOCKS
 5

	)

260 
	sîa_mëad©a
 {

261 
block_devi˚
 *
	mbdev
;

262 
dm_block_m™agî
 *
	mbm
;

263 
dm_•a˚_m≠
 *
	msm
;

264 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

266 
dm_block_t
 
	mblock_size
;

267 
uöt32_t
 
	mƒ_blocks
;

269 
uöt32_t
 
	mcuºít_îa
;

276 
wrôe£t
 
	mwrôe£ts
[2];

277 
wrôe£t
 *
	mcuºít_wrôe£t
;

279 
dm_block_t
 
	mwrôe£t_åì_roŸ
;

280 
dm_block_t
 
	mîa_¨øy_roŸ
;

282 
dm_disk_bô£t
 
	mbô£t_öfo
;

283 
dm_båì_öfo
 
	mwrôe£t_åì_öfo
;

284 
dm_¨øy_öfo
 
	mîa_¨øy_öfo
;

286 
dm_block_t
 
	mmëad©a_¢≠
;

291 
boﬁ
 
	m¨chived_wrôe£ts
;

297 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

300 
	$su≥rblock_ªad_lock
(
îa_mëad©a
 *
md
,

301 
dm_block
 **
sblock
)

303  
	`dm_bm_ªad_lock
(
md
->
bm
, 
SUPERBLOCK_LOCATION
,

304 &
sb_vÆid©‹
, 
sblock
);

305 
	}
}

307 
	$su≥rblock_lock_zîo
(
îa_mëad©a
 *
md
,

308 
dm_block
 **
sblock
)

310  
	`dm_bm_wrôe_lock_zîo
(
md
->
bm
, 
SUPERBLOCK_LOCATION
,

311 &
sb_vÆid©‹
, 
sblock
);

312 
	}
}

314 
	$su≥rblock_lock
(
îa_mëad©a
 *
md
,

315 
dm_block
 **
sblock
)

317  
	`dm_bm_wrôe_lock
(
md
->
bm
, 
SUPERBLOCK_LOCATION
,

318 &
sb_vÆid©‹
, 
sblock
);

319 
	}
}

322 
	$su≥rblock_Æl_zî€s
(
dm_block_m™agî
 *
bm
, 
boﬁ
 *
ªsu…
)

324 
r
;

325 
i
;

326 
dm_block
 *
b
;

327 
__À64
 *
d©a_À
, 
zîo
 = 
	`˝u_to_À64
(0);

328 
sb_block_size
 = 
	`dm_bm_block_size
(
bm
Ë/ (
__À64
);

333 
r
 = 
	`dm_bm_ªad_lock
(
bm
, 
SUPERBLOCK_LOCATION
, 
NULL
, &
b
);

334 i‡(
r
)

335  
r
;

337 
d©a_À
 = 
	`dm_block_d©a
(
b
);

338 *
ªsu…
 = 
åue
;

339 
i
 = 0; i < 
sb_block_size
; i++) {

340 i‡(
d©a_À
[
i
] !
zîo
) {

341 *
ªsu…
 = 
Ál£
;

346  
	`dm_bm_u∆ock
(
b
);

347 
	}
}

351 
	$ws_∑ck
(c⁄° 
wrôe£t_mëad©a
 *
c‹e
, 
wrôe£t_disk
 *
disk
)

353 
disk
->
ƒ_bôs
 = 
	`˝u_to_À32
(
c‹e
->nr_bits);

354 
disk
->
roŸ
 = 
	`˝u_to_À64
(
c‹e
->root);

355 
	}
}

357 
	$ws_u≈ack
(c⁄° 
wrôe£t_disk
 *
disk
, 
wrôe£t_mëad©a
 *
c‹e
)

359 
c‹e
->
ƒ_bôs
 = 
	`À32_to_˝u
(
disk
->nr_bits);

360 
c‹e
->
roŸ
 = 
	`À64_to_˝u
(
disk
->root);

361 
	}
}

363 
	$ws_öc
(*
c⁄ãxt
, c⁄° *
vÆue
)

365 
îa_mëad©a
 *
md
 = 
c⁄ãxt
;

366 
wrôe£t_disk
 
ws_d
;

367 
dm_block_t
 
b
;

369 
	`mem˝y
(&
ws_d
, 
vÆue
, (ws_d));

370 
b
 = 
	`À64_to_˝u
(
ws_d
.
roŸ
);

372 
	`dm_tm_öc
(
md
->
tm
, 
b
);

373 
	}
}

375 
	$ws_dec
(*
c⁄ãxt
, c⁄° *
vÆue
)

377 
îa_mëad©a
 *
md
 = 
c⁄ãxt
;

378 
wrôe£t_disk
 
ws_d
;

379 
dm_block_t
 
b
;

381 
	`mem˝y
(&
ws_d
, 
vÆue
, (ws_d));

382 
b
 = 
	`À64_to_˝u
(
ws_d
.
roŸ
);

384 
	`dm_bô£t_dñ
(&
md
->
bô£t_öfo
, 
b
);

385 
	}
}

387 
	$ws_eq
(*
c⁄ãxt
, c⁄° *
vÆue1
, c⁄° *
vÆue2
)

389  !
	`memcmp
(
vÆue1
, 
vÆue2
, (
wrôe£t_mëad©a
));

390 
	}
}

394 
	$£tup_wrôe£t_åì_öfo
(
îa_mëad©a
 *
md
)

396 
dm_båì_vÆue_ty≥
 *
vt
 = &
md
->
wrôe£t_åì_öfo
.
vÆue_ty≥
;

397 
md
->
wrôe£t_åì_öfo
.
tm
 = md->tm;

398 
md
->
wrôe£t_åì_öfo
.
Àvñs
 = 1;

399 
vt
->
c⁄ãxt
 = 
md
;

400 
vt
->
size
 = (
wrôe£t_disk
);

401 
vt
->
öc
 = 
ws_öc
;

402 
vt
->
dec
 = 
ws_dec
;

403 
vt
->
equÆ
 = 
ws_eq
;

404 
	}
}

406 
	$£tup_îa_¨øy_öfo
(
îa_mëad©a
 *
md
)

409 
dm_båì_vÆue_ty≥
 
vt
;

410 
vt
.
c⁄ãxt
 = 
NULL
;

411 
vt
.
size
 = (
__À32
);

412 
vt
.
öc
 = 
NULL
;

413 
vt
.
dec
 = 
NULL
;

414 
vt
.
equÆ
 = 
NULL
;

416 
	`dm_¨øy_öfo_öô
(&
md
->
îa_¨øy_öfo
, md->
tm
, &
vt
);

417 
	}
}

419 
	$£tup_öfos
(
îa_mëad©a
 *
md
)

421 
	`dm_disk_bô£t_öô
(
md
->
tm
, &md->
bô£t_öfo
);

422 
	`£tup_wrôe£t_åì_öfo
(
md
);

423 
	`£tup_îa_¨øy_öfo
(
md
);

424 
	}
}

428 
	$¸óã_‰esh_mëad©a
(
îa_mëad©a
 *
md
)

430 
r
;

432 
r
 = 
	`dm_tm_¸óã_wôh_sm
(
md
->
bm
, 
SUPERBLOCK_LOCATION
,

433 &
md
->
tm
, &md->
sm
);

434 i‡(
r
 < 0) {

435 
	`DMERR
("dm_tm_create_with_sm failed");

436  
r
;

439 
	`£tup_öfos
(
md
);

441 
r
 = 
	`dm_båì_em±y
(&
md
->
wrôe£t_åì_öfo
, &md->
wrôe£t_åì_roŸ
);

442 i‡(
r
) {

443 
	`DMERR
("couldn't createÇew writesetÅree");

444 
bad
;

447 
r
 = 
	`dm_¨øy_em±y
(&
md
->
îa_¨øy_öfo
, &md->
îa_¨øy_roŸ
);

448 i‡(
r
) {

449 
	`DMERR
("couldn't createÉraárray");

450 
bad
;

455 
bad
:

456 
	`dm_sm_de°roy
(
md
->
sm
);

457 
	`dm_tm_de°roy
(
md
->
tm
);

459  
r
;

460 
	}
}

462 
	$ßve_sm_roŸ
(
îa_mëad©a
 *
md
)

464 
r
;

465 
size_t
 
mëad©a_Àn
;

467 
r
 = 
	`dm_sm_roŸ_size
(
md
->
sm
, &
mëad©a_Àn
);

468 i‡(
r
 < 0)

469  
r
;

471  
	`dm_sm_c›y_roŸ
(
md
->
sm
, &md->
mëad©a_•a˚_m≠_roŸ
,

472 
mëad©a_Àn
);

473 
	}
}

475 
	$c›y_sm_roŸ
(
îa_mëad©a
 *
md
, 
su≥rblock_disk
 *
disk
)

477 
	`mem˝y
(&
disk
->
mëad©a_•a˚_m≠_roŸ
,

478 &
md
->
mëad©a_•a˚_m≠_roŸ
,

479 (
md
->
mëad©a_•a˚_m≠_roŸ
));

480 
	}
}

487 
	$¥ï¨e_su≥rblock
(
îa_mëad©a
 *
md
, 
su≥rblock_disk
 *
disk
)

489 
disk
->
magic
 = 
	`˝u_to_À64
(
SUPERBLOCK_MAGIC
);

490 
disk
->
Êags
 = 
	`˝u_to_À32
(0ul);

493 
	`mem£t
(
disk
->
uuid
, 0, (disk->uuid));

494 
disk
->
vîsi⁄
 = 
	`˝u_to_À32
(
MAX_ERA_VERSION
);

496 
	`c›y_sm_roŸ
(
md
, 
disk
);

498 
disk
->
d©a_block_size
 = 
	`˝u_to_À32
(
md
->
block_size
);

499 
disk
->
mëad©a_block_size
 = 
	`˝u_to_À32
(
DM_ERA_METADATA_BLOCK_SIZE
 >> 
SECTOR_SHIFT
);

500 
disk
->
ƒ_blocks
 = 
	`˝u_to_À32
(
md
->nr_blocks);

501 
disk
->
cuºít_îa
 = 
	`˝u_to_À32
(
md
->current_era);

503 
	`ws_∑ck
(&
md
->
cuºít_wrôe£t
->md, &
disk
->current_writeset);

504 
disk
->
wrôe£t_åì_roŸ
 = 
	`˝u_to_À64
(
md
->writeset_tree_root);

505 
disk
->
îa_¨øy_roŸ
 = 
	`˝u_to_À64
(
md
->era_array_root);

506 
disk
->
mëad©a_¢≠
 = 
	`˝u_to_À64
(
md
->metadata_snap);

507 
	}
}

509 
	$wrôe_su≥rblock
(
îa_mëad©a
 *
md
)

511 
r
;

512 
dm_block
 *
sblock
;

513 
su≥rblock_disk
 *
disk
;

515 
r
 = 
	`ßve_sm_roŸ
(
md
);

516 i‡(
r
) {

517 
	`DMERR
("%s: save_sm_roŸ faûed", 
__func__
);

518  
r
;

521 
r
 = 
	`su≥rblock_lock_zîo
(
md
, &
sblock
);

522 i‡(
r
)

523  
r
;

525 
disk
 = 
	`dm_block_d©a
(
sblock
);

526 
	`¥ï¨e_su≥rblock
(
md
, 
disk
);

528  
	`dm_tm_commô
(
md
->
tm
, 
sblock
);

529 
	}
}

534 
	$f‹m©_mëad©a
(
îa_mëad©a
 *
md
)

536 
r
;

538 
r
 = 
	`¸óã_‰esh_mëad©a
(
md
);

539 i‡(
r
)

540  
r
;

542 
r
 = 
	`wrôe_su≥rblock
(
md
);

543 i‡(
r
) {

544 
	`dm_sm_de°roy
(
md
->
sm
);

545 
	`dm_tm_de°roy
(
md
->
tm
);

546  
r
;

550 
	}
}

552 
	$›í_mëad©a
(
îa_mëad©a
 *
md
)

554 
r
;

555 
dm_block
 *
sblock
;

556 
su≥rblock_disk
 *
disk
;

558 
r
 = 
	`su≥rblock_ªad_lock
(
md
, &
sblock
);

559 i‡(
r
) {

560 
	`DMERR
("couldn'tÑead_lock superblock");

561  
r
;

564 
disk
 = 
	`dm_block_d©a
(
sblock
);

565 
r
 = 
	`dm_tm_›í_wôh_sm
(
md
->
bm
, 
SUPERBLOCK_LOCATION
,

566 
disk
->
mëad©a_•a˚_m≠_roŸ
,

567 (
disk
->
mëad©a_•a˚_m≠_roŸ
),

568 &
md
->
tm
, &md->
sm
);

569 i‡(
r
) {

570 
	`DMERR
("dm_tm_open_with_sm failed");

571 
bad
;

574 
	`£tup_öfos
(
md
);

576 
md
->
block_size
 = 
	`À32_to_˝u
(
disk
->
d©a_block_size
);

577 
md
->
ƒ_blocks
 = 
	`À32_to_˝u
(
disk
->nr_blocks);

578 
md
->
cuºít_îa
 = 
	`À32_to_˝u
(
disk
->current_era);

580 
md
->
wrôe£t_åì_roŸ
 = 
	`À64_to_˝u
(
disk
->writeset_tree_root);

581 
md
->
îa_¨øy_roŸ
 = 
	`À64_to_˝u
(
disk
->era_array_root);

582 
md
->
mëad©a_¢≠
 = 
	`À64_to_˝u
(
disk
->metadata_snap);

583 
md
->
¨chived_wrôe£ts
 = 
åue
;

585  
	`dm_bm_u∆ock
(
sblock
);

587 
bad
:

588 
	`dm_bm_u∆ock
(
sblock
);

589  
r
;

590 
	}
}

592 
	$›í_‹_f‹m©_mëad©a
(
îa_mëad©a
 *
md
,

593 
boﬁ
 
may_f‹m©
)

595 
r
;

596 
boﬁ
 
unf‹m©ãd
 = 
Ál£
;

598 
r
 = 
	`su≥rblock_Æl_zî€s
(
md
->
bm
, &
unf‹m©ãd
);

599 i‡(
r
)

600  
r
;

602 i‡(
unf‹m©ãd
)

603  
may_f‹m©
 ? 
	`f‹m©_mëad©a
(
md
Ë: -
EPERM
;

605  
	`›í_mëad©a
(
md
);

606 
	}
}

608 
	$¸óã_≥rsi°ít_d©a_obje˘s
(
îa_mëad©a
 *
md
,

609 
boﬁ
 
may_f‹m©
)

611 
r
;

613 
md
->
bm
 = 
	`dm_block_m™agî_¸óã
(md->
bdev
, 
DM_ERA_METADATA_BLOCK_SIZE
,

614 
DM_ERA_METADATA_CACHE_SIZE
,

615 
ERA_MAX_CONCURRENT_LOCKS
);

616 i‡(
	`IS_ERR
(
md
->
bm
)) {

617 
	`DMERR
("couldÇot create block manager");

618  
	`PTR_ERR
(
md
->
bm
);

621 
r
 = 
	`›í_‹_f‹m©_mëad©a
(
md
, 
may_f‹m©
);

622 i‡(
r
)

623 
	`dm_block_m™agî_de°roy
(
md
->
bm
);

625  
r
;

626 
	}
}

628 
	$de°roy_≥rsi°ít_d©a_obje˘s
(
îa_mëad©a
 *
md
)

630 
	`dm_sm_de°roy
(
md
->
sm
);

631 
	`dm_tm_de°roy
(
md
->
tm
);

632 
	`dm_block_m™agî_de°roy
(
md
->
bm
);

633 
	}
}

638 
	$sw≠_wrôe£t
(
îa_mëad©a
 *
md
, 
wrôe£t
 *
√w_wrôe£t
)

640 
	`rcu_assign_poöãr
(
md
->
cuºít_wrôe£t
, 
√w_wrôe£t
);

641 
	`synchr⁄ize_rcu
();

642 
	}
}

651 
	sdige°
 {

652 
uöt32_t
 
	mîa
;

653 
	mƒ_bôs
, 
	mcuºít_bô
;

654 
wrôe£t_mëad©a
 
	mwrôe£t
;

655 
__À32
 
	mvÆue
;

656 
dm_disk_bô£t
 
	möfo
;

658 (*
	m°ï
)(
	mîa_mëad©a
 *, 
	mdige°
 *);

661 
mëad©a_dige°_lookup_wrôe£t
(
îa_mëad©a
 *
md
,

662 
dige°
 *
d
);

664 
	$mëad©a_dige°_ªmove_wrôe£t
(
îa_mëad©a
 *
md
,

665 
dige°
 *
d
)

667 
r
;

668 
uöt64_t
 
key
 = 
d
->
îa
;

670 
r
 = 
	`dm_båì_ªmove
(&
md
->
wrôe£t_åì_öfo
, md->
wrôe£t_åì_roŸ
,

671 &
key
, &
md
->
wrôe£t_åì_roŸ
);

672 i‡(
r
) {

673 
	`DMERR
("%s: dm_båì_ªmovêÁûed", 
__func__
);

674  
r
;

677 
d
->
°ï
 = 
mëad©a_dige°_lookup_wrôe£t
;

679 
	}
}

681 
	#INSERTS_PER_STEP
 100

	)

683 
	$mëad©a_dige°_å™s¸ibe_wrôe£t
(
îa_mëad©a
 *
md
,

684 
dige°
 *
d
)

686 
r
;

687 
boﬁ
 
m¨ked
;

688 
b
, 
e
 = 
	`mö
(
d
->
cuºít_bô
 + 
INSERTS_PER_STEP
, d->
ƒ_bôs
);

690 
b
 = 
d
->
cuºít_bô
; b < 
e
; b++) {

691 
r
 = 
	`wrôe£t_m¨ked_⁄_disk
(&
d
->
öfo
, &d->
wrôe£t
, 
b
, &
m¨ked
);

692 i‡(
r
) {

693 
	`DMERR
("%s: wrôe£t_m¨ked_⁄_disk faûed", 
__func__
);

694  
r
;

697 i‡(!
m¨ked
)

700 
	`__dm_bÀss_f‹_disk
(&
d
->
vÆue
);

701 
r
 = 
	`dm_¨øy_£t_vÆue
(&
md
->
îa_¨øy_öfo
, md->
îa_¨øy_roŸ
,

702 
b
, &
d
->
vÆue
, &
md
->
îa_¨øy_roŸ
);

703 i‡(
r
) {

704 
	`DMERR
("%s: dm_¨øy_£t_vÆuêÁûed", 
__func__
);

705  
r
;

709 i‡(
b
 =
d
->
ƒ_bôs
)

710 
d
->
°ï
 = 
mëad©a_dige°_ªmove_wrôe£t
;

712 
d
->
cuºít_bô
 = 
b
;

715 
	}
}

717 
	$mëad©a_dige°_lookup_wrôe£t
(
îa_mëad©a
 *
md
,

718 
dige°
 *
d
)

720 
r
;

721 
uöt64_t
 
key
;

722 
wrôe£t_disk
 
disk
;

724 
r
 = 
	`dm_båì_föd_lowe°_key
(&
md
->
wrôe£t_åì_öfo
,

725 
md
->
wrôe£t_åì_roŸ
, &
key
);

726 i‡(
r
 < 0)

727  
r
;

729 
d
->
îa
 = 
key
;

731 
r
 = 
	`dm_båì_lookup
(&
md
->
wrôe£t_åì_öfo
,

732 
md
->
wrôe£t_åì_roŸ
, &
key
, &
disk
);

733 i‡(
r
) {

734 i‡(
r
 =-
ENODATA
) {

735 
d
->
°ï
 = 
NULL
;

739 
	`DMERR
("%s: dm_båì_looku∞Áûed", 
__func__
);

740  
r
;

743 
	`ws_u≈ack
(&
disk
, &
d
->
wrôe£t
);

744 
d
->
vÆue
 = 
	`˝u_to_À32
(
key
);

746 
d
->
ƒ_bôs
 = 
	`mö
(d->
wrôe£t
.ƒ_bôs, 
md
->
ƒ_blocks
);

747 
d
->
cuºít_bô
 = 0;

748 
d
->
°ï
 = 
mëad©a_dige°_å™s¸ibe_wrôe£t
;

751 
	}
}

753 
	$mëad©a_dige°_°¨t
(
îa_mëad©a
 *
md
, 
dige°
 *
d
)

755 i‡(
d
->
°ï
)

758 
	`mem£t
(
d
, 0, (*d));

764 
	`dm_disk_bô£t_öô
(
md
->
tm
, &
d
->
öfo
);

765 
d
->
°ï
 = 
mëad©a_dige°_lookup_wrôe£t
;

768 
	}
}

774 
îa_mëad©a
 *
	$mëad©a_›í
(
block_devi˚
 *
bdev
,

775 
£˘‹_t
 
block_size
,

776 
boﬁ
 
may_f‹m©
)

778 
r
;

779 
îa_mëad©a
 *
md
 = 
	`kzÆloc
((*md), 
GFP_KERNEL
);

781 i‡(!
md
)

782  
NULL
;

784 
md
->
bdev
 = bdev;

785 
md
->
block_size
 = block_size;

787 
md
->
wrôe£ts
[0].md.
roŸ
 = 
INVALID_WRITESET_ROOT
;

788 
md
->
wrôe£ts
[1].md.
roŸ
 = 
INVALID_WRITESET_ROOT
;

789 
md
->
cuºít_wrôe£t
 = &md->
wrôe£ts
[0];

791 
r
 = 
	`¸óã_≥rsi°ít_d©a_obje˘s
(
md
, 
may_f‹m©
);

792 i‡(
r
) {

793 
	`k‰ì
(
md
);

794  
	`ERR_PTR
(
r
);

797  
md
;

798 
	}
}

800 
	$mëad©a_˛o£
(
îa_mëad©a
 *
md
)

802 
	`de°roy_≥rsi°ít_d©a_obje˘s
(
md
);

803 
	`k‰ì
(
md
);

804 
	}
}

806 
boﬁ
 
	$vÆid_ƒ_blocks
(
dm_block_t
 
n
)

812  
n
 < (1ull << 31);

813 
	}
}

815 
	$mëad©a_ªsize
(
îa_mëad©a
 *
md
, *
¨g
)

817 
r
;

818 
dm_block_t
 *
√w_size
 = 
¨g
;

819 
__À32
 
vÆue
;

821 i‡(!
	`vÆid_ƒ_blocks
(*
√w_size
)) {

822 
	`DMERR
("InvalidÇumber of origin blocks %llu",

823 (Ë*
√w_size
);

824  -
EINVAL
;

827 
	`wrôe£t_‰ì
(&
md
->
wrôe£ts
[0]);

828 
	`wrôe£t_‰ì
(&
md
->
wrôe£ts
[1]);

830 
r
 = 
	`wrôe£t_Æloc
(&
md
->
wrôe£ts
[0], *
√w_size
);

831 i‡(
r
) {

832 
	`DMERR
("%s: wrôe£t_Ælo¯Áûed f‹ wrôe£à0", 
__func__
);

833  
r
;

836 
r
 = 
	`wrôe£t_Æloc
(&
md
->
wrôe£ts
[1], *
√w_size
);

837 i‡(
r
) {

838 
	`DMERR
("%s: wrôe£t_Ælo¯Áûed f‹ wrôe£à1", 
__func__
);

839  
r
;

842 
vÆue
 = 
	`˝u_to_À32
(0u);

843 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

844 
r
 = 
	`dm_¨øy_ªsize
(&
md
->
îa_¨øy_öfo
, md->
îa_¨øy_roŸ
,

845 
md
->
ƒ_blocks
, *
√w_size
,

846 &
vÆue
, &
md
->
îa_¨øy_roŸ
);

847 i‡(
r
) {

848 
	`DMERR
("%s: dm_¨øy_ªsizêÁûed", 
__func__
);

849  
r
;

852 
md
->
ƒ_blocks
 = *
√w_size
;

854 
	}
}

856 
	$mëad©a_îa_¨chive
(
îa_mëad©a
 *
md
)

858 
r
;

859 
uöt64_t
 
keys
[1];

860 
wrôe£t_disk
 
vÆue
;

862 
r
 = 
	`dm_bô£t_Êush
(&
md
->
bô£t_öfo
, md->
cuºít_wrôe£t
->md.
roŸ
,

863 &
md
->
cuºít_wrôe£t
->md.
roŸ
);

864 i‡(
r
) {

865 
	`DMERR
("%s: dm_bô£t_Êush faûed", 
__func__
);

866  
r
;

869 
	`ws_∑ck
(&
md
->
cuºít_wrôe£t
->md, &
vÆue
);

870 
md
->
cuºít_wrôe£t
->md.
roŸ
 = 
INVALID_WRITESET_ROOT
;

872 
keys
[0] = 
md
->
cuºít_îa
;

873 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

874 
r
 = 
	`dm_båì_ö£π
(&
md
->
wrôe£t_åì_öfo
, md->
wrôe£t_åì_roŸ
,

875 
keys
, &
vÆue
, &
md
->
wrôe£t_åì_roŸ
);

876 i‡(
r
) {

877 
	`DMERR
("%s: couldn'àö£π wrôe£àötÿbåì", 
__func__
);

879  
r
;

882 
md
->
¨chived_wrôe£ts
 = 
åue
;

885 
	}
}

887 
wrôe£t
 *
	$√xt_wrôe£t
(
îa_mëad©a
 *
md
)

889  (
md
->
cuºít_wrôe£t
 =&md->
wrôe£ts
[0]) ?

890 &
md
->
wrôe£ts
[1] : &md->writesets[0];

891 
	}
}

893 
	$mëad©a_√w_îa
(
îa_mëad©a
 *
md
)

895 
r
;

896 
wrôe£t
 *
√w_wrôe£t
 = 
	`√xt_wrôe£t
(
md
);

898 
r
 = 
	`wrôe£t_öô
(&
md
->
bô£t_öfo
, 
√w_wrôe£t
);

899 i‡(
r
) {

900 
	`DMERR
("%s: wrôe£t_öô faûed", 
__func__
);

901  
r
;

904 
	`sw≠_wrôe£t
(
md
, 
√w_wrôe£t
);

905 
md
->
cuºít_îa
++;

908 
	}
}

910 
	$mëad©a_îa_rﬁlovî
(
îa_mëad©a
 *
md
)

912 
r
;

914 i‡(
md
->
cuºít_wrôe£t
->md.
roŸ
 !
INVALID_WRITESET_ROOT
) {

915 
r
 = 
	`mëad©a_îa_¨chive
(
md
);

916 i‡(
r
) {

917 
	`DMERR
("%s: mëad©a_¨chive_î®Áûed", 
__func__
);

919  
r
;

923 
r
 = 
	`mëad©a_√w_îa
(
md
);

924 i‡(
r
) {

925 
	`DMERR
("%s:ÇewÉø faûed", 
__func__
);

927  
r
;

931 
	}
}

933 
boﬁ
 
	$mëad©a_cuºít_m¨ked
(
îa_mëad©a
 *
md
, 
dm_block_t
 
block
)

935 
boﬁ
 
r
;

936 
wrôe£t
 *
ws
;

938 
	`rcu_ªad_lock
();

939 
ws
 = 
	`rcu_dîe„ªn˚
(
md
->
cuºít_wrôe£t
);

940 
r
 = 
	`wrôe£t_m¨ked
(
ws
, 
block
);

941 
	`rcu_ªad_u∆ock
();

943  
r
;

944 
	}
}

946 
	$mëad©a_commô
(
îa_mëad©a
 *
md
)

948 
r
;

949 
dm_block
 *
sblock
;

951 i‡(
md
->
cuºít_wrôe£t
->md.
roŸ
 !
SUPERBLOCK_LOCATION
) {

952 
r
 = 
	`dm_bô£t_Êush
(&
md
->
bô£t_öfo
, md->
cuºít_wrôe£t
->md.
roŸ
,

953 &
md
->
cuºít_wrôe£t
->md.
roŸ
);

954 i‡(
r
) {

955 
	`DMERR
("%s: bô£àÊush faûed", 
__func__
);

956  
r
;

960 
r
 = 
	`ßve_sm_roŸ
(
md
);

961 i‡(
r
) {

962 
	`DMERR
("%s: save_sm_roŸ faûed", 
__func__
);

963  
r
;

966 
r
 = 
	`dm_tm_¥e_commô
(
md
->
tm
);

967 i‡(
r
) {

968 
	`DMERR
("%s:Öª commô faûed", 
__func__
);

969  
r
;

972 
r
 = 
	`su≥rblock_lock
(
md
, &
sblock
);

973 i‡(
r
) {

974 
	`DMERR
("%s: su≥rblockÜock faûed", 
__func__
);

975  
r
;

978 
	`¥ï¨e_su≥rblock
(
md
, 
	`dm_block_d©a
(
sblock
));

980  
	`dm_tm_commô
(
md
->
tm
, 
sblock
);

981 
	}
}

983 
	$mëad©a_checkpoöt
(
îa_mëad©a
 *
md
)

989  
	`mëad©a_îa_rﬁlovî
(
md
);

990 
	}
}

995 
	$mëad©a_èke_¢≠
(
îa_mëad©a
 *
md
)

997 
r
, 
öc
;

998 
dm_block
 *
˛⁄e
;

1000 i‡(
md
->
mëad©a_¢≠
 !
SUPERBLOCK_LOCATION
) {

1001 
	`DMERR
("%s: mëad©®¢≠shŸáÃódyÉxi°s", 
__func__
);

1002  -
EINVAL
;

1005 
r
 = 
	`mëad©a_îa_rﬁlovî
(
md
);

1006 i‡(
r
) {

1007 
	`DMERR
("%s:ÉøÑﬁlovî faûed", 
__func__
);

1008  
r
;

1011 
r
 = 
	`mëad©a_commô
(
md
);

1012 i‡(
r
) {

1013 
	`DMERR
("%s:Öª commô faûed", 
__func__
);

1014  
r
;

1017 
r
 = 
	`dm_sm_öc_block
(
md
->
sm
, 
SUPERBLOCK_LOCATION
);

1018 i‡(
r
) {

1019 
	`DMERR
("%s: couldn'àö¸emíàsu≥rblock", 
__func__
);

1020  
r
;

1023 
r
 = 
	`dm_tm_shadow_block
(
md
->
tm
, 
SUPERBLOCK_LOCATION
,

1024 &
sb_vÆid©‹
, &
˛⁄e
, &
öc
);

1025 i‡(
r
) {

1026 
	`DMERR
("%s: couldn'àshadow su≥rblock", 
__func__
);

1027 
	`dm_sm_dec_block
(
md
->
sm
, 
SUPERBLOCK_LOCATION
);

1028  
r
;

1030 
	`BUG_ON
(!
öc
);

1032 
r
 = 
	`dm_sm_öc_block
(
md
->
sm
, md->
wrôe£t_åì_roŸ
);

1033 i‡(
r
) {

1034 
	`DMERR
("%s: couldn'àö¯wrôe£àåìÑoŸ", 
__func__
);

1035 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1036  
r
;

1039 
r
 = 
	`dm_sm_öc_block
(
md
->
sm
, md->
îa_¨øy_roŸ
);

1040 i‡(
r
) {

1041 
	`DMERR
("%s: couldn'àö¯î®åìÑoŸ", 
__func__
);

1042 
	`dm_sm_dec_block
(
md
->
sm
, md->
wrôe£t_åì_roŸ
);

1043 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1044  
r
;

1047 
md
->
mëad©a_¢≠
 = 
	`dm_block_loˇti⁄
(
˛⁄e
);

1049 
r
 = 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1050 i‡(
r
) {

1051 
	`DMERR
("%s: couldn'àu∆ock cl⁄e", 
__func__
);

1052 
md
->
mëad©a_¢≠
 = 
SUPERBLOCK_LOCATION
;

1053  
r
;

1057 
	}
}

1059 
	$mëad©a_dr›_¢≠
(
îa_mëad©a
 *
md
)

1061 
r
;

1062 
dm_block_t
 
loˇti⁄
;

1063 
dm_block
 *
˛⁄e
;

1064 
su≥rblock_disk
 *
disk
;

1066 i‡(
md
->
mëad©a_¢≠
 =
SUPERBLOCK_LOCATION
) {

1067 
	`DMERR
("%s:Çÿ¢≠Åÿdr›", 
__func__
);

1068  -
EINVAL
;

1071 
r
 = 
	`dm_tm_ªad_lock
(
md
->
tm
, md->
mëad©a_¢≠
, &
sb_vÆid©‹
, &
˛⁄e
);

1072 i‡(
r
) {

1073 
	`DMERR
("%s: couldn'àªadÜock su≥rblock cl⁄e", 
__func__
);

1074  
r
;

1081 
md
->
mëad©a_¢≠
 = 
SUPERBLOCK_LOCATION
;

1083 
disk
 = 
	`dm_block_d©a
(
˛⁄e
);

1084 
r
 = 
	`dm_båì_dñ
(&
md
->
wrôe£t_åì_öfo
,

1085 
	`À64_to_˝u
(
disk
->
wrôe£t_åì_roŸ
));

1086 i‡(
r
) {

1087 
	`DMERR
("%s:Éº‹ dñëög wrôe£àåì cl⁄e", 
__func__
);

1088 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1089  
r
;

1092 
r
 = 
	`dm_¨øy_dñ
(&
md
->
îa_¨øy_öfo
, 
	`À64_to_˝u
(
disk
->
îa_¨øy_roŸ
));

1093 i‡(
r
) {

1094 
	`DMERR
("%s:Éº‹ dñëögÉøáºay cl⁄e", 
__func__
);

1095 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1096  
r
;

1099 
loˇti⁄
 = 
	`dm_block_loˇti⁄
(
˛⁄e
);

1100 
	`dm_tm_u∆ock
(
md
->
tm
, 
˛⁄e
);

1102  
	`dm_sm_dec_block
(
md
->
sm
, 
loˇti⁄
);

1103 
	}
}

1105 
	smëad©a_°©s
 {

1106 
dm_block_t
 
	mu£d
;

1107 
dm_block_t
 
	mtŸÆ
;

1108 
dm_block_t
 
	m¢≠
;

1109 
uöt32_t
 
	mîa
;

1112 
	$mëad©a_gë_°©s
(
îa_mëad©a
 *
md
, *
±r
)

1114 
r
;

1115 
mëad©a_°©s
 *
s
 = 
±r
;

1116 
dm_block_t
 
ƒ_‰ì
, 
ƒ_tŸÆ
;

1118 
r
 = 
	`dm_sm_gë_ƒ_‰ì
(
md
->
sm
, &
ƒ_‰ì
);

1119 i‡(
r
) {

1120 
	`DMERR
("dm_sm_gë_ƒ_‰ìÑëu∫ed %d", 
r
);

1121  
r
;

1124 
r
 = 
	`dm_sm_gë_ƒ_blocks
(
md
->
sm
, &
ƒ_tŸÆ
);

1125 i‡(
r
) {

1126 
	`DMERR
("dm_poﬁ_gë_mëad©a_dev_sizêªtu∫ed %d", 
r
);

1127  
r
;

1130 
s
->
u£d
 = 
ƒ_tŸÆ
 - 
ƒ_‰ì
;

1131 
s
->
tŸÆ
 = 
ƒ_tŸÆ
;

1132 
s
->
¢≠
 = 
md
->
mëad©a_¢≠
;

1133 
s
->
îa
 = 
md
->
cuºít_îa
;

1136 
	}
}

1140 
	sîa
 {

1141 
dm_èrgë
 *
	mti
;

1142 
dm_èrgë_ˇŒbacks
 
	mˇŒbacks
;

1144 
dm_dev
 *
	mmëad©a_dev
;

1145 
dm_dev
 *
	m‹igö_dev
;

1147 
dm_block_t
 
	mƒ_blocks
;

1148 
uöt32_t
 
	m£˘‹s_≥r_block
;

1149 
	m£˘‹s_≥r_block_shi·
;

1150 
îa_mëad©a
 *
	mmd
;

1152 
w‹kqueue_°ru˘
 *
	mwq
;

1153 
w‹k_°ru˘
 
	mw‹kî
;

1155 
•ölock_t
 
	mde„ºed_lock
;

1156 
bio_li°
 
	mde„ºed_bios
;

1158 
•ölock_t
 
	mΩc_lock
;

1159 
li°_hód
 
	mΩc_ˇŒs
;

1161 
dige°
 
	mdige°
;

1162 
©omic_t
 
	msu•íded
;

1165 
	sΩc
 {

1166 
li°_hód
 
	mli°
;

1168 (*
	m‚0
)(
	mîa_mëad©a
 *);

1169 (*
	m‚1
)(
	mîa_mëad©a
 *, *);

1170 *
	m¨g
;

1171 
	mªsu…
;

1173 
com∂ëi⁄
 
	mcom∂ëe
;

1179 
boﬁ
 
	$block_size_is_powî_of_two
(
îa
 *era)

1181  
îa
->
£˘‹s_≥r_block_shi·
 >= 0;

1182 
	}
}

1184 
dm_block_t
 
	$gë_block
(
îa
 *îa, 
bio
 *bio)

1186 
£˘‹_t
 
block_ƒ
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

1188 i‡(!
	`block_size_is_powî_of_two
(
îa
))

1189 (Ë
	`£˘‹_div
(
block_ƒ
, 
îa
->
£˘‹s_≥r_block
);

1191 
block_ƒ
 >>
îa
->
£˘‹s_≥r_block_shi·
;

1193  
block_ƒ
;

1194 
	}
}

1196 
	$ªm≠_to_‹igö
(
îa
 *îa, 
bio
 *bio)

1198 
bio
->
bi_bdev
 = 
îa
->
‹igö_dev
->
bdev
;

1199 
	}
}

1204 
	$wake_w‹kî
(
îa
 *era)

1206 i‡(!
	`©omic_ªad
(&
îa
->
su•íded
))

1207 
	`queue_w‹k
(
îa
->
wq
, &îa->
w‹kî
);

1208 
	}
}

1210 
	$¥o˚ss_ﬁd_îas
(
îa
 *era)

1212 
r
;

1214 i‡(!
îa
->
dige°
.
°ï
)

1217 
r
 = 
îa
->
dige°
.
	`°ï
”ø->
md
, &era->digest);

1218 i‡(
r
 < 0) {

1219 
	`DMERR
("%s: dige° sã∞Áûed, st›pög dige°i⁄", 
__func__
);

1220 
îa
->
dige°
.
°ï
 = 
NULL
;

1222 } i‡(
îa
->
dige°
.
°ï
)

1223 
	`wake_w‹kî
(
îa
);

1224 
	}
}

1226 
	$¥o˚ss_de„ºed_bios
(
îa
 *era)

1228 
r
;

1229 
bio_li°
 
de„ºed_bios
, 
m¨ked_bios
;

1230 
bio
 *bio;

1231 
boﬁ
 
commô_√eded
 = 
Ál£
;

1232 
boﬁ
 
Áûed
 = 
Ál£
;

1234 
	`bio_li°_öô
(&
de„ºed_bios
);

1235 
	`bio_li°_öô
(&
m¨ked_bios
);

1237 
	`•ö_lock
(&
îa
->
de„ºed_lock
);

1238 
	`bio_li°_mîge
(&
de„ºed_bios
, &
îa
->deferred_bios);

1239 
	`bio_li°_öô
(&
îa
->
de„ºed_bios
);

1240 
	`•ö_u∆ock
(&
îa
->
de„ºed_lock
);

1242 (
bio
 = 
	`bio_li°_p›
(&
de„ºed_bios
))) {

1243 
r
 = 
	`wrôe£t_ã°_™d_£t
(&
îa
->
md
->
bô£t_öfo
,

1244 
îa
->
md
->
cuºít_wrôe£t
,

1245 
	`gë_block
(
îa
, 
bio
));

1246 i‡(
r
 < 0) {

1251 
Áûed
 = 
åue
;

1253 } i‡(
r
 == 0)

1254 
commô_√eded
 = 
åue
;

1256 
	`bio_li°_add
(&
m¨ked_bios
, 
bio
);

1259 i‡(
commô_√eded
) {

1260 
r
 = 
	`mëad©a_commô
(
îa
->
md
);

1261 i‡(
r
)

1262 
Áûed
 = 
åue
;

1265 i‡(
Áûed
)

1266 (
bio
 = 
	`bio_li°_p›
(&
m¨ked_bios
)))

1267 
	`bio_io_îr‹
(
bio
);

1269 (
bio
 = 
	`bio_li°_p›
(&
m¨ked_bios
)))

1270 
	`gíîic_make_ªque°
(
bio
);

1271 
	}
}

1273 
	$¥o˚ss_Ωc_ˇŒs
(
îa
 *era)

1275 
r
;

1276 
boﬁ
 
√ed_commô
 = 
Ál£
;

1277 
li°_hód
 
ˇŒs
;

1278 
Ωc
 *Ωc, *
tmp
;

1280 
	`INIT_LIST_HEAD
(&
ˇŒs
);

1281 
	`•ö_lock
(&
îa
->
Ωc_lock
);

1282 
	`li°_•li˚_öô
(&
îa
->
Ωc_ˇŒs
, &
ˇŒs
);

1283 
	`•ö_u∆ock
(&
îa
->
Ωc_lock
);

1285 
	`li°_f‹_óch_íåy_ß„
(
Ωc
, 
tmp
, &
ˇŒs
, 
li°
) {

1286 
Ωc
->
ªsu…
 =Ñpc->
‚0
 ?Ñpc->
	`‚0
(
îa
->
md
Ë:Ñpc->
	`‚1
”ø->md,Ñpc->
¨g
);

1287 
√ed_commô
 = 
åue
;

1290 i‡(
√ed_commô
) {

1291 
r
 = 
	`mëad©a_commô
(
îa
->
md
);

1292 i‡(
r
)

1293 
	`li°_f‹_óch_íåy_ß„
(
Ωc
, 
tmp
, &
ˇŒs
, 
li°
)

1294 
Ωc
->
ªsu…
 = 
r
;

1297 
	`li°_f‹_óch_íåy_ß„
(
Ωc
, 
tmp
, &
ˇŒs
, 
li°
)

1298 
	`com∂ëe
(&
Ωc
->
com∂ëe
);

1299 
	}
}

1301 
	$kick_off_dige°
(
îa
 *era)

1303 i‡(
îa
->
md
->
¨chived_wrôe£ts
) {

1304 
îa
->
md
->
¨chived_wrôe£ts
 = 
Ál£
;

1305 
	`mëad©a_dige°_°¨t
(
îa
->
md
, &îa->
dige°
);

1307 
	}
}

1309 
	$do_w‹k
(
w‹k_°ru˘
 *
ws
)

1311 
îa
 *î®
	`c⁄èöî_of
(
ws
, îa, 
w‹kî
);

1313 
	`kick_off_dige°
(
îa
);

1314 
	`¥o˚ss_ﬁd_îas
(
îa
);

1315 
	`¥o˚ss_de„ºed_bios
(
îa
);

1316 
	`¥o˚ss_Ωc_ˇŒs
(
îa
);

1317 
	}
}

1319 
	$de„r_bio
(
îa
 *îa, 
bio
 *bio)

1321 
	`•ö_lock
(&
îa
->
de„ºed_lock
);

1322 
	`bio_li°_add
(&
îa
->
de„ºed_bios
, 
bio
);

1323 
	`•ö_u∆ock
(&
îa
->
de„ºed_lock
);

1325 
	`wake_w‹kî
(
îa
);

1326 
	}
}

1331 
	$≥rf‹m_Ωc
(
îa
 *îa, 
Ωc
 *rpc)

1333 
Ωc
->
ªsu…
 = 0;

1334 
	`öô_com∂ëi⁄
(&
Ωc
->
com∂ëe
);

1336 
	`•ö_lock
(&
îa
->
Ωc_lock
);

1337 
	`li°_add
(&
Ωc
->
li°
, &
îa
->
Ωc_ˇŒs
);

1338 
	`•ö_u∆ock
(&
îa
->
Ωc_lock
);

1340 
	`wake_w‹kî
(
îa
);

1341 
	`waô_f‹_com∂ëi⁄
(&
Ωc
->
com∂ëe
);

1343  
Ωc
->
ªsu…
;

1344 
	}
}

1346 
ö_w‹kî0
(
îa
 *îa, (*
‚
)(
îa_mëad©a
 *))

1348 
Ωc
Ñpc;

1349 
Ωc
.
‚0
 = 
‚
;

1350 
Ωc
.
‚1
 = 
NULL
;

1352  
	`≥rf‹m_Ωc
(
îa
, &
Ωc
);

1353 
	}
}

1355 
ö_w‹kî1
(
îa
 *era,

1356 (*
‚
)(
îa_mëad©a
 *, *), *
¨g
)

1358 
Ωc
Ñpc;

1359 
Ωc
.
‚0
 = 
NULL
;

1360 
Ωc
.
‚1
 = 
‚
;

1361 
Ωc
.
¨g
 =árg;

1363  
	`≥rf‹m_Ωc
(
îa
, &
Ωc
);

1364 
	}
}

1366 
	$°¨t_w‹kî
(
îa
 *era)

1368 
	`©omic_£t
(&
îa
->
su•íded
, 0);

1369 
	}
}

1371 
	$°›_w‹kî
(
îa
 *era)

1373 
	`©omic_£t
(&
îa
->
su•íded
, 1);

1374 
	`Êush_w‹kqueue
(
îa
->
wq
);

1375 
	}
}

1380 
	$dev_is_c⁄ge°ed
(
dm_dev
 *
dev
, 
bdi_bôs
)

1382 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1383  
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bdi_bôs
);

1384 
	}
}

1386 
	$îa_is_c⁄ge°ed
(
dm_èrgë_ˇŒbacks
 *
cb
, 
bdi_bôs
)

1388 
îa
 *î®
	`c⁄èöî_of
(
cb
, îa, 
ˇŒbacks
);

1389  
	`dev_is_c⁄ge°ed
(
îa
->
‹igö_dev
, 
bdi_bôs
);

1390 
	}
}

1392 
	$îa_de°roy
(
îa
 *era)

1394 i‡(
îa
->
md
)

1395 
	`mëad©a_˛o£
(
îa
->
md
);

1397 i‡(
îa
->
wq
)

1398 
	`de°roy_w‹kqueue
(
îa
->
wq
);

1400 i‡(
îa
->
‹igö_dev
)

1401 
	`dm_put_devi˚
(
îa
->
ti
,Éø->
‹igö_dev
);

1403 i‡(
îa
->
mëad©a_dev
)

1404 
	`dm_put_devi˚
(
îa
->
ti
,Éø->
mëad©a_dev
);

1406 
	`k‰ì
(
îa
);

1407 
	}
}

1409 
dm_block_t
 
	$ˇlc_ƒ_blocks
(
îa
 *era)

1411  
	`dm_£˘‹_div_up
(
îa
->
ti
->
Àn
,Éø->
£˘‹s_≥r_block
);

1412 
	}
}

1414 
boﬁ
 
	$vÆid_block_size
(
dm_block_t
 
block_size
)

1416 
boﬁ
 
gª©î_th™_zîo
 = 
block_size
 > 0;

1417 
boﬁ
 
mu…ùÀ_of_mö_block_size
 = (
block_size
 & (
MIN_BLOCK_SIZE
 - 1)) == 0;

1419  
gª©î_th™_zîo
 && 
mu…ùÀ_of_mö_block_size
;

1420 
	}
}

1425 
	$îa_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1427 
r
;

1428 
dummy
;

1429 
îa
 *era;

1430 
îa_mëad©a
 *
md
;

1432 i‡(
¨gc
 != 3) {

1433 
ti
->
îr‹
 = "Invalidárgument count";

1434  -
EINVAL
;

1437 
îa
 = 
	`kzÆloc
((*îa), 
GFP_KERNEL
);

1438 i‡(!
îa
) {

1439 
ti
->
îr‹
 = "ErrorállocatingÉra structure";

1440  -
ENOMEM
;

1443 
îa
->
ti
 =Åi;

1445 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
FMODE_READ
 | 
FMODE_WRITE
, &
îa
->
mëad©a_dev
);

1446 i‡(
r
) {

1447 
ti
->
îr‹
 = "Error opening metadata device";

1448 
	`îa_de°roy
(
îa
);

1449  -
EINVAL
;

1452 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[1], 
FMODE_READ
 | 
FMODE_WRITE
, &
îa
->
‹igö_dev
);

1453 i‡(
r
) {

1454 
ti
->
îr‹
 = "Error opening data device";

1455 
	`îa_de°roy
(
îa
);

1456  -
EINVAL
;

1459 
r
 = 
	`ssˇnf
(
¨gv
[2], "%u%c", &
îa
->
£˘‹s_≥r_block
, &
dummy
);

1460 i‡(
r
 != 1) {

1461 
ti
->
îr‹
 = "ErrorÖarsing block size";

1462 
	`îa_de°roy
(
îa
);

1463  -
EINVAL
;

1466 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
îa
->
£˘‹s_≥r_block
);

1467 i‡(
r
) {

1468 
ti
->
îr‹
 = "couldÇot set max ioÜen";

1469 
	`îa_de°roy
(
îa
);

1470  -
EINVAL
;

1473 i‡(!
	`vÆid_block_size
(
îa
->
£˘‹s_≥r_block
)) {

1474 
ti
->
îr‹
 = "Invalid block size";

1475 
	`îa_de°roy
(
îa
);

1476  -
EINVAL
;

1478 i‡(
îa
->
£˘‹s_≥r_block
 & (era->sectors_per_block - 1))

1479 
îa
->
£˘‹s_≥r_block_shi·
 = -1;

1481 
îa
->
£˘‹s_≥r_block_shi·
 = 
	`__ffs
”ø->
£˘‹s_≥r_block
);

1483 
md
 = 
	`mëad©a_›í
(
îa
->
mëad©a_dev
->
bdev
,Éø->
£˘‹s_≥r_block
, 
åue
);

1484 i‡(
	`IS_ERR
(
md
)) {

1485 
ti
->
îr‹
 = "ErrorÑeading metadata";

1486 
	`îa_de°roy
(
îa
);

1487  
	`PTR_ERR
(
md
);

1489 
îa
->
md
 = md;

1491 
îa
->
ƒ_blocks
 = 
	`ˇlc_ƒ_blocks
(era);

1493 
r
 = 
	`mëad©a_ªsize
(
îa
->
md
, &îa->
ƒ_blocks
);

1494 i‡(
r
) {

1495 
ti
->
îr‹
 = "couldn'tÑesize metadata";

1496 
	`îa_de°roy
(
îa
);

1497  -
ENOMEM
;

1500 
îa
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("dm-" 
DM_MSG_PREFIX
, 
WQ_MEM_RECLAIM
);

1501 i‡(!
îa
->
wq
) {

1502 
ti
->
îr‹
 = "couldÇot create workqueue for metadata object";

1503 
	`îa_de°roy
(
îa
);

1504  -
ENOMEM
;

1506 
	`INIT_WORK
(&
îa
->
w‹kî
, 
do_w‹k
);

1508 
	`•ö_lock_öô
(&
îa
->
de„ºed_lock
);

1509 
	`bio_li°_öô
(&
îa
->
de„ºed_bios
);

1511 
	`•ö_lock_öô
(&
îa
->
Ωc_lock
);

1512 
	`INIT_LIST_HEAD
(&
îa
->
Ωc_ˇŒs
);

1514 
ti
->
¥iv©e
 = 
îa
;

1515 
ti
->
num_Êush_bios
 = 1;

1516 
ti
->
Êush_suµ‹ãd
 = 
åue
;

1518 
ti
->
num_disˇrd_bios
 = 1;

1519 
ti
->
disˇrds_suµ‹ãd
 = 
åue
;

1520 
îa
->
ˇŒbacks
.
c⁄ge°ed_‚
 = 
îa_is_c⁄ge°ed
;

1521 
	`dm_èbÀ_add_èrgë_ˇŒbacks
(
ti
->
èbÀ
, &
îa
->
ˇŒbacks
);

1524 
	}
}

1526 
	$îa_då
(
dm_èrgë
 *
ti
)

1528 
	`îa_de°roy
(
ti
->
¥iv©e
);

1529 
	}
}

1531 
	$îa_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1533 
îa
 *î®
ti
->
¥iv©e
;

1534 
dm_block_t
 
block
 = 
	`gë_block
(
îa
, 
bio
);

1541 
	`ªm≠_to_‹igö
(
îa
, 
bio
);

1546 i‡(!(
bio
->
bi_rw
 & 
REQ_FLUSH
) &&

1547 (
	`bio_d©a_dú
(
bio
Ë=
WRITE
) &&

1548 !
	`mëad©a_cuºít_m¨ked
(
îa
->
md
, 
block
)) {

1549 
	`de„r_bio
(
îa
, 
bio
);

1550  
DM_MAPIO_SUBMITTED
;

1553  
DM_MAPIO_REMAPPED
;

1554 
	}
}

1556 
	$îa_po°su•íd
(
dm_èrgë
 *
ti
)

1558 
r
;

1559 
îa
 *î®
ti
->
¥iv©e
;

1561 
r
 = 
	`ö_w‹kî0
(
îa
, 
mëad©a_îa_¨chive
);

1562 i‡(
r
) {

1563 
	`DMERR
("%s: couldn'à¨chivêcuºíàîa", 
__func__
);

1567 
	`°›_w‹kî
(
îa
);

1568 
	}
}

1570 
	$îa_¥îesume
(
dm_èrgë
 *
ti
)

1572 
r
;

1573 
îa
 *î®
ti
->
¥iv©e
;

1574 
dm_block_t
 
√w_size
 = 
	`ˇlc_ƒ_blocks
(
îa
);

1576 i‡(
îa
->
ƒ_blocks
 !
√w_size
) {

1577 
r
 = 
	`ö_w‹kî1
(
îa
, 
mëad©a_ªsize
, &
√w_size
);

1578 i‡(
r
)

1579  
r
;

1581 
îa
->
ƒ_blocks
 = 
√w_size
;

1584 
	`°¨t_w‹kî
(
îa
);

1586 
r
 = 
	`ö_w‹kî0
(
îa
, 
mëad©a_√w_îa
);

1587 i‡(
r
) {

1588 
	`DMERR
("%s: mëad©a_îa_rﬁlovî faûed", 
__func__
);

1589  
r
;

1593 
	}
}

1601 
	$îa_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1602 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1604 
r
;

1605 
îa
 *î®
ti
->
¥iv©e
;

1606 
ssize_t
 
sz
 = 0;

1607 
mëad©a_°©s
 
°©s
;

1608 
buf
[
BDEVNAME_SIZE
];

1610 
ty≥
) {

1611 
STATUSTYPE_INFO
:

1612 
r
 = 
	`ö_w‹kî1
(
îa
, 
mëad©a_gë_°©s
, &
°©s
);

1613 i‡(
r
)

1614 
îr
;

1616 
	`DMEMIT
("%u %llu/%llu %u",

1617 (Ë(
DM_ERA_METADATA_BLOCK_SIZE
 >> 
SECTOR_SHIFT
),

1618 (Ë
°©s
.
u£d
,

1619 (Ë
°©s
.
tŸÆ
,

1620 (Ë
°©s
.
îa
);

1622 i‡(
°©s
.
¢≠
 !
SUPERBLOCK_LOCATION
)

1623 
	`DMEMIT
(" %Œu", 
°©s
.
¢≠
);

1625 
	`DMEMIT
(" -");

1628 
STATUSTYPE_TABLE
:

1629 
	`f‹m©_dev_t
(
buf
, 
îa
->
mëad©a_dev
->
bdev
->
bd_dev
);

1630 
	`DMEMIT
("%†", 
buf
);

1631 
	`f‹m©_dev_t
(
buf
, 
îa
->
‹igö_dev
->
bdev
->
bd_dev
);

1632 
	`DMEMIT
("%†%u", 
buf
, 
îa
->
£˘‹s_≥r_block
);

1638 
îr
:

1639 
	`DMEMIT
("Error");

1640 
	}
}

1642 
	$îa_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1644 
îa
 *î®
ti
->
¥iv©e
;

1646 i‡(
¨gc
 != 1) {

1647 
	`DMERR
("incorrectÇumber of messageárguments");

1648  -
EINVAL
;

1651 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "checkpoint"))

1652  
	`ö_w‹kî0
(
îa
, 
mëad©a_checkpoöt
);

1654 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "take_metadata_snap"))

1655  
	`ö_w‹kî0
(
îa
, 
mëad©a_èke_¢≠
);

1657 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "drop_metadata_snap"))

1658  
	`ö_w‹kî0
(
îa
, 
mëad©a_dr›_¢≠
);

1660 
	`DMERR
("unsuµ‹ãd mesßgê'%s'", 
¨gv
[0]);

1661  -
EINVAL
;

1662 
	}
}

1664 
£˘‹_t
 
	$gë_dev_size
(
dm_dev
 *
dev
)

1666  
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

1667 
	}
}

1669 
	$îa_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1670 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1672 
îa
 *î®
ti
->
¥iv©e
;

1673  
	`‚
(
ti
, 
îa
->
‹igö_dev
, 0, 
	`gë_dev_size
”ø->‹igö_dev), 
d©a
);

1674 
	}
}

1676 
	$îa_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

1677 
bio_vec
 *
biovec
, 
max_size
)

1679 
îa
 *î®
ti
->
¥iv©e
;

1680 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
îa
->
‹igö_dev
->
bdev
);

1682 i‡(!
q
->
mîge_bvec_‚
)

1683  
max_size
;

1685 
bvm
->
bi_bdev
 = 
îa
->
‹igö_dev
->
bdev
;

1687  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

1688 
	}
}

1690 
	$îa_io_höts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

1692 
îa
 *î®
ti
->
¥iv©e
;

1693 
uöt64_t
 
io_›t_£˘‹s
 = 
limôs
->
io_›t
 >> 
SECTOR_SHIFT
;

1699 i‡(
io_›t_£˘‹s
 < 
îa
->
£˘‹s_≥r_block
 ||

1700 
	`do_div
(
io_›t_£˘‹s
, 
îa
->
£˘‹s_≥r_block
)) {

1701 
	`blk_limôs_io_mö
(
limôs
, 0);

1702 
	`blk_limôs_io_›t
(
limôs
, 
îa
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

1704 
	}
}

1708 
èrgë_ty≥
 
	gîa_èrgë
 = {

1709 .
«me
 = "era",

1710 .
	gvîsi⁄
 = {1, 0, 0},

1711 .
	gmoduÀ
 = 
THIS_MODULE
,

1712 .
	g˘r
 = 
îa_˘r
,

1713 .
	gdå
 = 
îa_då
,

1714 .
	gm≠
 = 
îa_m≠
,

1715 .
	gpo°su•íd
 = 
îa_po°su•íd
,

1716 .
	g¥îesume
 = 
îa_¥îesume
,

1717 .
	g°©us
 = 
îa_°©us
,

1718 .
	gmesßge
 = 
îa_mesßge
,

1719 .
	gôî©e_devi˚s
 = 
îa_ôî©e_devi˚s
,

1720 .
	gmîge
 = 
îa_mîge
,

1721 .
	gio_höts
 = 
îa_io_höts


1724 
__öô
 
	$dm_îa_öô
()

1726 
r
;

1728 
r
 = 
	`dm_ªgi°î_èrgë
(&
îa_èrgë
);

1729 i‡(
r
) {

1730 
	`DMERR
("î®èrgëÑegi°øti⁄ faûed: %d", 
r
);

1731  
r
;

1735 
	}
}

1737 
__exô
 
	$dm_îa_exô
()

1739 
	`dm_uƒegi°î_èrgë
(&
îa_èrgë
);

1740 
	}
}

1742 
moduÀ_öô
(
dm_îa_öô
);

1743 
moduÀ_exô
(
dm_îa_exô
);

1745 
MODULE_DESCRIPTION
(
DM_NAME
 "ÉraÅarget");

1746 
MODULE_AUTHOR
("Joe Thornber <ejt@redhat.com>");

1747 
MODULE_LICENSE
("GPL");

	@dm-exception-store.c

8 
	~"dm-ex˚±i⁄-°‹e.h
"

10 
	~<löux/˘y≥.h
>

11 
	~<löux/mm.h
>

12 
	~<löux/∑gem≠.h
>

13 
	~<löux/vmÆloc.h
>

14 
	~<löux/moduÀ.h
>

15 
	~<löux/¶ab.h
>

17 
	#DM_MSG_PREFIX
 "¢≠shŸÉx˚±i⁄ st‹es"

	)

19 
LIST_HEAD
(
_ex˚±i⁄_°‹e_ty≥s
);

20 
DEFINE_SPINLOCK
(
_lock
);

22 
dm_ex˚±i⁄_°‹e_ty≥
 *
	$__föd_ex˚±i⁄_°‹e_ty≥
(c⁄° *
«me
)

24 
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
;

26 
	`li°_f‹_óch_íåy
(
ty≥
, &
_ex˚±i⁄_°‹e_ty≥s
, 
li°
)

27 i‡(!
	`°rcmp
(
«me
, 
ty≥
->name))

28  
ty≥
;

30  
NULL
;

31 
	}
}

33 
dm_ex˚±i⁄_°‹e_ty≥
 *
	$_gë_ex˚±i⁄_°‹e_ty≥
(c⁄° *
«me
)

35 
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
;

37 
	`•ö_lock
(&
_lock
);

39 
ty≥
 = 
	`__föd_ex˚±i⁄_°‹e_ty≥
(
«me
);

41 i‡(
ty≥
 && !
	`åy_moduÀ_gë
—y≥->
moduÀ
))

42 
ty≥
 = 
NULL
;

44 
	`•ö_u∆ock
(&
_lock
);

46  
ty≥
;

47 
	}
}

72 
dm_ex˚±i⁄_°‹e_ty≥
 *
	$gë_ty≥
(c⁄° *
ty≥_«me
)

74 *
p
, *
ty≥_«me_dup
;

75 
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
;

77 
ty≥
 = 
	`_gë_ex˚±i⁄_°‹e_ty≥
(
ty≥_«me
);

78 i‡(
ty≥
)

79  
ty≥
;

81 
ty≥_«me_dup
 = 
	`k°rdup
(
ty≥_«me
, 
GFP_KERNEL
);

82 i‡(!
ty≥_«me_dup
) {

83 
	`DMERR
("Nÿmem‹yÜe·Åÿ©ãm±Üﬂd f‹ \"%s\"", 
ty≥_«me
);

84  
NULL
;

87 
	`ªque°_moduÀ
("dm-ex°‹e-%s", 
ty≥_«me_dup
) ||

88 !(
ty≥
 = 
	`_gë_ex˚±i⁄_°‹e_ty≥
(
ty≥_«me
))) {

89 
p
 = 
	`°ºchr
(
ty≥_«me_dup
, '-');

90 i‡(!
p
)

92 
p
[0] = '\0';

95 i‡(!
ty≥
)

96 
	`DMWARN
("ModuÀ f‹Éx°‹êty≥ \"%s\"ÇŸ found.", 
ty≥_«me
);

98 
	`k‰ì
(
ty≥_«me_dup
);

100  
ty≥
;

101 
	}
}

103 
	$put_ty≥
(
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
)

105 
	`•ö_lock
(&
_lock
);

106 
	`moduÀ_put
(
ty≥
->
moduÀ
);

107 
	`•ö_u∆ock
(&
_lock
);

108 
	}
}

110 
	$dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
)

112 
r
 = 0;

114 
	`•ö_lock
(&
_lock
);

115 i‡(!
	`__föd_ex˚±i⁄_°‹e_ty≥
(
ty≥
->
«me
))

116 
	`li°_add
(&
ty≥
->
li°
, &
_ex˚±i⁄_°‹e_ty≥s
);

118 
r
 = -
EEXIST
;

119 
	`•ö_u∆ock
(&
_lock
);

121  
r
;

122 
	}
}

123 
EXPORT_SYMBOL
(
dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
);

125 
	$dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
)

127 
	`•ö_lock
(&
_lock
);

129 i‡(!
	`__föd_ex˚±i⁄_°‹e_ty≥
(
ty≥
->
«me
)) {

130 
	`•ö_u∆ock
(&
_lock
);

131  -
EINVAL
;

134 
	`li°_dñ
(&
ty≥
->
li°
);

136 
	`•ö_u∆ock
(&
_lock
);

139 
	}
}

140 
EXPORT_SYMBOL
(
dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
);

142 
	$£t_chunk_size
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

143 c⁄° *
chunk_size_¨g
, **
îr‹
)

145 
chunk_size
;

147 i‡(
	`k°πouöt
(
chunk_size_¨g
, 10, &
chunk_size
)) {

148 *
îr‹
 = "Invalid chunk size";

149  -
EINVAL
;

152 i‡(!
chunk_size
) {

153 
°‹e
->
chunk_size
 = st‹e->
chunk_mask
 = st‹e->
chunk_shi·
 = 0;

157  
	`dm_ex˚±i⁄_°‹e_£t_chunk_size
(
°‹e
, 
chunk_size
, 
îr‹
);

158 
	}
}

160 
	$dm_ex˚±i⁄_°‹e_£t_chunk_size
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

161 
chunk_size
,

162 **
îr‹
)

165 i‡(!
	`is_powî_of_2
(
chunk_size
)) {

166 *
îr‹
 = "Chunk size isÇotáÖower of 2";

167  -
EINVAL
;

171 i‡(
chunk_size
 %

172 (
	`bdev_logiˇl_block_size
(
	`dm_¢≠_cow
(
°‹e
->
¢≠
)->
bdev
) >> 9) ||

173 
chunk_size
 %

174 (
	`bdev_logiˇl_block_size
(
	`dm_¢≠_‹igö
(
°‹e
->
¢≠
)->
bdev
) >> 9)) {

175 *
îr‹
 = "Chunk size isÇotá multiple of device blocksize";

176  -
EINVAL
;

179 i‡(
chunk_size
 > 
INT_MAX
 >> 
SECTOR_SHIFT
) {

180 *
îr‹
 = "Chunk size isÅoo high";

181  -
EINVAL
;

184 
°‹e
->
chunk_size
 = chunk_size;

185 
°‹e
->
chunk_mask
 = 
chunk_size
 - 1;

186 
°‹e
->
chunk_shi·
 = 
	`ffs
(
chunk_size
) - 1;

189 
	}
}

191 
	$dm_ex˚±i⁄_°‹e_¸óã
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
,

192 
dm_¢≠shŸ
 *
¢≠
,

193 *
¨gs_u£d
,

194 
dm_ex˚±i⁄_°‹e
 **
°‹e
)

196 
r
 = 0;

197 
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
 = 
NULL
;

198 
dm_ex˚±i⁄_°‹e
 *
tmp_°‹e
;

199 
≥rsi°ít
;

201 i‡(
¨gc
 < 2) {

202 
ti
->
îr‹
 = "InsufficientÉxception storeárguments";

203  -
EINVAL
;

206 
tmp_°‹e
 = 
	`kmÆloc
((*tmp_°‹e), 
GFP_KERNEL
);

207 i‡(!
tmp_°‹e
) {

208 
ti
->
îr‹
 = "Exception storeállocation failed";

209  -
ENOMEM
;

212 
≥rsi°ít
 = 
	`touµî
(*
¨gv
[0]);

213 i‡(
≥rsi°ít
 == 'P')

214 
ty≥
 = 
	`gë_ty≥
("P");

215 i‡(
≥rsi°ít
 == 'N')

216 
ty≥
 = 
	`gë_ty≥
("N");

218 
ti
->
îr‹
 = "Persistent flag isÇot P or N";

219 
r
 = -
EINVAL
;

220 
bad_ty≥
;

223 i‡(!
ty≥
) {

224 
ti
->
îr‹
 = "Exception storeÅypeÇotÑecognised";

225 
r
 = -
EINVAL
;

226 
bad_ty≥
;

229 
tmp_°‹e
->
ty≥
 =Åype;

230 
tmp_°‹e
->
¢≠
 = snap;

232 
r
 = 
	`£t_chunk_size
(
tmp_°‹e
, 
¨gv
[1], &
ti
->
îr‹
);

233 i‡(
r
)

234 
bad
;

236 
r
 = 
ty≥
->
	`˘r
(
tmp_°‹e
, 0, 
NULL
);

237 i‡(
r
) {

238 
ti
->
îr‹
 = "Exception storeÅype constructor failed";

239 
bad
;

242 *
¨gs_u£d
 = 2;

243 *
°‹e
 = 
tmp_°‹e
;

246 
bad
:

247 
	`put_ty≥
(
ty≥
);

248 
bad_ty≥
:

249 
	`k‰ì
(
tmp_°‹e
);

250  
r
;

251 
	}
}

252 
EXPORT_SYMBOL
(
dm_ex˚±i⁄_°‹e_¸óã
);

254 
	$dm_ex˚±i⁄_°‹e_de°roy
(
dm_ex˚±i⁄_°‹e
 *
°‹e
)

256 
°‹e
->
ty≥
->
	`då
(store);

257 
	`put_ty≥
(
°‹e
->
ty≥
);

258 
	`k‰ì
(
°‹e
);

259 
	}
}

260 
EXPORT_SYMBOL
(
dm_ex˚±i⁄_°‹e_de°roy
);

262 
	$dm_ex˚±i⁄_°‹e_öô
()

264 
r
;

266 
r
 = 
	`dm_å™sõ¡_¢≠shŸ_öô
();

267 i‡(
r
) {

268 
	`DMERR
("UnableÅoÑegisterÅransientÉxception storeÅype.");

269 
å™sõ¡_Áû
;

272 
r
 = 
	`dm_≥rsi°ít_¢≠shŸ_öô
();

273 i‡(
r
) {

274 
	`DMERR
("UnableÅoÑegisterÖersistentÉxception storeÅype");

275 
≥rsi°ít_Áû
;

280 
≥rsi°ít_Áû
:

281 
	`dm_å™sõ¡_¢≠shŸ_exô
();

282 
å™sõ¡_Áû
:

283  
r
;

284 
	}
}

286 
	$dm_ex˚±i⁄_°‹e_exô
()

288 
	`dm_≥rsi°ít_¢≠shŸ_exô
();

289 
	`dm_å™sõ¡_¢≠shŸ_exô
();

290 
	}
}

	@dm-exception-store.h

10 #i‚de‡
_LINUX_DM_EXCEPTION_STORE


11 
	#_LINUX_DM_EXCEPTION_STORE


	)

13 
	~<löux/blkdev.h
>

14 
	~<löux/devi˚-m≠≥r.h
>

20 
£˘‹_t
 
	tchunk_t
;

29 
	sdm_ex˚±i⁄
 {

30 
li°_hód
 
	mhash_li°
;

32 
chunk_t
 
	mﬁd_chunk
;

33 
chunk_t
 
	m√w_chunk
;

40 
	gdm_ex˚±i⁄_°‹e
;

41 
	sdm_ex˚±i⁄_°‹e_ty≥
 {

42 c⁄° *
	m«me
;

43 
moduÀ
 *
	mmoduÀ
;

45 (*
	m˘r
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

46 
	m¨gc
, **
	m¨gv
);

51 (*
	mdå
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
);

58 (*
	mªad_mëad©a
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

59 (*
	mˇŒback
)(*
	mˇŒback_c⁄ãxt
,

60 
chunk_t
 
	mﬁd
, chunk_à
	m√w
),

61 *
	mˇŒback_c⁄ãxt
);

66 (*
	m¥ï¨e_ex˚±i⁄
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

67 
dm_ex˚±i⁄
 *
	me
);

72 (*
	mcommô_ex˚±i⁄
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

73 
dm_ex˚±i⁄
 *
	me
,

74 (*
	mˇŒback
Ë(*, 
	msuc˚ss
),

75 *
	mˇŒback_c⁄ãxt
);

85 (*
	m¥ï¨e_mîge
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

86 
chunk_t
 *
	mœ°_ﬁd_chunk
, chunk_à*
	mœ°_√w_chunk
);

92 (*
	mcommô_mîge
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
, 
	mƒ_mîged
);

97 (*
	mdr›_¢≠shŸ
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
);

99 (*
	m°©us
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

100 
°©us_ty≥_t
 
	m°©us
, *
	mªsu…
,

101 
	mmaxÀn
);

106 (*
	mußge
Ë(
dm_ex˚±i⁄_°‹e
 *
	m°‹e
,

107 
£˘‹_t
 *
	mtŸÆ_£˘‹s
, se˘‹_à*
	m£˘‹s_Æloˇãd
,

108 
£˘‹_t
 *
	mmëad©a_£˘‹s
);

111 
li°_hód
 
	mli°
;

114 
	gdm_¢≠shŸ
;

116 
	sdm_ex˚±i⁄_°‹e
 {

117 
dm_ex˚±i⁄_°‹e_ty≥
 *
	mty≥
;

118 
dm_¢≠shŸ
 *
	m¢≠
;

121 
	mchunk_size
;

122 
	mchunk_mask
;

123 
	mchunk_shi·
;

125 *
	mc⁄ãxt
;

131 
dm_dev
 *
dm_¢≠_‹igö
(
dm_¢≠shŸ
 *
¢≠
);

132 
dm_dev
 *
dm_¢≠_cow
(
dm_¢≠shŸ
 *
¢≠
);

137 #i‡
deföed
(
CONFIG_LBDAF
Ë|| (
BITS_PER_LONG
 == 64)

138 
	#DM_CHUNK_CONSECUTIVE_BITS
 8

	)

139 
	#DM_CHUNK_NUMBER_BITS
 56

	)

141 
ölöe
 
chunk_t
 
	$dm_chunk_numbî
(
chunk_t
 
chunk
)

143  
chunk
 & (
chunk_t
)((1ULL << 
DM_CHUNK_NUMBER_BITS
) - 1ULL);

144 
	}
}

146 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡
(
dm_ex˚±i⁄
 *
e
)

148  
e
->
√w_chunk
 >> 
DM_CHUNK_NUMBER_BITS
;

149 
	}
}

151 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡_öc
(
dm_ex˚±i⁄
 *
e
)

153 
e
->
√w_chunk
 +(1ULL << 
DM_CHUNK_NUMBER_BITS
);

155 
	`BUG_ON
(!
	`dm_c⁄£cutive_chunk_cou¡
(
e
));

156 
	}
}

158 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡_dec
(
dm_ex˚±i⁄
 *
e
)

160 
	`BUG_ON
(!
	`dm_c⁄£cutive_chunk_cou¡
(
e
));

162 
e
->
√w_chunk
 -(1ULL << 
DM_CHUNK_NUMBER_BITS
);

163 
	}
}

166 
	#DM_CHUNK_CONSECUTIVE_BITS
 0

	)

168 
ölöe
 
chunk_t
 
	$dm_chunk_numbî
(
chunk_t
 
chunk
)

170  
chunk
;

171 
	}
}

173 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡
(
dm_ex˚±i⁄
 *
e
)

176 
	}
}

178 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡_öc
(
dm_ex˚±i⁄
 *
e
)

180 
	}
}

182 
ölöe
 
	$dm_c⁄£cutive_chunk_cou¡_dec
(
dm_ex˚±i⁄
 *
e
)

184 
	}
}

191 
ölöe
 
£˘‹_t
 
	$gë_dev_size
(
block_devi˚
 *
bdev
)

193  
	`i_size_ªad
(
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

194 
	}
}

196 
ölöe
 
chunk_t
 
	$£˘‹_to_chunk
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

197 
£˘‹_t
 
£˘‹
)

199  
£˘‹
 >> 
°‹e
->
chunk_shi·
;

200 
	}
}

202 
dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
);

203 
dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(
dm_ex˚±i⁄_°‹e_ty≥
 *
ty≥
);

205 
dm_ex˚±i⁄_°‹e_£t_chunk_size
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

206 
chunk_size
,

207 **
îr‹
);

209 
dm_ex˚±i⁄_°‹e_¸óã
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
,

210 
dm_¢≠shŸ
 *
¢≠
,

211 *
¨gs_u£d
,

212 
dm_ex˚±i⁄_°‹e
 **
°‹e
);

213 
dm_ex˚±i⁄_°‹e_de°roy
(
dm_ex˚±i⁄_°‹e
 *
°‹e
);

215 
dm_ex˚±i⁄_°‹e_öô
();

216 
dm_ex˚±i⁄_°‹e_exô
();

221 
dm_≥rsi°ít_¢≠shŸ_öô
();

222 
dm_≥rsi°ít_¢≠shŸ_exô
();

224 
dm_å™sõ¡_¢≠shŸ_öô
();

225 
dm_å™sõ¡_¢≠shŸ_exô
();

	@dm-flakey.c

8 
	~<löux/devi˚-m≠≥r.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/blkdev.h
>

13 
	~<löux/bio.h
>

14 
	~<löux/¶ab.h
>

16 
	#DM_MSG_PREFIX
 "Êakey"

	)

18 
	#Æl_c‹ru±_bio_Êags_m©ch
(
bio
, 
fc
) \

19 (((
bio
)->
bi_rw
 & (
fc
)->
c‹ru±_bio_Êags
Ë=(fc)->c‹ru±_bio_Êags)

	)

25 
	sÊakey_c
 {

26 
dm_dev
 *
	mdev
;

27 
	m°¨t_time
;

28 
£˘‹_t
 
	m°¨t
;

29 
	mup_öãrvÆ
;

30 
	mdown_öãrvÆ
;

31 
	mÊags
;

32 
	mc‹ru±_bio_byã
;

33 
	mc‹ru±_bio_rw
;

34 
	mc‹ru±_bio_vÆue
;

35 
	mc‹ru±_bio_Êags
;

38 
	e„©uª_Êag_bôs
 {

39 
	mDROP_WRITES


42 
	s≥r_bio_d©a
 {

43 
boﬁ
 
	mbio_submôãd
;

46 
	$∑r£_„©uªs
(
dm_¨g_£t
 *
as
, 
Êakey_c
 *
fc
,

47 
dm_èrgë
 *
ti
)

49 
r
;

50 
¨gc
;

51 c⁄° *
¨g_«me
;

53 
dm_¨g
 
_¨gs
[] = {

55 {1, 
UINT_MAX
, "Invalid corrupt bio byte"},

57 {0, 
UINT_MAX
, "Invalid corrupt bio flags mask"},

61 i‡(!
as
->
¨gc
)

64 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
¨gc
, &
ti
->
îr‹
);

65 i‡(
r
)

66  
r
;

68 
¨gc
) {

69 
¨g_«me
 = 
	`dm_shi·_¨g
(
as
);

70 
¨gc
--;

75 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "drop_writes")) {

76 i‡(
	`ã°_™d_£t_bô
(
DROP_WRITES
, &
fc
->
Êags
)) {

77 
ti
->
îr‹
 = "Feature drop_writes duplicated";

78  -
EINVAL
;

87 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "corrupt_bio_byte")) {

88 i‡(!
¨gc
) {

89 
ti
->
îr‹
 = "Feature corrupt_bio_byteÑequiresÖarameters";

90  -
EINVAL
;

93 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 1, 
as
, &
fc
->
c‹ru±_bio_byã
, &
ti
->
îr‹
);

94 i‡(
r
)

95  
r
;

96 
¨gc
--;

101 
¨g_«me
 = 
	`dm_shi·_¨g
(
as
);

102 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "w"))

103 
fc
->
c‹ru±_bio_rw
 = 
WRITE
;

104 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "r"))

105 
fc
->
c‹ru±_bio_rw
 = 
READ
;

107 
ti
->
îr‹
 = "Invalid corrupt bio direction (r or w)";

108  -
EINVAL
;

110 
¨gc
--;

115 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 2, 
as
, &
fc
->
c‹ru±_bio_vÆue
, &
ti
->
îr‹
);

116 i‡(
r
)

117  
r
;

118 
¨gc
--;

123 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 3, 
as
, &
fc
->
c‹ru±_bio_Êags
, &
ti
->
îr‹
);

124 i‡(
r
)

125  
r
;

126 
¨gc
--;

131 
ti
->
îr‹
 = "Unrecognised flakey featureÑequested";

132  -
EINVAL
;

135 i‡(
	`ã°_bô
(
DROP_WRITES
, &
fc
->
Êags
Ë&& (fc->
c‹ru±_bio_rw
 =
WRITE
)) {

136 
ti
->
îr‹
 = "drop_writes is incompatible with corrupt_bio_byte withÅhe WRITE flag set";

137  -
EINVAL
;

141 
	}
}

155 
	$Êakey_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

157 
dm_¨g
 
_¨gs
[] = {

158 {0, 
UINT_MAX
, "Invalid up interval"},

159 {0, 
UINT_MAX
, "Invalid down interval"},

162 
r
;

163 
Êakey_c
 *
fc
;

164 
tm∂l
;

165 
dm_¨g_£t
 
as
;

166 c⁄° *
dev«me
;

167 
dummy
;

169 
as
.
¨gc
 =árgc;

170 
as
.
¨gv
 =árgv;

172 i‡(
¨gc
 < 4) {

173 
ti
->
îr‹
 = "Invalidárgument count";

174  -
EINVAL
;

177 
fc
 = 
	`kzÆloc
((*fc), 
GFP_KERNEL
);

178 i‡(!
fc
) {

179 
ti
->
îr‹
 = "Cannotállocate context";

180  -
ENOMEM
;

182 
fc
->
°¨t_time
 = 
jiffõs
;

184 
dev«me
 = 
	`dm_shi·_¨g
(&
as
);

186 i‡(
	`ssˇnf
(
	`dm_shi·_¨g
(&
as
), "%Œu%c", &
tm∂l
, &
dummy
) != 1) {

187 
ti
->
îr‹
 = "Invalid device sector";

188 
bad
;

190 
fc
->
°¨t
 = 
tm∂l
;

192 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, &
as
, &
fc
->
up_öãrvÆ
, &
ti
->
îr‹
);

193 i‡(
r
)

194 
bad
;

196 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, &
as
, &
fc
->
down_öãrvÆ
, &
ti
->
îr‹
);

197 i‡(
r
)

198 
bad
;

200 i‡(!(
fc
->
up_öãrvÆ
 + fc->
down_öãrvÆ
)) {

201 
ti
->
îr‹
 = "Total (up + down) interval is zero";

202 
bad
;

205 i‡(
fc
->
up_öãrvÆ
 + fc->
down_öãrvÆ
 < fc->up_interval) {

206 
ti
->
îr‹
 = "Interval overflow";

207 
bad
;

210 
r
 = 
	`∑r£_„©uªs
(&
as
, 
fc
, 
ti
);

211 i‡(
r
)

212 
bad
;

214 i‡(
	`dm_gë_devi˚
(
ti
, 
dev«me
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
fc
->
dev
)) {

215 
ti
->
îr‹
 = "DeviceÜookup failed";

216 
bad
;

219 
ti
->
num_Êush_bios
 = 1;

220 
ti
->
num_disˇrd_bios
 = 1;

221 
ti
->
≥r_bio_d©a_size
 = (
≥r_bio_d©a
);

222 
ti
->
¥iv©e
 = 
fc
;

225 
bad
:

226 
	`k‰ì
(
fc
);

227  -
EINVAL
;

228 
	}
}

230 
	$Êakey_då
(
dm_èrgë
 *
ti
)

232 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

234 
	`dm_put_devi˚
(
ti
, 
fc
->
dev
);

235 
	`k‰ì
(
fc
);

236 
	}
}

238 
£˘‹_t
 
	$Êakey_m≠_£˘‹
(
dm_èrgë
 *
ti
, 
£˘‹_t
 
bi_£˘‹
)

240 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

242  
fc
->
°¨t
 + 
	`dm_èrgë_off£t
(
ti
, 
bi_£˘‹
);

243 
	}
}

245 
	$Êakey_m≠_bio
(
dm_èrgë
 *
ti
, 
bio
 *bio)

247 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

249 
bio
->
bi_bdev
 = 
fc
->
dev
->
bdev
;

250 i‡(
	`bio_£˘‹s
(
bio
))

251 
bio
->
bi_ôî
.
bi_£˘‹
 =

252 
	`Êakey_m≠_£˘‹
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

253 
	}
}

255 
	$c‹ru±_bio_d©a
(
bio
 *bio, 
Êakey_c
 *
fc
)

257 
bio_byãs
 = 
	`bio_cur_byãs
(
bio
);

258 *
d©a
 = 
	`bio_d©a
(
bio
);

263 i‡(
d©a
 && 
bio_byãs
 >
fc
->
c‹ru±_bio_byã
) {

264 
d©a
[
fc
->
c‹ru±_bio_byã
 - 1] = fc->
c‹ru±_bio_vÆue
;

266 
	`DMDEBUG
("Corrupting data bio=%p by writing %uÅo byte %u "

268 
bio
, 
fc
->
c‹ru±_bio_vÆue
, fc->
c‹ru±_bio_byã
,

269 (
	`bio_d©a_dú
(
bio
Ë=
WRITE
Ë? 'w' : 'r', bio->
bi_rw
,

270 ()
bio
->
bi_ôî
.
bi_£˘‹
, 
bio_byãs
);

272 
	}
}

274 
	$Êakey_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

276 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

277 
ñ≠£d
;

278 
≥r_bio_d©a
 *
pb
 = 
	`dm_≥r_bio_d©a
(
bio
, (per_bio_data));

279 
pb
->
bio_submôãd
 = 
Ál£
;

282 
ñ≠£d
 = (
jiffõs
 - 
fc
->
°¨t_time
Ë/ 
HZ
;

283 i‡(
ñ≠£d
 % (
fc
->
up_öãrvÆ
 + fc->
down_öãrvÆ
) >= fc->up_interval) {

287 
pb
->
bio_submôãd
 = 
åue
;

292 i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
)

293 
m≠_bio
;

298 i‡(
	`ã°_bô
(
DROP_WRITES
, &
fc
->
Êags
)) {

299 
	`bio_ídio
(
bio
, 0);

300  
DM_MAPIO_SUBMITTED
;

306 i‡(
fc
->
c‹ru±_bio_byã
 && (fc->
c‹ru±_bio_rw
 =
WRITE
)) {

307 i‡(
	`Æl_c‹ru±_bio_Êags_m©ch
(
bio
, 
fc
))

308 
	`c‹ru±_bio_d©a
(
bio
, 
fc
);

309 
m≠_bio
;

315  -
EIO
;

318 
m≠_bio
:

319 
	`Êakey_m≠_bio
(
ti
, 
bio
);

321  
DM_MAPIO_REMAPPED
;

322 
	}
}

324 
	$Êakey_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

326 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

327 
≥r_bio_d©a
 *
pb
 = 
	`dm_≥r_bio_d©a
(
bio
, (per_bio_data));

333 i‡(
fc
->
c‹ru±_bio_byã
 && !
îr‹
 && 
pb
->
bio_submôãd
 &&

334 (
	`bio_d©a_dú
(
bio
Ë=
READ
Ë&& (
fc
->
c‹ru±_bio_rw
 == READ) &&

335 
	`Æl_c‹ru±_bio_Êags_m©ch
(
bio
, 
fc
))

336 
	`c‹ru±_bio_d©a
(
bio
, 
fc
);

338  
îr‹
;

339 
	}
}

341 
	$Êakey_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

342 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

344 
sz
 = 0;

345 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

346 
dr›_wrôes
;

348 
ty≥
) {

349 
STATUSTYPE_INFO
:

350 
ªsu…
[0] = '\0';

353 
STATUSTYPE_TABLE
:

354 
	`DMEMIT
("%†%Œu %u %u ", 
fc
->
dev
->
«me
,

355 ()
fc
->
°¨t
, fc->
up_öãrvÆ
,

356 
fc
->
down_öãrvÆ
);

358 
dr›_wrôes
 = 
	`ã°_bô
(
DROP_WRITES
, &
fc
->
Êags
);

359 
	`DMEMIT
("%u ", 
dr›_wrôes
 + (
fc
->
c‹ru±_bio_byã
 > 0) * 5);

361 i‡(
dr›_wrôes
)

362 
	`DMEMIT
("drop_writes ");

364 i‡(
fc
->
c‹ru±_bio_byã
)

365 
	`DMEMIT
("corrupt_bio_byte %u %c %u %u ",

366 
fc
->
c‹ru±_bio_byã
,

367 (
fc
->
c‹ru±_bio_rw
 =
WRITE
) ? 'w' : 'r',

368 
fc
->
c‹ru±_bio_vÆue
, fc->
c‹ru±_bio_Êags
);

372 
	}
}

374 
	$Êakey_io˘l
(
dm_èrgë
 *
ti
, 
cmd
, 
¨g
)

376 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

377 
dm_dev
 *
dev
 = 
fc
->dev;

378 
r
 = 0;

383 i‡(
fc
->
°¨t
 ||

384 
ti
->
Àn
 !
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
)

385 
r
 = 
	`scsi_vîify_blk_io˘l
(
NULL
, 
cmd
);

387  
r
 ? : 
	`__blkdev_drivî_io˘l
(
dev
->
bdev
, dev->
mode
, 
cmd
, 
¨g
);

388 
	}
}

390 
	$Êakey_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

391 
bio_vec
 *
biovec
, 
max_size
)

393 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

394 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
fc
->
dev
->
bdev
);

396 i‡(!
q
->
mîge_bvec_‚
)

397  
max_size
;

399 
bvm
->
bi_bdev
 = 
fc
->
dev
->
bdev
;

400 
bvm
->
bi_£˘‹
 = 
	`Êakey_m≠_£˘‹
(
ti
, bvm->bi_sector);

402  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

403 
	}
}

405 
	$Êakey_ôî©e_devi˚s
(
dm_èrgë
 *
ti
, 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

407 
Êakey_c
 *
fc
 = 
ti
->
¥iv©e
;

409  
	`‚
(
ti
, 
fc
->
dev
, fc->
°¨t
,Åi->
Àn
, 
d©a
);

410 
	}
}

412 
èrgë_ty≥
 
	gÊakey_èrgë
 = {

413 .
«me
 = "flakey",

414 .
	gvîsi⁄
 = {1, 3, 1},

415 .
	gmoduÀ
 = 
THIS_MODULE
,

416 .
	g˘r
 = 
Êakey_˘r
,

417 .
	gdå
 = 
Êakey_då
,

418 .
	gm≠
 = 
Êakey_m≠
,

419 .
	gíd_io
 = 
Êakey_íd_io
,

420 .
	g°©us
 = 
Êakey_°©us
,

421 .
	gio˘l
 = 
Êakey_io˘l
,

422 .
	gmîge
 = 
Êakey_mîge
,

423 .
	gôî©e_devi˚s
 = 
Êakey_ôî©e_devi˚s
,

426 
__öô
 
	$dm_Êakey_öô
()

428 
r
 = 
	`dm_ªgi°î_èrgë
(&
Êakey_èrgë
);

430 i‡(
r
 < 0)

431 
	`DMERR
("ªgi°î faûed %d", 
r
);

433  
r
;

434 
	}
}

436 
__exô
 
	$dm_Êakey_exô
()

438 
	`dm_uƒegi°î_èrgë
(&
Êakey_èrgë
);

439 
	}
}

442 
moduÀ_öô
(
dm_Êakey_öô
);

443 
moduÀ_exô
(
dm_Êakey_exô
);

445 
MODULE_DESCRIPTION
(
DM_NAME
 " flakeyÅarget");

446 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

447 
MODULE_LICENSE
("GPL");

	@dm-flakey.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

25 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

26 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

27 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

28 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

29 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

30 { 0x46„b099, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g
) },

31 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

32 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

33 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

34 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

35 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

36 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

37 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

38 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

39 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

40 { 0xf8c0f16e, 
__VMLINUX_SYMBOL_STR
(
__blkdev_drivî_io˘l
) },

41 { 0x4df6e7a2, 
__VMLINUX_SYMBOL_STR
(
scsi_vîify_blk_io˘l
) },

42 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

45 c⁄° 
	g__moduÀ_dïíds
[]

46 
__u£d


47 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

51 
MODULE_INFO
(
§cvîsi⁄
, "56CE782AEFB47A5759E16D7");

	@dm-io.c

8 
	~"dm.h
"

10 
	~<löux/devi˚-m≠≥r.h
>

12 
	~<löux/bio.h
>

13 
	~<löux/com∂ëi⁄.h
>

14 
	~<löux/mempoﬁ.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/sched.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/dm-io.h
>

20 
	#DM_MSG_PREFIX
 "io"

	)

22 
	#DM_IO_MAX_REGIONS
 
BITS_PER_LONG


	)

24 
	sdm_io_˛õ¡
 {

25 
mempoﬁ_t
 *
	mpoﬁ
;

26 
bio_£t
 *
	mbios
;

33 
	sio
 {

34 
	mîr‹_bôs
;

35 
©omic_t
 
	mcou¡
;

36 
dm_io_˛õ¡
 *
	m˛õ¡
;

37 
io_nŸify_‚
 
	mˇŒback
;

38 *
	mc⁄ãxt
;

39 *
	mvma_övÆid©e_addªss
;

40 
	mvma_övÆid©e_size
;

41 } 
__©åibuã__
((
Æig√d
(
DM_IO_MAX_REGIONS
)));

43 
kmem_ˇche
 *
	g_dm_io_ˇche
;

48 
dm_io_˛õ¡
 *
	$dm_io_˛õ¡_¸óã
()

50 
dm_io_˛õ¡
 *
˛õ¡
;

51 
mö_ios
 = 
	`dm_gë_ª£rved_bio_ba£d_ios
();

53 
˛õ¡
 = 
	`kmÆloc
((*˛õ¡), 
GFP_KERNEL
);

54 i‡(!
˛õ¡
)

55  
	`ERR_PTR
(-
ENOMEM
);

57 
˛õ¡
->
poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
mö_ios
, 
_dm_io_ˇche
);

58 i‡(!
˛õ¡
->
poﬁ
)

59 
bad
;

61 
˛õ¡
->
bios
 = 
	`bio£t_¸óã
(
mö_ios
, 0);

62 i‡(!
˛õ¡
->
bios
)

63 
bad
;

65  
˛õ¡
;

67 
bad
:

68 i‡(
˛õ¡
->
poﬁ
)

69 
	`mempoﬁ_de°roy
(
˛õ¡
->
poﬁ
);

70 
	`k‰ì
(
˛õ¡
);

71  
	`ERR_PTR
(-
ENOMEM
);

72 
	}
}

73 
EXPORT_SYMBOL
(
dm_io_˛õ¡_¸óã
);

75 
	$dm_io_˛õ¡_de°roy
(
dm_io_˛õ¡
 *
˛õ¡
)

77 
	`mempoﬁ_de°roy
(
˛õ¡
->
poﬁ
);

78 
	`bio£t_‰ì
(
˛õ¡
->
bios
);

79 
	`k‰ì
(
˛õ¡
);

80 
	}
}

81 
EXPORT_SYMBOL
(
dm_io_˛õ¡_de°roy
);

90 
	$°‹e_io_™d_ªgi⁄_ö_bio
(
bio
 *bio, 
io
 *io,

91 
ªgi⁄
)

93 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(()
io
, 
DM_IO_MAX_REGIONS
))) {

94 
	`DMCRIT
("U«lig√d såu˘ iÿpoöã∏%p", 
io
);

95 
	`BUG
();

98 
bio
->
bi_¥iv©e
 = (*)(()
io
 | 
ªgi⁄
);

99 
	}
}

101 
	$ªåõve_io_™d_ªgi⁄_‰om_bio
(
bio
 *bio, 
io
 **io,

102 *
ªgi⁄
)

104 
vÆ
 = ()
bio
->
bi_¥iv©e
;

106 *
io
 = (*)(
vÆ
 & -()
DM_IO_MAX_REGIONS
);

107 *
ªgi⁄
 = 
vÆ
 & (
DM_IO_MAX_REGIONS
 - 1);

108 
	}
}

114 
	$com∂ëe_io
(
io
 *io)

116 
îr‹_bôs
 = 
io
->error_bits;

117 
io_nŸify_‚
 
‚
 = 
io
->
ˇŒback
;

118 *
c⁄ãxt
 = 
io
->context;

120 i‡(
io
->
vma_övÆid©e_size
)

121 
	`övÆid©e_kî√l_vm≠_ønge
(
io
->
vma_övÆid©e_addªss
,

122 
io
->
vma_övÆid©e_size
);

124 
	`mempoﬁ_‰ì
(
io
, io->
˛õ¡
->
poﬁ
);

125 
	`‚
(
îr‹_bôs
, 
c⁄ãxt
);

126 
	}
}

128 
	$dec_cou¡
(
io
 *io, 
ªgi⁄
, 
îr‹
)

130 i‡(
îr‹
)

131 
	`£t_bô
(
ªgi⁄
, &
io
->
îr‹_bôs
);

133 i‡(
	`©omic_dec_™d_ã°
(&
io
->
cou¡
))

134 
	`com∂ëe_io
(
io
);

135 
	}
}

137 
	$ídio
(
bio
 *bio, 
îr‹
)

139 
io
 *io;

140 
ªgi⁄
;

142 i‡(
îr‹
 && 
	`bio_d©a_dú
(
bio
Ë=
READ
)

143 
	`zîo_fûl_bio
(
bio
);

148 
	`ªåõve_io_™d_ªgi⁄_‰om_bio
(
bio
, &
io
, &
ªgi⁄
);

150 
	`bio_put
(
bio
);

152 
	`dec_cou¡
(
io
, 
ªgi⁄
, 
îr‹
);

153 
	}
}

159 
	sd∑ges
 {

160 (*
	mgë_∑ge
)(
d∑ges
 *
	mdp
,

161 
∑ge
 **
	mp
, *
	mÀn
, *
	moff£t
);

162 (*
	m√xt_∑ge
)(
d∑ges
 *
	mdp
);

164 
	mc⁄ãxt_u
;

165 *
	mc⁄ãxt_±r
;

167 *
	mvma_övÆid©e_addªss
;

168 
	mvma_övÆid©e_size
;

174 
	$li°_gë_∑ge
(
d∑ges
 *
dp
,

175 
∑ge
 **
p
, *
Àn
, *
off£t
)

177 
o
 = 
dp
->
c⁄ãxt_u
;

178 
∑ge_li°
 *
∂
 = (∑ge_li° *Ë
dp
->
c⁄ãxt_±r
;

180 *
p
 = 
∂
->
∑ge
;

181 *
Àn
 = 
PAGE_SIZE
 - 
o
;

182 *
off£t
 = 
o
;

183 
	}
}

185 
	$li°_√xt_∑ge
(
d∑ges
 *
dp
)

187 
∑ge_li°
 *
∂
 = (∑ge_li° *Ë
dp
->
c⁄ãxt_±r
;

188 
dp
->
c⁄ãxt_±r
 = 
∂
->
√xt
;

189 
dp
->
c⁄ãxt_u
 = 0;

190 
	}
}

192 
	$li°_dp_öô
(
d∑ges
 *
dp
, 
∑ge_li°
 *
∂
, 
off£t
)

194 
dp
->
gë_∑ge
 = 
li°_gë_∑ge
;

195 
dp
->
√xt_∑ge
 = 
li°_√xt_∑ge
;

196 
dp
->
c⁄ãxt_u
 = 
off£t
;

197 
dp
->
c⁄ãxt_±r
 = 
∂
;

198 
	}
}

203 
	$bio_gë_∑ge
(
d∑ges
 *
dp
, 
∑ge
 **
p
,

204 *
Àn
, *
off£t
)

206 
bio_vec
 *
bvec
 = 
dp
->
c⁄ãxt_±r
;

207 *
p
 = 
bvec
->
bv_∑ge
;

208 *
Àn
 = 
bvec
->
bv_Àn
 - 
dp
->
c⁄ãxt_u
;

209 *
off£t
 = 
bvec
->
bv_off£t
 + 
dp
->
c⁄ãxt_u
;

210 
	}
}

212 
	$bio_√xt_∑ge
(
d∑ges
 *
dp
)

214 
bio_vec
 *
bvec
 = 
dp
->
c⁄ãxt_±r
;

215 
dp
->
c⁄ãxt_±r
 = 
bvec
 + 1;

216 
dp
->
c⁄ãxt_u
 = 0;

217 
	}
}

219 
	$bio_dp_öô
(
d∑ges
 *
dp
, 
bio
 *bio)

221 
dp
->
gë_∑ge
 = 
bio_gë_∑ge
;

222 
dp
->
√xt_∑ge
 = 
bio_√xt_∑ge
;

223 
dp
->
c⁄ãxt_±r
 = 
	`__bvec_ôî_bvec
(
bio
->
bi_io_vec
, bio->
bi_ôî
);

224 
dp
->
c⁄ãxt_u
 = 
bio
->
bi_ôî
.
bi_bvec_d⁄e
;

225 
	}
}

230 
	$vm_gë_∑ge
(
d∑ges
 *
dp
,

231 
∑ge
 **
p
, *
Àn
, *
off£t
)

233 *
p
 = 
	`vmÆloc_to_∑ge
(
dp
->
c⁄ãxt_±r
);

234 *
off£t
 = 
dp
->
c⁄ãxt_u
;

235 *
Àn
 = 
PAGE_SIZE
 - 
dp
->
c⁄ãxt_u
;

236 
	}
}

238 
	$vm_√xt_∑ge
(
d∑ges
 *
dp
)

240 
dp
->
c⁄ãxt_±r
 +
PAGE_SIZE
 - dp->
c⁄ãxt_u
;

241 
dp
->
c⁄ãxt_u
 = 0;

242 
	}
}

244 
	$vm_dp_öô
(
d∑ges
 *
dp
, *
d©a
)

246 
dp
->
gë_∑ge
 = 
vm_gë_∑ge
;

247 
dp
->
√xt_∑ge
 = 
vm_√xt_∑ge
;

248 
dp
->
c⁄ãxt_u
 = ((Ë
d©a
Ë& (
PAGE_SIZE
 - 1);

249 
dp
->
c⁄ãxt_±r
 = 
d©a
;

250 
	}
}

255 
	$km_gë_∑ge
(
d∑ges
 *
dp
, 
∑ge
 **
p
, *
Àn
,

256 *
off£t
)

258 *
p
 = 
	`vút_to_∑ge
(
dp
->
c⁄ãxt_±r
);

259 *
off£t
 = 
dp
->
c⁄ãxt_u
;

260 *
Àn
 = 
PAGE_SIZE
 - 
dp
->
c⁄ãxt_u
;

261 
	}
}

263 
	$km_√xt_∑ge
(
d∑ges
 *
dp
)

265 
dp
->
c⁄ãxt_±r
 +
PAGE_SIZE
 - dp->
c⁄ãxt_u
;

266 
dp
->
c⁄ãxt_u
 = 0;

267 
	}
}

269 
	$km_dp_öô
(
d∑ges
 *
dp
, *
d©a
)

271 
dp
->
gë_∑ge
 = 
km_gë_∑ge
;

272 
dp
->
√xt_∑ge
 = 
km_√xt_∑ge
;

273 
dp
->
c⁄ãxt_u
 = ((Ë
d©a
Ë& (
PAGE_SIZE
 - 1);

274 
dp
->
c⁄ãxt_±r
 = 
d©a
;

275 
	}
}

280 
	$do_ªgi⁄
(
rw
, 
ªgi⁄
, 
dm_io_ªgi⁄
 *
whîe
,

281 
d∑ges
 *
dp
, 
io
 *io)

283 
bio
 *bio;

284 
∑ge
 *page;

285 
Àn
;

286 
off£t
;

287 
num_bvecs
;

288 
£˘‹_t
 
ªmaöög
 = 
whîe
->
cou¡
;

289 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
whîe
->
bdev
);

290 
logiˇl_block_size
 = 
	`queue_logiˇl_block_size
(
q
);

291 
£˘‹_t
 
num_£˘‹s
;

301 i‡((
rw
 & 
REQ_DISCARD
Ë|| (rw & 
REQ_WRITE_SAME
))

302 
num_bvecs
 = 1;

304 
num_bvecs
 = 
	`mö_t
(, 
	`bio_gë_ƒ_vecs
(
whîe
->
bdev
),

305 
	`dm_£˘‹_div_up
(
ªmaöög
, (
PAGE_SIZE
 >> 
SECTOR_SHIFT
)));

307 
bio
 = 
	`bio_Æloc_bio£t
(
GFP_NOIO
, 
num_bvecs
, 
io
->
˛õ¡
->
bios
);

308 
bio
->
bi_ôî
.
bi_£˘‹
 = 
whîe
->
£˘‹
 + (whîe->
cou¡
 - 
ªmaöög
);

309 
bio
->
bi_bdev
 = 
whîe
->
bdev
;

310 
bio
->
bi_íd_io
 = 
ídio
;

311 
	`°‹e_io_™d_ªgi⁄_ö_bio
(
bio
, 
io
, 
ªgi⁄
);

313 i‡(
rw
 & 
REQ_DISCARD
) {

314 
num_£˘‹s
 = 
	`mö_t
(
£˘‹_t
, 
q
->
limôs
.
max_disˇrd_£˘‹s
, 
ªmaöög
);

315 
bio
->
bi_ôî
.
bi_size
 = 
num_£˘‹s
 << 
SECTOR_SHIFT
;

316 
ªmaöög
 -
num_£˘‹s
;

317 } i‡(
rw
 & 
REQ_WRITE_SAME
) {

321 
dp
->
	`gë_∑ge
(dp, &
∑ge
, &
Àn
, &
off£t
);

322 
	`bio_add_∑ge
(
bio
, 
∑ge
, 
logiˇl_block_size
, 
off£t
);

323 
num_£˘‹s
 = 
	`mö_t
(
£˘‹_t
, 
q
->
limôs
.
max_wrôe_ßme_£˘‹s
, 
ªmaöög
);

324 
bio
->
bi_ôî
.
bi_size
 = 
num_£˘‹s
 << 
SECTOR_SHIFT
;

326 
off£t
 = 0;

327 
ªmaöög
 -
num_£˘‹s
;

328 
dp
->
	`√xt_∑ge
(dp);

329 } 
ªmaöög
) {

333 
dp
->
	`gë_∑ge
(dp, &
∑ge
, &
Àn
, &
off£t
);

334 
Àn
 = 
	`mö
÷í, 
	`to_byãs
(
ªmaöög
));

335 i‡(!
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àn
, 
off£t
))

338 
off£t
 = 0;

339 
ªmaöög
 -
	`to_£˘‹
(
Àn
);

340 
dp
->
	`√xt_∑ge
(dp);

343 
	`©omic_öc
(&
io
->
cou¡
);

344 
	`submô_bio
(
rw
, 
bio
);

345 } 
ªmaöög
);

346 
	}
}

348 
	$di•©ch_io
(
rw
, 
num_ªgi⁄s
,

349 
dm_io_ªgi⁄
 *
whîe
, 
d∑ges
 *
dp
,

350 
io
 *io, 
sync
)

352 
i
;

353 
d∑ges
 
ﬁd_∑ges
 = *
dp
;

355 
	`BUG_ON
(
num_ªgi⁄s
 > 
DM_IO_MAX_REGIONS
);

357 i‡(
sync
)

358 
rw
 |
REQ_SYNC
;

364 
i
 = 0; i < 
num_ªgi⁄s
; i++) {

365 *
dp
 = 
ﬁd_∑ges
;

366 i‡(
whîe
[
i
].
cou¡
 || (
rw
 & 
REQ_FLUSH
))

367 
	`do_ªgi⁄
(
rw
, 
i
, 
whîe
 + i, 
dp
, 
io
);

374 
	`dec_cou¡
(
io
, 0, 0);

375 
	}
}

377 
	ssync_io
 {

378 
	mîr‹_bôs
;

379 
com∂ëi⁄
 
	mwaô
;

382 
	$sync_io_com∂ëe
(
îr‹
, *
c⁄ãxt
)

384 
sync_io
 *
sio
 = 
c⁄ãxt
;

386 
sio
->
îr‹_bôs
 = 
îr‹
;

387 
	`com∂ëe
(&
sio
->
waô
);

388 
	}
}

390 
	$sync_io
(
dm_io_˛õ¡
 *
˛õ¡
, 
num_ªgi⁄s
,

391 
dm_io_ªgi⁄
 *
whîe
, 
rw
, 
d∑ges
 *
dp
,

392 *
îr‹_bôs
)

394 
io
 *io;

395 
sync_io
 
sio
;

397 i‡(
num_ªgi⁄s
 > 1 && (
rw
 & 
RW_MASK
Ë!
WRITE
) {

398 
	`WARN_ON
(1);

399  -
EIO
;

402 
	`öô_com∂ëi⁄
(&
sio
.
waô
);

404 
io
 = 
	`mempoﬁ_Æloc
(
˛õ¡
->
poﬁ
, 
GFP_NOIO
);

405 
io
->
îr‹_bôs
 = 0;

406 
	`©omic_£t
(&
io
->
cou¡
, 1);

407 
io
->
˛õ¡
 = client;

408 
io
->
ˇŒback
 = 
sync_io_com∂ëe
;

409 
io
->
c⁄ãxt
 = &
sio
;

411 
io
->
vma_övÆid©e_addªss
 = 
dp
->vma_invalidate_address;

412 
io
->
vma_övÆid©e_size
 = 
dp
->vma_invalidate_size;

414 
	`di•©ch_io
(
rw
, 
num_ªgi⁄s
, 
whîe
, 
dp
, 
io
, 1);

416 
	`waô_f‹_com∂ëi⁄_io
(&
sio
.
waô
);

418 i‡(
îr‹_bôs
)

419 *
îr‹_bôs
 = 
sio
.error_bits;

421  
sio
.
îr‹_bôs
 ? -
EIO
 : 0;

422 
	}
}

424 
	$async_io
(
dm_io_˛õ¡
 *
˛õ¡
, 
num_ªgi⁄s
,

425 
dm_io_ªgi⁄
 *
whîe
, 
rw
, 
d∑ges
 *
dp
,

426 
io_nŸify_‚
 
‚
, *
c⁄ãxt
)

428 
io
 *io;

430 i‡(
num_ªgi⁄s
 > 1 && (
rw
 & 
RW_MASK
Ë!
WRITE
) {

431 
	`WARN_ON
(1);

432 
	`‚
(1, 
c⁄ãxt
);

433  -
EIO
;

436 
io
 = 
	`mempoﬁ_Æloc
(
˛õ¡
->
poﬁ
, 
GFP_NOIO
);

437 
io
->
îr‹_bôs
 = 0;

438 
	`©omic_£t
(&
io
->
cou¡
, 1);

439 
io
->
˛õ¡
 = client;

440 
io
->
ˇŒback
 = 
‚
;

441 
io
->
c⁄ãxt
 = context;

443 
io
->
vma_övÆid©e_addªss
 = 
dp
->vma_invalidate_address;

444 
io
->
vma_övÆid©e_size
 = 
dp
->vma_invalidate_size;

446 
	`di•©ch_io
(
rw
, 
num_ªgi⁄s
, 
whîe
, 
dp
, 
io
, 0);

448 
	}
}

450 
	$dp_öô
(
dm_io_ªque°
 *
io_ªq
, 
d∑ges
 *
dp
,

451 
size
)

455 
dp
->
vma_övÆid©e_addªss
 = 
NULL
;

456 
dp
->
vma_övÆid©e_size
 = 0;

458 
io_ªq
->
mem
.
ty≥
) {

459 
DM_IO_PAGE_LIST
:

460 
	`li°_dp_öô
(
dp
, 
io_ªq
->
mem
.
±r
.
∂
, io_ªq->mem.
off£t
);

463 
DM_IO_BIO
:

464 
	`bio_dp_öô
(
dp
, 
io_ªq
->
mem
.
±r
.
bio
);

467 
DM_IO_VMA
:

468 
	`Êush_kî√l_vm≠_ønge
(
io_ªq
->
mem
.
±r
.
vma
, 
size
);

469 i‡((
io_ªq
->
bi_rw
 & 
RW_MASK
Ë=
READ
) {

470 
dp
->
vma_övÆid©e_addªss
 = 
io_ªq
->
mem
.
±r
.
vma
;

471 
dp
->
vma_övÆid©e_size
 = 
size
;

473 
	`vm_dp_öô
(
dp
, 
io_ªq
->
mem
.
±r
.
vma
);

476 
DM_IO_KMEM
:

477 
	`km_dp_öô
(
dp
, 
io_ªq
->
mem
.
±r
.
addr
);

481  -
EINVAL
;

485 
	}
}

495 
	$dm_io
(
dm_io_ªque°
 *
io_ªq
, 
num_ªgi⁄s
,

496 
dm_io_ªgi⁄
 *
whîe
, *
sync_îr‹_bôs
)

498 
r
;

499 
d∑ges
 
dp
;

501 
r
 = 
	`dp_öô
(
io_ªq
, &
dp
, ()
whîe
->
cou¡
 << 
SECTOR_SHIFT
);

502 i‡(
r
)

503  
r
;

505 i‡(!
io_ªq
->
nŸify
.
‚
)

506  
	`sync_io
(
io_ªq
->
˛õ¡
, 
num_ªgi⁄s
, 
whîe
,

507 
io_ªq
->
bi_rw
, &
dp
, 
sync_îr‹_bôs
);

509  
	`async_io
(
io_ªq
->
˛õ¡
, 
num_ªgi⁄s
, 
whîe
, io_ªq->
bi_rw
,

510 &
dp
, 
io_ªq
->
nŸify
.
‚
, io_ªq->nŸify.
c⁄ãxt
);

511 
	}
}

512 
EXPORT_SYMBOL
(
dm_io
);

514 
__öô
 
	$dm_io_öô
()

516 
_dm_io_ˇche
 = 
	`KMEM_CACHE
(
io
, 0);

517 i‡(!
_dm_io_ˇche
)

518  -
ENOMEM
;

521 
	}
}

523 
	$dm_io_exô
()

525 
	`kmem_ˇche_de°roy
(
_dm_io_ˇche
);

526 
_dm_io_ˇche
 = 
NULL
;

527 
	}
}

	@dm-ioctl.c

8 
	~"dm.h
"

10 
	~<löux/moduÀ.h
>

11 
	~<löux/vmÆloc.h
>

12 
	~<löux/miscdevi˚.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/waô.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/dm-io˘l.h
>

17 
	~<löux/hdªg.h
>

18 
	~<löux/com∑t.h
>

20 
	~<asm/uac˚ss.h
>

22 
	#DM_MSG_PREFIX
 "io˘l"

	)

23 
	#DM_DRIVER_EMAIL
 "dm-devñ@ªdh©.com"

	)

29 
	shash_˚Œ
 {

30 
li°_hód
 
	m«me_li°
;

31 
li°_hód
 
	muuid_li°
;

33 *
	m«me
;

34 *
	muuid
;

35 
m≠≥d_devi˚
 *
	mmd
;

36 
dm_èbÀ
 *
	m√w_m≠
;

43 
	sdm_èbÀ
 {

44 
	mundeföed__
;

47 
	svîs_ôî
 {

48 
size_t
 
	m∑øm_size
;

49 
dm_èrgë_vîsi⁄s
 *
	mvîs
, *
	mﬁd_vîs
;

50 *
	míd
;

51 
uöt32_t
 
	mÊags
;

55 
	#NUM_BUCKETS
 64

	)

56 
	#MASK_BUCKETS
 (
NUM_BUCKETS
 - 1)

	)

57 
li°_hód
 
	g_«me_buckës
[
NUM_BUCKETS
];

58 
li°_hód
 
	g_uuid_buckës
[
NUM_BUCKETS
];

60 
dm_hash_ªmove_Æl
(
boﬁ
 
kìp_›í_devi˚s
, boﬁ 
m¨k_de„ºed
, boﬁ 
⁄ly_de„ºed
);

65 
DECLARE_RWSEM
(
_hash_lock
);

70 
DEFINE_MUTEX
(
dm_hash_˚Œs_muãx
);

72 
	$öô_buckës
(
li°_hód
 *
buckës
)

74 
i
;

76 
i
 = 0; i < 
NUM_BUCKETS
; i++)

77 
	`INIT_LIST_HEAD
(
buckës
 + 
i
);

78 
	}
}

80 
	$dm_hash_öô
()

82 
	`öô_buckës
(
_«me_buckës
);

83 
	`öô_buckës
(
_uuid_buckës
);

85 
	}
}

87 
	$dm_hash_exô
()

89 
	`dm_hash_ªmove_Æl
(
Ál£
, false, false);

90 
	}
}

97 
	$hash_°r
(c⁄° *
°r
)

99 c⁄° 
hash_mu…
 = 2654435387U;

100 
h
 = 0;

102 *
°r
)

103 
h
 = (h + (Ë*
°r
++Ë* 
hash_mu…
;

105  
h
 & 
MASK_BUCKETS
;

106 
	}
}

111 
hash_˚Œ
 *
	$__gë_«me_˚Œ
(c⁄° *
°r
)

113 
hash_˚Œ
 *
hc
;

114 
h
 = 
	`hash_°r
(
°r
);

116 
	`li°_f‹_óch_íåy
 (
hc
, 
_«me_buckës
 + 
h
, 
«me_li°
)

117 i‡(!
	`°rcmp
(
hc
->
«me
, 
°r
)) {

118 
	`dm_gë
(
hc
->
md
);

119  
hc
;

122  
NULL
;

123 
	}
}

125 
hash_˚Œ
 *
	$__gë_uuid_˚Œ
(c⁄° *
°r
)

127 
hash_˚Œ
 *
hc
;

128 
h
 = 
	`hash_°r
(
°r
);

130 
	`li°_f‹_óch_íåy
 (
hc
, 
_uuid_buckës
 + 
h
, 
uuid_li°
)

131 i‡(!
	`°rcmp
(
hc
->
uuid
, 
°r
)) {

132 
	`dm_gë
(
hc
->
md
);

133  
hc
;

136  
NULL
;

137 
	}
}

139 
hash_˚Œ
 *
	$__gë_dev_˚Œ
(
uöt64_t
 
dev
)

141 
m≠≥d_devi˚
 *
md
;

142 
hash_˚Œ
 *
hc
;

144 
md
 = 
	`dm_gë_md
(
	`huge_decode_dev
(
dev
));

145 i‡(!
md
)

146  
NULL
;

148 
hc
 = 
	`dm_gë_md±r
(
md
);

149 i‡(!
hc
) {

150 
	`dm_put
(
md
);

151  
NULL
;

154  
hc
;

155 
	}
}

160 
hash_˚Œ
 *
	$Æloc_˚Œ
(c⁄° *
«me
, c⁄° *
uuid
,

161 
m≠≥d_devi˚
 *
md
)

163 
hash_˚Œ
 *
hc
;

165 
hc
 = 
	`kmÆloc
((*hc), 
GFP_KERNEL
);

166 i‡(!
hc
)

167  
NULL
;

169 
hc
->
«me
 = 
	`k°rdup
“ame, 
GFP_KERNEL
);

170 i‡(!
hc
->
«me
) {

171 
	`k‰ì
(
hc
);

172  
NULL
;

175 i‡(!
uuid
)

176 
hc
->
uuid
 = 
NULL
;

179 
hc
->
uuid
 = 
	`k°rdup
(uuid, 
GFP_KERNEL
);

180 i‡(!
hc
->
uuid
) {

181 
	`k‰ì
(
hc
->
«me
);

182 
	`k‰ì
(
hc
);

183  
NULL
;

187 
	`INIT_LIST_HEAD
(&
hc
->
«me_li°
);

188 
	`INIT_LIST_HEAD
(&
hc
->
uuid_li°
);

189 
hc
->
md
 = md;

190 
hc
->
√w_m≠
 = 
NULL
;

191  
hc
;

192 
	}
}

194 
	$‰ì_˚Œ
(
hash_˚Œ
 *
hc
)

196 i‡(
hc
) {

197 
	`k‰ì
(
hc
->
«me
);

198 
	`k‰ì
(
hc
->
uuid
);

199 
	`k‰ì
(
hc
);

201 
	}
}

207 
	$dm_hash_ö£π
(c⁄° *
«me
, c⁄° *
uuid
, 
m≠≥d_devi˚
 *
md
)

209 
hash_˚Œ
 *
˚Œ
, *
hc
;

214 
˚Œ
 = 
	`Æloc_˚Œ
(
«me
, 
uuid
, 
md
);

215 i‡(!
˚Œ
)

216  -
ENOMEM
;

221 
	`down_wrôe
(&
_hash_lock
);

222 
hc
 = 
	`__gë_«me_˚Œ
(
«me
);

223 i‡(
hc
) {

224 
	`dm_put
(
hc
->
md
);

225 
bad
;

228 
	`li°_add
(&
˚Œ
->
«me_li°
, 
_«me_buckës
 + 
	`hash_°r
(
«me
));

230 i‡(
uuid
) {

231 
hc
 = 
	`__gë_uuid_˚Œ
(
uuid
);

232 i‡(
hc
) {

233 
	`li°_dñ
(&
˚Œ
->
«me_li°
);

234 
	`dm_put
(
hc
->
md
);

235 
bad
;

237 
	`li°_add
(&
˚Œ
->
uuid_li°
, 
_uuid_buckës
 + 
	`hash_°r
(
uuid
));

239 
	`dm_gë
(
md
);

240 
	`muãx_lock
(&
dm_hash_˚Œs_muãx
);

241 
	`dm_£t_md±r
(
md
, 
˚Œ
);

242 
	`muãx_u∆ock
(&
dm_hash_˚Œs_muãx
);

243 
	`up_wrôe
(&
_hash_lock
);

247 
bad
:

248 
	`up_wrôe
(&
_hash_lock
);

249 
	`‰ì_˚Œ
(
˚Œ
);

250  -
EBUSY
;

251 
	}
}

253 
dm_èbÀ
 *
	$__hash_ªmove
(
hash_˚Œ
 *
hc
)

255 
dm_èbÀ
 *
èbÀ
;

256 
§cu_idx
;

259 
	`li°_dñ
(&
hc
->
uuid_li°
);

260 
	`li°_dñ
(&
hc
->
«me_li°
);

261 
	`muãx_lock
(&
dm_hash_˚Œs_muãx
);

262 
	`dm_£t_md±r
(
hc
->
md
, 
NULL
);

263 
	`muãx_u∆ock
(&
dm_hash_˚Œs_muãx
);

265 
èbÀ
 = 
	`dm_gë_live_èbÀ
(
hc
->
md
, &
§cu_idx
);

266 i‡(
èbÀ
)

267 
	`dm_èbÀ_evít
(
èbÀ
);

268 
	`dm_put_live_èbÀ
(
hc
->
md
, 
§cu_idx
);

270 
èbÀ
 = 
NULL
;

271 i‡(
hc
->
√w_m≠
)

272 
èbÀ
 = 
hc
->
√w_m≠
;

273 
	`dm_put
(
hc
->
md
);

274 
	`‰ì_˚Œ
(
hc
);

276  
èbÀ
;

277 
	}
}

279 
	$dm_hash_ªmove_Æl
(
boﬁ
 
kìp_›í_devi˚s
, boﬁ 
m¨k_de„ºed
, boﬁ 
⁄ly_de„ºed
)

281 
i
, 
dev_skù≥d
;

282 
hash_˚Œ
 *
hc
;

283 
m≠≥d_devi˚
 *
md
;

284 
dm_èbÀ
 *
t
;

286 
ªåy
:

287 
dev_skù≥d
 = 0;

289 
	`down_wrôe
(&
_hash_lock
);

291 
i
 = 0; i < 
NUM_BUCKETS
; i++) {

292 
	`li°_f‹_óch_íåy
(
hc
, 
_«me_buckës
 + 
i
, 
«me_li°
) {

293 
md
 = 
hc
->md;

294 
	`dm_gë
(
md
);

296 i‡(
kìp_›í_devi˚s
 &&

297 
	`dm_lock_f‹_dñëi⁄
(
md
, 
m¨k_de„ºed
, 
⁄ly_de„ºed
)) {

298 
	`dm_put
(
md
);

299 
dev_skù≥d
++;

303 
t
 = 
	`__hash_ªmove
(
hc
);

305 
	`up_wrôe
(&
_hash_lock
);

307 i‡(
t
) {

308 
	`dm_sync_èbÀ
(
md
);

309 
	`dm_èbÀ_de°roy
(
t
);

311 
	`dm_put
(
md
);

312 i‡(
	`likñy
(
kìp_›í_devi˚s
))

313 
	`dm_de°roy
(
md
);

315 
	`dm_de°roy_immedüã
(
md
);

323 
ªåy
;

327 
	`up_wrôe
(&
_hash_lock
);

329 i‡(
dev_skù≥d
)

330 
	`DMWARN
("ªmove_Æ»À· %d o≥¿devi˚(s)", 
dev_skù≥d
);

331 
	}
}

336 
	$__£t_˚Œ_uuid
(
hash_˚Œ
 *
hc
, *
√w_uuid
)

338 
	`muãx_lock
(&
dm_hash_˚Œs_muãx
);

339 
hc
->
uuid
 = 
√w_uuid
;

340 
	`muãx_u∆ock
(&
dm_hash_˚Œs_muãx
);

342 
	`li°_add
(&
hc
->
uuid_li°
, 
_uuid_buckës
 + 
	`hash_°r
(
√w_uuid
));

343 
	}
}

349 *
	$__ch™ge_˚Œ_«me
(
hash_˚Œ
 *
hc
, *
√w_«me
)

351 *
ﬁd_«me
;

356 
	`li°_dñ
(&
hc
->
«me_li°
);

357 
ﬁd_«me
 = 
hc
->
«me
;

359 
	`muãx_lock
(&
dm_hash_˚Œs_muãx
);

360 
hc
->
«me
 = 
√w_«me
;

361 
	`muãx_u∆ock
(&
dm_hash_˚Œs_muãx
);

363 
	`li°_add
(&
hc
->
«me_li°
, 
_«me_buckës
 + 
	`hash_°r
(
√w_«me
));

365  
ﬁd_«me
;

366 
	}
}

368 
m≠≥d_devi˚
 *
	$dm_hash_ª«me
(
dm_io˘l
 *
∑øm
,

369 c⁄° *
√w
)

371 *
√w_d©a
, *
ﬁd_«me
 = 
NULL
;

372 
hash_˚Œ
 *
hc
;

373 
dm_èbÀ
 *
èbÀ
;

374 
m≠≥d_devi˚
 *
md
;

375 
ch™ge_uuid
 = (
∑øm
->
Êags
 & 
DM_UUID_FLAG
) ? 1 : 0;

376 
§cu_idx
;

381 
√w_d©a
 = 
	`k°rdup
(
√w
, 
GFP_KERNEL
);

382 i‡(!
√w_d©a
)

383  
	`ERR_PTR
(-
ENOMEM
);

385 
	`down_wrôe
(&
_hash_lock
);

390 i‡(
ch™ge_uuid
)

391 
hc
 = 
	`__gë_uuid_˚Œ
(
√w
);

393 
hc
 = 
	`__gë_«me_˚Œ
(
√w
);

395 i‡(
hc
) {

396 
	`DMWARN
("UnableÅo change %s on mapped device %sÅo oneÅhat "

398 
ch™ge_uuid
 ? "uuid" : "name",

399 
∑øm
->
«me
, 
√w
);

400 
	`dm_put
(
hc
->
md
);

401 
	`up_wrôe
(&
_hash_lock
);

402 
	`k‰ì
(
√w_d©a
);

403  
	`ERR_PTR
(-
EBUSY
);

409 
hc
 = 
	`__gë_«me_˚Œ
(
∑øm
->
«me
);

410 i‡(!
hc
) {

411 
	`DMWARN
("UnableÅoÑenameÇon-existent device, %sÅo %s%s",

412 
∑øm
->
«me
, 
ch™ge_uuid
 ? "uuid " : "", 
√w
);

413 
	`up_wrôe
(&
_hash_lock
);

414 
	`k‰ì
(
√w_d©a
);

415  
	`ERR_PTR
(-
ENXIO
);

421 i‡(
ch™ge_uuid
 && 
hc
->
uuid
) {

422 
	`DMWARN
("UnableÅo change uuid of mapped device %sÅo %s "

424 
∑øm
->
«me
, 
√w
, 
hc
->
uuid
);

425 
	`dm_put
(
hc
->
md
);

426 
	`up_wrôe
(&
_hash_lock
);

427 
	`k‰ì
(
√w_d©a
);

428  
	`ERR_PTR
(-
EINVAL
);

431 i‡(
ch™ge_uuid
)

432 
	`__£t_˚Œ_uuid
(
hc
, 
√w_d©a
);

434 
ﬁd_«me
 = 
	`__ch™ge_˚Œ_«me
(
hc
, 
√w_d©a
);

439 
èbÀ
 = 
	`dm_gë_live_èbÀ
(
hc
->
md
, &
§cu_idx
);

440 i‡(
èbÀ
)

441 
	`dm_èbÀ_evít
(
èbÀ
);

442 
	`dm_put_live_èbÀ
(
hc
->
md
, 
§cu_idx
);

444 i‡(!
	`dm_kobje˘_uevít
(
hc
->
md
, 
KOBJ_CHANGE
, 
∑øm
->
evít_ƒ
))

445 
∑øm
->
Êags
 |
DM_UEVENT_GENERATED_FLAG
;

447 
md
 = 
hc
->md;

448 
	`up_wrôe
(&
_hash_lock
);

449 
	`k‰ì
(
ﬁd_«me
);

451  
md
;

452 
	}
}

454 
	$dm_de„ºed_ªmove
()

456 
	`dm_hash_ªmove_Æl
(
åue
, 
Ál£
,Årue);

457 
	}
}

466 (*
	tio˘l_‚
)(
	tdm_io˘l
 *
	t∑øm
, 
	tsize_t
 
	t∑øm_size
);

468 
	$ªmove_Æl
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

470 
	`dm_hash_ªmove_Æl
(
åue
, !!(
∑øm
->
Êags
 & 
DM_DEFERRED_REMOVE
), 
Ál£
);

471 
∑øm
->
d©a_size
 = 0;

473 
	}
}

478 
	#ALIGN_MASK
 7

	)

479 
ölöe
 *
	$Æign_±r
(*
±r
)

481  (*Ë(((
size_t
Ë(
±r
 + 
ALIGN_MASK
)) & ~ALIGN_MASK);

482 
	}
}

488 *
	$gë_ªsu…_buf„r
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
,

489 
size_t
 *
Àn
)

491 
∑øm
->
d©a_°¨t
 = 
	`Æign_±r
(param + 1) - (*)Öaram;

493 i‡(
∑øm
->
d©a_°¨t
 < 
∑øm_size
)

494 *
Àn
 = 
∑øm_size
 - 
∑øm
->
d©a_°¨t
;

496 *
Àn
 = 0;

498  ((*Ë
∑øm
Ë+Ö¨am->
d©a_°¨t
;

499 
	}
}

501 
	$li°_devi˚s
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

503 
i
;

504 
hash_˚Œ
 *
hc
;

505 
size_t
 
Àn
, 
√eded
 = 0;

506 
gídisk
 *
disk
;

507 
dm_«me_li°
 *
∆
, *
ﬁd_∆
 = 
NULL
;

509 
	`down_wrôe
(&
_hash_lock
);

515 
i
 = 0; i < 
NUM_BUCKETS
; i++) {

516 
	`li°_f‹_óch_íåy
 (
hc
, 
_«me_buckës
 + 
i
, 
«me_li°
) {

517 
√eded
 +(
dm_«me_li°
);

518 
√eded
 +
	`°æí
(
hc
->
«me
) + 1;

519 
√eded
 +
ALIGN_MASK
;

526 
∆
 = 
	`gë_ªsu…_buf„r
(
∑øm
, 
∑øm_size
, &
Àn
);

527 i‡(
Àn
 < 
√eded
) {

528 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

529 
out
;

531 
∑øm
->
d©a_size
 =Ö¨am->
d©a_°¨t
 + 
√eded
;

533 
∆
->
dev
 = 0;

538 
i
 = 0; i < 
NUM_BUCKETS
; i++) {

539 
	`li°_f‹_óch_íåy
 (
hc
, 
_«me_buckës
 + 
i
, 
«me_li°
) {

540 i‡(
ﬁd_∆
)

541 
ﬁd_∆
->
√xt
 = (
uöt32_t
Ë((*Ë
∆
 -

542 (*Ë
ﬁd_∆
);

543 
disk
 = 
	`dm_disk
(
hc
->
md
);

544 
∆
->
dev
 = 
	`huge_ícode_dev
(
	`disk_devt
(
disk
));

545 
∆
->
√xt
 = 0;

546 
	`°r˝y
(
∆
->
«me
, 
hc
->name);

548 
ﬁd_∆
 = 
∆
;

549 
∆
 = 
	`Æign_±r
(((*Ë++∆Ë+ 
	`°æí
(
hc
->
«me
) + 1);

553 
out
:

554 
	`up_wrôe
(&
_hash_lock
);

556 
	}
}

558 
	$li°_vîsi⁄_gë_√eded
(
èrgë_ty≥
 *
â
, *
√eded_∑øm
)

560 
size_t
 *
√eded
 = 
√eded_∑øm
;

562 *
√eded
 +(
dm_èrgë_vîsi⁄s
);

563 *
√eded
 +
	`°æí
(
â
->
«me
);

564 *
√eded
 +
ALIGN_MASK
;

565 
	}
}

567 
	$li°_vîsi⁄_gë_öfo
(
èrgë_ty≥
 *
â
, *
∑øm
)

569 
vîs_ôî
 *
öfo
 = 
∑øm
;

572 i‡((*)
öfo
->
vîs
 + (
â
->
vîsi⁄
Ë+ 
	`°æí
—t->
«me
) + 1 >

573 
öfo
->
íd
) {

575 
öfo
->
Êags
 = 
DM_BUFFER_FULL_FLAG
;

579 i‡(
öfo
->
ﬁd_vîs
)

580 
öfo
->
ﬁd_vîs
->
√xt
 = (
uöt32_t
Ë((*)öfo->
vîs
 -

581 (*)
öfo
->
ﬁd_vîs
);

582 
öfo
->
vîs
->
vîsi⁄
[0] = 
â
->version[0];

583 
öfo
->
vîs
->
vîsi⁄
[1] = 
â
->version[1];

584 
öfo
->
vîs
->
vîsi⁄
[2] = 
â
->version[2];

585 
öfo
->
vîs
->
√xt
 = 0;

586 
	`°r˝y
(
öfo
->
vîs
->
«me
, 
â
->name);

588 
öfo
->
ﬁd_vîs
 = info->
vîs
;

589 
öfo
->
vîs
 = 
	`Æign_±r
(((*Ë++öfo->vîsË+ 
	`°æí
(
â
->
«me
) + 1);

590 
	}
}

592 
	$li°_vîsi⁄s
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

594 
size_t
 
Àn
, 
√eded
 = 0;

595 
dm_èrgë_vîsi⁄s
 *
vîs
;

596 
vîs_ôî
 
ôî_öfo
;

602 
	`dm_èrgë_ôî©e
(
li°_vîsi⁄_gë_√eded
, &
√eded
);

607 
vîs
 = 
	`gë_ªsu…_buf„r
(
∑øm
, 
∑øm_size
, &
Àn
);

608 i‡(
Àn
 < 
√eded
) {

609 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

610 
out
;

612 
∑øm
->
d©a_size
 =Ö¨am->
d©a_°¨t
 + 
√eded
;

614 
ôî_öfo
.
∑øm_size
 =Öaram_size;

615 
ôî_öfo
.
ﬁd_vîs
 = 
NULL
;

616 
ôî_öfo
.
vîs
 = vers;

617 
ôî_öfo
.
Êags
 = 0;

618 
ôî_öfo
.
íd
 = (*)
vîs
+
Àn
;

623 
	`dm_èrgë_ôî©e
(
li°_vîsi⁄_gë_öfo
, &
ôî_öfo
);

624 
∑øm
->
Êags
 |
ôî_öfo
.flags;

626 
out
:

628 
	}
}

630 
	$check_«me
(c⁄° *
«me
)

632 i‡(
	`°rchr
(
«me
, '/')) {

633 
	`DMWARN
("invalid deviceÇame");

634  -
EINVAL
;

638 
	}
}

645 
dm_èbÀ
 *
	$dm_gë_öa˘ive_èbÀ
(
m≠≥d_devi˚
 *
md
, *
§cu_idx
)

647 
hash_˚Œ
 *
hc
;

648 
dm_èbÀ
 *
èbÀ
 = 
NULL
;

651 
	`dm_gë_live_èbÀ
(
md
, 
§cu_idx
);

653 
	`down_ªad
(&
_hash_lock
);

654 
hc
 = 
	`dm_gë_md±r
(
md
);

655 i‡(!
hc
 || hc->
md
 != md) {

656 
	`DMWARN
("device has beenÑemoved fromÅhe dev hashÅable.");

657 
out
;

660 
èbÀ
 = 
hc
->
√w_m≠
;

662 
out
:

663 
	`up_ªad
(&
_hash_lock
);

665  
èbÀ
;

666 
	}
}

668 
dm_èbÀ
 *
	$dm_gë_live_‹_öa˘ive_èbÀ
(
m≠≥d_devi˚
 *
md
,

669 
dm_io˘l
 *
∑øm
,

670 *
§cu_idx
)

672  (
∑øm
->
Êags
 & 
DM_QUERY_INACTIVE_TABLE_FLAG
) ?

673 
	`dm_gë_öa˘ive_èbÀ
(
md
, 
§cu_idx
Ë: 
	`dm_gë_live_èbÀ
(md, srcu_idx);

674 
	}
}

680 
	$__dev_°©us
(
m≠≥d_devi˚
 *
md
, 
dm_io˘l
 *
∑øm
)

682 
gídisk
 *
disk
 = 
	`dm_disk
(
md
);

683 
dm_èbÀ
 *
èbÀ
;

684 
§cu_idx
;

686 
∑øm
->
Êags
 &~(
DM_SUSPEND_FLAG
 | 
DM_READONLY_FLAG
 |

687 
DM_ACTIVE_PRESENT_FLAG
);

689 i‡(
	`dm_su•íded_md
(
md
))

690 
∑øm
->
Êags
 |
DM_SUSPEND_FLAG
;

692 i‡(
	`dm_ã°_de„ºed_ªmove_Êag
(
md
))

693 
∑øm
->
Êags
 |
DM_DEFERRED_REMOVE
;

695 
∑øm
->
dev
 = 
	`huge_ícode_dev
(
	`disk_devt
(
disk
));

702 
∑øm
->
›í_cou¡
 = 
	`dm_›í_cou¡
(
md
);

704 
∑øm
->
evít_ƒ
 = 
	`dm_gë_evít_ƒ
(
md
);

705 
∑øm
->
èrgë_cou¡
 = 0;

707 
èbÀ
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

708 i‡(
èbÀ
) {

709 i‡(!(
∑øm
->
Êags
 & 
DM_QUERY_INACTIVE_TABLE_FLAG
)) {

710 i‡(
	`gë_disk_ro
(
disk
))

711 
∑øm
->
Êags
 |
DM_READONLY_FLAG
;

712 
∑øm
->
èrgë_cou¡
 = 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
);

715 
∑øm
->
Êags
 |
DM_ACTIVE_PRESENT_FLAG
;

717 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

719 i‡(
∑øm
->
Êags
 & 
DM_QUERY_INACTIVE_TABLE_FLAG
) {

720 
§cu_idx
;

721 
èbÀ
 = 
	`dm_gë_öa˘ive_èbÀ
(
md
, &
§cu_idx
);

722 i‡(
èbÀ
) {

723 i‡(!(
	`dm_èbÀ_gë_mode
(
èbÀ
Ë& 
FMODE_WRITE
))

724 
∑øm
->
Êags
 |
DM_READONLY_FLAG
;

725 
∑øm
->
èrgë_cou¡
 = 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
);

727 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

729 
	}
}

731 
	$dev_¸óã
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

733 
r
, 
m
 = 
DM_ANY_MINOR
;

734 
m≠≥d_devi˚
 *
md
;

736 
r
 = 
	`check_«me
(
∑øm
->
«me
);

737 i‡(
r
)

738  
r
;

740 i‡(
∑øm
->
Êags
 & 
DM_PERSISTENT_DEV_FLAG
)

741 
m
 = 
	`MINOR
(
	`huge_decode_dev
(
∑øm
->
dev
));

743 
r
 = 
	`dm_¸óã
(
m
, &
md
);

744 i‡(
r
)

745  
r
;

747 
r
 = 
	`dm_hash_ö£π
(
∑øm
->
«me
, *∑øm->
uuid
 ?Ö¨am->uuid : 
NULL
, 
md
);

748 i‡(
r
) {

749 
	`dm_put
(
md
);

750 
	`dm_de°roy
(
md
);

751  
r
;

754 
∑øm
->
Êags
 &~
DM_INACTIVE_PRESENT_FLAG
;

756 
	`__dev_°©us
(
md
, 
∑øm
);

758 
	`dm_put
(
md
);

761 
	}
}

766 
hash_˚Œ
 *
	$__föd_devi˚_hash_˚Œ
(
dm_io˘l
 *
∑øm
)

768 
hash_˚Œ
 *
hc
 = 
NULL
;

770 i‡(*
∑øm
->
uuid
) {

771 i‡(*
∑øm
->
«me
 ||Ö¨am->
dev
)

772  
NULL
;

774 
hc
 = 
	`__gë_uuid_˚Œ
(
∑øm
->
uuid
);

775 i‡(!
hc
)

776  
NULL
;

777 } i‡(*
∑øm
->
«me
) {

778 i‡(
∑øm
->
dev
)

779  
NULL
;

781 
hc
 = 
	`__gë_«me_˚Œ
(
∑øm
->
«me
);

782 i‡(!
hc
)

783  
NULL
;

784 } i‡(
∑øm
->
dev
) {

785 
hc
 = 
	`__gë_dev_˚Œ
(
∑øm
->
dev
);

786 i‡(!
hc
)

787  
NULL
;

789  
NULL
;

795 
	`°æ˝y
(
∑øm
->
«me
, 
hc
->name, (param->name));

796 i‡(
hc
->
uuid
)

797 
	`°æ˝y
(
∑øm
->
uuid
, 
hc
->uuid, (param->uuid));

799 
∑øm
->
uuid
[0] = '\0';

801 i‡(
hc
->
√w_m≠
)

802 
∑øm
->
Êags
 |
DM_INACTIVE_PRESENT_FLAG
;

804 
∑øm
->
Êags
 &~
DM_INACTIVE_PRESENT_FLAG
;

806  
hc
;

807 
	}
}

809 
m≠≥d_devi˚
 *
	$föd_devi˚
(
dm_io˘l
 *
∑øm
)

811 
hash_˚Œ
 *
hc
;

812 
m≠≥d_devi˚
 *
md
 = 
NULL
;

814 
	`down_ªad
(&
_hash_lock
);

815 
hc
 = 
	`__föd_devi˚_hash_˚Œ
(
∑øm
);

816 i‡(
hc
)

817 
md
 = 
hc
->md;

818 
	`up_ªad
(&
_hash_lock
);

820  
md
;

821 
	}
}

823 
	$dev_ªmove
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

825 
hash_˚Œ
 *
hc
;

826 
m≠≥d_devi˚
 *
md
;

827 
r
;

828 
dm_èbÀ
 *
t
;

830 
	`down_wrôe
(&
_hash_lock
);

831 
hc
 = 
	`__föd_devi˚_hash_˚Œ
(
∑øm
);

833 i‡(!
hc
) {

834 
	`DMDEBUG_LIMIT
("device doesn'táppearÅo be inÅhe dev hashÅable.");

835 
	`up_wrôe
(&
_hash_lock
);

836  -
ENXIO
;

839 
md
 = 
hc
->md;

844 
r
 = 
	`dm_lock_f‹_dñëi⁄
(
md
, !!(
∑øm
->
Êags
 & 
DM_DEFERRED_REMOVE
), 
Ál£
);

845 i‡(
r
) {

846 i‡(
r
 =-
EBUSY
 && 
∑øm
->
Êags
 & 
DM_DEFERRED_REMOVE
) {

847 
	`up_wrôe
(&
_hash_lock
);

848 
	`dm_put
(
md
);

851 
	`DMDEBUG_LIMIT
("u«bÀÅÿªmovê›í devi˚ %s", 
hc
->
«me
);

852 
	`up_wrôe
(&
_hash_lock
);

853 
	`dm_put
(
md
);

854  
r
;

857 
t
 = 
	`__hash_ªmove
(
hc
);

858 
	`up_wrôe
(&
_hash_lock
);

860 i‡(
t
) {

861 
	`dm_sync_èbÀ
(
md
);

862 
	`dm_èbÀ_de°roy
(
t
);

865 
∑øm
->
Êags
 &~
DM_DEFERRED_REMOVE
;

867 i‡(!
	`dm_kobje˘_uevít
(
md
, 
KOBJ_REMOVE
, 
∑øm
->
evít_ƒ
))

868 
∑øm
->
Êags
 |
DM_UEVENT_GENERATED_FLAG
;

870 
	`dm_put
(
md
);

871 
	`dm_de°roy
(
md
);

873 
	}
}

879 
	$övÆid_°r
(*
°r
, *
íd
)

881 (*Ë
°r
 < 
íd
)

882 i‡(!*
°r
++)

885  -
EINVAL
;

886 
	}
}

888 
	$dev_ª«me
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

890 
r
;

891 *
√w_d©a
 = (*Ë
∑øm
 +Ö¨am->
d©a_°¨t
;

892 
m≠≥d_devi˚
 *
md
;

893 
ch™ge_uuid
 = (
∑øm
->
Êags
 & 
DM_UUID_FLAG
) ? 1 : 0;

895 i‡(
√w_d©a
 < 
∑øm
->
d©a
 ||

896 
	`övÆid_°r
(
√w_d©a
, (*Ë
∑øm
 + 
∑øm_size
) || !*new_data ||

897 
	`°æí
(
√w_d©a
Ë> (
ch™ge_uuid
 ? 
DM_UUID_LEN
 - 1 : 
DM_NAME_LEN
 - 1)) {

898 
	`DMWARN
("InvalidÇew mapped deviceÇame or uuid string supplied.");

899  -
EINVAL
;

902 i‡(!
ch™ge_uuid
) {

903 
r
 = 
	`check_«me
(
√w_d©a
);

904 i‡(
r
)

905  
r
;

908 
md
 = 
	`dm_hash_ª«me
(
∑øm
, 
√w_d©a
);

909 i‡(
	`IS_ERR
(
md
))

910  
	`PTR_ERR
(
md
);

912 
	`__dev_°©us
(
md
, 
∑øm
);

913 
	`dm_put
(
md
);

916 
	}
}

918 
	$dev_£t_geomëry
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

920 
r
 = -
EINVAL
, 
x
;

921 
m≠≥d_devi˚
 *
md
;

922 
hd_geomëry
 
geomëry
;

923 
öd©a
[4];

924 *
geo°r
 = (*Ë
∑øm
 +Ö¨am->
d©a_°¨t
;

925 
dummy
;

927 
md
 = 
	`föd_devi˚
(
∑øm
);

928 i‡(!
md
)

929  -
ENXIO
;

931 i‡(
geo°r
 < 
∑øm
->
d©a
 ||

932 
	`övÆid_°r
(
geo°r
, (*Ë
∑øm
 + 
∑øm_size
)) {

933 
	`DMWARN
("Invalid geometry supplied.");

934 
out
;

937 
x
 = 
	`ssˇnf
(
geo°r
, "%lu %lu %lu %lu%c", 
öd©a
,

938 
öd©a
 + 1, ind©®+ 2, ind©®+ 3, &
dummy
);

940 i‡(
x
 != 4) {

941 
	`DMWARN
("UnableÅo interpret geometry settings.");

942 
out
;

945 i‡(
öd©a
[0] > 65535 || indata[1] > 255 ||

946 
öd©a
[2] > 255 || ind©a[3] > 
ULONG_MAX
) {

947 
	`DMWARN
("GeometryÉxceedsÑangeÜimits.");

948 
out
;

951 
geomëry
.
cylödîs
 = 
öd©a
[0];

952 
geomëry
.
hóds
 = 
öd©a
[1];

953 
geomëry
.
£˘‹s
 = 
öd©a
[2];

954 
geomëry
.
°¨t
 = 
öd©a
[3];

956 
r
 = 
	`dm_£t_geomëry
(
md
, &
geomëry
);

958 
∑øm
->
d©a_size
 = 0;

960 
out
:

961 
	`dm_put
(
md
);

962  
r
;

963 
	}
}

965 
	$do_su•íd
(
dm_io˘l
 *
∑øm
)

967 
r
 = 0;

968 
su•íd_Êags
 = 
DM_SUSPEND_LOCKFS_FLAG
;

969 
m≠≥d_devi˚
 *
md
;

971 
md
 = 
	`föd_devi˚
(
∑øm
);

972 i‡(!
md
)

973  -
ENXIO
;

975 i‡(
∑øm
->
Êags
 & 
DM_SKIP_LOCKFS_FLAG
)

976 
su•íd_Êags
 &~
DM_SUSPEND_LOCKFS_FLAG
;

977 i‡(
∑øm
->
Êags
 & 
DM_NOFLUSH_FLAG
)

978 
su•íd_Êags
 |
DM_SUSPEND_NOFLUSH_FLAG
;

980 i‡(!
	`dm_su•íded_md
(
md
)) {

981 
r
 = 
	`dm_su•íd
(
md
, 
su•íd_Êags
);

982 i‡(
r
)

983 
out
;

986 
	`__dev_°©us
(
md
, 
∑øm
);

988 
out
:

989 
	`dm_put
(
md
);

991  
r
;

992 
	}
}

994 
	$do_ªsume
(
dm_io˘l
 *
∑øm
)

996 
r
 = 0;

997 
su•íd_Êags
 = 
DM_SUSPEND_LOCKFS_FLAG
;

998 
hash_˚Œ
 *
hc
;

999 
m≠≥d_devi˚
 *
md
;

1000 
dm_èbÀ
 *
√w_m≠
, *
ﬁd_m≠
 = 
NULL
;

1002 
	`down_wrôe
(&
_hash_lock
);

1004 
hc
 = 
	`__föd_devi˚_hash_˚Œ
(
∑øm
);

1005 i‡(!
hc
) {

1006 
	`DMDEBUG_LIMIT
("device doesn'táppearÅo be inÅhe dev hashÅable.");

1007 
	`up_wrôe
(&
_hash_lock
);

1008  -
ENXIO
;

1011 
md
 = 
hc
->md;

1013 
√w_m≠
 = 
hc
->new_map;

1014 
hc
->
√w_m≠
 = 
NULL
;

1015 
∑øm
->
Êags
 &~
DM_INACTIVE_PRESENT_FLAG
;

1017 
	`up_wrôe
(&
_hash_lock
);

1020 i‡(
√w_m≠
) {

1022 i‡(
∑øm
->
Êags
 & 
DM_SKIP_LOCKFS_FLAG
)

1023 
su•íd_Êags
 &~
DM_SUSPEND_LOCKFS_FLAG
;

1024 i‡(
∑øm
->
Êags
 & 
DM_NOFLUSH_FLAG
)

1025 
su•íd_Êags
 |
DM_SUSPEND_NOFLUSH_FLAG
;

1026 i‡(!
	`dm_su•íded_md
(
md
))

1027 
	`dm_su•íd
(
md
, 
su•íd_Êags
);

1029 
ﬁd_m≠
 = 
	`dm_sw≠_èbÀ
(
md
, 
√w_m≠
);

1030 i‡(
	`IS_ERR
(
ﬁd_m≠
)) {

1031 
	`dm_sync_èbÀ
(
md
);

1032 
	`dm_èbÀ_de°roy
(
√w_m≠
);

1033 
	`dm_put
(
md
);

1034  
	`PTR_ERR
(
ﬁd_m≠
);

1037 i‡(
	`dm_èbÀ_gë_mode
(
√w_m≠
Ë& 
FMODE_WRITE
)

1038 
	`£t_disk_ro
(
	`dm_disk
(
md
), 0);

1040 
	`£t_disk_ro
(
	`dm_disk
(
md
), 1);

1043 i‡(
	`dm_su•íded_md
(
md
)) {

1044 
r
 = 
	`dm_ªsume
(
md
);

1045 i‡(!
r
 && !
	`dm_kobje˘_uevít
(
md
, 
KOBJ_CHANGE
, 
∑øm
->
evít_ƒ
))

1046 
∑øm
->
Êags
 |
DM_UEVENT_GENERATED_FLAG
;

1053 i‡(
ﬁd_m≠
)

1054 
	`dm_èbÀ_de°roy
(
ﬁd_m≠
);

1056 i‡(!
r
)

1057 
	`__dev_°©us
(
md
, 
∑øm
);

1059 
	`dm_put
(
md
);

1060  
r
;

1061 
	}
}

1067 
	$dev_su•íd
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1069 i‡(
∑øm
->
Êags
 & 
DM_SUSPEND_FLAG
)

1070  
	`do_su•íd
(
∑øm
);

1072  
	`do_ªsume
(
∑øm
);

1073 
	}
}

1079 
	$dev_°©us
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1081 
m≠≥d_devi˚
 *
md
;

1083 
md
 = 
	`föd_devi˚
(
∑øm
);

1084 i‡(!
md
)

1085  -
ENXIO
;

1087 
	`__dev_°©us
(
md
, 
∑øm
);

1088 
	`dm_put
(
md
);

1091 
	}
}

1096 
	$ªåõve_°©us
(
dm_èbÀ
 *
èbÀ
,

1097 
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1099 
i
, 
num_èrgës
;

1100 
dm_èrgë_•ec
 *
•ec
;

1101 *
outbuf
, *
ouçå
;

1102 
°©us_ty≥_t
 
ty≥
;

1103 
size_t
 
ªmaöög
, 
Àn
, 
u£d
 = 0;

1104 
°©us_Êags
 = 0;

1106 
ouçå
 = 
outbuf
 = 
	`gë_ªsu…_buf„r
(
∑øm
, 
∑øm_size
, &
Àn
);

1108 i‡(
∑øm
->
Êags
 & 
DM_STATUS_TABLE_FLAG
)

1109 
ty≥
 = 
STATUSTYPE_TABLE
;

1111 
ty≥
 = 
STATUSTYPE_INFO
;

1114 
num_èrgës
 = 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
);

1115 
i
 = 0; i < 
num_èrgës
; i++) {

1116 
dm_èrgë
 *
ti
 = 
	`dm_èbÀ_gë_èrgë
(
èbÀ
, 
i
);

1117 
size_t
 
l
;

1119 
ªmaöög
 = 
Àn
 - (
ouçå
 - 
outbuf
);

1120 i‡(
ªmaöög
 <(
dm_èrgë_•ec
)) {

1121 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

1125 
•ec
 = (
dm_èrgë_•ec
 *Ë
ouçå
;

1127 
•ec
->
°©us
 = 0;

1128 
•ec
->
£˘‹_°¨t
 = 
ti
->
begö
;

1129 
•ec
->
Àngth
 = 
ti
->
Àn
;

1130 
	`°∫˝y
(
•ec
->
èrgë_ty≥
, 
ti
->
ty≥
->
«me
,

1131 (
•ec
->
èrgë_ty≥
));

1133 
ouçå
 +(
dm_èrgë_•ec
);

1134 
ªmaöög
 = 
Àn
 - (
ouçå
 - 
outbuf
);

1135 i‡(
ªmaöög
 <= 0) {

1136 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

1141 i‡(
ti
->
ty≥
->
°©us
) {

1142 i‡(
∑øm
->
Êags
 & 
DM_NOFLUSH_FLAG
)

1143 
°©us_Êags
 |
DM_STATUS_NOFLUSH_FLAG
;

1144 
ti
->
ty≥
->
	`°©us
—i,Åy≥, 
°©us_Êags
, 
ouçå
, 
ªmaöög
);

1146 
ouçå
[0] = '\0';

1148 
l
 = 
	`°æí
(
ouçå
) + 1;

1149 i‡(
l
 =
ªmaöög
) {

1150 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

1154 
ouçå
 +
l
;

1155 
u£d
 = 
∑øm
->
d©a_°¨t
 + (
ouçå
 - 
outbuf
);

1157 
ouçå
 = 
	`Æign_±r
(outptr);

1158 
•ec
->
√xt
 = 
ouçå
 - 
outbuf
;

1161 i‡(
u£d
)

1162 
∑øm
->
d©a_size
 = 
u£d
;

1164 
∑øm
->
èrgë_cou¡
 = 
num_èrgës
;

1165 
	}
}

1170 
	$dev_waô
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1172 
r
 = 0;

1173 
m≠≥d_devi˚
 *
md
;

1174 
dm_èbÀ
 *
èbÀ
;

1175 
§cu_idx
;

1177 
md
 = 
	`föd_devi˚
(
∑øm
);

1178 i‡(!
md
)

1179  -
ENXIO
;

1184 i‡(
	`dm_waô_evít
(
md
, 
∑øm
->
evít_ƒ
)) {

1185 
r
 = -
ERESTARTSYS
;

1186 
out
;

1194 
	`__dev_°©us
(
md
, 
∑øm
);

1196 
èbÀ
 = 
	`dm_gë_live_‹_öa˘ive_èbÀ
(
md
, 
∑øm
, &
§cu_idx
);

1197 i‡(
èbÀ
)

1198 
	`ªåõve_°©us
(
èbÀ
, 
∑øm
, 
∑øm_size
);

1199 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1201 
out
:

1202 
	`dm_put
(
md
);

1204  
r
;

1205 
	}
}

1207 
ölöe
 
fmode_t
 
	$gë_mode
(
dm_io˘l
 *
∑øm
)

1209 
fmode_t
 
mode
 = 
FMODE_READ
 | 
FMODE_WRITE
;

1211 i‡(
∑øm
->
Êags
 & 
DM_READONLY_FLAG
)

1212 
mode
 = 
FMODE_READ
;

1214  
mode
;

1215 
	}
}

1217 
	$√xt_èrgë
(
dm_èrgë_•ec
 *
œ°
, 
uöt32_t
 
√xt
, *
íd
,

1218 
dm_èrgë_•ec
 **
•ec
, **
èrgë_∑øms
)

1220 *
•ec
 = (
dm_èrgë_•ec
 *Ë((*Ë
œ°
 + 
√xt
);

1221 *
èrgë_∑øms
 = (*Ë(*
•ec
 + 1);

1223 i‡(*
•ec
 < (
œ°
 + 1))

1224  -
EINVAL
;

1226  
	`övÆid_°r
(*
èrgë_∑øms
, 
íd
);

1227 
	}
}

1229 
	$p›uœã_èbÀ
(
dm_èbÀ
 *
èbÀ
,

1230 
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1232 
r
;

1233 
i
 = 0;

1234 
dm_èrgë_•ec
 *
•ec
 = (dm_èrgë_•e¯*Ë
∑øm
;

1235 
uöt32_t
 
√xt
 = 
∑øm
->
d©a_°¨t
;

1236 *
íd
 = (*Ë
∑øm
 + 
∑øm_size
;

1237 *
èrgë_∑øms
;

1239 i‡(!
∑øm
->
èrgë_cou¡
) {

1240 
	`DMWARN
("populate_table:ÇoÅargets specified");

1241  -
EINVAL
;

1244 
i
 = 0; i < 
∑øm
->
èrgë_cou¡
; i++) {

1246 
r
 = 
	`√xt_èrgë
(
•ec
, 
√xt
, 
íd
, &•ec, &
èrgë_∑øms
);

1247 i‡(
r
) {

1248 
	`DMWARN
("unableÅo findÅarget");

1249  
r
;

1252 
r
 = 
	`dm_èbÀ_add_èrgë
(
èbÀ
, 
•ec
->
èrgë_ty≥
,

1253 (
£˘‹_t
Ë
•ec
->
£˘‹_°¨t
,

1254 (
£˘‹_t
Ë
•ec
->
Àngth
,

1255 
èrgë_∑øms
);

1256 i‡(
r
) {

1257 
	`DMWARN
("erroráddingÅargetÅoÅable");

1258  
r
;

1261 
√xt
 = 
•ec
->next;

1264  
	`dm_èbÀ_com∂ëe
(
èbÀ
);

1265 
	}
}

1267 
	$èbÀ_lﬂd
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1269 
r
;

1270 
hash_˚Œ
 *
hc
;

1271 
dm_èbÀ
 *
t
, *
ﬁd_m≠
 = 
NULL
;

1272 
m≠≥d_devi˚
 *
md
;

1273 
èrgë_ty≥
 *
immuèbÀ_èrgë_ty≥
;

1275 
md
 = 
	`föd_devi˚
(
∑øm
);

1276 i‡(!
md
)

1277  -
ENXIO
;

1279 
r
 = 
	`dm_èbÀ_¸óã
(&
t
, 
	`gë_mode
(
∑øm
),Ö¨am->
èrgë_cou¡
, 
md
);

1280 i‡(
r
)

1281 
îr
;

1284 
	`dm_lock_md_ty≥
(
md
);

1285 
r
 = 
	`p›uœã_èbÀ
(
t
, 
∑øm
, 
∑øm_size
);

1286 i‡(
r
)

1287 
îr_u∆ock_md_ty≥
;

1289 
immuèbÀ_èrgë_ty≥
 = 
	`dm_gë_immuèbÀ_èrgë_ty≥
(
md
);

1290 i‡(
immuèbÀ_èrgë_ty≥
 &&

1291 (
immuèbÀ_èrgë_ty≥
 !
	`dm_èbÀ_gë_immuèbÀ_èrgë_ty≥
(
t
))) {

1292 
	`DMWARN
("can'tÑeplace immutableÅargetÅype %s",

1293 
immuèbÀ_èrgë_ty≥
->
«me
);

1294 
r
 = -
EINVAL
;

1295 
îr_u∆ock_md_ty≥
;

1298 i‡(
	`dm_gë_md_ty≥
(
md
Ë=
DM_TYPE_NONE
)

1300 
	`dm_£t_md_ty≥
(
md
, 
	`dm_èbÀ_gë_ty≥
(
t
));

1301 i‡(
	`dm_gë_md_ty≥
(
md
Ë!
	`dm_èbÀ_gë_ty≥
(
t
)) {

1302 
	`DMWARN
("can't change deviceÅypeáfter initialÅableÜoad.");

1303 
r
 = -
EINVAL
;

1304 
îr_u∆ock_md_ty≥
;

1308 
r
 = 
	`dm_£tup_md_queue
(
md
);

1309 i‡(
r
) {

1310 
	`DMWARN
("unableÅo set up device queue forÇewÅable.");

1311 
îr_u∆ock_md_ty≥
;

1313 
	`dm_u∆ock_md_ty≥
(
md
);

1316 
	`down_wrôe
(&
_hash_lock
);

1317 
hc
 = 
	`dm_gë_md±r
(
md
);

1318 i‡(!
hc
 || hc->
md
 != md) {

1319 
	`DMWARN
("device has beenÑemoved fromÅhe dev hashÅable.");

1320 
	`up_wrôe
(&
_hash_lock
);

1321 
r
 = -
ENXIO
;

1322 
îr_de°roy_èbÀ
;

1325 i‡(
hc
->
√w_m≠
)

1326 
ﬁd_m≠
 = 
hc
->
√w_m≠
;

1327 
hc
->
√w_m≠
 = 
t
;

1328 
	`up_wrôe
(&
_hash_lock
);

1330 
∑øm
->
Êags
 |
DM_INACTIVE_PRESENT_FLAG
;

1331 
	`__dev_°©us
(
md
, 
∑øm
);

1333 i‡(
ﬁd_m≠
) {

1334 
	`dm_sync_èbÀ
(
md
);

1335 
	`dm_èbÀ_de°roy
(
ﬁd_m≠
);

1338 
	`dm_put
(
md
);

1342 
îr_u∆ock_md_ty≥
:

1343 
	`dm_u∆ock_md_ty≥
(
md
);

1344 
îr_de°roy_èbÀ
:

1345 
	`dm_èbÀ_de°roy
(
t
);

1346 
îr
:

1347 
	`dm_put
(
md
);

1349  
r
;

1350 
	}
}

1352 
	$èbÀ_˛ór
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1354 
hash_˚Œ
 *
hc
;

1355 
m≠≥d_devi˚
 *
md
;

1356 
dm_èbÀ
 *
ﬁd_m≠
 = 
NULL
;

1358 
	`down_wrôe
(&
_hash_lock
);

1360 
hc
 = 
	`__föd_devi˚_hash_˚Œ
(
∑øm
);

1361 i‡(!
hc
) {

1362 
	`DMDEBUG_LIMIT
("device doesn'táppearÅo be inÅhe dev hashÅable.");

1363 
	`up_wrôe
(&
_hash_lock
);

1364  -
ENXIO
;

1367 i‡(
hc
->
√w_m≠
) {

1368 
ﬁd_m≠
 = 
hc
->
√w_m≠
;

1369 
hc
->
√w_m≠
 = 
NULL
;

1372 
∑øm
->
Êags
 &~
DM_INACTIVE_PRESENT_FLAG
;

1374 
	`__dev_°©us
(
hc
->
md
, 
∑øm
);

1375 
md
 = 
hc
->md;

1376 
	`up_wrôe
(&
_hash_lock
);

1377 i‡(
ﬁd_m≠
) {

1378 
	`dm_sync_èbÀ
(
md
);

1379 
	`dm_èbÀ_de°roy
(
ﬁd_m≠
);

1381 
	`dm_put
(
md
);

1384 
	}
}

1389 
	$ªåõve_dïs
(
dm_èbÀ
 *
èbÀ
,

1390 
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1392 
cou¡
 = 0;

1393 
li°_hód
 *
tmp
;

1394 
size_t
 
Àn
, 
√eded
;

1395 
dm_dev_öã∫Æ
 *
dd
;

1396 
dm_èrgë_dïs
 *
dïs
;

1398 
dïs
 = 
	`gë_ªsu…_buf„r
(
∑øm
, 
∑øm_size
, &
Àn
);

1403 
	`li°_f‹_óch
 (
tmp
, 
	`dm_èbÀ_gë_devi˚s
(
èbÀ
))

1404 
cou¡
++;

1409 
√eded
 = (*
dïs
Ë+ ((*dïs->
dev
Ë* 
cou¡
);

1410 i‡(
Àn
 < 
√eded
) {

1411 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

1418 
dïs
->
cou¡
 = count;

1419 
cou¡
 = 0;

1420 
	`li°_f‹_óch_íåy
 (
dd
, 
	`dm_èbÀ_gë_devi˚s
(
èbÀ
), 
li°
)

1421 
dïs
->
dev
[
cou¡
++] = 
	`huge_ícode_dev
(
dd
->
dm_dev
->
bdev
->
bd_dev
);

1423 
∑øm
->
d©a_size
 =Ö¨am->
d©a_°¨t
 + 
√eded
;

1424 
	}
}

1426 
	$èbÀ_dïs
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1428 
m≠≥d_devi˚
 *
md
;

1429 
dm_èbÀ
 *
èbÀ
;

1430 
§cu_idx
;

1432 
md
 = 
	`föd_devi˚
(
∑øm
);

1433 i‡(!
md
)

1434  -
ENXIO
;

1436 
	`__dev_°©us
(
md
, 
∑øm
);

1438 
èbÀ
 = 
	`dm_gë_live_‹_öa˘ive_èbÀ
(
md
, 
∑øm
, &
§cu_idx
);

1439 i‡(
èbÀ
)

1440 
	`ªåõve_dïs
(
èbÀ
, 
∑øm
, 
∑øm_size
);

1441 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1443 
	`dm_put
(
md
);

1446 
	}
}

1452 
	$èbÀ_°©us
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1454 
m≠≥d_devi˚
 *
md
;

1455 
dm_èbÀ
 *
èbÀ
;

1456 
§cu_idx
;

1458 
md
 = 
	`föd_devi˚
(
∑øm
);

1459 i‡(!
md
)

1460  -
ENXIO
;

1462 
	`__dev_°©us
(
md
, 
∑øm
);

1464 
èbÀ
 = 
	`dm_gë_live_‹_öa˘ive_èbÀ
(
md
, 
∑øm
, &
§cu_idx
);

1465 i‡(
èbÀ
)

1466 
	`ªåõve_°©us
(
èbÀ
, 
∑øm
, 
∑øm_size
);

1467 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1469 
	`dm_put
(
md
);

1472 
	}
}

1480 
	$mesßge_f‹_md
(
m≠≥d_devi˚
 *
md
, 
¨gc
, **
¨gv
,

1481 *
ªsu…
, 
maxÀn
)

1483 
r
;

1485 i‡(**
¨gv
 != '@')

1488 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@cancel_deferred_remove")) {

1489 i‡(
¨gc
 != 1) {

1490 
	`DMERR
("Invalidárguments for @cancel_deferred_remove");

1491  -
EINVAL
;

1493  
	`dm_ˇn˚l_de„ºed_ªmove
(
md
);

1496 
r
 = 
	`dm_°©s_mesßge
(
md
, 
¨gc
, 
¨gv
, 
ªsu…
, 
maxÀn
);

1497 i‡(
r
 < 2)

1498  
r
;

1500 
	`DMERR
("Unsuµ‹ãd mesßgê£¡ÅÿDM c‹e: %s", 
¨gv
[0]);

1501  -
EINVAL
;

1502 
	}
}

1507 
	$èrgë_mesßge
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
)

1509 
r
, 
¨gc
;

1510 **
¨gv
;

1511 
m≠≥d_devi˚
 *
md
;

1512 
dm_èbÀ
 *
èbÀ
;

1513 
dm_èrgë
 *
ti
;

1514 
dm_èrgë_msg
 *
tmsg
 = (*Ë
∑øm
 +Ö¨am->
d©a_°¨t
;

1515 
size_t
 
maxÀn
;

1516 *
ªsu…
 = 
	`gë_ªsu…_buf„r
(
∑øm
, 
∑øm_size
, &
maxÀn
);

1517 
§cu_idx
;

1519 
md
 = 
	`föd_devi˚
(
∑øm
);

1520 i‡(!
md
)

1521  -
ENXIO
;

1523 i‡(
tmsg
 < (
dm_èrgë_msg
 *Ë
∑øm
->
d©a
 ||

1524 
	`övÆid_°r
(
tmsg
->
mesßge
, (*Ë
∑øm
 + 
∑øm_size
)) {

1525 
	`DMWARN
("InvalidÅarget messageÖarameters.");

1526 
r
 = -
EINVAL
;

1527 
out
;

1530 
r
 = 
	`dm_•lô_¨gs
(&
¨gc
, &
¨gv
, 
tmsg
->
mesßge
);

1531 i‡(
r
) {

1532 
	`DMWARN
("FailedÅo splitÅarget messageÖarameters");

1533 
out
;

1536 i‡(!
¨gc
) {

1537 
	`DMWARN
("Empty messageÑeceived.");

1538 
out_¨gv
;

1541 
r
 = 
	`mesßge_f‹_md
(
md
, 
¨gc
, 
¨gv
, 
ªsu…
, 
maxÀn
);

1542 i‡(
r
 <= 1)

1543 
out_¨gv
;

1545 
èbÀ
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

1546 i‡(!
èbÀ
)

1547 
out_èbÀ
;

1549 i‡(
	`dm_dñëög_md
(
md
)) {

1550 
r
 = -
ENXIO
;

1551 
out_èbÀ
;

1554 
ti
 = 
	`dm_èbÀ_föd_èrgë
(
èbÀ
, 
tmsg
->
£˘‹
);

1555 i‡(!
	`dm_èrgë_is_vÆid
(
ti
)) {

1556 
	`DMWARN
("Target message sector outside device.");

1557 
r
 = -
EINVAL
;

1558 } i‡(
ti
->
ty≥
->
mesßge
)

1559 
r
 = 
ti
->
ty≥
->
	`mesßge
—i, 
¨gc
, 
¨gv
);

1561 
	`DMWARN
("TargetÅype doesÇot support messages");

1562 
r
 = -
EINVAL
;

1565 
out_èbÀ
:

1566 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1567 
out_¨gv
:

1568 
	`k‰ì
(
¨gv
);

1569 
out
:

1570 i‡(
r
 >= 0)

1571 
	`__dev_°©us
(
md
, 
∑øm
);

1573 i‡(
r
 == 1) {

1574 
∑øm
->
Êags
 |
DM_DATA_OUT_FLAG
;

1575 i‡(
	`dm_mesßge_ã°_buf„r_ovîÊow
(
ªsu…
, 
maxÀn
))

1576 
∑øm
->
Êags
 |
DM_BUFFER_FULL_FLAG
;

1578 
∑øm
->
d©a_size
 =Ö¨am->
d©a_°¨t
 + 
	`°æí
(
ªsu…
) + 1;

1579 
r
 = 0;

1582 
	`dm_put
(
md
);

1583  
r
;

1584 
	}
}

1592 
	#IOCTL_FLAGS_NO_PARAMS
 1

	)

1598 
io˘l_‚
 
	$lookup_io˘l
(
cmd
, *
io˘l_Êags
)

1601 
cmd
;

1602 
Êags
;

1603 
io˘l_‚
 
‚
;

1604 } 
_io˘ls
[] = {

1605 {
DM_VERSION_CMD
, 0, 
NULL
},

1606 {
DM_REMOVE_ALL_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
ªmove_Æl
},

1607 {
DM_LIST_DEVICES_CMD
, 0, 
li°_devi˚s
},

1609 {
DM_DEV_CREATE_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
dev_¸óã
},

1610 {
DM_DEV_REMOVE_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
dev_ªmove
},

1611 {
DM_DEV_RENAME_CMD
, 0, 
dev_ª«me
},

1612 {
DM_DEV_SUSPEND_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
dev_su•íd
},

1613 {
DM_DEV_STATUS_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
dev_°©us
},

1614 {
DM_DEV_WAIT_CMD
, 0, 
dev_waô
},

1616 {
DM_TABLE_LOAD_CMD
, 0, 
èbÀ_lﬂd
},

1617 {
DM_TABLE_CLEAR_CMD
, 
IOCTL_FLAGS_NO_PARAMS
, 
èbÀ_˛ór
},

1618 {
DM_TABLE_DEPS_CMD
, 0, 
èbÀ_dïs
},

1619 {
DM_TABLE_STATUS_CMD
, 0, 
èbÀ_°©us
},

1621 {
DM_LIST_VERSIONS_CMD
, 0, 
li°_vîsi⁄s
},

1623 {
DM_TARGET_MSG_CMD
, 0, 
èrgë_mesßge
},

1624 {
DM_DEV_SET_GEOMETRY_CMD
, 0, 
dev_£t_geomëry
}

1627 i‡(
	`u∆ikñy
(
cmd
 >
	`ARRAY_SIZE
(
_io˘ls
)))

1628  
NULL
;

1630 *
io˘l_Êags
 = 
_io˘ls
[
cmd
].
Êags
;

1631  
_io˘ls
[
cmd
].
‚
;

1632 
	}
}

1638 
	$check_vîsi⁄
(
cmd
, 
dm_io˘l
 
__u£r
 *
u£r
)

1640 
uöt32_t
 
vîsi⁄
[3];

1641 
r
 = 0;

1643 i‡(
	`c›y_‰om_u£r
(
vîsi⁄
, 
u£r
->version, (version)))

1644  -
EFAULT
;

1646 i‡((
DM_VERSION_MAJOR
 !
vîsi⁄
[0]) ||

1647 (
DM_VERSION_MINOR
 < 
vîsi⁄
[1])) {

1648 
	`DMWARN
("ioctl interface mismatch: "

1650 
DM_VERSION_MAJOR
, 
DM_VERSION_MINOR
,

1651 
DM_VERSION_PATCHLEVEL
,

1652 
vîsi⁄
[0], vîsi⁄[1], vîsi⁄[2], 
cmd
);

1653 
r
 = -
EINVAL
;

1659 
vîsi⁄
[0] = 
DM_VERSION_MAJOR
;

1660 
vîsi⁄
[1] = 
DM_VERSION_MINOR
;

1661 
vîsi⁄
[2] = 
DM_VERSION_PATCHLEVEL
;

1662 i‡(
	`c›y_to_u£r
(
u£r
->
vîsi⁄
, version, (version)))

1663  -
EFAULT
;

1665  
r
;

1666 
	}
}

1668 
	#DM_PARAMS_KMALLOC
 0x0001

	)

1669 
	#DM_PARAMS_VMALLOC
 0x0002

	)

1670 
	#DM_WIPE_BUFFER
 0x0010

	)

1672 
	$‰ì_∑øms
(
dm_io˘l
 *
∑øm
, 
size_t
 
∑øm_size
, 
∑øm_Êags
)

1674 i‡(
∑øm_Êags
 & 
DM_WIPE_BUFFER
)

1675 
	`mem£t
(
∑øm
, 0, 
∑øm_size
);

1677 i‡(
∑øm_Êags
 & 
DM_PARAMS_KMALLOC
)

1678 
	`k‰ì
(
∑øm
);

1679 i‡(
∑øm_Êags
 & 
DM_PARAMS_VMALLOC
)

1680 
	`v‰ì
(
∑øm
);

1681 
	}
}

1683 
	$c›y_∑øms
(
dm_io˘l
 
__u£r
 *
u£r
, dm_io˘»*
∑øm_kî√l
,

1684 
io˘l_Êags
,

1685 
dm_io˘l
 **
∑øm
, *
∑øm_Êags
)

1687 
dm_io˘l
 *
dmi
;

1688 
£cuª_d©a
;

1689 c⁄° 
size_t
 
möimum_d©a_size
 = (*
∑øm_kî√l
Ë- ’¨am_kî√l->
d©a
);

1691 i‡(
	`c›y_‰om_u£r
(
∑øm_kî√l
, 
u£r
, 
möimum_d©a_size
))

1692  -
EFAULT
;

1694 i‡(
∑øm_kî√l
->
d©a_size
 < 
möimum_d©a_size
)

1695  -
EINVAL
;

1697 
£cuª_d©a
 = 
∑øm_kî√l
->
Êags
 & 
DM_SECURE_DATA_FLAG
;

1699 *
∑øm_Êags
 = 
£cuª_d©a
 ? 
DM_WIPE_BUFFER
 : 0;

1701 i‡(
io˘l_Êags
 & 
IOCTL_FLAGS_NO_PARAMS
) {

1702 
dmi
 = 
∑øm_kî√l
;

1703 
dmi
->
d©a_size
 = 
möimum_d©a_size
;

1704 
d©a_c›õd
;

1711 
dmi
 = 
NULL
;

1712 i‡(
∑øm_kî√l
->
d©a_size
 <
KMALLOC_MAX_SIZE
) {

1713 
dmi
 = 
	`kmÆloc
(
∑øm_kî√l
->
d©a_size
, 
GFP_NOIO
 | 
__GFP_NORETRY
 | 
__GFP_NOMEMALLOC
 | 
__GFP_NOWARN
);

1714 i‡(
dmi
)

1715 *
∑øm_Êags
 |
DM_PARAMS_KMALLOC
;

1718 i‡(!
dmi
) {

1719 
noio_Êag
;

1720 
noio_Êag
 = 
	`memÆloc_noio_ßve
();

1721 
dmi
 = 
	`__vmÆloc
(
∑øm_kî√l
->
d©a_size
, 
GFP_NOIO
 | 
__GFP_REPEAT
 | 
__GFP_HIGH
 | 
__GFP_HIGHMEM
, 
PAGE_KERNEL
);

1722 
	`memÆloc_noio_ª°‹e
(
noio_Êag
);

1723 i‡(
dmi
)

1724 *
∑øm_Êags
 |
DM_PARAMS_VMALLOC
;

1727 i‡(!
dmi
) {

1728 i‡(
£cuª_d©a
 && 
	`˛ór_u£r
(
u£r
, 
∑øm_kî√l
->
d©a_size
))

1729  -
EFAULT
;

1730  -
ENOMEM
;

1733 i‡(
	`c›y_‰om_u£r
(
dmi
, 
u£r
, 
∑øm_kî√l
->
d©a_size
))

1734 
bad
;

1736 
d©a_c›õd
:

1740 i‡(
dmi
->
d©a_size
 !
∑øm_kî√l
->data_size) {

1741 
	`DMERR
("rejecting ioctl: data size modified whileÖrocessingÖarameters");

1742 
bad
;

1746 i‡(
£cuª_d©a
 && 
	`˛ór_u£r
(
u£r
, 
∑øm_kî√l
->
d©a_size
))

1747 
bad
;

1749 *
∑øm
 = 
dmi
;

1752 
bad
:

1753 
	`‰ì_∑øms
(
dmi
, 
∑øm_kî√l
->
d©a_size
, *
∑øm_Êags
);

1755  -
EFAULT
;

1756 
	}
}

1758 
	$vÆid©e_∑øms
(
uöt
 
cmd
, 
dm_io˘l
 *
∑øm
)

1761 
∑øm
->
Êags
 &~
DM_BUFFER_FULL_FLAG
;

1762 
∑øm
->
Êags
 &~
DM_UEVENT_GENERATED_FLAG
;

1763 
∑øm
->
Êags
 &~
DM_SECURE_DATA_FLAG
;

1764 
∑øm
->
Êags
 &~
DM_DATA_OUT_FLAG
;

1767 i‡(
cmd
 =
DM_REMOVE_ALL_CMD
 ||

1768 
cmd
 =
DM_LIST_DEVICES_CMD
 ||

1769 
cmd
 =
DM_LIST_VERSIONS_CMD
)

1772 i‡((
cmd
 =
DM_DEV_CREATE_CMD
)) {

1773 i‡(!*
∑øm
->
«me
) {

1774 
	`DMWARN
("nameÇot supplied when creating device");

1775  -
EINVAL
;

1777 } i‡((*
∑øm
->
uuid
 && *∑øm->
«me
)) {

1778 
	`DMWARN
("⁄ly suµly o√ o‡«mê‹ uuid, cmd(%u)", 
cmd
);

1779  -
EINVAL
;

1783 
∑øm
->
«me
[
DM_NAME_LEN
 - 1] = '\0';

1784 
∑øm
->
uuid
[
DM_UUID_LEN
 - 1] = '\0';

1787 
	}
}

1789 
	$˘l_io˘l
(
uöt
 
comm™d
, 
dm_io˘l
 
__u£r
 *
u£r
)

1791 
r
 = 0;

1792 
io˘l_Êags
;

1793 
∑øm_Êags
;

1794 
cmd
;

1795 
dm_io˘l
 *
	`unöôülized_v¨
(
∑øm
);

1796 
io˘l_‚
 
‚
 = 
NULL
;

1797 
size_t
 
öput_∑øm_size
;

1798 
dm_io˘l
 
∑øm_kî√l
;

1801 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1802  -
EACCES
;

1804 i‡(
	`_IOC_TYPE
(
comm™d
Ë!
DM_IOCTL
)

1805  -
ENOTTY
;

1807 
cmd
 = 
	`_IOC_NR
(
comm™d
);

1813 
r
 = 
	`check_vîsi⁄
(
cmd
, 
u£r
);

1814 i‡(
r
)

1815  
r
;

1820 i‡(
cmd
 =
DM_VERSION_CMD
)

1823 
‚
 = 
	`lookup_io˘l
(
cmd
, &
io˘l_Êags
);

1824 i‡(!
‚
) {

1825 
	`DMWARN
("dm_˘l_io˘l: unknow¿comm™d 0x%x", 
comm™d
);

1826  -
ENOTTY
;

1832 
r
 = 
	`c›y_∑øms
(
u£r
, &
∑øm_kî√l
, 
io˘l_Êags
, &
∑øm
, &
∑øm_Êags
);

1834 i‡(
r
)

1835  
r
;

1837 
öput_∑øm_size
 = 
∑øm
->
d©a_size
;

1838 
r
 = 
	`vÆid©e_∑øms
(
cmd
, 
∑øm
);

1839 i‡(
r
)

1840 
out
;

1842 
∑øm
->
d©a_size
 = (*param);

1843 
r
 = 
	`‚
(
∑øm
, 
öput_∑øm_size
);

1845 i‡(
	`u∆ikñy
(
∑øm
->
Êags
 & 
DM_BUFFER_FULL_FLAG
) &&

1846 
	`u∆ikñy
(
io˘l_Êags
 & 
IOCTL_FLAGS_NO_PARAMS
))

1847 
	`DMERR
("io˘»%dÅrõdÅÿouçuàsomêd©®buàha†IOCTL_FLAGS_NO_PARAMS së", 
cmd
);

1852 i‡(!
r
 && 
	`c›y_to_u£r
(
u£r
, 
∑øm
,Ö¨am->
d©a_size
))

1853 
r
 = -
EFAULT
;

1855 
out
:

1856 
	`‰ì_∑øms
(
∑øm
, 
öput_∑øm_size
, 
∑øm_Êags
);

1857  
r
;

1858 
	}
}

1860 
	$dm_˘l_io˘l
(
fûe
 *fûe, 
uöt
 
comm™d
, 
ul⁄g
 
u
)

1862  ()
	`˘l_io˘l
(
comm™d
, (
dm_io˘l
 
__u£r
 *)
u
);

1863 
	}
}

1865 #ifde‡
CONFIG_COMPAT


1866 
	$dm_com∑t_˘l_io˘l
(
fûe
 *fûe, 
uöt
 
comm™d
, 
ul⁄g
 
u
)

1868  ()
	`dm_˘l_io˘l
(
fûe
, 
comm™d
, (
ul⁄g
Ë
	`com∑t_±r
(
u
));

1869 
	}
}

1871 
	#dm_com∑t_˘l_io˘l
 
NULL


	)

1874 c⁄° 
fûe_›î©i⁄s
 
	g_˘l_f›s
 = {

1875 .
›í
 = 
n⁄£ekabÀ_›í
,

1876 .
	gu∆ocked_io˘l
 = 
dm_˘l_io˘l
,

1877 .
	gcom∑t_io˘l
 = 
dm_com∑t_˘l_io˘l
,

1878 .
	gow√r
 = 
THIS_MODULE
,

1879 .
	gŒ£ek
 = 
no›_Œ£ek
,

1882 
miscdevi˚
 
	g_dm_misc
 = {

1883 .
mö‹
 = 
MAPPER_CTRL_MINOR
,

1884 .
	g«me
 = 
DM_NAME
,

1885 .
	gnodíame
 = 
DM_DIR
 "/" 
DM_CONTROL_NODE
,

1886 .
	gf›s
 = &
_˘l_f›s


1889 
MODULE_ALIAS_MISCDEV
(
MAPPER_CTRL_MINOR
);

1890 
MODULE_ALIAS
("dev«me:" 
DM_DIR
 "/" 
DM_CONTROL_NODE
);

1895 
__öô
 
	$dm_öãrÁ˚_öô
()

1897 
r
;

1899 
r
 = 
	`dm_hash_öô
();

1900 i‡(
r
)

1901  
r
;

1903 
r
 = 
	`misc_ªgi°î
(&
_dm_misc
);

1904 i‡(
r
) {

1905 
	`DMERR
("misc_register failed for control device");

1906 
	`dm_hash_exô
();

1907  
r
;

1910 
	`DMINFO
("%d.%d.%d%†öôüli£d: %s", 
DM_VERSION_MAJOR
,

1911 
DM_VERSION_MINOR
, 
DM_VERSION_PATCHLEVEL
, 
DM_VERSION_EXTRA
,

1912 
DM_DRIVER_EMAIL
);

1914 
	}
}

1916 
	$dm_öãrÁ˚_exô
()

1918 i‡(
	`misc_dîegi°î
(&
_dm_misc
) < 0)

1919 
	`DMERR
("misc_deregister failed for control device");

1921 
	`dm_hash_exô
();

1922 
	}
}

1930 
	$dm_c›y_«me_™d_uuid
(
m≠≥d_devi˚
 *
md
, *
«me
, *
uuid
)

1932 
r
 = 0;

1933 
hash_˚Œ
 *
hc
;

1935 i‡(!
md
)

1936  -
ENXIO
;

1938 
	`muãx_lock
(&
dm_hash_˚Œs_muãx
);

1939 
hc
 = 
	`dm_gë_md±r
(
md
);

1940 i‡(!
hc
 || hc->
md
 != md) {

1941 
r
 = -
ENXIO
;

1942 
out
;

1945 i‡(
«me
)

1946 
	`°r˝y
(
«me
, 
hc
->name);

1947 i‡(
uuid
)

1948 
	`°r˝y
(
uuid
, 
hc
->uuid ? : "");

1950 
out
:

1951 
	`muãx_u∆ock
(&
dm_hash_˚Œs_muãx
);

1953  
r
;

1954 
	}
}

	@dm-kcopyd.c

12 
	~<löux/ty≥s.h
>

13 
	~<löux/©omic.h
>

14 
	~<löux/blkdev.h
>

15 
	~<löux/fs.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/li°.h
>

18 
	~<löux/mempoﬁ.h
>

19 
	~<löux/moduÀ.h
>

20 
	~<löux/∑gem≠.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/vmÆloc.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/muãx.h
>

25 
	~<löux/dñay.h
>

26 
	~<löux/devi˚-m≠≥r.h
>

27 
	~<löux/dm-kc›yd.h
>

29 
	~"dm.h
"

31 
	#SUB_JOB_SIZE
 128

	)

32 
	#SPLIT_COUNT
 8

	)

33 
	#MIN_JOBS
 8

	)

34 
	#RESERVE_PAGES
 (
	`DIV_ROUND_UP
(
SUB_JOB_SIZE
 << 
SECTOR_SHIFT
, 
PAGE_SIZE
))

	)

40 
	sdm_kc›yd_˛õ¡
 {

41 
∑ge_li°
 *
	m∑ges
;

42 
	mƒ_ª£rved_∑ges
;

43 
	mƒ_‰ì_∑ges
;

45 
dm_io_˛õ¡
 *
	mio_˛õ¡
;

47 
waô_queue_hód_t
 
	mde°royq
;

48 
©omic_t
 
	mƒ_jobs
;

50 
mempoﬁ_t
 *
	mjob_poﬁ
;

52 
w‹kqueue_°ru˘
 *
	mkc›yd_wq
;

53 
w‹k_°ru˘
 
	mkc›yd_w‹k
;

55 
dm_kc›yd_thrŸée
 *
	mthrŸée
;

66 
•ölock_t
 
	mjob_lock
;

67 
li°_hód
 
	mcom∂ëe_jobs
;

68 
li°_hód
 
	mio_jobs
;

69 
li°_hód
 
	m∑ges_jobs
;

72 
∑ge_li°
 
	gzîo_∑ge_li°
;

74 
DEFINE_SPINLOCK
(
thrŸée_•ölock
);

81 
	#ACCOUNT_INTERVAL_SHIFT
 
SHIFT_HZ


	)

91 
	#SLEEP_MSEC
 100

	)

97 
	#MAX_SLEEPS
 10

	)

99 
	$io_job_°¨t
(
dm_kc›yd_thrŸée
 *
t
)

101 
thrŸée
, 
now
, 
dif„ªn˚
;

102 
¶ït
 = 0, 
skew
;

104 i‡(
	`u∆ikñy
(!
t
))

107 
åy_agaö
:

108 
	`•ö_lock_úq
(&
thrŸée_•ölock
);

110 
thrŸée
 = 
	`ACCESS_ONCE
(
t
->throttle);

112 i‡(
	`likñy
(
thrŸée
 >= 100))

113 
skù_limô
;

115 
now
 = 
jiffõs
;

116 
dif„ªn˚
 = 
now
 - 
t
->
œ°_jiffõs
;

117 
t
->
œ°_jiffõs
 = 
now
;

118 i‡(
t
->
num_io_jobs
)

119 
t
->
io_≥riod
 +
dif„ªn˚
;

120 
t
->
tŸÆ_≥riod
 +
dif„ªn˚
;

125 i‡(
	`u∆ikñy
(
t
->
io_≥riod
 >Å->
tŸÆ_≥riod
))

126 
t
->
io_≥riod
 =Å->
tŸÆ_≥riod
;

128 i‡(
	`u∆ikñy
(
t
->
tŸÆ_≥riod
 >(1 << 
ACCOUNT_INTERVAL_SHIFT
))) {

129 
shi·
 = 
	`Ês
(
t
->
tŸÆ_≥riod
 >> 
ACCOUNT_INTERVAL_SHIFT
);

130 
t
->
tŸÆ_≥riod
 >>
shi·
;

131 
t
->
io_≥riod
 >>
shi·
;

134 
skew
 = 
t
->
io_≥riod
 - 
thrŸée
 *Å->
tŸÆ_≥riod
 / 100;

136 i‡(
	`u∆ikñy
(
skew
 > 0Ë&& 
¶ït
 < 
MAX_SLEEPS
) {

137 
¶ït
++;

138 
	`•ö_u∆ock_úq
(&
thrŸée_•ölock
);

139 
	`m¶ìp
(
SLEEP_MSEC
);

140 
åy_agaö
;

143 
skù_limô
:

144 
t
->
num_io_jobs
++;

146 
	`•ö_u∆ock_úq
(&
thrŸée_•ölock
);

147 
	}
}

149 
	$io_job_föish
(
dm_kc›yd_thrŸée
 *
t
)

151 
Êags
;

153 i‡(
	`u∆ikñy
(!
t
))

156 
	`•ö_lock_úqßve
(&
thrŸée_•ölock
, 
Êags
);

158 
t
->
num_io_jobs
--;

160 i‡(
	`likñy
(
	`ACCESS_ONCE
(
t
->
thrŸée
) >= 100))

161 
skù_limô
;

163 i‡(!
t
->
num_io_jobs
) {

164 
now
, 
dif„ªn˚
;

166 
now
 = 
jiffõs
;

167 
dif„ªn˚
 = 
now
 - 
t
->
œ°_jiffõs
;

168 
t
->
œ°_jiffõs
 = 
now
;

170 
t
->
io_≥riod
 +
dif„ªn˚
;

171 
t
->
tŸÆ_≥riod
 +
dif„ªn˚
;

176 i‡(
	`u∆ikñy
(
t
->
io_≥riod
 >Å->
tŸÆ_≥riod
))

177 
t
->
io_≥riod
 =Å->
tŸÆ_≥riod
;

180 
skù_limô
:

181 
	`•ö_u∆ock_úqª°‹e
(&
thrŸée_•ölock
, 
Êags
);

182 
	}
}

185 
	$wake
(
dm_kc›yd_˛õ¡
 *
kc
)

187 
	`queue_w‹k
(
kc
->
kc›yd_wq
, &kc->
kc›yd_w‹k
);

188 
	}
}

193 
∑ge_li°
 *
	$Æloc_∂
(
gÂ_t
 
gÂ
)

195 
∑ge_li°
 *
∂
;

197 
∂
 = 
	`kmÆloc
((*∂), 
gÂ
);

198 i‡(!
∂
)

199  
NULL
;

201 
∂
->
∑ge
 = 
	`Æloc_∑ge
(
gÂ
);

202 i‡(!
∂
->
∑ge
) {

203 
	`k‰ì
(
∂
);

204  
NULL
;

207  
∂
;

208 
	}
}

210 
	$‰ì_∂
(
∑ge_li°
 *
∂
)

212 
	`__‰ì_∑ge
(
∂
->
∑ge
);

213 
	`k‰ì
(
∂
);

214 
	}
}

220 
	$kc›yd_put_∑ges
(
dm_kc›yd_˛õ¡
 *
kc
, 
∑ge_li°
 *
∂
)

222 
∑ge_li°
 *
√xt
;

225 
√xt
 = 
∂
->next;

227 i‡(
kc
->
ƒ_‰ì_∑ges
 >kc->
ƒ_ª£rved_∑ges
)

228 
	`‰ì_∂
(
∂
);

230 
∂
->
√xt
 = 
kc
->
∑ges
;

231 
kc
->
∑ges
 = 
∂
;

232 
kc
->
ƒ_‰ì_∑ges
++;

235 
∂
 = 
√xt
;

236 } 
∂
);

237 
	}
}

239 
	$kc›yd_gë_∑ges
(
dm_kc›yd_˛õ¡
 *
kc
,

240 
ƒ
, 
∑ge_li°
 **
∑ges
)

242 
∑ge_li°
 *
∂
;

244 *
∑ges
 = 
NULL
;

247 
∂
 = 
	`Æloc_∂
(
__GFP_NOWARN
 | 
__GFP_NORETRY
);

248 i‡(
	`u∆ikñy
(!
∂
)) {

250 
∂
 = 
kc
->
∑ges
;

251 i‡(
	`u∆ikñy
(!
∂
))

252 
out_of_mem‹y
;

253 
kc
->
∑ges
 = 
∂
->
√xt
;

254 
kc
->
ƒ_‰ì_∑ges
--;

256 
∂
->
√xt
 = *
∑ges
;

257 *
∑ges
 = 
∂
;

258 } --
ƒ
);

262 
out_of_mem‹y
:

263 i‡(*
∑ges
)

264 
	`kc›yd_put_∑ges
(
kc
, *
∑ges
);

265  -
ENOMEM
;

266 
	}
}

271 
	$dr›_∑ges
(
∑ge_li°
 *
∂
)

273 
∑ge_li°
 *
√xt
;

275 
∂
) {

276 
√xt
 = 
∂
->next;

277 
	`‰ì_∂
(
∂
);

278 
∂
 = 
√xt
;

280 
	}
}

285 
	$˛õ¡_ª£rve_∑ges
(
dm_kc›yd_˛õ¡
 *
kc
, 
ƒ_∑ges
)

287 
i
;

288 
∑ge_li°
 *
∂
 = 
NULL
, *
√xt
;

290 
i
 = 0; i < 
ƒ_∑ges
; i++) {

291 
√xt
 = 
	`Æloc_∂
(
GFP_KERNEL
);

292 i‡(!
√xt
) {

293 i‡(
∂
)

294 
	`dr›_∑ges
(
∂
);

295  -
ENOMEM
;

297 
√xt
->√xà
∂
;

298 
∂
 = 
√xt
;

301 
kc
->
ƒ_ª£rved_∑ges
 +
ƒ_∑ges
;

302 
	`kc›yd_put_∑ges
(
kc
, 
∂
);

305 
	}
}

307 
	$˛õ¡_‰ì_∑ges
(
dm_kc›yd_˛õ¡
 *
kc
)

309 
	`BUG_ON
(
kc
->
ƒ_‰ì_∑ges
 !kc->
ƒ_ª£rved_∑ges
);

310 
	`dr›_∑ges
(
kc
->
∑ges
);

311 
kc
->
∑ges
 = 
NULL
;

312 
kc
->
ƒ_‰ì_∑ges
 = kc->
ƒ_ª£rved_∑ges
 = 0;

313 
	}
}

320 
	skc›yd_job
 {

321 
dm_kc›yd_˛õ¡
 *
	mkc
;

322 
li°_hód
 
	mli°
;

323 
	mÊags
;

328 
	mªad_îr
;

329 
	mwrôe_îr
;

334 
	mrw
;

335 
dm_io_ªgi⁄
 
	msour˚
;

340 
	mnum_de°s
;

341 
dm_io_ªgi⁄
 
	mde°s
[
DM_KCOPYD_MAX_REGIONS
];

343 
∑ge_li°
 *
	m∑ges
;

349 
dm_kc›yd_nŸify_‚
 
	m‚
;

350 *
	mc⁄ãxt
;

356 
muãx
 
	mlock
;

357 
©omic_t
 
	msub_jobs
;

358 
£˘‹_t
 
	m¥ogªss
;

360 
kc›yd_job
 *
	mma°î_job
;

363 
kmem_ˇche
 *
	g_job_ˇche
;

365 
__öô
 
	$dm_kc›yd_öô
()

367 
_job_ˇche
 = 
	`kmem_ˇche_¸óã
("kcopyd_job",

368 (
kc›yd_job
Ë* (
SPLIT_COUNT
 + 1),

369 
	`__Æignof__
(
kc›yd_job
), 0, 
NULL
);

370 i‡(!
_job_ˇche
)

371  -
ENOMEM
;

373 
zîo_∑ge_li°
.
√xt
 = &zero_page_list;

374 
zîo_∑ge_li°
.
∑ge
 = 
	`ZERO_PAGE
(0);

377 
	}
}

379 
	$dm_kc›yd_exô
()

381 
	`kmem_ˇche_de°roy
(
_job_ˇche
);

382 
_job_ˇche
 = 
NULL
;

383 
	}
}

389 
kc›yd_job
 *
	$p›
(
li°_hód
 *
jobs
,

390 
dm_kc›yd_˛õ¡
 *
kc
)

392 
kc›yd_job
 *
job
 = 
NULL
;

393 
Êags
;

395 
	`•ö_lock_úqßve
(&
kc
->
job_lock
, 
Êags
);

397 i‡(!
	`li°_em±y
(
jobs
)) {

398 
job
 = 
	`li°_íåy
(
jobs
->
√xt
, 
kc›yd_job
, 
li°
);

399 
	`li°_dñ
(&
job
->
li°
);

401 
	`•ö_u∆ock_úqª°‹e
(&
kc
->
job_lock
, 
Êags
);

403  
job
;

404 
	}
}

406 
	$push
(
li°_hód
 *
jobs
, 
kc›yd_job
 *
job
)

408 
Êags
;

409 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

411 
	`•ö_lock_úqßve
(&
kc
->
job_lock
, 
Êags
);

412 
	`li°_add_èû
(&
job
->
li°
, 
jobs
);

413 
	`•ö_u∆ock_úqª°‹e
(&
kc
->
job_lock
, 
Êags
);

414 
	}
}

417 
	$push_hód
(
li°_hód
 *
jobs
, 
kc›yd_job
 *
job
)

419 
Êags
;

420 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

422 
	`•ö_lock_úqßve
(&
kc
->
job_lock
, 
Êags
);

423 
	`li°_add
(&
job
->
li°
, 
jobs
);

424 
	`•ö_u∆ock_úqª°‹e
(&
kc
->
job_lock
, 
Êags
);

425 
	}
}

436 
	$run_com∂ëe_job
(
kc›yd_job
 *
job
)

438 *
c⁄ãxt
 = 
job
->context;

439 
ªad_îr
 = 
job
->read_err;

440 
wrôe_îr
 = 
job
->write_err;

441 
dm_kc›yd_nŸify_‚
 
‚
 = 
job
->fn;

442 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

444 i‡(
job
->
∑ges
 && job->∑ge†!&
zîo_∑ge_li°
)

445 
	`kc›yd_put_∑ges
(
kc
, 
job
->
∑ges
);

450 i‡(
job
->
ma°î_job
 == job)

451 
	`mempoﬁ_‰ì
(
job
, 
kc
->
job_poﬁ
);

452 
	`‚
(
ªad_îr
, 
wrôe_îr
, 
c⁄ãxt
);

454 i‡(
	`©omic_dec_™d_ã°
(&
kc
->
ƒ_jobs
))

455 
	`wake_up
(&
kc
->
de°royq
);

458 
	}
}

460 
	$com∂ëe_io
(
îr‹
, *
c⁄ãxt
)

462 
kc›yd_job
 *
job
 = (kc›yd_job *Ë
c⁄ãxt
;

463 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

465 
	`io_job_föish
(
kc
->
thrŸée
);

467 i‡(
îr‹
) {

468 i‡(
job
->
rw
 & 
WRITE
)

469 
job
->
wrôe_îr
 |
îr‹
;

471 
job
->
ªad_îr
 = 1;

473 i‡(!
	`ã°_bô
(
DM_KCOPYD_IGNORE_ERROR
, &
job
->
Êags
)) {

474 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

475 
	`wake
(
kc
);

480 i‡(
job
->
rw
 & 
WRITE
)

481 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

484 
job
->
rw
 = 
WRITE
;

485 
	`push
(&
kc
->
io_jobs
, 
job
);

488 
	`wake
(
kc
);

489 
	}
}

495 
	$run_io_job
(
kc›yd_job
 *
job
)

497 
r
;

498 
dm_io_ªque°
 
io_ªq
 = {

499 .
bi_rw
 = 
job
->
rw
,

500 .
mem
.
ty≥
 = 
DM_IO_PAGE_LIST
,

501 .
mem
.
±r
.
∂
 = 
job
->
∑ges
,

502 .
mem
.
off£t
 = 0,

503 .
nŸify
.
‚
 = 
com∂ëe_io
,

504 .
nŸify
.
c⁄ãxt
 = 
job
,

505 .
˛õ¡
 = 
job
->
kc
->
io_˛õ¡
,

508 
	`io_job_°¨t
(
job
->
kc
->
thrŸée
);

510 i‡(
job
->
rw
 =
READ
)

511 
r
 = 
	`dm_io
(&
io_ªq
, 1, &
job
->
sour˚
, 
NULL
);

513 
r
 = 
	`dm_io
(&
io_ªq
, 
job
->
num_de°s
, job->
de°s
, 
NULL
);

515  
r
;

516 
	}
}

518 
	$run_∑ges_job
(
kc›yd_job
 *
job
)

520 
r
;

521 
ƒ_∑ges
 = 
	`dm_div_up
(
job
->
de°s
[0].
cou¡
, 
PAGE_SIZE
 >> 9);

523 
r
 = 
	`kc›yd_gë_∑ges
(
job
->
kc
, 
ƒ_∑ges
, &job->
∑ges
);

524 i‡(!
r
) {

526 
	`push
(&
job
->
kc
->
io_jobs
, job);

530 i‡(
r
 =-
ENOMEM
)

534  
r
;

535 
	}
}

541 
¥o˚ss_jobs
(
li°_hód
 *
jobs
, 
dm_kc›yd_˛õ¡
 *
kc
,

542 (*
‚
Ë(
kc›yd_job
 *))

544 
kc›yd_job
 *
job
;

545 
r
, 
cou¡
 = 0;

547 (
job
 = 
	`p›
(
jobs
, 
kc
))) {

549 
r
 = 
	`‚
(
job
);

551 i‡(
r
 < 0) {

553 i‡(
job
->
rw
 & 
WRITE
)

554 
job
->
wrôe_îr
 = () -1L;

556 
job
->
ªad_îr
 = 1;

557 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

561 i‡(
r
 > 0) {

566 
	`push_hód
(
jobs
, 
job
);

570 
cou¡
++;

573  
cou¡
;

574 
	}
}

579 
	$do_w‹k
(
w‹k_°ru˘
 *
w‹k
)

581 
dm_kc›yd_˛õ¡
 *
kc
 = 
	`c⁄èöî_of
(
w‹k
,

582 
dm_kc›yd_˛õ¡
, 
kc›yd_w‹k
);

583 
blk_∂ug
 
∂ug
;

592 
	`blk_°¨t_∂ug
(&
∂ug
);

593 
	`¥o˚ss_jobs
(&
kc
->
com∂ëe_jobs
, kc, 
run_com∂ëe_job
);

594 
	`¥o˚ss_jobs
(&
kc
->
∑ges_jobs
, kc, 
run_∑ges_job
);

595 
	`¥o˚ss_jobs
(&
kc
->
io_jobs
, kc, 
run_io_job
);

596 
	`blk_föish_∂ug
(&
∂ug
);

597 
	}
}

604 
	$di•©ch_job
(
kc›yd_job
 *
job
)

606 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

607 
	`©omic_öc
(&
kc
->
ƒ_jobs
);

608 i‡(
	`u∆ikñy
(!
job
->
sour˚
.
cou¡
))

609 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

610 i‡(
job
->
∑ges
 =&
zîo_∑ge_li°
)

611 
	`push
(&
kc
->
io_jobs
, 
job
);

613 
	`push
(&
kc
->
∑ges_jobs
, 
job
);

614 
	`wake
(
kc
);

615 
	}
}

617 
	$£gmít_com∂ëe
(
ªad_îr
, 
wrôe_îr
,

618 *
c⁄ãxt
)

621 
£˘‹_t
 
¥ogªss
 = 0;

622 
£˘‹_t
 
cou¡
 = 0;

623 
kc›yd_job
 *
sub_job
 = (kc›yd_job *Ë
c⁄ãxt
;

624 
kc›yd_job
 *
job
 = 
sub_job
->
ma°î_job
;

625 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

627 
	`muãx_lock
(&
job
->
lock
);

630 i‡(
ªad_îr
)

631 
job
->
ªad_îr
 = 1;

633 i‡(
wrôe_îr
)

634 
job
->
wrôe_îr
 |= write_err;

639 i‡((!
job
->
ªad_îr
 && !job->
wrôe_îr
) ||

640 
	`ã°_bô
(
DM_KCOPYD_IGNORE_ERROR
, &
job
->
Êags
)) {

642 
¥ogªss
 = 
job
->progress;

643 
cou¡
 = 
job
->
sour˚
.cou¡ - 
¥ogªss
;

644 i‡(
cou¡
) {

645 i‡(
cou¡
 > 
SUB_JOB_SIZE
)

646 
cou¡
 = 
SUB_JOB_SIZE
;

648 
job
->
¥ogªss
 +
cou¡
;

651 
	`muãx_u∆ock
(&
job
->
lock
);

653 i‡(
cou¡
) {

654 
i
;

656 *
sub_job
 = *
job
;

657 
sub_job
->
sour˚
.
£˘‹
 +
¥ogªss
;

658 
sub_job
->
sour˚
.
cou¡
 = count;

660 
i
 = 0; i < 
job
->
num_de°s
; i++) {

661 
sub_job
->
de°s
[
i
].
£˘‹
 +
¥ogªss
;

662 
sub_job
->
de°s
[
i
].
cou¡
 = count;

665 
sub_job
->
‚
 = 
£gmít_com∂ëe
;

666 
sub_job
->
c⁄ãxt
 = sub_job;

667 
	`di•©ch_job
(
sub_job
);

669 } i‡(
	`©omic_dec_™d_ã°
(&
job
->
sub_jobs
)) {

680 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

681 
	`wake
(
kc
);

683 
	}
}

688 
	$•lô_job
(
kc›yd_job
 *
ma°î_job
)

690 
i
;

692 
	`©omic_öc
(&
ma°î_job
->
kc
->
ƒ_jobs
);

694 
	`©omic_£t
(&
ma°î_job
->
sub_jobs
, 
SPLIT_COUNT
);

695 
i
 = 0; i < 
SPLIT_COUNT
; i++) {

696 
ma°î_job
[
i
 + 1].master_job = master_job;

697 
	`£gmít_com∂ëe
(0, 0u, &
ma°î_job
[
i
 + 1]);

699 
	}
}

701 
	$dm_kc›yd_c›y
(
dm_kc›yd_˛õ¡
 *
kc
, 
dm_io_ªgi⁄
 *
‰om
,

702 
num_de°s
, 
dm_io_ªgi⁄
 *
de°s
,

703 
Êags
, 
dm_kc›yd_nŸify_‚
 
‚
, *
c⁄ãxt
)

705 
kc›yd_job
 *
job
;

706 
i
;

712 
job
 = 
	`mempoﬁ_Æloc
(
kc
->
job_poﬁ
, 
GFP_NOIO
);

717 
job
->
kc
 = kc;

718 
job
->
Êags
 = flags;

719 
job
->
ªad_îr
 = 0;

720 
job
->
wrôe_îr
 = 0;

722 
job
->
num_de°s
 =Çum_dests;

723 
	`mem˝y
(&
job
->
de°s
, de°s, (*de°sË* 
num_de°s
);

725 i‡(
‰om
) {

726 
job
->
sour˚
 = *
‰om
;

727 
job
->
∑ges
 = 
NULL
;

728 
job
->
rw
 = 
READ
;

730 
	`mem£t
(&
job
->
sour˚
, 0,  job->source);

731 
job
->
sour˚
.
cou¡
 = job->
de°s
[0].count;

732 
job
->
∑ges
 = &
zîo_∑ge_li°
;

737 
job
->
rw
 = 
WRITE
 | 
REQ_WRITE_SAME
;

738 
i
 = 0; i < 
job
->
num_de°s
; i++)

739 i‡(!
	`bdev_wrôe_ßme
(
job
->
de°s
[
i
].
bdev
)) {

740 
job
->
rw
 = 
WRITE
;

745 
job
->
‚
 = fn;

746 
job
->
c⁄ãxt
 = context;

747 
job
->
ma°î_job
 = job;

749 i‡(
job
->
sour˚
.
cou¡
 <
SUB_JOB_SIZE
)

750 
	`di•©ch_job
(
job
);

752 
	`muãx_öô
(&
job
->
lock
);

753 
job
->
¥ogªss
 = 0;

754 
	`•lô_job
(
job
);

758 
	}
}

759 
EXPORT_SYMBOL
(
dm_kc›yd_c›y
);

761 
	$dm_kc›yd_zîo
(
dm_kc›yd_˛õ¡
 *
kc
,

762 
num_de°s
, 
dm_io_ªgi⁄
 *
de°s
,

763 
Êags
, 
dm_kc›yd_nŸify_‚
 
‚
, *
c⁄ãxt
)

765  
	`dm_kc›yd_c›y
(
kc
, 
NULL
, 
num_de°s
, 
de°s
, 
Êags
, 
‚
, 
c⁄ãxt
);

766 
	}
}

767 
EXPORT_SYMBOL
(
dm_kc›yd_zîo
);

769 *
	$dm_kc›yd_¥ï¨e_ˇŒback
(
dm_kc›yd_˛õ¡
 *
kc
,

770 
dm_kc›yd_nŸify_‚
 
‚
, *
c⁄ãxt
)

772 
kc›yd_job
 *
job
;

774 
job
 = 
	`mempoﬁ_Æloc
(
kc
->
job_poﬁ
, 
GFP_NOIO
);

776 
	`mem£t
(
job
, 0, (
kc›yd_job
));

777 
job
->
kc
 = kc;

778 
job
->
‚
 = fn;

779 
job
->
c⁄ãxt
 = context;

780 
job
->
ma°î_job
 = job;

782 
	`©omic_öc
(&
kc
->
ƒ_jobs
);

784  
job
;

785 
	}
}

786 
EXPORT_SYMBOL
(
dm_kc›yd_¥ï¨e_ˇŒback
);

788 
	$dm_kc›yd_do_ˇŒback
(*
j
, 
ªad_îr
, 
wrôe_îr
)

790 
kc›yd_job
 *
job
 = 
j
;

791 
dm_kc›yd_˛õ¡
 *
kc
 = 
job
->kc;

793 
job
->
ªad_îr
 =Ñead_err;

794 
job
->
wrôe_îr
 = write_err;

796 
	`push
(&
kc
->
com∂ëe_jobs
, 
job
);

797 
	`wake
(
kc
);

798 
	}
}

799 
EXPORT_SYMBOL
(
dm_kc›yd_do_ˇŒback
);

806 
	$kc›yd_ˇn˚l
(
kc›yd_job
 *
job
, 
block
)

810 
	}
}

816 
dm_kc›yd_˛õ¡
 *
	$dm_kc›yd_˛õ¡_¸óã
(
dm_kc›yd_thrŸée
 *
thrŸée
)

818 
r
 = -
ENOMEM
;

819 
dm_kc›yd_˛õ¡
 *
kc
;

821 
kc
 = 
	`kmÆloc
((*kc), 
GFP_KERNEL
);

822 i‡(!
kc
)

823  
	`ERR_PTR
(-
ENOMEM
);

825 
	`•ö_lock_öô
(&
kc
->
job_lock
);

826 
	`INIT_LIST_HEAD
(&
kc
->
com∂ëe_jobs
);

827 
	`INIT_LIST_HEAD
(&
kc
->
io_jobs
);

828 
	`INIT_LIST_HEAD
(&
kc
->
∑ges_jobs
);

829 
kc
->
thrŸée
 =Åhrottle;

831 
kc
->
job_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
MIN_JOBS
, 
_job_ˇche
);

832 i‡(!
kc
->
job_poﬁ
)

833 
bad_¶ab
;

835 
	`INIT_WORK
(&
kc
->
kc›yd_w‹k
, 
do_w‹k
);

836 
kc
->
kc›yd_wq
 = 
	`Æloc_w‹kqueue
("kc›yd", 
WQ_MEM_RECLAIM
, 0);

837 i‡(!
kc
->
kc›yd_wq
)

838 
bad_w‹kqueue
;

840 
kc
->
∑ges
 = 
NULL
;

841 
kc
->
ƒ_ª£rved_∑ges
 = kc->
ƒ_‰ì_∑ges
 = 0;

842 
r
 = 
	`˛õ¡_ª£rve_∑ges
(
kc
, 
RESERVE_PAGES
);

843 i‡(
r
)

844 
bad_˛õ¡_∑ges
;

846 
kc
->
io_˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

847 i‡(
	`IS_ERR
(
kc
->
io_˛õ¡
)) {

848 
r
 = 
	`PTR_ERR
(
kc
->
io_˛õ¡
);

849 
bad_io_˛õ¡
;

852 
	`öô_waôqueue_hód
(&
kc
->
de°royq
);

853 
	`©omic_£t
(&
kc
->
ƒ_jobs
, 0);

855  
kc
;

857 
bad_io_˛õ¡
:

858 
	`˛õ¡_‰ì_∑ges
(
kc
);

859 
bad_˛õ¡_∑ges
:

860 
	`de°roy_w‹kqueue
(
kc
->
kc›yd_wq
);

861 
bad_w‹kqueue
:

862 
	`mempoﬁ_de°roy
(
kc
->
job_poﬁ
);

863 
bad_¶ab
:

864 
	`k‰ì
(
kc
);

866  
	`ERR_PTR
(
r
);

867 
	}
}

868 
EXPORT_SYMBOL
(
dm_kc›yd_˛õ¡_¸óã
);

870 
	$dm_kc›yd_˛õ¡_de°roy
(
dm_kc›yd_˛õ¡
 *
kc
)

873 
	`waô_evít
(
kc
->
de°royq
, !
	`©omic_ªad
(&kc->
ƒ_jobs
));

875 
	`BUG_ON
(!
	`li°_em±y
(&
kc
->
com∂ëe_jobs
));

876 
	`BUG_ON
(!
	`li°_em±y
(&
kc
->
io_jobs
));

877 
	`BUG_ON
(!
	`li°_em±y
(&
kc
->
∑ges_jobs
));

878 
	`de°roy_w‹kqueue
(
kc
->
kc›yd_wq
);

879 
	`dm_io_˛õ¡_de°roy
(
kc
->
io_˛õ¡
);

880 
	`˛õ¡_‰ì_∑ges
(
kc
);

881 
	`mempoﬁ_de°roy
(
kc
->
job_poﬁ
);

882 
	`k‰ì
(
kc
);

883 
	}
}

884 
EXPORT_SYMBOL
(
dm_kc›yd_˛õ¡_de°roy
);

	@dm-linear.c

7 
	~"dm.h
"

8 
	~<löux/moduÀ.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/blkdev.h
>

11 
	~<löux/bio.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/devi˚-m≠≥r.h
>

15 
	#DM_MSG_PREFIX
 "löór"

	)

20 
	slöór_c
 {

21 
dm_dev
 *
	mdev
;

22 
£˘‹_t
 
	m°¨t
;

28 
	$löór_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

30 
löór_c
 *
lc
;

31 
tmp
;

32 
dummy
;

34 i‡(
¨gc
 != 2) {

35 
ti
->
îr‹
 = "Invalidárgument count";

36  -
EINVAL
;

39 
lc
 = 
	`kmÆloc
((*lc), 
GFP_KERNEL
);

40 i‡(
lc
 =
NULL
) {

41 
ti
->
îr‹
 = "dm-linear: CannotállocateÜinear context";

42  -
ENOMEM
;

45 i‡(
	`ssˇnf
(
¨gv
[1], "%Œu%c", &
tmp
, &
dummy
) != 1) {

46 
ti
->
îr‹
 = "dm-linear: Invalid device sector";

47 
bad
;

49 
lc
->
°¨t
 = 
tmp
;

51 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
lc
->
dev
)) {

52 
ti
->
îr‹
 = "dm-linear: DeviceÜookup failed";

53 
bad
;

56 
ti
->
num_Êush_bios
 = 1;

57 
ti
->
num_disˇrd_bios
 = 1;

58 
ti
->
num_wrôe_ßme_bios
 = 1;

59 
ti
->
¥iv©e
 = 
lc
;

62 
bad
:

63 
	`k‰ì
(
lc
);

64  -
EINVAL
;

65 
	}
}

67 
	$löór_då
(
dm_èrgë
 *
ti
)

69 
löór_c
 *
lc
 = (löór_¯*Ë
ti
->
¥iv©e
;

71 
	`dm_put_devi˚
(
ti
, 
lc
->
dev
);

72 
	`k‰ì
(
lc
);

73 
	}
}

75 
£˘‹_t
 
	$löór_m≠_£˘‹
(
dm_èrgë
 *
ti
, 
£˘‹_t
 
bi_£˘‹
)

77 
löór_c
 *
lc
 = 
ti
->
¥iv©e
;

79  
lc
->
°¨t
 + 
	`dm_èrgë_off£t
(
ti
, 
bi_£˘‹
);

80 
	}
}

82 
	$löór_m≠_bio
(
dm_èrgë
 *
ti
, 
bio
 *bio)

84 
löór_c
 *
lc
 = 
ti
->
¥iv©e
;

86 
bio
->
bi_bdev
 = 
lc
->
dev
->
bdev
;

87 i‡(
	`bio_£˘‹s
(
bio
))

88 
bio
->
bi_ôî
.
bi_£˘‹
 =

89 
	`löór_m≠_£˘‹
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

90 
	}
}

92 
	$löór_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

94 
	`löór_m≠_bio
(
ti
, 
bio
);

96  
DM_MAPIO_REMAPPED
;

97 
	}
}

99 
	$löór_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

100 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

102 
löór_c
 *
lc
 = (löór_¯*Ë
ti
->
¥iv©e
;

104 
ty≥
) {

105 
STATUSTYPE_INFO
:

106 
ªsu…
[0] = '\0';

109 
STATUSTYPE_TABLE
:

110 
	`¢¥ötf
(
ªsu…
, 
maxÀn
, "%†%Œu", 
lc
->
dev
->
«me
,

111 ()
lc
->
°¨t
);

114 
	}
}

116 
	$löór_io˘l
(
dm_èrgë
 *
ti
, 
cmd
,

117 
¨g
)

119 
löór_c
 *
lc
 = (löór_¯*Ë
ti
->
¥iv©e
;

120 
dm_dev
 *
dev
 = 
lc
->dev;

121 
r
 = 0;

126 i‡(
lc
->
°¨t
 ||

127 
ti
->
Àn
 !
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
)

128 
r
 = 
	`scsi_vîify_blk_io˘l
(
NULL
, 
cmd
);

130  
r
 ? : 
	`__blkdev_drivî_io˘l
(
dev
->
bdev
, dev->
mode
, 
cmd
, 
¨g
);

131 
	}
}

133 
	$löór_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

134 
bio_vec
 *
biovec
, 
max_size
)

136 
löór_c
 *
lc
 = 
ti
->
¥iv©e
;

137 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
lc
->
dev
->
bdev
);

139 i‡(!
q
->
mîge_bvec_‚
)

140  
max_size
;

142 
bvm
->
bi_bdev
 = 
lc
->
dev
->
bdev
;

143 
bvm
->
bi_£˘‹
 = 
	`löór_m≠_£˘‹
(
ti
, bvm->bi_sector);

145  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

146 
	}
}

148 
	$löór_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

149 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

151 
löór_c
 *
lc
 = 
ti
->
¥iv©e
;

153  
	`‚
(
ti
, 
lc
->
dev
,Üc->
°¨t
,Åi->
Àn
, 
d©a
);

154 
	}
}

156 
èrgë_ty≥
 
	glöór_èrgë
 = {

157 .
«me
 = "linear",

158 .
	gvîsi⁄
 = {1, 2, 1},

159 .
	gmoduÀ
 = 
THIS_MODULE
,

160 .
	g˘r
 = 
löór_˘r
,

161 .
	gdå
 = 
löór_då
,

162 .
	gm≠
 = 
löór_m≠
,

163 .
	g°©us
 = 
löór_°©us
,

164 .
	gio˘l
 = 
löór_io˘l
,

165 .
	gmîge
 = 
löór_mîge
,

166 .
	gôî©e_devi˚s
 = 
löór_ôî©e_devi˚s
,

169 
__öô
 
	$dm_löór_öô
()

171 
r
 = 
	`dm_ªgi°î_èrgë
(&
löór_èrgë
);

173 i‡(
r
 < 0)

174 
	`DMERR
("ªgi°î faûed %d", 
r
);

176  
r
;

177 
	}
}

179 
	$dm_löór_exô
()

181 
	`dm_uƒegi°î_èrgë
(&
löór_èrgë
);

182 
	}
}

	@dm-log-userspace-base.c

7 
	~<löux/bio.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/dm-dúty-log.h
>

10 
	~<löux/devi˚-m≠≥r.h
>

11 
	~<löux/dm-log-u£r•a˚.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/w‹kqueue.h
>

15 
	~"dm-log-u£r•a˚-å™s„r.h
"

17 
	#DM_LOG_USERSPACE_VSN
 "1.3.0"

	)

19 
	sÊush_íåy
 {

20 
	mty≥
;

21 
ªgi⁄_t
 
	mªgi⁄
;

22 
li°_hód
 
	mli°
;

31 
	#MAX_FLUSH_GROUP_COUNT
 32

	)

33 
	slog_c
 {

34 
dm_èrgë
 *
	mti
;

35 
dm_dev
 *
	mlog_dev
;

36 
uöt32_t
 
	mªgi⁄_size
;

37 
ªgi⁄_t
 
	mªgi⁄_cou¡
;

38 
uöt64_t
 
	mluid
;

39 
	muuid
[
DM_UUID_LEN
];

41 *
	mu§_¨gv_°r
;

42 
uöt32_t
 
	mu§_¨gc
;

51 
uöt64_t
 
	mö_sync_höt
;

59 
•ölock_t
 
	mÊush_lock
;

60 
li°_hód
 
	mm¨k_li°
;

61 
li°_hód
 
	m˛ór_li°
;

66 
w‹kqueue_°ru˘
 *
	mdmlog_wq
;

67 
dñayed_w‹k
 
	mÊush_log_w‹k
;

68 
©omic_t
 
	msched_Êush
;

73 
uöt32_t
 
	möãgøãd_Êush
;

76 
mempoﬁ_t
 *
	gÊush_íåy_poﬁ
;

78 *
	$Êush_íåy_Æloc
(
gÂ_t
 
gÂ_mask
, *
poﬁ_d©a
)

80  
	`kmÆloc
((
Êush_íåy
), 
gÂ_mask
);

81 
	}
}

83 
	$Êush_íåy_‰ì
(*
ñemít
, *
poﬁ_d©a
)

85 
	`k‰ì
(
ñemít
);

86 
	}
}

88 
	$u£r•a˚_do_ªque°
(
log_c
 *
lc
, c⁄° *
uuid
,

89 
ªque°_ty≥
, *
d©a
, 
size_t
 
d©a_size
,

90 *
rd©a
, 
size_t
 *
rd©a_size
)

92 
r
;

99 
ªåy
:

100 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
uuid
, 
lc
->
luid
, 
ªque°_ty≥
, 
d©a
,

101 
d©a_size
, 
rd©a
, 
rd©a_size
);

103 i‡(
r
 !-
ESRCH
)

104  
r
;

106 
	`DMERR
(" UserspaceÜog serverÇot found.");

108 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

109 
	`scheduÀ_timeout
(2*
HZ
);

110 
	`DMWARN
("AttemptingÅo contact userspaceÜog server...");

111 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
uuid
, 
lc
->
luid
, 
DM_ULOG_CTR
,

112 
lc
->
u§_¨gv_°r
,

113 
	`°æí
(
lc
->
u§_¨gv_°r
) + 1,

114 
NULL
, NULL);

115 i‡(!
r
)

118 
	`DMINFO
("ReconnectedÅo userspaceÜog server... DM_ULOG_CTR complete");

119 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
uuid
, 
lc
->
luid
, 
DM_ULOG_RESUME
, 
NULL
,

120 0, 
NULL
, NULL);

121 i‡(!
r
)

122 
ªåy
;

124 
	`DMERR
("Eº‹ÅryögÅÿªsumêu£r•a˚Üog: %d", 
r
);

126  -
ESRCH
;

127 
	}
}

129 
	$buûd_c⁄°ru˘‹_°rög
(
dm_èrgë
 *
ti
,

130 
¨gc
, **
¨gv
,

131 **
˘r_°r
)

133 
i
, 
°r_size
;

134 *
°r
 = 
NULL
;

136 *
˘r_°r
 = 
NULL
;

141 
i
 = 0, 
°r_size
 = 0; i < 
¨gc
; i++)

142 
°r_size
 +
	`°æí
(
¨gv
[
i
]) + 1;

144 
°r_size
 += 20;

146 
°r
 = 
	`kzÆloc
(
°r_size
, 
GFP_KERNEL
);

147 i‡(!
°r
) {

148 
	`DMWARN
("UnableÅoállocate memory for constructor string");

149  -
ENOMEM
;

152 
°r_size
 = 
	`•rötf
(
°r
, "%Œu", ()
ti
->
Àn
);

153 
i
 = 0; i < 
¨gc
; i++)

154 
°r_size
 +
	`•rötf
(
°r
 + så_size, " %s", 
¨gv
[
i
]);

156 *
˘r_°r
 = 
°r
;

157  
°r_size
;

158 
	}
}

160 
	$do_Êush
(
w‹k_°ru˘
 *
w‹k
)

162 
r
;

163 
log_c
 *
lc
 = 
	`c⁄èöî_of
(
w‹k
, log_c, 
Êush_log_w‹k
.work);

165 
	`©omic_£t
(&
lc
->
sched_Êush
, 0);

167 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_FLUSH
, 
NULL
, 0, NULL, NULL);

169 i‡(
r
)

170 
	`dm_èbÀ_evít
(
lc
->
ti
->
èbÀ
);

171 
	}
}

194 
	$u£r•a˚_˘r
(
dm_dúty_log
 *
log
, 
dm_èrgë
 *
ti
,

195 
¨gc
, **
¨gv
)

197 
r
 = 0;

198 
°r_size
;

199 *
˘r_°r
 = 
NULL
;

200 
log_c
 *
lc
 = 
NULL
;

201 
uöt64_t
 
rd©a
;

202 
size_t
 
rd©a_size
 = (
rd©a
);

203 *
devi˚s_rd©a
 = 
NULL
;

204 
size_t
 
devi˚s_rd©a_size
 = 
DM_NAME_LEN
;

206 i‡(
¨gc
 < 3) {

207 
	`DMWARN
("Too fewárgumentsÅo userspace dirtyÜog");

208  -
EINVAL
;

211 
lc
 = 
	`kzÆloc
((*lc), 
GFP_KERNEL
);

212 i‡(!
lc
) {

213 
	`DMWARN
("UnableÅoállocate userspaceÜog context.");

214  -
ENOMEM
;

218 
lc
->
luid
 = ()lc;

220 
lc
->
ti
 =Åi;

222 i‡(
	`°æí
(
¨gv
[0]Ë> (
DM_UUID_LEN
 - 1)) {

223 
	`DMWARN
("UUIDárgumentÅooÜong.");

224 
	`k‰ì
(
lc
);

225  -
EINVAL
;

228 
lc
->
u§_¨gc
 = 
¨gc
;

230 
	`°∫˝y
(
lc
->
uuid
, 
¨gv
[0], 
DM_UUID_LEN
);

231 
¨gc
--;

232 
¨gv
++;

233 
	`•ö_lock_öô
(&
lc
->
Êush_lock
);

234 
	`INIT_LIST_HEAD
(&
lc
->
m¨k_li°
);

235 
	`INIT_LIST_HEAD
(&
lc
->
˛ór_li°
);

237 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "integrated_flush")) {

238 
lc
->
öãgøãd_Êush
 = 1;

239 
¨gc
--;

240 
¨gv
++;

243 
°r_size
 = 
	`buûd_c⁄°ru˘‹_°rög
(
ti
, 
¨gc
, 
¨gv
, &
˘r_°r
);

244 i‡(
°r_size
 < 0) {

245 
	`k‰ì
(
lc
);

246  
°r_size
;

249 
devi˚s_rd©a
 = 
	`kzÆloc
(
devi˚s_rd©a_size
, 
GFP_KERNEL
);

250 i‡(!
devi˚s_rd©a
) {

251 
	`DMERR
("FailedÅoállocate memory for device information");

252 
r
 = -
ENOMEM
;

253 
out
;

259 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_CTR
,

260 
˘r_°r
, 
°r_size
,

261 
devi˚s_rd©a
, &
devi˚s_rd©a_size
);

263 i‡(
r
 < 0) {

264 i‡(
r
 =-
ESRCH
)

265 
	`DMERR
("UserspaceÜog serverÇot found");

267 
	`DMERR
("UserspaceÜog server failedÅo createÜog");

268 
out
;

272 
rd©a_size
 = (
rd©a
);

273 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_GET_REGION_SIZE
,

274 
NULL
, 0, (*)&
rd©a
, &
rd©a_size
);

276 i‡(
r
) {

277 
	`DMERR
("FailedÅo getÑegion size of dirtyÜog");

278 
out
;

281 
lc
->
ªgi⁄_size
 = (
uöt32_t
)
rd©a
;

282 
lc
->
ªgi⁄_cou¡
 = 
	`dm_£˘‹_div_up
(
ti
->
Àn
,Üc->
ªgi⁄_size
);

284 i‡(
devi˚s_rd©a_size
) {

285 i‡(
devi˚s_rd©a
[
devi˚s_rd©a_size
 - 1] != '\0') {

286 
	`DMERR
("DM_ULOG_CTR deviceÑeturn stringÇotÖroperlyÅerminated");

287 
r
 = -
EINVAL
;

288 
out
;

290 
r
 = 
	`dm_gë_devi˚
(
ti
, 
devi˚s_rd©a
,

291 
	`dm_èbÀ_gë_mode
(
ti
->
èbÀ
), &
lc
->
log_dev
);

292 i‡(
r
)

293 
	`DMERR
("FailedÅoÑegister %s with device-mapper",

294 
devi˚s_rd©a
);

297 i‡(
lc
->
öãgøãd_Êush
) {

298 
lc
->
dmlog_wq
 = 
	`Æloc_w‹kqueue
("dmlogd", 
WQ_MEM_RECLAIM
, 0);

299 i‡(!
lc
->
dmlog_wq
) {

300 
	`DMERR
("couldn't start dmlogd");

301 
r
 = -
ENOMEM
;

302 
out
;

305 
	`INIT_DELAYED_WORK
(&
lc
->
Êush_log_w‹k
, 
do_Êush
);

306 
	`©omic_£t
(&
lc
->
sched_Êush
, 0);

309 
out
:

310 
	`k‰ì
(
devi˚s_rd©a
);

311 i‡(
r
) {

312 
	`k‰ì
(
lc
);

313 
	`k‰ì
(
˘r_°r
);

315 
lc
->
u§_¨gv_°r
 = 
˘r_°r
;

316 
log
->
c⁄ãxt
 = 
lc
;

319  
r
;

320 
	}
}

322 
	$u£r•a˚_då
(
dm_dúty_log
 *
log
)

324 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

326 i‡(
lc
->
öãgøãd_Êush
) {

328 i‡(
	`©omic_ªad
(&
lc
->
sched_Êush
))

329 
	`Êush_dñayed_w‹k
(&
lc
->
Êush_log_w‹k
);

331 
	`de°roy_w‹kqueue
(
lc
->
dmlog_wq
);

334 (Ë
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_DTR
,

335 
NULL
, 0, NULL, NULL);

337 i‡(
lc
->
log_dev
)

338 
	`dm_put_devi˚
(
lc
->
ti
,Üc->
log_dev
);

340 
	`k‰ì
(
lc
->
u§_¨gv_°r
);

341 
	`k‰ì
(
lc
);

344 
	}
}

346 
	$u£r•a˚_¥esu•íd
(
dm_dúty_log
 *
log
)

348 
r
;

349 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

351 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_PRESUSPEND
,

352 
NULL
, 0, NULL, NULL);

354  
r
;

355 
	}
}

357 
	$u£r•a˚_po°su•íd
(
dm_dúty_log
 *
log
)

359 
r
;

360 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

365 i‡(
lc
->
öãgøãd_Êush
 && 
	`©omic_ªad
(&lc->
sched_Êush
))

366 
	`Êush_dñayed_w‹k
(&
lc
->
Êush_log_w‹k
);

368 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_POSTSUSPEND
,

369 
NULL
, 0, NULL, NULL);

371  
r
;

372 
	}
}

374 
	$u£r•a˚_ªsume
(
dm_dúty_log
 *
log
)

376 
r
;

377 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

379 
lc
->
ö_sync_höt
 = 0;

380 
r
 = 
	`dm_c⁄su…_u£r•a˚
(
lc
->
uuid
,Üc->
luid
, 
DM_ULOG_RESUME
,

381 
NULL
, 0, NULL, NULL);

383  
r
;

384 
	}
}

386 
uöt32_t
 
	$u£r•a˚_gë_ªgi⁄_size
(
dm_dúty_log
 *
log
)

388 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

390  
lc
->
ªgi⁄_size
;

391 
	}
}

401 
	$u£r•a˚_is_˛ón
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

403 
r
;

404 
uöt64_t
 
ªgi⁄64
 = (uöt64_t)
ªgi⁄
;

405 
öt64_t
 
is_˛ón
;

406 
size_t
 
rd©a_size
;

407 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

409 
rd©a_size
 = (
is_˛ón
);

410 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_IS_CLEAN
,

411 (*)&
ªgi⁄64
, (region64),

412 (*)&
is_˛ón
, &
rd©a_size
);

414  (
r
Ë? 0 : ()
is_˛ón
;

415 
	}
}

428 
	$u£r•a˚_ö_sync
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
,

429 
ˇn_block
)

431 
r
;

432 
uöt64_t
 
ªgi⁄64
 = 
ªgi⁄
;

433 
öt64_t
 
ö_sync
;

434 
size_t
 
rd©a_size
;

435 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

450 i‡(!
ˇn_block
)

451  -
EWOULDBLOCK
;

453 
rd©a_size
 = (
ö_sync
);

454 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_IN_SYNC
,

455 (*)&
ªgi⁄64
, (region64),

456 (*)&
ö_sync
, &
rd©a_size
);

457  (
r
Ë? 0 : ()
ö_sync
;

458 
	}
}

460 
	$Êush_⁄e_by_⁄e
(
log_c
 *
lc
, 
li°_hód
 *
Êush_li°
)

462 
r
 = 0;

463 
Êush_íåy
 *
„
;

465 
	`li°_f‹_óch_íåy
(
„
, 
Êush_li°
, 
li°
) {

466 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
„
->
ty≥
,

467 (*)&
„
->
ªgi⁄
,

468 (
„
->
ªgi⁄
),

469 
NULL
, NULL);

470 i‡(
r
)

474  
r
;

475 
	}
}

477 
	$Êush_by_group
(
log_c
 *
lc
, 
li°_hód
 *
Êush_li°
,

478 
Êush_wôh_∑ylﬂd
)

480 
r
 = 0;

481 
cou¡
;

482 
uöt32_t
 
ty≥
 = 0;

483 
Êush_íåy
 *
„
, *
tmp_„
;

484 
	`LIST_HEAD
(
tmp_li°
);

485 
uöt64_t
 
group
[
MAX_FLUSH_GROUP_COUNT
];

490 !
	`li°_em±y
(
Êush_li°
)) {

491 
cou¡
 = 0;

493 
	`li°_f‹_óch_íåy_ß„
(
„
, 
tmp_„
, 
Êush_li°
, 
li°
) {

494 
group
[
cou¡
] = 
„
->
ªgi⁄
;

495 
cou¡
++;

497 
	`li°_move
(&
„
->
li°
, &
tmp_li°
);

499 
ty≥
 = 
„
->type;

500 i‡(
cou¡
 >
MAX_FLUSH_GROUP_COUNT
)

504 i‡(
Êush_wôh_∑ylﬂd
) {

505 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_FLUSH
,

506 (*)(
group
),

507 
cou¡
 * (
uöt64_t
),

508 
NULL
, NULL);

512 i‡(
r
)

515 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
ty≥
,

516 (*)(
group
),

517 
cou¡
 * (
uöt64_t
),

518 
NULL
, NULL);

519 i‡(
r
) {

523 
	`li°_•li˚_öô
(&
tmp_li°
, 
Êush_li°
);

524 
r
 = 
	`Êush_⁄e_by_⁄e
(
lc
, 
Êush_li°
);

534 
	`li°_•li˚_öô
(&
tmp_li°
, 
Êush_li°
);

536  
r
;

537 
	}
}

556 
	$u£r•a˚_Êush
(
dm_dúty_log
 *
log
)

558 
r
 = 0;

559 
Êags
;

560 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

561 
	`LIST_HEAD
(
m¨k_li°
);

562 
	`LIST_HEAD
(
˛ór_li°
);

563 
m¨k_li°_is_em±y
;

564 
˛ór_li°_is_em±y
;

565 
Êush_íåy
 *
„
, *
tmp_„
;

567 
	`•ö_lock_úqßve
(&
lc
->
Êush_lock
, 
Êags
);

568 
	`li°_•li˚_öô
(&
lc
->
m¨k_li°
, &mark_list);

569 
	`li°_•li˚_öô
(&
lc
->
˛ór_li°
, &clear_list);

570 
	`•ö_u∆ock_úqª°‹e
(&
lc
->
Êush_lock
, 
Êags
);

572 
m¨k_li°_is_em±y
 = 
	`li°_em±y
(&
m¨k_li°
);

573 
˛ór_li°_is_em±y
 = 
	`li°_em±y
(&
˛ór_li°
);

575 i‡(
m¨k_li°_is_em±y
 && 
˛ór_li°_is_em±y
)

578 
r
 = 
	`Êush_by_group
(
lc
, &
˛ór_li°
, 0);

579 i‡(
r
)

580 
out
;

582 i‡(!
lc
->
öãgøãd_Êush
) {

583 
r
 = 
	`Êush_by_group
(
lc
, &
m¨k_li°
, 0);

584 i‡(
r
)

585 
out
;

586 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_FLUSH
,

587 
NULL
, 0, NULL, NULL);

588 
out
;

594 
r
 = 
	`Êush_by_group
(
lc
, &
m¨k_li°
, 1);

595 i‡(
r
)

596 
out
;

598 i‡(
m¨k_li°_is_em±y
 && !
	`©omic_ªad
(&
lc
->
sched_Êush
)) {

603 
	`queue_dñayed_w‹k
(
lc
->
dmlog_wq
, &lc->
Êush_log_w‹k
, 3 * 
HZ
);

604 
	`©omic_£t
(&
lc
->
sched_Êush
, 1);

610 
	`ˇn˚l_dñayed_w‹k
(&
lc
->
Êush_log_w‹k
);

611 
	`©omic_£t
(&
lc
->
sched_Êush
, 0);

614 
out
:

620 
	`li°_f‹_óch_íåy_ß„
(
„
, 
tmp_„
, &
m¨k_li°
, 
li°
) {

621 
	`li°_dñ
(&
„
->
li°
);

622 
	`mempoﬁ_‰ì
(
„
, 
Êush_íåy_poﬁ
);

624 
	`li°_f‹_óch_íåy_ß„
(
„
, 
tmp_„
, &
˛ór_li°
, 
li°
) {

625 
	`li°_dñ
(&
„
->
li°
);

626 
	`mempoﬁ_‰ì
(
„
, 
Êush_íåy_poﬁ
);

629 i‡(
r
)

630 
	`dm_èbÀ_evít
(
lc
->
ti
->
èbÀ
);

632  
r
;

633 
	}
}

641 
	$u£r•a˚_m¨k_ªgi⁄
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

643 
Êags
;

644 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

645 
Êush_íåy
 *
„
;

648 
„
 = 
	`mempoﬁ_Æloc
(
Êush_íåy_poﬁ
, 
GFP_NOIO
);

649 
	`BUG_ON
(!
„
);

651 
	`•ö_lock_úqßve
(&
lc
->
Êush_lock
, 
Êags
);

652 
„
->
ty≥
 = 
DM_ULOG_MARK_REGION
;

653 
„
->
ªgi⁄
 =Ñegion;

654 
	`li°_add
(&
„
->
li°
, &
lc
->
m¨k_li°
);

655 
	`•ö_u∆ock_úqª°‹e
(&
lc
->
Êush_lock
, 
Êags
);

658 
	}
}

670 
	$u£r•a˚_˛ór_ªgi⁄
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

672 
Êags
;

673 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

674 
Êush_íåy
 *
„
;

682 
„
 = 
	`mempoﬁ_Æloc
(
Êush_íåy_poﬁ
, 
GFP_ATOMIC
);

683 i‡(!
„
) {

684 
	`DMERR
("FailedÅoállocate memoryÅo clearÑegion.");

688 
	`•ö_lock_úqßve
(&
lc
->
Êush_lock
, 
Êags
);

689 
„
->
ty≥
 = 
DM_ULOG_CLEAR_REGION
;

690 
„
->
ªgi⁄
 =Ñegion;

691 
	`li°_add
(&
„
->
li°
, &
lc
->
˛ór_li°
);

692 
	`•ö_u∆ock_úqª°‹e
(&
lc
->
Êush_lock
, 
Êags
);

695 
	}
}

705 
	$u£r•a˚_gë_ªsync_w‹k
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 *
ªgi⁄
)

707 
r
;

708 
size_t
 
rd©a_size
;

709 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

711 
öt64_t
 
i
;

712 
ªgi⁄_t
 
r
;

713 } 
pkg
;

715 i‡(
lc
->
ö_sync_höt
 >lc->
ªgi⁄_cou¡
)

718 
rd©a_size
 = (
pkg
);

719 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_GET_RESYNC_WORK
,

720 
NULL
, 0, (*)&
pkg
, &
rd©a_size
);

722 *
ªgi⁄
 = 
pkg
.
r
;

723  (
r
Ë?Ñ : ()
pkg
.
i
;

724 
	}
}

732 
	$u£r•a˚_£t_ªgi⁄_sync
(
dm_dúty_log
 *
log
,

733 
ªgi⁄_t
 
ªgi⁄
, 
ö_sync
)

735 
r
;

736 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

738 
ªgi⁄_t
 
r
;

739 
öt64_t
 
i
;

740 } 
pkg
;

742 
pkg
.
r
 = 
ªgi⁄
;

743 
pkg
.
i
 = (
öt64_t
)
ö_sync
;

745 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_SET_REGION_SYNC
,

746 (*)&
pkg
, ’kg), 
NULL
, NULL);

753 
	}
}

763 
ªgi⁄_t
 
	$u£r•a˚_gë_sync_cou¡
(
dm_dúty_log
 *
log
)

765 
r
;

766 
size_t
 
rd©a_size
;

767 
uöt64_t
 
sync_cou¡
;

768 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

770 
rd©a_size
 = (
sync_cou¡
);

771 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_GET_SYNC_COUNT
,

772 
NULL
, 0, (*)&
sync_cou¡
, &
rd©a_size
);

774 i‡(
r
)

777 i‡(
sync_cou¡
 >
lc
->
ªgi⁄_cou¡
)

778 
lc
->
ö_sync_höt
 =Üc->
ªgi⁄_cou¡
;

780  (
ªgi⁄_t
)
sync_cou¡
;

781 
	}
}

788 
	$u£r•a˚_°©us
(
dm_dúty_log
 *
log
, 
°©us_ty≥_t
 
°©us_ty≥
,

789 *
ªsu…
, 
maxÀn
)

791 
r
 = 0;

792 *
èbÀ_¨gs
;

793 
size_t
 
sz
 = (size_t)
maxÀn
;

794 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

796 
°©us_ty≥
) {

797 
STATUSTYPE_INFO
:

798 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_STATUS_INFO
,

799 
NULL
, 0, 
ªsu…
, &
sz
);

801 i‡(
r
) {

802 
sz
 = 0;

803 
	`DMEMIT
("%†1 COM_FAILURE", 
log
->
ty≥
->
«me
);

806 
STATUSTYPE_TABLE
:

807 
sz
 = 0;

808 
èbÀ_¨gs
 = 
	`°rchr
(
lc
->
u§_¨gv_°r
, ' ');

809 
	`BUG_ON
(!
èbÀ_¨gs
);

810 
èbÀ_¨gs
++;

812 
	`DMEMIT
("%†%u %†", 
log
->
ty≥
->
«me
, 
lc
->
u§_¨gc
,Üc->
uuid
);

813 i‡(
lc
->
öãgøãd_Êush
)

814 
	`DMEMIT
("integrated_flush ");

815 
	`DMEMIT
("%†", 
èbÀ_¨gs
);

818  (
r
Ë? 0 : ()
sz
;

819 
	}
}

826 
	$u£r•a˚_is_ªmŸe_ªcovîög
(
dm_dúty_log
 *
log
,

827 
ªgi⁄_t
 
ªgi⁄
)

829 
r
;

830 
uöt64_t
 
ªgi⁄64
 = 
ªgi⁄
;

831 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

832 
limô
;

834 
öt64_t
 
is_ªcovîög
;

835 
uöt64_t
 
ö_sync_höt
;

836 } 
pkg
;

837 
size_t
 
rd©a_size
 = (
pkg
);

846 i‡(
ªgi⁄
 < 
lc
->
ö_sync_höt
)

848 i‡(
jiffõs
 < 
limô
)

851 
limô
 = 
jiffõs
 + (
HZ
 / 4);

852 
r
 = 
	`u£r•a˚_do_ªque°
(
lc
,Üc->
uuid
, 
DM_ULOG_IS_REMOTE_RECOVERING
,

853 (*)&
ªgi⁄64
, (region64),

854 (*)&
pkg
, &
rd©a_size
);

855 i‡(
r
)

858 
lc
->
ö_sync_höt
 = 
pkg
.in_sync_hint;

860  ()
pkg
.
is_ªcovîög
;

861 
	}
}

863 
dm_dúty_log_ty≥
 
	g_u£r•a˚_ty≥
 = {

864 .
«me
 = "userspace",

865 .
	gmoduÀ
 = 
THIS_MODULE
,

866 .
	g˘r
 = 
u£r•a˚_˘r
,

867 .
	gdå
 = 
u£r•a˚_då
,

868 .
	g¥esu•íd
 = 
u£r•a˚_¥esu•íd
,

869 .
	gpo°su•íd
 = 
u£r•a˚_po°su•íd
,

870 .
	gªsume
 = 
u£r•a˚_ªsume
,

871 .
	ggë_ªgi⁄_size
 = 
u£r•a˚_gë_ªgi⁄_size
,

872 .
	gis_˛ón
 = 
u£r•a˚_is_˛ón
,

873 .
	gö_sync
 = 
u£r•a˚_ö_sync
,

874 .
	gÊush
 = 
u£r•a˚_Êush
,

875 .
	gm¨k_ªgi⁄
 = 
u£r•a˚_m¨k_ªgi⁄
,

876 .
	g˛ór_ªgi⁄
 = 
u£r•a˚_˛ór_ªgi⁄
,

877 .
	ggë_ªsync_w‹k
 = 
u£r•a˚_gë_ªsync_w‹k
,

878 .
	g£t_ªgi⁄_sync
 = 
u£r•a˚_£t_ªgi⁄_sync
,

879 .
	ggë_sync_cou¡
 = 
u£r•a˚_gë_sync_cou¡
,

880 .
	g°©us
 = 
u£r•a˚_°©us
,

881 .
	gis_ªmŸe_ªcovîög
 = 
u£r•a˚_is_ªmŸe_ªcovîög
,

884 
__öô
 
	$u£r•a˚_dúty_log_öô
()

886 
r
 = 0;

888 
Êush_íåy_poﬁ
 = 
	`mempoﬁ_¸óã
(100, 
Êush_íåy_Æloc
,

889 
Êush_íåy_‰ì
, 
NULL
);

891 i‡(!
Êush_íåy_poﬁ
) {

892 
	`DMWARN
("UnableÅo create flush_entry_pool: No memory.");

893  -
ENOMEM
;

896 
r
 = 
	`dm_ulog_t‰_öô
();

897 i‡(
r
) {

898 
	`DMWARN
("UnableÅo initialize userspaceÜog communications");

899 
	`mempoﬁ_de°roy
(
Êush_íåy_poﬁ
);

900  
r
;

903 
r
 = 
	`dm_dúty_log_ty≥_ªgi°î
(&
_u£r•a˚_ty≥
);

904 i‡(
r
) {

905 
	`DMWARN
("Couldn'tÑegister userspace dirtyÜogÅype");

906 
	`dm_ulog_t‰_exô
();

907 
	`mempoﬁ_de°roy
(
Êush_íåy_poﬁ
);

908  
r
;

911 
	`DMINFO
("vîsi⁄ " 
DM_LOG_USERSPACE_VSN
 "Üoaded");

913 
	}
}

915 
__exô
 
	$u£r•a˚_dúty_log_exô
()

917 
	`dm_dúty_log_ty≥_uƒegi°î
(&
_u£r•a˚_ty≥
);

918 
	`dm_ulog_t‰_exô
();

919 
	`mempoﬁ_de°roy
(
Êush_íåy_poﬁ
);

921 
	`DMINFO
("vîsi⁄ " 
DM_LOG_USERSPACE_VSN
 " unloaded");

923 
	}
}

925 
moduÀ_öô
(
u£r•a˚_dúty_log_öô
);

926 
moduÀ_exô
(
u£r•a˚_dúty_log_exô
);

928 
MODULE_DESCRIPTION
(
DM_NAME
 " userspace dirtyÜogÜink");

929 
MODULE_AUTHOR
("Jonathan Brassow <dm-devel@redhat.com>");

930 
MODULE_LICENSE
("GPL");

	@dm-log-userspace-transfer.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/¶ab.h
>

10 
	~<√t/sock.h
>

11 
	~<löux/w‹kqueue.h
>

12 
	~<löux/c⁄√˘‹.h
>

13 
	~<löux/devi˚-m≠≥r.h
>

14 
	~<löux/dm-log-u£r•a˚.h
>

16 
	~"dm-log-u£r•a˚-å™s„r.h
"

18 
uöt32_t
 
	gdm_ulog_£q
;

26 
	#DM_ULOG_RETRY_TIMEOUT
 (15 * 
HZ
)

	)

31 
	#DM_ULOG_PREALLOCED_SIZE
 512

	)

32 
˙_msg
 *
	g¥óŒo˚d_˙_msg
;

33 
dm_ulog_ªque°
 *
	g¥óŒo˚d_ulog_t‰
;

35 
cb_id
 
	gulog_˙_id
 = {

36 .
idx
 = 
CN_IDX_DM
,

37 .
	gvÆ
 = 
CN_VAL_DM_USERSPACE_LOG


40 
DEFINE_MUTEX
(
dm_ulog_lock
);

42 
	sª˚ivög_pkg
 {

43 
li°_hód
 
	mli°
;

44 
com∂ëi⁄
 
	mcom∂ëe
;

46 
uöt32_t
 
	m£q
;

48 
	mîr‹
;

49 
size_t
 *
	md©a_size
;

50 *
	md©a
;

53 
DEFINE_SPINLOCK
(
ª˚ivög_li°_lock
);

54 
li°_hód
 
	gª˚ivög_li°
;

56 
	$dm_ulog_£ndto_£rvî
(
dm_ulog_ªque°
 *
t‰
)

58 
r
;

59 
˙_msg
 *
msg
 = 
¥óŒo˚d_˙_msg
;

61 
	`mem£t
(
msg
, 0, (
˙_msg
));

63 
msg
->
id
.
idx
 = 
ulog_˙_id
.idx;

64 
msg
->
id
.
vÆ
 = 
ulog_˙_id
.val;

65 
msg
->
ack
 = 0;

66 
msg
->
£q
 = 
t‰
->seq;

67 
msg
->
Àn
 = (
dm_ulog_ªque°
Ë+ 
t‰
->
d©a_size
;

69 
r
 = 
	`˙_√éök_£nd
(
msg
, 0, 0, 
	`gÂ_™y
());

71  
r
;

72 
	}
}

82 
	$fûl_pkg
(
˙_msg
 *
msg
, 
dm_ulog_ªque°
 *
t‰
)

84 
uöt32_t
 
πn_£q
 = (
msg
Ë? msg->
£q
 : (
t‰
) ?Åfr->seq : 0;

85 
ª˚ivög_pkg
 *
pkg
;

97 
	`li°_f‹_óch_íåy
(
pkg
, &
ª˚ivög_li°
, 
li°
) {

98 i‡(
πn_£q
 !
pkg
->
£q
)

101 i‡(
msg
) {

102 
pkg
->
îr‹
 = -
msg
->
ack
;

108 i‡(
pkg
->
îr‹
 !-
EAGAIN
)

109 *(
pkg
->
d©a_size
) = 0;

110 } i‡(
t‰
->
d©a_size
 > *(
pkg
->data_size)) {

111 
	`DMERR
("Insufficient spaceÅoÑeceiveÖackage [%u] "

112 "(%u v†%zu)", 
t‰
->
ªque°_ty≥
,

113 
t‰
->
d©a_size
, *(
pkg
->data_size));

115 *(
pkg
->
d©a_size
) = 0;

116 
pkg
->
îr‹
 = -
ENOSPC
;

118 
pkg
->
îr‹
 = 
t‰
->error;

119 
	`mem˝y
(
pkg
->
d©a
, 
t‰
->d©a,Å‰->
d©a_size
);

120 *(
pkg
->
d©a_size
Ë
t‰
->data_size;

122 
	`com∂ëe
(&
pkg
->
com∂ëe
);

126  -
ENOENT
;

127 
	}
}

133 
	$˙_ulog_ˇŒback
(
˙_msg
 *
msg
, 
√éök_skb_∑rms
 *
n•
)

135 
dm_ulog_ªque°
 *
t‰
 = (dm_ulog_ªque° *)(
msg
 + 1);

137 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

140 
	`•ö_lock
(&
ª˚ivög_li°_lock
);

141 i‡(
msg
->
Àn
 == 0)

142 
	`fûl_pkg
(
msg
, 
NULL
);

143 i‡(
msg
->
Àn
 < (*
t‰
))

144 
	`DMERR
("Incomplete messageÑeceived (expected %u, got %u): [%u]",

145 ()(*
t‰
), 
msg
->
Àn
, msg->
£q
);

147 
	`fûl_pkg
(
NULL
, 
t‰
);

148 
	`•ö_u∆ock
(&
ª˚ivög_li°_lock
);

149 
	}
}

170 
	$dm_c⁄su…_u£r•a˚
(c⁄° *
uuid
, 
uöt64_t
 
luid
, 
ªque°_ty≥
,

171 *
d©a
, 
size_t
 
d©a_size
,

172 *
rd©a
, 
size_t
 *
rd©a_size
)

174 
r
 = 0;

175 
size_t
 
dummy
 = 0;

176 
ovîhód_size
 = (
dm_ulog_ªque°
Ë+ (
˙_msg
);

177 
dm_ulog_ªque°
 *
t‰
 = 
¥óŒo˚d_ulog_t‰
;

178 
ª˚ivög_pkg
 
pkg
;

185 i‡(
d©a_size
 > (
DM_ULOG_PREALLOCED_SIZE
 - 
ovîhód_size
)) {

186 
	`DMINFO
("Size ofÅfrÉxceedsÖreallocated size");

187  -
EINVAL
;

190 i‡(!
rd©a_size
)

191 
rd©a_size
 = &
dummy
;

192 
ª£nd
:

197 
	`muãx_lock
(&
dm_ulog_lock
);

199 
	`mem£t
(
t‰
, 0, 
DM_ULOG_PREALLOCED_SIZE
 - (
˙_msg
));

200 
	`mem˝y
(
t‰
->
uuid
, uuid, 
DM_UUID_LEN
);

201 
t‰
->
vîsi⁄
 = 
DM_ULOG_REQUEST_VERSION
;

202 
t‰
->
luid
 =Üuid;

203 
t‰
->
£q
 = 
dm_ulog_£q
++;

210 
t‰
->
ªque°_ty≥
 =Ñeque°_ty≥ & 
DM_ULOG_REQUEST_MASK
;

212 
t‰
->
d©a_size
 = data_size;

213 i‡(
d©a
 && 
d©a_size
)

214 
	`mem˝y
(
t‰
->
d©a
, d©a, 
d©a_size
);

216 
	`mem£t
(&
pkg
, 0, (pkg));

217 
	`öô_com∂ëi⁄
(&
pkg
.
com∂ëe
);

218 
pkg
.
£q
 = 
t‰
->seq;

219 
pkg
.
d©a_size
 = 
rd©a_size
;

220 
pkg
.
d©a
 = 
rd©a
;

221 
	`•ö_lock
(&
ª˚ivög_li°_lock
);

222 
	`li°_add
(&(
pkg
.
li°
), &
ª˚ivög_li°
);

223 
	`•ö_u∆ock
(&
ª˚ivög_li°_lock
);

225 
r
 = 
	`dm_ulog_£ndto_£rvî
(
t‰
);

227 
	`muãx_u∆ock
(&
dm_ulog_lock
);

229 i‡(
r
) {

230 
	`DMERR
("UnableÅo sendÜogÑequest [%u]Åo userspace: %d",

231 
ªque°_ty≥
, 
r
);

232 
	`•ö_lock
(&
ª˚ivög_li°_lock
);

233 
	`li°_dñ_öô
(&(
pkg
.
li°
));

234 
	`•ö_u∆ock
(&
ª˚ivög_li°_lock
);

236 
out
;

239 
r
 = 
	`waô_f‹_com∂ëi⁄_timeout
(&(
pkg
.
com∂ëe
), 
DM_ULOG_RETRY_TIMEOUT
);

240 
	`•ö_lock
(&
ª˚ivög_li°_lock
);

241 
	`li°_dñ_öô
(&(
pkg
.
li°
));

242 
	`•ö_u∆ock
(&
ª˚ivög_li°_lock
);

243 i‡(!
r
) {

244 
	`DMWARN
("[%s] RequestÅimed out: [%u/%u] -Ñetrying",

245 (
	`°æí
(
uuid
) > 8) ?

246 (
uuid
 + (
	`°æí
(uuid) - 8)) : (uuid),

247 
ªque°_ty≥
, 
pkg
.
£q
);

248 
ª£nd
;

251 
r
 = 
pkg
.
îr‹
;

252 i‡(
r
 =-
EAGAIN
)

253 
ª£nd
;

255 
out
:

256  
r
;

257 
	}
}

259 
	$dm_ulog_t‰_öô
()

261 
r
;

262 *
¥óŒo˚d
;

264 
	`INIT_LIST_HEAD
(&
ª˚ivög_li°
);

266 
¥óŒo˚d
 = 
	`kmÆloc
(
DM_ULOG_PREALLOCED_SIZE
, 
GFP_KERNEL
);

267 i‡(!
¥óŒo˚d
)

268  -
ENOMEM
;

270 
¥óŒo˚d_˙_msg
 = 
¥óŒo˚d
;

271 
¥óŒo˚d_ulog_t‰
 = 
¥óŒo˚d
 + (
˙_msg
);

273 
r
 = 
	`˙_add_ˇŒback
(&
ulog_˙_id
, "dmlogu§", 
˙_ulog_ˇŒback
);

274 i‡(
r
) {

275 
	`˙_dñ_ˇŒback
(&
ulog_˙_id
);

276  
r
;

280 
	}
}

282 
	$dm_ulog_t‰_exô
()

284 
	`˙_dñ_ˇŒback
(&
ulog_˙_id
);

285 
	`k‰ì
(
¥óŒo˚d_˙_msg
);

286 
	}
}

	@dm-log-userspace-transfer.h

7 #i‚de‡
__DM_LOG_USERSPACE_TRANSFER_H__


8 
	#__DM_LOG_USERSPACE_TRANSFER_H__


	)

10 
	#DM_MSG_PREFIX
 "dm-log-u£r•a˚"

	)

12 
dm_ulog_t‰_öô
();

13 
dm_ulog_t‰_exô
();

14 
dm_c⁄su…_u£r•a˚
(c⁄° *
uuid
, 
uöt64_t
 
luid
, 
ªque°_ty≥
,

15 *
d©a
, 
size_t
 
d©a_size
,

16 *
rd©a
, 
size_t
 *
rd©a_size
);

	@dm-log-userspace.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

24 { 0x109065dc, 
__VMLINUX_SYMBOL_STR
(
˙_add_ˇŒback
) },

25 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

26 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

27 { 0x349cba85, 
__VMLINUX_SYMBOL_STR
(
°rchr
) },

28 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
°æí
) },

29 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

30 { 0xc4649b54, 
__VMLINUX_SYMBOL_STR
(
dm_dúty_log_ty≥_uƒegi°î
) },

31 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

32 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

33 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

34 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

35 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

36 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

37 { 0x4629334c, 
__VMLINUX_SYMBOL_STR
(
__¥ìm±_cou¡
) },

38 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

39 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

40 { 0xff5a8c„, 
__VMLINUX_SYMBOL_STR
(
˙_dñ_ˇŒback
) },

41 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

42 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

43 { 0x5991219c, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k
) },

44 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

45 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

46 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

47 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

48 { 0x9166Áda, 
__VMLINUX_SYMBOL_STR
(
°∫˝y
) },

49 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

50 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

51 { 0xc8de802f, 
__VMLINUX_SYMBOL_STR
(
˙_√éök_£nd
) },

52 { 0xc6cbbc89, 
__VMLINUX_SYMBOL_STR
(
ˇ∑bÀ
) },

53 { 0x7cfbØ67, 
__VMLINUX_SYMBOL_STR
(
dm_dúty_log_ty≥_ªgi°î
) },

54 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

55 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

56 { 0xd62c833f, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout
) },

57 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

58 { 0x8e332829, 
__VMLINUX_SYMBOL_STR
(
Êush_dñayed_w‹k
) },

59 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

60 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

61 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

62 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

63 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

64 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

65 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

66 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

67 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

68 { 0x4b06d2e7, 
__VMLINUX_SYMBOL_STR
(
com∂ëe
) },

69 { 0x53f6ffbc, 
__VMLINUX_SYMBOL_STR
(
waô_f‹_com∂ëi⁄_timeout
) },

72 c⁄° 
	g__moduÀ_dïíds
[]

73 
__u£d


74 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

78 
MODULE_INFO
(
§cvîsi⁄
, "EB5F66A46B428F1685BB4C6");

	@dm-log.c

8 
	~<löux/öô.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/vmÆloc.h
>

12 
	~<löux/dm-io.h
>

13 
	~<löux/dm-dúty-log.h
>

15 
	~<löux/devi˚-m≠≥r.h
>

17 
	#DM_MSG_PREFIX
 "dútyÑegi⁄Üog"

	)

19 
LIST_HEAD
(
_log_ty≥s
);

20 
DEFINE_SPINLOCK
(
_lock
);

22 
dm_dúty_log_ty≥
 *
	$__föd_dúty_log_ty≥
(c⁄° *
«me
)

24 
dm_dúty_log_ty≥
 *
log_ty≥
;

26 
	`li°_f‹_óch_íåy
(
log_ty≥
, &
_log_ty≥s
, 
li°
)

27 i‡(!
	`°rcmp
(
«me
, 
log_ty≥
->name))

28  
log_ty≥
;

30  
NULL
;

31 
	}
}

33 
dm_dúty_log_ty≥
 *
	$_gë_dúty_log_ty≥
(c⁄° *
«me
)

35 
dm_dúty_log_ty≥
 *
log_ty≥
;

37 
	`•ö_lock
(&
_lock
);

39 
log_ty≥
 = 
	`__föd_dúty_log_ty≥
(
«me
);

40 i‡(
log_ty≥
 && !
	`åy_moduÀ_gë
÷og_ty≥->
moduÀ
))

41 
log_ty≥
 = 
NULL
;

43 
	`•ö_u∆ock
(&
_lock
);

45  
log_ty≥
;

46 
	}
}

65 
dm_dúty_log_ty≥
 *
	$gë_ty≥
(c⁄° *
ty≥_«me
)

67 *
p
, *
ty≥_«me_dup
;

68 
dm_dúty_log_ty≥
 *
log_ty≥
;

70 i‡(!
ty≥_«me
)

71  
NULL
;

73 
log_ty≥
 = 
	`_gë_dúty_log_ty≥
(
ty≥_«me
);

74 i‡(
log_ty≥
)

75  
log_ty≥
;

77 
ty≥_«me_dup
 = 
	`k°rdup
(
ty≥_«me
, 
GFP_KERNEL
);

78 i‡(!
ty≥_«me_dup
) {

79 
	`DMWARN
("No memoryÜeftÅoáttemptÜog moduleÜoad for \"%s\"",

80 
ty≥_«me
);

81  
NULL
;

84 
	`ªque°_moduÀ
("dm-log-%s", 
ty≥_«me_dup
) ||

85 !(
log_ty≥
 = 
	`_gë_dúty_log_ty≥
(
ty≥_«me
))) {

86 
p
 = 
	`°ºchr
(
ty≥_«me_dup
, '-');

87 i‡(!
p
)

89 
p
[0] = '\0';

92 i‡(!
log_ty≥
)

93 
	`DMWARN
("ModuÀ f‹ÜoggögÅy≥ \"%s\"ÇŸ found.", 
ty≥_«me
);

95 
	`k‰ì
(
ty≥_«me_dup
);

97  
log_ty≥
;

98 
	}
}

100 
	$put_ty≥
(
dm_dúty_log_ty≥
 *
ty≥
)

102 i‡(!
ty≥
)

105 
	`•ö_lock
(&
_lock
);

106 i‡(!
	`__föd_dúty_log_ty≥
(
ty≥
->
«me
))

107 
out
;

109 
	`moduÀ_put
(
ty≥
->
moduÀ
);

111 
out
:

112 
	`•ö_u∆ock
(&
_lock
);

113 
	}
}

115 
	$dm_dúty_log_ty≥_ªgi°î
(
dm_dúty_log_ty≥
 *
ty≥
)

117 
r
 = 0;

119 
	`•ö_lock
(&
_lock
);

120 i‡(!
	`__föd_dúty_log_ty≥
(
ty≥
->
«me
))

121 
	`li°_add
(&
ty≥
->
li°
, &
_log_ty≥s
);

123 
r
 = -
EEXIST
;

124 
	`•ö_u∆ock
(&
_lock
);

126  
r
;

127 
	}
}

128 
EXPORT_SYMBOL
(
dm_dúty_log_ty≥_ªgi°î
);

130 
	$dm_dúty_log_ty≥_uƒegi°î
(
dm_dúty_log_ty≥
 *
ty≥
)

132 
	`•ö_lock
(&
_lock
);

134 i‡(!
	`__föd_dúty_log_ty≥
(
ty≥
->
«me
)) {

135 
	`•ö_u∆ock
(&
_lock
);

136  -
EINVAL
;

139 
	`li°_dñ
(&
ty≥
->
li°
);

141 
	`•ö_u∆ock
(&
_lock
);

144 
	}
}

145 
EXPORT_SYMBOL
(
dm_dúty_log_ty≥_uƒegi°î
);

147 
dm_dúty_log
 *
dm_dúty_log_¸óã
(c⁄° *
ty≥_«me
,

148 
dm_èrgë
 *
ti
,

149 (*
Êush_ˇŒback_‚
)(
dm_èrgë
 *
ti
),

150 
¨gc
, **
¨gv
)

152 
dm_dúty_log_ty≥
 *
ty≥
;

153 
dm_dúty_log
 *
log
;

155 
log
 = 
	`kmÆloc
((*log), 
GFP_KERNEL
);

156 i‡(!
log
)

157  
NULL
;

159 
ty≥
 = 
	`gë_ty≥
(
ty≥_«me
);

160 i‡(!
ty≥
) {

161 
	`k‰ì
(
log
);

162  
NULL
;

165 
log
->
Êush_ˇŒback_‚
 = flush_callback_fn;

166 
log
->
ty≥
 =Åype;

167 i‡(
ty≥
->
	`˘r
(
log
, 
ti
, 
¨gc
, 
¨gv
)) {

168 
	`k‰ì
(
log
);

169 
	`put_ty≥
(
ty≥
);

170  
NULL
;

173  
log
;

174 
	}
}

175 
EXPORT_SYMBOL
(
dm_dúty_log_¸óã
);

177 
	$dm_dúty_log_de°roy
(
dm_dúty_log
 *
log
)

179 
log
->
ty≥
->
	`då
(log);

180 
	`put_ty≥
(
log
->
ty≥
);

181 
	`k‰ì
(
log
);

182 
	}
}

183 
EXPORT_SYMBOL
(
dm_dúty_log_de°roy
);

192 
	#MIRROR_MAGIC
 0x4D695272

	)

197 
	#MIRROR_DISK_VERSION
 2

	)

198 
	#LOG_OFFSET
 2

	)

200 
	slog_hódî_disk
 {

201 
__À32
 
	mmagic
;

207 
__À32
 
	mvîsi⁄
;

208 
__À64
 
	mƒ_ªgi⁄s
;

209 } 
	g__∑cked
;

211 
	slog_hódî_c‹e
 {

212 
uöt32_t
 
	mmagic
;

213 
uöt32_t
 
	mvîsi⁄
;

214 
uöt64_t
 
	mƒ_ªgi⁄s
;

217 
	slog_c
 {

218 
dm_èrgë
 *
	mti
;

219 
	mtouched_dútõd
;

220 
	mtouched_˛ó√d
;

221 
	mÊush_Áûed
;

222 
uöt32_t
 
	mªgi⁄_size
;

223 
	mªgi⁄_cou¡
;

224 
ªgi⁄_t
 
	msync_cou¡
;

226 
	mbô£t_uöt32_cou¡
;

227 
uöt32_t
 *
	m˛ón_bôs
;

228 
uöt32_t
 *
	msync_bôs
;

229 
uöt32_t
 *
	mªcovîög_bôs
;

231 
	msync_£¨ch
;

234 
	esync
 {

235 
	mDEFAULTSYNC
,

236 
	mNOSYNC
,

237 
	mFORCESYNC
,

238 } 
	msync
;

240 
dm_io_ªque°
 
	mio_ªq
;

245 
	mlog_dev_Áûed
;

246 
	mlog_dev_Êush_Áûed
;

247 
dm_dev
 *
	mlog_dev
;

248 
log_hódî_c‹e
 
	mhódî
;

250 
dm_io_ªgi⁄
 
	mhódî_loˇti⁄
;

251 
log_hódî_disk
 *
	mdisk_hódî
;

258 
ölöe
 
	$log_ã°_bô
(
uöt32_t
 *
bs
, 
bô
)

260  
	`ã°_bô_À
(
bô
, 
bs
) ? 1 : 0;

261 
	}
}

263 
ölöe
 
	$log_£t_bô
(
log_c
 *
l
,

264 
uöt32_t
 *
bs
, 
bô
)

266 
	`__£t_bô_À
(
bô
, 
bs
);

267 
l
->
touched_˛ó√d
 = 1;

268 
	}
}

270 
ölöe
 
	$log_˛ór_bô
(
log_c
 *
l
,

271 
uöt32_t
 *
bs
, 
bô
)

273 
	`__˛ór_bô_À
(
bô
, 
bs
);

274 
l
->
touched_dútõd
 = 1;

275 
	}
}

280 
	$hódî_to_disk
(
log_hódî_c‹e
 *
c‹e
, 
log_hódî_disk
 *
disk
)

282 
disk
->
magic
 = 
	`˝u_to_À32
(
c‹e
->magic);

283 
disk
->
vîsi⁄
 = 
	`˝u_to_À32
(
c‹e
->version);

284 
disk
->
ƒ_ªgi⁄s
 = 
	`˝u_to_À64
(
c‹e
->nr_regions);

285 
	}
}

287 
	$hódî_‰om_disk
(
log_hódî_c‹e
 *
c‹e
, 
log_hódî_disk
 *
disk
)

289 
c‹e
->
magic
 = 
	`À32_to_˝u
(
disk
->magic);

290 
c‹e
->
vîsi⁄
 = 
	`À32_to_˝u
(
disk
->version);

291 
c‹e
->
ƒ_ªgi⁄s
 = 
	`À64_to_˝u
(
disk
->nr_regions);

292 
	}
}

294 
	$rw_hódî
(
log_c
 *
lc
, 
rw
)

296 
lc
->
io_ªq
.
bi_rw
 = 
rw
;

298  
	`dm_io
(&
lc
->
io_ªq
, 1, &lc->
hódî_loˇti⁄
, 
NULL
);

299 
	}
}

301 
	$Êush_hódî
(
log_c
 *
lc
)

303 
dm_io_ªgi⁄
 
nuŒ_loˇti⁄
 = {

304 .
bdev
 = 
lc
->
hódî_loˇti⁄
.bdev,

305 .
£˘‹
 = 0,

306 .
cou¡
 = 0,

309 
lc
->
io_ªq
.
bi_rw
 = 
WRITE_FLUSH
;

311  
	`dm_io
(&
lc
->
io_ªq
, 1, &
nuŒ_loˇti⁄
, 
NULL
);

312 
	}
}

314 
	$ªad_hódî
(
log_c
 *
log
)

316 
r
;

318 
r
 = 
	`rw_hódî
(
log
, 
READ
);

319 i‡(
r
)

320  
r
;

322 
	`hódî_‰om_disk
(&
log
->
hódî
,Üog->
disk_hódî
);

325 i‡(
log
->
sync
 !
DEFAULTSYNC
 ||Üog->
hódî
.
magic
 !
MIRROR_MAGIC
) {

326 
log
->
hódî
.
magic
 = 
MIRROR_MAGIC
;

327 
log
->
hódî
.
vîsi⁄
 = 
MIRROR_DISK_VERSION
;

328 
log
->
hódî
.
ƒ_ªgi⁄s
 = 0;

331 #ifde‡
__LITTLE_ENDIAN


332 i‡(
log
->
hódî
.
vîsi⁄
 == 1)

333 
log
->
hódî
.
vîsi⁄
 = 2;

336 i‡(
log
->
hódî
.
vîsi⁄
 !
MIRROR_DISK_VERSION
) {

337 
	`DMWARN
("incompatible diskÜog version");

338  -
EINVAL
;

342 
	}
}

344 
	$_check_ªgi⁄_size
(
dm_èrgë
 *
ti
, 
uöt32_t
 
ªgi⁄_size
)

346 i‡(
ªgi⁄_size
 < 2 ||Ñegi⁄_sizê> 
ti
->
Àn
)

349 i‡(!
	`is_powî_of_2
(
ªgi⁄_size
))

353 
	}
}

360 
	#BYTE_SHIFT
 3

	)

361 
	$¸óã_log_c⁄ãxt
(
dm_dúty_log
 *
log
, 
dm_èrgë
 *
ti
,

362 
¨gc
, **
¨gv
,

363 
dm_dev
 *
dev
)

365 
sync
 syn¯
DEFAULTSYNC
;

367 
log_c
 *
lc
;

368 
uöt32_t
 
ªgi⁄_size
;

369 
ªgi⁄_cou¡
;

370 
size_t
 
bô£t_size
, 
buf_size
;

371 
r
;

372 
dummy
;

374 i‡(
¨gc
 < 1 ||árgc > 2) {

375 
	`DMWARN
("wrongÇumber ofárgumentsÅo dirtyÑegionÜog");

376  -
EINVAL
;

379 i‡(
¨gc
 > 1) {

380 i‡(!
	`°rcmp
(
¨gv
[1], "sync"))

381 
sync
 = 
FORCESYNC
;

382 i‡(!
	`°rcmp
(
¨gv
[1], "nosync"))

383 
sync
 = 
NOSYNC
;

385 
	`DMWARN
("unrecognised syncárgumentÅo "

386 "dútyÑegi⁄Üog: %s", 
¨gv
[1]);

387  -
EINVAL
;

391 i‡(
	`ssˇnf
(
¨gv
[0], "%u%c", &
ªgi⁄_size
, &
dummy
) != 1 ||

392 !
	`_check_ªgi⁄_size
(
ti
, 
ªgi⁄_size
)) {

393 
	`DMWARN
("övÆidÑegi⁄ sizê%s", 
¨gv
[0]);

394  -
EINVAL
;

397 
ªgi⁄_cou¡
 = 
	`dm_£˘‹_div_up
(
ti
->
Àn
, 
ªgi⁄_size
);

399 
lc
 = 
	`kmÆloc
((*lc), 
GFP_KERNEL
);

400 i‡(!
lc
) {

401 
	`DMWARN
("couldn'tállocate coreÜog");

402  -
ENOMEM
;

405 
lc
->
ti
 =Åi;

406 
lc
->
touched_dútõd
 = 0;

407 
lc
->
touched_˛ó√d
 = 0;

408 
lc
->
Êush_Áûed
 = 0;

409 
lc
->
ªgi⁄_size
 =Ñegion_size;

410 
lc
->
ªgi⁄_cou¡
 =Ñegion_count;

411 
lc
->
sync
 = sync;

416 
bô£t_size
 = 
	`dm_round_up
(
ªgi⁄_cou¡
,

417 (*
lc
->
˛ón_bôs
Ë<< 
BYTE_SHIFT
);

418 
bô£t_size
 >>
BYTE_SHIFT
;

420 
lc
->
bô£t_uöt32_cou¡
 = 
bô£t_size
 / (*lc->
˛ón_bôs
);

425 i‡(!
dev
) {

426 
lc
->
˛ón_bôs
 = 
	`vmÆloc
(
bô£t_size
);

427 i‡(!
lc
->
˛ón_bôs
) {

428 
	`DMWARN
("couldn'tállocate clean bitset");

429 
	`k‰ì
(
lc
);

430  -
ENOMEM
;

432 
lc
->
disk_hódî
 = 
NULL
;

434 
lc
->
log_dev
 = 
dev
;

435 
lc
->
log_dev_Áûed
 = 0;

436 
lc
->
log_dev_Êush_Áûed
 = 0;

437 
lc
->
hódî_loˇti⁄
.
bdev
 =Üc->
log_dev
->bdev;

438 
lc
->
hódî_loˇti⁄
.
£˘‹
 = 0;

443 
buf_size
 =

444 
	`dm_round_up
((
LOG_OFFSET
 << 
SECTOR_SHIFT
Ë+ 
bô£t_size
,

445 
	`bdev_logiˇl_block_size
(
lc
->
hódî_loˇti⁄
.

446 
bdev
));

448 i‡(
buf_size
 > 
	`i_size_ªad
(
dev
->
bdev
->
bd_öode
)) {

449 
	`DMWARN
("log device %sÅoo small:Çeed %llu bytes",

450 
dev
->
«me
, ()
buf_size
);

451 
	`k‰ì
(
lc
);

452  -
EINVAL
;

455 
lc
->
hódî_loˇti⁄
.
cou¡
 = 
buf_size
 >> 
SECTOR_SHIFT
;

457 
lc
->
io_ªq
.
mem
.
ty≥
 = 
DM_IO_VMA
;

458 
lc
->
io_ªq
.
nŸify
.
‚
 = 
NULL
;

459 
lc
->
io_ªq
.
˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

460 i‡(
	`IS_ERR
(
lc
->
io_ªq
.
˛õ¡
)) {

461 
r
 = 
	`PTR_ERR
(
lc
->
io_ªq
.
˛õ¡
);

462 
	`DMWARN
("couldn'tállocate disk io client");

463 
	`k‰ì
(
lc
);

464  
r
;

467 
lc
->
disk_hódî
 = 
	`vmÆloc
(
buf_size
);

468 i‡(!
lc
->
disk_hódî
) {

469 
	`DMWARN
("couldn'tállocate diskÜog buffer");

470 
	`dm_io_˛õ¡_de°roy
(
lc
->
io_ªq
.
˛õ¡
);

471 
	`k‰ì
(
lc
);

472  -
ENOMEM
;

475 
lc
->
io_ªq
.
mem
.
±r
.
vma
 =Üc->
disk_hódî
;

476 
lc
->
˛ón_bôs
 = (*Óc->
disk_hódî
 +

477 (
LOG_OFFSET
 << 
SECTOR_SHIFT
);

480 
	`mem£t
(
lc
->
˛ón_bôs
, -1, 
bô£t_size
);

482 
lc
->
sync_bôs
 = 
	`vmÆloc
(
bô£t_size
);

483 i‡(!
lc
->
sync_bôs
) {

484 
	`DMWARN
("couldn'tállocate sync bitset");

485 i‡(!
dev
)

486 
	`v‰ì
(
lc
->
˛ón_bôs
);

488 
	`dm_io_˛õ¡_de°roy
(
lc
->
io_ªq
.
˛õ¡
);

489 
	`v‰ì
(
lc
->
disk_hódî
);

490 
	`k‰ì
(
lc
);

491  -
ENOMEM
;

493 
	`mem£t
(
lc
->
sync_bôs
, (
sync
 =
NOSYNC
Ë? -1 : 0, 
bô£t_size
);

494 
lc
->
sync_cou¡
 = (
sync
 =
NOSYNC
Ë? 
ªgi⁄_cou¡
 : 0;

496 
lc
->
ªcovîög_bôs
 = 
	`vzÆloc
(
bô£t_size
);

497 i‡(!
lc
->
ªcovîög_bôs
) {

498 
	`DMWARN
("couldn'tállocate sync bitset");

499 
	`v‰ì
(
lc
->
sync_bôs
);

500 i‡(!
dev
)

501 
	`v‰ì
(
lc
->
˛ón_bôs
);

503 
	`dm_io_˛õ¡_de°roy
(
lc
->
io_ªq
.
˛õ¡
);

504 
	`v‰ì
(
lc
->
disk_hódî
);

505 
	`k‰ì
(
lc
);

506  -
ENOMEM
;

508 
lc
->
sync_£¨ch
 = 0;

509 
log
->
c⁄ãxt
 = 
lc
;

512 
	}
}

514 
	$c‹e_˘r
(
dm_dúty_log
 *
log
, 
dm_èrgë
 *
ti
,

515 
¨gc
, **
¨gv
)

517  
	`¸óã_log_c⁄ãxt
(
log
, 
ti
, 
¨gc
, 
¨gv
, 
NULL
);

518 
	}
}

520 
	$de°roy_log_c⁄ãxt
(
log_c
 *
lc
)

522 
	`v‰ì
(
lc
->
sync_bôs
);

523 
	`v‰ì
(
lc
->
ªcovîög_bôs
);

524 
	`k‰ì
(
lc
);

525 
	}
}

527 
	$c‹e_då
(
dm_dúty_log
 *
log
)

529 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

531 
	`v‰ì
(
lc
->
˛ón_bôs
);

532 
	`de°roy_log_c⁄ãxt
(
lc
);

533 
	}
}

540 
	$disk_˘r
(
dm_dúty_log
 *
log
, 
dm_èrgë
 *
ti
,

541 
¨gc
, **
¨gv
)

543 
r
;

544 
dm_dev
 *
dev
;

546 i‡(
¨gc
 < 2 ||árgc > 3) {

547 
	`DMWARN
("wrongÇumber ofárgumentsÅo disk dirtyÑegionÜog");

548  -
EINVAL
;

551 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
dev
);

552 i‡(
r
)

553  
r
;

555 
r
 = 
	`¸óã_log_c⁄ãxt
(
log
, 
ti
, 
¨gc
 - 1, 
¨gv
 + 1, 
dev
);

556 i‡(
r
) {

557 
	`dm_put_devi˚
(
ti
, 
dev
);

558  
r
;

562 
	}
}

564 
	$disk_då
(
dm_dúty_log
 *
log
)

566 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

568 
	`dm_put_devi˚
(
lc
->
ti
,Üc->
log_dev
);

569 
	`v‰ì
(
lc
->
disk_hódî
);

570 
	`dm_io_˛õ¡_de°roy
(
lc
->
io_ªq
.
˛õ¡
);

571 
	`de°roy_log_c⁄ãxt
(
lc
);

572 
	}
}

574 
	$Áû_log_devi˚
(
log_c
 *
lc
)

576 i‡(
lc
->
log_dev_Áûed
)

579 
lc
->
log_dev_Áûed
 = 1;

580 
	`dm_èbÀ_evít
(
lc
->
ti
->
èbÀ
);

581 
	}
}

583 
	$disk_ªsume
(
dm_dúty_log
 *
log
)

585 
r
;

586 
i
;

587 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

588 
size_t
 
size
 = 
lc
->
bô£t_uöt32_cou¡
 * (
uöt32_t
);

591 
r
 = 
	`ªad_hódî
(
lc
);

592 i‡(
r
) {

593 
	`DMWARN
("%s: FailedÅoÑead header on dirtyÑegionÜog device",

594 
lc
->
log_dev
->
«me
);

595 
	`Áû_log_devi˚
(
lc
);

603 
lc
->
hódî
.
ƒ_ªgi⁄s
 = 0;

607 i‡(
lc
->
sync
 =
NOSYNC
)

608 
i
 = 
lc
->
hódî
.
ƒ_ªgi⁄s
; i <Üc->
ªgi⁄_cou¡
; i++)

610 
	`log_£t_bô
(
lc
,Üc->
˛ón_bôs
, 
i
);

612 
i
 = 
lc
->
hódî
.
ƒ_ªgi⁄s
; i <Üc->
ªgi⁄_cou¡
; i++)

614 
	`log_˛ór_bô
(
lc
,Üc->
˛ón_bôs
, 
i
);

617 
i
 = 
lc
->
ªgi⁄_cou¡
; i % ((*lc->
˛ón_bôs
Ë<< 
BYTE_SHIFT
); i++)

618 
	`log_˛ór_bô
(
lc
,Üc->
˛ón_bôs
, 
i
);

621 
	`mem˝y
(
lc
->
sync_bôs
,Üc->
˛ón_bôs
, 
size
);

622 
lc
->
sync_cou¡
 = 
	`memweight
÷c->
˛ón_bôs
,

623 
lc
->
bô£t_uöt32_cou¡
 * (
uöt32_t
));

624 
lc
->
sync_£¨ch
 = 0;

627 
lc
->
hódî
.
ƒ_ªgi⁄s
 =Üc->
ªgi⁄_cou¡
;

629 
	`hódî_to_disk
(&
lc
->
hódî
,Üc->
disk_hódî
);

632 
r
 = 
	`rw_hódî
(
lc
, 
WRITE
);

633 i‡(!
r
) {

634 
r
 = 
	`Êush_hódî
(
lc
);

635 i‡(
r
)

636 
lc
->
log_dev_Êush_Áûed
 = 1;

638 i‡(
r
) {

639 
	`DMWARN
("%s: FailedÅo write header on dirtyÑegionÜog device",

640 
lc
->
log_dev
->
«me
);

641 
	`Áû_log_devi˚
(
lc
);

644  
r
;

645 
	}
}

647 
uöt32_t
 
	$c‹e_gë_ªgi⁄_size
(
dm_dúty_log
 *
log
)

649 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

650  
lc
->
ªgi⁄_size
;

651 
	}
}

653 
	$c‹e_ªsume
(
dm_dúty_log
 *
log
)

655 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

656 
lc
->
sync_£¨ch
 = 0;

658 
	}
}

660 
	$c‹e_is_˛ón
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

662 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

663  
	`log_ã°_bô
(
lc
->
˛ón_bôs
, 
ªgi⁄
);

664 
	}
}

666 
	$c‹e_ö_sync
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
, 
block
)

668 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

669  
	`log_ã°_bô
(
lc
->
sync_bôs
, 
ªgi⁄
);

670 
	}
}

672 
	$c‹e_Êush
(
dm_dúty_log
 *
log
)

676 
	}
}

678 
	$disk_Êush
(
dm_dúty_log
 *
log
)

680 
r
, 
i
;

681 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

684 i‡(!
lc
->
touched_˛ó√d
 && !lc->
touched_dútõd
)

687 i‡(
lc
->
touched_˛ó√d
 && 
log
->
Êush_ˇŒback_‚
 &&

688 
log
->
	`Êush_ˇŒback_‚
(
lc
->
ti
)) {

695 
lc
->
Êush_Áûed
 = 1;

696 
i
 = 0; i < 
lc
->
ªgi⁄_cou¡
; i++)

697 
	`log_˛ór_bô
(
lc
,Üc->
˛ón_bôs
, 
i
);

700 
r
 = 
	`rw_hódî
(
lc
, 
WRITE
);

701 i‡(
r
)

702 
	`Áû_log_devi˚
(
lc
);

704 i‡(
lc
->
touched_dútõd
) {

705 
r
 = 
	`Êush_hódî
(
lc
);

706 i‡(
r
) {

707 
lc
->
log_dev_Êush_Áûed
 = 1;

708 
	`Áû_log_devi˚
(
lc
);

710 
lc
->
touched_dútõd
 = 0;

712 
lc
->
touched_˛ó√d
 = 0;

715  
r
;

716 
	}
}

718 
	$c‹e_m¨k_ªgi⁄
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

720 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

721 
	`log_˛ór_bô
(
lc
,Üc->
˛ón_bôs
, 
ªgi⁄
);

722 
	}
}

724 
	$c‹e_˛ór_ªgi⁄
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
)

726 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

727 i‡(
	`likñy
(!
lc
->
Êush_Áûed
))

728 
	`log_£t_bô
(
lc
,Üc->
˛ón_bôs
, 
ªgi⁄
);

729 
	}
}

731 
	$c‹e_gë_ªsync_w‹k
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 *
ªgi⁄
)

733 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

735 i‡(
lc
->
sync_£¨ch
 >lc->
ªgi⁄_cou¡
)

739 *
ªgi⁄
 = 
	`föd_√xt_zîo_bô_À
(
lc
->
sync_bôs
,

740 
lc
->
ªgi⁄_cou¡
,

741 
lc
->
sync_£¨ch
);

742 
lc
->
sync_£¨ch
 = *
ªgi⁄
 + 1;

744 i‡(*
ªgi⁄
 >
lc
->
ªgi⁄_cou¡
)

747 } 
	`log_ã°_bô
(
lc
->
ªcovîög_bôs
, *
ªgi⁄
));

749 
	`log_£t_bô
(
lc
,Üc->
ªcovîög_bôs
, *
ªgi⁄
);

751 
	}
}

753 
	$c‹e_£t_ªgi⁄_sync
(
dm_dúty_log
 *
log
, 
ªgi⁄_t
 
ªgi⁄
,

754 
ö_sync
)

756 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

758 
	`log_˛ór_bô
(
lc
,Üc->
ªcovîög_bôs
, 
ªgi⁄
);

759 i‡(
ö_sync
) {

760 
	`log_£t_bô
(
lc
,Üc->
sync_bôs
, 
ªgi⁄
);

761 
lc
->
sync_cou¡
++;

762 } i‡(
	`log_ã°_bô
(
lc
->
sync_bôs
, 
ªgi⁄
)) {

763 
lc
->
sync_cou¡
--;

764 
	`log_˛ór_bô
(
lc
,Üc->
sync_bôs
, 
ªgi⁄
);

766 
	}
}

768 
ªgi⁄_t
 
	$c‹e_gë_sync_cou¡
(
dm_dúty_log
 *
log
)

770 
log_c
 *
lc
 = (log_¯*Ë
log
->
c⁄ãxt
;

772  
lc
->
sync_cou¡
;

773 
	}
}

775 
	#DMEMIT_SYNC
 \

776 i‡(
lc
->
sync
 !
DEFAULTSYNC
) \

777 
	`DMEMIT
("%ssyn¯", 
lc
->
sync
 =
NOSYNC
 ? "no" : "")

	)

779 
	$c‹e_°©us
(
dm_dúty_log
 *
log
, 
°©us_ty≥_t
 
°©us
,

780 *
ªsu…
, 
maxÀn
)

782 
sz
 = 0;

783 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

785 
°©us
) {

786 
STATUSTYPE_INFO
:

787 
	`DMEMIT
("1 %s", 
log
->
ty≥
->
«me
);

790 
STATUSTYPE_TABLE
:

791 
	`DMEMIT
("%†%u %u ", 
log
->
ty≥
->
«me
,

792 
lc
->
sync
 =
DEFAULTSYNC
 ? 1 : 2,Üc->
ªgi⁄_size
);

793 
DMEMIT_SYNC
;

796  
sz
;

797 
	}
}

799 
	$disk_°©us
(
dm_dúty_log
 *
log
, 
°©us_ty≥_t
 
°©us
,

800 *
ªsu…
, 
maxÀn
)

802 
sz
 = 0;

803 
log_c
 *
lc
 = 
log
->
c⁄ãxt
;

805 
°©us
) {

806 
STATUSTYPE_INFO
:

807 
	`DMEMIT
("3 %†%†%c", 
log
->
ty≥
->
«me
, 
lc
->
log_dev
->name,

808 
lc
->
log_dev_Êush_Áûed
 ? 'F' :

809 
lc
->
log_dev_Áûed
 ? 'D' :

813 
STATUSTYPE_TABLE
:

814 
	`DMEMIT
("%†%u %†%u ", 
log
->
ty≥
->
«me
,

815 
lc
->
sync
 =
DEFAULTSYNC
 ? 2 : 3,Üc->
log_dev
->
«me
,

816 
lc
->
ªgi⁄_size
);

817 
DMEMIT_SYNC
;

820  
sz
;

821 
	}
}

823 
dm_dúty_log_ty≥
 
	g_c‹e_ty≥
 = {

824 .
«me
 = "core",

825 .
	gmoduÀ
 = 
THIS_MODULE
,

826 .
	g˘r
 = 
c‹e_˘r
,

827 .
	gdå
 = 
c‹e_då
,

828 .
	gªsume
 = 
c‹e_ªsume
,

829 .
	ggë_ªgi⁄_size
 = 
c‹e_gë_ªgi⁄_size
,

830 .
	gis_˛ón
 = 
c‹e_is_˛ón
,

831 .
	gö_sync
 = 
c‹e_ö_sync
,

832 .
	gÊush
 = 
c‹e_Êush
,

833 .
	gm¨k_ªgi⁄
 = 
c‹e_m¨k_ªgi⁄
,

834 .
	g˛ór_ªgi⁄
 = 
c‹e_˛ór_ªgi⁄
,

835 .
	ggë_ªsync_w‹k
 = 
c‹e_gë_ªsync_w‹k
,

836 .
	g£t_ªgi⁄_sync
 = 
c‹e_£t_ªgi⁄_sync
,

837 .
	ggë_sync_cou¡
 = 
c‹e_gë_sync_cou¡
,

838 .
	g°©us
 = 
c‹e_°©us
,

841 
dm_dúty_log_ty≥
 
	g_disk_ty≥
 = {

842 .
«me
 = "disk",

843 .
	gmoduÀ
 = 
THIS_MODULE
,

844 .
	g˘r
 = 
disk_˘r
,

845 .
	gdå
 = 
disk_då
,

846 .
	gpo°su•íd
 = 
disk_Êush
,

847 .
	gªsume
 = 
disk_ªsume
,

848 .
	ggë_ªgi⁄_size
 = 
c‹e_gë_ªgi⁄_size
,

849 .
	gis_˛ón
 = 
c‹e_is_˛ón
,

850 .
	gö_sync
 = 
c‹e_ö_sync
,

851 .
	gÊush
 = 
disk_Êush
,

852 .
	gm¨k_ªgi⁄
 = 
c‹e_m¨k_ªgi⁄
,

853 .
	g˛ór_ªgi⁄
 = 
c‹e_˛ór_ªgi⁄
,

854 .
	ggë_ªsync_w‹k
 = 
c‹e_gë_ªsync_w‹k
,

855 .
	g£t_ªgi⁄_sync
 = 
c‹e_£t_ªgi⁄_sync
,

856 .
	ggë_sync_cou¡
 = 
c‹e_gë_sync_cou¡
,

857 .
	g°©us
 = 
disk_°©us
,

860 
__öô
 
	$dm_dúty_log_öô
()

862 
r
;

864 
r
 = 
	`dm_dúty_log_ty≥_ªgi°î
(&
_c‹e_ty≥
);

865 i‡(
r
)

866 
	`DMWARN
("couldn'tÑegister coreÜog");

868 
r
 = 
	`dm_dúty_log_ty≥_ªgi°î
(&
_disk_ty≥
);

869 i‡(
r
) {

870 
	`DMWARN
("couldn'tÑegister diskÅype");

871 
	`dm_dúty_log_ty≥_uƒegi°î
(&
_c‹e_ty≥
);

874  
r
;

875 
	}
}

877 
__exô
 
	$dm_dúty_log_exô
()

879 
	`dm_dúty_log_ty≥_uƒegi°î
(&
_disk_ty≥
);

880 
	`dm_dúty_log_ty≥_uƒegi°î
(&
_c‹e_ty≥
);

881 
	}
}

883 
moduÀ_öô
(
dm_dúty_log_öô
);

884 
moduÀ_exô
(
dm_dúty_log_exô
);

886 
MODULE_DESCRIPTION
(
DM_NAME
 " dirtyÑegionÜog");

887 
MODULE_AUTHOR
("Joe Thornber, Heinz Mauelshagen <dm-devel@redhat.com>");

888 
MODULE_LICENSE
("GPL");

	@dm-log.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x402b8281, 
__VMLINUX_SYMBOL_STR
(
__ªque°_moduÀ
) },

24 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

25 { 0x3„2ccbe, 
__VMLINUX_SYMBOL_STR
(
memweight
) },

26 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

27 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

28 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

29 { 0x2b5a58a3, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

30 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

31 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

32 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

33 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

34 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

35 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

36 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

37 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

38 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

39 { 0x479c3c86, 
__VMLINUX_SYMBOL_STR
(
föd_√xt_zîo_bô
) },

40 { 0xbe0498f3, 
__VMLINUX_SYMBOL_STR
(
moduÀ_put
) },

41 { 0x9f984513, 
__VMLINUX_SYMBOL_STR
(
°ºchr
) },

42 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

43 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

44 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

45 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

46 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

47 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

48 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

49 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

50 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

51 { 0x8ó31722, 
__VMLINUX_SYMBOL_STR
(
åy_moduÀ_gë
) },

54 c⁄° 
	g__moduÀ_dïíds
[]

55 
__u£d


56 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

60 
MODULE_INFO
(
§cvîsi⁄
, "2520F689AFECC997AB36ADE");

	@dm-mirror.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x8487a2b6, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹k
) },

24 { 0x2d3385d3, 
__VMLINUX_SYMBOL_STR
(
sy°em_wq
) },

25 { 0xa83588eb, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªcovîy_íd
) },

26 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

27 { 0xÁd9d53a, 
__VMLINUX_SYMBOL_STR
(
dm_rh_gë_ªgi⁄_size
) },

28 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

29 { 0xa68e1f06, 
__VMLINUX_SYMBOL_STR
(
dm_rh_gë_°©e
) },

30 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

31 { 0x2b5a58a3, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

32 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

33 { 0x864a8d14, 
__VMLINUX_SYMBOL_STR
(
dm_rh_öc_≥ndög
) },

34 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

35 { 0xfc62ef4e, 
__VMLINUX_SYMBOL_STR
(
dm_rh_gë_ªgi⁄_key
) },

36 { 0x154c6338, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_de°roy
) },

37 { 0x6cb2a52c, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi⁄_hash_¸óã
) },

38 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

39 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

40 { 0xeˇb91e1, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_c›y
) },

41 { 0xd8Ø4284, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªgi⁄_c⁄ãxt
) },

42 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

43 { 0xa53387c7, 
__VMLINUX_SYMBOL_STR
(
dm_rh_Êush
) },

44 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

45 { 0x1d2f9ac, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªcovîy_°¨t
) },

46 { 0xbe38a431, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªcovîy_¥ï¨e
) },

47 { 0xdbccc8f9, 
__VMLINUX_SYMBOL_STR
(
dm_rh_bio_to_ªgi⁄
) },

48 { 0xd5f2172f, 
__VMLINUX_SYMBOL_STR
(
dñ_timî_sync
) },

49 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

50 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

51 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

52 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

53 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

54 { 0xb138d0bf, 
__VMLINUX_SYMBOL_STR
(
dm_øãlimô_°©e
) },

55 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

56 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

57 { 0xbe2c0274, 
__VMLINUX_SYMBOL_STR
(
add_timî
) },

58 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

59 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

60 { 0x7774620f, 
__VMLINUX_SYMBOL_STR
(
dm_rh_°›_ªcovîy
) },

61 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

62 { 0xeb184302, 
__VMLINUX_SYMBOL_STR
(
dm_rh_dúty_log
) },

63 { 0x4430764e, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªgi⁄_to_£˘‹
) },

64 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

65 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

66 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

67 { 0xd688716b, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_¸óã
) },

68 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

69 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

70 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

71 { 0x38eÁf5a, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi⁄_hash_de°roy
) },

72 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

73 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

74 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

75 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

76 { 0x2a5248ˇ, 
__VMLINUX_SYMBOL_STR
(
dm_rh_m¨k_nosync
) },

77 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

78 { 0x969e9378, 
__VMLINUX_SYMBOL_STR
(
dm_dúty_log_de°roy
) },

79 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

80 { 0x7d053fc5, 
__VMLINUX_SYMBOL_STR
(
dm_rh_°¨t_ªcovîy
) },

81 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

82 { 0x3a18389a, 
__VMLINUX_SYMBOL_STR
(
dm_rh_upd©e_°©es
) },

83 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

84 { 0x1008b78b, 
__VMLINUX_SYMBOL_STR
(
dm_noÊush_su•ídög
) },

85 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

86 { 0xfd93482e, 
__VMLINUX_SYMBOL_STR
(
dm_rh_ªcovîy_ö_Êight
) },

87 { 0x51dbbd0, 
__VMLINUX_SYMBOL_STR
(
dm_rh_dñay
) },

88 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

89 { 0x6óa3d4e, 
__VMLINUX_SYMBOL_STR
(
dm_dúty_log_¸óã
) },

90 { 0x45ab972a, 
__VMLINUX_SYMBOL_STR
(
dm_rh_dec
) },

93 c⁄° 
	g__moduÀ_dïíds
[]

94 
__u£d


95 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

99 
MODULE_INFO
(
§cvîsi⁄
, "F6EBBF529C0EB95C817EE2A");

	@dm-mpath.c

8 
	~<löux/devi˚-m≠≥r.h
>

10 
	~"dm.h
"

11 
	~"dm-∑th-£À˘‹.h
"

12 
	~"dm-uevít.h
"

14 
	~<löux/˘y≥.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/mempoﬁ.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/¶ab.h
>

20 
	~<löux/time.h
>

21 
	~<löux/w‹kqueue.h
>

22 
	~<löux/dñay.h
>

23 
	~<scsi/scsi_dh.h
>

24 
	~<löux/©omic.h
>

26 
	#DM_MSG_PREFIX
 "mu…ù©h"

	)

27 
	#DM_PG_INIT_DELAY_MSECS
 2000

	)

28 
	#DM_PG_INIT_DELAY_DEFAULT
 ((Ë-1)

	)

31 
	spg∑th
 {

32 
li°_hód
 
	mli°
;

34 
¥i‹ôy_group
 *
	mpg
;

35 
	mis_a˘ive
;

36 
	mÁû_cou¡
;

38 
dm_∑th
 
	m∑th
;

39 
dñayed_w‹k
 
	ma˘iv©e_∑th
;

42 
	#∑th_to_pg∑th
(
__pgp
Ë
	`c⁄èöî_of
((__pgp), 
pg∑th
, 
∑th
)

	)

48 
	s¥i‹ôy_group
 {

49 
li°_hód
 
	mli°
;

51 
mu…ù©h
 *
	mm
;

52 
∑th_£À˘‹
 
	mps
;

54 
	mpg_num
;

55 
	mby∑s£d
;

57 
	mƒ_pg∑ths
;

58 
li°_hód
 
	mpg∑ths
;

62 
	smu…ù©h
 {

63 
li°_hód
 
	mli°
;

64 
dm_èrgë
 *
	mti
;

66 c⁄° *
	mhw_h™dÀr_«me
;

67 *
	mhw_h™dÀr_∑øms
;

69 
•ölock_t
 
	mlock
;

71 
	mƒ_¥i‹ôy_groups
;

72 
li°_hód
 
	m¥i‹ôy_groups
;

74 
waô_queue_hód_t
 
	mpg_öô_waô
;

76 
	mpg_öô_ªquúed
;

77 
	mpg_öô_ö_¥ogªss
;

78 
	mpg_öô_dñay_ªåy
;

80 
	mƒ_vÆid_∑ths
;

81 
pg∑th
 *
	mcuºít_pg∑th
;

82 
¥i‹ôy_group
 *
	mcuºít_pg
;

83 
¥i‹ôy_group
 *
	m√xt_pg
;

84 
	mª≥©_cou¡
;

86 
	mqueue_io
:1;

87 
	mqueue_if_no_∑th
:1;

88 
	mßved_queue_if_no_∑th
:1;

89 
	mªèö_©èched_hw_h™dÀr
:1;

90 
	mpg_öô_dißbÀd
:1;

92 
	mpg_öô_ªåõs
;

93 
	mpg_öô_cou¡
;

94 
	mpg_öô_dñay_m£cs
;

96 
w‹k_°ru˘
 
	måiggî_evít
;

102 
mempoﬁ_t
 *
	mmpio_poﬁ
;

104 
muãx
 
	mw‹k_muãx
;

110 
	sdm_m∑th_io
 {

111 
pg∑th
 *
	mpg∑th
;

112 
size_t
 
	mƒ_byãs
;

115 (*
	ta˘i⁄_‚
Ë(
	tpg∑th
 *pgpath);

117 
kmem_ˇche
 *
_mpio_ˇche
;

119 
w‹kqueue_°ru˘
 *
kmu…ù©hd
, *
km∑th_h™dÀrd
;

120 
	`åiggî_evít
(
w‹k_°ru˘
 *
w‹k
);

121 
	`a˘iv©e_∑th
(
w‹k_°ru˘
 *
w‹k
);

122 
	`__pg∑th_busy
(
pg∑th
 *pgpath);

129 
pg∑th
 *
	$Æloc_pg∑th
()

131 
pg∑th
 *pg∑th = 
	`kzÆloc
((*pg∑th), 
GFP_KERNEL
);

133 i‡(
pg∑th
) {

134 
pg∑th
->
is_a˘ive
 = 1;

135 
	`INIT_DELAYED_WORK
(&
pg∑th
->
a˘iv©e_∑th
,áctivate_path);

138  
pg∑th
;

139 
	}
}

141 
	$‰ì_pg∑th
(
pg∑th
 *pgpath)

143 
	`k‰ì
(
pg∑th
);

144 
	}
}

146 
¥i‹ôy_group
 *
	$Æloc_¥i‹ôy_group
()

148 
¥i‹ôy_group
 *
pg
;

150 
pg
 = 
	`kzÆloc
((*pg), 
GFP_KERNEL
);

152 i‡(
pg
)

153 
	`INIT_LIST_HEAD
(&
pg
->
pg∑ths
);

155  
pg
;

156 
	}
}

158 
	$‰ì_pg∑ths
(
li°_hód
 *
pg∑ths
, 
dm_èrgë
 *
ti
)

160 
pg∑th
 *pg∑th, *
tmp
;

161 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

163 
	`li°_f‹_óch_íåy_ß„
(
pg∑th
, 
tmp
, 
pg∑ths
, 
li°
) {

164 
	`li°_dñ
(&
pg∑th
->
li°
);

165 i‡(
m
->
hw_h™dÀr_«me
)

166 
	`scsi_dh_dëach
(
	`bdev_gë_queue
(
pg∑th
->
∑th
.
dev
->
bdev
));

167 
	`dm_put_devi˚
(
ti
, 
pg∑th
->
∑th
.
dev
);

168 
	`‰ì_pg∑th
(
pg∑th
);

170 
	}
}

172 
	$‰ì_¥i‹ôy_group
(
¥i‹ôy_group
 *
pg
,

173 
dm_èrgë
 *
ti
)

175 
∑th_£À˘‹
 *
ps
 = &
pg
->ps;

177 i‡(
ps
->
ty≥
) {

178 
ps
->
ty≥
->
	`de°roy
(ps);

179 
	`dm_put_∑th_£À˘‹
(
ps
->
ty≥
);

182 
	`‰ì_pg∑ths
(&
pg
->
pg∑ths
, 
ti
);

183 
	`k‰ì
(
pg
);

184 
	}
}

186 
mu…ù©h
 *
	$Æloc_mu…ù©h
(
dm_èrgë
 *
ti
)

188 
mu…ù©h
 *
m
;

189 
mö_ios
 = 
	`dm_gë_ª£rved_rq_ba£d_ios
();

191 
m
 = 
	`kzÆloc
((*m), 
GFP_KERNEL
);

192 i‡(
m
) {

193 
	`INIT_LIST_HEAD
(&
m
->
¥i‹ôy_groups
);

194 
	`•ö_lock_öô
(&
m
->
lock
);

195 
m
->
queue_io
 = 1;

196 
m
->
pg_öô_dñay_m£cs
 = 
DM_PG_INIT_DELAY_DEFAULT
;

197 
	`INIT_WORK
(&
m
->
åiggî_evít
,Årigger_event);

198 
	`öô_waôqueue_hód
(&
m
->
pg_öô_waô
);

199 
	`muãx_öô
(&
m
->
w‹k_muãx
);

200 
m
->
mpio_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
mö_ios
, 
_mpio_ˇche
);

201 i‡(!
m
->
mpio_poﬁ
) {

202 
	`k‰ì
(
m
);

203  
NULL
;

205 
m
->
ti
 =Åi;

206 
ti
->
¥iv©e
 = 
m
;

209  
m
;

210 
	}
}

212 
	$‰ì_mu…ù©h
(
mu…ù©h
 *
m
)

214 
¥i‹ôy_group
 *
pg
, *
tmp
;

216 
	`li°_f‹_óch_íåy_ß„
(
pg
, 
tmp
, &
m
->
¥i‹ôy_groups
, 
li°
) {

217 
	`li°_dñ
(&
pg
->
li°
);

218 
	`‰ì_¥i‹ôy_group
(
pg
, 
m
->
ti
);

221 
	`k‰ì
(
m
->
hw_h™dÀr_«me
);

222 
	`k‰ì
(
m
->
hw_h™dÀr_∑øms
);

223 
	`mempoﬁ_de°roy
(
m
->
mpio_poﬁ
);

224 
	`k‰ì
(
m
);

225 
	}
}

227 
	$£t_m≠öfo
(
mu…ù©h
 *
m
, 
m≠_öfo
 *
öfo
)

229 
dm_m∑th_io
 *
mpio
;

231 
mpio
 = 
	`mempoﬁ_Æloc
(
m
->
mpio_poﬁ
, 
GFP_ATOMIC
);

232 i‡(!
mpio
)

233  -
ENOMEM
;

235 
	`mem£t
(
mpio
, 0, (*mpio));

236 
öfo
->
±r
 = 
mpio
;

239 
	}
}

241 
	$˛ór_m≠öfo
(
mu…ù©h
 *
m
, 
m≠_öfo
 *
öfo
)

243 
dm_m∑th_io
 *
mpio
 = 
öfo
->
±r
;

245 
öfo
->
±r
 = 
NULL
;

246 
	`mempoﬁ_‰ì
(
mpio
, 
m
->
mpio_poﬁ
);

247 
	}
}

253 
	$__pg_öô_Æl_∑ths
(
mu…ù©h
 *
m
)

255 
pg∑th
 *pgpath;

256 
pg_öô_dñay
 = 0;

258 i‡(
m
->
pg_öô_ö_¥ogªss
 || m->
pg_öô_dißbÀd
)

261 
m
->
pg_öô_cou¡
++;

262 
m
->
pg_öô_ªquúed
 = 0;

265 i‡(!
m
->
cuºít_pg
)

268 i‡(
m
->
pg_öô_dñay_ªåy
)

269 
pg_öô_dñay
 = 
	`m£cs_to_jiffõs
(
m
->
pg_öô_dñay_m£cs
 !
DM_PG_INIT_DELAY_DEFAULT
 ?

270 
m
->
pg_öô_dñay_m£cs
 : 
DM_PG_INIT_DELAY_MSECS
);

271 
	`li°_f‹_óch_íåy
(
pg∑th
, &
m
->
cuºít_pg
->
pg∑ths
, 
li°
) {

273 i‡(!
pg∑th
->
is_a˘ive
)

275 i‡(
	`queue_dñayed_w‹k
(
km∑th_h™dÀrd
, &
pg∑th
->
a˘iv©e_∑th
,

276 
pg_öô_dñay
))

277 
m
->
pg_öô_ö_¥ogªss
++;

279  
m
->
pg_öô_ö_¥ogªss
;

280 
	}
}

282 
	$__swôch_pg
(
mu…ù©h
 *
m
, 
pg∑th
 *pgpath)

284 
m
->
cuºít_pg
 = 
pg∑th
->
pg
;

287 i‡(
m
->
hw_h™dÀr_«me
) {

288 
m
->
pg_öô_ªquúed
 = 1;

289 
m
->
queue_io
 = 1;

291 
m
->
pg_öô_ªquúed
 = 0;

292 
m
->
queue_io
 = 0;

295 
m
->
pg_öô_cou¡
 = 0;

296 
	}
}

298 
	$__choo£_∑th_ö_pg
(
mu…ù©h
 *
m
, 
¥i‹ôy_group
 *
pg
,

299 
size_t
 
ƒ_byãs
)

301 
dm_∑th
 *
∑th
;

303 
∑th
 = 
pg
->
ps
.
ty≥
->
	`£À˘_∑th
(&pg->ps, &
m
->
ª≥©_cou¡
, 
ƒ_byãs
);

304 i‡(!
∑th
)

305  -
ENXIO
;

307 
m
->
cuºít_pg∑th
 = 
	`∑th_to_pg∑th
(
∑th
);

309 i‡(
m
->
cuºít_pg
 !
pg
)

310 
	`__swôch_pg
(
m
, m->
cuºít_pg∑th
);

313 
	}
}

315 
	$__choo£_pg∑th
(
mu…ù©h
 *
m
, 
size_t
 
ƒ_byãs
)

317 
¥i‹ôy_group
 *
pg
;

318 
by∑s£d
 = 1;

320 i‡(!
m
->
ƒ_vÆid_∑ths
) {

321 
m
->
queue_io
 = 0;

322 
Áûed
;

326 i‡(
m
->
√xt_pg
) {

327 
pg
 = 
m
->
√xt_pg
;

328 
m
->
√xt_pg
 = 
NULL
;

329 i‡(!
	`__choo£_∑th_ö_pg
(
m
, 
pg
, 
ƒ_byãs
))

334 i‡(
m
->
cuºít_pg
 && !
	`__choo£_∑th_ö_pg
(m, m->cuºít_pg, 
ƒ_byãs
))

344 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

345 i‡(
pg
->
by∑s£d
 == bypassed)

347 i‡(!
	`__choo£_∑th_ö_pg
(
m
, 
pg
, 
ƒ_byãs
)) {

348 i‡(!
by∑s£d
)

349 
m
->
pg_öô_dñay_ªåy
 = 1;

353 } 
by∑s£d
--);

355 
Áûed
:

356 
m
->
cuºít_pg∑th
 = 
NULL
;

357 
m
->
cuºít_pg
 = 
NULL
;

358 
	}
}

371 
	$__mu°_push_back
(
mu…ù©h
 *
m
)

373  (
m
->
queue_if_no_∑th
 ||

374 (
m
->
queue_if_no_∑th
 !m->
ßved_queue_if_no_∑th
 &&

375 
	`dm_noÊush_su•ídög
(
m
->
ti
)));

376 
	}
}

381 
	$mu…ù©h_m≠
(
dm_èrgë
 *
ti
, 
ªque°
 *
˛⁄e
,

382 
m≠_öfo
 *
m≠_c⁄ãxt
)

384 
mu…ù©h
 *
m
 = (mu…ù©h *Ë
ti
->
¥iv©e
;

385 
r
 = 
DM_MAPIO_REQUEUE
;

386 
size_t
 
ƒ_byãs
 = 
	`blk_rq_byãs
(
˛⁄e
);

387 
Êags
;

388 
pg∑th
 *pgpath;

389 
block_devi˚
 *
bdev
;

390 
dm_m∑th_io
 *
mpio
;

392 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

395 i‡(!
m
->
cuºít_pg∑th
 ||

396 (!
m
->
queue_io
 && (m->
ª≥©_cou¡
 && --m->repeat_count == 0)))

397 
	`__choo£_pg∑th
(
m
, 
ƒ_byãs
);

399 
pg∑th
 = 
m
->
cuºít_pg∑th
;

401 i‡(!
pg∑th
) {

402 i‡(!
	`__mu°_push_back
(
m
))

403 
r
 = -
EIO
;

404 
out_u∆ock
;

405 } i‡(
m
->
queue_io
 || m->
pg_öô_ªquúed
) {

406 
	`__pg_öô_Æl_∑ths
(
m
);

407 
out_u∆ock
;

410 i‡(
	`£t_m≠öfo
(
m
, 
m≠_c⁄ãxt
) < 0)

412 
out_u∆ock
;

414 
bdev
 = 
pg∑th
->
∑th
.
dev
->bdev;

415 
˛⁄e
->
q
 = 
	`bdev_gë_queue
(
bdev
);

416 
˛⁄e
->
rq_disk
 = 
bdev
->
bd_disk
;

417 
˛⁄e
->
cmd_Êags
 |
REQ_FAILFAST_TRANSPORT
;

418 
mpio
 = 
m≠_c⁄ãxt
->
±r
;

419 
mpio
->
pg∑th
 =Ögpath;

420 
mpio
->
ƒ_byãs
 =Çr_bytes;

421 i‡(
pg∑th
->
pg
->
ps
.
ty≥
->
°¨t_io
)

422 
pg∑th
->
pg
->
ps
.
ty≥
->
	`°¨t_io
(&pgpath->pg->ps,

423 &
pg∑th
->
∑th
,

424 
ƒ_byãs
);

425 
r
 = 
DM_MAPIO_REMAPPED
;

427 
out_u∆ock
:

428 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

430  
r
;

431 
	}
}

436 
	$queue_if_no_∑th
(
mu…ù©h
 *
m
, 
queue_if_no_∑th
,

437 
ßve_ﬁd_vÆue
)

439 
Êags
;

441 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

443 i‡(
ßve_ﬁd_vÆue
)

444 
m
->
ßved_queue_if_no_∑th
 = m->
queue_if_no_∑th
;

446 
m
->
ßved_queue_if_no_∑th
 = 
queue_if_no_∑th
;

447 
m
->
queue_if_no_∑th
 = queue_if_no_path;

448 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

450 i‡(!
queue_if_no_∑th
)

451 
	`dm_èbÀ_run_md_queue_async
(
m
->
ti
->
èbÀ
);

454 
	}
}

460 
	$åiggî_evít
(
w‹k_°ru˘
 *
w‹k
)

462 
mu…ù©h
 *
m
 =

463 
	`c⁄èöî_of
(
w‹k
, 
mu…ù©h
, 
åiggî_evít
);

465 
	`dm_èbÀ_evít
(
m
->
ti
->
èbÀ
);

466 
	}
}

478 
	$∑r£_∑th_£À˘‹
(
dm_¨g_£t
 *
as
, 
¥i‹ôy_group
 *
pg
,

479 
dm_èrgë
 *
ti
)

481 
r
;

482 
∑th_£À˘‹_ty≥
 *
p°
;

483 
ps_¨gc
;

485 
dm_¨g
 
_¨gs
[] = {

489 
p°
 = 
	`dm_gë_∑th_£À˘‹
(
	`dm_shi·_¨g
(
as
));

490 i‡(!
p°
) {

491 
ti
->
îr‹
 = "unknownÖath selectorÅype";

492  -
EINVAL
;

495 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
ps_¨gc
, &
ti
->
îr‹
);

496 i‡(
r
) {

497 
	`dm_put_∑th_£À˘‹
(
p°
);

498  -
EINVAL
;

501 
r
 = 
p°
->
	`¸óã
(&
pg
->
ps
, 
ps_¨gc
, 
as
->
¨gv
);

502 i‡(
r
) {

503 
	`dm_put_∑th_£À˘‹
(
p°
);

504 
ti
->
îr‹
 = "path selector constructor failed";

505  
r
;

508 
pg
->
ps
.
ty≥
 = 
p°
;

509 
	`dm_c⁄sume_¨gs
(
as
, 
ps_¨gc
);

512 
	}
}

514 
pg∑th
 *
	$∑r£_∑th
(
dm_¨g_£t
 *
as
, 
∑th_£À˘‹
 *
ps
,

515 
dm_èrgë
 *
ti
)

517 
r
;

518 
pg∑th
 *
p
;

519 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

520 
ªque°_queue
 *
q
 = 
NULL
;

521 c⁄° *
©èched_h™dÀr_«me
;

524 i‡(
as
->
¨gc
 < 1) {

525 
ti
->
îr‹
 = "no device given";

526  
	`ERR_PTR
(-
EINVAL
);

529 
p
 = 
	`Æloc_pg∑th
();

530 i‡(!
p
)

531  
	`ERR_PTR
(-
ENOMEM
);

533 
r
 = 
	`dm_gë_devi˚
(
ti
, 
	`dm_shi·_¨g
(
as
), 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

534 &
p
->
∑th
.
dev
);

535 i‡(
r
) {

536 
ti
->
îr‹
 = "error getting device";

537 
bad
;

540 i‡(
m
->
ªèö_©èched_hw_h™dÀr
 || m->
hw_h™dÀr_«me
)

541 
q
 = 
	`bdev_gë_queue
(
p
->
∑th
.
dev
->
bdev
);

543 i‡(
m
->
ªèö_©èched_hw_h™dÀr
) {

544 
©èched_h™dÀr_«me
 = 
	`scsi_dh_©èched_h™dÀr_«me
(
q
, 
GFP_KERNEL
);

545 i‡(
©èched_h™dÀr_«me
) {

554 
	`k‰ì
(
m
->
hw_h™dÀr_«me
);

555 
m
->
hw_h™dÀr_«me
 = 
©èched_h™dÀr_«me
;

557 
	`k‰ì
(
m
->
hw_h™dÀr_∑øms
);

558 
m
->
hw_h™dÀr_∑øms
 = 
NULL
;

562 i‡(
m
->
hw_h™dÀr_«me
) {

567 
r
 = 
	`scsi_dh_©èch
(
q
, 
m
->
hw_h™dÀr_«me
);

568 i‡(
r
 =-
EBUSY
) {

573 
	`scsi_dh_dëach
(
q
);

574 
r
 = 
	`scsi_dh_©èch
(
q
, 
m
->
hw_h™dÀr_«me
);

577 i‡(
r
 < 0) {

578 
ti
->
îr‹
 = "erroráttaching hardware handler";

579 
	`dm_put_devi˚
(
ti
, 
p
->
∑th
.
dev
);

580 
bad
;

583 i‡(
m
->
hw_h™dÀr_∑øms
) {

584 
r
 = 
	`scsi_dh_£t_∑øms
(
q
, 
m
->
hw_h™dÀr_∑øms
);

585 i‡(
r
 < 0) {

586 
ti
->
îr‹
 = "unableÅo set hardware "

588 
	`scsi_dh_dëach
(
q
);

589 
	`dm_put_devi˚
(
ti
, 
p
->
∑th
.
dev
);

590 
bad
;

595 
r
 = 
ps
->
ty≥
->
	`add_∑th
’s, &
p
->
∑th
, 
as
->
¨gc
,ás->
¨gv
, &
ti
->
îr‹
);

596 i‡(
r
) {

597 
	`dm_put_devi˚
(
ti
, 
p
->
∑th
.
dev
);

598 
bad
;

601  
p
;

603 
bad
:

604 
	`‰ì_pg∑th
(
p
);

605  
	`ERR_PTR
(
r
);

606 
	}
}

608 
¥i‹ôy_group
 *
	$∑r£_¥i‹ôy_group
(
dm_¨g_£t
 *
as
,

609 
mu…ù©h
 *
m
)

611 
dm_¨g
 
_¨gs
[] = {

616 
r
;

617 
i
, 
ƒ_£À˘‹_¨gs
, 
ƒ_¨gs
;

618 
¥i‹ôy_group
 *
pg
;

619 
dm_èrgë
 *
ti
 = 
m
->ti;

621 i‡(
as
->
¨gc
 < 2) {

622 
as
->
¨gc
 = 0;

623 
ti
->
îr‹
 = "notÉnoughÖriority groupárguments";

624  
	`ERR_PTR
(-
EINVAL
);

627 
pg
 = 
	`Æloc_¥i‹ôy_group
();

628 i‡(!
pg
) {

629 
ti
->
îr‹
 = "couldn'tállocateÖriority group";

630  
	`ERR_PTR
(-
ENOMEM
);

632 
pg
->
m
 = m;

634 
r
 = 
	`∑r£_∑th_£À˘‹
(
as
, 
pg
, 
ti
);

635 i‡(
r
)

636 
bad
;

641 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, 
as
, &
pg
->
ƒ_pg∑ths
, &
ti
->
îr‹
);

642 i‡(
r
)

643 
bad
;

645 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 1, 
as
, &
ƒ_£À˘‹_¨gs
, &
ti
->
îr‹
);

646 i‡(
r
)

647 
bad
;

649 
ƒ_¨gs
 = 1 + 
ƒ_£À˘‹_¨gs
;

650 
i
 = 0; i < 
pg
->
ƒ_pg∑ths
; i++) {

651 
pg∑th
 *pgpath;

652 
dm_¨g_£t
 
∑th_¨gs
;

654 i‡(
as
->
¨gc
 < 
ƒ_¨gs
) {

655 
ti
->
îr‹
 = "notÉnoughÖathÖarameters";

656 
r
 = -
EINVAL
;

657 
bad
;

660 
∑th_¨gs
.
¨gc
 = 
ƒ_¨gs
;

661 
∑th_¨gs
.
¨gv
 = 
as
->argv;

663 
pg∑th
 = 
	`∑r£_∑th
(&
∑th_¨gs
, &
pg
->
ps
, 
ti
);

664 i‡(
	`IS_ERR
(
pg∑th
)) {

665 
r
 = 
	`PTR_ERR
(
pg∑th
);

666 
bad
;

669 
pg∑th
->
pg
 =Ög;

670 
	`li°_add_èû
(&
pg∑th
->
li°
, &
pg
->
pg∑ths
);

671 
	`dm_c⁄sume_¨gs
(
as
, 
ƒ_¨gs
);

674  
pg
;

676 
bad
:

677 
	`‰ì_¥i‹ôy_group
(
pg
, 
ti
);

678  
	`ERR_PTR
(
r
);

679 
	}
}

681 
	$∑r£_hw_h™dÀr
(
dm_¨g_£t
 *
as
, 
mu…ù©h
 *
m
)

683 
hw_¨gc
;

684 
ªt
;

685 
dm_èrgë
 *
ti
 = 
m
->ti;

687 
dm_¨g
 
_¨gs
[] = {

691 i‡(
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
hw_¨gc
, &
ti
->
îr‹
))

692  -
EINVAL
;

694 i‡(!
hw_¨gc
)

697 
m
->
hw_h™dÀr_«me
 = 
	`k°rdup
(
	`dm_shi·_¨g
(
as
), 
GFP_KERNEL
);

698 i‡(!
	`åy_thí_ªque°_moduÀ
(
	`scsi_dh_h™dÀr_exi°
(
m
->
hw_h™dÀr_«me
),

699 "scsi_dh_%s", 
m
->
hw_h™dÀr_«me
)) {

700 
ti
->
îr‹
 = "unknown hardware handlerÅype";

701 
ªt
 = -
EINVAL
;

702 
Áû
;

705 i‡(
hw_¨gc
 > 1) {

706 *
p
;

707 
i
, 
j
, 
Àn
 = 4;

709 
i
 = 0; i <
hw_¨gc
 - 2; i++)

710 
Àn
 +
	`°æí
(
as
->
¨gv
[
i
]) + 1;

711 
p
 = 
m
->
hw_h™dÀr_∑øms
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

712 i‡(!
p
) {

713 
ti
->
îr‹
 = "memoryállocation failed";

714 
ªt
 = -
ENOMEM
;

715 
Áû
;

717 
j
 = 
	`•rötf
(
p
, "%d", 
hw_¨gc
 - 1);

718 
i
 = 0, 
p
+=
j
+1; i <
hw_¨gc
 - 2; i++,Ö+=j+1)

719 
j
 = 
	`•rötf
(
p
, "%s", 
as
->
¨gv
[
i
]);

721 
	`dm_c⁄sume_¨gs
(
as
, 
hw_¨gc
 - 1);

724 
Áû
:

725 
	`k‰ì
(
m
->
hw_h™dÀr_«me
);

726 
m
->
hw_h™dÀr_«me
 = 
NULL
;

727  
ªt
;

728 
	}
}

730 
	$∑r£_„©uªs
(
dm_¨g_£t
 *
as
, 
mu…ù©h
 *
m
)

732 
r
;

733 
¨gc
;

734 
dm_èrgë
 *
ti
 = 
m
->ti;

735 c⁄° *
¨g_«me
;

737 
dm_¨g
 
_¨gs
[] = {

743 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
¨gc
, &
ti
->
îr‹
);

744 i‡(
r
)

745  -
EINVAL
;

747 i‡(!
¨gc
)

751 
¨g_«me
 = 
	`dm_shi·_¨g
(
as
);

752 
¨gc
--;

754 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "queue_if_no_path")) {

755 
r
 = 
	`queue_if_no_∑th
(
m
, 1, 0);

759 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "retain_attached_hw_handler")) {

760 
m
->
ªèö_©èched_hw_h™dÀr
 = 1;

764 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "pg_init_retries") &&

765 (
¨gc
 >= 1)) {

766 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 1, 
as
, &
m
->
pg_öô_ªåõs
, &
ti
->
îr‹
);

767 
¨gc
--;

771 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "pg_init_delay_msecs") &&

772 (
¨gc
 >= 1)) {

773 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 2, 
as
, &
m
->
pg_öô_dñay_m£cs
, &
ti
->
îr‹
);

774 
¨gc
--;

778 
ti
->
îr‹
 = "Unrecognised multipath featureÑequest";

779 
r
 = -
EINVAL
;

780 } 
¨gc
 && !
r
);

782  
r
;

783 
	}
}

785 
	$mu…ù©h_˘r
(
dm_èrgë
 *
ti
, 
¨gc
,

786 **
¨gv
)

789 
dm_¨g
 
_¨gs
[] = {

794 
r
;

795 
mu…ù©h
 *
m
;

796 
dm_¨g_£t
 
as
;

797 
pg_cou¡
 = 0;

798 
√xt_pg_num
;

800 
as
.
¨gc
 =árgc;

801 
as
.
¨gv
 =árgv;

803 
m
 = 
	`Æloc_mu…ù©h
(
ti
);

804 i‡(!
m
) {

805 
ti
->
îr‹
 = "can'tállocate multipath";

806  -
EINVAL
;

809 
r
 = 
	`∑r£_„©uªs
(&
as
, 
m
);

810 i‡(
r
)

811 
bad
;

813 
r
 = 
	`∑r£_hw_h™dÀr
(&
as
, 
m
);

814 i‡(
r
)

815 
bad
;

817 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, &
as
, &
m
->
ƒ_¥i‹ôy_groups
, &
ti
->
îr‹
);

818 i‡(
r
)

819 
bad
;

821 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 1, &
as
, &
√xt_pg_num
, &
ti
->
îr‹
);

822 i‡(
r
)

823 
bad
;

825 i‡((!
m
->
ƒ_¥i‹ôy_groups
 && 
√xt_pg_num
) ||

826 (
m
->
ƒ_¥i‹ôy_groups
 && !
√xt_pg_num
)) {

827 
ti
->
îr‹
 = "invalid initialÖriority group";

828 
r
 = -
EINVAL
;

829 
bad
;

833 
as
.
¨gc
) {

834 
¥i‹ôy_group
 *
pg
;

836 
pg
 = 
	`∑r£_¥i‹ôy_group
(&
as
, 
m
);

837 i‡(
	`IS_ERR
(
pg
)) {

838 
r
 = 
	`PTR_ERR
(
pg
);

839 
bad
;

842 
m
->
ƒ_vÆid_∑ths
 +
pg
->
ƒ_pg∑ths
;

843 
	`li°_add_èû
(&
pg
->
li°
, &
m
->
¥i‹ôy_groups
);

844 
pg_cou¡
++;

845 
pg
->
pg_num
 = 
pg_cou¡
;

846 i‡(!--
√xt_pg_num
)

847 
m
->
√xt_pg
 = 
pg
;

850 i‡(
pg_cou¡
 !
m
->
ƒ_¥i‹ôy_groups
) {

851 
ti
->
îr‹
 = "priority group count mismatch";

852 
r
 = -
EINVAL
;

853 
bad
;

856 
ti
->
num_Êush_bios
 = 1;

857 
ti
->
num_disˇrd_bios
 = 1;

858 
ti
->
num_wrôe_ßme_bios
 = 1;

862 
bad
:

863 
	`‰ì_mu…ù©h
(
m
);

864  
r
;

865 
	}
}

867 
	$mu…ù©h_waô_f‹_pg_öô_com∂ëi⁄
(
mu…ù©h
 *
m
)

869 
	`DECLARE_WAITQUEUE
(
waô
, 
cuºít
);

870 
Êags
;

872 
	`add_waô_queue
(&
m
->
pg_öô_waô
, &
waô
);

875 
	`£t_cuºít_°©e
(
TASK_UNINTERRUPTIBLE
);

877 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

878 i‡(!
m
->
pg_öô_ö_¥ogªss
) {

879 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

882 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

884 
	`io_scheduÀ
();

886 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

888 
	`ªmove_waô_queue
(&
m
->
pg_öô_waô
, &
waô
);

889 
	}
}

891 
	$Êush_mu…ù©h_w‹k
(
mu…ù©h
 *
m
)

893 
Êags
;

895 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

896 
m
->
pg_öô_dißbÀd
 = 1;

897 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

899 
	`Êush_w‹kqueue
(
km∑th_h™dÀrd
);

900 
	`mu…ù©h_waô_f‹_pg_öô_com∂ëi⁄
(
m
);

901 
	`Êush_w‹kqueue
(
kmu…ù©hd
);

902 
	`Êush_w‹k
(&
m
->
åiggî_evít
);

904 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

905 
m
->
pg_öô_dißbÀd
 = 0;

906 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

907 
	}
}

909 
	$mu…ù©h_då
(
dm_èrgë
 *
ti
)

911 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

913 
	`Êush_mu…ù©h_w‹k
(
m
);

914 
	`‰ì_mu…ù©h
(
m
);

915 
	}
}

920 
	$Áû_∑th
(
pg∑th
 *pgpath)

922 
Êags
;

923 
mu…ù©h
 *
m
 = 
pg∑th
->
pg
->m;

925 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

927 i‡(!
pg∑th
->
is_a˘ive
)

928 
out
;

930 
	`DMWARN
("FaûögÖ©h %s.", 
pg∑th
->
∑th
.
dev
->
«me
);

932 
pg∑th
->
pg
->
ps
.
ty≥
->
	`Áû_∑th
(&pg∑th->pg->ps, &pg∑th->
∑th
);

933 
pg∑th
->
is_a˘ive
 = 0;

934 
pg∑th
->
Áû_cou¡
++;

936 
m
->
ƒ_vÆid_∑ths
--;

938 i‡(
pg∑th
 =
m
->
cuºít_pg∑th
)

939 
m
->
cuºít_pg∑th
 = 
NULL
;

941 
	`dm_∑th_uevít
(
DM_UEVENT_PATH_FAILED
, 
m
->
ti
,

942 
pg∑th
->
∑th
.
dev
->
«me
, 
m
->
ƒ_vÆid_∑ths
);

944 
	`scheduÀ_w‹k
(&
m
->
åiggî_evít
);

946 
out
:

947 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

950 
	}
}

955 
	$ªö°©e_∑th
(
pg∑th
 *pgpath)

957 
r
 = 0, 
run_queue
 = 0;

958 
Êags
;

959 
mu…ù©h
 *
m
 = 
pg∑th
->
pg
->m;

961 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

963 i‡(
pg∑th
->
is_a˘ive
)

964 
out
;

966 i‡(!
pg∑th
->
pg
->
ps
.
ty≥
->
ªö°©e_∑th
) {

967 
	`DMWARN
("ReinstateÖathÇot supported byÖath selector %s",

968 
pg∑th
->
pg
->
ps
.
ty≥
->
«me
);

969 
r
 = -
EINVAL
;

970 
out
;

973 
r
 = 
pg∑th
->
pg
->
ps
.
ty≥
->
	`ªö°©e_∑th
(&pg∑th->pg->ps, &pg∑th->
∑th
);

974 i‡(
r
)

975 
out
;

977 
pg∑th
->
is_a˘ive
 = 1;

979 i‡(!
m
->
ƒ_vÆid_∑ths
++) {

980 
m
->
cuºít_pg∑th
 = 
NULL
;

981 
run_queue
 = 1;

982 } i‡(
m
->
hw_h™dÀr_«me
 && (m->
cuºít_pg
 =
pg∑th
->
pg
)) {

983 i‡(
	`queue_w‹k
(
km∑th_h™dÀrd
, &
pg∑th
->
a˘iv©e_∑th
.
w‹k
))

984 
m
->
pg_öô_ö_¥ogªss
++;

987 
	`dm_∑th_uevít
(
DM_UEVENT_PATH_REINSTATED
, 
m
->
ti
,

988 
pg∑th
->
∑th
.
dev
->
«me
, 
m
->
ƒ_vÆid_∑ths
);

990 
	`scheduÀ_w‹k
(&
m
->
åiggî_evít
);

992 
out
:

993 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

994 i‡(
run_queue
)

995 
	`dm_èbÀ_run_md_queue_async
(
m
->
ti
->
èbÀ
);

997  
r
;

998 
	}
}

1003 
	$a˘i⁄_dev
(
mu…ù©h
 *
m
, 
dm_dev
 *
dev
,

1004 
a˘i⁄_‚
 
a˘i⁄
)

1006 
r
 = -
EINVAL
;

1007 
pg∑th
 *pgpath;

1008 
¥i‹ôy_group
 *
pg
;

1010 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1011 
	`li°_f‹_óch_íåy
(
pg∑th
, &
pg
->
pg∑ths
, 
li°
) {

1012 i‡(
pg∑th
->
∑th
.
dev
 == dev)

1013 
r
 = 
	`a˘i⁄
(
pg∑th
);

1017  
r
;

1018 
	}
}

1023 
	$by∑ss_pg
(
mu…ù©h
 *
m
, 
¥i‹ôy_group
 *
pg
,

1024 
by∑s£d
)

1026 
Êags
;

1028 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1030 
pg
->
by∑s£d
 = bypassed;

1031 
m
->
cuºít_pg∑th
 = 
NULL
;

1032 
m
->
cuºít_pg
 = 
NULL
;

1034 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1036 
	`scheduÀ_w‹k
(&
m
->
åiggî_evít
);

1037 
	}
}

1042 
	$swôch_pg_num
(
mu…ù©h
 *
m
, c⁄° *
pg°r
)

1044 
¥i‹ôy_group
 *
pg
;

1045 
pgnum
;

1046 
Êags
;

1047 
dummy
;

1049 i‡(!
pg°r
 || (
	`ssˇnf
’g°r, "%u%c", &
pgnum
, &
dummy
) != 1) || !pgnum ||

1050 (
pgnum
 > 
m
->
ƒ_¥i‹ôy_groups
)) {

1051 
	`DMWARN
("invalid PGÇumber suppliedÅo switch_pg_num");

1052  -
EINVAL
;

1055 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1056 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1057 
pg
->
by∑s£d
 = 0;

1058 i‡(--
pgnum
)

1061 
m
->
cuºít_pg∑th
 = 
NULL
;

1062 
m
->
cuºít_pg
 = 
NULL
;

1063 
m
->
√xt_pg
 = 
pg
;

1065 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1067 
	`scheduÀ_w‹k
(&
m
->
åiggî_evít
);

1069 
	}
}

1075 
	$by∑ss_pg_num
(
mu…ù©h
 *
m
, c⁄° *
pg°r
, 
by∑s£d
)

1077 
¥i‹ôy_group
 *
pg
;

1078 
pgnum
;

1079 
dummy
;

1081 i‡(!
pg°r
 || (
	`ssˇnf
’g°r, "%u%c", &
pgnum
, &
dummy
) != 1) || !pgnum ||

1082 (
pgnum
 > 
m
->
ƒ_¥i‹ôy_groups
)) {

1083 
	`DMWARN
("invalid PGÇumber suppliedÅo bypass_pg");

1084  -
EINVAL
;

1087 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1088 i‡(!--
pgnum
)

1092 
	`by∑ss_pg
(
m
, 
pg
, 
by∑s£d
);

1094 
	}
}

1099 
	$pg_öô_limô_ªached
(
mu…ù©h
 *
m
, 
pg∑th
 *pgpath)

1101 
Êags
;

1102 
limô_ªached
 = 0;

1104 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1106 i‡(
m
->
pg_öô_cou¡
 <m->
pg_öô_ªåõs
 && !m->
pg_öô_dißbÀd
)

1107 
m
->
pg_öô_ªquúed
 = 1;

1109 
limô_ªached
 = 1;

1111 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1113  
limô_ªached
;

1114 
	}
}

1116 
	$pg_öô_d⁄e
(*
d©a
, 
îr‹s
)

1118 
pg∑th
 *pg∑th = 
d©a
;

1119 
¥i‹ôy_group
 *
pg
 = 
pg∑th
->pg;

1120 
mu…ù©h
 *
m
 = 
pg
->m;

1121 
Êags
;

1122 
dñay_ªåy
 = 0;

1125 
îr‹s
) {

1126 
SCSI_DH_OK
:

1128 
SCSI_DH_NOSYS
:

1129 i‡(!
m
->
hw_h™dÀr_«me
) {

1130 
îr‹s
 = 0;

1133 
	`DMERR
("CouldÇot failoverÅhe device: Handler scsi_dh_%s "

1134 "Eº‹ %d.", 
m
->
hw_h™dÀr_«me
, 
îr‹s
);

1138 
	`Áû_∑th
(
pg∑th
);

1140 
SCSI_DH_DEV_TEMP_BUSY
:

1145 
	`by∑ss_pg
(
m
, 
pg
, 1);

1147 
SCSI_DH_RETRY
:

1149 
dñay_ªåy
 = 1;

1150 
SCSI_DH_IMM_RETRY
:

1151 
SCSI_DH_RES_TEMP_UNAVAIL
:

1152 i‡(
	`pg_öô_limô_ªached
(
m
, 
pg∑th
))

1153 
	`Áû_∑th
(
pg∑th
);

1154 
îr‹s
 = 0;

1162 
	`Áû_∑th
(
pg∑th
);

1165 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1166 i‡(
îr‹s
) {

1167 i‡(
pg∑th
 =
m
->
cuºít_pg∑th
) {

1168 
	`DMERR
("CouldÇŸ faûovî devi˚. Eº‹ %d.", 
îr‹s
);

1169 
m
->
cuºít_pg∑th
 = 
NULL
;

1170 
m
->
cuºít_pg
 = 
NULL
;

1172 } i‡(!
m
->
pg_öô_ªquúed
)

1173 
pg
->
by∑s£d
 = 0;

1175 i‡(--
m
->
pg_öô_ö_¥ogªss
)

1177 
out
;

1179 i‡(
m
->
pg_öô_ªquúed
) {

1180 
m
->
pg_öô_dñay_ªåy
 = 
dñay_ªåy
;

1181 i‡(
	`__pg_öô_Æl_∑ths
(
m
))

1182 
out
;

1184 
m
->
queue_io
 = 0;

1189 
	`wake_up
(&
m
->
pg_öô_waô
);

1191 
out
:

1192 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1193 
	}
}

1195 
	$a˘iv©e_∑th
(
w‹k_°ru˘
 *
w‹k
)

1197 
pg∑th
 *pgpath =

1198 
	`c⁄èöî_of
(
w‹k
, 
pg∑th
, 
a˘iv©e_∑th
.work);

1200 i‡(
pg∑th
->
is_a˘ive
)

1201 
	`scsi_dh_a˘iv©e
(
	`bdev_gë_queue
(
pg∑th
->
∑th
.
dev
->
bdev
),

1202 
pg_öô_d⁄e
, 
pg∑th
);

1204 
	`pg_öô_d⁄e
(
pg∑th
, 
SCSI_DH_DEV_OFFLINED
);

1205 
	}
}

1207 
	$n‹ëry_îr‹
(
îr‹
)

1209 
îr‹
) {

1210 -
EOPNOTSUPP
:

1211 -
EREMOTEIO
:

1212 -
EILSEQ
:

1213 -
ENODATA
:

1214 -
ENOSPC
:

1220 
	}
}

1225 
	$do_íd_io
(
mu…ù©h
 *
m
, 
ªque°
 *
˛⁄e
,

1226 
îr‹
, 
dm_m∑th_io
 *
mpio
)

1239 
r
 = 
DM_ENDIO_REQUEUE
;

1240 
Êags
;

1242 i‡(!
îr‹
 && !
˛⁄e
->
îr‹s
)

1245 i‡(
	`n‹ëry_îr‹
(
îr‹
))

1246  
îr‹
;

1248 i‡(
mpio
->
pg∑th
)

1249 
	`Áû_∑th
(
mpio
->
pg∑th
);

1251 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1252 i‡(!
m
->
ƒ_vÆid_∑ths
) {

1253 i‡(!
m
->
queue_if_no_∑th
) {

1254 i‡(!
	`__mu°_push_back
(
m
))

1255 
r
 = -
EIO
;

1257 i‡(
îr‹
 =-
EBADE
)

1258 
r
 = 
îr‹
;

1261 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1263  
r
;

1264 
	}
}

1266 
	$mu…ù©h_íd_io
(
dm_èrgë
 *
ti
, 
ªque°
 *
˛⁄e
,

1267 
îr‹
, 
m≠_öfo
 *
m≠_c⁄ãxt
)

1269 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

1270 
dm_m∑th_io
 *
mpio
 = 
m≠_c⁄ãxt
->
±r
;

1271 
pg∑th
 *pgpath;

1272 
∑th_£À˘‹
 *
ps
;

1273 
r
;

1275 
	`BUG_ON
(!
mpio
);

1277 
r
 = 
	`do_íd_io
(
m
, 
˛⁄e
, 
îr‹
, 
mpio
);

1278 
pg∑th
 = 
mpio
->pgpath;

1279 i‡(
pg∑th
) {

1280 
ps
 = &
pg∑th
->
pg
->ps;

1281 i‡(
ps
->
ty≥
->
íd_io
)

1282 
ps
->
ty≥
->
	`íd_io
’s, &
pg∑th
->
∑th
, 
mpio
->
ƒ_byãs
);

1284 
	`˛ór_m≠öfo
(
m
, 
m≠_c⁄ãxt
);

1286  
r
;

1287 
	}
}

1295 
	$mu…ù©h_¥esu•íd
(
dm_èrgë
 *
ti
)

1297 
mu…ù©h
 *
m
 = (mu…ù©h *Ë
ti
->
¥iv©e
;

1299 
	`queue_if_no_∑th
(
m
, 0, 1);

1300 
	}
}

1302 
	$mu…ù©h_po°su•íd
(
dm_èrgë
 *
ti
)

1304 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

1306 
	`muãx_lock
(&
m
->
w‹k_muãx
);

1307 
	`Êush_mu…ù©h_w‹k
(
m
);

1308 
	`muãx_u∆ock
(&
m
->
w‹k_muãx
);

1309 
	}
}

1314 
	$mu…ù©h_ªsume
(
dm_èrgë
 *
ti
)

1316 
mu…ù©h
 *
m
 = (mu…ù©h *Ë
ti
->
¥iv©e
;

1317 
Êags
;

1319 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1320 
m
->
queue_if_no_∑th
 = m->
ßved_queue_if_no_∑th
;

1321 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1322 
	}
}

1340 
	$mu…ù©h_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1341 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1343 
sz
 = 0;

1344 
Êags
;

1345 
mu…ù©h
 *
m
 = (mu…ù©h *Ë
ti
->
¥iv©e
;

1346 
¥i‹ôy_group
 *
pg
;

1347 
pg∑th
 *
p
;

1348 
pg_num
;

1349 
°©e
;

1351 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1354 i‡(
ty≥
 =
STATUSTYPE_INFO
)

1355 
	`DMEMIT
("2 %u %u ", 
m
->
queue_io
, m->
pg_öô_cou¡
);

1357 
	`DMEMIT
("%u ", 
m
->
queue_if_no_∑th
 +

1358 (
m
->
pg_öô_ªåõs
 > 0) * 2 +

1359 (
m
->
pg_öô_dñay_m£cs
 !
DM_PG_INIT_DELAY_DEFAULT
) * 2 +

1360 
m
->
ªèö_©èched_hw_h™dÀr
);

1361 i‡(
m
->
queue_if_no_∑th
)

1362 
	`DMEMIT
("queue_if_no_path ");

1363 i‡(
m
->
pg_öô_ªåõs
)

1364 
	`DMEMIT
("pg_öô_ªåõ†%u ", 
m
->
pg_öô_ªåõs
);

1365 i‡(
m
->
pg_öô_dñay_m£cs
 !
DM_PG_INIT_DELAY_DEFAULT
)

1366 
	`DMEMIT
("pg_öô_dñay_m£c†%u ", 
m
->
pg_öô_dñay_m£cs
);

1367 i‡(
m
->
ªèö_©èched_hw_h™dÀr
)

1368 
	`DMEMIT
("retain_attached_hw_handler ");

1371 i‡(!
m
->
hw_h™dÀr_«me
 || 
ty≥
 =
STATUSTYPE_INFO
)

1372 
	`DMEMIT
("0 ");

1374 
	`DMEMIT
("1 %†", 
m
->
hw_h™dÀr_«me
);

1376 
	`DMEMIT
("%u ", 
m
->
ƒ_¥i‹ôy_groups
);

1378 i‡(
m
->
√xt_pg
)

1379 
pg_num
 = 
m
->
√xt_pg
->pg_num;

1380 i‡(
m
->
cuºít_pg
)

1381 
pg_num
 = 
m
->
cuºít_pg
->pg_num;

1383 
pg_num
 = (
m
->
ƒ_¥i‹ôy_groups
 ? 1 : 0);

1385 
	`DMEMIT
("%u ", 
pg_num
);

1387 
ty≥
) {

1388 
STATUSTYPE_INFO
:

1389 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1390 i‡(
pg
->
by∑s£d
)

1391 
°©e
 = 'D';

1392 i‡(
pg
 =
m
->
cuºít_pg
)

1393 
°©e
 = 'A';

1395 
°©e
 = 'E';

1397 
	`DMEMIT
("%¯", 
°©e
);

1399 i‡(
pg
->
ps
.
ty≥
->
°©us
)

1400 
sz
 +
pg
->
ps
.
ty≥
->
	`°©us
(&pg->ps, 
NULL
,Åype,

1401 
ªsu…
 + 
sz
,

1402 
maxÀn
 - 
sz
);

1404 
	`DMEMIT
("0 ");

1406 
	`DMEMIT
("%u %u ", 
pg
->
ƒ_pg∑ths
,

1407 
pg
->
ps
.
ty≥
->
öfo_¨gs
);

1409 
	`li°_f‹_óch_íåy
(
p
, &
pg
->
pg∑ths
, 
li°
) {

1410 
	`DMEMIT
("%†%†%u ", 
p
->
∑th
.
dev
->
«me
,

1411 
p
->
is_a˘ive
 ? "A" : "F",

1412 
p
->
Áû_cou¡
);

1413 i‡(
pg
->
ps
.
ty≥
->
°©us
)

1414 
sz
 +
pg
->
ps
.
ty≥
->
	`°©us
(&pg->ps,

1415 &
p
->
∑th
, 
ty≥
, 
ªsu…
 + 
sz
,

1416 
maxÀn
 - 
sz
);

1421 
STATUSTYPE_TABLE
:

1422 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1423 
	`DMEMIT
("%†", 
pg
->
ps
.
ty≥
->
«me
);

1425 i‡(
pg
->
ps
.
ty≥
->
°©us
)

1426 
sz
 +
pg
->
ps
.
ty≥
->
	`°©us
(&pg->ps, 
NULL
,Åype,

1427 
ªsu…
 + 
sz
,

1428 
maxÀn
 - 
sz
);

1430 
	`DMEMIT
("0 ");

1432 
	`DMEMIT
("%u %u ", 
pg
->
ƒ_pg∑ths
,

1433 
pg
->
ps
.
ty≥
->
èbÀ_¨gs
);

1435 
	`li°_f‹_óch_íåy
(
p
, &
pg
->
pg∑ths
, 
li°
) {

1436 
	`DMEMIT
("%†", 
p
->
∑th
.
dev
->
«me
);

1437 i‡(
pg
->
ps
.
ty≥
->
°©us
)

1438 
sz
 +
pg
->
ps
.
ty≥
->
	`°©us
(&pg->ps,

1439 &
p
->
∑th
, 
ty≥
, 
ªsu…
 + 
sz
,

1440 
maxÀn
 - 
sz
);

1446 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1447 
	}
}

1449 
	$mu…ù©h_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1451 
r
 = -
EINVAL
;

1452 
dm_dev
 *
dev
;

1453 
mu…ù©h
 *
m
 = (mu…ù©h *Ë
ti
->
¥iv©e
;

1454 
a˘i⁄_‚
 
a˘i⁄
;

1456 
	`muãx_lock
(&
m
->
w‹k_muãx
);

1458 i‡(
	`dm_su•íded
(
ti
)) {

1459 
r
 = -
EBUSY
;

1460 
out
;

1463 i‡(
¨gc
 == 1) {

1464 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "queue_if_no_path")) {

1465 
r
 = 
	`queue_if_no_∑th
(
m
, 1, 0);

1466 
out
;

1467 } i‡(!
	`°rˇ£cmp
(
¨gv
[0], "fail_if_no_path")) {

1468 
r
 = 
	`queue_if_no_∑th
(
m
, 0, 0);

1469 
out
;

1473 i‡(
¨gc
 != 2) {

1474 
	`DMWARN
("InvÆid mu…ù©h mesßgê¨gumíts. Ex≥˘ed 2árgumíts, gŸ %d.", 
¨gc
);

1475 
out
;

1478 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "disable_group")) {

1479 
r
 = 
	`by∑ss_pg_num
(
m
, 
¨gv
[1], 1);

1480 
out
;

1481 } i‡(!
	`°rˇ£cmp
(
¨gv
[0], "enable_group")) {

1482 
r
 = 
	`by∑ss_pg_num
(
m
, 
¨gv
[1], 0);

1483 
out
;

1484 } i‡(!
	`°rˇ£cmp
(
¨gv
[0], "switch_group")) {

1485 
r
 = 
	`swôch_pg_num
(
m
, 
¨gv
[1]);

1486 
out
;

1487 } i‡(!
	`°rˇ£cmp
(
¨gv
[0], "reinstate_path"))

1488 
a˘i⁄
 = 
ªö°©e_∑th
;

1489 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "fail_path"))

1490 
a˘i⁄
 = 
Áû_∑th
;

1492 
	`DMWARN
("Uƒecogni£d mu…ù©h mesßgêª˚ived: %s", 
¨gv
[0]);

1493 
out
;

1496 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[1], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
dev
);

1497 i‡(
r
) {

1498 
	`DMWARN
("message:Érror getting device %s",

1499 
¨gv
[1]);

1500 
out
;

1503 
r
 = 
	`a˘i⁄_dev
(
m
, 
dev
, 
a˘i⁄
);

1505 
	`dm_put_devi˚
(
ti
, 
dev
);

1507 
out
:

1508 
	`muãx_u∆ock
(&
m
->
w‹k_muãx
);

1509  
r
;

1510 
	}
}

1512 
	$mu…ù©h_io˘l
(
dm_èrgë
 *
ti
, 
cmd
,

1513 
¨g
)

1515 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

1516 
pg∑th
 *pgpath;

1517 
block_devi˚
 *
bdev
;

1518 
fmode_t
 
mode
;

1519 
Êags
;

1520 
r
;

1522 
bdev
 = 
NULL
;

1523 
mode
 = 0;

1524 
r
 = 0;

1526 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1528 i‡(!
m
->
cuºít_pg∑th
)

1529 
	`__choo£_pg∑th
(
m
, 0);

1531 
pg∑th
 = 
m
->
cuºít_pg∑th
;

1533 i‡(
pg∑th
) {

1534 
bdev
 = 
pg∑th
->
∑th
.
dev
->bdev;

1535 
mode
 = 
pg∑th
->
∑th
.
dev
->mode;

1538 i‡((
pg∑th
 && 
m
->
queue_io
Ë|| (!pg∑th && m->
queue_if_no_∑th
))

1539 
r
 = -
ENOTCONN
;

1540 i‡(!
bdev
)

1541 
r
 = -
EIO
;

1543 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1548 i‡(!
bdev
 || 
ti
->
Àn
 !
	`i_size_ªad
(bdev->
bd_öode
Ë>> 
SECTOR_SHIFT
) {

1549 
îr
 = 
	`scsi_vîify_blk_io˘l
(
NULL
, 
cmd
);

1550 i‡(
îr
)

1551 
r
 = 
îr
;

1554 i‡(
r
 =-
ENOTCONN
 && !
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1555 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1556 i‡(!
m
->
cuºít_pg
) {

1558 
	`__choo£_pg∑th
(
m
, 0);

1560 i‡(
m
->
pg_öô_ªquúed
)

1561 
	`__pg_öô_Æl_∑ths
(
m
);

1562 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1563 
	`dm_èbÀ_run_md_queue_async
(
m
->
ti
->
èbÀ
);

1566  
r
 ? : 
	`__blkdev_drivî_io˘l
(
bdev
, 
mode
, 
cmd
, 
¨g
);

1567 
	}
}

1569 
	$mu…ù©h_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1570 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1572 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

1573 
¥i‹ôy_group
 *
pg
;

1574 
pg∑th
 *
p
;

1575 
ªt
 = 0;

1577 
	`li°_f‹_óch_íåy
(
pg
, &
m
->
¥i‹ôy_groups
, 
li°
) {

1578 
	`li°_f‹_óch_íåy
(
p
, &
pg
->
pg∑ths
, 
li°
) {

1579 
ªt
 = 
	`‚
(
ti
, 
p
->
∑th
.
dev
,Åi->
begö
,Åi->
Àn
, 
d©a
);

1580 i‡(
ªt
)

1581 
out
;

1585 
out
:

1586  
ªt
;

1587 
	}
}

1589 
	$__pg∑th_busy
(
pg∑th
 *pgpath)

1591 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
pg∑th
->
∑th
.
dev
->
bdev
);

1593  
	`dm_undîlyög_devi˚_busy
(
q
);

1594 
	}
}

1604 
	$mu…ù©h_busy
(
dm_èrgë
 *
ti
)

1606 
busy
 = 0, 
has_a˘ive
 = 0;

1607 
mu…ù©h
 *
m
 = 
ti
->
¥iv©e
;

1608 
¥i‹ôy_group
 *
pg
;

1609 
pg∑th
 *pgpath;

1610 
Êags
;

1612 
	`•ö_lock_úqßve
(&
m
->
lock
, 
Êags
);

1615 i‡(
m
->
pg_öô_ö_¥ogªss
 ||

1616 (!
m
->
ƒ_vÆid_∑ths
 && m->
queue_if_no_∑th
)) {

1617 
busy
 = 1;

1618 
out
;

1621 i‡(
	`u∆ikñy
(!
m
->
cuºít_pg∑th
 && m->
√xt_pg
))

1622 
pg
 = 
m
->
√xt_pg
;

1623 i‡(
	`likñy
(
m
->
cuºít_pg
))

1624 
pg
 = 
m
->
cuºít_pg
;

1633 
out
;

1639 
busy
 = 1;

1640 
	`li°_f‹_óch_íåy
(
pg∑th
, &
pg
->
pg∑ths
, 
li°
)

1641 i‡(
pg∑th
->
is_a˘ive
) {

1642 
has_a˘ive
 = 1;

1644 i‡(!
	`__pg∑th_busy
(
pg∑th
)) {

1645 
busy
 = 0;

1650 i‡(!
has_a˘ive
)

1656 
busy
 = 0;

1658 
out
:

1659 
	`•ö_u∆ock_úqª°‹e
(&
m
->
lock
, 
Êags
);

1661  
busy
;

1662 
	}
}

1667 
èrgë_ty≥
 
	gmu…ù©h_èrgë
 = {

1668 .
«me
 = "multipath",

1669 .
	gvîsi⁄
 = {1, 7, 0},

1670 .
	gmoduÀ
 = 
THIS_MODULE
,

1671 .
	g˘r
 = 
mu…ù©h_˘r
,

1672 .
	gdå
 = 
mu…ù©h_då
,

1673 .
	gm≠_rq
 = 
mu…ù©h_m≠
,

1674 .
	grq_íd_io
 = 
mu…ù©h_íd_io
,

1675 .
	g¥esu•íd
 = 
mu…ù©h_¥esu•íd
,

1676 .
	gpo°su•íd
 = 
mu…ù©h_po°su•íd
,

1677 .
	gªsume
 = 
mu…ù©h_ªsume
,

1678 .
	g°©us
 = 
mu…ù©h_°©us
,

1679 .
	gmesßge
 = 
mu…ù©h_mesßge
,

1680 .
	gio˘l
 = 
mu…ù©h_io˘l
,

1681 .
	gôî©e_devi˚s
 = 
mu…ù©h_ôî©e_devi˚s
,

1682 .
	gbusy
 = 
mu…ù©h_busy
,

1685 
__öô
 
	$dm_mu…ù©h_öô
()

1687 
r
;

1690 
_mpio_ˇche
 = 
	`KMEM_CACHE
(
dm_m∑th_io
, 0);

1691 i‡(!
_mpio_ˇche
)

1692  -
ENOMEM
;

1694 
r
 = 
	`dm_ªgi°î_èrgë
(&
mu…ù©h_èrgë
);

1695 i‡(
r
 < 0) {

1696 
	`DMERR
("ªgi°î faûed %d", 
r
);

1697 
	`kmem_ˇche_de°roy
(
_mpio_ˇche
);

1698  -
EINVAL
;

1701 
kmu…ù©hd
 = 
	`Æloc_w‹kqueue
("km∑thd", 
WQ_MEM_RECLAIM
, 0);

1702 i‡(!
kmu…ù©hd
) {

1703 
	`DMERR
("failedÅo create workqueue kmpathd");

1704 
	`dm_uƒegi°î_èrgë
(&
mu…ù©h_èrgë
);

1705 
	`kmem_ˇche_de°roy
(
_mpio_ˇche
);

1706  -
ENOMEM
;

1715 
km∑th_h™dÀrd
 = 
	`Æloc_‹dîed_w‹kqueue
("kmpath_handlerd",

1716 
WQ_MEM_RECLAIM
);

1717 i‡(!
km∑th_h™dÀrd
) {

1718 
	`DMERR
("failedÅo create workqueue kmpath_handlerd");

1719 
	`de°roy_w‹kqueue
(
kmu…ù©hd
);

1720 
	`dm_uƒegi°î_èrgë
(&
mu…ù©h_èrgë
);

1721 
	`kmem_ˇche_de°roy
(
_mpio_ˇche
);

1722  -
ENOMEM
;

1725 
	`DMINFO
("version %u.%u.%uÜoaded",

1726 
mu…ù©h_èrgë
.
vîsi⁄
[0], multipath_target.version[1],

1727 
mu…ù©h_èrgë
.
vîsi⁄
[2]);

1729  
r
;

1730 
	}
}

1732 
__exô
 
	$dm_mu…ù©h_exô
()

1734 
	`de°roy_w‹kqueue
(
km∑th_h™dÀrd
);

1735 
	`de°roy_w‹kqueue
(
kmu…ù©hd
);

1737 
	`dm_uƒegi°î_èrgë
(&
mu…ù©h_èrgë
);

1738 
	`kmem_ˇche_de°roy
(
_mpio_ˇche
);

1739 
	}
}

1741 
moduÀ_öô
(
dm_mu…ù©h_öô
);

1742 
moduÀ_exô
(
dm_mu…ù©h_exô
);

1744 
MODULE_DESCRIPTION
(
DM_NAME
 " multipathÅarget");

1745 
MODULE_AUTHOR
("Sistina Software <dm-devel@redhat.com>");

1746 
MODULE_LICENSE
("GPL");

	@dm-mpath.h

9 #i‚def 
DM_MPATH_H


10 
	#DM_MPATH_H


	)

12 
	gdm_dev
;

14 
	sdm_∑th
 {

15 
dm_dev
 *
	mdev
;

16 *
	mpsc⁄ãxt
;

20 
dm_pg_öô_com∂ëe
(
dm_∑th
 *
∑th
, 
îr_Êags
);

	@dm-multipath.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x8487a2b6, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹k
) },

24 { 0x2d3385d3, 
__VMLINUX_SYMBOL_STR
(
sy°em_wq
) },

25 { 0xa˚7f227, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_£t_∑øms
) },

26 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

27 { 0x402b8281, 
__VMLINUX_SYMBOL_STR
(
__ªque°_moduÀ
) },

28 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

29 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

30 { 0x7deff673, 
__VMLINUX_SYMBOL_STR
(
dm_c⁄sume_¨gs
) },

31 { 0x5876c094, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

32 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
°æí
) },

33 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

34 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

35 { 0x2f113952, 
__VMLINUX_SYMBOL_STR
(
dm_∑th_uevít
) },

36 { 0xb5dˇb5b, 
__VMLINUX_SYMBOL_STR
(
ªmove_waô_queue
) },

37 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

38 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

39 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

40 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

41 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

42 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

43 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

44 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

45 { 0x4708400e, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_©èched_h™dÀr_«me
) },

46 { 0xf96cc7e, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

47 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

48 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

49 { 0xffd5a395, 
__VMLINUX_SYMBOL_STR
(
deÁu…_wake_fun˘i⁄
) },

50 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

51 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

52 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

53 { 0xf8c0f16e, 
__VMLINUX_SYMBOL_STR
(
__blkdev_drivî_io˘l
) },

54 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

55 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

56 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

57 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

58 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

59 { 0x9c123043, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_a˘iv©e
) },

60 { 0x98Á1e20, 
__VMLINUX_SYMBOL_STR
(
dm_gë_ª£rved_rq_ba£d_ios
) },

61 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

62 { 0x3dbf87c4, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_©èch
) },

63 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

64 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

65 { 0x93a6e0b2, 
__VMLINUX_SYMBOL_STR
(
io_scheduÀ
) },

66 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

67 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

68 { 0x46„b099, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g
) },

69 { 0x960f071e, 
__VMLINUX_SYMBOL_STR
(
dm_su•íded
) },

70 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

71 { 0x6e5db7e4, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

72 { 0x2ed55c8e, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

73 { 0x593a36c2, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_h™dÀr_exi°
) },

74 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

75 { 0xbe0498f3, 
__VMLINUX_SYMBOL_STR
(
moduÀ_put
) },

76 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

77 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

78 { 0x4df6e7a2, 
__VMLINUX_SYMBOL_STR
(
scsi_vîify_blk_io˘l
) },

79 { 0x3bd1b1f6, 
__VMLINUX_SYMBOL_STR
(
m£cs_to_jiffõs
) },

80 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

81 { 0xbde67803, 
__VMLINUX_SYMBOL_STR
(
dm_undîlyög_devi˚_busy
) },

82 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

83 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

84 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

85 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

86 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

87 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

88 { 0x5860Ød4, 
__VMLINUX_SYMBOL_STR
(
add_waô_queue
) },

89 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

90 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

91 { 0xa203bd85, 
__VMLINUX_SYMBOL_STR
(
scsi_dh_dëach
) },

92 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

93 { 0x1008b78b, 
__VMLINUX_SYMBOL_STR
(
dm_noÊush_su•ídög
) },

94 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

95 { 0x37af3190, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_run_md_queue_async
) },

96 { 0x8ó31722, 
__VMLINUX_SYMBOL_STR
(
åy_moduÀ_gë
) },

99 c⁄° 
	g__moduÀ_dïíds
[]

100 
__u£d


101 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

105 
MODULE_INFO
(
§cvîsi⁄
, "E5697BA16B757D09DE56A67");

	@dm-path-selector.c

12 
	~<löux/devi˚-m≠≥r.h
>

13 
	~<löux/moduÀ.h
>

15 
	~"dm-∑th-£À˘‹.h
"

17 
	~<löux/¶ab.h
>

19 
	sps_öã∫Æ
 {

20 
∑th_£À˘‹_ty≥
 
	mp°
;

21 
li°_hód
 
	mli°
;

24 
	#p°_to_psi
(
__p°
Ë
	`c⁄èöî_of
((__p°), 
ps_öã∫Æ
, 
p°
)

	)

26 
LIST_HEAD
(
_∑th_£À˘‹s
);

27 
DECLARE_RWSEM
(
_ps_lock
);

29 
ps_öã∫Æ
 *
	$__föd_∑th_£À˘‹_ty≥
(c⁄° *
«me
)

31 
ps_öã∫Æ
 *
psi
;

33 
	`li°_f‹_óch_íåy
(
psi
, &
_∑th_£À˘‹s
, 
li°
) {

34 i‡(!
	`°rcmp
(
«me
, 
psi
->
p°
.name))

35  
psi
;

38  
NULL
;

39 
	}
}

41 
ps_öã∫Æ
 *
	$gë_∑th_£À˘‹
(c⁄° *
«me
)

43 
ps_öã∫Æ
 *
psi
;

45 
	`down_ªad
(&
_ps_lock
);

46 
psi
 = 
	`__föd_∑th_£À˘‹_ty≥
(
«me
);

47 i‡(
psi
 && !
	`åy_moduÀ_gë
’si->
p°
.
moduÀ
))

48 
psi
 = 
NULL
;

49 
	`up_ªad
(&
_ps_lock
);

51  
psi
;

52 
	}
}

54 
∑th_£À˘‹_ty≥
 *
	$dm_gë_∑th_£À˘‹
(c⁄° *
«me
)

56 
ps_öã∫Æ
 *
psi
;

58 i‡(!
«me
)

59  
NULL
;

61 
psi
 = 
	`gë_∑th_£À˘‹
(
«me
);

62 i‡(!
psi
) {

63 
	`ªque°_moduÀ
("dm-%s", 
«me
);

64 
psi
 = 
	`gë_∑th_£À˘‹
(
«me
);

67  
psi
 ? &psi->
p°
 : 
NULL
;

68 
	}
}

70 
	$dm_put_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
p°
)

72 
ps_öã∫Æ
 *
psi
;

74 i‡(!
p°
)

77 
	`down_ªad
(&
_ps_lock
);

78 
psi
 = 
	`__föd_∑th_£À˘‹_ty≥
(
p°
->
«me
);

79 i‡(!
psi
)

80 
out
;

82 
	`moduÀ_put
(
psi
->
p°
.
moduÀ
);

83 
out
:

84 
	`up_ªad
(&
_ps_lock
);

85 
	}
}

87 
ps_öã∫Æ
 *
	$_Æloc_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
p°
)

89 
ps_öã∫Æ
 *
psi
 = 
	`kzÆloc
((*psi), 
GFP_KERNEL
);

91 i‡(
psi
)

92 
psi
->
p°
 = *pst;

94  
psi
;

95 
	}
}

97 
	$dm_ªgi°î_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
p°
)

99 
r
 = 0;

100 
ps_öã∫Æ
 *
psi
 = 
	`_Æloc_∑th_£À˘‹
(
p°
);

102 i‡(!
psi
)

103  -
ENOMEM
;

105 
	`down_wrôe
(&
_ps_lock
);

107 i‡(
	`__föd_∑th_£À˘‹_ty≥
(
p°
->
«me
)) {

108 
	`k‰ì
(
psi
);

109 
r
 = -
EEXIST
;

111 
	`li°_add
(&
psi
->
li°
, &
_∑th_£À˘‹s
);

113 
	`up_wrôe
(&
_ps_lock
);

115  
r
;

116 
	}
}

118 
	$dm_uƒegi°î_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
p°
)

120 
ps_öã∫Æ
 *
psi
;

122 
	`down_wrôe
(&
_ps_lock
);

124 
psi
 = 
	`__föd_∑th_£À˘‹_ty≥
(
p°
->
«me
);

125 i‡(!
psi
) {

126 
	`up_wrôe
(&
_ps_lock
);

127  -
EINVAL
;

130 
	`li°_dñ
(&
psi
->
li°
);

132 
	`up_wrôe
(&
_ps_lock
);

134 
	`k‰ì
(
psi
);

137 
	}
}

139 
EXPORT_SYMBOL_GPL
(
dm_ªgi°î_∑th_£À˘‹
);

140 
EXPORT_SYMBOL_GPL
(
dm_uƒegi°î_∑th_£À˘‹
);

	@dm-path-selector.h

12 #i‚def 
DM_PATH_SELECTOR_H


13 
	#DM_PATH_SELECTOR_H


	)

15 
	~<löux/devi˚-m≠≥r.h
>

17 
	~"dm-m∑th.h
"

23 
	g∑th_£À˘‹_ty≥
;

24 
	s∑th_£À˘‹
 {

25 
∑th_£À˘‹_ty≥
 *
	mty≥
;

26 *
	mc⁄ãxt
;

30 
	s∑th_£À˘‹_ty≥
 {

31 *
	m«me
;

32 
moduÀ
 *
	mmoduÀ
;

34 
	mèbÀ_¨gs
;

35 
	möfo_¨gs
;

40 (*
	m¸óã
Ë(
∑th_£À˘‹
 *
	mps
, 
	m¨gc
, **
	m¨gv
);

41 (*
	mde°roy
Ë(
∑th_£À˘‹
 *
	mps
);

47 (*
	madd_∑th
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	m∑th
,

48 
	m¨gc
, **
	m¨gv
, **
	mîr‹
);

58 
	mdm_∑th
 *(*
	m£À˘_∑th
Ë(
∑th_£À˘‹
 *
	mps
,

59 *
	mª≥©_cou¡
,

60 
size_t
 
	mƒ_byãs
);

65 (*
	mÁû_∑th
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	mp
);

70 (*
	mªö°©e_∑th
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	mp
);

76 (*
	m°©us
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	m∑th
,

77 
°©us_ty≥_t
 
	mty≥
, *
	mªsu…
, 
	mmaxÀn
);

79 (*
	m°¨t_io
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	m∑th
,

80 
size_t
 
	mƒ_byãs
);

81 (*
	míd_io
Ë(
∑th_£À˘‹
 *
	mps
, 
dm_∑th
 *
	m∑th
,

82 
size_t
 
	mƒ_byãs
);

86 
dm_ªgi°î_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
ty≥
);

89 
dm_uƒegi°î_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
ty≥
);

92 
∑th_£À˘‹_ty≥
 *
dm_gë_∑th_£À˘‹
(c⁄° *
«me
);

95 
dm_put_∑th_£À˘‹
(
∑th_£À˘‹_ty≥
 *
p°
);

	@dm-queue-length.c

16 
	~"dm.h
"

17 
	~"dm-∑th-£À˘‹.h
"

19 
	~<löux/¶ab.h
>

20 
	~<löux/˘y≥.h
>

21 
	~<löux/î∫o.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/©omic.h
>

25 
	#DM_MSG_PREFIX
 "mu…ù©h queue-Àngth"

	)

26 
	#QL_MIN_IO
 128

	)

27 
	#QL_VERSION
 "0.1.0"

	)

29 
	s£À˘‹
 {

30 
li°_hód
 
	mvÆid_∑ths
;

31 
li°_hód
 
	mÁûed_∑ths
;

34 
	s∑th_öfo
 {

35 
li°_hód
 
	mli°
;

36 
dm_∑th
 *
	m∑th
;

37 
	mª≥©_cou¡
;

38 
©omic_t
 
	mqÀn
;

41 
£À˘‹
 *
	$Æloc_£À˘‹
()

43 
£À˘‹
 *
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

45 i‡(
s
) {

46 
	`INIT_LIST_HEAD
(&
s
->
vÆid_∑ths
);

47 
	`INIT_LIST_HEAD
(&
s
->
Áûed_∑ths
);

50  
s
;

51 
	}
}

53 
	$ql_¸óã
(
∑th_£À˘‹
 *
ps
, 
¨gc
, **
¨gv
)

55 
£À˘‹
 *
s
 = 
	`Æloc_£À˘‹
();

57 i‡(!
s
)

58  -
ENOMEM
;

60 
ps
->
c⁄ãxt
 = 
s
;

62 
	}
}

64 
	$ql_‰ì_∑ths
(
li°_hód
 *
∑ths
)

66 
∑th_öfo
 *
pi
, *
√xt
;

68 
	`li°_f‹_óch_íåy_ß„
(
pi
, 
√xt
, 
∑ths
, 
li°
) {

69 
	`li°_dñ
(&
pi
->
li°
);

70 
	`k‰ì
(
pi
);

72 
	}
}

74 
	$ql_de°roy
(
∑th_£À˘‹
 *
ps
)

76 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

78 
	`ql_‰ì_∑ths
(&
s
->
vÆid_∑ths
);

79 
	`ql_‰ì_∑ths
(&
s
->
Áûed_∑ths
);

80 
	`k‰ì
(
s
);

81 
ps
->
c⁄ãxt
 = 
NULL
;

82 
	}
}

84 
	$ql_°©us
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

85 
°©us_ty≥_t
 
ty≥
, *
ªsu…
, 
maxÀn
)

87 
sz
 = 0;

88 
∑th_öfo
 *
pi
;

91 i‡(!
∑th
)

92 
	`DMEMIT
("0 ");

94 
pi
 = 
∑th
->
psc⁄ãxt
;

96 
ty≥
) {

97 
STATUSTYPE_INFO
:

98 
	`DMEMIT
("%d ", 
	`©omic_ªad
(&
pi
->
qÀn
));

100 
STATUSTYPE_TABLE
:

101 
	`DMEMIT
("%u ", 
pi
->
ª≥©_cou¡
);

106  
sz
;

107 
	}
}

109 
	$ql_add_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

110 
¨gc
, **
¨gv
, **
îr‹
)

112 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

113 
∑th_öfo
 *
pi
;

114 
ª≥©_cou¡
 = 
QL_MIN_IO
;

115 
dummy
;

122 i‡(
¨gc
 > 1) {

123 *
îr‹
 = "queue-lengthÖs: incorrectÇumber ofárguments";

124  -
EINVAL
;

127 i‡((
¨gc
 =1Ë&& (
	`ssˇnf
(
¨gv
[0], "%u%c", &
ª≥©_cou¡
, &
dummy
) != 1)) {

128 *
îr‹
 = "queue-lengthÖs: invalidÑepeat count";

129  -
EINVAL
;

133 
pi
 = 
	`kmÆloc
((*pi), 
GFP_KERNEL
);

134 i‡(!
pi
) {

135 *
îr‹
 = "queue-lengthÖs: ErrorállocatingÖath information";

136  -
ENOMEM
;

139 
pi
->
∑th
 =Öath;

140 
pi
->
ª≥©_cou¡
 =Ñepeat_count;

141 
	`©omic_£t
(&
pi
->
qÀn
, 0);

143 
∑th
->
psc⁄ãxt
 = 
pi
;

145 
	`li°_add_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

148 
	}
}

150 
	$ql_Áû_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
)

152 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

153 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

155 
	`li°_move
(&
pi
->
li°
, &
s
->
Áûed_∑ths
);

156 
	}
}

158 
	$ql_ªö°©e_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
)

160 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

161 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

163 
	`li°_move_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

166 
	}
}

171 
dm_∑th
 *
	$ql_£À˘_∑th
(
∑th_£À˘‹
 *
ps
,

172 *
ª≥©_cou¡
, 
size_t
 
ƒ_byãs
)

174 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

175 
∑th_öfo
 *
pi
 = 
NULL
, *
be°
 = NULL;

177 i‡(
	`li°_em±y
(&
s
->
vÆid_∑ths
))

178  
NULL
;

181 
	`li°_move_èû
(
s
->
vÆid_∑ths
.
√xt
, &s->valid_paths);

183 
	`li°_f‹_óch_íåy
(
pi
, &
s
->
vÆid_∑ths
, 
li°
) {

184 i‡(!
be°
 ||

185 (
	`©omic_ªad
(&
pi
->
qÀn
Ë<átomic_ªad(&
be°
->qlen)))

186 
be°
 = 
pi
;

188 i‡(!
	`©omic_ªad
(&
be°
->
qÀn
))

192 i‡(!
be°
)

193  
NULL
;

195 *
ª≥©_cou¡
 = 
be°
->repeat_count;

197  
be°
->
∑th
;

198 
	}
}

200 
	$ql_°¨t_io
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

201 
size_t
 
ƒ_byãs
)

203 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

205 
	`©omic_öc
(&
pi
->
qÀn
);

208 
	}
}

210 
	$ql_íd_io
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

211 
size_t
 
ƒ_byãs
)

213 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

215 
	`©omic_dec
(&
pi
->
qÀn
);

218 
	}
}

220 
∑th_£À˘‹_ty≥
 
	gql_ps
 = {

221 .
«me
 = "queue-length",

222 .
	gmoduÀ
 = 
THIS_MODULE
,

223 .
	gèbÀ_¨gs
 = 1,

224 .
	göfo_¨gs
 = 1,

225 .
	g¸óã
 = 
ql_¸óã
,

226 .
	gde°roy
 = 
ql_de°roy
,

227 .
	g°©us
 = 
ql_°©us
,

228 .
	gadd_∑th
 = 
ql_add_∑th
,

229 .
	gÁû_∑th
 = 
ql_Áû_∑th
,

230 .
	gªö°©e_∑th
 = 
ql_ªö°©e_∑th
,

231 .
	g£À˘_∑th
 = 
ql_£À˘_∑th
,

232 .
	g°¨t_io
 = 
ql_°¨t_io
,

233 .
	gíd_io
 = 
ql_íd_io
,

236 
__öô
 
	$dm_ql_öô
()

238 
r
 = 
	`dm_ªgi°î_∑th_£À˘‹
(&
ql_ps
);

240 i‡(
r
 < 0)

241 
	`DMERR
("ªgi°î faûed %d", 
r
);

243 
	`DMINFO
("vîsi⁄ " 
QL_VERSION
 "Üoaded");

245  
r
;

246 
	}
}

248 
__exô
 
	$dm_ql_exô
()

250 
r
 = 
	`dm_uƒegi°î_∑th_£À˘‹
(&
ql_ps
);

252 i‡(
r
 < 0)

253 
	`DMERR
("uƒegi°î faûed %d", 
r
);

254 
	}
}

256 
moduÀ_öô
(
dm_ql_öô
);

257 
moduÀ_exô
(
dm_ql_exô
);

259 
MODULE_AUTHOR
("Stefan Bader <Stefan.Baderát de.ibm.com>");

260 
MODULE_DESCRIPTION
(

262 
DM_NAME
 "Öath selectorÅo balanceÅheÇumber of in-flight I/Os"

264 
MODULE_LICENSE
("GPL");

	@dm-queue-length.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xa1a86d48, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_∑th_£À˘‹
) },

24 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

25 { 0x32d0b785, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_∑th_£À˘‹
) },

26 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

27 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

28 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

29 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

30 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

31 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

34 c⁄° 
	g__moduÀ_dïíds
[]

35 
__u£d


36 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

40 
MODULE_INFO
(
§cvîsi⁄
, "950B49FEC14EA0461258C3A");

	@dm-raid.c

8 
	~<löux/¶ab.h
>

9 
	~<löux/moduÀ.h
>

11 
	~"md.h
"

12 
	~"øid1.h
"

13 
	~"øid5.h
"

14 
	~"øid10.h
"

15 
	~"bôm≠.h
"

17 
	~<löux/devi˚-m≠≥r.h
>

19 
	#DM_MSG_PREFIX
 "øid"

	)

25 
	#Fú°U£
 10

	)

27 
	søid_dev
 {

40 
dm_dev
 *
	mmëa_dev
;

41 
dm_dev
 *
	md©a_dev
;

42 
md_rdev
 
	mrdev
;

48 
	#DMPF_SYNC
 0x1

	)

49 
	#DMPF_NOSYNC
 0x2

	)

50 
	#DMPF_REBUILD
 0x4

	)

51 
	#DMPF_DAEMON_SLEEP
 0x8

	)

52 
	#DMPF_MIN_RECOVERY_RATE
 0x10

	)

53 
	#DMPF_MAX_RECOVERY_RATE
 0x20

	)

54 
	#DMPF_MAX_WRITE_BEHIND
 0x40

	)

55 
	#DMPF_STRIPE_CACHE
 0x80

	)

56 
	#DMPF_REGION_SIZE
 0x100

	)

57 
	#DMPF_RAID10_COPIES
 0x200

	)

58 
	#DMPF_RAID10_FORMAT
 0x400

	)

60 
	søid_£t
 {

61 
dm_èrgë
 *
	mti
;

63 
uöt32_t
 
	mbôm≠_lﬂded
;

64 
uöt32_t
 
	m¥öt_Êags
;

66 
mddev
 
	mmd
;

67 
øid_ty≥
 *
	møid_ty≥
;

68 
dm_èrgë_ˇŒbacks
 
	mˇŒbacks
;

70 
øid_dev
 
	mdev
[0];

74 
	søid_ty≥
 {

75 c⁄° *
	m«me
;

76 c⁄° *
	mdes¸
;

77 c⁄° 
	m∑rôy_devs
;

78 c⁄° 
	mmöimÆ_devs
;

79 c⁄° 
	mÀvñ
;

80 c⁄° 
	mÆg‹ôhm
;

81 } 
	gøid_ty≥s
[] = {

83 {"øid10", "RAID10 (°rùed múr‹s)", 0, 2, 10, 
UINT_MAX
 },

84 {"øid4", "RAID4 (dediˇãdÖ¨ôy disk)", 1, 2, 5, 
ALGORITHM_PARITY_0
},

85 {"øid5_œ", "RAID5 (À·ásymmëric)", 1, 2, 5, 
ALGORITHM_LEFT_ASYMMETRIC
},

86 {"øid5_ø", "RAID5 (righàasymmëric)", 1, 2, 5, 
ALGORITHM_RIGHT_ASYMMETRIC
},

87 {"øid5_ls", "RAID5 (À· symmëric)", 1, 2, 5, 
ALGORITHM_LEFT_SYMMETRIC
},

88 {"øid5_rs", "RAID5 (righàsymmëric)", 1, 2, 5, 
ALGORITHM_RIGHT_SYMMETRIC
},

89 {"øid6_zr", "RAID6 (zîÿª°¨t)", 2, 4, 6, 
ALGORITHM_ROTATING_ZERO_RESTART
},

90 {"øid6_ƒ", "RAID6 (NÑe°¨t)", 2, 4, 6, 
ALGORITHM_ROTATING_N_RESTART
},

91 {"øid6_nc", "RAID6 (N c⁄töue)", 2, 4, 6, 
ALGORITHM_ROTATING_N_CONTINUE
}

94 *
	$øid10_md_œyout_to_f‹m©
(
œyout
)

100 i‡((
œyout
 & 0x10000) && (layout & 0x20000))

103 i‡((
œyout
 & 0xFF) > 1)

107 
	}
}

109 
	$øid10_md_œyout_to_c›õs
(
œyout
)

111 i‡((
œyout
 & 0xFF) > 1)

112  
œyout
 & 0xFF;

113  (
œyout
 >> 8) & 0xFF;

114 
	}
}

116 
	$øid10_f‹m©_to_md_œyout
(*
f‹m©
, 
c›õs
)

118 
n
 = 1, 
f
 = 1;

120 i‡(!
	`°rcmp
("√¨", 
f‹m©
))

121 
n
 = 
c›õs
;

123 
f
 = 
c›õs
;

125 i‡(!
	`°rcmp
("off£t", 
f‹m©
))

126  0x30000 | (
f
 << 8Ë| 
n
;

128 i‡(!
	`°rcmp
("Ár", 
f‹m©
))

129  0x20000 | (
f
 << 8Ë| 
n
;

131  (
f
 << 8Ë| 
n
;

132 
	}
}

134 
øid_ty≥
 *
	$gë_øid_ty≥
(*
«me
)

136 
i
;

138 
i
 = 0; i < 
	`ARRAY_SIZE
(
øid_ty≥s
); i++)

139 i‡(!
	`°rcmp
(
øid_ty≥s
[
i
].
«me
,Çame))

140  &
øid_ty≥s
[
i
];

142  
NULL
;

143 
	}
}

145 
øid_£t
 *
	$c⁄ãxt_Æloc
(
dm_èrgë
 *
ti
, 
øid_ty≥
 *øid_ty≥, 
øid_devs
)

147 
i
;

148 
øid_£t
 *
rs
;

150 i‡(
øid_devs
 <
øid_ty≥
->
∑rôy_devs
) {

151 
ti
->
îr‹
 = "InsufficientÇumber of devices";

152  
	`ERR_PTR
(-
EINVAL
);

155 
rs
 = 
	`kzÆloc
((*rsË+ 
øid_devs
 * ‘s->
dev
[0]), 
GFP_KERNEL
);

156 i‡(!
rs
) {

157 
ti
->
îr‹
 = "CannotállocateÑaid context";

158  
	`ERR_PTR
(-
ENOMEM
);

161 
	`mddev_öô
(&
rs
->
md
);

163 
rs
->
ti
 =Åi;

164 
rs
->
øid_ty≥
 =Ñaid_type;

165 
rs
->
md
.
øid_disks
 = 
øid_devs
;

166 
rs
->
md
.
Àvñ
 = 
øid_ty≥
->level;

167 
rs
->
md
.
√w_Àvñ
 =Ñs->md.
Àvñ
;

168 
rs
->
md
.
œyout
 = 
øid_ty≥
->
Æg‹ôhm
;

169 
rs
->
md
.
√w_œyout
 =Ñs->md.
œyout
;

170 
rs
->
md
.
dñè_disks
 = 0;

171 
rs
->
md
.
ªcovîy_˝
 = 0;

173 
i
 = 0; i < 
øid_devs
; i++)

174 
	`md_rdev_öô
(&
rs
->
dev
[
i
].
rdev
);

185  
rs
;

186 
	}
}

188 
	$c⁄ãxt_‰ì
(
øid_£t
 *
rs
)

190 
i
;

192 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

193 i‡(
rs
->
dev
[
i
].
mëa_dev
)

194 
	`dm_put_devi˚
(
rs
->
ti
,Ñs->
dev
[
i
].
mëa_dev
);

195 
	`md_rdev_˛ór
(&
rs
->
dev
[
i
].
rdev
);

196 i‡(
rs
->
dev
[
i
].
d©a_dev
)

197 
	`dm_put_devi˚
(
rs
->
ti
,Ñs->
dev
[
i
].
d©a_dev
);

200 
	`k‰ì
(
rs
);

201 
	}
}

219 
	$dev_∑rms
(
øid_£t
 *
rs
, **
¨gv
)

221 
i
;

222 
ªbuûd
 = 0;

223 
mëad©a_avaûabÀ
 = 0;

224 
ªt
 = 0;

226 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++, 
¨gv
 += 2) {

227 
rs
->
dev
[
i
].
rdev
.
øid_disk
 = i;

229 
rs
->
dev
[
i
].
mëa_dev
 = 
NULL
;

230 
rs
->
dev
[
i
].
d©a_dev
 = 
NULL
;

236 
rs
->
dev
[
i
].
rdev
.
d©a_off£t
 = 0;

237 
rs
->
dev
[
i
].
rdev
.
mddev
 = &rs->
md
;

239 i‡(
	`°rcmp
(
¨gv
[0], "-")) {

240 
ªt
 = 
	`dm_gë_devi˚
(
rs
->
ti
, 
¨gv
[0],

241 
	`dm_èbÀ_gë_mode
(
rs
->
ti
->
èbÀ
),

242 &
rs
->
dev
[
i
].
mëa_dev
);

243 
rs
->
ti
->
îr‹
 = "RAID metadata deviceÜookup failure";

244 i‡(
ªt
)

245  
ªt
;

247 
rs
->
dev
[
i
].
rdev
.
sb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

248 i‡(!
rs
->
dev
[
i
].
rdev
.
sb_∑ge
)

249  -
ENOMEM
;

252 i‡(!
	`°rcmp
(
¨gv
[1], "-")) {

253 i‡(!
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
) &&

254 (!
rs
->
dev
[
i
].
rdev
.
ªcovîy_off£t
)) {

255 
rs
->
ti
->
îr‹
 = "Drive designated forÑebuildÇot specified";

256  -
EINVAL
;

259 
rs
->
ti
->
îr‹
 = "No data device supplied with metadata device";

260 i‡(
rs
->
dev
[
i
].
mëa_dev
)

261  -
EINVAL
;

266 
ªt
 = 
	`dm_gë_devi˚
(
rs
->
ti
, 
¨gv
[1],

267 
	`dm_èbÀ_gë_mode
(
rs
->
ti
->
èbÀ
),

268 &
rs
->
dev
[
i
].
d©a_dev
);

269 i‡(
ªt
) {

270 
rs
->
ti
->
îr‹
 = "RAID deviceÜookup failure";

271  
ªt
;

274 i‡(
rs
->
dev
[
i
].
mëa_dev
) {

275 
mëad©a_avaûabÀ
 = 1;

276 
rs
->
dev
[
i
].
rdev
.
mëa_bdev
 =Ñs->dev[i].
mëa_dev
->
bdev
;

278 
rs
->
dev
[
i
].
rdev
.
bdev
 =Ñs->dev[i].
d©a_dev
->bdev;

279 
	`li°_add
(&
rs
->
dev
[
i
].
rdev
.
ßme_£t
, &rs->
md
.
disks
);

280 i‡(!
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

281 
ªbuûd
++;

284 i‡(
mëad©a_avaûabÀ
) {

285 
rs
->
md
.
exã∫Æ
 = 0;

286 
rs
->
md
.
≥rsi°ít
 = 1;

287 
rs
->
md
.
maj‹_vîsi⁄
 = 2;

288 } i‡(
ªbuûd
 && !
rs
->
md
.
ªcovîy_˝
) {

300 
	`DMERR
("UnableÅoÑebuild drive whileárray isÇot in-sync");

301 
rs
->
ti
->
îr‹
 = "RAID deviceÜookup failure";

302  -
EINVAL
;

306 
	}
}

318 
	$vÆid©e_ªgi⁄_size
(
øid_£t
 *
rs
, 
ªgi⁄_size
)

320 
mö_ªgi⁄_size
 = 
rs
->
ti
->
Àn
 / (1 << 21);

322 i‡(!
ªgi⁄_size
) {

326 i‡(
mö_ªgi⁄_size
 > (1 << 13)) {

328 i‡(
mö_ªgi⁄_size
 & (min_region_size - 1))

329 
ªgi⁄_size
 = 1 << 
	`Ês
(region_size);

330 
	`DMINFO
("Choosing defaultÑegion size of %lu sectors",

331 
ªgi⁄_size
);

333 
	`DMINFO
("Choosing defaultÑegion size of 4MiB");

334 
ªgi⁄_size
 = 1 << 13;

340 i‡(
ªgi⁄_size
 > 
rs
->
ti
->
Àn
) {

341 
rs
->
ti
->
îr‹
 = "SuppliedÑegion size isÅooÜarge";

342  -
EINVAL
;

345 i‡(
ªgi⁄_size
 < 
mö_ªgi⁄_size
) {

346 
	`DMERR
("SuppliedÑegion_size (%lu sectors) below minimum (%lu)",

347 
ªgi⁄_size
, 
mö_ªgi⁄_size
);

348 
rs
->
ti
->
îr‹
 = "SuppliedÑegion size isÅoo small";

349  -
EINVAL
;

352 i‡(!
	`is_powî_of_2
(
ªgi⁄_size
)) {

353 
rs
->
ti
->
îr‹
 = "Region size isÇotáÖower of 2";

354  -
EINVAL
;

357 i‡(
ªgi⁄_size
 < 
rs
->
md
.
chunk_£˘‹s
) {

358 
rs
->
ti
->
îr‹
 = "Region size is smallerÅhanÅhe chunk size";

359  -
EINVAL
;

366 
rs
->
md
.
bôm≠_öfo
.
chunksize
 = (
ªgi⁄_size
 << 9);

369 
	}
}

380 
	$vÆid©e_øid_ªdund™cy
(
øid_£t
 *
rs
)

382 
i
, 
ªbuûd_˙t
 = 0;

383 
ªbuûds_≥r_group
 = 0, 
c›õs
, 
d
;

384 
group_size
, 
œ°_group_°¨t
;

386 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++)

387 i‡(!
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
) ||

388 !
rs
->
dev
[
i
].
rdev
.
sb_∑ge
)

389 
ªbuûd_˙t
++;

391 
rs
->
øid_ty≥
->
Àvñ
) {

393 i‡(
ªbuûd_˙t
 >
rs
->
md
.
øid_disks
)

394 
too_m™y
;

399 i‡(
ªbuûd_˙t
 > 
rs
->
øid_ty≥
->
∑rôy_devs
)

400 
too_m™y
;

403 
c›õs
 = 
	`øid10_md_œyout_to_c›õs
(
rs
->
md
.
œyout
);

404 i‡(
ªbuûd_˙t
 < 
c›õs
)

421 i‡(!
	`°rcmp
("√¨", 
	`øid10_md_œyout_to_f‹m©
(
rs
->
md
.
œyout
))) {

422 
i
 = 0; i < 
rs
->
md
.
øid_disks
 * 
c›õs
; i++) {

423 i‡(!(
i
 % 
c›õs
))

424 
ªbuûds_≥r_group
 = 0;

425 
d
 = 
i
 % 
rs
->
md
.
øid_disks
;

426 i‡((!
rs
->
dev
[
d
].
rdev
.
sb_∑ge
 ||

427 !
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
d
].
rdev
.
Êags
)) &&

428 (++
ªbuûds_≥r_group
 >
c›õs
))

429 
too_m™y
;

446 
group_size
 = (
rs
->
md
.
øid_disks
 / 
c›õs
);

447 
œ°_group_°¨t
 = (
rs
->
md
.
øid_disks
 / 
group_size
) - 1;

448 
œ°_group_°¨t
 *
group_size
;

449 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

450 i‡(!(
i
 % 
c›õs
Ë&& !(ò> 
œ°_group_°¨t
))

451 
ªbuûds_≥r_group
 = 0;

452 i‡((!
rs
->
dev
[
i
].
rdev
.
sb_∑ge
 ||

453 !
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
)) &&

454 (++
ªbuûds_≥r_group
 >
c›õs
))

455 
too_m™y
;

459 i‡(
ªbuûd_˙t
)

460  -
EINVAL
;

465 
too_m™y
:

466  -
EINVAL
;

467 
	}
}

492 
	$∑r£_øid_∑øms
(
øid_£t
 *
rs
, **
¨gv
,

493 
num_øid_∑øms
)

495 *
øid10_f‹m©
 = "near";

496 
øid10_c›õs
 = 2;

497 
i
;

498 
vÆue
, 
ªgi⁄_size
 = 0;

499 
£˘‹_t
 
£˘‹s_≥r_dev
 = 
rs
->
ti
->
Àn
;

500 
£˘‹_t
 
max_io_Àn
;

501 *
key
;

507 i‡((
	`k°πoul
(
¨gv
[0], 10, &
vÆue
) < 0)) {

508 
rs
->
ti
->
îr‹
 = "Bad chunk size";

509  -
EINVAL
;

510 } i‡(
rs
->
øid_ty≥
->
Àvñ
 == 1) {

511 i‡(
vÆue
)

512 
	`DMERR
("Ignoring chunk sizeÖarameter for RAID 1");

513 
vÆue
 = 0;

514 } i‡(!
	`is_powî_of_2
(
vÆue
)) {

515 
rs
->
ti
->
îr‹
 = "Chunk size must beáÖower of 2";

516  -
EINVAL
;

517 } i‡(
vÆue
 < 8) {

518 
rs
->
ti
->
îr‹
 = "Chunk size value isÅoo small";

519  -
EINVAL
;

522 
rs
->
md
.
√w_chunk_£˘‹s
 =Ñs->md.
chunk_£˘‹s
 = 
vÆue
;

523 
¨gv
++;

524 
num_øid_∑øms
--;

543 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

544 
	`£t_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
);

545 
rs
->
dev
[
i
].
rdev
.
ªcovîy_off£t
 = 
MaxSe˘‹
;

551 
i
 = 0; i < 
num_øid_∑øms
; i++) {

552 i‡(!
	`°rˇ£cmp
(
¨gv
[
i
], "nosync")) {

553 
rs
->
md
.
ªcovîy_˝
 = 
MaxSe˘‹
;

554 
rs
->
¥öt_Êags
 |
DMPF_NOSYNC
;

557 i‡(!
	`°rˇ£cmp
(
¨gv
[
i
], "sync")) {

558 
rs
->
md
.
ªcovîy_˝
 = 0;

559 
rs
->
¥öt_Êags
 |
DMPF_SYNC
;

564 i‡((
i
 + 1Ë>
num_øid_∑øms
) {

565 
rs
->
ti
->
îr‹
 = "WrongÇumber ofÑaidÖarameters given";

566  -
EINVAL
;

569 
key
 = 
¨gv
[
i
++];

572 i‡(!
	`°rˇ£cmp
(
key
, "raid10_format")) {

573 i‡(
rs
->
øid_ty≥
->
Àvñ
 != 10) {

574 
rs
->
ti
->
îr‹
 = "'raid10_format' isán invalidÖarameter forÅhis RAIDÅype";

575  -
EINVAL
;

577 i‡(
	`°rcmp
("√¨", 
¨gv
[
i
]) &&

578 
	`°rcmp
("Ár", 
¨gv
[
i
]) &&

579 
	`°rcmp
("off£t", 
¨gv
[
i
])) {

580 
rs
->
ti
->
îr‹
 = "Invalid 'raid10_format' value given";

581  -
EINVAL
;

583 
øid10_f‹m©
 = 
¨gv
[
i
];

584 
rs
->
¥öt_Êags
 |
DMPF_RAID10_FORMAT
;

588 i‡(
	`k°πoul
(
¨gv
[
i
], 10, &
vÆue
) < 0) {

589 
rs
->
ti
->
îr‹
 = "BadÇumericalárgument given inÑaidÖarams";

590  -
EINVAL
;

594 i‡(!
	`°rˇ£cmp
(
key
, "rebuild")) {

595 i‡(
vÆue
 >
rs
->
md
.
øid_disks
) {

596 
rs
->
ti
->
îr‹
 = "InvalidÑebuild index given";

597  -
EINVAL
;

599 
	`˛ór_bô
(
In_sync
, &
rs
->
dev
[
vÆue
].
rdev
.
Êags
);

600 
rs
->
dev
[
vÆue
].
rdev
.
ªcovîy_off£t
 = 0;

601 
rs
->
¥öt_Êags
 |
DMPF_REBUILD
;

602 } i‡(!
	`°rˇ£cmp
(
key
, "write_mostly")) {

603 i‡(
rs
->
øid_ty≥
->
Àvñ
 != 1) {

604 
rs
->
ti
->
îr‹
 = "write_mostly option is only valid for RAID1";

605  -
EINVAL
;

607 i‡(
vÆue
 >
rs
->
md
.
øid_disks
) {

608 
rs
->
ti
->
îr‹
 = "Invalid write_mostly drive index given";

609  -
EINVAL
;

611 
	`£t_bô
(
WrôeMo°ly
, &
rs
->
dev
[
vÆue
].
rdev
.
Êags
);

612 } i‡(!
	`°rˇ£cmp
(
key
, "max_write_behind")) {

613 i‡(
rs
->
øid_ty≥
->
Àvñ
 != 1) {

614 
rs
->
ti
->
îr‹
 = "max_write_behind option is only valid for RAID1";

615  -
EINVAL
;

617 
rs
->
¥öt_Êags
 |
DMPF_MAX_WRITE_BEHIND
;

623 
vÆue
 /= 2;

624 i‡(
vÆue
 > 
COUNTER_MAX
) {

625 
rs
->
ti
->
îr‹
 = "Max write-behindÜimit out ofÑange";

626  -
EINVAL
;

628 
rs
->
md
.
bôm≠_öfo
.
max_wrôe_behöd
 = 
vÆue
;

629 } i‡(!
	`°rˇ£cmp
(
key
, "daemon_sleep")) {

630 
rs
->
¥öt_Êags
 |
DMPF_DAEMON_SLEEP
;

631 i‡(!
vÆue
 || (vÆuê> 
MAX_SCHEDULE_TIMEOUT
)) {

632 
rs
->
ti
->
îr‹
 = "daemon sleepÖeriod out ofÑange";

633  -
EINVAL
;

635 
rs
->
md
.
bôm≠_öfo
.
d´m⁄_¶ìp
 = 
vÆue
;

636 } i‡(!
	`°rˇ£cmp
(
key
, "stripe_cache")) {

637 
rs
->
¥öt_Êags
 |
DMPF_STRIPE_CACHE
;

643 
vÆue
 /= 2;

645 i‡((
rs
->
øid_ty≥
->
Àvñ
 != 5) &&

646 (
rs
->
øid_ty≥
->
Àvñ
 != 6)) {

647 
rs
->
ti
->
îr‹
 = "Inappropriateárgument: stripe_cache";

648  -
EINVAL
;

650 i‡(
	`øid5_£t_ˇche_size
(&
rs
->
md
, ()
vÆue
)) {

651 
rs
->
ti
->
îr‹
 = "Bad stripe_cache size";

652  -
EINVAL
;

654 } i‡(!
	`°rˇ£cmp
(
key
, "min_recovery_rate")) {

655 
rs
->
¥öt_Êags
 |
DMPF_MIN_RECOVERY_RATE
;

656 i‡(
vÆue
 > 
INT_MAX
) {

657 
rs
->
ti
->
îr‹
 = "min_recovery_rate out ofÑange";

658  -
EINVAL
;

660 
rs
->
md
.
sync_•ìd_mö
 = ()
vÆue
;

661 } i‡(!
	`°rˇ£cmp
(
key
, "max_recovery_rate")) {

662 
rs
->
¥öt_Êags
 |
DMPF_MAX_RECOVERY_RATE
;

663 i‡(
vÆue
 > 
INT_MAX
) {

664 
rs
->
ti
->
îr‹
 = "max_recovery_rate out ofÑange";

665  -
EINVAL
;

667 
rs
->
md
.
sync_•ìd_max
 = ()
vÆue
;

668 } i‡(!
	`°rˇ£cmp
(
key
, "region_size")) {

669 
rs
->
¥öt_Êags
 |
DMPF_REGION_SIZE
;

670 
ªgi⁄_size
 = 
vÆue
;

671 } i‡(!
	`°rˇ£cmp
(
key
, "raid10_copies") &&

672 (
rs
->
øid_ty≥
->
Àvñ
 == 10)) {

673 i‡((
vÆue
 < 2) || (value > 0xFF)) {

674 
rs
->
ti
->
îr‹
 = "Bad value for 'raid10_copies'";

675  -
EINVAL
;

677 
rs
->
¥öt_Êags
 |
DMPF_RAID10_COPIES
;

678 
øid10_c›õs
 = 
vÆue
;

680 
	`DMERR
("U«bÀÅÿ∑r£ RAIDÖ¨amëî: %s", 
key
);

681 
rs
->
ti
->
îr‹
 = "UnableÅoÖarse RAIDÖarameters";

682  -
EINVAL
;

686 i‡(
	`vÆid©e_ªgi⁄_size
(
rs
, 
ªgi⁄_size
))

687  -
EINVAL
;

689 i‡(
rs
->
md
.
chunk_£˘‹s
)

690 
max_io_Àn
 = 
rs
->
md
.
chunk_£˘‹s
;

692 
max_io_Àn
 = 
ªgi⁄_size
;

694 i‡(
	`dm_£t_èrgë_max_io_Àn
(
rs
->
ti
, 
max_io_Àn
))

695  -
EINVAL
;

697 i‡(
rs
->
øid_ty≥
->
Àvñ
 == 10) {

698 i‡(
øid10_c›õs
 > 
rs
->
md
.
øid_disks
) {

699 
rs
->
ti
->
îr‹
 = "NotÉnough devicesÅo satisfy specification";

700  -
EINVAL
;

707 i‡(
	`°rcmp
("√¨", 
øid10_f‹m©
Ë&& (
øid10_c›õs
 > 2)) {

708 
rs
->
ti
->
îr‹
 = "Too many copies for given RAID10 format.";

709  -
EINVAL
;

713 
£˘‹s_≥r_dev
 = 
rs
->
ti
->
Àn
 * 
øid10_c›õs
;

714 
	`£˘‹_div
(
£˘‹s_≥r_dev
, 
rs
->
md
.
øid_disks
);

716 
rs
->
md
.
œyout
 = 
	`øid10_f‹m©_to_md_œyout
(
øid10_f‹m©
,

717 
øid10_c›õs
);

718 
rs
->
md
.
√w_œyout
 =Ñs->md.
œyout
;

719 } i‡((
rs
->
øid_ty≥
->
Àvñ
 > 1) &&

720 
	`£˘‹_div
(
£˘‹s_≥r_dev
,

721 (
rs
->
md
.
øid_disks
 -Ñs->
øid_ty≥
->
∑rôy_devs
))) {

722 
rs
->
ti
->
îr‹
 = "TargetÜengthÇot divisible byÇumber of data devices";

723  -
EINVAL
;

725 
rs
->
md
.
dev_£˘‹s
 = 
£˘‹s_≥r_dev
;

728 
rs
->
md
.
≥rsi°ít
 = 0;

729 
rs
->
md
.
exã∫Æ
 = 1;

732 
	}
}

734 
	$do_èbÀ_evít
(
w‹k_°ru˘
 *
ws
)

736 
øid_£t
 *
rs
 = 
	`c⁄èöî_of
(
ws
, øid_£t, 
md
.
evít_w‹k
);

738 
	`dm_èbÀ_evít
(
rs
->
ti
->
èbÀ
);

739 
	}
}

741 
	$øid_is_c⁄ge°ed
(
dm_èrgë_ˇŒbacks
 *
cb
, 
bôs
)

743 
øid_£t
 *
rs
 = 
	`c⁄èöî_of
(
cb
, øid_£t, 
ˇŒbacks
);

745 i‡(
rs
->
øid_ty≥
->
Àvñ
 == 1)

746  
	`md_øid1_c⁄ge°ed
(&
rs
->
md
, 
bôs
);

748 i‡(
rs
->
øid_ty≥
->
Àvñ
 == 10)

749  
	`md_øid10_c⁄ge°ed
(&
rs
->
md
, 
bôs
);

751  
	`md_øid5_c⁄ge°ed
(&
rs
->
md
, 
bôs
);

752 
	}
}

758 
	#DM_RAID_MAGIC
 0x64526D44

	)

759 
	sdm_øid_su≥rblock
 {

760 
__À32
 
	mmagic
;

761 
__À32
 
	m„©uªs
;

763 
__À32
 
	mnum_devi˚s
;

764 
__À32
 
	m¨øy_posôi⁄
;

766 
__À64
 
	mevíts
;

767 
__À64
 
	mÁûed_devi˚s
;

773 
__À64
 
	mdisk_ªcovîy_off£t
;

779 
__À64
 
	m¨øy_ªsync_off£t
;

784 
__À32
 
	mÀvñ
;

785 
__À32
 
	mœyout
;

786 
__À32
 
	m°rùe_£˘‹s
;

788 
__u8
 
	m∑d
[452];

790 } 
	g__∑cked
;

792 
	$ªad_disk_sb
(
md_rdev
 *
rdev
, 
size
)

794 
	`BUG_ON
(!
rdev
->
sb_∑ge
);

796 i‡(
rdev
->
sb_lﬂded
)

799 i‡(!
	`sync_∑ge_io
(
rdev
, 0, 
size
,Ñdev->
sb_∑ge
, 
READ
, 1)) {

800 
	`DMERR
("FailedÅoÑead superblock of deviceátÖosition %d",

801 
rdev
->
øid_disk
);

802 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

803  -
EINVAL
;

806 
rdev
->
sb_lﬂded
 = 1;

809 
	}
}

811 
	$su≥r_sync
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

813 
i
;

814 
uöt64_t
 
Áûed_devi˚s
;

815 
dm_øid_su≥rblock
 *
sb
;

816 
øid_£t
 *
rs
 = 
	`c⁄èöî_of
(
mddev
, øid_£t, 
md
);

818 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

819 
Áûed_devi˚s
 = 
	`À64_to_˝u
(
sb
->failed_devices);

821 
i
 = 0; i < 
mddev
->
øid_disks
; i++)

822 i‡(!
rs
->
dev
[
i
].
d©a_dev
 ||

823 
	`ã°_bô
(
Fau…y
, &(
rs
->
dev
[
i
].
rdev
.
Êags
)))

824 
Áûed_devi˚s
 |(1ULL << 
i
);

826 
	`mem£t
(
sb
, 0, (*sb));

828 
sb
->
magic
 = 
	`˝u_to_À32
(
DM_RAID_MAGIC
);

829 
sb
->
„©uªs
 = 
	`˝u_to_À32
(0);

831 
sb
->
num_devi˚s
 = 
	`˝u_to_À32
(
mddev
->
øid_disks
);

832 
sb
->
¨øy_posôi⁄
 = 
	`˝u_to_À32
(
rdev
->
øid_disk
);

834 
sb
->
evíts
 = 
	`˝u_to_À64
(
mddev
->events);

835 
sb
->
Áûed_devi˚s
 = 
	`˝u_to_À64
(failed_devices);

837 
sb
->
disk_ªcovîy_off£t
 = 
	`˝u_to_À64
(
rdev
->
ªcovîy_off£t
);

838 
sb
->
¨øy_ªsync_off£t
 = 
	`˝u_to_À64
(
mddev
->
ªcovîy_˝
);

840 
sb
->
Àvñ
 = 
	`˝u_to_À32
(
mddev
->level);

841 
sb
->
œyout
 = 
	`˝u_to_À32
(
mddev
->layout);

842 
sb
->
°rùe_£˘‹s
 = 
	`˝u_to_À32
(
mddev
->
chunk_£˘‹s
);

843 
	}
}

853 
	$su≥r_lﬂd
(
md_rdev
 *
rdev
, md_rdev *
ªfdev
)

855 
ªt
;

856 
dm_øid_su≥rblock
 *
sb
;

857 
dm_øid_su≥rblock
 *
ªfsb
;

858 
uöt64_t
 
evíts_sb
, 
evíts_ªfsb
;

860 
rdev
->
sb_°¨t
 = 0;

861 
rdev
->
sb_size
 = (*
sb
);

863 
ªt
 = 
	`ªad_disk_sb
(
rdev
,Ñdev->
sb_size
);

864 i‡(
ªt
)

865  
ªt
;

867 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

874 i‡((
sb
->
magic
 !
	`˝u_to_À32
(
DM_RAID_MAGIC
)) ||

875 (!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
Ë&& !rdev->
ªcovîy_off£t
)) {

876 
	`su≥r_sync
(
rdev
->
mddev
,Ñdev);

878 
	`£t_bô
(
Fú°U£
, &
rdev
->
Êags
);

881 
	`£t_bô
(
MD_CHANGE_DEVS
, &
rdev
->
mddev
->
Êags
);

884  
ªfdev
 ? 0 : 1;

887 i‡(!
ªfdev
)

890 
evíts_sb
 = 
	`À64_to_˝u
(
sb
->
evíts
);

892 
ªfsb
 = 
	`∑ge_addªss
(
ªfdev
->
sb_∑ge
);

893 
evíts_ªfsb
 = 
	`À64_to_˝u
(
ªfsb
->
evíts
);

895  (
evíts_sb
 > 
evíts_ªfsb
) ? 1 : 0;

896 
	}
}

898 
	$su≥r_öô_vÆid©i⁄
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

900 
rﬁe
;

901 
øid_£t
 *
rs
 = 
	`c⁄èöî_of
(
mddev
, øid_£t, 
md
);

902 
uöt64_t
 
evíts_sb
;

903 
uöt64_t
 
Áûed_devi˚s
;

904 
dm_øid_su≥rblock
 *
sb
;

905 
uöt32_t
 
√w_devs
 = 0;

906 
uöt32_t
 
ªbuûds
 = 0;

907 
md_rdev
 *
r
;

908 
dm_øid_su≥rblock
 *
sb2
;

910 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

911 
evíts_sb
 = 
	`À64_to_˝u
(
sb
->
evíts
);

912 
Áûed_devi˚s
 = 
	`À64_to_˝u
(
sb
->failed_devices);

917 
mddev
->
evíts
 = 
evíts_sb
 ? : 1;

922 i‡(
	`À32_to_˝u
(
sb
->
Àvñ
Ë!
mddev
->level) {

923 
	`DMERR
("ReshapingárraysÇot yet supported. (RAIDÜevel change)");

924  -
EINVAL
;

926 i‡(
	`À32_to_˝u
(
sb
->
œyout
Ë!
mddev
->layout) {

927 
	`DMERR
("ReshapingárraysÇot yet supported. (RAIDÜayout change)");

928 
	`DMERR
(" 0x%X v†0x%X", 
	`À32_to_˝u
(
sb
->
œyout
), 
mddev
->layout);

929 
	`DMERR
(" OldÜayout: %s w/ %d copies",

930 
	`øid10_md_œyout_to_f‹m©
(
	`À32_to_˝u
(
sb
->
œyout
)),

931 
	`øid10_md_œyout_to_c›õs
(
	`À32_to_˝u
(
sb
->
œyout
)));

932 
	`DMERR
(" NewÜayout: %s w/ %d copies",

933 
	`øid10_md_œyout_to_f‹m©
(
mddev
->
œyout
),

934 
	`øid10_md_œyout_to_c›õs
(
mddev
->
œyout
));

935  -
EINVAL
;

937 i‡(
	`À32_to_˝u
(
sb
->
°rùe_£˘‹s
Ë!
mddev
->
chunk_£˘‹s
) {

938 
	`DMERR
("ReshapingárraysÇot yet supported. (stripe sectors change)");

939  -
EINVAL
;

943 i‡((
rs
->
øid_ty≥
->
Àvñ
 != 1) &&

944 (
	`À32_to_˝u
(
sb
->
num_devi˚s
Ë!
mddev
->
øid_disks
)) {

945 
	`DMERR
("ReshapingárraysÇot yet supported. (device count change)");

946  -
EINVAL
;

949 i‡(!(
rs
->
¥öt_Êags
 & (
DMPF_SYNC
 | 
DMPF_NOSYNC
)))

950 
mddev
->
ªcovîy_˝
 = 
	`À64_to_˝u
(
sb
->
¨øy_ªsync_off£t
);

963 
	`rdev_f‹_óch
(
r
, 
mddev
) {

964 i‡(!
	`ã°_bô
(
In_sync
, &
r
->
Êags
)) {

965 
	`DMINFO
("Device %d specified forÑebuild: "

966 "CÀ¨ög su≥rblock", 
r
->
øid_disk
);

967 
ªbuûds
++;

968 } i‡(
	`ã°_bô
(
Fú°U£
, &
r
->
Êags
))

969 
√w_devs
++;

972 i‡(!
ªbuûds
) {

973 i‡(
√w_devs
 =
mddev
->
øid_disks
) {

974 
	`DMINFO
("Superblocks created forÇewárray");

975 
	`£t_bô
(
MD_ARRAY_FIRST_USE
, &
mddev
->
Êags
);

976 } i‡(
√w_devs
) {

977 
	`DMERR
("New device injected "

980  -
EINVAL
;

982 } i‡(
√w_devs
) {

983 
	`DMERR
("'rebuild' devices cannot be "

985  -
EINVAL
;

986 } i‡(
mddev
->
ªcovîy_˝
 !
MaxSe˘‹
) {

987 
	`DMERR
("'rebuild' specified whileárray isÇot in-sync");

988  -
EINVAL
;

995 
	`rdev_f‹_óch
(
r
, 
mddev
) {

996 i‡(!
r
->
sb_∑ge
)

998 
sb2
 = 
	`∑ge_addªss
(
r
->
sb_∑ge
);

999 
sb2
->
Áûed_devi˚s
 = 0;

1004 i‡(!
	`ã°_bô
(
Fú°U£
, &
r
->
Êags
Ë&& (r->
øid_disk
 >= 0)) {

1005 
rﬁe
 = 
	`À32_to_˝u
(
sb2
->
¨øy_posôi⁄
);

1006 i‡(
rﬁe
 !
r
->
øid_disk
) {

1007 i‡(
rs
->
øid_ty≥
->
Àvñ
 != 1) {

1008 
rs
->
ti
->
îr‹
 = "Cannot change device "

1010  -
EINVAL
;

1012 
	`DMINFO
("RAID1 device #%dÇowátÖosition #%d",

1013 
rﬁe
, 
r
->
øid_disk
);

1020 i‡(
Áûed_devi˚s
 & (1 << 
rﬁe
))

1021 
	`£t_bô
(
Fau…y
, &
r
->
Êags
);

1026 
	}
}

1028 
	$su≥r_vÆid©e
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1030 
dm_øid_su≥rblock
 *
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1036 i‡(!
mddev
->
evíts
 && 
	`su≥r_öô_vÆid©i⁄
(mddev, 
rdev
))

1037  -
EINVAL
;

1039 
mddev
->
bôm≠_öfo
.
off£t
 = 4096 >> 9;

1040 
rdev
->
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 = 4096 >> 9;

1041 i‡(!
	`ã°_bô
(
Fú°U£
, &
rdev
->
Êags
)) {

1042 
rdev
->
ªcovîy_off£t
 = 
	`À64_to_˝u
(
sb
->
disk_ªcovîy_off£t
);

1043 i‡(
rdev
->
ªcovîy_off£t
 !
MaxSe˘‹
)

1044 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1050 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

1051 
	`˛ór_bô
(
Fau…y
, &
rdev
->
Êags
);

1052 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1053 
rdev
->
ßved_øid_disk
 =Ñdev->
øid_disk
;

1054 
rdev
->
ªcovîy_off£t
 = 0;

1057 
	`˛ór_bô
(
Fú°U£
, &
rdev
->
Êags
);

1060 
	}
}

1065 
	$™Æy£_su≥rblocks
(
dm_èrgë
 *
ti
, 
øid_£t
 *
rs
)

1067 
ªt
;

1068 
øid_dev
 *
dev
;

1069 
md_rdev
 *
rdev
, *
tmp
, *
‰eshe°
;

1070 
mddev
 *mddev = &
rs
->
md
;

1072 
‰eshe°
 = 
NULL
;

1073 
	`rdev_f‹_óch_ß„
(
rdev
, 
tmp
, 
mddev
) {

1084 i‡(
rs
->
¥öt_Êags
 & 
DMPF_SYNC
)

1087 i‡(!
rdev
->
mëa_bdev
)

1090 
ªt
 = 
	`su≥r_lﬂd
(
rdev
, 
‰eshe°
);

1092 
ªt
) {

1094 
‰eshe°
 = 
rdev
;

1099 
dev
 = 
	`c⁄èöî_of
(
rdev
, 
øid_dev
,Ñdev);

1100 i‡(
dev
->
mëa_dev
)

1101 
	`dm_put_devi˚
(
ti
, 
dev
->
mëa_dev
);

1103 
dev
->
mëa_dev
 = 
NULL
;

1104 
rdev
->
mëa_bdev
 = 
NULL
;

1106 i‡(
rdev
->
sb_∑ge
)

1107 
	`put_∑ge
(
rdev
->
sb_∑ge
);

1109 
rdev
->
sb_∑ge
 = 
NULL
;

1111 
rdev
->
sb_lﬂded
 = 0;

1119 i‡(
dev
->
d©a_dev
)

1120 
	`dm_put_devi˚
(
ti
, 
dev
->
d©a_dev
);

1122 
dev
->
d©a_dev
 = 
NULL
;

1123 
rdev
->
bdev
 = 
NULL
;

1125 
	`li°_dñ
(&
rdev
->
ßme_£t
);

1129 i‡(!
‰eshe°
)

1132 i‡(
	`vÆid©e_øid_ªdund™cy
(
rs
)) {

1133 
rs
->
ti
->
îr‹
 = "InsufficientÑedundancyÅoáctivateárray";

1134  -
EINVAL
;

1141 
ti
->
îr‹
 = "UnableÅoássembleárray: Invalid superblocks";

1142 i‡(
	`su≥r_vÆid©e
(
mddev
, 
‰eshe°
))

1143  -
EINVAL
;

1145 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

1146 i‡((
rdev
 !
‰eshe°
Ë&& 
	`su≥r_vÆid©e
(
mddev
,Ñdev))

1147  -
EINVAL
;

1150 
	}
}

1161 
	$øid_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1163 
ªt
;

1164 
øid_ty≥
 *
π
;

1165 
num_øid_∑øms
, 
num_øid_devs
;

1166 
øid_£t
 *
rs
 = 
NULL
;

1169 i‡(
¨gc
 < 2) {

1170 
ti
->
îr‹
 = "Too fewárguments";

1171  -
EINVAL
;

1175 
π
 = 
	`gë_øid_ty≥
(
¨gv
[0]);

1176 i‡(!
π
) {

1177 
ti
->
îr‹
 = "UnrecognisedÑaid_type";

1178  -
EINVAL
;

1180 
¨gc
--;

1181 
¨gv
++;

1184 i‡(
	`k°πoul
(
¨gv
[0], 10, &
num_øid_∑øms
) < 0) {

1185 
ti
->
îr‹
 = "Cannot understandÇumber of RAIDÖarameters";

1186  -
EINVAL
;

1188 
¨gc
--;

1189 
¨gv
++;

1192 i‡(
num_øid_∑øms
 + 1 > 
¨gc
) {

1193 
ti
->
îr‹
 = "Arguments doÇotágree with counts given";

1194  -
EINVAL
;

1197 i‡((
	`k°πoul
(
¨gv
[
num_øid_∑øms
], 10, &
num_øid_devs
) < 0) ||

1198 (
num_øid_devs
 >
INT_MAX
)) {

1199 
ti
->
îr‹
 = "Cannot understandÇumber ofÑaid devices";

1200  -
EINVAL
;

1203 
rs
 = 
	`c⁄ãxt_Æloc
(
ti
, 
π
, ()
num_øid_devs
);

1204 i‡(
	`IS_ERR
(
rs
))

1205  
	`PTR_ERR
(
rs
);

1207 
ªt
 = 
	`∑r£_øid_∑øms
(
rs
, 
¨gv
, ()
num_øid_∑øms
);

1208 i‡(
ªt
)

1209 
bad
;

1211 
ªt
 = -
EINVAL
;

1213 
¨gc
 -
num_øid_∑øms
 + 1;

1214 
¨gv
 +
num_øid_∑øms
 + 1;

1216 i‡(
¨gc
 !(
num_øid_devs
 * 2)) {

1217 
ti
->
îr‹
 = "Supplied RAID devices doesÇot matchÅhe count given";

1218 
bad
;

1221 
ªt
 = 
	`dev_∑rms
(
rs
, 
¨gv
);

1222 i‡(
ªt
)

1223 
bad
;

1225 
rs
->
md
.
sync_su≥r
 = 
su≥r_sync
;

1226 
ªt
 = 
	`™Æy£_su≥rblocks
(
ti
, 
rs
);

1227 i‡(
ªt
)

1228 
bad
;

1230 
	`INIT_WORK
(&
rs
->
md
.
evít_w‹k
, 
do_èbÀ_evít
);

1231 
ti
->
¥iv©e
 = 
rs
;

1232 
ti
->
num_Êush_bios
 = 1;

1234 
	`muãx_lock
(&
rs
->
md
.
ªc⁄fig_muãx
);

1235 
ªt
 = 
	`md_run
(&
rs
->
md
);

1236 
rs
->
md
.
ö_sync
 = 0;

1237 
	`muãx_u∆ock
(&
rs
->
md
.
ªc⁄fig_muãx
);

1239 i‡(
ªt
) {

1240 
ti
->
îr‹
 = "FailÅoÑunÑaidárray";

1241 
bad
;

1244 i‡(
ti
->
Àn
 !
rs
->
md
.
¨øy_£˘‹s
) {

1245 
ti
->
îr‹
 = "Array size doesÇot matchÑequestedÅargetÜength";

1246 
ªt
 = -
EINVAL
;

1247 
size_mism©ch
;

1249 
rs
->
ˇŒbacks
.
c⁄ge°ed_‚
 = 
øid_is_c⁄ge°ed
;

1250 
	`dm_èbÀ_add_èrgë_ˇŒbacks
(
ti
->
èbÀ
, &
rs
->
ˇŒbacks
);

1252 
	`mddev_su•íd
(&
rs
->
md
);

1255 
size_mism©ch
:

1256 
	`md_°›
(&
rs
->
md
);

1257 
bad
:

1258 
	`c⁄ãxt_‰ì
(
rs
);

1260  
ªt
;

1261 
	}
}

1263 
	$øid_då
(
dm_èrgë
 *
ti
)

1265 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1267 
	`li°_dñ_öô
(&
rs
->
ˇŒbacks
.
li°
);

1268 
	`md_°›
(&
rs
->
md
);

1269 
	`c⁄ãxt_‰ì
(
rs
);

1270 
	}
}

1272 
	$øid_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1274 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1275 
mddev
 *mddev = &
rs
->
md
;

1277 
mddev
->
≥rs
->
	`make_ªque°
(mddev, 
bio
);

1279  
DM_MAPIO_SUBMITTED
;

1280 
	}
}

1282 c⁄° *
	$decùhî_sync_a˘i⁄
(
mddev
 *mddev)

1284 i‡(
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
))

1287 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
) ||

1288 (!
mddev
->
ro
 && 
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &mddev->
ªcovîy
))) {

1289 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

1292 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

1293 i‡(!
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

1295 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
))

1300 i‡(
	`ã°_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
))

1305 
	}
}

1307 
	$øid_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1308 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1310 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1311 
øid_∑øm_˙t
 = 1;

1312 
sz
 = 0;

1313 
i
, 
¨øy_ö_sync
 = 0;

1314 
£˘‹_t
 
sync
;

1316 
ty≥
) {

1317 
STATUSTYPE_INFO
:

1318 
	`DMEMIT
("%†%d ", 
rs
->
øid_ty≥
->
«me
,Ñs->
md
.
øid_disks
);

1320 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
rs
->
md
.
ªcovîy
))

1321 
sync
 = 
rs
->
md
.
cuº_ªsync_com∂ëed
;

1323 
sync
 = 
rs
->
md
.
ªcovîy_˝
;

1325 i‡(
sync
 >
rs
->
md
.
ªsync_max_£˘‹s
) {

1329 
¨øy_ö_sync
 = 1;

1330 
sync
 = 
rs
->
md
.
ªsync_max_£˘‹s
;

1331 } i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
rs
->
md
.
ªcovîy
)) {

1337 
¨øy_ö_sync
 = 1;

1345 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++)

1346 i‡(!
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1347 
¨øy_ö_sync
 = 1;

1356 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

1357 i‡(
	`ã°_bô
(
Fau…y
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1358 
	`DMEMIT
("D");

1359 i‡(!
¨øy_ö_sync
 ||

1360 !
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1361 
	`DMEMIT
("a");

1363 
	`DMEMIT
("A");

1374 
	`DMEMIT
(" %llu/%llu",

1375 (Ë
sync
,

1376 (Ë
rs
->
md
.
ªsync_max_£˘‹s
);

1383 
	`DMEMIT
(" %s", 
	`decùhî_sync_a˘i⁄
(&
rs
->
md
));

1390 
	`DMEMIT
(" %llu",

1391 (
	`°rcmp
(
rs
->
md
.
œ°_sync_a˘i⁄
, "check")) ? 0 :

1393 
	`©omic64_ªad
(&
rs
->
md
.
ªsync_mism©ches
));

1395 
STATUSTYPE_TABLE
:

1397 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

1398 i‡((
rs
->
¥öt_Êags
 & 
DMPF_REBUILD
) &&

1399 
rs
->
dev
[
i
].
d©a_dev
 &&

1400 !
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1401 
øid_∑øm_˙t
 += 2;

1402 i‡(
rs
->
dev
[
i
].
d©a_dev
 &&

1403 
	`ã°_bô
(
WrôeMo°ly
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1404 
øid_∑øm_˙t
 += 2;

1407 
øid_∑øm_˙t
 +(
	`hweight32
(
rs
->
¥öt_Êags
 & ~
DMPF_REBUILD
) * 2);

1408 i‡(
rs
->
¥öt_Êags
 & (
DMPF_SYNC
 | 
DMPF_NOSYNC
))

1409 
øid_∑øm_˙t
--;

1411 
	`DMEMIT
("%†%u %u", 
rs
->
øid_ty≥
->
«me
,

1412 
øid_∑øm_˙t
, 
rs
->
md
.
chunk_£˘‹s
);

1414 i‡((
rs
->
¥öt_Êags
 & 
DMPF_SYNC
) &&

1415 (
rs
->
md
.
ªcovîy_˝
 =
MaxSe˘‹
))

1416 
	`DMEMIT
(" sync");

1417 i‡(
rs
->
¥öt_Êags
 & 
DMPF_NOSYNC
)

1418 
	`DMEMIT
("Çosync");

1420 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++)

1421 i‡((
rs
->
¥öt_Êags
 & 
DMPF_REBUILD
) &&

1422 
rs
->
dev
[
i
].
d©a_dev
 &&

1423 !
	`ã°_bô
(
In_sync
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1424 
	`DMEMIT
("Ñebuûd %u", 
i
);

1426 i‡(
rs
->
¥öt_Êags
 & 
DMPF_DAEMON_SLEEP
)

1427 
	`DMEMIT
(" daemon_sleep %lu",

1428 
rs
->
md
.
bôm≠_öfo
.
d´m⁄_¶ìp
);

1430 i‡(
rs
->
¥öt_Êags
 & 
DMPF_MIN_RECOVERY_RATE
)

1431 
	`DMEMIT
(" mö_ªcovîy_øã %d", 
rs
->
md
.
sync_•ìd_mö
);

1433 i‡(
rs
->
¥öt_Êags
 & 
DMPF_MAX_RECOVERY_RATE
)

1434 
	`DMEMIT
(" max_ªcovîy_øã %d", 
rs
->
md
.
sync_•ìd_max
);

1436 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++)

1437 i‡(
rs
->
dev
[
i
].
d©a_dev
 &&

1438 
	`ã°_bô
(
WrôeMo°ly
, &
rs
->
dev
[
i
].
rdev
.
Êags
))

1439 
	`DMEMIT
(" wrôe_mo°ly %u", 
i
);

1441 i‡(
rs
->
¥öt_Êags
 & 
DMPF_MAX_WRITE_BEHIND
)

1442 
	`DMEMIT
(" max_write_behind %lu",

1443 
rs
->
md
.
bôm≠_öfo
.
max_wrôe_behöd
);

1445 i‡(
rs
->
¥öt_Êags
 & 
DMPF_STRIPE_CACHE
) {

1446 
r5c⁄f
 *
c⁄f
 = 
rs
->
md
.
¥iv©e
;

1449 
	`DMEMIT
(" stripe_cache %d",

1450 
c⁄f
 ? c⁄f->
max_ƒ_°rùes
 * 2 : 0);

1453 i‡(
rs
->
¥öt_Êags
 & 
DMPF_REGION_SIZE
)

1454 
	`DMEMIT
("Ñegion_size %lu",

1455 
rs
->
md
.
bôm≠_öfo
.
chunksize
 >> 9);

1457 i‡(
rs
->
¥öt_Êags
 & 
DMPF_RAID10_COPIES
)

1458 
	`DMEMIT
("Ñaid10_copies %u",

1459 
	`øid10_md_œyout_to_c›õs
(
rs
->
md
.
œyout
));

1461 i‡(
rs
->
¥öt_Êags
 & 
DMPF_RAID10_FORMAT
)

1462 
	`DMEMIT
("Ñaid10_format %s",

1463 
	`øid10_md_œyout_to_f‹m©
(
rs
->
md
.
œyout
));

1465 
	`DMEMIT
(" %d", 
rs
->
md
.
øid_disks
);

1466 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

1467 i‡(
rs
->
dev
[
i
].
mëa_dev
)

1468 
	`DMEMIT
(" %s", 
rs
->
dev
[
i
].
mëa_dev
->
«me
);

1470 
	`DMEMIT
(" -");

1472 i‡(
rs
->
dev
[
i
].
d©a_dev
)

1473 
	`DMEMIT
(" %s", 
rs
->
dev
[
i
].
d©a_dev
->
«me
);

1475 
	`DMEMIT
(" -");

1478 
	}
}

1480 
	$øid_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1482 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1483 
mddev
 *mddev = &
rs
->
md
;

1485 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "reshape")) {

1486 
	`DMERR
("ReshapeÇot supported.");

1487  -
EINVAL
;

1490 i‡(!
mddev
->
≥rs
 || !mddev->≥rs->
sync_ªque°
)

1491  -
EINVAL
;

1493 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "frozen"))

1494 
	`£t_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

1496 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

1498 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "idle") || !strcasecmp(argv[0], "frozen")) {

1499 i‡(
mddev
->
sync_thªad
) {

1500 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

1501 
	`md_ª≠_sync_thªad
(
mddev
);

1503 } i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
) ||

1504 
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
))

1505  -
EBUSY
;

1506 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "resync"))

1507 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

1508 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "recover")) {

1509 
	`£t_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

1510 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

1512 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "check"))

1513 
	`£t_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

1514 i‡(!!
	`°rˇ£cmp
(
¨gv
[0], "repair"))

1515  -
EINVAL
;

1516 
	`£t_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
);

1517 
	`£t_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

1519 i‡(
mddev
->
ro
 == 2) {

1523 
mddev
->
ro
 = 0;

1524 i‡(!
mddev
->
su•íded
)

1525 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

1527 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

1528 i‡(!
mddev
->
su•íded
)

1529 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1532 
	}
}

1534 
	$øid_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1535 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1537 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1538 
i
;

1539 
ªt
 = 0;

1541 
i
 = 0; !
ªt
 && i < 
rs
->
md
.
øid_disks
; i++)

1542 i‡(
rs
->
dev
[
i
].
d©a_dev
)

1543 
ªt
 = 
	`‚
(
ti
,

1544 
rs
->
dev
[
i
].
d©a_dev
,

1546 
rs
->
md
.
dev_£˘‹s
,

1547 
d©a
);

1549  
ªt
;

1550 
	}
}

1552 
	$øid_io_höts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

1554 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1555 
chunk_size
 = 
rs
->
md
.
chunk_£˘‹s
 << 9;

1556 
r5c⁄f
 *
c⁄f
 = 
rs
->
md
.
¥iv©e
;

1558 
	`blk_limôs_io_mö
(
limôs
, 
chunk_size
);

1559 
	`blk_limôs_io_›t
(
limôs
, 
chunk_size
 * (
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
));

1560 
	}
}

1562 
	$øid_¥esu•íd
(
dm_èrgë
 *
ti
)

1564 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1566 
	`md_°›_wrôes
(&
rs
->
md
);

1567 
	}
}

1569 
	$øid_po°su•íd
(
dm_èrgë
 *
ti
)

1571 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1573 
	`mddev_su•íd
(&
rs
->
md
);

1574 
	}
}

1576 
	$©ãm±_ª°‹e_of_Áu…y_devi˚s
(
øid_£t
 *
rs
)

1578 
i
;

1579 
uöt64_t
 
Áûed_devi˚s
, 
˛óªd_Áûed_devi˚s
 = 0;

1580 
Êags
;

1581 
dm_øid_su≥rblock
 *
sb
;

1582 
md_rdev
 *
r
;

1584 
i
 = 0; i < 
rs
->
md
.
øid_disks
; i++) {

1585 
r
 = &
rs
->
dev
[
i
].
rdev
;

1586 i‡(
	`ã°_bô
(
Fau…y
, &
r
->
Êags
Ë&&Ñ->
sb_∑ge
 &&

1587 
	`sync_∑ge_io
(
r
, 0,Ñ->
sb_size
,Ñ->
sb_∑ge
, 
READ
, 1)) {

1588 
	`DMINFO
("Faulty %s device #%d hasÑeadable super block."

1590 
rs
->
øid_ty≥
->
«me
, 
i
);

1601 i‡((
r
->
øid_disk
 >= 0) &&

1602 (
r
->
mddev
->
≥rs
->
	`hŸ_ªmove_disk
(r->mddev,Ñ) != 0))

1606 
r
->
øid_disk
 = 
i
;

1607 
r
->
ßved_øid_disk
 = 
i
;

1608 
Êags
 = 
r
->flags;

1609 
	`˛ór_bô
(
Fau…y
, &
r
->
Êags
);

1610 
	`˛ór_bô
(
WrôeEº‹Sìn
, &
r
->
Êags
);

1611 
	`˛ór_bô
(
In_sync
, &
r
->
Êags
);

1612 i‡(
r
->
mddev
->
≥rs
->
	`hŸ_add_disk
(r->mddev,Ñ)) {

1613 
r
->
øid_disk
 = -1;

1614 
r
->
ßved_øid_disk
 = -1;

1615 
r
->
Êags
 = flags;

1617 
r
->
ªcovîy_off£t
 = 0;

1618 
˛óªd_Áûed_devi˚s
 |1 << 
i
;

1622 i‡(
˛óªd_Áûed_devi˚s
) {

1623 
	`rdev_f‹_óch
(
r
, &
rs
->
md
) {

1624 
sb
 = 
	`∑ge_addªss
(
r
->
sb_∑ge
);

1625 
Áûed_devi˚s
 = 
	`À64_to_˝u
(
sb
->failed_devices);

1626 
Áûed_devi˚s
 &~
˛óªd_Áûed_devi˚s
;

1627 
sb
->
Áûed_devi˚s
 = 
	`˝u_to_À64
(failed_devices);

1630 
	}
}

1632 
	$øid_ªsume
(
dm_èrgë
 *
ti
)

1634 
øid_£t
 *
rs
 = 
ti
->
¥iv©e
;

1636 
	`£t_bô
(
MD_CHANGE_DEVS
, &
rs
->
md
.
Êags
);

1637 i‡(!
rs
->
bôm≠_lﬂded
) {

1638 
	`bôm≠_lﬂd
(&
rs
->
md
);

1639 
rs
->
bôm≠_lﬂded
 = 1;

1646 
	`©ãm±_ª°‹e_of_Áu…y_devi˚s
(
rs
);

1649 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
rs
->
md
.
ªcovîy
);

1650 
	`mddev_ªsume
(&
rs
->
md
);

1651 
	}
}

1653 
èrgë_ty≥
 
	gøid_èrgë
 = {

1654 .
«me
 = "raid",

1655 .
	gvîsi⁄
 = {1, 5, 2},

1656 .
	gmoduÀ
 = 
THIS_MODULE
,

1657 .
	g˘r
 = 
øid_˘r
,

1658 .
	gdå
 = 
øid_då
,

1659 .
	gm≠
 = 
øid_m≠
,

1660 .
	g°©us
 = 
øid_°©us
,

1661 .
	gmesßge
 = 
øid_mesßge
,

1662 .
	gôî©e_devi˚s
 = 
øid_ôî©e_devi˚s
,

1663 .
	gio_höts
 = 
øid_io_höts
,

1664 .
	g¥esu•íd
 = 
øid_¥esu•íd
,

1665 .
	gpo°su•íd
 = 
øid_po°su•íd
,

1666 .
	gªsume
 = 
øid_ªsume
,

1669 
__öô
 
	$dm_øid_öô
()

1671 
	`DMINFO
("LoadingÅarget version %u.%u.%u",

1672 
øid_èrgë
.
vîsi⁄
[0],

1673 
øid_èrgë
.
vîsi⁄
[1],

1674 
øid_èrgë
.
vîsi⁄
[2]);

1675  
	`dm_ªgi°î_èrgë
(&
øid_èrgë
);

1676 
	}
}

1678 
__exô
 
	$dm_øid_exô
()

1680 
	`dm_uƒegi°î_èrgë
(&
øid_èrgë
);

1681 
	}
}

1683 
moduÀ_öô
(
dm_øid_öô
);

1684 
moduÀ_exô
(
dm_øid_exô
);

1686 
MODULE_DESCRIPTION
(
DM_NAME
 "Ñaid4/5/6Åarget");

1687 
MODULE_ALIAS
("dm-raid1");

1688 
MODULE_ALIAS
("dm-raid10");

1689 
MODULE_ALIAS
("dm-raid4");

1690 
MODULE_ALIAS
("dm-raid5");

1691 
MODULE_ALIAS
("dm-raid6");

1692 
MODULE_AUTHOR
("Neil Brown <dm-devel@redhat.com>");

1693 
MODULE_LICENSE
("GPL");

	@dm-raid.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

25 { 0xb1425b32, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_add_èrgë_ˇŒbacks
) },

26 { 0x88c6f˚5, 
__VMLINUX_SYMBOL_STR
(
put_∑ge
) },

27 { 0x2f6da7a9, 
__VMLINUX_SYMBOL_STR
(
md_îr‹
) },

28 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

29 { 0x215df4df, 
__VMLINUX_SYMBOL_STR
(
md_run
) },

30 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

31 { 0x543b4234, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

32 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

33 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

34 { 0x9d5a630d, 
__VMLINUX_SYMBOL_STR
(
øid5_£t_ˇche_size
) },

35 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

36 { 0xc592˚29, 
__VMLINUX_SYMBOL_STR
(
md_rdev_öô
) },

37 { 0x2231e233, 
__VMLINUX_SYMBOL_STR
(
mddev_öô
) },

38 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

39 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

40 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

41 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

42 { 0xbˇ91938, 
__VMLINUX_SYMBOL_STR
(
md_øid1_c⁄ge°ed
) },

43 { 0x9270bcc1, 
__VMLINUX_SYMBOL_STR
(
md_øid10_c⁄ge°ed
) },

44 { 0xf1dbcdb6, 
__VMLINUX_SYMBOL_STR
(
md_øid5_c⁄ge°ed
) },

45 { 0x5835d429, 
__VMLINUX_SYMBOL_STR
(
md_°›
) },

46 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

47 { 0xa6c844e3, 
__VMLINUX_SYMBOL_STR
(
md_rdev_˛ór
) },

48 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

49 { 0x2e739058, 
__VMLINUX_SYMBOL_STR
(
md_°›_wrôes
) },

50 { 0x6755˚92, 
__VMLINUX_SYMBOL_STR
(
mddev_su•íd
) },

51 { 0x48e7b678, 
__VMLINUX_SYMBOL_STR
(
bôm≠_lﬂd
) },

52 { 0xc01bc255, 
__VMLINUX_SYMBOL_STR
(
mddev_ªsume
) },

53 { 0x5ab10213, 
__VMLINUX_SYMBOL_STR
(
sync_∑ge_io
) },

54 { 0x74c134b9, 
__VMLINUX_SYMBOL_STR
(
__sw_hweight32
) },

55 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

56 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

57 { 0xc90c172a, 
__VMLINUX_SYMBOL_STR
(
md_wakeup_thªad
) },

58 { 0x37f37c30, 
__VMLINUX_SYMBOL_STR
(
md_ª≠_sync_thªad
) },

59 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

60 { 0xd75f42b2, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_›t
) },

61 { 0x118a5e56, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_mö
) },

62 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

65 c⁄° 
	g__moduÀ_dïíds
[]

66 
__u£d


67 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

71 
MODULE_INFO
(
§cvîsi⁄
, "EA406DFFD26E9760799BC53");

	@dm-raid1.c

8 
	~"dm-bio-ªc‹d.h
"

10 
	~<löux/öô.h
>

11 
	~<löux/mempoﬁ.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/w‹kqueue.h
>

16 
	~<löux/devi˚-m≠≥r.h
>

17 
	~<löux/dm-io.h
>

18 
	~<löux/dm-dúty-log.h
>

19 
	~<löux/dm-kc›yd.h
>

20 
	~<löux/dm-ªgi⁄-hash.h
>

22 
	#DM_MSG_PREFIX
 "øid1"

	)

24 
	#MAX_RECOVERY
 1

	)

26 
	#DM_RAID1_HANDLE_ERRORS
 0x01

	)

27 
	#îr‹s_h™dÀd
(
p
Ë(’)->
„©uªs
 & 
DM_RAID1_HANDLE_ERRORS
)

	)

29 
DECLARE_WAIT_QUEUE_HEAD
(
_kmúr‹d_ªcovîy_°›≥d
);

34 
	edm_øid1_îr‹
 {

35 
	mDM_RAID1_WRITE_ERROR
,

36 
	mDM_RAID1_FLUSH_ERROR
,

37 
	mDM_RAID1_SYNC_ERROR
,

38 
	mDM_RAID1_READ_ERROR


41 
	smúr‹
 {

42 
múr‹_£t
 *
	mms
;

43 
©omic_t
 
	mîr‹_cou¡
;

44 
	mîr‹_ty≥
;

45 
dm_dev
 *
	mdev
;

46 
£˘‹_t
 
	moff£t
;

49 
	smúr‹_£t
 {

50 
dm_èrgë
 *
	mti
;

51 
li°_hód
 
	mli°
;

53 
uöt64_t
 
	m„©uªs
;

55 
•ölock_t
 
	mlock
;

56 
bio_li°
 
	mªads
;

57 
bio_li°
 
	mwrôes
;

58 
bio_li°
 
	mÁûuªs
;

59 
bio_li°
 
	mhﬁds
;

61 
dm_ªgi⁄_hash
 *
	mrh
;

62 
dm_kc›yd_˛õ¡
 *
	mkc›yd_˛õ¡
;

63 
dm_io_˛õ¡
 *
	mio_˛õ¡
;

66 
ªgi⁄_t
 
	mƒ_ªgi⁄s
;

67 
	mö_sync
;

68 
	mlog_Áûuª
;

69 
	mÀg_Áûuª
;

70 
©omic_t
 
	msu•íd
;

72 
©omic_t
 
	mdeÁu…_múr‹
;

74 
w‹kqueue_°ru˘
 *
	mkmúr‹d_wq
;

75 
w‹k_°ru˘
 
	mkmúr‹d_w‹k
;

76 
timî_li°
 
	mtimî
;

77 
	mtimî_≥ndög
;

79 
w‹k_°ru˘
 
	måiggî_evít
;

81 
	mƒ_múr‹s
;

82 
múr‹
 
	mmúr‹
[0];

85 
DECLARE_DM_KCOPYD_THROTTLE_WITH_MODULE_PARM
(
øid1_ªsync_thrŸée
,

88 
	$wakeup_múr‹d
(*
c⁄ãxt
)

90 
múr‹_£t
 *
ms
 = 
c⁄ãxt
;

92 
	`queue_w‹k
(
ms
->
kmúr‹d_wq
, &ms->
kmúr‹d_w‹k
);

93 
	}
}

95 
	$dñayed_wake_‚
(
d©a
)

97 
múr‹_£t
 *
ms
 = (múr‹_£à*Ë
d©a
;

99 
	`˛ór_bô
(0, &
ms
->
timî_≥ndög
);

100 
	`wakeup_múr‹d
(
ms
);

101 
	}
}

103 
	$dñayed_wake
(
múr‹_£t
 *
ms
)

105 i‡(
	`ã°_™d_£t_bô
(0, &
ms
->
timî_≥ndög
))

108 
ms
->
timî
.
expúes
 = 
jiffõs
 + 
HZ
 / 5;

109 
ms
->
timî
.
d©a
 = () ms;

110 
ms
->
timî
.
fun˘i⁄
 = 
dñayed_wake_‚
;

111 
	`add_timî
(&
ms
->
timî
);

112 
	}
}

114 
	$wakeup_Æl_ªcovîy_waôîs
(*
c⁄ãxt
)

116 
	`wake_up_Æl
(&
_kmúr‹d_ªcovîy_°›≥d
);

117 
	}
}

119 
	$queue_bio
(
múr‹_£t
 *
ms
, 
bio
 *bio, 
rw
)

121 
Êags
;

122 
should_wake
 = 0;

123 
bio_li°
 *
bl
;

125 
bl
 = (
rw
 =
WRITE
Ë? &
ms
->
wrôes
 : &ms->
ªads
;

126 
	`•ö_lock_úqßve
(&
ms
->
lock
, 
Êags
);

127 
should_wake
 = !(
bl
->
hód
);

128 
	`bio_li°_add
(
bl
, 
bio
);

129 
	`•ö_u∆ock_úqª°‹e
(&
ms
->
lock
, 
Êags
);

131 i‡(
should_wake
)

132 
	`wakeup_múr‹d
(
ms
);

133 
	}
}

135 
	$di•©ch_bios
(*
c⁄ãxt
, 
bio_li°
 *bio_list)

137 
múr‹_£t
 *
ms
 = 
c⁄ãxt
;

138 
bio
 *bio;

140 (
bio
 = 
	`bio_li°_p›
(
bio_li°
)))

141 
	`queue_bio
(
ms
, 
bio
, 
WRITE
);

142 
	}
}

144 
	sdm_øid1_bio_ªc‹d
 {

145 
múr‹
 *
	mm
;

147 
dm_bio_dëaûs
 
	mdëaûs
;

148 
ªgi⁄_t
 
	mwrôe_ªgi⁄
;

154 
	#DEFAULT_MIRROR
 0

	)

161 
múr‹
 *
	$bio_gë_m
(
bio
 *bio)

163  (
múr‹
 *Ë
bio
->
bi_√xt
;

164 
	}
}

166 
	$bio_£t_m
(
bio
 *bio, 
múr‹
 *
m
)

168 
bio
->
bi_√xt
 = (biÿ*Ë
m
;

169 
	}
}

171 
múr‹
 *
	$gë_deÁu…_múr‹
(
múr‹_£t
 *
ms
)

173  &
ms
->
múr‹
[
	`©omic_ªad
(&ms->
deÁu…_múr‹
)];

174 
	}
}

176 
	$£t_deÁu…_múr‹
(
múr‹
 *
m
)

178 
múr‹_£t
 *
ms
 = 
m
->ms;

179 
múr‹
 *
m0
 = &(
ms
->mirror[0]);

181 
	`©omic_£t
(&
ms
->
deÁu…_múr‹
, 
m
 - 
m0
);

182 
	}
}

184 
múr‹
 *
	$gë_vÆid_múr‹
(
múr‹_£t
 *
ms
)

186 
múr‹
 *
m
;

188 
m
 = 
ms
->
múr‹
; m < ms->múr‹ + ms->
ƒ_múr‹s
; m++)

189 i‡(!
	`©omic_ªad
(&
m
->
îr‹_cou¡
))

190  
m
;

192  
NULL
;

193 
	}
}

209 
	$Áû_múr‹
(
múr‹
 *
m
, 
dm_øid1_îr‹
 
îr‹_ty≥
)

211 
múr‹_£t
 *
ms
 = 
m
->ms;

212 
múr‹
 *
√w
;

214 
ms
->
Àg_Áûuª
 = 1;

221 
	`©omic_öc
(&
m
->
îr‹_cou¡
);

223 i‡(
	`ã°_™d_£t_bô
(
îr‹_ty≥
, &
m
->error_type))

226 i‡(!
	`îr‹s_h™dÀd
(
ms
))

229 i‡(
m
 !
	`gë_deÁu…_múr‹
(
ms
))

230 
out
;

232 i‡(!
ms
->
ö_sync
) {

237 
	`DMERR
("Primary mirror (%s) failed while out-of-sync: "

238 "Ród†may faû.", 
m
->
dev
->
«me
);

239 
out
;

242 
√w
 = 
	`gë_vÆid_múr‹
(
ms
);

243 i‡(
√w
)

244 
	`£t_deÁu…_múr‹
(
√w
);

246 
	`DMWARN
("All sides of mirror have failed.");

248 
out
:

249 
	`scheduÀ_w‹k
(&
ms
->
åiggî_evít
);

250 
	}
}

252 
	$múr‹_Êush
(
dm_èrgë
 *
ti
)

254 
múr‹_£t
 *
ms
 = 
ti
->
¥iv©e
;

255 
îr‹_bôs
;

257 
i
;

258 
dm_io_ªgi⁄
 
io
[
ms
->
ƒ_múr‹s
];

259 
múr‹
 *
m
;

260 
dm_io_ªque°
 
io_ªq
 = {

261 .
bi_rw
 = 
WRITE_FLUSH
,

262 .
mem
.
ty≥
 = 
DM_IO_KMEM
,

263 .
mem
.
±r
.
addr
 = 
NULL
,

264 .
˛õ¡
 = 
ms
->
io_˛õ¡
,

267 
i
 = 0, 
m
 = 
ms
->
múr‹
; i < ms->
ƒ_múr‹s
; i++, m++) {

268 
io
[
i
].
bdev
 = 
m
->
dev
->bdev;

269 
io
[
i
].
£˘‹
 = 0;

270 
io
[
i
].
cou¡
 = 0;

273 
îr‹_bôs
 = -1;

274 
	`dm_io
(&
io_ªq
, 
ms
->
ƒ_múr‹s
, 
io
, &
îr‹_bôs
);

275 i‡(
	`u∆ikñy
(
îr‹_bôs
 != 0)) {

276 
i
 = 0; i < 
ms
->
ƒ_múr‹s
; i++)

277 i‡(
	`ã°_bô
(
i
, &
îr‹_bôs
))

278 
	`Áû_múr‹
(
ms
->
múr‹
 + 
i
,

279 
DM_RAID1_FLUSH_ERROR
);

280  -
EIO
;

284 
	}
}

293 
	$ªcovîy_com∂ëe
(
ªad_îr
, 
wrôe_îr
,

294 *
c⁄ãxt
)

296 
dm_ªgi⁄
 *
ªg
 = 
c⁄ãxt
;

297 
múr‹_£t
 *
ms
 = 
	`dm_rh_ªgi⁄_c⁄ãxt
(
ªg
);

298 
m
, 
bô
 = 0;

300 i‡(
ªad_îr
) {

302 
	`DMERR_LIMIT
("UnableÅoÑeadÖrimary mirror duringÑecovery");

303 
	`Áû_múr‹
(
	`gë_deÁu…_múr‹
(
ms
), 
DM_RAID1_SYNC_ERROR
);

306 i‡(
wrôe_îr
) {

307 
	`DMERR_LIMIT
("WriteÉrror duringÑecovery (error = 0x%lx)",

308 
wrôe_îr
);

313 
m
 = 0; m < 
ms
->
ƒ_múr‹s
; m++) {

314 i‡(&
ms
->
múr‹
[
m
] =
	`gë_deÁu…_múr‹
(ms))

316 i‡(
	`ã°_bô
(
bô
, &
wrôe_îr
))

317 
	`Áû_múr‹
(
ms
->
múr‹
 + 
m
,

318 
DM_RAID1_SYNC_ERROR
);

319 
bô
++;

323 
	`dm_rh_ªcovîy_íd
(
ªg
, !(
ªad_îr
 || 
wrôe_îr
));

324 
	}
}

326 
	$ªcovî
(
múr‹_£t
 *
ms
, 
dm_ªgi⁄
 *
ªg
)

328 
r
;

329 
i
;

330 
dm_io_ªgi⁄
 
‰om
, 
to
[
DM_KCOPYD_MAX_REGIONS
], *
de°
;

331 
múr‹
 *
m
;

332 
Êags
 = 0;

333 
ªgi⁄_t
 
key
 = 
	`dm_rh_gë_ªgi⁄_key
(
ªg
);

334 
£˘‹_t
 
ªgi⁄_size
 = 
	`dm_rh_gë_ªgi⁄_size
(
ms
->
rh
);

337 
m
 = 
	`gë_deÁu…_múr‹
(
ms
);

338 
‰om
.
bdev
 = 
m
->
dev
->bdev;

339 
‰om
.
£˘‹
 = 
m
->
off£t
 + 
	`dm_rh_ªgi⁄_to_£˘‹
(
ms
->
rh
, 
key
);

340 i‡(
key
 =(
ms
->
ƒ_ªgi⁄s
 - 1)) {

345 
‰om
.
cou¡
 = 
ms
->
ti
->
Àn
 & (
ªgi⁄_size
 - 1);

346 i‡(!
‰om
.
cou¡
)

347 
‰om
.
cou¡
 = 
ªgi⁄_size
;

349 
‰om
.
cou¡
 = 
ªgi⁄_size
;

352 
i
 = 0, 
de°
 = 
to
; i < 
ms
->
ƒ_múr‹s
; i++) {

353 i‡(&
ms
->
múr‹
[
i
] =
	`gë_deÁu…_múr‹
(ms))

356 
m
 = 
ms
->
múr‹
 + 
i
;

357 
de°
->
bdev
 = 
m
->
dev
->bdev;

358 
de°
->
£˘‹
 = 
m
->
off£t
 + 
	`dm_rh_ªgi⁄_to_£˘‹
(
ms
->
rh
, 
key
);

359 
de°
->
cou¡
 = 
‰om
.count;

360 
de°
++;

364 i‡(!
	`îr‹s_h™dÀd
(
ms
))

365 
	`£t_bô
(
DM_KCOPYD_IGNORE_ERROR
, &
Êags
);

367 
r
 = 
	`dm_kc›yd_c›y
(
ms
->
kc›yd_˛õ¡
, &
‰om
, ms->
ƒ_múr‹s
 - 1, 
to
,

368 
Êags
, 
ªcovîy_com∂ëe
, 
ªg
);

370  
r
;

371 
	}
}

373 
	$do_ªcovîy
(
múr‹_£t
 *
ms
)

375 
dm_ªgi⁄
 *
ªg
;

376 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

377 
r
;

382 
	`dm_rh_ªcovîy_¥ï¨e
(
ms
->
rh
);

387 (
ªg
 = 
	`dm_rh_ªcovîy_°¨t
(
ms
->
rh
))) {

388 
r
 = 
	`ªcovî
(
ms
, 
ªg
);

389 i‡(
r
)

390 
	`dm_rh_ªcovîy_íd
(
ªg
, 0);

396 i‡(!
ms
->
ö_sync
 &&

397 (
log
->
ty≥
->
	`gë_sync_cou¡
÷ogË=
ms
->
ƒ_ªgi⁄s
)) {

399 
	`dm_èbÀ_evít
(
ms
->
ti
->
èbÀ
);

400 
ms
->
ö_sync
 = 1;

402 
	}
}

407 
múr‹
 *
	$choo£_múr‹
(
múr‹_£t
 *
ms
, 
£˘‹_t
 
£˘‹
)

409 
múr‹
 *
m
 = 
	`gë_deÁu…_múr‹
(
ms
);

412 i‡(
	`likñy
(!
	`©omic_ªad
(&
m
->
îr‹_cou¡
)))

413  
m
;

415 i‡(
m
-- =
ms
->
múr‹
)

416 
m
 +
ms
->
ƒ_múr‹s
;

417 } 
m
 !
	`gë_deÁu…_múr‹
(
ms
));

419  
NULL
;

420 
	}
}

422 
	$deÁu…_ok
(
múr‹
 *
m
)

424 
múr‹
 *
deÁu…_múr‹
 = 
	`gë_deÁu…_múr‹
(
m
->
ms
);

426  !
	`©omic_ªad
(&
deÁu…_múr‹
->
îr‹_cou¡
);

427 
	}
}

429 
	$múr‹_avaûabÀ
(
múr‹_£t
 *
ms
, 
bio
 *bio)

431 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

432 
ªgi⁄_t
 
ªgi⁄
 = 
	`dm_rh_bio_to_ªgi⁄
(
ms
->
rh
, 
bio
);

434 i‡(
log
->
ty≥
->
	`ö_sync
÷og, 
ªgi⁄
, 0))

435  
	`choo£_múr‹
(
ms
, 
bio
->
bi_ôî
.
bi_£˘‹
) ? 1 : 0;

438 
	}
}

443 
£˘‹_t
 
	$m≠_£˘‹
(
múr‹
 *
m
, 
bio
 *bio)

445 i‡(
	`u∆ikñy
(!
bio
->
bi_ôî
.
bi_size
))

447  
m
->
off£t
 + 
	`dm_èrgë_off£t
(m->
ms
->
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

448 
	}
}

450 
	$m≠_bio
(
múr‹
 *
m
, 
bio
 *bio)

452 
bio
->
bi_bdev
 = 
m
->
dev
->
bdev
;

453 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`m≠_£˘‹
(
m
, bio);

454 
	}
}

456 
	$m≠_ªgi⁄
(
dm_io_ªgi⁄
 *
io
, 
múr‹
 *
m
,

457 
bio
 *bio)

459 
io
->
bdev
 = 
m
->
dev
->bdev;

460 
io
->
£˘‹
 = 
	`m≠_£˘‹
(
m
, 
bio
);

461 
io
->
cou¡
 = 
	`bio_£˘‹s
(
bio
);

462 
	}
}

464 
	$hﬁd_bio
(
múr‹_£t
 *
ms
, 
bio
 *bio)

470 
	`•ö_lock_úq
(&
ms
->
lock
);

472 i‡(
	`©omic_ªad
(&
ms
->
su•íd
)) {

473 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

478 i‡(
	`dm_noÊush_su•ídög
(
ms
->
ti
))

479 
	`bio_ídio
(
bio
, 
DM_ENDIO_REQUEUE
);

481 
	`bio_ídio
(
bio
, -
EIO
);

488 
	`bio_li°_add
(&
ms
->
hﬁds
, 
bio
);

489 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

490 
	}
}

495 
	$ªad_ˇŒback
(
îr‹
, *
c⁄ãxt
)

497 
bio
 *biÿ
c⁄ãxt
;

498 
múr‹
 *
m
;

500 
m
 = 
	`bio_gë_m
(
bio
);

501 
	`bio_£t_m
(
bio
, 
NULL
);

503 i‡(
	`likñy
(!
îr‹
)) {

504 
	`bio_ídio
(
bio
, 0);

508 
	`Áû_múr‹
(
m
, 
DM_RAID1_READ_ERROR
);

510 i‡(
	`likñy
(
	`deÁu…_ok
(
m
)Ë|| 
	`múr‹_avaûabÀ
(m->
ms
, 
bio
)) {

511 
	`DMWARN_LIMIT
("Read failure on mirror device %s. "

513 
m
->
dev
->
«me
);

514 
	`queue_bio
(
m
->
ms
, 
bio
, 
	`bio_rw
(bio));

518 
	`DMERR_LIMIT
("Read failure on mirror device %s. Failing I/O.",

519 
m
->
dev
->
«me
);

520 
	`bio_ídio
(
bio
, -
EIO
);

521 
	}
}

524 
	$ªad_async_bio
(
múr‹
 *
m
, 
bio
 *bio)

526 
dm_io_ªgi⁄
 
io
;

527 
dm_io_ªque°
 
io_ªq
 = {

528 .
bi_rw
 = 
READ
,

529 .
mem
.
ty≥
 = 
DM_IO_BIO
,

530 .
mem
.
±r
.
bio
 = bio,

531 .
nŸify
.
‚
 = 
ªad_ˇŒback
,

532 .
nŸify
.
c⁄ãxt
 = 
bio
,

533 .
˛õ¡
 = 
m
->
ms
->
io_˛õ¡
,

536 
	`m≠_ªgi⁄
(&
io
, 
m
, 
bio
);

537 
	`bio_£t_m
(
bio
, 
m
);

538 
	`BUG_ON
(
	`dm_io
(&
io_ªq
, 1, &
io
, 
NULL
));

539 
	}
}

541 
ölöe
 
	$ªgi⁄_ö_sync
(
múr‹_£t
 *
ms
, 
ªgi⁄_t
 
ªgi⁄
,

542 
may_block
)

544 
°©e
 = 
	`dm_rh_gë_°©e
(
ms
->
rh
, 
ªgi⁄
, 
may_block
);

545  
°©e
 =
DM_RH_CLEAN
 || sèã =
DM_RH_DIRTY
;

546 
	}
}

548 
	$do_ªads
(
múr‹_£t
 *
ms
, 
bio_li°
 *
ªads
)

550 
ªgi⁄_t
 
ªgi⁄
;

551 
bio
 *bio;

552 
múr‹
 *
m
;

554 (
bio
 = 
	`bio_li°_p›
(
ªads
))) {

555 
ªgi⁄
 = 
	`dm_rh_bio_to_ªgi⁄
(
ms
->
rh
, 
bio
);

556 
m
 = 
	`gë_deÁu…_múr‹
(
ms
);

561 i‡(
	`likñy
(
	`ªgi⁄_ö_sync
(
ms
, 
ªgi⁄
, 1)))

562 
m
 = 
	`choo£_múr‹
(
ms
, 
bio
->
bi_ôî
.
bi_£˘‹
);

563 i‡(
m
 && 
	`©omic_ªad
(&m->
îr‹_cou¡
))

564 
m
 = 
NULL
;

566 i‡(
	`likñy
(
m
))

567 
	`ªad_async_bio
(
m
, 
bio
);

569 
	`bio_ídio
(
bio
, -
EIO
);

571 
	}
}

585 
	$wrôe_ˇŒback
(
îr‹
, *
c⁄ãxt
)

587 
i
, 
ªt
 = 0;

588 
bio
 *biÿ(biÿ*Ë
c⁄ãxt
;

589 
múr‹_£t
 *
ms
;

590 
should_wake
 = 0;

591 
Êags
;

593 
ms
 = 
	`bio_gë_m
(
bio
)->ms;

594 
	`bio_£t_m
(
bio
, 
NULL
);

602 i‡(
	`likñy
(!
îr‹
)) {

603 
	`bio_ídio
(
bio
, 
ªt
);

607 
i
 = 0; i < 
ms
->
ƒ_múr‹s
; i++)

608 i‡(
	`ã°_bô
(
i
, &
îr‹
))

609 
	`Áû_múr‹
(
ms
->
múr‹
 + 
i
, 
DM_RAID1_WRITE_ERROR
);

616 
	`•ö_lock_úqßve
(&
ms
->
lock
, 
Êags
);

617 i‡(!
ms
->
Áûuªs
.
hód
)

618 
should_wake
 = 1;

619 
	`bio_li°_add
(&
ms
->
Áûuªs
, 
bio
);

620 
	`•ö_u∆ock_úqª°‹e
(&
ms
->
lock
, 
Êags
);

621 i‡(
should_wake
)

622 
	`wakeup_múr‹d
(
ms
);

623 
	}
}

625 
	$do_wrôe
(
múr‹_£t
 *
ms
, 
bio
 *bio)

627 
i
;

628 
dm_io_ªgi⁄
 
io
[
ms
->
ƒ_múr‹s
], *
de°
 = io;

629 
múr‹
 *
m
;

630 
dm_io_ªque°
 
io_ªq
 = {

631 .
bi_rw
 = 
WRITE
 | (
bio
->bi_rw & 
WRITE_FLUSH_FUA
),

632 .
mem
.
ty≥
 = 
DM_IO_BIO
,

633 .
mem
.
±r
.
bio
 = bio,

634 .
nŸify
.
‚
 = 
wrôe_ˇŒback
,

635 .
nŸify
.
c⁄ãxt
 = 
bio
,

636 .
˛õ¡
 = 
ms
->
io_˛õ¡
,

639 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
) {

640 
io_ªq
.
bi_rw
 |
REQ_DISCARD
;

641 
io_ªq
.
mem
.
ty≥
 = 
DM_IO_KMEM
;

642 
io_ªq
.
mem
.
±r
.
addr
 = 
NULL
;

645 
i
 = 0, 
m
 = 
ms
->
múr‹
; i < ms->
ƒ_múr‹s
; i++, m++)

646 
	`m≠_ªgi⁄
(
de°
++, 
m
, 
bio
);

652 
	`bio_£t_m
(
bio
, 
	`gë_deÁu…_múr‹
(
ms
));

654 
	`BUG_ON
(
	`dm_io
(&
io_ªq
, 
ms
->
ƒ_múr‹s
, 
io
, 
NULL
));

655 
	}
}

657 
	$do_wrôes
(
múr‹_£t
 *
ms
, 
bio_li°
 *
wrôes
)

659 
°©e
;

660 
bio
 *bio;

661 
bio_li°
 
sync
, 
nosync
, 
ªcovî
, *
this_li°
 = 
NULL
;

662 
bio_li°
 
ªqueue
;

663 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

664 
ªgi⁄_t
 
ªgi⁄
;

666 i‡(!
wrôes
->
hód
)

672 
	`bio_li°_öô
(&
sync
);

673 
	`bio_li°_öô
(&
nosync
);

674 
	`bio_li°_öô
(&
ªcovî
);

675 
	`bio_li°_öô
(&
ªqueue
);

677 (
bio
 = 
	`bio_li°_p›
(
wrôes
))) {

678 i‡((
bio
->
bi_rw
 & 
REQ_FLUSH
) ||

679 (
bio
->
bi_rw
 & 
REQ_DISCARD
)) {

680 
	`bio_li°_add
(&
sync
, 
bio
);

684 
ªgi⁄
 = 
	`dm_rh_bio_to_ªgi⁄
(
ms
->
rh
, 
bio
);

686 i‡(
log
->
ty≥
->
is_ªmŸe_ªcovîög
 &&

687 
log
->
ty≥
->
	`is_ªmŸe_ªcovîög
÷og, 
ªgi⁄
)) {

688 
	`bio_li°_add
(&
ªqueue
, 
bio
);

692 
°©e
 = 
	`dm_rh_gë_°©e
(
ms
->
rh
, 
ªgi⁄
, 1);

693 
°©e
) {

694 
DM_RH_CLEAN
:

695 
DM_RH_DIRTY
:

696 
this_li°
 = &
sync
;

699 
DM_RH_NOSYNC
:

700 
this_li°
 = &
nosync
;

703 
DM_RH_RECOVERING
:

704 
this_li°
 = &
ªcovî
;

708 
	`bio_li°_add
(
this_li°
, 
bio
);

715 i‡(
	`u∆ikñy
(
ªqueue
.
hód
)) {

716 
	`•ö_lock_úq
(&
ms
->
lock
);

717 
	`bio_li°_mîge
(&
ms
->
wrôes
, &
ªqueue
);

718 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

719 
	`dñayed_wake
(
ms
);

727 
	`dm_rh_öc_≥ndög
(
ms
->
rh
, &
sync
);

728 
	`dm_rh_öc_≥ndög
(
ms
->
rh
, &
nosync
);

735 
ms
->
log_Áûuª
 = 
	`dm_rh_Êush
(ms->
rh
) ? 1 : ms->log_failure;

740 i‡(
	`u∆ikñy
(
ms
->
log_Áûuª
Ë&& 
	`îr‹s_h™dÀd
(ms)) {

741 
	`•ö_lock_úq
(&
ms
->
lock
);

742 
	`bio_li°_mîge
(&
ms
->
Áûuªs
, &
sync
);

743 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

744 
	`wakeup_múr‹d
(
ms
);

746 (
bio
 = 
	`bio_li°_p›
(&
sync
)))

747 
	`do_wrôe
(
ms
, 
bio
);

749 (
bio
 = 
	`bio_li°_p›
(&
ªcovî
)))

750 
	`dm_rh_dñay
(
ms
->
rh
, 
bio
);

752 (
bio
 = 
	`bio_li°_p›
(&
nosync
))) {

753 i‡(
	`u∆ikñy
(
ms
->
Àg_Áûuª
Ë&& 
	`îr‹s_h™dÀd
(ms)) {

754 
	`•ö_lock_úq
(&
ms
->
lock
);

755 
	`bio_li°_add
(&
ms
->
Áûuªs
, 
bio
);

756 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

757 
	`wakeup_múr‹d
(
ms
);

759 
	`m≠_bio
(
	`gë_deÁu…_múr‹
(
ms
), 
bio
);

760 
	`gíîic_make_ªque°
(
bio
);

763 
	}
}

765 
	$do_Áûuªs
(
múr‹_£t
 *
ms
, 
bio_li°
 *
Áûuªs
)

767 
bio
 *bio;

769 i‡(
	`likñy
(!
Áûuªs
->
hód
))

789 (
bio
 = 
	`bio_li°_p›
(
Áûuªs
))) {

790 i‡(!
ms
->
log_Áûuª
) {

791 
ms
->
ö_sync
 = 0;

792 
	`dm_rh_m¨k_nosync
(
ms
->
rh
, 
bio
);

803 i‡(!
	`gë_vÆid_múr‹
(
ms
))

804 
	`bio_ídio
(
bio
, -
EIO
);

805 i‡(
	`îr‹s_h™dÀd
(
ms
))

806 
	`hﬁd_bio
(
ms
, 
bio
);

808 
	`bio_ídio
(
bio
, 0);

810 
	}
}

812 
	$åiggî_evít
(
w‹k_°ru˘
 *
w‹k
)

814 
múr‹_£t
 *
ms
 =

815 
	`c⁄èöî_of
(
w‹k
, 
múr‹_£t
, 
åiggî_evít
);

817 
	`dm_èbÀ_evít
(
ms
->
ti
->
èbÀ
);

818 
	}
}

823 
	$do_múr‹
(
w‹k_°ru˘
 *
w‹k
)

825 
múr‹_£t
 *
ms
 = 
	`c⁄èöî_of
(
w‹k
, mirror_set,

826 
kmúr‹d_w‹k
);

827 
bio_li°
 
ªads
, 
wrôes
, 
Áûuªs
;

828 
Êags
;

830 
	`•ö_lock_úqßve
(&
ms
->
lock
, 
Êags
);

831 
ªads
 = 
ms
->reads;

832 
wrôes
 = 
ms
->writes;

833 
Áûuªs
 = 
ms
->failures;

834 
	`bio_li°_öô
(&
ms
->
ªads
);

835 
	`bio_li°_öô
(&
ms
->
wrôes
);

836 
	`bio_li°_öô
(&
ms
->
Áûuªs
);

837 
	`•ö_u∆ock_úqª°‹e
(&
ms
->
lock
, 
Êags
);

839 
	`dm_rh_upd©e_°©es
(
ms
->
rh
, 
	`îr‹s_h™dÀd
(ms));

840 
	`do_ªcovîy
(
ms
);

841 
	`do_ªads
(
ms
, &
ªads
);

842 
	`do_wrôes
(
ms
, &
wrôes
);

843 
	`do_Áûuªs
(
ms
, &
Áûuªs
);

844 
	}
}

849 
múr‹_£t
 *
	$Æloc_c⁄ãxt
(
ƒ_múr‹s
,

850 
uöt32_t
 
ªgi⁄_size
,

851 
dm_èrgë
 *
ti
,

852 
dm_dúty_log
 *
dl
)

854 
size_t
 
Àn
;

855 
múr‹_£t
 *
ms
 = 
NULL
;

857 
Àn
 = (*
ms
Ë+ ((ms->
múr‹
[0]Ë* 
ƒ_múr‹s
);

859 
ms
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

860 i‡(!
ms
) {

861 
ti
->
îr‹
 = "Cannotállocate mirror context";

862  
NULL
;

865 
	`•ö_lock_öô
(&
ms
->
lock
);

866 
	`bio_li°_öô
(&
ms
->
ªads
);

867 
	`bio_li°_öô
(&
ms
->
wrôes
);

868 
	`bio_li°_öô
(&
ms
->
Áûuªs
);

869 
	`bio_li°_öô
(&
ms
->
hﬁds
);

871 
ms
->
ti
 =Åi;

872 
ms
->
ƒ_múr‹s
 =Çr_mirrors;

873 
ms
->
ƒ_ªgi⁄s
 = 
	`dm_£˘‹_div_up
(
ti
->
Àn
, 
ªgi⁄_size
);

874 
ms
->
ö_sync
 = 0;

875 
ms
->
log_Áûuª
 = 0;

876 
ms
->
Àg_Áûuª
 = 0;

877 
	`©omic_£t
(&
ms
->
su•íd
, 0);

878 
	`©omic_£t
(&
ms
->
deÁu…_múr‹
, 
DEFAULT_MIRROR
);

880 
ms
->
io_˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

881 i‡(
	`IS_ERR
(
ms
->
io_˛õ¡
)) {

882 
ti
->
îr‹
 = "Error creating dm_io client";

883 
	`k‰ì
(
ms
);

884  
NULL
;

887 
ms
->
rh
 = 
	`dm_ªgi⁄_hash_¸óã
(ms, 
di•©ch_bios
, 
wakeup_múr‹d
,

888 
wakeup_Æl_ªcovîy_waôîs
,

889 
ms
->
ti
->
begö
, 
MAX_RECOVERY
,

890 
dl
, 
ªgi⁄_size
, 
ms
->
ƒ_ªgi⁄s
);

891 i‡(
	`IS_ERR
(
ms
->
rh
)) {

892 
ti
->
îr‹
 = "Error creating dirtyÑegion hash";

893 
	`dm_io_˛õ¡_de°roy
(
ms
->
io_˛õ¡
);

894 
	`k‰ì
(
ms
);

895  
NULL
;

898  
ms
;

899 
	}
}

901 
	$‰ì_c⁄ãxt
(
múr‹_£t
 *
ms
, 
dm_èrgë
 *
ti
,

902 
m
)

904 
m
--)

905 
	`dm_put_devi˚
(
ti
, 
ms
->
múr‹
[
m
].
dev
);

907 
	`dm_io_˛õ¡_de°roy
(
ms
->
io_˛õ¡
);

908 
	`dm_ªgi⁄_hash_de°roy
(
ms
->
rh
);

909 
	`k‰ì
(
ms
);

910 
	}
}

912 
	$gë_múr‹
(
múr‹_£t
 *
ms
, 
dm_èrgë
 *
ti
,

913 
múr‹
, **
¨gv
)

915 
off£t
;

916 
dummy
;

918 i‡(
	`ssˇnf
(
¨gv
[1], "%Œu%c", &
off£t
, &
dummy
) != 1) {

919 
ti
->
îr‹
 = "Invalid offset";

920  -
EINVAL
;

923 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

924 &
ms
->
múr‹
[múr‹].
dev
)) {

925 
ti
->
îr‹
 = "DeviceÜookup failure";

926  -
ENXIO
;

929 
ms
->
múr‹
[mirror].ms = ms;

930 
	`©omic_£t
(&(
ms
->
múr‹
[múr‹].
îr‹_cou¡
), 0);

931 
ms
->
múr‹
[múr‹].
îr‹_ty≥
 = 0;

932 
ms
->
múr‹
[múr‹].
off£t
 = offset;

935 
	}
}

940 
dm_dúty_log
 *
	$¸óã_dúty_log
(
dm_èrgë
 *
ti
,

941 
¨gc
, **
¨gv
,

942 *
¨gs_u£d
)

944 
∑øm_cou¡
;

945 
dm_dúty_log
 *
dl
;

946 
dummy
;

948 i‡(
¨gc
 < 2) {

949 
ti
->
îr‹
 = "Insufficient mirrorÜogárguments";

950  
NULL
;

953 i‡(
	`ssˇnf
(
¨gv
[1], "%u%c", &
∑øm_cou¡
, &
dummy
) != 1) {

954 
ti
->
îr‹
 = "Invalid mirrorÜogárgument count";

955  
NULL
;

958 *
¨gs_u£d
 = 2 + 
∑øm_cou¡
;

960 i‡(
¨gc
 < *
¨gs_u£d
) {

961 
ti
->
îr‹
 = "Insufficient mirrorÜogárguments";

962  
NULL
;

965 
dl
 = 
	`dm_dúty_log_¸óã
(
¨gv
[0], 
ti
, 
múr‹_Êush
, 
∑øm_cou¡
,

966 
¨gv
 + 2);

967 i‡(!
dl
) {

968 
ti
->
îr‹
 = "Error creating mirror dirtyÜog";

969  
NULL
;

972  
dl
;

973 
	}
}

975 
	$∑r£_„©uªs
(
múr‹_£t
 *
ms
, 
¨gc
, **
¨gv
,

976 *
¨gs_u£d
)

978 
num_„©uªs
;

979 
dm_èrgë
 *
ti
 = 
ms
->ti;

980 
dummy
;

982 *
¨gs_u£d
 = 0;

984 i‡(!
¨gc
)

987 i‡(
	`ssˇnf
(
¨gv
[0], "%u%c", &
num_„©uªs
, &
dummy
) != 1) {

988 
ti
->
îr‹
 = "InvalidÇumber of features";

989  -
EINVAL
;

992 
¨gc
--;

993 
¨gv
++;

994 (*
¨gs_u£d
)++;

996 i‡(
num_„©uªs
 > 
¨gc
) {

997 
ti
->
îr‹
 = "NotÉnoughárgumentsÅo support feature count";

998  -
EINVAL
;

1001 i‡(!
	`°rcmp
("h™dÀ_îr‹s", 
¨gv
[0]))

1002 
ms
->
„©uªs
 |
DM_RAID1_HANDLE_ERRORS
;

1004 
ti
->
îr‹
 = "Unrecognised featureÑequested";

1005  -
EINVAL
;

1008 (*
¨gs_u£d
)++;

1011 
	}
}

1025 
	$múr‹_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1027 
r
;

1028 
ƒ_múr‹s
, 
m
, 
¨gs_u£d
;

1029 
múr‹_£t
 *
ms
;

1030 
dm_dúty_log
 *
dl
;

1031 
dummy
;

1033 
dl
 = 
	`¸óã_dúty_log
(
ti
, 
¨gc
, 
¨gv
, &
¨gs_u£d
);

1034 i‡(!
dl
)

1035  -
EINVAL
;

1037 
¨gv
 +
¨gs_u£d
;

1038 
¨gc
 -
¨gs_u£d
;

1040 i‡(!
¨gc
 || 
	`ssˇnf
(
¨gv
[0], "%u%c", &
ƒ_múr‹s
, &
dummy
) != 1 ||

1041 
ƒ_múr‹s
 < 2 ||Çr_múr‹†> 
DM_KCOPYD_MAX_REGIONS
 + 1) {

1042 
ti
->
îr‹
 = "InvalidÇumber of mirrors";

1043 
	`dm_dúty_log_de°roy
(
dl
);

1044  -
EINVAL
;

1047 
¨gv
++, 
¨gc
--;

1049 i‡(
¨gc
 < 
ƒ_múr‹s
 * 2) {

1050 
ti
->
îr‹
 = "Too few mirrorárguments";

1051 
	`dm_dúty_log_de°roy
(
dl
);

1052  -
EINVAL
;

1055 
ms
 = 
	`Æloc_c⁄ãxt
(
ƒ_múr‹s
, 
dl
->
ty≥
->
	`gë_ªgi⁄_size
(dl), 
ti
, dl);

1056 i‡(!
ms
) {

1057 
	`dm_dúty_log_de°roy
(
dl
);

1058  -
ENOMEM
;

1062 
m
 = 0; m < 
ƒ_múr‹s
; m++) {

1063 
r
 = 
	`gë_múr‹
(
ms
, 
ti
, 
m
, 
¨gv
);

1064 i‡(
r
) {

1065 
	`‰ì_c⁄ãxt
(
ms
, 
ti
, 
m
);

1066  
r
;

1068 
¨gv
 += 2;

1069 
¨gc
 -= 2;

1072 
ti
->
¥iv©e
 = 
ms
;

1074 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
	`dm_rh_gë_ªgi⁄_size
(
ms
->
rh
));

1075 i‡(
r
)

1076 
îr_‰ì_c⁄ãxt
;

1078 
ti
->
num_Êush_bios
 = 1;

1079 
ti
->
num_disˇrd_bios
 = 1;

1080 
ti
->
≥r_bio_d©a_size
 = (
dm_øid1_bio_ªc‹d
);

1081 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

1083 
ms
->
kmúr‹d_wq
 = 
	`Æloc_w‹kqueue
("kmúr‹d", 
WQ_MEM_RECLAIM
, 0);

1084 i‡(!
ms
->
kmúr‹d_wq
) {

1085 
	`DMERR
("couldn't start kmirrord");

1086 
r
 = -
ENOMEM
;

1087 
îr_‰ì_c⁄ãxt
;

1089 
	`INIT_WORK
(&
ms
->
kmúr‹d_w‹k
, 
do_múr‹
);

1090 
	`öô_timî
(&
ms
->
timî
);

1091 
ms
->
timî_≥ndög
 = 0;

1092 
	`INIT_WORK
(&
ms
->
åiggî_evít
,Årigger_event);

1094 
r
 = 
	`∑r£_„©uªs
(
ms
, 
¨gc
, 
¨gv
, &
¨gs_u£d
);

1095 i‡(
r
)

1096 
îr_de°roy_wq
;

1098 
¨gv
 +
¨gs_u£d
;

1099 
¨gc
 -
¨gs_u£d
;

1110 i‡(
¨gc
) {

1111 
ti
->
îr‹
 = "Too many mirrorárguments";

1112 
r
 = -
EINVAL
;

1113 
îr_de°roy_wq
;

1116 
ms
->
kc›yd_˛õ¡
 = 
	`dm_kc›yd_˛õ¡_¸óã
(&
dm_kc›yd_thrŸée
);

1117 i‡(
	`IS_ERR
(
ms
->
kc›yd_˛õ¡
)) {

1118 
r
 = 
	`PTR_ERR
(
ms
->
kc›yd_˛õ¡
);

1119 
îr_de°roy_wq
;

1122 
	`wakeup_múr‹d
(
ms
);

1125 
îr_de°roy_wq
:

1126 
	`de°roy_w‹kqueue
(
ms
->
kmúr‹d_wq
);

1127 
îr_‰ì_c⁄ãxt
:

1128 
	`‰ì_c⁄ãxt
(
ms
, 
ti
, ms->
ƒ_múr‹s
);

1129  
r
;

1130 
	}
}

1132 
	$múr‹_då
(
dm_èrgë
 *
ti
)

1134 
múr‹_£t
 *
ms
 = (múr‹_£à*Ë
ti
->
¥iv©e
;

1136 
	`dñ_timî_sync
(&
ms
->
timî
);

1137 
	`Êush_w‹kqueue
(
ms
->
kmúr‹d_wq
);

1138 
	`Êush_w‹k
(&
ms
->
åiggî_evít
);

1139 
	`dm_kc›yd_˛õ¡_de°roy
(
ms
->
kc›yd_˛õ¡
);

1140 
	`de°roy_w‹kqueue
(
ms
->
kmúr‹d_wq
);

1141 
	`‰ì_c⁄ãxt
(
ms
, 
ti
, ms->
ƒ_múr‹s
);

1142 
	}
}

1147 
	$múr‹_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1149 
r
, 
rw
 = 
	`bio_rw
(
bio
);

1150 
múr‹
 *
m
;

1151 
múr‹_£t
 *
ms
 = 
ti
->
¥iv©e
;

1152 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

1153 
dm_øid1_bio_ªc‹d
 *
bio_ªc‹d
 =

1154 
	`dm_≥r_bio_d©a
(
bio
, (
dm_øid1_bio_ªc‹d
));

1156 
bio_ªc‹d
->
dëaûs
.
bi_bdev
 = 
NULL
;

1158 i‡(
rw
 =
WRITE
) {

1160 
bio_ªc‹d
->
wrôe_ªgi⁄
 = 
	`dm_rh_bio_to_ªgi⁄
(
ms
->
rh
, 
bio
);

1161 
	`queue_bio
(
ms
, 
bio
, 
rw
);

1162  
DM_MAPIO_SUBMITTED
;

1165 
r
 = 
log
->
ty≥
->
	`ö_sync
÷og, 
	`dm_rh_bio_to_ªgi⁄
(
ms
->
rh
, 
bio
), 0);

1166 i‡(
r
 < 0 &&Ñ !-
EWOULDBLOCK
)

1167  
r
;

1172 i‡(!
r
 || (∏=-
EWOULDBLOCK
)) {

1173 i‡(
rw
 =
READA
)

1174  -
EWOULDBLOCK
;

1176 
	`queue_bio
(
ms
, 
bio
, 
rw
);

1177  
DM_MAPIO_SUBMITTED
;

1184 
m
 = 
	`choo£_múr‹
(
ms
, 
bio
->
bi_ôî
.
bi_£˘‹
);

1185 i‡(
	`u∆ikñy
(!
m
))

1186  -
EIO
;

1188 
	`dm_bio_ªc‹d
(&
bio_ªc‹d
->
dëaûs
, 
bio
);

1189 
bio_ªc‹d
->
m
 = m;

1191 
	`m≠_bio
(
m
, 
bio
);

1193  
DM_MAPIO_REMAPPED
;

1194 
	}
}

1196 
	$múr‹_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

1198 
rw
 = 
	`bio_rw
(
bio
);

1199 
múr‹_£t
 *
ms
 = (múr‹_£à*Ë
ti
->
¥iv©e
;

1200 
múr‹
 *
m
 = 
NULL
;

1201 
dm_bio_dëaûs
 *
bd
 = 
NULL
;

1202 
dm_øid1_bio_ªc‹d
 *
bio_ªc‹d
 =

1203 
	`dm_≥r_bio_d©a
(
bio
, (
dm_øid1_bio_ªc‹d
));

1208 i‡(
rw
 =
WRITE
) {

1209 i‡(!(
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_DISCARD
)))

1210 
	`dm_rh_dec
(
ms
->
rh
, 
bio_ªc‹d
->
wrôe_ªgi⁄
);

1211  
îr‹
;

1214 i‡(
îr‹
 =-
EOPNOTSUPP
)

1215 
out
;

1217 i‡((
îr‹
 =-
EWOULDBLOCK
Ë&& (
bio
->
bi_rw
 & 
REQ_RAHEAD
))

1218 
out
;

1220 i‡(
	`u∆ikñy
(
îr‹
)) {

1221 i‡(!
bio_ªc‹d
->
dëaûs
.
bi_bdev
) {

1227 
	`DMERR_LIMIT
("MirrorÑead failed.");

1228  -
EIO
;

1231 
m
 = 
bio_ªc‹d
->m;

1233 
	`DMERR
("MirrorÑead failed from %s. Tryingálternative device.",

1234 
m
->
dev
->
«me
);

1236 
	`Áû_múr‹
(
m
, 
DM_RAID1_READ_ERROR
);

1242 i‡(
	`deÁu…_ok
(
m
Ë|| 
	`múr‹_avaûabÀ
(
ms
, 
bio
)) {

1243 
bd
 = &
bio_ªc‹d
->
dëaûs
;

1245 
	`dm_bio_ª°‹e
(
bd
, 
bio
);

1246 
bio_ªc‹d
->
dëaûs
.
bi_bdev
 = 
NULL
;

1248 
	`©omic_öc
(&
bio
->
bi_ªmaöög
);

1250 
	`queue_bio
(
ms
, 
bio
, 
rw
);

1251  
DM_ENDIO_INCOMPLETE
;

1253 
	`DMERR
("AllÑeplicated volumes dead, failing I/O");

1256 
out
:

1257 
bio_ªc‹d
->
dëaûs
.
bi_bdev
 = 
NULL
;

1259  
îr‹
;

1260 
	}
}

1262 
	$múr‹_¥esu•íd
(
dm_èrgë
 *
ti
)

1264 
múr‹_£t
 *
ms
 = (múr‹_£à*Ë
ti
->
¥iv©e
;

1265 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

1267 
bio_li°
 
hﬁds
;

1268 
bio
 *bio;

1270 
	`©omic_£t
(&
ms
->
su•íd
, 1);

1278 
	`•ö_lock_úq
(&
ms
->
lock
);

1279 
hﬁds
 = 
ms
->holds;

1280 
	`bio_li°_öô
(&
ms
->
hﬁds
);

1281 
	`•ö_u∆ock_úq
(&
ms
->
lock
);

1283 (
bio
 = 
	`bio_li°_p›
(&
hﬁds
)))

1284 
	`hﬁd_bio
(
ms
, 
bio
);

1290 
	`dm_rh_°›_ªcovîy
(
ms
->
rh
);

1292 
	`waô_evít
(
_kmúr‹d_ªcovîy_°›≥d
,

1293 !
	`dm_rh_ªcovîy_ö_Êight
(
ms
->
rh
));

1295 i‡(
log
->
ty≥
->
¥esu•íd
 &&Üog->ty≥->
	`¥esu•íd
(log))

1297 
	`DMWARN
("logÖresuspend failed");

1305 
	`Êush_w‹kqueue
(
ms
->
kmúr‹d_wq
);

1306 
	}
}

1308 
	$múr‹_po°su•íd
(
dm_èrgë
 *
ti
)

1310 
múr‹_£t
 *
ms
 = 
ti
->
¥iv©e
;

1311 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

1313 i‡(
log
->
ty≥
->
po°su•íd
 &&Üog->ty≥->
	`po°su•íd
(log))

1315 
	`DMWARN
("logÖostsuspend failed");

1316 
	}
}

1318 
	$múr‹_ªsume
(
dm_èrgë
 *
ti
)

1320 
múr‹_£t
 *
ms
 = 
ti
->
¥iv©e
;

1321 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

1323 
	`©omic_£t
(&
ms
->
su•íd
, 0);

1324 i‡(
log
->
ty≥
->
ªsume
 &&Üog->ty≥->
	`ªsume
(log))

1326 
	`DMWARN
("logÑesume failed");

1327 
	`dm_rh_°¨t_ªcovîy
(
ms
->
rh
);

1328 
	}
}

1343 
	$devi˚_°©us_ch¨
(
múr‹
 *
m
)

1345 i‡(!
	`©omic_ªad
(&(
m
->
îr‹_cou¡
)))

1348  (
	`ã°_bô
(
DM_RAID1_FLUSH_ERROR
, &(
m
->
îr‹_ty≥
))) ? 'F' :

1349 (
	`ã°_bô
(
DM_RAID1_WRITE_ERROR
, &(
m
->
îr‹_ty≥
))) ? 'D' :

1350 (
	`ã°_bô
(
DM_RAID1_SYNC_ERROR
, &(
m
->
îr‹_ty≥
))) ? 'S' :

1351 (
	`ã°_bô
(
DM_RAID1_READ_ERROR
, &(
m
->
îr‹_ty≥
))) ? 'R' : 'U';

1352 
	}
}

1355 
	$múr‹_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1356 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1358 
m
, 
sz
 = 0;

1359 
múr‹_£t
 *
ms
 = (múr‹_£à*Ë
ti
->
¥iv©e
;

1360 
dm_dúty_log
 *
log
 = 
	`dm_rh_dúty_log
(
ms
->
rh
);

1361 
buf„r
[
ms
->
ƒ_múr‹s
 + 1];

1363 
ty≥
) {

1364 
STATUSTYPE_INFO
:

1365 
	`DMEMIT
("%d ", 
ms
->
ƒ_múr‹s
);

1366 
m
 = 0; m < 
ms
->
ƒ_múr‹s
; m++) {

1367 
	`DMEMIT
("%†", 
ms
->
múr‹
[
m
].
dev
->
«me
);

1368 
buf„r
[
m
] = 
	`devi˚_°©us_ch¨
(&(
ms
->
múr‹
[m]));

1370 
buf„r
[
m
] = '\0';

1372 
	`DMEMIT
("%llu/%llu 1 %s ",

1373 ()
log
->
ty≥
->
	`gë_sync_cou¡
(log),

1374 ()
ms
->
ƒ_ªgi⁄s
, 
buf„r
);

1376 
sz
 +
log
->
ty≥
->
	`°©us
÷og,Åy≥, 
ªsu…
+sz, 
maxÀn
-sz);

1380 
STATUSTYPE_TABLE
:

1381 
sz
 = 
log
->
ty≥
->
	`°©us
÷og,Åy≥, 
ªsu…
, 
maxÀn
);

1383 
	`DMEMIT
("%d", 
ms
->
ƒ_múr‹s
);

1384 
m
 = 0; m < 
ms
->
ƒ_múr‹s
; m++)

1385 
	`DMEMIT
(" %†%Œu", 
ms
->
múr‹
[
m
].
dev
->
«me
,

1386 ()
ms
->
múr‹
[
m
].
off£t
);

1388 i‡(
ms
->
„©uªs
 & 
DM_RAID1_HANDLE_ERRORS
)

1389 
	`DMEMIT
(" 1 handle_errors");

1391 
	}
}

1393 
	$múr‹_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1394 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1396 
múr‹_£t
 *
ms
 = 
ti
->
¥iv©e
;

1397 
ªt
 = 0;

1398 
i
;

1400 
i
 = 0; !
ªt
 && i < 
ms
->
ƒ_múr‹s
; i++)

1401 
ªt
 = 
	`‚
(
ti
, 
ms
->
múr‹
[
i
].
dev
,

1402 
ms
->
múr‹
[
i
].
off£t
, 
ti
->
Àn
, 
d©a
);

1404  
ªt
;

1405 
	}
}

1407 
èrgë_ty≥
 
	gmúr‹_èrgë
 = {

1408 .
«me
 = "mirror",

1409 .
	gvîsi⁄
 = {1, 13, 2},

1410 .
	gmoduÀ
 = 
THIS_MODULE
,

1411 .
	g˘r
 = 
múr‹_˘r
,

1412 .
	gdå
 = 
múr‹_då
,

1413 .
	gm≠
 = 
múr‹_m≠
,

1414 .
	gíd_io
 = 
múr‹_íd_io
,

1415 .
	g¥esu•íd
 = 
múr‹_¥esu•íd
,

1416 .
	gpo°su•íd
 = 
múr‹_po°su•íd
,

1417 .
	gªsume
 = 
múr‹_ªsume
,

1418 .
	g°©us
 = 
múr‹_°©us
,

1419 .
	gôî©e_devi˚s
 = 
múr‹_ôî©e_devi˚s
,

1422 
__öô
 
	$dm_múr‹_öô
()

1424 
r
;

1426 
r
 = 
	`dm_ªgi°î_èrgë
(&
múr‹_èrgë
);

1427 i‡(
r
 < 0) {

1428 
	`DMERR
("FailedÅoÑegister mirrorÅarget");

1429 
bad_èrgë
;

1434 
bad_èrgë
:

1435  
r
;

1436 
	}
}

1438 
__exô
 
	$dm_múr‹_exô
()

1440 
	`dm_uƒegi°î_èrgë
(&
múr‹_èrgë
);

1441 
	}
}

1444 
moduÀ_öô
(
dm_múr‹_öô
);

1445 
moduÀ_exô
(
dm_múr‹_exô
);

1447 
MODULE_DESCRIPTION
(
DM_NAME
 " mirrorÅarget");

1448 
MODULE_AUTHOR
("Joe Thornber");

1449 
MODULE_LICENSE
("GPL");

	@dm-region-hash.c

8 
	~<löux/dm-dúty-log.h
>

9 
	~<löux/dm-ªgi⁄-hash.h
>

11 
	~<löux/˘y≥.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/vmÆloc.h
>

17 
	~"dm.h
"

19 
	#DM_MSG_PREFIX
 "ªgi⁄ hash"

	)

57 
	sdm_ªgi⁄_hash
 {

58 
uöt32_t
 
	mªgi⁄_size
;

59 
	mªgi⁄_shi·
;

62 
dm_dúty_log
 *
	mlog
;

65 
rwlock_t
 
	mhash_lock
;

66 
mempoﬁ_t
 *
	mªgi⁄_poﬁ
;

67 
	mmask
;

68 
	mƒ_buckës
;

69 
	m¥ime
;

70 
	mshi·
;

71 
li°_hód
 *
	mbuckës
;

73 
	mmax_ªcovîy
;

75 
•ölock_t
 
	mªgi⁄_lock
;

76 
©omic_t
 
	mªcovîy_ö_Êight
;

77 
£m≠h‹e
 
	mªcovîy_cou¡
;

78 
li°_hód
 
	m˛ón_ªgi⁄s
;

79 
li°_hód
 
	mquõs˚d_ªgi⁄s
;

80 
li°_hód
 
	mªcovîed_ªgi⁄s
;

81 
li°_hód
 
	mÁûed_ªcovîed_ªgi⁄s
;

86 
	mÊush_Áûuª
;

88 *
	mc⁄ãxt
;

89 
£˘‹_t
 
	mèrgë_begö
;

92 (*
	mdi•©ch_bios
)(*
	mc⁄ãxt
, 
bio_li°
 *
	mbios
);

95 (*
	mwakeup_w‹kîs
)(*
	mc⁄ãxt
);

98 (*
	mwakeup_Æl_ªcovîy_waôîs
)(*
	mc⁄ãxt
);

101 
	sdm_ªgi⁄
 {

102 
dm_ªgi⁄_hash
 *
	mrh
;

103 
ªgi⁄_t
 
	mkey
;

104 
	m°©e
;

106 
li°_hód
 
	mhash_li°
;

107 
li°_hód
 
	mli°
;

109 
©omic_t
 
	m≥ndög
;

110 
bio_li°
 
	mdñayed_bios
;

116 
ªgi⁄_t
 
	$dm_rh_£˘‹_to_ªgi⁄
(
dm_ªgi⁄_hash
 *
rh
, 
£˘‹_t
 
£˘‹
)

118  
£˘‹
 >> 
rh
->
ªgi⁄_shi·
;

119 
	}
}

121 
£˘‹_t
 
	$dm_rh_ªgi⁄_to_£˘‹
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

123  
ªgi⁄
 << 
rh
->
ªgi⁄_shi·
;

124 
	}
}

125 
EXPORT_SYMBOL_GPL
(
dm_rh_ªgi⁄_to_£˘‹
);

127 
ªgi⁄_t
 
	$dm_rh_bio_to_ªgi⁄
(
dm_ªgi⁄_hash
 *
rh
, 
bio
 *bio)

129  
	`dm_rh_£˘‹_to_ªgi⁄
(
rh
, 
bio
->
bi_ôî
.
bi_£˘‹
 -

130 
rh
->
èrgë_begö
);

131 
	}
}

132 
EXPORT_SYMBOL_GPL
(
dm_rh_bio_to_ªgi⁄
);

134 *
	$dm_rh_ªgi⁄_c⁄ãxt
(
dm_ªgi⁄
 *
ªg
)

136  
ªg
->
rh
->
c⁄ãxt
;

137 
	}
}

138 
EXPORT_SYMBOL_GPL
(
dm_rh_ªgi⁄_c⁄ãxt
);

140 
ªgi⁄_t
 
	$dm_rh_gë_ªgi⁄_key
(
dm_ªgi⁄
 *
ªg
)

142  
ªg
->
key
;

143 
	}
}

144 
EXPORT_SYMBOL_GPL
(
dm_rh_gë_ªgi⁄_key
);

146 
£˘‹_t
 
	$dm_rh_gë_ªgi⁄_size
(
dm_ªgi⁄_hash
 *
rh
)

148  
rh
->
ªgi⁄_size
;

149 
	}
}

150 
EXPORT_SYMBOL_GPL
(
dm_rh_gë_ªgi⁄_size
);

156 
	#RH_HASH_MULT
 2654435387U

	)

157 
	#RH_HASH_SHIFT
 12

	)

159 
	#MIN_REGIONS
 64

	)

160 
dm_ªgi⁄_hash
 *
dm_ªgi⁄_hash_¸óã
(

161 *
c⁄ãxt
, (*
di•©ch_bios
)(*context,

162 
bio_li°
 *
bios
),

163 (*
wakeup_w‹kîs
)(*
c⁄ãxt
),

164 (*
wakeup_Æl_ªcovîy_waôîs
)(*
c⁄ãxt
),

165 
£˘‹_t
 
èrgë_begö
, 
max_ªcovîy
,

166 
dm_dúty_log
 *
log
, 
uöt32_t
 
ªgi⁄_size
,

167 
ªgi⁄_t
 
ƒ_ªgi⁄s
)

169 
dm_ªgi⁄_hash
 *
rh
;

170 
ƒ_buckës
, 
max_buckës
;

171 
size_t
 
i
;

177 
max_buckës
 = 
ƒ_ªgi⁄s
 >> 6;

178 
ƒ_buckës
 = 128u;Çr_buckë†< 
max_buckës
;Çr_buckets <<= 1)

180 
ƒ_buckës
 >>= 1;

182 
rh
 = 
	`kmÆloc
((*rh), 
GFP_KERNEL
);

183 i‡(!
rh
) {

184 
	`DMERR
("unableÅoállocateÑegion hash memory");

185  
	`ERR_PTR
(-
ENOMEM
);

188 
rh
->
c⁄ãxt
 = context;

189 
rh
->
di•©ch_bios
 = dispatch_bios;

190 
rh
->
wakeup_w‹kîs
 = wakeup_workers;

191 
rh
->
wakeup_Æl_ªcovîy_waôîs
 = wakeup_all_recovery_waiters;

192 
rh
->
èrgë_begö
 =Åarget_begin;

193 
rh
->
max_ªcovîy
 = max_recovery;

194 
rh
->
log
 =Üog;

195 
rh
->
ªgi⁄_size
 =Ñegion_size;

196 
rh
->
ªgi⁄_shi·
 = 
	`ffs
(
ªgi⁄_size
) - 1;

197 
	`rwlock_öô
(&
rh
->
hash_lock
);

198 
rh
->
mask
 = 
ƒ_buckës
 - 1;

199 
rh
->
ƒ_buckës
 =Çr_buckets;

201 
rh
->
shi·
 = 
RH_HASH_SHIFT
;

202 
rh
->
¥ime
 = 
RH_HASH_MULT
;

204 
rh
->
buckës
 = 
	`vmÆloc
(
ƒ_buckës
 * (*rh->buckets));

205 i‡(!
rh
->
buckës
) {

206 
	`DMERR
("unableÅoállocateÑegion hash bucket memory");

207 
	`k‰ì
(
rh
);

208  
	`ERR_PTR
(-
ENOMEM
);

211 
i
 = 0; i < 
ƒ_buckës
; i++)

212 
	`INIT_LIST_HEAD
(
rh
->
buckës
 + 
i
);

214 
	`•ö_lock_öô
(&
rh
->
ªgi⁄_lock
);

215 
	`£ma_öô
(&
rh
->
ªcovîy_cou¡
, 0);

216 
	`©omic_£t
(&
rh
->
ªcovîy_ö_Êight
, 0);

217 
	`INIT_LIST_HEAD
(&
rh
->
˛ón_ªgi⁄s
);

218 
	`INIT_LIST_HEAD
(&
rh
->
quõs˚d_ªgi⁄s
);

219 
	`INIT_LIST_HEAD
(&
rh
->
ªcovîed_ªgi⁄s
);

220 
	`INIT_LIST_HEAD
(&
rh
->
Áûed_ªcovîed_ªgi⁄s
);

221 
rh
->
Êush_Áûuª
 = 0;

223 
rh
->
ªgi⁄_poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
MIN_REGIONS
,

224 (
dm_ªgi⁄
));

225 i‡(!
rh
->
ªgi⁄_poﬁ
) {

226 
	`v‰ì
(
rh
->
buckës
);

227 
	`k‰ì
(
rh
);

228 
rh
 = 
	`ERR_PTR
(-
ENOMEM
);

231  
rh
;

232 
	}
}

233 
EXPORT_SYMBOL_GPL
(
dm_ªgi⁄_hash_¸óã
);

235 
	$dm_ªgi⁄_hash_de°roy
(
dm_ªgi⁄_hash
 *
rh
)

237 
h
;

238 
dm_ªgi⁄
 *
ªg
, *
ƒeg
;

240 
	`BUG_ON
(!
	`li°_em±y
(&
rh
->
quõs˚d_ªgi⁄s
));

241 
h
 = 0; h < 
rh
->
ƒ_buckës
; h++) {

242 
	`li°_f‹_óch_íåy_ß„
(
ªg
, 
ƒeg
, 
rh
->
buckës
 + 
h
,

243 
hash_li°
) {

244 
	`BUG_ON
(
	`©omic_ªad
(&
ªg
->
≥ndög
));

245 
	`mempoﬁ_‰ì
(
ªg
, 
rh
->
ªgi⁄_poﬁ
);

249 i‡(
rh
->
log
)

250 
	`dm_dúty_log_de°roy
(
rh
->
log
);

252 i‡(
rh
->
ªgi⁄_poﬁ
)

253 
	`mempoﬁ_de°roy
(
rh
->
ªgi⁄_poﬁ
);

255 
	`v‰ì
(
rh
->
buckës
);

256 
	`k‰ì
(
rh
);

257 
	}
}

258 
EXPORT_SYMBOL_GPL
(
dm_ªgi⁄_hash_de°roy
);

260 
dm_dúty_log
 *
	$dm_rh_dúty_log
(
dm_ªgi⁄_hash
 *
rh
)

262  
rh
->
log
;

263 
	}
}

264 
EXPORT_SYMBOL_GPL
(
dm_rh_dúty_log
);

266 
	$rh_hash
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

268  (Ë((
ªgi⁄
 * 
rh
->
¥ime
Ë>>Ñh->
shi·
Ë&Ñh->
mask
;

269 
	}
}

271 
dm_ªgi⁄
 *
	$__rh_lookup
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

273 
dm_ªgi⁄
 *
ªg
;

274 
li°_hód
 *
buckë
 = 
rh
->
buckës
 + 
	`rh_hash
‘h, 
ªgi⁄
);

276 
	`li°_f‹_óch_íåy
(
ªg
, 
buckë
, 
hash_li°
)

277 i‡(
ªg
->
key
 =
ªgi⁄
)

278  
ªg
;

280  
NULL
;

281 
	}
}

283 
	$__rh_ö£π
(
dm_ªgi⁄_hash
 *
rh
, 
dm_ªgi⁄
 *
ªg
)

285 
	`li°_add
(&
ªg
->
hash_li°
, 
rh
->
buckës
 + 
	`rh_hash
‘h,Ñeg->
key
));

286 
	}
}

288 
dm_ªgi⁄
 *
	$__rh_Æloc
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

290 
dm_ªgi⁄
 *
ªg
, *
ƒeg
;

292 
ƒeg
 = 
	`mempoﬁ_Æloc
(
rh
->
ªgi⁄_poﬁ
, 
GFP_ATOMIC
);

293 i‡(
	`u∆ikñy
(!
ƒeg
))

294 
ƒeg
 = 
	`kmÆloc
((*ƒeg), 
GFP_NOIO
 | 
__GFP_NOFAIL
);

296 
ƒeg
->
°©e
 = 
rh
->
log
->
ty≥
->
	`ö_sync
‘h->log, 
ªgi⁄
, 1) ?

297 
DM_RH_CLEAN
 : 
DM_RH_NOSYNC
;

298 
ƒeg
->
rh
 =Ñh;

299 
ƒeg
->
key
 = 
ªgi⁄
;

300 
	`INIT_LIST_HEAD
(&
ƒeg
->
li°
);

301 
	`©omic_£t
(&
ƒeg
->
≥ndög
, 0);

302 
	`bio_li°_öô
(&
ƒeg
->
dñayed_bios
);

304 
	`wrôe_lock_úq
(&
rh
->
hash_lock
);

305 
ªg
 = 
	`__rh_lookup
(
rh
, 
ªgi⁄
);

306 i‡(
ªg
)

308 
	`mempoﬁ_‰ì
(
ƒeg
, 
rh
->
ªgi⁄_poﬁ
);

310 
	`__rh_ö£π
(
rh
, 
ƒeg
);

311 i‡(
ƒeg
->
°©e
 =
DM_RH_CLEAN
) {

312 
	`•ö_lock
(&
rh
->
ªgi⁄_lock
);

313 
	`li°_add
(&
ƒeg
->
li°
, &
rh
->
˛ón_ªgi⁄s
);

314 
	`•ö_u∆ock
(&
rh
->
ªgi⁄_lock
);

317 
ªg
 = 
ƒeg
;

319 
	`wrôe_u∆ock_úq
(&
rh
->
hash_lock
);

321  
ªg
;

322 
	}
}

324 
dm_ªgi⁄
 *
	$__rh_föd
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

326 
dm_ªgi⁄
 *
ªg
;

328 
ªg
 = 
	`__rh_lookup
(
rh
, 
ªgi⁄
);

329 i‡(!
ªg
) {

330 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

331 
ªg
 = 
	`__rh_Æloc
(
rh
, 
ªgi⁄
);

332 
	`ªad_lock
(&
rh
->
hash_lock
);

335  
ªg
;

336 
	}
}

338 
	$dm_rh_gë_°©e
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
, 
may_block
)

340 
r
;

341 
dm_ªgi⁄
 *
ªg
;

343 
	`ªad_lock
(&
rh
->
hash_lock
);

344 
ªg
 = 
	`__rh_lookup
(
rh
, 
ªgi⁄
);

345 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

347 i‡(
ªg
)

348  
ªg
->
°©e
;

354 
r
 = 
rh
->
log
->
ty≥
->
	`ö_sync
‘h->log, 
ªgi⁄
, 
may_block
);

360  
r
 =1 ? 
DM_RH_CLEAN
 : 
DM_RH_NOSYNC
;

361 
	}
}

362 
EXPORT_SYMBOL_GPL
(
dm_rh_gë_°©e
);

364 
	$com∂ëe_ªsync_w‹k
(
dm_ªgi⁄
 *
ªg
, 
suc˚ss
)

366 
dm_ªgi⁄_hash
 *
rh
 = 
ªg
->rh;

368 
rh
->
log
->
ty≥
->
	`£t_ªgi⁄_sync
‘h->log, 
ªg
->
key
, 
suc˚ss
);

379 
rh
->
	`di•©ch_bios
‘h->
c⁄ãxt
, &
ªg
->
dñayed_bios
);

380 i‡(
	`©omic_dec_™d_ã°
(&
rh
->
ªcovîy_ö_Êight
))

381 
rh
->
	`wakeup_Æl_ªcovîy_waôîs
‘h->
c⁄ãxt
);

382 
	`up
(&
rh
->
ªcovîy_cou¡
);

383 
	}
}

395 
	$dm_rh_m¨k_nosync
(
dm_ªgi⁄_hash
 *
rh
, 
bio
 *bio)

397 
Êags
;

398 
dm_dúty_log
 *
log
 = 
rh
->log;

399 
dm_ªgi⁄
 *
ªg
;

400 
ªgi⁄_t
 
ªgi⁄
 = 
	`dm_rh_bio_to_ªgi⁄
(
rh
, 
bio
);

401 
ªcovîög
 = 0;

403 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

404 
rh
->
Êush_Áûuª
 = 1;

408 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

412 
log
->
ty≥
->
	`£t_ªgi⁄_sync
÷og, 
ªgi⁄
, 0);

414 
	`ªad_lock
(&
rh
->
hash_lock
);

415 
ªg
 = 
	`__rh_föd
(
rh
, 
ªgi⁄
);

416 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

419 
	`BUG_ON
(!
ªg
);

420 
	`BUG_ON
(!
	`li°_em±y
(&
ªg
->
li°
));

422 
	`•ö_lock_úqßve
(&
rh
->
ªgi⁄_lock
, 
Êags
);

430 
ªcovîög
 = (
ªg
->
°©e
 =
DM_RH_RECOVERING
);

431 
ªg
->
°©e
 = 
DM_RH_NOSYNC
;

432 
	`BUG_ON
(!
	`li°_em±y
(&
ªg
->
li°
));

433 
	`•ö_u∆ock_úqª°‹e
(&
rh
->
ªgi⁄_lock
, 
Êags
);

435 i‡(
ªcovîög
)

436 
	`com∂ëe_ªsync_w‹k
(
ªg
, 0);

437 
	}
}

438 
EXPORT_SYMBOL_GPL
(
dm_rh_m¨k_nosync
);

440 
	$dm_rh_upd©e_°©es
(
dm_ªgi⁄_hash
 *
rh
, 
îr‹s_h™dÀd
)

442 
dm_ªgi⁄
 *
ªg
, *
√xt
;

444 
	`LIST_HEAD
(
˛ón
);

445 
	`LIST_HEAD
(
ªcovîed
);

446 
	`LIST_HEAD
(
Áûed_ªcovîed
);

451 
	`wrôe_lock_úq
(&
rh
->
hash_lock
);

452 
	`•ö_lock
(&
rh
->
ªgi⁄_lock
);

453 i‡(!
	`li°_em±y
(&
rh
->
˛ón_ªgi⁄s
)) {

454 
	`li°_•li˚_öô
(&
rh
->
˛ón_ªgi⁄s
, &
˛ón
);

456 
	`li°_f‹_óch_íåy
(
ªg
, &
˛ón
, 
li°
)

457 
	`li°_dñ
(&
ªg
->
hash_li°
);

460 i‡(!
	`li°_em±y
(&
rh
->
ªcovîed_ªgi⁄s
)) {

461 
	`li°_•li˚_öô
(&
rh
->
ªcovîed_ªgi⁄s
, &
ªcovîed
);

463 
	`li°_f‹_óch_íåy
(
ªg
, &
ªcovîed
, 
li°
)

464 
	`li°_dñ
(&
ªg
->
hash_li°
);

467 i‡(!
	`li°_em±y
(&
rh
->
Áûed_ªcovîed_ªgi⁄s
)) {

468 
	`li°_•li˚_öô
(&
rh
->
Áûed_ªcovîed_ªgi⁄s
,

469 &
Áûed_ªcovîed
);

471 
	`li°_f‹_óch_íåy
(
ªg
, &
Áûed_ªcovîed
, 
li°
)

472 
	`li°_dñ
(&
ªg
->
hash_li°
);

475 
	`•ö_u∆ock
(&
rh
->
ªgi⁄_lock
);

476 
	`wrôe_u∆ock_úq
(&
rh
->
hash_lock
);

483 
	`li°_f‹_óch_íåy_ß„
(
ªg
, 
√xt
, &
ªcovîed
, 
li°
) {

484 
rh
->
log
->
ty≥
->
	`˛ór_ªgi⁄
‘h->log, 
ªg
->
key
);

485 
	`com∂ëe_ªsync_w‹k
(
ªg
, 1);

486 
	`mempoﬁ_‰ì
(
ªg
, 
rh
->
ªgi⁄_poﬁ
);

489 
	`li°_f‹_óch_íåy_ß„
(
ªg
, 
√xt
, &
Áûed_ªcovîed
, 
li°
) {

490 
	`com∂ëe_ªsync_w‹k
(
ªg
, 
îr‹s_h™dÀd
 ? 0 : 1);

491 
	`mempoﬁ_‰ì
(
ªg
, 
rh
->
ªgi⁄_poﬁ
);

494 
	`li°_f‹_óch_íåy_ß„
(
ªg
, 
√xt
, &
˛ón
, 
li°
) {

495 
rh
->
log
->
ty≥
->
	`˛ór_ªgi⁄
‘h->log, 
ªg
->
key
);

496 
	`mempoﬁ_‰ì
(
ªg
, 
rh
->
ªgi⁄_poﬁ
);

499 
rh
->
log
->
ty≥
->
	`Êush
(rh->log);

500 
	}
}

501 
EXPORT_SYMBOL_GPL
(
dm_rh_upd©e_°©es
);

503 
	$rh_öc
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

505 
dm_ªgi⁄
 *
ªg
;

507 
	`ªad_lock
(&
rh
->
hash_lock
);

508 
ªg
 = 
	`__rh_föd
(
rh
, 
ªgi⁄
);

510 
	`•ö_lock_úq
(&
rh
->
ªgi⁄_lock
);

511 
	`©omic_öc
(&
ªg
->
≥ndög
);

513 i‡(
ªg
->
°©e
 =
DM_RH_CLEAN
) {

514 
ªg
->
°©e
 = 
DM_RH_DIRTY
;

515 
	`li°_dñ_öô
(&
ªg
->
li°
);

516 
	`•ö_u∆ock_úq
(&
rh
->
ªgi⁄_lock
);

518 
rh
->
log
->
ty≥
->
	`m¨k_ªgi⁄
‘h->log, 
ªg
->
key
);

520 
	`•ö_u∆ock_úq
(&
rh
->
ªgi⁄_lock
);

523 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

524 
	}
}

526 
	$dm_rh_öc_≥ndög
(
dm_ªgi⁄_hash
 *
rh
, 
bio_li°
 *
bios
)

528 
bio
 *bio;

530 
bio
 = 
bios
->
hód
; bio; biÿbio->
bi_√xt
) {

531 i‡(
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_DISCARD
))

533 
	`rh_öc
(
rh
, 
	`dm_rh_bio_to_ªgi⁄
‘h, 
bio
));

535 
	}
}

536 
EXPORT_SYMBOL_GPL
(
dm_rh_öc_≥ndög
);

538 
	$dm_rh_dec
(
dm_ªgi⁄_hash
 *
rh
, 
ªgi⁄_t
 
ªgi⁄
)

540 
Êags
;

541 
dm_ªgi⁄
 *
ªg
;

542 
should_wake
 = 0;

544 
	`ªad_lock
(&
rh
->
hash_lock
);

545 
ªg
 = 
	`__rh_lookup
(
rh
, 
ªgi⁄
);

546 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

548 
	`•ö_lock_úqßve
(&
rh
->
ªgi⁄_lock
, 
Êags
);

549 i‡(
	`©omic_dec_™d_ã°
(&
ªg
->
≥ndög
)) {

562 i‡(
	`u∆ikñy
(
rh
->
Êush_Áûuª
)) {

568 
ªg
->
°©e
 = 
DM_RH_NOSYNC
;

569 } i‡(
ªg
->
°©e
 =
DM_RH_RECOVERING
) {

570 
	`li°_add_èû
(&
ªg
->
li°
, &
rh
->
quõs˚d_ªgi⁄s
);

571 } i‡(
ªg
->
°©e
 =
DM_RH_DIRTY
) {

572 
ªg
->
°©e
 = 
DM_RH_CLEAN
;

573 
	`li°_add
(&
ªg
->
li°
, &
rh
->
˛ón_ªgi⁄s
);

575 
should_wake
 = 1;

577 
	`•ö_u∆ock_úqª°‹e
(&
rh
->
ªgi⁄_lock
, 
Êags
);

579 i‡(
should_wake
)

580 
rh
->
	`wakeup_w‹kîs
‘h->
c⁄ãxt
);

581 
	}
}

582 
EXPORT_SYMBOL_GPL
(
dm_rh_dec
);

587 
	$__rh_ªcovîy_¥ï¨e
(
dm_ªgi⁄_hash
 *
rh
)

589 
r
;

590 
ªgi⁄_t
 
ªgi⁄
;

591 
dm_ªgi⁄
 *
ªg
;

596 
r
 = 
rh
->
log
->
ty≥
->
	`gë_ªsync_w‹k
‘h->log, &
ªgi⁄
);

597 i‡(
r
 <= 0)

598  
r
;

604 
	`ªad_lock
(&
rh
->
hash_lock
);

605 
ªg
 = 
	`__rh_föd
(
rh
, 
ªgi⁄
);

606 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

608 
	`•ö_lock_úq
(&
rh
->
ªgi⁄_lock
);

609 
ªg
->
°©e
 = 
DM_RH_RECOVERING
;

612 i‡(
	`©omic_ªad
(&
ªg
->
≥ndög
))

613 
	`li°_dñ_öô
(&
ªg
->
li°
);

615 
	`li°_move
(&
ªg
->
li°
, &
rh
->
quõs˚d_ªgi⁄s
);

617 
	`•ö_u∆ock_úq
(&
rh
->
ªgi⁄_lock
);

620 
	}
}

622 
	$dm_rh_ªcovîy_¥ï¨e
(
dm_ªgi⁄_hash
 *
rh
)

625 
	`©omic_öc
(&
rh
->
ªcovîy_ö_Êight
);

627 !
	`down_åylock
(&
rh
->
ªcovîy_cou¡
)) {

628 
	`©omic_öc
(&
rh
->
ªcovîy_ö_Êight
);

629 i‡(
	`__rh_ªcovîy_¥ï¨e
(
rh
) <= 0) {

630 
	`©omic_dec
(&
rh
->
ªcovîy_ö_Êight
);

631 
	`up
(&
rh
->
ªcovîy_cou¡
);

637 i‡(
	`©omic_dec_™d_ã°
(&
rh
->
ªcovîy_ö_Êight
))

638 
rh
->
	`wakeup_Æl_ªcovîy_waôîs
‘h->
c⁄ãxt
);

639 
	}
}

640 
EXPORT_SYMBOL_GPL
(
dm_rh_ªcovîy_¥ï¨e
);

645 
dm_ªgi⁄
 *
	$dm_rh_ªcovîy_°¨t
(
dm_ªgi⁄_hash
 *
rh
)

647 
dm_ªgi⁄
 *
ªg
 = 
NULL
;

649 
	`•ö_lock_úq
(&
rh
->
ªgi⁄_lock
);

650 i‡(!
	`li°_em±y
(&
rh
->
quõs˚d_ªgi⁄s
)) {

651 
ªg
 = 
	`li°_íåy
(
rh
->
quõs˚d_ªgi⁄s
.
√xt
,

652 
dm_ªgi⁄
, 
li°
);

653 
	`li°_dñ_öô
(&
ªg
->
li°
);

655 
	`•ö_u∆ock_úq
(&
rh
->
ªgi⁄_lock
);

657  
ªg
;

658 
	}
}

659 
EXPORT_SYMBOL_GPL
(
dm_rh_ªcovîy_°¨t
);

661 
	$dm_rh_ªcovîy_íd
(
dm_ªgi⁄
 *
ªg
, 
suc˚ss
)

663 
dm_ªgi⁄_hash
 *
rh
 = 
ªg
->rh;

665 
	`•ö_lock_úq
(&
rh
->
ªgi⁄_lock
);

666 i‡(
suc˚ss
)

667 
	`li°_add
(&
ªg
->
li°
, &ªg->
rh
->
ªcovîed_ªgi⁄s
);

669 
	`li°_add
(&
ªg
->
li°
, &ªg->
rh
->
Áûed_ªcovîed_ªgi⁄s
);

671 
	`•ö_u∆ock_úq
(&
rh
->
ªgi⁄_lock
);

673 
rh
->
	`wakeup_w‹kîs
‘h->
c⁄ãxt
);

674 
	}
}

675 
EXPORT_SYMBOL_GPL
(
dm_rh_ªcovîy_íd
);

678 
	$dm_rh_ªcovîy_ö_Êight
(
dm_ªgi⁄_hash
 *
rh
)

680  
	`©omic_ªad
(&
rh
->
ªcovîy_ö_Êight
);

681 
	}
}

682 
EXPORT_SYMBOL_GPL
(
dm_rh_ªcovîy_ö_Êight
);

684 
	$dm_rh_Êush
(
dm_ªgi⁄_hash
 *
rh
)

686  
rh
->
log
->
ty≥
->
	`Êush
(rh->log);

687 
	}
}

688 
EXPORT_SYMBOL_GPL
(
dm_rh_Êush
);

690 
	$dm_rh_dñay
(
dm_ªgi⁄_hash
 *
rh
, 
bio
 *bio)

692 
dm_ªgi⁄
 *
ªg
;

694 
	`ªad_lock
(&
rh
->
hash_lock
);

695 
ªg
 = 
	`__rh_föd
(
rh
, 
	`dm_rh_bio_to_ªgi⁄
‘h, 
bio
));

696 
	`bio_li°_add
(&
ªg
->
dñayed_bios
, 
bio
);

697 
	`ªad_u∆ock
(&
rh
->
hash_lock
);

698 
	}
}

699 
EXPORT_SYMBOL_GPL
(
dm_rh_dñay
);

701 
	$dm_rh_°›_ªcovîy
(
dm_ªgi⁄_hash
 *
rh
)

703 
i
;

706 
i
 = 0; i < 
rh
->
max_ªcovîy
; i++)

707 
	`down
(&
rh
->
ªcovîy_cou¡
);

708 
	}
}

709 
EXPORT_SYMBOL_GPL
(
dm_rh_°›_ªcovîy
);

711 
	$dm_rh_°¨t_ªcovîy
(
dm_ªgi⁄_hash
 *
rh
)

713 
i
;

715 
i
 = 0; i < 
rh
->
max_ªcovîy
; i++)

716 
	`up
(&
rh
->
ªcovîy_cou¡
);

718 
rh
->
	`wakeup_w‹kîs
‘h->
c⁄ãxt
);

719 
	}
}

720 
EXPORT_SYMBOL_GPL
(
dm_rh_°¨t_ªcovîy
);

722 
MODULE_DESCRIPTION
(
DM_NAME
 "Ñegion hash");

723 
MODULE_AUTHOR
("Joe Thornber/Heinz Mauelshagen <dm-devel@redhat.com>");

724 
MODULE_LICENSE
("GPL");

	@dm-region-hash.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

13 
MODULE_INFO
(
öåì
, "Y");

15 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

16 
__u£d


17 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

18 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

19 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

20 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

21 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

22 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

23 { 0x8b900f3b, 
__VMLINUX_SYMBOL_STR
(
_øw_ªad_lock
) },

24 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

25 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

26 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

27 { 0xf147ecb1, 
__VMLINUX_SYMBOL_STR
(
down_åylock
) },

28 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

29 { 0x68aˇ4ad, 
__VMLINUX_SYMBOL_STR
(
down
) },

30 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

31 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

32 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

33 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

34 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

35 { 0x2c224067, 
__VMLINUX_SYMBOL_STR
(
_øw_wrôe_lock_úq
) },

36 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

37 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

38 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

39 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

40 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

41 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

42 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

43 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

44 { 0x71e3˚cb, 
__VMLINUX_SYMBOL_STR
(
up
) },

45 { 0x969e9378, 
__VMLINUX_SYMBOL_STR
(
dm_dúty_log_de°roy
) },

48 c⁄° 
	g__moduÀ_dïíds
[]

49 
__u£d


50 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

54 
MODULE_INFO
(
§cvîsi⁄
, "84AB0464B815538F470617D");

	@dm-round-robin.c

12 
	~<löux/devi˚-m≠≥r.h
>

14 
	~"dm-∑th-£À˘‹.h
"

16 
	~<löux/¶ab.h
>

17 
	~<löux/moduÀ.h
>

19 
	#DM_MSG_PREFIX
 "mu…ù©hÑound-robö"

	)

24 
	s∑th_öfo
 {

25 
li°_hód
 
	mli°
;

26 
dm_∑th
 *
	m∑th
;

27 
	mª≥©_cou¡
;

30 
	$‰ì_∑ths
(
li°_hód
 *
∑ths
)

32 
∑th_öfo
 *
pi
, *
√xt
;

34 
	`li°_f‹_óch_íåy_ß„
(
pi
, 
√xt
, 
∑ths
, 
li°
) {

35 
	`li°_dñ
(&
pi
->
li°
);

36 
	`k‰ì
(
pi
);

38 
	}
}

44 
	#RR_MIN_IO
 1000

	)

46 
	s£À˘‹
 {

47 
li°_hód
 
	mvÆid_∑ths
;

48 
li°_hód
 
	mövÆid_∑ths
;

51 
£À˘‹
 *
	$Æloc_£À˘‹
()

53 
£À˘‹
 *
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

55 i‡(
s
) {

56 
	`INIT_LIST_HEAD
(&
s
->
vÆid_∑ths
);

57 
	`INIT_LIST_HEAD
(&
s
->
övÆid_∑ths
);

60  
s
;

61 
	}
}

63 
	$º_¸óã
(
∑th_£À˘‹
 *
ps
, 
¨gc
, **
¨gv
)

65 
£À˘‹
 *
s
;

67 
s
 = 
	`Æloc_£À˘‹
();

68 i‡(!
s
)

69  -
ENOMEM
;

71 
ps
->
c⁄ãxt
 = 
s
;

73 
	}
}

75 
	$º_de°roy
(
∑th_£À˘‹
 *
ps
)

77 
£À˘‹
 *
s
 = (£À˘‹ *Ë
ps
->
c⁄ãxt
;

79 
	`‰ì_∑ths
(&
s
->
vÆid_∑ths
);

80 
	`‰ì_∑ths
(&
s
->
övÆid_∑ths
);

81 
	`k‰ì
(
s
);

82 
ps
->
c⁄ãxt
 = 
NULL
;

83 
	}
}

85 
	$º_°©us
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

86 
°©us_ty≥_t
 
ty≥
, *
ªsu…
, 
maxÀn
)

88 
∑th_öfo
 *
pi
;

89 
sz
 = 0;

91 i‡(!
∑th
)

92 
	`DMEMIT
("0 ");

94 
ty≥
) {

95 
STATUSTYPE_INFO
:

97 
STATUSTYPE_TABLE
:

98 
pi
 = 
∑th
->
psc⁄ãxt
;

99 
	`DMEMIT
("%u ", 
pi
->
ª≥©_cou¡
);

104  
sz
;

105 
	}
}

111 
	$º_add_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

112 
¨gc
, **
¨gv
, **
îr‹
)

114 
£À˘‹
 *
s
 = (£À˘‹ *Ë
ps
->
c⁄ãxt
;

115 
∑th_öfo
 *
pi
;

116 
ª≥©_cou¡
 = 
RR_MIN_IO
;

117 
dummy
;

119 i‡(
¨gc
 > 1) {

120 *
îr‹
 = "round-robinÖs: incorrectÇumber ofárguments";

121  -
EINVAL
;

125 i‡((
¨gc
 =1Ë&& (
	`ssˇnf
(
¨gv
[0], "%u%c", &
ª≥©_cou¡
, &
dummy
) != 1)) {

126 *
îr‹
 = "round-robinÖs: invalidÑepeat count";

127  -
EINVAL
;

131 
pi
 = 
	`kmÆloc
((*pi), 
GFP_KERNEL
);

132 i‡(!
pi
) {

133 *
îr‹
 = "round-robinÖs: ErrorállocatingÖath context";

134  -
ENOMEM
;

137 
pi
->
∑th
 =Öath;

138 
pi
->
ª≥©_cou¡
 =Ñepeat_count;

140 
∑th
->
psc⁄ãxt
 = 
pi
;

142 
	`li°_add_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

145 
	}
}

147 
	$º_Áû_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
p
)

149 
£À˘‹
 *
s
 = (£À˘‹ *Ë
ps
->
c⁄ãxt
;

150 
∑th_öfo
 *
pi
 = 
p
->
psc⁄ãxt
;

152 
	`li°_move
(&
pi
->
li°
, &
s
->
övÆid_∑ths
);

153 
	}
}

155 
	$º_ªö°©e_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
p
)

157 
£À˘‹
 *
s
 = (£À˘‹ *Ë
ps
->
c⁄ãxt
;

158 
∑th_öfo
 *
pi
 = 
p
->
psc⁄ãxt
;

160 
	`li°_move
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

163 
	}
}

165 
dm_∑th
 *
	$º_£À˘_∑th
(
∑th_£À˘‹
 *
ps
,

166 *
ª≥©_cou¡
, 
size_t
 
ƒ_byãs
)

168 
£À˘‹
 *
s
 = (£À˘‹ *Ë
ps
->
c⁄ãxt
;

169 
∑th_öfo
 *
pi
 = 
NULL
;

171 i‡(!
	`li°_em±y
(&
s
->
vÆid_∑ths
)) {

172 
pi
 = 
	`li°_íåy
(
s
->
vÆid_∑ths
.
√xt
, 
∑th_öfo
, 
li°
);

173 
	`li°_move_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

174 *
ª≥©_cou¡
 = 
pi
->repeat_count;

177  
pi
 ?Öi->
∑th
 : 
NULL
;

178 
	}
}

180 
∑th_£À˘‹_ty≥
 
	gº_ps
 = {

181 .
«me
 = "round-robin",

182 .
	gmoduÀ
 = 
THIS_MODULE
,

183 .
	gèbÀ_¨gs
 = 1,

184 .
	göfo_¨gs
 = 0,

185 .
	g¸óã
 = 
º_¸óã
,

186 .
	gde°roy
 = 
º_de°roy
,

187 .
	g°©us
 = 
º_°©us
,

188 .
	gadd_∑th
 = 
º_add_∑th
,

189 .
	gÁû_∑th
 = 
º_Áû_∑th
,

190 .
	gªö°©e_∑th
 = 
º_ªö°©e_∑th
,

191 .
	g£À˘_∑th
 = 
º_£À˘_∑th
,

194 
__öô
 
	$dm_º_öô
()

196 
r
 = 
	`dm_ªgi°î_∑th_£À˘‹
(&
º_ps
);

198 i‡(
r
 < 0)

199 
	`DMERR
("ªgi°î faûed %d", 
r
);

201 
	`DMINFO
("version 1.0.0Üoaded");

203  
r
;

204 
	}
}

206 
__exô
 
	$dm_º_exô
()

208 
r
 = 
	`dm_uƒegi°î_∑th_£À˘‹
(&
º_ps
);

210 i‡(
r
 < 0)

211 
	`DMERR
("uƒegi°î faûed %d", 
r
);

212 
	}
}

214 
moduÀ_öô
(
dm_º_öô
);

215 
moduÀ_exô
(
dm_º_exô
);

217 
MODULE_DESCRIPTION
(
DM_NAME
 "Ñound-robin multipathÖath selector");

218 
MODULE_AUTHOR
("Sistina Software <dm-devel@redhat.com>");

219 
MODULE_LICENSE
("GPL");

	@dm-round-robin.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xa1a86d48, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_∑th_£À˘‹
) },

24 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

25 { 0x32d0b785, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_∑th_£À˘‹
) },

26 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

27 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

28 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

29 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

30 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

31 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

34 c⁄° 
	g__moduÀ_dïíds
[]

35 
__u£d


36 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

40 
MODULE_INFO
(
§cvîsi⁄
, "A773DF8E298CE0F15746CA7");

	@dm-service-time.c

11 
	~"dm.h
"

12 
	~"dm-∑th-£À˘‹.h
"

14 
	~<löux/¶ab.h
>

15 
	~<löux/moduÀ.h
>

17 
	#DM_MSG_PREFIX
 "mu…ù©h sîvi˚-time"

	)

18 
	#ST_MIN_IO
 1

	)

19 
	#ST_MAX_RELATIVE_THROUGHPUT
 100

	)

20 
	#ST_MAX_RELATIVE_THROUGHPUT_SHIFT
 7

	)

21 
	#ST_MAX_INFLIGHT_SIZE
 ((
size_t
)-1 >> 
ST_MAX_RELATIVE_THROUGHPUT_SHIFT
)

	)

22 
	#ST_VERSION
 "0.2.0"

	)

24 
	s£À˘‹
 {

25 
li°_hód
 
	mvÆid_∑ths
;

26 
li°_hód
 
	mÁûed_∑ths
;

29 
	s∑th_öfo
 {

30 
li°_hód
 
	mli°
;

31 
dm_∑th
 *
	m∑th
;

32 
	mª≥©_cou¡
;

33 
	mªœtive_throughput
;

34 
©omic_t
 
	mö_Êight_size
;

37 
£À˘‹
 *
	$Æloc_£À˘‹
()

39 
£À˘‹
 *
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

41 i‡(
s
) {

42 
	`INIT_LIST_HEAD
(&
s
->
vÆid_∑ths
);

43 
	`INIT_LIST_HEAD
(&
s
->
Áûed_∑ths
);

46  
s
;

47 
	}
}

49 
	$°_¸óã
(
∑th_£À˘‹
 *
ps
, 
¨gc
, **
¨gv
)

51 
£À˘‹
 *
s
 = 
	`Æloc_£À˘‹
();

53 i‡(!
s
)

54  -
ENOMEM
;

56 
ps
->
c⁄ãxt
 = 
s
;

58 
	}
}

60 
	$‰ì_∑ths
(
li°_hód
 *
∑ths
)

62 
∑th_öfo
 *
pi
, *
√xt
;

64 
	`li°_f‹_óch_íåy_ß„
(
pi
, 
√xt
, 
∑ths
, 
li°
) {

65 
	`li°_dñ
(&
pi
->
li°
);

66 
	`k‰ì
(
pi
);

68 
	}
}

70 
	$°_de°roy
(
∑th_£À˘‹
 *
ps
)

72 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

74 
	`‰ì_∑ths
(&
s
->
vÆid_∑ths
);

75 
	`‰ì_∑ths
(&
s
->
Áûed_∑ths
);

76 
	`k‰ì
(
s
);

77 
ps
->
c⁄ãxt
 = 
NULL
;

78 
	}
}

80 
	$°_°©us
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

81 
°©us_ty≥_t
 
ty≥
, *
ªsu…
, 
maxÀn
)

83 
sz
 = 0;

84 
∑th_öfo
 *
pi
;

86 i‡(!
∑th
)

87 
	`DMEMIT
("0 ");

89 
pi
 = 
∑th
->
psc⁄ãxt
;

91 
ty≥
) {

92 
STATUSTYPE_INFO
:

93 
	`DMEMIT
("%d %u ", 
	`©omic_ªad
(&
pi
->
ö_Êight_size
),

94 
pi
->
ªœtive_throughput
);

96 
STATUSTYPE_TABLE
:

97 
	`DMEMIT
("%u %u ", 
pi
->
ª≥©_cou¡
,

98 
pi
->
ªœtive_throughput
);

103  
sz
;

104 
	}
}

106 
	$°_add_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

107 
¨gc
, **
¨gv
, **
îr‹
)

109 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

110 
∑th_öfo
 *
pi
;

111 
ª≥©_cou¡
 = 
ST_MIN_IO
;

112 
ªœtive_throughput
 = 1;

113 
dummy
;

127 i‡(
¨gc
 > 2) {

128 *
îr‹
 = "service-timeÖs: incorrectÇumber ofárguments";

129  -
EINVAL
;

132 i‡(
¨gc
 && (
	`ssˇnf
(
¨gv
[0], "%u%c", &
ª≥©_cou¡
, &
dummy
) != 1)) {

133 *
îr‹
 = "service-timeÖs: invalidÑepeat count";

134  -
EINVAL
;

137 i‡((
¨gc
 == 2) &&

138 (
	`ssˇnf
(
¨gv
[1], "%u%c", &
ªœtive_throughput
, &
dummy
) != 1 ||

139 
ªœtive_throughput
 > 
ST_MAX_RELATIVE_THROUGHPUT
)) {

140 *
îr‹
 = "service-timeÖs: invalidÑelative_throughput value";

141  -
EINVAL
;

145 
pi
 = 
	`kmÆloc
((*pi), 
GFP_KERNEL
);

146 i‡(!
pi
) {

147 *
îr‹
 = "service-timeÖs: ErrorállocatingÖath context";

148  -
ENOMEM
;

151 
pi
->
∑th
 =Öath;

152 
pi
->
ª≥©_cou¡
 =Ñepeat_count;

153 
pi
->
ªœtive_throughput
 =Ñelative_throughput;

154 
	`©omic_£t
(&
pi
->
ö_Êight_size
, 0);

156 
∑th
->
psc⁄ãxt
 = 
pi
;

158 
	`li°_add_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

161 
	}
}

163 
	$°_Áû_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
)

165 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

166 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

168 
	`li°_move
(&
pi
->
li°
, &
s
->
Áûed_∑ths
);

169 
	}
}

171 
	$°_ªö°©e_∑th
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
)

173 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

174 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

176 
	`li°_move_èû
(&
pi
->
li°
, &
s
->
vÆid_∑ths
);

179 
	}
}

196 
	$°_com∑ª_lﬂd
(
∑th_öfo
 *
pi1
, ∑th_öfÿ*
pi2
,

197 
size_t
 
öcomög
)

199 
size_t
 
sz1
, 
sz2
, 
°1
, 
°2
;

201 
sz1
 = 
	`©omic_ªad
(&
pi1
->
ö_Êight_size
);

202 
sz2
 = 
	`©omic_ªad
(&
pi2
->
ö_Êight_size
);

207 i‡(
pi1
->
ªœtive_throughput
 =
pi2
->relative_throughput)

208  
sz1
 - 
sz2
;

214 i‡(
sz1
 =
sz2
 ||

215 !
pi1
->
ªœtive_throughput
 || !
pi2
->relative_throughput)

216  
pi2
->
ªœtive_throughput
 - 
pi1
->relative_throughput;

235 
sz1
 +
öcomög
;

236 
sz2
 +
öcomög
;

237 i‡(
	`u∆ikñy
(
sz1
 >
ST_MAX_INFLIGHT_SIZE
 ||

238 
sz2
 >
ST_MAX_INFLIGHT_SIZE
)) {

244 
sz1
 >>
ST_MAX_RELATIVE_THROUGHPUT_SHIFT
;

245 
sz2
 >>
ST_MAX_RELATIVE_THROUGHPUT_SHIFT
;

247 
°1
 = 
sz1
 * 
pi2
->
ªœtive_throughput
;

248 
°2
 = 
sz2
 * 
pi1
->
ªœtive_throughput
;

249 i‡(
°1
 !
°2
)

250  
°1
 - 
°2
;

255  
pi2
->
ªœtive_throughput
 - 
pi1
->relative_throughput;

256 
	}
}

258 
dm_∑th
 *
	$°_£À˘_∑th
(
∑th_£À˘‹
 *
ps
,

259 *
ª≥©_cou¡
, 
size_t
 
ƒ_byãs
)

261 
£À˘‹
 *
s
 = 
ps
->
c⁄ãxt
;

262 
∑th_öfo
 *
pi
 = 
NULL
, *
be°
 = NULL;

264 i‡(
	`li°_em±y
(&
s
->
vÆid_∑ths
))

265  
NULL
;

268 
	`li°_move_èû
(
s
->
vÆid_∑ths
.
√xt
, &s->valid_paths);

270 
	`li°_f‹_óch_íåy
(
pi
, &
s
->
vÆid_∑ths
, 
li°
)

271 i‡(!
be°
 || (
	`°_com∑ª_lﬂd
(
pi
, be°, 
ƒ_byãs
) < 0))

272 
be°
 = 
pi
;

274 i‡(!
be°
)

275  
NULL
;

277 *
ª≥©_cou¡
 = 
be°
->repeat_count;

279  
be°
->
∑th
;

280 
	}
}

282 
	$°_°¨t_io
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

283 
size_t
 
ƒ_byãs
)

285 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

287 
	`©omic_add
(
ƒ_byãs
, &
pi
->
ö_Êight_size
);

290 
	}
}

292 
	$°_íd_io
(
∑th_£À˘‹
 *
ps
, 
dm_∑th
 *
∑th
,

293 
size_t
 
ƒ_byãs
)

295 
∑th_öfo
 *
pi
 = 
∑th
->
psc⁄ãxt
;

297 
	`©omic_sub
(
ƒ_byãs
, &
pi
->
ö_Êight_size
);

300 
	}
}

302 
∑th_£À˘‹_ty≥
 
	g°_ps
 = {

303 .
«me
 = "service-time",

304 .
	gmoduÀ
 = 
THIS_MODULE
,

305 .
	gèbÀ_¨gs
 = 2,

306 .
	göfo_¨gs
 = 2,

307 .
	g¸óã
 = 
°_¸óã
,

308 .
	gde°roy
 = 
°_de°roy
,

309 .
	g°©us
 = 
°_°©us
,

310 .
	gadd_∑th
 = 
°_add_∑th
,

311 .
	gÁû_∑th
 = 
°_Áû_∑th
,

312 .
	gªö°©e_∑th
 = 
°_ªö°©e_∑th
,

313 .
	g£À˘_∑th
 = 
°_£À˘_∑th
,

314 .
	g°¨t_io
 = 
°_°¨t_io
,

315 .
	gíd_io
 = 
°_íd_io
,

318 
__öô
 
	$dm_°_öô
()

320 
r
 = 
	`dm_ªgi°î_∑th_£À˘‹
(&
°_ps
);

322 i‡(
r
 < 0)

323 
	`DMERR
("ªgi°î faûed %d", 
r
);

325 
	`DMINFO
("vîsi⁄ " 
ST_VERSION
 "Üoaded");

327  
r
;

328 
	}
}

330 
__exô
 
	$dm_°_exô
()

332 
r
 = 
	`dm_uƒegi°î_∑th_£À˘‹
(&
°_ps
);

334 i‡(
r
 < 0)

335 
	`DMERR
("uƒegi°î faûed %d", 
r
);

336 
	}
}

338 
moduÀ_öô
(
dm_°_öô
);

339 
moduÀ_exô
(
dm_°_exô
);

341 
MODULE_DESCRIPTION
(
DM_NAME
 "Åhroughput orientedÖath selector");

342 
MODULE_AUTHOR
("Kiyoshi Ueda <k-ueda@ct.jp.nec.com>");

343 
MODULE_LICENSE
("GPL");

	@dm-service-time.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xa1a86d48, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_∑th_£À˘‹
) },

24 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

25 { 0x32d0b785, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_∑th_£À˘‹
) },

26 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

27 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

28 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

29 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

30 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

31 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

34 c⁄° 
	g__moduÀ_dïíds
[]

35 
__u£d


36 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

40 
MODULE_INFO
(
§cvîsi⁄
, "5F0897DDF623F55997FB1C4");

	@dm-snap-persistent.c

8 
	~"dm-ex˚±i⁄-°‹e.h
"

10 
	~<löux/mm.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/vmÆloc.h
>

13 
	~<löux/exp‹t.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/dm-io.h
>

16 
	~"dm-bufio.h
"

18 
	#DM_MSG_PREFIX
 "≥rsi°íà¢≠shŸ"

	)

19 
	#DM_CHUNK_SIZE_DEFAULT_SECTORS
 32

	)

21 
	#DM_PREFETCH_CHUNKS
 12

	)

55 
	#SNAP_MAGIC
 0x70416e53

	)

60 
	#SNAPSHOT_DISK_VERSION
 1

	)

62 
	#NUM_SNAPSHOT_HDR_CHUNKS
 1

	)

64 
	sdisk_hódî
 {

65 
__À32
 
	mmagic
;

71 
__À32
 
	mvÆid
;

77 
__À32
 
	mvîsi⁄
;

80 
__À32
 
	mchunk_size
;

81 } 
	g__∑cked
;

83 
	sdisk_ex˚±i⁄
 {

84 
__À64
 
	mﬁd_chunk
;

85 
__À64
 
	m√w_chunk
;

86 } 
	g__∑cked
;

88 
	sc‹e_ex˚±i⁄
 {

89 
uöt64_t
 
	mﬁd_chunk
;

90 
uöt64_t
 
	m√w_chunk
;

93 
	scommô_ˇŒback
 {

94 (*
	mˇŒback
)(*, 
	msuc˚ss
);

95 *
	mc⁄ãxt
;

101 
	sp°‹e
 {

102 
dm_ex˚±i⁄_°‹e
 *
	m°‹e
;

103 
	mvîsi⁄
;

104 
	mvÆid
;

105 
uöt32_t
 
	mex˚±i⁄s_≥r_¨ó
;

112 *
	m¨ó
;

117 *
	mzîo_¨ó
;

124 *
	mhódî_¨ó
;

130 
chunk_t
 
	mcuºít_¨ó
;

150 
chunk_t
 
	m√xt_‰ì
;

156 
uöt32_t
 
	mcuºít_commôãd
;

158 
©omic_t
 
	m≥ndög_cou¡
;

159 
uöt32_t
 
	mˇŒback_cou¡
;

160 
commô_ˇŒback
 *
	mˇŒbacks
;

161 
dm_io_˛õ¡
 *
	mio_˛õ¡
;

163 
w‹kqueue_°ru˘
 *
	mmëad©a_wq
;

166 
	$Æloc_¨ó
(
p°‹e
 *
ps
)

168 
r
 = -
ENOMEM
;

169 
size_t
 
Àn
;

171 
Àn
 = 
ps
->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
;

177 
ps
->
¨ó
 = 
	`vmÆloc
(
Àn
);

178 i‡(!
ps
->
¨ó
)

179 
îr_¨ó
;

181 
ps
->
zîo_¨ó
 = 
	`vzÆloc
(
Àn
);

182 i‡(!
ps
->
zîo_¨ó
)

183 
îr_zîo_¨ó
;

185 
ps
->
hódî_¨ó
 = 
	`vmÆloc
(
Àn
);

186 i‡(!
ps
->
hódî_¨ó
)

187 
îr_hódî_¨ó
;

191 
îr_hódî_¨ó
:

192 
	`v‰ì
(
ps
->
zîo_¨ó
);

194 
îr_zîo_¨ó
:

195 
	`v‰ì
(
ps
->
¨ó
);

197 
îr_¨ó
:

198  
r
;

199 
	}
}

201 
	$‰ì_¨ó
(
p°‹e
 *
ps
)

203 i‡(
ps
->
¨ó
)

204 
	`v‰ì
(
ps
->
¨ó
);

205 
ps
->
¨ó
 = 
NULL
;

207 i‡(
ps
->
zîo_¨ó
)

208 
	`v‰ì
(
ps
->
zîo_¨ó
);

209 
ps
->
zîo_¨ó
 = 
NULL
;

211 i‡(
ps
->
hódî_¨ó
)

212 
	`v‰ì
(
ps
->
hódî_¨ó
);

213 
ps
->
hódî_¨ó
 = 
NULL
;

214 
	}
}

216 
	smd©a_ªq
 {

217 
dm_io_ªgi⁄
 *
	mwhîe
;

218 
dm_io_ªque°
 *
	mio_ªq
;

219 
w‹k_°ru˘
 
	mw‹k
;

220 
	mªsu…
;

223 
	$do_mëad©a
(
w‹k_°ru˘
 *
w‹k
)

225 
md©a_ªq
 *
ªq
 = 
	`c⁄èöî_of
(
w‹k
, mdata_req, work);

227 
ªq
->
ªsu…
 = 
	`dm_io
‘eq->
io_ªq
, 1,Ñeq->
whîe
, 
NULL
);

228 
	}
}

233 
	$chunk_io
(
p°‹e
 *
ps
, *
¨ó
, 
chunk_t
 
chunk
, 
rw
,

234 
mëad©a
)

236 
dm_io_ªgi⁄
 
whîe
 = {

237 .
bdev
 = 
	`dm_¢≠_cow
(
ps
->
°‹e
->
¢≠
)->bdev,

238 .
£˘‹
 = 
ps
->
°‹e
->
chunk_size
 * 
chunk
,

239 .
cou¡
 = 
ps
->
°‹e
->
chunk_size
,

241 
dm_io_ªque°
 
io_ªq
 = {

242 .
bi_rw
 = 
rw
,

243 .
mem
.
ty≥
 = 
DM_IO_VMA
,

244 .
mem
.
±r
.
vma
 = 
¨ó
,

245 .
˛õ¡
 = 
ps
->
io_˛õ¡
,

246 .
nŸify
.
‚
 = 
NULL
,

248 
md©a_ªq
 
ªq
;

250 i‡(!
mëad©a
)

251  
	`dm_io
(&
io_ªq
, 1, &
whîe
, 
NULL
);

253 
ªq
.
whîe
 = &where;

254 
ªq
.
io_ªq
 = &io_req;

260 
	`INIT_WORK_ONSTACK
(&
ªq
.
w‹k
, 
do_mëad©a
);

261 
	`queue_w‹k
(
ps
->
mëad©a_wq
, &
ªq
.
w‹k
);

262 
	`Êush_w‹kqueue
(
ps
->
mëad©a_wq
);

263 
	`de°roy_w‹k_⁄_°ack
(&
ªq
.
w‹k
);

265  
ªq
.
ªsu…
;

266 
	}
}

271 
chunk_t
 
	$¨ó_loˇti⁄
(
p°‹e
 *
ps
, 
chunk_t
 
¨ó
)

273  
NUM_SNAPSHOT_HDR_CHUNKS
 + ((
ps
->
ex˚±i⁄s_≥r_¨ó
 + 1Ë* 
¨ó
);

274 
	}
}

276 
	$skù_mëad©a
(
p°‹e
 *
ps
)

278 
uöt32_t
 
°ride
 = 
ps
->
ex˚±i⁄s_≥r_¨ó
 + 1;

279 
chunk_t
 
√xt_‰ì
 = 
ps
->next_free;

280 i‡(
	`£˘‹_div
(
√xt_‰ì
, 
°ride
Ë=
NUM_SNAPSHOT_HDR_CHUNKS
)

281 
ps
->
√xt_‰ì
++;

282 
	}
}

288 
	$¨ó_io
(
p°‹e
 *
ps
, 
rw
)

290 
r
;

291 
chunk_t
 
chunk
;

293 
chunk
 = 
	`¨ó_loˇti⁄
(
ps
,Ös->
cuºít_¨ó
);

295 
r
 = 
	`chunk_io
(
ps
,Ös->
¨ó
, 
chunk
, 
rw
, 0);

296 i‡(
r
)

297  
r
;

300 
	}
}

302 
	$zîo_mem‹y_¨ó
(
p°‹e
 *
ps
)

304 
	`mem£t
(
ps
->
¨ó
, 0,Ös->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
);

305 
	}
}

307 
	$zîo_disk_¨ó
(
p°‹e
 *
ps
, 
chunk_t
 
¨ó
)

309  
	`chunk_io
(
ps
,Ös->
zîo_¨ó
, 
	`¨ó_loˇti⁄
’s, 
¨ó
), 
WRITE
, 0);

310 
	}
}

312 
	$ªad_hódî
(
p°‹e
 *
ps
, *
√w_¢≠shŸ
)

314 
r
;

315 
disk_hódî
 *
dh
;

316 
chunk_size
;

317 
chunk_size_suµlõd
 = 1;

318 *
chunk_îr
;

324 i‡(!
ps
->
°‹e
->
chunk_size
) {

325 
ps
->
°‹e
->
chunk_size
 = 
	`max
(
DM_CHUNK_SIZE_DEFAULT_SECTORS
,

326 
	`bdev_logiˇl_block_size
(
	`dm_¢≠_cow
(
ps
->
°‹e
->
¢≠
)->

327 
bdev
) >> 9);

328 
ps
->
°‹e
->
chunk_mask
 =Ös->°‹e->
chunk_size
 - 1;

329 
ps
->
°‹e
->
chunk_shi·
 = 
	`ffs
’s->°‹e->
chunk_size
) - 1;

330 
chunk_size_suµlõd
 = 0;

333 
ps
->
io_˛õ¡
 = 
	`dm_io_˛õ¡_¸óã
();

334 i‡(
	`IS_ERR
(
ps
->
io_˛õ¡
))

335  
	`PTR_ERR
(
ps
->
io_˛õ¡
);

337 
r
 = 
	`Æloc_¨ó
(
ps
);

338 i‡(
r
)

339  
r
;

341 
r
 = 
	`chunk_io
(
ps
,Ös->
hódî_¨ó
, 0, 
READ
, 1);

342 i‡(
r
)

343 
bad
;

345 
dh
 = 
ps
->
hódî_¨ó
;

347 i‡(
	`À32_to_˝u
(
dh
->
magic
) == 0) {

348 *
√w_¢≠shŸ
 = 1;

352 i‡(
	`À32_to_˝u
(
dh
->
magic
Ë!
SNAP_MAGIC
) {

353 
	`DMWARN
("Invalid or corrupt snapshot");

354 
r
 = -
ENXIO
;

355 
bad
;

358 *
√w_¢≠shŸ
 = 0;

359 
ps
->
vÆid
 = 
	`À32_to_˝u
(
dh
->valid);

360 
ps
->
vîsi⁄
 = 
	`À32_to_˝u
(
dh
->version);

361 
chunk_size
 = 
	`À32_to_˝u
(
dh
->chunk_size);

363 i‡(
ps
->
°‹e
->
chunk_size
 == chunk_size)

366 i‡(
chunk_size_suµlõd
)

367 
	`DMWARN
("chunk size %u in device metadata overrides "

369 
chunk_size
, 
ps
->
°‹e
->chunk_size);

372 
	`‰ì_¨ó
(
ps
);

374 
r
 = 
	`dm_ex˚±i⁄_°‹e_£t_chunk_size
(
ps
->
°‹e
, 
chunk_size
,

375 &
chunk_îr
);

376 i‡(
r
) {

377 
	`DMERR
("invalid on-disk chunk size %u: %s.",

378 
chunk_size
, 
chunk_îr
);

379  
r
;

382 
r
 = 
	`Æloc_¨ó
(
ps
);

383  
r
;

385 
bad
:

386 
	`‰ì_¨ó
(
ps
);

387  
r
;

388 
	}
}

390 
	$wrôe_hódî
(
p°‹e
 *
ps
)

392 
disk_hódî
 *
dh
;

394 
	`mem£t
(
ps
->
hódî_¨ó
, 0,Ös->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
);

396 
dh
 = 
ps
->
hódî_¨ó
;

397 
dh
->
magic
 = 
	`˝u_to_À32
(
SNAP_MAGIC
);

398 
dh
->
vÆid
 = 
	`˝u_to_À32
(
ps
->valid);

399 
dh
->
vîsi⁄
 = 
	`˝u_to_À32
(
ps
->version);

400 
dh
->
chunk_size
 = 
	`˝u_to_À32
(
ps
->
°‹e
->chunk_size);

402  
	`chunk_io
(
ps
,Ös->
hódî_¨ó
, 0, 
WRITE
, 1);

403 
	}
}

408 
disk_ex˚±i⁄
 *
	$gë_ex˚±i⁄
(
p°‹e
 *
ps
, *
ps_¨ó
,

409 
uöt32_t
 
ödex
)

411 
	`BUG_ON
(
ödex
 >
ps
->
ex˚±i⁄s_≥r_¨ó
);

413  ((
disk_ex˚±i⁄
 *Ë
ps_¨ó
Ë+ 
ödex
;

414 
	}
}

416 
	$ªad_ex˚±i⁄
(
p°‹e
 *
ps
, *
ps_¨ó
,

417 
uöt32_t
 
ödex
, 
c‹e_ex˚±i⁄
 *
ªsu…
)

419 
disk_ex˚±i⁄
 *
de
 = 
	`gë_ex˚±i⁄
(
ps
, 
ps_¨ó
, 
ödex
);

422 
ªsu…
->
ﬁd_chunk
 = 
	`À64_to_˝u
(
de
->old_chunk);

423 
ªsu…
->
√w_chunk
 = 
	`À64_to_˝u
(
de
->new_chunk);

424 
	}
}

426 
	$wrôe_ex˚±i⁄
(
p°‹e
 *
ps
,

427 
uöt32_t
 
ödex
, 
c‹e_ex˚±i⁄
 *
e
)

429 
disk_ex˚±i⁄
 *
de
 = 
	`gë_ex˚±i⁄
(
ps
,Ös->
¨ó
, 
ödex
);

432 
de
->
ﬁd_chunk
 = 
	`˝u_to_À64
(
e
->old_chunk);

433 
de
->
√w_chunk
 = 
	`˝u_to_À64
(
e
->new_chunk);

434 
	}
}

436 
	$˛ór_ex˚±i⁄
(
p°‹e
 *
ps
, 
uöt32_t
 
ödex
)

438 
disk_ex˚±i⁄
 *
de
 = 
	`gë_ex˚±i⁄
(
ps
,Ös->
¨ó
, 
ödex
);

441 
de
->
ﬁd_chunk
 = 0;

442 
de
->
√w_chunk
 = 0;

443 
	}
}

450 
ö£π_ex˚±i⁄s
(
p°‹e
 *
ps
, *
ps_¨ó
,

451 (*
ˇŒback
)(*
ˇŒback_c⁄ãxt
,

452 
chunk_t
 
ﬁd
, chunk_à
√w
),

453 *
ˇŒback_c⁄ãxt
,

454 *
fuŒ
)

456 
r
;

457 
i
;

458 
c‹e_ex˚±i⁄
 
e
;

461 *
fuŒ
 = 1;

463 
i
 = 0; i < 
ps
->
ex˚±i⁄s_≥r_¨ó
; i++) {

464 
	`ªad_ex˚±i⁄
(
ps
, 
ps_¨ó
, 
i
, &
e
);

472 i‡(
e
.
√w_chunk
 == 0LL) {

473 
ps
->
cuºít_commôãd
 = 
i
;

474 *
fuŒ
 = 0;

481 i‡(
ps
->
√xt_‰ì
 <
e
.
√w_chunk
)

482 
ps
->
√xt_‰ì
 = 
e
.
√w_chunk
 + 1;

487 
r
 = 
	`ˇŒback
(
ˇŒback_c⁄ãxt
, 
e
.
ﬁd_chunk
,É.
√w_chunk
);

488 i‡(
r
)

489  
r
;

493 
	}
}

495 
ªad_ex˚±i⁄s
(
p°‹e
 *
ps
,

496 (*
ˇŒback
)(*
ˇŒback_c⁄ãxt
, 
chunk_t
 
ﬁd
,

497 
chunk_t
 
√w
),

498 *
ˇŒback_c⁄ãxt
)

500 
r
, 
fuŒ
 = 1;

501 
dm_bufio_˛õ¡
 *
˛õ¡
;

502 
chunk_t
 
¥e„tch_¨ó
 = 0;

504 
˛õ¡
 = 
	`dm_bufio_˛õ¡_¸óã
(
	`dm_¢≠_cow
(
ps
->
°‹e
->
¢≠
)->
bdev
,

505 
ps
->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
,

506 1, 0, 
NULL
, NULL);

508 i‡(
	`IS_ERR
(
˛õ¡
))

509  
	`PTR_ERR
(
˛õ¡
);

514 
	`dm_bufio_£t_möimum_buf„rs
(
˛õ¡
, 1 + 
DM_PREFETCH_CHUNKS
);

520 
ps
->
cuºít_¨ó
 = 0; 
fuŒ
;Ös->current_area++) {

521 
dm_buf„r
 *
bp
;

522 *
¨ó
;

523 
chunk_t
 
chunk
;

525 i‡(
	`u∆ikñy
(
¥e„tch_¨ó
 < 
ps
->
cuºít_¨ó
))

526 
¥e„tch_¨ó
 = 
ps
->
cuºít_¨ó
;

528 i‡(
DM_PREFETCH_CHUNKS
) do {

529 
chunk_t
 
pf_chunk
 = 
	`¨ó_loˇti⁄
(
ps
, 
¥e„tch_¨ó
);

530 i‡(
	`u∆ikñy
(
pf_chunk
 >
	`dm_bufio_gë_devi˚_size
(
˛õ¡
)))

532 
	`dm_bufio_¥e„tch
(
˛õ¡
, 
pf_chunk
, 1);

533 
¥e„tch_¨ó
++;

534 i‡(
	`u∆ikñy
(!
¥e„tch_¨ó
))

536 } 
¥e„tch_¨ó
 <
ps
->
cuºít_¨ó
 + 
DM_PREFETCH_CHUNKS
);

538 
chunk
 = 
	`¨ó_loˇti⁄
(
ps
,Ös->
cuºít_¨ó
);

540 
¨ó
 = 
	`dm_bufio_ªad
(
˛õ¡
, 
chunk
, &
bp
);

541 i‡(
	`u∆ikñy
(
	`IS_ERR
(
¨ó
))) {

542 
r
 = 
	`PTR_ERR
(
¨ó
);

543 
ªt_de°roy_bufio
;

546 
r
 = 
	`ö£π_ex˚±i⁄s
(
ps
, 
¨ó
, 
ˇŒback
, 
ˇŒback_c⁄ãxt
,

547 &
fuŒ
);

549 i‡(!
fuŒ
)

550 
	`mem˝y
(
ps
->
¨ó
,áªa,Ös->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
);

552 
	`dm_bufio_ªÀa£
(
bp
);

554 
	`dm_bufio_f‹gë
(
˛õ¡
, 
chunk
);

556 i‡(
	`u∆ikñy
(
r
))

557 
ªt_de°roy_bufio
;

560 
ps
->
cuºít_¨ó
--;

562 
	`skù_mëad©a
(
ps
);

564 
r
 = 0;

566 
ªt_de°roy_bufio
:

567 
	`dm_bufio_˛õ¡_de°roy
(
˛õ¡
);

569  
r
;

570 
	}
}

572 
p°‹e
 *
	$gë_öfo
(
dm_ex˚±i⁄_°‹e
 *
°‹e
)

574  (
p°‹e
 *Ë
°‹e
->
c⁄ãxt
;

575 
	}
}

577 
	$≥rsi°ít_ußge
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

578 
£˘‹_t
 *
tŸÆ_£˘‹s
,

579 
£˘‹_t
 *
£˘‹s_Æloˇãd
,

580 
£˘‹_t
 *
mëad©a_£˘‹s
)

582 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

584 *
£˘‹s_Æloˇãd
 = 
ps
->
√xt_‰ì
 * 
°‹e
->
chunk_size
;

585 *
tŸÆ_£˘‹s
 = 
	`gë_dev_size
(
	`dm_¢≠_cow
(
°‹e
->
¢≠
)->
bdev
);

592 *
mëad©a_£˘‹s
 = (
ps
->
cuºít_¨ó
 + 1 + 
NUM_SNAPSHOT_HDR_CHUNKS
) *

593 
°‹e
->
chunk_size
;

594 
	}
}

596 
	$≥rsi°ít_då
(
dm_ex˚±i⁄_°‹e
 *
°‹e
)

598 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

600 
	`de°roy_w‹kqueue
(
ps
->
mëad©a_wq
);

603 i‡(
ps
->
io_˛õ¡
)

604 
	`dm_io_˛õ¡_de°roy
(
ps
->
io_˛õ¡
);

605 
	`‰ì_¨ó
(
ps
);

608 i‡(
ps
->
ˇŒbacks
)

609 
	`v‰ì
(
ps
->
ˇŒbacks
);

611 
	`k‰ì
(
ps
);

612 
	}
}

614 
≥rsi°ít_ªad_mëad©a
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

615 (*
ˇŒback
)(*
ˇŒback_c⁄ãxt
,

616 
chunk_t
 
ﬁd
, chunk_à
√w
),

617 *
ˇŒback_c⁄ãxt
)

619 
r
, 
	`unöôülized_v¨
(
√w_¢≠shŸ
);

620 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

625 
r
 = 
	`ªad_hódî
(
ps
, &
√w_¢≠shŸ
);

626 i‡(
r
)

627  
r
;

632 
ps
->
ex˚±i⁄s_≥r_¨ó
 = (ps->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
) /

633 (
disk_ex˚±i⁄
);

634 
ps
->
ˇŒbacks
 = 
	`dm_vˇŒoc
’s->
ex˚±i⁄s_≥r_¨ó
,

635 (*
ps
->
ˇŒbacks
));

636 i‡(!
ps
->
ˇŒbacks
)

637  -
ENOMEM
;

642 i‡(
√w_¢≠shŸ
) {

643 
r
 = 
	`wrôe_hódî
(
ps
);

644 i‡(
r
) {

645 
	`DMWARN
("write_header failed");

646  
r
;

649 
ps
->
cuºít_¨ó
 = 0;

650 
	`zîo_mem‹y_¨ó
(
ps
);

651 
r
 = 
	`zîo_disk_¨ó
(
ps
, 0);

652 i‡(
r
)

653 
	`DMWARN
("zero_disk_area(0) failed");

654  
r
;

659 i‡(
ps
->
vîsi⁄
 !
SNAPSHOT_DISK_VERSION
) {

660 
	`DMWARN
("unableÅo handle snapshot disk version %d",

661 
ps
->
vîsi⁄
);

662  -
EINVAL
;

668 i‡(!
ps
->
vÆid
)

674 
r
 = 
	`ªad_ex˚±i⁄s
(
ps
, 
ˇŒback
, 
ˇŒback_c⁄ãxt
);

676  
r
;

677 
	}
}

679 
	$≥rsi°ít_¥ï¨e_ex˚±i⁄
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

680 
dm_ex˚±i⁄
 *
e
)

682 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

683 
£˘‹_t
 
size
 = 
	`gë_dev_size
(
	`dm_¢≠_cow
(
°‹e
->
¢≠
)->
bdev
);

686 i‡(
size
 < ((
ps
->
√xt_‰ì
 + 1Ë* 
°‹e
->
chunk_size
))

687  -
ENOSPC
;

689 
e
->
√w_chunk
 = 
ps
->
√xt_‰ì
;

695 
ps
->
√xt_‰ì
++;

696 
	`skù_mëad©a
(
ps
);

698 
	`©omic_öc
(&
ps
->
≥ndög_cou¡
);

700 
	}
}

702 
≥rsi°ít_commô_ex˚±i⁄
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

703 
dm_ex˚±i⁄
 *
e
,

704 (*
ˇŒback
Ë(*, 
suc˚ss
),

705 *
ˇŒback_c⁄ãxt
)

707 
i
;

708 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

709 
c‹e_ex˚±i⁄
 
˚
;

710 
commô_ˇŒback
 *
cb
;

712 
˚
.
ﬁd_chunk
 = 
e
->old_chunk;

713 
˚
.
√w_chunk
 = 
e
->new_chunk;

714 
	`wrôe_ex˚±i⁄
(
ps
,Ös->
cuºít_commôãd
++, &
˚
);

722 
cb
 = 
ps
->
ˇŒbacks
 +Ös->
ˇŒback_cou¡
++;

723 
cb
->
ˇŒback
 = callback;

724 
cb
->
c⁄ãxt
 = 
ˇŒback_c⁄ãxt
;

730 i‡(!
	`©omic_dec_™d_ã°
(&
ps
->
≥ndög_cou¡
) &&

731 (
ps
->
cuºít_commôãd
 !ps->
ex˚±i⁄s_≥r_¨ó
))

737 i‡((
ps
->
cuºít_commôãd
 =ps->
ex˚±i⁄s_≥r_¨ó
) &&

738 
	`zîo_disk_¨ó
(
ps
,Ös->
cuºít_¨ó
 + 1))

739 
ps
->
vÆid
 = 0;

744 i‡(
ps
->
vÆid
 && 
	`¨ó_io
’s, 
WRITE_FLUSH_FUA
))

745 
ps
->
vÆid
 = 0;

750 i‡(
ps
->
cuºít_commôãd
 =ps->
ex˚±i⁄s_≥r_¨ó
) {

751 
ps
->
cuºít_commôãd
 = 0;

752 
ps
->
cuºít_¨ó
++;

753 
	`zîo_mem‹y_¨ó
(
ps
);

756 
i
 = 0; i < 
ps
->
ˇŒback_cou¡
; i++) {

757 
cb
 = 
ps
->
ˇŒbacks
 + 
i
;

758 
cb
->
	`ˇŒback
(cb->
c⁄ãxt
, 
ps
->
vÆid
);

761 
ps
->
ˇŒback_cou¡
 = 0;

762 
	}
}

764 
	$≥rsi°ít_¥ï¨e_mîge
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

765 
chunk_t
 *
œ°_ﬁd_chunk
,

766 
chunk_t
 *
œ°_√w_chunk
)

768 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

769 
c‹e_ex˚±i⁄
 
˚
;

770 
ƒ_c⁄£cutive
;

771 
r
;

776 i‡(!
ps
->
cuºít_commôãd
) {

780 i‡(!
ps
->
cuºít_¨ó
)

783 
ps
->
cuºít_¨ó
--;

784 
r
 = 
	`¨ó_io
(
ps
, 
READ
);

785 i‡(
r
 < 0)

786  
r
;

787 
ps
->
cuºít_commôãd
 =Ös->
ex˚±i⁄s_≥r_¨ó
;

790 
	`ªad_ex˚±i⁄
(
ps
,Ös->
¨ó
,Ös->
cuºít_commôãd
 - 1, &
˚
);

791 *
œ°_ﬁd_chunk
 = 
˚
.
ﬁd_chunk
;

792 *
œ°_√w_chunk
 = 
˚
.
√w_chunk
;

798 
ƒ_c⁄£cutive
 = 1;Çr_c⁄£cutivê< 
ps
->
cuºít_commôãd
;

799 
ƒ_c⁄£cutive
++) {

800 
	`ªad_ex˚±i⁄
(
ps
,Ös->
¨ó
,

801 
ps
->
cuºít_commôãd
 - 1 - 
ƒ_c⁄£cutive
, &
˚
);

802 i‡(
˚
.
ﬁd_chunk
 !*
œ°_ﬁd_chunk
 - 
ƒ_c⁄£cutive
 ||

803 
˚
.
√w_chunk
 !*
œ°_√w_chunk
 - 
ƒ_c⁄£cutive
)

807  
ƒ_c⁄£cutive
;

808 
	}
}

810 
	$≥rsi°ít_commô_mîge
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

811 
ƒ_mîged
)

813 
r
, 
i
;

814 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

816 
	`BUG_ON
(
ƒ_mîged
 > 
ps
->
cuºít_commôãd
);

818 
i
 = 0; i < 
ƒ_mîged
; i++)

819 
	`˛ór_ex˚±i⁄
(
ps
,Ös->
cuºít_commôãd
 - 1 - 
i
);

821 
r
 = 
	`¨ó_io
(
ps
, 
WRITE_FLUSH_FUA
);

822 i‡(
r
 < 0)

823  
r
;

825 
ps
->
cuºít_commôãd
 -
ƒ_mîged
;

837 
ps
->
√xt_‰ì
 = 
	`¨ó_loˇti⁄
’s,Ös->
cuºít_¨ó
) +

838 
ps
->
cuºít_commôãd
 + 1;

841 
	}
}

843 
	$≥rsi°ít_dr›_¢≠shŸ
(
dm_ex˚±i⁄_°‹e
 *
°‹e
)

845 
p°‹e
 *
ps
 = 
	`gë_öfo
(
°‹e
);

847 
ps
->
vÆid
 = 0;

848 i‡(
	`wrôe_hódî
(
ps
))

849 
	`DMWARN
("write header failed");

850 
	}
}

852 
	$≥rsi°ít_˘r
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

853 
¨gc
, **
¨gv
)

855 
p°‹e
 *
ps
;

858 
ps
 = 
	`kzÆloc
((*ps), 
GFP_KERNEL
);

859 i‡(!
ps
)

860  -
ENOMEM
;

862 
ps
->
°‹e
 = store;

863 
ps
->
vÆid
 = 1;

864 
ps
->
vîsi⁄
 = 
SNAPSHOT_DISK_VERSION
;

865 
ps
->
¨ó
 = 
NULL
;

866 
ps
->
zîo_¨ó
 = 
NULL
;

867 
ps
->
hódî_¨ó
 = 
NULL
;

868 
ps
->
√xt_‰ì
 = 
NUM_SNAPSHOT_HDR_CHUNKS
 + 1;

869 
ps
->
cuºít_commôãd
 = 0;

871 
ps
->
ˇŒback_cou¡
 = 0;

872 
	`©omic_£t
(&
ps
->
≥ndög_cou¡
, 0);

873 
ps
->
ˇŒbacks
 = 
NULL
;

875 
ps
->
mëad©a_wq
 = 
	`Æloc_w‹kqueue
("k¢≠hd", 
WQ_MEM_RECLAIM
, 0);

876 i‡(!
ps
->
mëad©a_wq
) {

877 
	`k‰ì
(
ps
);

878 
	`DMERR
("couldn't start header metadata updateÅhread");

879  -
ENOMEM
;

882 
°‹e
->
c⁄ãxt
 = 
ps
;

885 
	}
}

887 
	$≥rsi°ít_°©us
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

888 
°©us_ty≥_t
 
°©us
, *
ªsu…
,

889 
maxÀn
)

891 
sz
 = 0;

893 
°©us
) {

894 
STATUSTYPE_INFO
:

896 
STATUSTYPE_TABLE
:

897 
	`DMEMIT
(" P %Œu", ()
°‹e
->
chunk_size
);

900  
sz
;

901 
	}
}

903 
dm_ex˚±i⁄_°‹e_ty≥
 
	g_≥rsi°ít_ty≥
 = {

904 .
«me
 = "persistent",

905 .
	gmoduÀ
 = 
THIS_MODULE
,

906 .
	g˘r
 = 
≥rsi°ít_˘r
,

907 .
	gdå
 = 
≥rsi°ít_då
,

908 .
	gªad_mëad©a
 = 
≥rsi°ít_ªad_mëad©a
,

909 .
	g¥ï¨e_ex˚±i⁄
 = 
≥rsi°ít_¥ï¨e_ex˚±i⁄
,

910 .
	gcommô_ex˚±i⁄
 = 
≥rsi°ít_commô_ex˚±i⁄
,

911 .
	g¥ï¨e_mîge
 = 
≥rsi°ít_¥ï¨e_mîge
,

912 .
	gcommô_mîge
 = 
≥rsi°ít_commô_mîge
,

913 .
	gdr›_¢≠shŸ
 = 
≥rsi°ít_dr›_¢≠shŸ
,

914 .
	gußge
 = 
≥rsi°ít_ußge
,

915 .
	g°©us
 = 
≥rsi°ít_°©us
,

918 
dm_ex˚±i⁄_°‹e_ty≥
 
	g_≥rsi°ít_com∑t_ty≥
 = {

919 .
«me
 = "P",

920 .
	gmoduÀ
 = 
THIS_MODULE
,

921 .
	g˘r
 = 
≥rsi°ít_˘r
,

922 .
	gdå
 = 
≥rsi°ít_då
,

923 .
	gªad_mëad©a
 = 
≥rsi°ít_ªad_mëad©a
,

924 .
	g¥ï¨e_ex˚±i⁄
 = 
≥rsi°ít_¥ï¨e_ex˚±i⁄
,

925 .
	gcommô_ex˚±i⁄
 = 
≥rsi°ít_commô_ex˚±i⁄
,

926 .
	g¥ï¨e_mîge
 = 
≥rsi°ít_¥ï¨e_mîge
,

927 .
	gcommô_mîge
 = 
≥rsi°ít_commô_mîge
,

928 .
	gdr›_¢≠shŸ
 = 
≥rsi°ít_dr›_¢≠shŸ
,

929 .
	gußge
 = 
≥rsi°ít_ußge
,

930 .
	g°©us
 = 
≥rsi°ít_°©us
,

933 
	$dm_≥rsi°ít_¢≠shŸ_öô
()

935 
r
;

937 
r
 = 
	`dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(&
_≥rsi°ít_ty≥
);

938 i‡(
r
) {

939 
	`DMERR
("UnableÅoÑegisterÖersistentÉxception storeÅype");

940  
r
;

943 
r
 = 
	`dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(&
_≥rsi°ít_com∑t_ty≥
);

944 i‡(
r
) {

945 
	`DMERR
("UnableÅoÑegister old-styleÖersistentÉxception "

947 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_≥rsi°ít_ty≥
);

948  
r
;

951  
r
;

952 
	}
}

954 
	$dm_≥rsi°ít_¢≠shŸ_exô
()

956 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_≥rsi°ít_ty≥
);

957 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_≥rsi°ít_com∑t_ty≥
);

958 
	}
}

	@dm-snap-transient.c

8 
	~"dm-ex˚±i⁄-°‹e.h
"

10 
	~<löux/mm.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/vmÆloc.h
>

13 
	~<löux/exp‹t.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/dm-io.h
>

17 
	#DM_MSG_PREFIX
 "å™sõ¡ s«pshŸ"

	)

22 
	så™sõ¡_c
 {

23 
£˘‹_t
 
	m√xt_‰ì
;

26 
	$å™sõ¡_då
(
dm_ex˚±i⁄_°‹e
 *
°‹e
)

28 
	`k‰ì
(
°‹e
->
c⁄ãxt
);

29 
	}
}

31 
å™sõ¡_ªad_mëad©a
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

32 (*
ˇŒback
)(*
ˇŒback_c⁄ãxt
,

33 
chunk_t
 
ﬁd
, chunk_à
√w
),

34 *
ˇŒback_c⁄ãxt
)

37 
	}
}

39 
	$å™sõ¡_¥ï¨e_ex˚±i⁄
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

40 
dm_ex˚±i⁄
 *
e
)

42 
å™sõ¡_c
 *
tc
 = 
°‹e
->
c⁄ãxt
;

43 
£˘‹_t
 
size
 = 
	`gë_dev_size
(
	`dm_¢≠_cow
(
°‹e
->
¢≠
)->
bdev
);

45 i‡(
size
 < (
tc
->
√xt_‰ì
 + 
°‹e
->
chunk_size
))

48 
e
->
√w_chunk
 = 
	`£˘‹_to_chunk
(
°‹e
, 
tc
->
√xt_‰ì
);

49 
tc
->
√xt_‰ì
 +
°‹e
->
chunk_size
;

52 
	}
}

54 
å™sõ¡_commô_ex˚±i⁄
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

55 
dm_ex˚±i⁄
 *
e
,

56 (*
ˇŒback
Ë(*, 
suc˚ss
),

57 *
ˇŒback_c⁄ãxt
)

60 
	`ˇŒback
(
ˇŒback_c⁄ãxt
, 1);

61 
	}
}

63 
	$å™sõ¡_ußge
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

64 
£˘‹_t
 *
tŸÆ_£˘‹s
,

65 
£˘‹_t
 *
£˘‹s_Æloˇãd
,

66 
£˘‹_t
 *
mëad©a_£˘‹s
)

68 *
£˘‹s_Æloˇãd
 = ((
å™sõ¡_c
 *Ë
°‹e
->
c⁄ãxt
)->
√xt_‰ì
;

69 *
tŸÆ_£˘‹s
 = 
	`gë_dev_size
(
	`dm_¢≠_cow
(
°‹e
->
¢≠
)->
bdev
);

70 *
mëad©a_£˘‹s
 = 0;

71 
	}
}

73 
	$å™sõ¡_˘r
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

74 
¨gc
, **
¨gv
)

76 
å™sõ¡_c
 *
tc
;

78 
tc
 = 
	`kmÆloc
((
å™sõ¡_c
), 
GFP_KERNEL
);

79 i‡(!
tc
)

80  -
ENOMEM
;

82 
tc
->
√xt_‰ì
 = 0;

83 
°‹e
->
c⁄ãxt
 = 
tc
;

86 
	}
}

88 
	$å™sõ¡_°©us
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

89 
°©us_ty≥_t
 
°©us
, *
ªsu…
,

90 
maxÀn
)

92 
sz
 = 0;

94 
°©us
) {

95 
STATUSTYPE_INFO
:

97 
STATUSTYPE_TABLE
:

98 
	`DMEMIT
(" N %Œu", ()
°‹e
->
chunk_size
);

101  
sz
;

102 
	}
}

104 
dm_ex˚±i⁄_°‹e_ty≥
 
	g_å™sõ¡_ty≥
 = {

105 .
«me
 = "transient",

106 .
	gmoduÀ
 = 
THIS_MODULE
,

107 .
	g˘r
 = 
å™sõ¡_˘r
,

108 .
	gdå
 = 
å™sõ¡_då
,

109 .
	gªad_mëad©a
 = 
å™sõ¡_ªad_mëad©a
,

110 .
	g¥ï¨e_ex˚±i⁄
 = 
å™sõ¡_¥ï¨e_ex˚±i⁄
,

111 .
	gcommô_ex˚±i⁄
 = 
å™sõ¡_commô_ex˚±i⁄
,

112 .
	gußge
 = 
å™sõ¡_ußge
,

113 .
	g°©us
 = 
å™sõ¡_°©us
,

116 
dm_ex˚±i⁄_°‹e_ty≥
 
	g_å™sõ¡_com∑t_ty≥
 = {

117 .
«me
 = "N",

118 .
	gmoduÀ
 = 
THIS_MODULE
,

119 .
	g˘r
 = 
å™sõ¡_˘r
,

120 .
	gdå
 = 
å™sõ¡_då
,

121 .
	gªad_mëad©a
 = 
å™sõ¡_ªad_mëad©a
,

122 .
	g¥ï¨e_ex˚±i⁄
 = 
å™sõ¡_¥ï¨e_ex˚±i⁄
,

123 .
	gcommô_ex˚±i⁄
 = 
å™sõ¡_commô_ex˚±i⁄
,

124 .
	gußge
 = 
å™sõ¡_ußge
,

125 .
	g°©us
 = 
å™sõ¡_°©us
,

128 
	$dm_å™sõ¡_¢≠shŸ_öô
()

130 
r
;

132 
r
 = 
	`dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(&
_å™sõ¡_ty≥
);

133 i‡(
r
) {

134 
	`DMWARN
("UnableÅoÑegisterÅransientÉxception storeÅype");

135  
r
;

138 
r
 = 
	`dm_ex˚±i⁄_°‹e_ty≥_ªgi°î
(&
_å™sõ¡_com∑t_ty≥
);

139 i‡(
r
) {

140 
	`DMWARN
("UnableÅoÑegister old-styleÅransient "

142 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_å™sõ¡_ty≥
);

143  
r
;

146  
r
;

147 
	}
}

149 
	$dm_å™sõ¡_¢≠shŸ_exô
()

151 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_å™sõ¡_ty≥
);

152 
	`dm_ex˚±i⁄_°‹e_ty≥_uƒegi°î
(&
_å™sõ¡_com∑t_ty≥
);

153 
	}
}

	@dm-snap.c

9 
	~<löux/blkdev.h
>

10 
	~<löux/devi˚-m≠≥r.h
>

11 
	~<löux/dñay.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/kdev_t.h
>

15 
	~<löux/li°.h
>

16 
	~<löux/mempoﬁ.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/vmÆloc.h
>

20 
	~<löux/log2.h
>

21 
	~<löux/dm-kc›yd.h
>

23 
	~"dm-ex˚±i⁄-°‹e.h
"

25 
	#DM_MSG_PREFIX
 "¢≠shŸs"

	)

27 c⁄° 
	gdm_¢≠shŸ_mîge_èrgë_«me
[] = "snapshot-merge";

29 
	#dm_èrgë_is_¢≠shŸ_mîge
(
ti
) \

30 ((
ti
)->
ty≥
->
«me
 =
dm_¢≠shŸ_mîge_èrgë_«me
)

	)

35 
	#MIN_IOS
 256

	)

37 
	#DM_TRACKED_CHUNK_HASH_SIZE
 16

	)

38 
	#DM_TRACKED_CHUNK_HASH
(
x
) (()(x) & \

39 (
DM_TRACKED_CHUNK_HASH_SIZE
 - 1))

	)

41 
	sdm_ex˚±i⁄_èbÀ
 {

42 
uöt32_t
 
	mhash_mask
;

43 
	mhash_shi·
;

44 
li°_hód
 *
	mèbÀ
;

47 
	sdm_¢≠shŸ
 {

48 
rw_£m≠h‹e
 
	mlock
;

50 
dm_dev
 *
	m‹igö
;

51 
dm_dev
 *
	mcow
;

53 
dm_èrgë
 *
	mti
;

56 
li°_hód
 
	mli°
;

62 
	mvÆid
;

65 
	ma˘ive
;

67 
©omic_t
 
	m≥ndög_ex˚±i⁄s_cou¡
;

70 
£˘‹_t
 
	mex˚±i⁄_°¨t_£quí˚
;

73 
£˘‹_t
 
	mex˚±i⁄_com∂ëe_£quí˚
;

79 
li°_hód
 
	mout_of_‹dî_li°
;

81 
mempoﬁ_t
 *
	m≥ndög_poﬁ
;

83 
dm_ex˚±i⁄_èbÀ
 
	m≥ndög
;

84 
dm_ex˚±i⁄_èbÀ
 
	mcom∂ëe
;

90 
•ölock_t
 
	m≥_lock
;

93 
•ölock_t
 
	måacked_chunk_lock
;

94 
hli°_hód
 
	måacked_chunk_hash
[
DM_TRACKED_CHUNK_HASH_SIZE
];

97 
dm_ex˚±i⁄_°‹e
 *
	m°‹e
;

99 
dm_kc›yd_˛õ¡
 *
	mkc›yd_˛õ¡
;

102 
	m°©e_bôs
;

105 
chunk_t
 
	mfú°_mîgög_chunk
;

106 
	mnum_mîgög_chunks
;

121 
	mmîge_Áûed
;

127 
bio_li°
 
	mbios_queued_durög_mîge
;

136 
	#RUNNING_MERGE
 0

	)

137 
	#SHUTDOWN_MERGE
 1

	)

139 
DECLARE_DM_KCOPYD_THROTTLE_WITH_MODULE_PARM
(
¢≠shŸ_c›y_thrŸée
,

142 
dm_dev
 *
	$dm_¢≠_‹igö
(
dm_¢≠shŸ
 *
s
)

144  
s
->
‹igö
;

145 
	}
}

146 
EXPORT_SYMBOL
(
dm_¢≠_‹igö
);

148 
dm_dev
 *
	$dm_¢≠_cow
(
dm_¢≠shŸ
 *
s
)

150  
s
->
cow
;

151 
	}
}

152 
EXPORT_SYMBOL
(
dm_¢≠_cow
);

154 
£˘‹_t
 
	$chunk_to_£˘‹
(
dm_ex˚±i⁄_°‹e
 *
°‹e
,

155 
chunk_t
 
chunk
)

157  
chunk
 << 
°‹e
->
chunk_shi·
;

158 
	}
}

160 
	$bdev_equÆ
(
block_devi˚
 *
lhs
, block_devi˚ *
rhs
)

166  
lhs
 =
rhs
;

167 
	}
}

169 
	sdm_¢≠_≥ndög_ex˚±i⁄
 {

170 
dm_ex˚±i⁄
 
	me
;

176 
bio_li°
 
	m‹igö_bios
;

177 
bio_li°
 
	m¢≠shŸ_bios
;

180 
dm_¢≠shŸ
 *
	m¢≠
;

186 
	m°¨ãd
;

189 
	mc›y_îr‹
;

192 
£˘‹_t
 
	mex˚±i⁄_£quí˚
;

194 
li°_hód
 
	mout_of_‹dî_íåy
;

199 
bio
 *
	mfuŒ_bio
;

200 
bio_íd_io_t
 *
	mfuŒ_bio_íd_io
;

201 *
	mfuŒ_bio_¥iv©e
;

208 
kmem_ˇche
 *
	gex˚±i⁄_ˇche
;

209 
kmem_ˇche
 *
	g≥ndög_ˇche
;

211 
	sdm_¢≠_åacked_chunk
 {

212 
hli°_node
 
	mnode
;

213 
chunk_t
 
	mchunk
;

216 
	$öô_åacked_chunk
(
bio
 *bio)

218 
dm_¢≠_åacked_chunk
 *
c
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_snap_tracked_chunk));

219 
	`INIT_HLIST_NODE
(&
c
->
node
);

220 
	}
}

222 
boﬁ
 
	$is_bio_åacked
(
bio
 *bio)

224 
dm_¢≠_åacked_chunk
 *
c
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_snap_tracked_chunk));

225  !
	`hli°_unhashed
(&
c
->
node
);

226 
	}
}

228 
	$åack_chunk
(
dm_¢≠shŸ
 *
s
, 
bio
 *bio, 
chunk_t
 
chunk
)

230 
dm_¢≠_åacked_chunk
 *
c
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_snap_tracked_chunk));

232 
c
->
chunk
 = chunk;

234 
	`•ö_lock_úq
(&
s
->
åacked_chunk_lock
);

235 
	`hli°_add_hód
(&
c
->
node
,

236 &
s
->
åacked_chunk_hash
[
	`DM_TRACKED_CHUNK_HASH
(
chunk
)]);

237 
	`•ö_u∆ock_úq
(&
s
->
åacked_chunk_lock
);

238 
	}
}

240 
	$°›_åackög_chunk
(
dm_¢≠shŸ
 *
s
, 
bio
 *bio)

242 
dm_¢≠_åacked_chunk
 *
c
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_snap_tracked_chunk));

243 
Êags
;

245 
	`•ö_lock_úqßve
(&
s
->
åacked_chunk_lock
, 
Êags
);

246 
	`hli°_dñ
(&
c
->
node
);

247 
	`•ö_u∆ock_úqª°‹e
(&
s
->
åacked_chunk_lock
, 
Êags
);

248 
	}
}

250 
	$__chunk_is_åacked
(
dm_¢≠shŸ
 *
s
, 
chunk_t
 
chunk
)

252 
dm_¢≠_åacked_chunk
 *
c
;

253 
found
 = 0;

255 
	`•ö_lock_úq
(&
s
->
åacked_chunk_lock
);

257 
	`hli°_f‹_óch_íåy
(
c
,

258 &
s
->
åacked_chunk_hash
[
	`DM_TRACKED_CHUNK_HASH
(
chunk
)], 
node
) {

259 i‡(
c
->
chunk
 == chunk) {

260 
found
 = 1;

265 
	`•ö_u∆ock_úq
(&
s
->
åacked_chunk_lock
);

267  
found
;

268 
	}
}

274 
	$__check_f‹_c⁄Êi˘ög_io
(
dm_¢≠shŸ
 *
s
, 
chunk_t
 
chunk
)

276 
	`__chunk_is_åacked
(
s
, 
chunk
))

277 
	`m¶ìp
(1);

278 
	}
}

283 
	s‹igö
 {

285 
block_devi˚
 *
	mbdev
;

287 
li°_hód
 
	mhash_li°
;

290 
li°_hód
 
	m¢≠shŸs
;

297 
	#ORIGIN_HASH_SIZE
 256

	)

298 
	#ORIGIN_MASK
 0xFF

	)

299 
li°_hód
 *
	g_‹igös
;

300 
rw_£m≠h‹e
 
	g_‹igös_lock
;

302 
DECLARE_WAIT_QUEUE_HEAD
(
_≥ndög_ex˚±i⁄s_d⁄e
);

303 
DEFINE_SPINLOCK
(
_≥ndög_ex˚±i⁄s_d⁄e_•ölock
);

304 
uöt64_t
 
	g_≥ndög_ex˚±i⁄s_d⁄e_cou¡
;

306 
	$öô_‹igö_hash
()

308 
i
;

310 
_‹igös
 = 
	`kmÆloc
(
ORIGIN_HASH_SIZE
 * (
li°_hód
),

311 
GFP_KERNEL
);

312 i‡(!
_‹igös
) {

313 
	`DMERR
("unableÅoállocate memory");

314  -
ENOMEM
;

317 
i
 = 0; i < 
ORIGIN_HASH_SIZE
; i++)

318 
	`INIT_LIST_HEAD
(
_‹igös
 + 
i
);

319 
	`öô_rw£m
(&
_‹igös_lock
);

322 
	}
}

324 
	$exô_‹igö_hash
()

326 
	`k‰ì
(
_‹igös
);

327 
	}
}

329 
	$‹igö_hash
(
block_devi˚
 *
bdev
)

331  
bdev
->
bd_dev
 & 
ORIGIN_MASK
;

332 
	}
}

334 
‹igö
 *
	$__lookup_‹igö
(
block_devi˚
 *
‹igö
)

336 
li°_hód
 *
ﬁ
;

337 
‹igö
 *
o
;

339 
ﬁ
 = &
_‹igös
[
	`‹igö_hash
(
‹igö
)];

340 
	`li°_f‹_óch_íåy
 (
o
, 
ﬁ
, 
hash_li°
)

341 i‡(
	`bdev_equÆ
(
o
->
bdev
, 
‹igö
))

342  
o
;

344  
NULL
;

345 
	}
}

347 
	$__ö£π_‹igö
(
‹igö
 *
o
)

349 
li°_hód
 *
¶
 = &
_‹igös
[
	`‹igö_hash
(
o
->
bdev
)];

350 
	`li°_add_èû
(&
o
->
hash_li°
, 
¶
);

351 
	}
}

368 
	$__föd_¢≠shŸs_sh¨ög_cow
(
dm_¢≠shŸ
 *
¢≠
,

369 
dm_¢≠shŸ
 **
¢≠_§c
,

370 
dm_¢≠shŸ
 **
¢≠_de°
,

371 
dm_¢≠shŸ
 **
¢≠_mîge
)

373 
dm_¢≠shŸ
 *
s
;

374 
‹igö
 *
o
;

375 
cou¡
 = 0;

376 
a˘ive
;

378 
o
 = 
	`__lookup_‹igö
(
¢≠
->
‹igö
->
bdev
);

379 i‡(!
o
)

380 
out
;

382 
	`li°_f‹_óch_íåy
(
s
, &
o
->
¢≠shŸs
, 
li°
) {

383 i‡(
	`dm_èrgë_is_¢≠shŸ_mîge
(
s
->
ti
Ë&& 
¢≠_mîge
)

384 *
¢≠_mîge
 = 
s
;

385 i‡(!
	`bdev_equÆ
(
s
->
cow
->
bdev
, 
¢≠
->cow->bdev))

388 
	`down_ªad
(&
s
->
lock
);

389 
a˘ive
 = 
s
->active;

390 
	`up_ªad
(&
s
->
lock
);

392 i‡(
a˘ive
) {

393 i‡(
¢≠_§c
)

394 *
¢≠_§c
 = 
s
;

395 } i‡(
¢≠_de°
)

396 *
¢≠_de°
 = 
s
;

398 
cou¡
++;

401 
out
:

402  
cou¡
;

403 
	}
}

409 
	$__vÆid©e_ex˚±i⁄_h™dovî
(
dm_¢≠shŸ
 *
¢≠
)

411 
dm_¢≠shŸ
 *
¢≠_§c
 = 
NULL
, *
¢≠_de°
 = NULL;

412 
dm_¢≠shŸ
 *
¢≠_mîge
 = 
NULL
;

415 i‡((
	`__föd_¢≠shŸs_sh¨ög_cow
(
¢≠
, &
¢≠_§c
, &
¢≠_de°
,

416 &
¢≠_mîge
) == 2) ||

417 
¢≠_de°
) {

418 
¢≠
->
ti
->
îr‹
 = "Snapshot cowÖairing forÉxception "

420  -
EINVAL
;

427 i‡(!
¢≠_§c
)

433 i‡(!
	`dm_èrgë_is_¢≠shŸ_mîge
(
¢≠
->
ti
))

439 i‡(
¢≠_mîge
) {

440 
¢≠
->
ti
->
îr‹
 = "A snapshot isálready merging.";

441  -
EINVAL
;

444 i‡(!
¢≠_§c
->
°‹e
->
ty≥
->
¥ï¨e_mîge
 ||

445 !
¢≠_§c
->
°‹e
->
ty≥
->
commô_mîge
) {

446 
¢≠
->
ti
->
îr‹
 = "SnapshotÉxception store doesÇot "

448  -
EINVAL
;

452 
	}
}

454 
	$__ö£π_¢≠shŸ
(
‹igö
 *
o
, 
dm_¢≠shŸ
 *
s
)

456 
dm_¢≠shŸ
 *
l
;

459 
	`li°_f‹_óch_íåy
(
l
, &
o
->
¢≠shŸs
, 
li°
)

460 i‡(
l
->
°‹e
->
chunk_size
 < 
s
->store->chunk_size)

462 
	`li°_add_èû
(&
s
->
li°
, &
l
->list);

463 
	}
}

473 
	$ªgi°î_¢≠shŸ
(
dm_¢≠shŸ
 *
¢≠
)

475 
‹igö
 *
o
, *
√w_o
 = 
NULL
;

476 
block_devi˚
 *
bdev
 = 
¢≠
->
‹igö
->bdev;

477 
r
 = 0;

479 
√w_o
 = 
	`kmÆloc
((*√w_o), 
GFP_KERNEL
);

480 i‡(!
√w_o
)

481  -
ENOMEM
;

483 
	`down_wrôe
(&
_‹igös_lock
);

485 
r
 = 
	`__vÆid©e_ex˚±i⁄_h™dovî
(
¢≠
);

486 i‡(
r
 < 0) {

487 
	`k‰ì
(
√w_o
);

488 
out
;

491 
o
 = 
	`__lookup_‹igö
(
bdev
);

492 i‡(
o
)

493 
	`k‰ì
(
√w_o
);

496 
o
 = 
√w_o
;

499 
	`INIT_LIST_HEAD
(&
o
->
¢≠shŸs
);

500 
o
->
bdev
 = bdev;

502 
	`__ö£π_‹igö
(
o
);

505 
	`__ö£π_¢≠shŸ
(
o
, 
¢≠
);

507 
out
:

508 
	`up_wrôe
(&
_‹igös_lock
);

510  
r
;

511 
	}
}

516 
	$ªªgi°î_¢≠shŸ
(
dm_¢≠shŸ
 *
s
)

518 
block_devi˚
 *
bdev
 = 
s
->
‹igö
->bdev;

520 
	`down_wrôe
(&
_‹igös_lock
);

522 
	`li°_dñ
(&
s
->
li°
);

523 
	`__ö£π_¢≠shŸ
(
	`__lookup_‹igö
(
bdev
), 
s
);

525 
	`up_wrôe
(&
_‹igös_lock
);

526 
	}
}

528 
	$uƒegi°î_¢≠shŸ
(
dm_¢≠shŸ
 *
s
)

530 
‹igö
 *
o
;

532 
	`down_wrôe
(&
_‹igös_lock
);

533 
o
 = 
	`__lookup_‹igö
(
s
->
‹igö
->
bdev
);

535 
	`li°_dñ
(&
s
->
li°
);

536 i‡(
o
 && 
	`li°_em±y
(&o->
¢≠shŸs
)) {

537 
	`li°_dñ
(&
o
->
hash_li°
);

538 
	`k‰ì
(
o
);

541 
	`up_wrôe
(&
_‹igös_lock
);

542 
	}
}

549 
	$dm_ex˚±i⁄_èbÀ_öô
(
dm_ex˚±i⁄_èbÀ
 *
ë
,

550 
uöt32_t
 
size
, 
hash_shi·
)

552 
i
;

554 
ë
->
hash_shi·
 = hash_shift;

555 
ë
->
hash_mask
 = 
size
 - 1;

556 
ë
->
èbÀ
 = 
	`dm_vˇŒoc
(
size
, (
li°_hód
));

557 i‡(!
ë
->
èbÀ
)

558  -
ENOMEM
;

560 
i
 = 0; i < 
size
; i++)

561 
	`INIT_LIST_HEAD
(
ë
->
èbÀ
 + 
i
);

564 
	}
}

566 
	$dm_ex˚±i⁄_èbÀ_exô
(
dm_ex˚±i⁄_èbÀ
 *
ë
,

567 
kmem_ˇche
 *
mem
)

569 
li°_hód
 *
¶Ÿ
;

570 
dm_ex˚±i⁄
 *
ex
, *
√xt
;

571 
i
, 
size
;

573 
size
 = 
ë
->
hash_mask
 + 1;

574 
i
 = 0; i < 
size
; i++) {

575 
¶Ÿ
 = 
ë
->
èbÀ
 + 
i
;

577 
	`li°_f‹_óch_íåy_ß„
 (
ex
, 
√xt
, 
¶Ÿ
, 
hash_li°
)

578 
	`kmem_ˇche_‰ì
(
mem
, 
ex
);

581 
	`v‰ì
(
ë
->
èbÀ
);

582 
	}
}

584 
uöt32_t
 
	$ex˚±i⁄_hash
(
dm_ex˚±i⁄_èbÀ
 *
ë
, 
chunk_t
 
chunk
)

586  (
chunk
 >> 
ë
->
hash_shi·
Ë&Ét->
hash_mask
;

587 
	}
}

589 
	$dm_ªmove_ex˚±i⁄
(
dm_ex˚±i⁄
 *
e
)

591 
	`li°_dñ
(&
e
->
hash_li°
);

592 
	}
}

598 
dm_ex˚±i⁄
 *
	$dm_lookup_ex˚±i⁄
(
dm_ex˚±i⁄_èbÀ
 *
ë
,

599 
chunk_t
 
chunk
)

601 
li°_hód
 *
¶Ÿ
;

602 
dm_ex˚±i⁄
 *
e
;

604 
¶Ÿ
 = &
ë
->
èbÀ
[
	`ex˚±i⁄_hash
”t, 
chunk
)];

605 
	`li°_f‹_óch_íåy
 (
e
, 
¶Ÿ
, 
hash_li°
)

606 i‡(
chunk
 >
e
->
ﬁd_chunk
 &&

607 
chunk
 <
e
->
ﬁd_chunk
 + 
	`dm_c⁄£cutive_chunk_cou¡
(e))

608  
e
;

610  
NULL
;

611 
	}
}

613 
dm_ex˚±i⁄
 *
	$Æloc_com∂ëed_ex˚±i⁄
(
gÂ_t
 
gÂ
)

615 
dm_ex˚±i⁄
 *
e
;

617 
e
 = 
	`kmem_ˇche_Æloc
(
ex˚±i⁄_ˇche
, 
gÂ
);

618 i‡(!
e
 && 
gÂ
 =
GFP_NOIO
)

619 
e
 = 
	`kmem_ˇche_Æloc
(
ex˚±i⁄_ˇche
, 
GFP_ATOMIC
);

621  
e
;

622 
	}
}

624 
	$‰ì_com∂ëed_ex˚±i⁄
(
dm_ex˚±i⁄
 *
e
)

626 
	`kmem_ˇche_‰ì
(
ex˚±i⁄_ˇche
, 
e
);

627 
	}
}

629 
dm_¢≠_≥ndög_ex˚±i⁄
 *
	$Æloc_≥ndög_ex˚±i⁄
(
dm_¢≠shŸ
 *
s
)

631 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
 = 
	`mempoﬁ_Æloc
(
s
->
≥ndög_poﬁ
,

632 
GFP_NOIO
);

634 
	`©omic_öc
(&
s
->
≥ndög_ex˚±i⁄s_cou¡
);

635 
≥
->
¢≠
 = 
s
;

637  
≥
;

638 
	}
}

640 
	$‰ì_≥ndög_ex˚±i⁄
(
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
)

642 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

644 
	`mempoﬁ_‰ì
(
≥
, 
s
->
≥ndög_poﬁ
);

645 
	`smp_mb__bef‹e_©omic
();

646 
	`©omic_dec
(&
s
->
≥ndög_ex˚±i⁄s_cou¡
);

647 
	}
}

649 
	$dm_ö£π_ex˚±i⁄
(
dm_ex˚±i⁄_èbÀ
 *
eh
,

650 
dm_ex˚±i⁄
 *
√w_e
)

652 
li°_hód
 *
l
;

653 
dm_ex˚±i⁄
 *
e
 = 
NULL
;

655 
l
 = &
eh
->
èbÀ
[
	`ex˚±i⁄_hash
”h, 
√w_e
->
ﬁd_chunk
)];

658 i‡(!
eh
->
hash_shi·
)

659 
out
;

662 
	`li°_f‹_óch_íåy_ªvî£
(
e
, 
l
, 
hash_li°
) {

664 i‡(
√w_e
->
ﬁd_chunk
 =(
e
->old_chunk +

665 
	`dm_c⁄£cutive_chunk_cou¡
(
e
) + 1) &&

666 
√w_e
->
√w_chunk
 =(
	`dm_chunk_numbî
(
e
->new_chunk) +

667 
	`dm_c⁄£cutive_chunk_cou¡
(
e
) + 1)) {

668 
	`dm_c⁄£cutive_chunk_cou¡_öc
(
e
);

669 
	`‰ì_com∂ëed_ex˚±i⁄
(
√w_e
);

674 i‡(
√w_e
->
ﬁd_chunk
 =(
e
->old_chunk - 1) &&

675 
√w_e
->
√w_chunk
 =(
	`dm_chunk_numbî
(
e
->new_chunk) - 1)) {

676 
	`dm_c⁄£cutive_chunk_cou¡_öc
(
e
);

677 
e
->
ﬁd_chunk
--;

678 
e
->
√w_chunk
--;

679 
	`‰ì_com∂ëed_ex˚±i⁄
(
√w_e
);

683 i‡(
√w_e
->
ﬁd_chunk
 > 
e
->old_chunk)

687 
out
:

688 
	`li°_add
(&
√w_e
->
hash_li°
, 
e
 ? &e->hash_li° : 
l
);

689 
	}
}

695 
	$dm_add_ex˚±i⁄
(*
c⁄ãxt
, 
chunk_t
 
ﬁd
, chunk_à
√w
)

697 
dm_¢≠shŸ
 *
s
 = 
c⁄ãxt
;

698 
dm_ex˚±i⁄
 *
e
;

700 
e
 = 
	`Æloc_com∂ëed_ex˚±i⁄
(
GFP_KERNEL
);

701 i‡(!
e
)

702  -
ENOMEM
;

704 
e
->
ﬁd_chunk
 = 
ﬁd
;

707 
e
->
√w_chunk
 = 
√w
;

709 
	`dm_ö£π_ex˚±i⁄
(&
s
->
com∂ëe
, 
e
);

712 
	}
}

718 
uöt32_t
 
	$__möimum_chunk_size
(
‹igö
 *
o
)

720 
dm_¢≠shŸ
 *
¢≠
;

721 
chunk_size
 = 0;

723 i‡(
o
)

724 
	`li°_f‹_óch_íåy
(
¢≠
, &
o
->
¢≠shŸs
, 
li°
)

725 
chunk_size
 = 
	`mö_nŸ_zîo
(chunk_size,

726 
¢≠
->
°‹e
->
chunk_size
);

728  (
uöt32_t
Ë
chunk_size
;

729 
	}
}

734 
	$ˇlc_max_buckës
()

737 
mem
 = 2 * 1024 * 1024;

738 
mem
 /(
li°_hód
);

740  
mem
;

741 
	}
}

746 
	$öô_hash_èbÀs
(
dm_¢≠shŸ
 *
s
)

748 
£˘‹_t
 
hash_size
, 
cow_dev_size
, 
max_buckës
;

754 
cow_dev_size
 = 
	`gë_dev_size
(
s
->
cow
->
bdev
);

755 
max_buckës
 = 
	`ˇlc_max_buckës
();

757 
hash_size
 = 
cow_dev_size
 >> 
s
->
°‹e
->
chunk_shi·
;

758 
hash_size
 = 
	`mö
(hash_size, 
max_buckës
);

760 i‡(
hash_size
 < 64)

761 
hash_size
 = 64;

762 
hash_size
 = 
	`rounddown_pow_of_two
(hash_size);

763 i‡(
	`dm_ex˚±i⁄_èbÀ_öô
(&
s
->
com∂ëe
, 
hash_size
,

764 
DM_CHUNK_CONSECUTIVE_BITS
))

765  -
ENOMEM
;

771 
hash_size
 >>= 3;

772 i‡(
hash_size
 < 64)

773 
hash_size
 = 64;

775 i‡(
	`dm_ex˚±i⁄_èbÀ_öô
(&
s
->
≥ndög
, 
hash_size
, 0)) {

776 
	`dm_ex˚±i⁄_èbÀ_exô
(&
s
->
com∂ëe
, 
ex˚±i⁄_ˇche
);

777  -
ENOMEM
;

781 
	}
}

783 
	$mîge_shutdown
(
dm_¢≠shŸ
 *
s
)

785 
	`˛ór_bô_u∆ock
(
RUNNING_MERGE
, &
s
->
°©e_bôs
);

786 
	`smp_mb__a·î_©omic
();

787 
	`wake_up_bô
(&
s
->
°©e_bôs
, 
RUNNING_MERGE
);

788 
	}
}

790 
bio
 *
	$__ªÀa£_queued_bios_a·î_mîge
(
dm_¢≠shŸ
 *
s
)

792 
s
->
fú°_mîgög_chunk
 = 0;

793 
s
->
num_mîgög_chunks
 = 0;

795  
	`bio_li°_gë
(&
s
->
bios_queued_durög_mîge
);

796 
	}
}

801 
	$__ªmove_sögÀ_ex˚±i⁄_chunk
(
dm_¢≠shŸ
 *
s
,

802 
chunk_t
 
ﬁd_chunk
)

804 
dm_ex˚±i⁄
 *
e
;

806 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
s
->
com∂ëe
, 
ﬁd_chunk
);

807 i‡(!
e
) {

808 
	`DMERR
("Corruption detected:Éxception for block %llu is "

810 ()
ﬁd_chunk
);

811  -
EINVAL
;

817 i‡(!
	`dm_c⁄£cutive_chunk_cou¡
(
e
)) {

818 
	`dm_ªmove_ex˚±i⁄
(
e
);

819 
	`‰ì_com∂ëed_ex˚±i⁄
(
e
);

831 i‡(
ﬁd_chunk
 =
e
->old_chunk) {

832 
e
->
ﬁd_chunk
++;

833 
e
->
√w_chunk
++;

834 } i‡(
ﬁd_chunk
 !
e
->old_chunk +

835 
	`dm_c⁄£cutive_chunk_cou¡
(
e
)) {

836 
	`DMERR
("AttemptÅo merge block %llu fromÅhe "

838 ()
ﬁd_chunk
,

839 ()
e
->
ﬁd_chunk
,

841 
e
->
ﬁd_chunk
 + 
	`dm_c⁄£cutive_chunk_cou¡
(e));

842  -
EINVAL
;

845 
	`dm_c⁄£cutive_chunk_cou¡_dec
(
e
);

848 
	}
}

850 
Êush_bios
(
bio
 *bio);

852 
	$ªmove_sögÀ_ex˚±i⁄_chunk
(
dm_¢≠shŸ
 *
s
)

854 
bio
 *
b
 = 
NULL
;

855 
r
;

856 
chunk_t
 
ﬁd_chunk
 = 
s
->
fú°_mîgög_chunk
 + s->
num_mîgög_chunks
 - 1;

858 
	`down_wrôe
(&
s
->
lock
);

865 
r
 = 
	`__ªmove_sögÀ_ex˚±i⁄_chunk
(
s
, 
ﬁd_chunk
);

866 i‡(
r
)

867 
out
;

868 } 
ﬁd_chunk
-- > 
s
->
fú°_mîgög_chunk
);

870 
b
 = 
	`__ªÀa£_queued_bios_a·î_mîge
(
s
);

872 
out
:

873 
	`up_wrôe
(&
s
->
lock
);

874 i‡(
b
)

875 
	`Êush_bios
(
b
);

877  
r
;

878 
	}
}

880 
‹igö_wrôe_exã¡
(
dm_¢≠shŸ
 *
mîgög_¢≠
,

881 
£˘‹_t
 
£˘‹
, 
chunk_size
);

883 
mîge_ˇŒback
(
ªad_îr
, 
wrôe_îr
,

884 *
c⁄ãxt
);

886 
uöt64_t
 
	$ªad_≥ndög_ex˚±i⁄s_d⁄e_cou¡
()

888 
uöt64_t
 
≥ndög_ex˚±i⁄s_d⁄e
;

890 
	`•ö_lock
(&
_≥ndög_ex˚±i⁄s_d⁄e_•ölock
);

891 
≥ndög_ex˚±i⁄s_d⁄e
 = 
_≥ndög_ex˚±i⁄s_d⁄e_cou¡
;

892 
	`•ö_u∆ock
(&
_≥ndög_ex˚±i⁄s_d⁄e_•ölock
);

894  
≥ndög_ex˚±i⁄s_d⁄e
;

895 
	}
}

897 
	$ö¸emít_≥ndög_ex˚±i⁄s_d⁄e_cou¡
()

899 
	`•ö_lock
(&
_≥ndög_ex˚±i⁄s_d⁄e_•ölock
);

900 
_≥ndög_ex˚±i⁄s_d⁄e_cou¡
++;

901 
	`•ö_u∆ock
(&
_≥ndög_ex˚±i⁄s_d⁄e_•ölock
);

903 
	`wake_up_Æl
(&
_≥ndög_ex˚±i⁄s_d⁄e
);

904 
	}
}

906 
	$¢≠shŸ_mîge_√xt_chunks
(
dm_¢≠shŸ
 *
s
)

908 
i
, 
löór_chunks
;

909 
chunk_t
 
ﬁd_chunk
, 
√w_chunk
;

910 
dm_io_ªgi⁄
 
§c
, 
de°
;

911 
£˘‹_t
 
io_size
;

912 
uöt64_t
 
¥evious_cou¡
;

914 
	`BUG_ON
(!
	`ã°_bô
(
RUNNING_MERGE
, &
s
->
°©e_bôs
));

915 i‡(
	`u∆ikñy
(
	`ã°_bô
(
SHUTDOWN_MERGE
, &
s
->
°©e_bôs
)))

916 
shut
;

921 i‡(!
s
->
vÆid
) {

922 
	`DMERR
("Snapshot is invalid: can't merge");

923 
shut
;

926 
löór_chunks
 = 
s
->
°‹e
->
ty≥
->
	`¥ï¨e_mîge
(s->°‹e, &
ﬁd_chunk
,

927 &
√w_chunk
);

928 i‡(
löór_chunks
 <= 0) {

929 i‡(
löór_chunks
 < 0) {

930 
	`DMERR
("ReadÉrror inÉxception store: "

932 
	`down_wrôe
(&
s
->
lock
);

933 
s
->
mîge_Áûed
 = 1;

934 
	`up_wrôe
(&
s
->
lock
);

936 
shut
;

940 
ﬁd_chunk
 = old_chunk + 1 - 
löór_chunks
;

941 
√w_chunk
 =Çew_chunk + 1 - 
löór_chunks
;

947 
io_size
 = 
löór_chunks
 * 
s
->
°‹e
->
chunk_size
;

949 
de°
.
bdev
 = 
s
->
‹igö
->bdev;

950 
de°
.
£˘‹
 = 
	`chunk_to_£˘‹
(
s
->
°‹e
, 
ﬁd_chunk
);

951 
de°
.
cou¡
 = 
	`mö
(
io_size
, 
	`gë_dev_size
(de°.
bdev
Ë- de°.
£˘‹
);

953 
§c
.
bdev
 = 
s
->
cow
->bdev;

954 
§c
.
£˘‹
 = 
	`chunk_to_£˘‹
(
s
->
°‹e
, 
√w_chunk
);

955 
§c
.
cou¡
 = 
de°
.count;

966 
¥evious_cou¡
 = 
	`ªad_≥ndög_ex˚±i⁄s_d⁄e_cou¡
();

967 
	`‹igö_wrôe_exã¡
(
s
, 
de°
.
£˘‹
, 
io_size
)) {

968 
	`waô_evít
(
_≥ndög_ex˚±i⁄s_d⁄e
,

969 (
	`ªad_≥ndög_ex˚±i⁄s_d⁄e_cou¡
() !=

970 
¥evious_cou¡
));

972 
¥evious_cou¡
 = 
	`ªad_≥ndög_ex˚±i⁄s_d⁄e_cou¡
();

975 
	`down_wrôe
(&
s
->
lock
);

976 
s
->
fú°_mîgög_chunk
 = 
ﬁd_chunk
;

977 
s
->
num_mîgög_chunks
 = 
löór_chunks
;

978 
	`up_wrôe
(&
s
->
lock
);

981 
i
 = 0; i < 
löór_chunks
; i++)

982 
	`__check_f‹_c⁄Êi˘ög_io
(
s
, 
ﬁd_chunk
 + 
i
);

984 
	`dm_kc›yd_c›y
(
s
->
kc›yd_˛õ¡
, &
§c
, 1, &
de°
, 0, 
mîge_ˇŒback
, s);

987 
shut
:

988 
	`mîge_shutdown
(
s
);

989 
	}
}

991 
îr‹_bios
(
bio
 *bio);

993 
	$mîge_ˇŒback
(
ªad_îr
, 
wrôe_îr
, *
c⁄ãxt
)

995 
dm_¢≠shŸ
 *
s
 = 
c⁄ãxt
;

996 
bio
 *
b
 = 
NULL
;

998 i‡(
ªad_îr
 || 
wrôe_îr
) {

999 i‡(
ªad_îr
)

1000 
	`DMERR
("ReadÉrror: shutting down merge.");

1002 
	`DMERR
("WriteÉrror: shutting down merge.");

1003 
shut
;

1006 i‡(
s
->
°‹e
->
ty≥
->
	`commô_mîge
(s->store,

1007 
s
->
num_mîgög_chunks
) < 0) {

1008 
	`DMERR
("WriteÉrror inÉxception store: shutting down merge");

1009 
shut
;

1012 i‡(
	`ªmove_sögÀ_ex˚±i⁄_chunk
(
s
) < 0)

1013 
shut
;

1015 
	`¢≠shŸ_mîge_√xt_chunks
(
s
);

1019 
shut
:

1020 
	`down_wrôe
(&
s
->
lock
);

1021 
s
->
mîge_Áûed
 = 1;

1022 
b
 = 
	`__ªÀa£_queued_bios_a·î_mîge
(
s
);

1023 
	`up_wrôe
(&
s
->
lock
);

1024 
	`îr‹_bios
(
b
);

1026 
	`mîge_shutdown
(
s
);

1027 
	}
}

1029 
	$°¨t_mîge
(
dm_¢≠shŸ
 *
s
)

1031 i‡(!
	`ã°_™d_£t_bô
(
RUNNING_MERGE
, &
s
->
°©e_bôs
))

1032 
	`¢≠shŸ_mîge_√xt_chunks
(
s
);

1033 
	}
}

1038 
	$°›_mîge
(
dm_¢≠shŸ
 *
s
)

1040 
	`£t_bô
(
SHUTDOWN_MERGE
, &
s
->
°©e_bôs
);

1041 
	`waô_⁄_bô
(&
s
->
°©e_bôs
, 
RUNNING_MERGE
, 
TASK_UNINTERRUPTIBLE
);

1042 
	`˛ór_bô
(
SHUTDOWN_MERGE
, &
s
->
°©e_bôs
);

1043 
	}
}

1048 
	$¢≠shŸ_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

1050 
dm_¢≠shŸ
 *
s
;

1051 
i
;

1052 
r
 = -
EINVAL
;

1053 *
‹igö_∑th
, *
cow_∑th
;

1054 
¨gs_u£d
, 
num_Êush_bios
 = 1;

1055 
fmode_t
 
‹igö_mode
 = 
FMODE_READ
;

1057 i‡(
¨gc
 != 4) {

1058 
ti
->
îr‹
 = "requiresÉxactly 4árguments";

1059 
r
 = -
EINVAL
;

1060 
bad
;

1063 i‡(
	`dm_èrgë_is_¢≠shŸ_mîge
(
ti
)) {

1064 
num_Êush_bios
 = 2;

1065 
‹igö_mode
 = 
FMODE_WRITE
;

1068 
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

1069 i‡(!
s
) {

1070 
ti
->
îr‹
 = "CannotállocateÖrivate snapshot structure";

1071 
r
 = -
ENOMEM
;

1072 
bad
;

1075 
‹igö_∑th
 = 
¨gv
[0];

1076 
¨gv
++;

1077 
¨gc
--;

1079 
r
 = 
	`dm_gë_devi˚
(
ti
, 
‹igö_∑th
, 
‹igö_mode
, &
s
->
‹igö
);

1080 i‡(
r
) {

1081 
ti
->
îr‹
 = "Cannot get origin device";

1082 
bad_‹igö
;

1085 
cow_∑th
 = 
¨gv
[0];

1086 
¨gv
++;

1087 
¨gc
--;

1089 
r
 = 
	`dm_gë_devi˚
(
ti
, 
cow_∑th
, 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
s
->
cow
);

1090 i‡(
r
) {

1091 
ti
->
îr‹
 = "Cannot get COW device";

1092 
bad_cow
;

1095 
r
 = 
	`dm_ex˚±i⁄_°‹e_¸óã
(
ti
, 
¨gc
, 
¨gv
, 
s
, &
¨gs_u£d
, &s->
°‹e
);

1096 i‡(
r
) {

1097 
ti
->
îr‹
 = "Couldn't createÉxception store";

1098 
r
 = -
EINVAL
;

1099 
bad_°‹e
;

1102 
¨gv
 +
¨gs_u£d
;

1103 
¨gc
 -
¨gs_u£d
;

1105 
s
->
ti
 =Åi;

1106 
s
->
vÆid
 = 1;

1107 
s
->
a˘ive
 = 0;

1108 
	`©omic_£t
(&
s
->
≥ndög_ex˚±i⁄s_cou¡
, 0);

1109 
s
->
ex˚±i⁄_°¨t_£quí˚
 = 0;

1110 
s
->
ex˚±i⁄_com∂ëe_£quí˚
 = 0;

1111 
	`INIT_LIST_HEAD
(&
s
->
out_of_‹dî_li°
);

1112 
	`öô_rw£m
(&
s
->
lock
);

1113 
	`INIT_LIST_HEAD
(&
s
->
li°
);

1114 
	`•ö_lock_öô
(&
s
->
≥_lock
);

1115 
s
->
°©e_bôs
 = 0;

1116 
s
->
mîge_Áûed
 = 0;

1117 
s
->
fú°_mîgög_chunk
 = 0;

1118 
s
->
num_mîgög_chunks
 = 0;

1119 
	`bio_li°_öô
(&
s
->
bios_queued_durög_mîge
);

1122 i‡(
	`öô_hash_èbÀs
(
s
)) {

1123 
ti
->
îr‹
 = "UnableÅoállocate hashÅable space";

1124 
r
 = -
ENOMEM
;

1125 
bad_hash_èbÀs
;

1128 
s
->
kc›yd_˛õ¡
 = 
	`dm_kc›yd_˛õ¡_¸óã
(&
dm_kc›yd_thrŸée
);

1129 i‡(
	`IS_ERR
(
s
->
kc›yd_˛õ¡
)) {

1130 
r
 = 
	`PTR_ERR
(
s
->
kc›yd_˛õ¡
);

1131 
ti
->
îr‹
 = "CouldÇot create kcopyd client";

1132 
bad_kc›yd
;

1135 
s
->
≥ndög_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
MIN_IOS
, 
≥ndög_ˇche
);

1136 i‡(!
s
->
≥ndög_poﬁ
) {

1137 
ti
->
îr‹
 = "CouldÇotállocate mempool forÖendingÉxceptions";

1138 
r
 = -
ENOMEM
;

1139 
bad_≥ndög_poﬁ
;

1142 
i
 = 0; i < 
DM_TRACKED_CHUNK_HASH_SIZE
; i++)

1143 
	`INIT_HLIST_HEAD
(&
s
->
åacked_chunk_hash
[
i
]);

1145 
	`•ö_lock_öô
(&
s
->
åacked_chunk_lock
);

1147 
ti
->
¥iv©e
 = 
s
;

1148 
ti
->
num_Êush_bios
 =Çum_flush_bios;

1149 
ti
->
≥r_bio_d©a_size
 = (
dm_¢≠_åacked_chunk
);

1153 
r
 = 
	`ªgi°î_¢≠shŸ
(
s
);

1154 i‡(
r
 =-
ENOMEM
) {

1155 
ti
->
îr‹
 = "Snapshot origin structállocation failed";

1156 
bad_lﬂd_™d_ªgi°î
;

1157 } i‡(
r
 < 0) {

1159 
bad_lﬂd_™d_ªgi°î
;

1168 i‡(
r
 > 0) {

1169 
s
->
°‹e
->
chunk_size
 = 0;

1173 
r
 = 
s
->
°‹e
->
ty≥
->
	`ªad_mëad©a
(s->°‹e, 
dm_add_ex˚±i⁄
,

1174 (*)
s
);

1175 i‡(
r
 < 0) {

1176 
ti
->
îr‹
 = "FailedÅoÑead snapshot metadata";

1177 
bad_ªad_mëad©a
;

1178 } i‡(
r
 > 0) {

1179 
s
->
vÆid
 = 0;

1180 
	`DMWARN
("Snapshot is marked invalid.");

1183 i‡(!
s
->
°‹e
->
chunk_size
) {

1184 
ti
->
îr‹
 = "Chunk sizeÇot set";

1185 
bad_ªad_mëad©a
;

1188 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
s
->
°‹e
->
chunk_size
);

1189 i‡(
r
)

1190 
bad_ªad_mëad©a
;

1194 
bad_ªad_mëad©a
:

1195 
	`uƒegi°î_¢≠shŸ
(
s
);

1197 
bad_lﬂd_™d_ªgi°î
:

1198 
	`mempoﬁ_de°roy
(
s
->
≥ndög_poﬁ
);

1200 
bad_≥ndög_poﬁ
:

1201 
	`dm_kc›yd_˛õ¡_de°roy
(
s
->
kc›yd_˛õ¡
);

1203 
bad_kc›yd
:

1204 
	`dm_ex˚±i⁄_èbÀ_exô
(&
s
->
≥ndög
, 
≥ndög_ˇche
);

1205 
	`dm_ex˚±i⁄_èbÀ_exô
(&
s
->
com∂ëe
, 
ex˚±i⁄_ˇche
);

1207 
bad_hash_èbÀs
:

1208 
	`dm_ex˚±i⁄_°‹e_de°roy
(
s
->
°‹e
);

1210 
bad_°‹e
:

1211 
	`dm_put_devi˚
(
ti
, 
s
->
cow
);

1213 
bad_cow
:

1214 
	`dm_put_devi˚
(
ti
, 
s
->
‹igö
);

1216 
bad_‹igö
:

1217 
	`k‰ì
(
s
);

1219 
bad
:

1220  
r
;

1221 
	}
}

1223 
	$__‰ì_ex˚±i⁄s
(
dm_¢≠shŸ
 *
s
)

1225 
	`dm_kc›yd_˛õ¡_de°roy
(
s
->
kc›yd_˛õ¡
);

1226 
s
->
kc›yd_˛õ¡
 = 
NULL
;

1228 
	`dm_ex˚±i⁄_èbÀ_exô
(&
s
->
≥ndög
, 
≥ndög_ˇche
);

1229 
	`dm_ex˚±i⁄_èbÀ_exô
(&
s
->
com∂ëe
, 
ex˚±i⁄_ˇche
);

1230 
	}
}

1232 
	$__h™dovî_ex˚±i⁄s
(
dm_¢≠shŸ
 *
¢≠_§c
,

1233 
dm_¢≠shŸ
 *
¢≠_de°
)

1236 
dm_ex˚±i⁄_èbÀ
 
èbÀ_sw≠
;

1237 
dm_ex˚±i⁄_°‹e
 *
°‹e_sw≠
;

1238 } 
u
;

1243 
u
.
èbÀ_sw≠
 = 
¢≠_de°
->
com∂ëe
;

1244 
¢≠_de°
->
com∂ëe
 = 
¢≠_§c
->complete;

1245 
¢≠_§c
->
com∂ëe
 = 
u
.
èbÀ_sw≠
;

1247 
u
.
°‹e_sw≠
 = 
¢≠_de°
->
°‹e
;

1248 
¢≠_de°
->
°‹e
 = 
¢≠_§c
->store;

1249 
¢≠_§c
->
°‹e
 = 
u
.
°‹e_sw≠
;

1251 
¢≠_de°
->
°‹e
->
¢≠
 = snap_dest;

1252 
¢≠_§c
->
°‹e
->
¢≠
 = snap_src;

1254 
¢≠_de°
->
ti
->
max_io_Àn
 = s«p_de°->
°‹e
->
chunk_size
;

1255 
¢≠_de°
->
vÆid
 = 
¢≠_§c
->valid;

1260 
¢≠_§c
->
vÆid
 = 0;

1261 
	}
}

1263 
	$¢≠shŸ_då
(
dm_èrgë
 *
ti
)

1265 #ifde‡
CONFIG_DM_DEBUG


1266 
i
;

1268 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1269 
dm_¢≠shŸ
 *
¢≠_§c
 = 
NULL
, *
¢≠_de°
 = NULL;

1271 
	`down_ªad
(&
_‹igös_lock
);

1273 (Ë
	`__föd_¢≠shŸs_sh¨ög_cow
(
s
, &
¢≠_§c
, &
¢≠_de°
, 
NULL
);

1274 i‡(
¢≠_§c
 && 
¢≠_de°
 && (
s
 == snap_src)) {

1275 
	`down_wrôe
(&
¢≠_de°
->
lock
);

1276 
¢≠_de°
->
vÆid
 = 0;

1277 
	`up_wrôe
(&
¢≠_de°
->
lock
);

1278 
	`DMERR
("Cancelling snapshot handover.");

1280 
	`up_ªad
(&
_‹igös_lock
);

1282 i‡(
	`dm_èrgë_is_¢≠shŸ_mîge
(
ti
))

1283 
	`°›_mîge
(
s
);

1287 
	`uƒegi°î_¢≠shŸ
(
s
);

1289 
	`©omic_ªad
(&
s
->
≥ndög_ex˚±i⁄s_cou¡
))

1290 
	`m¶ìp
(1);

1295 
	`smp_mb
();

1297 #ifde‡
CONFIG_DM_DEBUG


1298 
i
 = 0; i < 
DM_TRACKED_CHUNK_HASH_SIZE
; i++)

1299 
	`BUG_ON
(!
	`hli°_em±y
(&
s
->
åacked_chunk_hash
[
i
]));

1302 
	`__‰ì_ex˚±i⁄s
(
s
);

1304 
	`mempoﬁ_de°roy
(
s
->
≥ndög_poﬁ
);

1306 
	`dm_ex˚±i⁄_°‹e_de°roy
(
s
->
°‹e
);

1308 
	`dm_put_devi˚
(
ti
, 
s
->
cow
);

1310 
	`dm_put_devi˚
(
ti
, 
s
->
‹igö
);

1312 
	`k‰ì
(
s
);

1313 
	}
}

1318 
	$Êush_bios
(
bio
 *bio)

1320 
bio
 *
n
;

1322 
bio
) {

1323 
n
 = 
bio
->
bi_√xt
;

1324 
bio
->
bi_√xt
 = 
NULL
;

1325 
	`gíîic_make_ªque°
(
bio
);

1326 
bio
 = 
n
;

1328 
	}
}

1330 
do_‹igö
(
dm_dev
 *
‹igö
, 
bio
 *bio);

1335 
	$ªåy_‹igö_bios
(
dm_¢≠shŸ
 *
s
, 
bio
 *bio)

1337 
bio
 *
n
;

1338 
r
;

1340 
bio
) {

1341 
n
 = 
bio
->
bi_√xt
;

1342 
bio
->
bi_√xt
 = 
NULL
;

1343 
r
 = 
	`do_‹igö
(
s
->
‹igö
, 
bio
);

1344 i‡(
r
 =
DM_MAPIO_REMAPPED
)

1345 
	`gíîic_make_ªque°
(
bio
);

1346 
bio
 = 
n
;

1348 
	}
}

1353 
	$îr‹_bios
(
bio
 *bio)

1355 
bio
 *
n
;

1357 
bio
) {

1358 
n
 = 
bio
->
bi_√xt
;

1359 
bio
->
bi_√xt
 = 
NULL
;

1360 
	`bio_io_îr‹
(
bio
);

1361 
bio
 = 
n
;

1363 
	}
}

1365 
	$__övÆid©e_¢≠shŸ
(
dm_¢≠shŸ
 *
s
, 
îr
)

1367 i‡(!
s
->
vÆid
)

1370 i‡(
îr
 =-
EIO
)

1371 
	`DMERR
("Invalidating snapshot: ErrorÑeading/writing.");

1372 i‡(
îr
 =-
ENOMEM
)

1373 
	`DMERR
("Invalidating snapshot: UnableÅoállocateÉxception.");

1375 i‡(
s
->
°‹e
->
ty≥
->
dr›_¢≠shŸ
)

1376 
s
->
°‹e
->
ty≥
->
	`dr›_¢≠shŸ
(s->store);

1378 
s
->
vÆid
 = 0;

1380 
	`dm_èbÀ_evít
(
s
->
ti
->
èbÀ
);

1381 
	}
}

1383 
	$≥ndög_com∂ëe
(
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
, 
suc˚ss
)

1385 
dm_ex˚±i⁄
 *
e
;

1386 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

1387 
bio
 *
‹igö_bios
 = 
NULL
;

1388 
bio
 *
¢≠shŸ_bios
 = 
NULL
;

1389 
bio
 *
fuŒ_bio
 = 
NULL
;

1390 
îr‹
 = 0;

1392 i‡(!
suc˚ss
) {

1394 
	`down_wrôe
(&
s
->
lock
);

1395 
	`__övÆid©e_¢≠shŸ
(
s
, -
EIO
);

1396 
îr‹
 = 1;

1397 
out
;

1400 
e
 = 
	`Æloc_com∂ëed_ex˚±i⁄
(
GFP_NOIO
);

1401 i‡(!
e
) {

1402 
	`down_wrôe
(&
s
->
lock
);

1403 
	`__övÆid©e_¢≠shŸ
(
s
, -
ENOMEM
);

1404 
îr‹
 = 1;

1405 
out
;

1407 *
e
 = 
≥
->e;

1409 
	`down_wrôe
(&
s
->
lock
);

1410 i‡(!
s
->
vÆid
) {

1411 
	`‰ì_com∂ëed_ex˚±i⁄
(
e
);

1412 
îr‹
 = 1;

1413 
out
;

1417 
	`__check_f‹_c⁄Êi˘ög_io
(
s
, 
≥
->
e
.
ﬁd_chunk
);

1423 
	`dm_ö£π_ex˚±i⁄
(&
s
->
com∂ëe
, 
e
);

1425 
out
:

1426 
	`dm_ªmove_ex˚±i⁄
(&
≥
->
e
);

1427 
¢≠shŸ_bios
 = 
	`bio_li°_gë
(&
≥
->snapshot_bios);

1428 
‹igö_bios
 = 
	`bio_li°_gë
(&
≥
->origin_bios);

1429 
fuŒ_bio
 = 
≥
->full_bio;

1430 i‡(
fuŒ_bio
) {

1431 
fuŒ_bio
->
bi_íd_io
 = 
≥
->
fuŒ_bio_íd_io
;

1432 
fuŒ_bio
->
bi_¥iv©e
 = 
≥
->
fuŒ_bio_¥iv©e
;

1433 
	`©omic_öc
(&
fuŒ_bio
->
bi_ªmaöög
);

1435 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

1437 
	`ö¸emít_≥ndög_ex˚±i⁄s_d⁄e_cou¡
();

1439 
	`up_wrôe
(&
s
->
lock
);

1442 i‡(
îr‹
) {

1443 i‡(
fuŒ_bio
)

1444 
	`bio_io_îr‹
(
fuŒ_bio
);

1445 
	`îr‹_bios
(
¢≠shŸ_bios
);

1447 i‡(
fuŒ_bio
)

1448 
	`bio_ídio
(
fuŒ_bio
, 0);

1449 
	`Êush_bios
(
¢≠shŸ_bios
);

1452 
	`ªåy_‹igö_bios
(
s
, 
‹igö_bios
);

1453 
	}
}

1455 
	$commô_ˇŒback
(*
c⁄ãxt
, 
suc˚ss
)

1457 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
 = 
c⁄ãxt
;

1459 
	`≥ndög_com∂ëe
(
≥
, 
suc˚ss
);

1460 
	}
}

1462 
	$com∂ëe_ex˚±i⁄
(
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
)

1464 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

1466 i‡(
	`u∆ikñy
(
≥
->
c›y_îr‹
))

1467 
	`≥ndög_com∂ëe
(
≥
, 0);

1471 
s
->
°‹e
->
ty≥
->
	`commô_ex˚±i⁄
(s->°‹e, &
≥
->
e
,

1472 
commô_ˇŒback
, 
≥
);

1473 
	}
}

1479 
	$c›y_ˇŒback
(
ªad_îr
, 
wrôe_îr
, *
c⁄ãxt
)

1481 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
 = 
c⁄ãxt
;

1482 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

1484 
≥
->
c›y_îr‹
 = 
ªad_îr
 || 
wrôe_îr
;

1486 i‡(
≥
->
ex˚±i⁄_£quí˚
 =
s
->
ex˚±i⁄_com∂ëe_£quí˚
) {

1487 
s
->
ex˚±i⁄_com∂ëe_£quí˚
++;

1488 
	`com∂ëe_ex˚±i⁄
(
≥
);

1490 !
	`li°_em±y
(&
s
->
out_of_‹dî_li°
)) {

1491 
≥
 = 
	`li°_íåy
(
s
->
out_of_‹dî_li°
.
√xt
,

1492 
dm_¢≠_≥ndög_ex˚±i⁄
, 
out_of_‹dî_íåy
);

1493 i‡(
≥
->
ex˚±i⁄_£quí˚
 !
s
->
ex˚±i⁄_com∂ëe_£quí˚
)

1495 
s
->
ex˚±i⁄_com∂ëe_£quí˚
++;

1496 
	`li°_dñ
(&
≥
->
out_of_‹dî_íåy
);

1497 
	`com∂ëe_ex˚±i⁄
(
≥
);

1500 
li°_hód
 *
lh
;

1501 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥2
;

1503 
	`li°_f‹_óch_¥ev
(
lh
, &
s
->
out_of_‹dî_li°
) {

1504 
≥2
 = 
	`li°_íåy
(
lh
, 
dm_¢≠_≥ndög_ex˚±i⁄
, 
out_of_‹dî_íåy
);

1505 i‡(
≥2
->
ex˚±i⁄_£quí˚
 < 
≥
->exception_sequence)

1508 
	`li°_add
(&
≥
->
out_of_‹dî_íåy
, 
lh
);

1510 
	}
}

1515 
	$°¨t_c›y
(
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
)

1517 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

1518 
dm_io_ªgi⁄
 
§c
, 
de°
;

1519 
block_devi˚
 *
bdev
 = 
s
->
‹igö
->bdev;

1520 
£˘‹_t
 
dev_size
;

1522 
dev_size
 = 
	`gë_dev_size
(
bdev
);

1524 
§c
.
bdev
 = bdev;

1525 
§c
.
£˘‹
 = 
	`chunk_to_£˘‹
(
s
->
°‹e
, 
≥
->
e
.
ﬁd_chunk
);

1526 
§c
.
cou¡
 = 
	`mö
((
£˘‹_t
)
s
->
°‹e
->
chunk_size
, 
dev_size
 - src.
£˘‹
);

1528 
de°
.
bdev
 = 
s
->
cow
->bdev;

1529 
de°
.
£˘‹
 = 
	`chunk_to_£˘‹
(
s
->
°‹e
, 
≥
->
e
.
√w_chunk
);

1530 
de°
.
cou¡
 = 
§c
.count;

1533 
	`dm_kc›yd_c›y
(
s
->
kc›yd_˛õ¡
, &
§c
, 1, &
de°
, 0, 
c›y_ˇŒback
, 
≥
);

1534 
	}
}

1536 
	$fuŒ_bio_íd_io
(
bio
 *bio, 
îr‹
)

1538 *
ˇŒback_d©a
 = 
bio
->
bi_¥iv©e
;

1540 
	`dm_kc›yd_do_ˇŒback
(
ˇŒback_d©a
, 0, 
îr‹
 ? 1 : 0);

1541 
	}
}

1543 
	$°¨t_fuŒ_bio
(
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
,

1544 
bio
 *bio)

1546 
dm_¢≠shŸ
 *
s
 = 
≥
->
¢≠
;

1547 *
ˇŒback_d©a
;

1549 
≥
->
fuŒ_bio
 = 
bio
;

1550 
≥
->
fuŒ_bio_íd_io
 = 
bio
->
bi_íd_io
;

1551 
≥
->
fuŒ_bio_¥iv©e
 = 
bio
->
bi_¥iv©e
;

1553 
ˇŒback_d©a
 = 
	`dm_kc›yd_¥ï¨e_ˇŒback
(
s
->
kc›yd_˛õ¡
,

1554 
c›y_ˇŒback
, 
≥
);

1556 
bio
->
bi_íd_io
 = 
fuŒ_bio_íd_io
;

1557 
bio
->
bi_¥iv©e
 = 
ˇŒback_d©a
;

1559 
	`gíîic_make_ªque°
(
bio
);

1560 
	}
}

1562 
dm_¢≠_≥ndög_ex˚±i⁄
 *

1563 
	$__lookup_≥ndög_ex˚±i⁄
(
dm_¢≠shŸ
 *
s
, 
chunk_t
 
chunk
)

1565 
dm_ex˚±i⁄
 *
e
 = 
	`dm_lookup_ex˚±i⁄
(&
s
->
≥ndög
, 
chunk
);

1567 i‡(!
e
)

1568  
NULL
;

1570  
	`c⁄èöî_of
(
e
, 
dm_¢≠_≥ndög_ex˚±i⁄
,É);

1571 
	}
}

1581 
dm_¢≠_≥ndög_ex˚±i⁄
 *

1582 
	$__föd_≥ndög_ex˚±i⁄
(
dm_¢≠shŸ
 *
s
,

1583 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
, 
chunk_t
 
chunk
)

1585 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥2
;

1587 
≥2
 = 
	`__lookup_≥ndög_ex˚±i⁄
(
s
, 
chunk
);

1588 i‡(
≥2
) {

1589 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

1590  
≥2
;

1593 
≥
->
e
.
ﬁd_chunk
 = 
chunk
;

1594 
	`bio_li°_öô
(&
≥
->
‹igö_bios
);

1595 
	`bio_li°_öô
(&
≥
->
¢≠shŸ_bios
);

1596 
≥
->
°¨ãd
 = 0;

1597 
≥
->
fuŒ_bio
 = 
NULL
;

1599 i‡(
s
->
°‹e
->
ty≥
->
	`¥ï¨e_ex˚±i⁄
(s->°‹e, &
≥
->
e
)) {

1600 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

1601  
NULL
;

1604 
≥
->
ex˚±i⁄_£quí˚
 = 
s
->
ex˚±i⁄_°¨t_£quí˚
++;

1606 
	`dm_ö£π_ex˚±i⁄
(&
s
->
≥ndög
, &
≥
->
e
);

1608  
≥
;

1609 
	}
}

1611 
	$ªm≠_ex˚±i⁄
(
dm_¢≠shŸ
 *
s
, 
dm_ex˚±i⁄
 *
e
,

1612 
bio
 *bio, 
chunk_t
 
chunk
)

1614 
bio
->
bi_bdev
 = 
s
->
cow
->
bdev
;

1615 
bio
->
bi_ôî
.
bi_£˘‹
 =

1616 
	`chunk_to_£˘‹
(
s
->
°‹e
, 
	`dm_chunk_numbî
(
e
->
√w_chunk
) +

1617 (
chunk
 - 
e
->
ﬁd_chunk
)) +

1618 (
bio
->
bi_ôî
.
bi_£˘‹
 & 
s
->
°‹e
->
chunk_mask
);

1619 
	}
}

1621 
	$¢≠shŸ_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1623 
dm_ex˚±i⁄
 *
e
;

1624 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1625 
r
 = 
DM_MAPIO_REMAPPED
;

1626 
chunk_t
 
chunk
;

1627 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
 = 
NULL
;

1629 
	`öô_åacked_chunk
(
bio
);

1631 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

1632 
bio
->
bi_bdev
 = 
s
->
cow
->
bdev
;

1633  
DM_MAPIO_REMAPPED
;

1636 
chunk
 = 
	`£˘‹_to_chunk
(
s
->
°‹e
, 
bio
->
bi_ôî
.
bi_£˘‹
);

1640 i‡(!
s
->
vÆid
)

1641  -
EIO
;

1645 
	`down_wrôe
(&
s
->
lock
);

1647 i‡(!
s
->
vÆid
) {

1648 
r
 = -
EIO
;

1649 
out_u∆ock
;

1653 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
s
->
com∂ëe
, 
chunk
);

1654 i‡(
e
) {

1655 
	`ªm≠_ex˚±i⁄
(
s
, 
e
, 
bio
, 
chunk
);

1656 
out_u∆ock
;

1664 i‡(
	`bio_rw
(
bio
Ë=
WRITE
) {

1665 
≥
 = 
	`__lookup_≥ndög_ex˚±i⁄
(
s
, 
chunk
);

1666 i‡(!
≥
) {

1667 
	`up_wrôe
(&
s
->
lock
);

1668 
≥
 = 
	`Æloc_≥ndög_ex˚±i⁄
(
s
);

1669 
	`down_wrôe
(&
s
->
lock
);

1671 i‡(!
s
->
vÆid
) {

1672 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

1673 
r
 = -
EIO
;

1674 
out_u∆ock
;

1677 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
s
->
com∂ëe
, 
chunk
);

1678 i‡(
e
) {

1679 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

1680 
	`ªm≠_ex˚±i⁄
(
s
, 
e
, 
bio
, 
chunk
);

1681 
out_u∆ock
;

1684 
≥
 = 
	`__föd_≥ndög_ex˚±i⁄
(
s
,Öe, 
chunk
);

1685 i‡(!
≥
) {

1686 
	`__övÆid©e_¢≠shŸ
(
s
, -
ENOMEM
);

1687 
r
 = -
EIO
;

1688 
out_u∆ock
;

1692 
	`ªm≠_ex˚±i⁄
(
s
, &
≥
->
e
, 
bio
, 
chunk
);

1694 
r
 = 
DM_MAPIO_SUBMITTED
;

1696 i‡(!
≥
->
°¨ãd
 &&

1697 
bio
->
bi_ôî
.
bi_size
 ==

1698 (
s
->
°‹e
->
chunk_size
 << 
SECTOR_SHIFT
)) {

1699 
≥
->
°¨ãd
 = 1;

1700 
	`up_wrôe
(&
s
->
lock
);

1701 
	`°¨t_fuŒ_bio
(
≥
, 
bio
);

1702 
out
;

1705 
	`bio_li°_add
(&
≥
->
¢≠shŸ_bios
, 
bio
);

1707 i‡(!
≥
->
°¨ãd
) {

1709 
≥
->
°¨ãd
 = 1;

1710 
	`up_wrôe
(&
s
->
lock
);

1711 
	`°¨t_c›y
(
≥
);

1712 
out
;

1715 
bio
->
bi_bdev
 = 
s
->
‹igö
->
bdev
;

1716 
	`åack_chunk
(
s
, 
bio
, 
chunk
);

1719 
out_u∆ock
:

1720 
	`up_wrôe
(&
s
->
lock
);

1721 
out
:

1722  
r
;

1723 
	}
}

1737 
	$¢≠shŸ_mîge_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1739 
dm_ex˚±i⁄
 *
e
;

1740 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1741 
r
 = 
DM_MAPIO_REMAPPED
;

1742 
chunk_t
 
chunk
;

1744 
	`öô_åacked_chunk
(
bio
);

1746 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

1747 i‡(!
	`dm_bio_gë_èrgë_bio_ƒ
(
bio
))

1748 
bio
->
bi_bdev
 = 
s
->
‹igö
->
bdev
;

1750 
bio
->
bi_bdev
 = 
s
->
cow
->
bdev
;

1751  
DM_MAPIO_REMAPPED
;

1754 
chunk
 = 
	`£˘‹_to_chunk
(
s
->
°‹e
, 
bio
->
bi_ôî
.
bi_£˘‹
);

1756 
	`down_wrôe
(&
s
->
lock
);

1759 i‡(!
s
->
vÆid
)

1760 
ªdúe˘_to_‹igö
;

1763 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
s
->
com∂ëe
, 
chunk
);

1764 i‡(
e
) {

1766 i‡(
	`bio_rw
(
bio
Ë=
WRITE
 &&

1767 
chunk
 >
s
->
fú°_mîgög_chunk
 &&

1768 
chunk
 < (
s
->
fú°_mîgög_chunk
 +

1769 
s
->
num_mîgög_chunks
)) {

1770 
bio
->
bi_bdev
 = 
s
->
‹igö
->
bdev
;

1771 
	`bio_li°_add
(&
s
->
bios_queued_durög_mîge
, 
bio
);

1772 
r
 = 
DM_MAPIO_SUBMITTED
;

1773 
out_u∆ock
;

1776 
	`ªm≠_ex˚±i⁄
(
s
, 
e
, 
bio
, 
chunk
);

1778 i‡(
	`bio_rw
(
bio
Ë=
WRITE
)

1779 
	`åack_chunk
(
s
, 
bio
, 
chunk
);

1780 
out_u∆ock
;

1783 
ªdúe˘_to_‹igö
:

1784 
bio
->
bi_bdev
 = 
s
->
‹igö
->
bdev
;

1786 i‡(
	`bio_rw
(
bio
Ë=
WRITE
) {

1787 
	`up_wrôe
(&
s
->
lock
);

1788  
	`do_‹igö
(
s
->
‹igö
, 
bio
);

1791 
out_u∆ock
:

1792 
	`up_wrôe
(&
s
->
lock
);

1794  
r
;

1795 
	}
}

1797 
	$¢≠shŸ_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

1799 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1801 i‡(
	`is_bio_åacked
(
bio
))

1802 
	`°›_åackög_chunk
(
s
, 
bio
);

1805 
	}
}

1807 
	$¢≠shŸ_mîge_¥esu•íd
(
dm_èrgë
 *
ti
)

1809 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1811 
	`°›_mîge
(
s
);

1812 
	}
}

1814 
	$¢≠shŸ_¥îesume
(
dm_èrgë
 *
ti
)

1816 
r
 = 0;

1817 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1818 
dm_¢≠shŸ
 *
¢≠_§c
 = 
NULL
, *
¢≠_de°
 = NULL;

1820 
	`down_ªad
(&
_‹igös_lock
);

1821 (Ë
	`__föd_¢≠shŸs_sh¨ög_cow
(
s
, &
¢≠_§c
, &
¢≠_de°
, 
NULL
);

1822 i‡(
¢≠_§c
 && 
¢≠_de°
) {

1823 
	`down_ªad
(&
¢≠_§c
->
lock
);

1824 i‡(
s
 =
¢≠_§c
) {

1825 
	`DMERR
("UnableÅoÑesume snapshot source until "

1827 
r
 = -
EINVAL
;

1828 } i‡(!
	`dm_su•íded
(
¢≠_§c
->
ti
)) {

1829 
	`DMERR
("UnableÅoÖerform snapshot handover until "

1831 
r
 = -
EINVAL
;

1833 
	`up_ªad
(&
¢≠_§c
->
lock
);

1835 
	`up_ªad
(&
_‹igös_lock
);

1837  
r
;

1838 
	}
}

1840 
	$¢≠shŸ_ªsume
(
dm_èrgë
 *
ti
)

1842 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1843 
dm_¢≠shŸ
 *
¢≠_§c
 = 
NULL
, *
¢≠_de°
 = NULL;

1845 
	`down_ªad
(&
_‹igös_lock
);

1846 (Ë
	`__föd_¢≠shŸs_sh¨ög_cow
(
s
, &
¢≠_§c
, &
¢≠_de°
, 
NULL
);

1847 i‡(
¢≠_§c
 && 
¢≠_de°
) {

1848 
	`down_wrôe
(&
¢≠_§c
->
lock
);

1849 
	`down_wrôe_√°ed
(&
¢≠_de°
->
lock
, 
SINGLE_DEPTH_NESTING
);

1850 
	`__h™dovî_ex˚±i⁄s
(
¢≠_§c
, 
¢≠_de°
);

1851 
	`up_wrôe
(&
¢≠_de°
->
lock
);

1852 
	`up_wrôe
(&
¢≠_§c
->
lock
);

1854 
	`up_ªad
(&
_‹igös_lock
);

1857 
	`ªªgi°î_¢≠shŸ
(
s
);

1859 
	`down_wrôe
(&
s
->
lock
);

1860 
s
->
a˘ive
 = 1;

1861 
	`up_wrôe
(&
s
->
lock
);

1862 
	}
}

1864 
uöt32_t
 
	$gë_‹igö_möimum_chunksize
(
block_devi˚
 *
bdev
)

1866 
uöt32_t
 
mö_chunksize
;

1868 
	`down_ªad
(&
_‹igös_lock
);

1869 
mö_chunksize
 = 
	`__möimum_chunk_size
(
	`__lookup_‹igö
(
bdev
));

1870 
	`up_ªad
(&
_‹igös_lock
);

1872  
mö_chunksize
;

1873 
	}
}

1875 
	$¢≠shŸ_mîge_ªsume
(
dm_èrgë
 *
ti
)

1877 
dm_¢≠shŸ
 *
s
 = 
ti
->
¥iv©e
;

1882 
	`¢≠shŸ_ªsume
(
ti
);

1887 
ti
->
max_io_Àn
 = 
	`gë_‹igö_möimum_chunksize
(
s
->
‹igö
->
bdev
);

1889 
	`°¨t_mîge
(
s
);

1890 
	}
}

1892 
	$¢≠shŸ_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

1893 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

1895 
sz
 = 0;

1896 
dm_¢≠shŸ
 *
¢≠
 = 
ti
->
¥iv©e
;

1898 
ty≥
) {

1899 
STATUSTYPE_INFO
:

1901 
	`down_wrôe
(&
¢≠
->
lock
);

1903 i‡(!
¢≠
->
vÆid
)

1904 
	`DMEMIT
("Invalid");

1905 i‡(
¢≠
->
mîge_Áûed
)

1906 
	`DMEMIT
("Merge failed");

1908 i‡(
¢≠
->
°‹e
->
ty≥
->
ußge
) {

1909 
£˘‹_t
 
tŸÆ_£˘‹s
, 
£˘‹s_Æloˇãd
,

1910 
mëad©a_£˘‹s
;

1911 
¢≠
->
°‹e
->
ty≥
->
	`ußge
(snap->store,

1912 &
tŸÆ_£˘‹s
,

1913 &
£˘‹s_Æloˇãd
,

1914 &
mëad©a_£˘‹s
);

1915 
	`DMEMIT
("%llu/%llu %llu",

1916 ()
£˘‹s_Æloˇãd
,

1917 ()
tŸÆ_£˘‹s
,

1918 ()
mëad©a_£˘‹s
);

1921 
	`DMEMIT
("Unknown");

1924 
	`up_wrôe
(&
¢≠
->
lock
);

1928 
STATUSTYPE_TABLE
:

1934 
	`DMEMIT
("%†%s", 
¢≠
->
‹igö
->
«me
, s«p->
cow
->name);

1935 
¢≠
->
°‹e
->
ty≥
->
	`°©us
(¢≠->°‹e,Åy≥, 
ªsu…
 + 
sz
,

1936 
maxÀn
 - 
sz
);

1939 
	}
}

1941 
	$¢≠shŸ_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

1942 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

1944 
dm_¢≠shŸ
 *
¢≠
 = 
ti
->
¥iv©e
;

1945 
r
;

1947 
r
 = 
	`‚
(
ti
, 
¢≠
->
‹igö
, 0,Åi->
Àn
, 
d©a
);

1949 i‡(!
r
)

1950 
r
 = 
	`‚
(
ti
, 
¢≠
->
cow
, 0, 
	`gë_dev_size
(¢≠->cow->
bdev
), 
d©a
);

1952  
r
;

1953 
	}
}

1970 
	$__‹igö_wrôe
(
li°_hód
 *
¢≠shŸs
, 
£˘‹_t
 
£˘‹
,

1971 
bio
 *bio)

1973 
r
 = 
DM_MAPIO_REMAPPED
;

1974 
dm_¢≠shŸ
 *
¢≠
;

1975 
dm_ex˚±i⁄
 *
e
;

1976 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥
;

1977 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥_to_°¨t_now
 = 
NULL
;

1978 
dm_¢≠_≥ndög_ex˚±i⁄
 *
≥_to_°¨t_œ°
 = 
NULL
;

1979 
chunk_t
 
chunk
;

1982 
	`li°_f‹_óch_íåy
 (
¢≠
, 
¢≠shŸs
, 
li°
) {

1987 i‡(
	`dm_èrgë_is_¢≠shŸ_mîge
(
¢≠
->
ti
))

1990 
	`down_wrôe
(&
¢≠
->
lock
);

1993 i‡(!
¢≠
->
vÆid
 || !¢≠->
a˘ive
)

1994 
√xt_¢≠shŸ
;

1997 i‡(
£˘‹
 >
	`dm_èbÀ_gë_size
(
¢≠
->
ti
->
èbÀ
))

1998 
√xt_¢≠shŸ
;

2004 
chunk
 = 
	`£˘‹_to_chunk
(
¢≠
->
°‹e
, 
£˘‹
);

2011 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
¢≠
->
com∂ëe
, 
chunk
);

2012 i‡(
e
)

2013 
√xt_¢≠shŸ
;

2015 
≥
 = 
	`__lookup_≥ndög_ex˚±i⁄
(
¢≠
, 
chunk
);

2016 i‡(!
≥
) {

2017 
	`up_wrôe
(&
¢≠
->
lock
);

2018 
≥
 = 
	`Æloc_≥ndög_ex˚±i⁄
(
¢≠
);

2019 
	`down_wrôe
(&
¢≠
->
lock
);

2021 i‡(!
¢≠
->
vÆid
) {

2022 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

2023 
√xt_¢≠shŸ
;

2026 
e
 = 
	`dm_lookup_ex˚±i⁄
(&
¢≠
->
com∂ëe
, 
chunk
);

2027 i‡(
e
) {

2028 
	`‰ì_≥ndög_ex˚±i⁄
(
≥
);

2029 
√xt_¢≠shŸ
;

2032 
≥
 = 
	`__föd_≥ndög_ex˚±i⁄
(
¢≠
,Öe, 
chunk
);

2033 i‡(!
≥
) {

2034 
	`__övÆid©e_¢≠shŸ
(
¢≠
, -
ENOMEM
);

2035 
√xt_¢≠shŸ
;

2039 
r
 = 
DM_MAPIO_SUBMITTED
;

2046 i‡(
bio
) {

2047 
	`bio_li°_add
(&
≥
->
‹igö_bios
, 
bio
);

2048 
bio
 = 
NULL
;

2050 i‡(!
≥
->
°¨ãd
) {

2051 
≥
->
°¨ãd
 = 1;

2052 
≥_to_°¨t_œ°
 = 
≥
;

2056 i‡(!
≥
->
°¨ãd
) {

2057 
≥
->
°¨ãd
 = 1;

2058 
≥_to_°¨t_now
 = 
≥
;

2061 
√xt_¢≠shŸ
:

2062 
	`up_wrôe
(&
¢≠
->
lock
);

2064 i‡(
≥_to_°¨t_now
) {

2065 
	`°¨t_c›y
(
≥_to_°¨t_now
);

2066 
≥_to_°¨t_now
 = 
NULL
;

2074 i‡(
≥_to_°¨t_œ°
)

2075 
	`°¨t_c›y
(
≥_to_°¨t_œ°
);

2077  
r
;

2078 
	}
}

2083 
	$do_‹igö
(
dm_dev
 *
‹igö
, 
bio
 *bio)

2085 
‹igö
 *
o
;

2086 
r
 = 
DM_MAPIO_REMAPPED
;

2088 
	`down_ªad
(&
_‹igös_lock
);

2089 
o
 = 
	`__lookup_‹igö
(
‹igö
->
bdev
);

2090 i‡(
o
)

2091 
r
 = 
	`__‹igö_wrôe
(&
o
->
¢≠shŸs
, 
bio
->
bi_ôî
.
bi_£˘‹
, bio);

2092 
	`up_ªad
(&
_‹igös_lock
);

2094  
r
;

2095 
	}
}

2110 
	$‹igö_wrôe_exã¡
(
dm_¢≠shŸ
 *
mîgög_¢≠
,

2111 
£˘‹_t
 
£˘‹
, 
size
)

2113 
mu°_waô
 = 0;

2114 
£˘‹_t
 
n
;

2115 
‹igö
 *
o
;

2121 
	`down_ªad
(&
_‹igös_lock
);

2122 
o
 = 
	`__lookup_‹igö
(
mîgög_¢≠
->
‹igö
->
bdev
);

2123 
n
 = 0;Ç < 
size
;Ç +
mîgög_¢≠
->
ti
->
max_io_Àn
)

2124 i‡(
	`__‹igö_wrôe
(&
o
->
¢≠shŸs
, 
£˘‹
 + 
n
, 
NULL
) ==

2125 
DM_MAPIO_SUBMITTED
)

2126 
mu°_waô
 = 1;

2127 
	`up_ªad
(&
_‹igös_lock
);

2129  
mu°_waô
;

2130 
	}
}

2136 
	sdm_‹igö
 {

2137 
dm_dev
 *
	mdev
;

2138 
	m•lô_bound¨y
;

2146 
	$‹igö_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

2148 
r
;

2149 
dm_‹igö
 *
o
;

2151 i‡(
¨gc
 != 1) {

2152 
ti
->
îr‹
 = "origin: incorrectÇumber ofárguments";

2153  -
EINVAL
;

2156 
o
 = 
	`kmÆloc
((
dm_‹igö
), 
GFP_KERNEL
);

2157 i‡(!
o
) {

2158 
ti
->
îr‹
 = "CannotállocateÖrivate origin structure";

2159 
r
 = -
ENOMEM
;

2160 
bad_Æloc
;

2163 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
o
->
dev
);

2164 i‡(
r
) {

2165 
ti
->
îr‹
 = "Cannot getÅarget device";

2166 
bad_›í
;

2169 
ti
->
¥iv©e
 = 
o
;

2170 
ti
->
num_Êush_bios
 = 1;

2174 
bad_›í
:

2175 
	`k‰ì
(
o
);

2176 
bad_Æloc
:

2177  
r
;

2178 
	}
}

2180 
	$‹igö_då
(
dm_èrgë
 *
ti
)

2182 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2183 
	`dm_put_devi˚
(
ti
, 
o
->
dev
);

2184 
	`k‰ì
(
o
);

2185 
	}
}

2187 
	$‹igö_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

2189 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2190 
avaûabÀ_£˘‹s
;

2192 
bio
->
bi_bdev
 = 
o
->
dev
->
bdev
;

2194 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_FLUSH
))

2195  
DM_MAPIO_REMAPPED
;

2197 i‡(
	`bio_rw
(
bio
Ë!
WRITE
)

2198  
DM_MAPIO_REMAPPED
;

2200 
avaûabÀ_£˘‹s
 = 
o
->
•lô_bound¨y
 -

2201 (()
bio
->
bi_ôî
.
bi_£˘‹
 & (
o
->
•lô_bound¨y
 - 1));

2203 i‡(
	`bio_£˘‹s
(
bio
Ë> 
avaûabÀ_£˘‹s
)

2204 
	`dm_ac˚±_∑πül_bio
(
bio
, 
avaûabÀ_£˘‹s
);

2207  
	`do_‹igö
(
o
->
dev
, 
bio
);

2208 
	}
}

2214 
	$‹igö_ªsume
(
dm_èrgë
 *
ti
)

2216 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2218 
o
->
•lô_bound¨y
 = 
	`gë_‹igö_möimum_chunksize
(o->
dev
->
bdev
);

2219 
	}
}

2221 
	$‹igö_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

2222 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

2224 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2226 
ty≥
) {

2227 
STATUSTYPE_INFO
:

2228 
ªsu…
[0] = '\0';

2231 
STATUSTYPE_TABLE
:

2232 
	`¢¥ötf
(
ªsu…
, 
maxÀn
, "%s", 
o
->
dev
->
«me
);

2235 
	}
}

2237 
	$‹igö_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

2238 
bio_vec
 *
biovec
, 
max_size
)

2240 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2241 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
o
->
dev
->
bdev
);

2243 i‡(!
q
->
mîge_bvec_‚
)

2244  
max_size
;

2246 
bvm
->
bi_bdev
 = 
o
->
dev
->
bdev
;

2248  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

2249 
	}
}

2251 
	$‹igö_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

2252 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

2254 
dm_‹igö
 *
o
 = 
ti
->
¥iv©e
;

2256  
	`‚
(
ti
, 
o
->
dev
, 0,Åi->
Àn
, 
d©a
);

2257 
	}
}

2259 
èrgë_ty≥
 
	g‹igö_èrgë
 = {

2260 .
«me
 = "snapshot-origin",

2261 .
	gvîsi⁄
 = {1, 8, 1},

2262 .
	gmoduÀ
 = 
THIS_MODULE
,

2263 .
	g˘r
 = 
‹igö_˘r
,

2264 .
	gdå
 = 
‹igö_då
,

2265 .
	gm≠
 = 
‹igö_m≠
,

2266 .
	gªsume
 = 
‹igö_ªsume
,

2267 .
	g°©us
 = 
‹igö_°©us
,

2268 .
	gmîge
 = 
‹igö_mîge
,

2269 .
	gôî©e_devi˚s
 = 
‹igö_ôî©e_devi˚s
,

2272 
èrgë_ty≥
 
	g¢≠shŸ_èrgë
 = {

2273 .
«me
 = "snapshot",

2274 .
	gvîsi⁄
 = {1, 12, 0},

2275 .
	gmoduÀ
 = 
THIS_MODULE
,

2276 .
	g˘r
 = 
¢≠shŸ_˘r
,

2277 .
	gdå
 = 
¢≠shŸ_då
,

2278 .
	gm≠
 = 
¢≠shŸ_m≠
,

2279 .
	gíd_io
 = 
¢≠shŸ_íd_io
,

2280 .
	g¥îesume
 = 
¢≠shŸ_¥îesume
,

2281 .
	gªsume
 = 
¢≠shŸ_ªsume
,

2282 .
	g°©us
 = 
¢≠shŸ_°©us
,

2283 .
	gôî©e_devi˚s
 = 
¢≠shŸ_ôî©e_devi˚s
,

2286 
èrgë_ty≥
 
	gmîge_èrgë
 = {

2287 .
«me
 = 
dm_¢≠shŸ_mîge_èrgë_«me
,

2288 .
	gvîsi⁄
 = {1, 2, 0},

2289 .
	gmoduÀ
 = 
THIS_MODULE
,

2290 .
	g˘r
 = 
¢≠shŸ_˘r
,

2291 .
	gdå
 = 
¢≠shŸ_då
,

2292 .
	gm≠
 = 
¢≠shŸ_mîge_m≠
,

2293 .
	gíd_io
 = 
¢≠shŸ_íd_io
,

2294 .
	g¥esu•íd
 = 
¢≠shŸ_mîge_¥esu•íd
,

2295 .
	g¥îesume
 = 
¢≠shŸ_¥îesume
,

2296 .
	gªsume
 = 
¢≠shŸ_mîge_ªsume
,

2297 .
	g°©us
 = 
¢≠shŸ_°©us
,

2298 .
	gôî©e_devi˚s
 = 
¢≠shŸ_ôî©e_devi˚s
,

2301 
__öô
 
	$dm_¢≠shŸ_öô
()

2303 
r
;

2305 
r
 = 
	`dm_ex˚±i⁄_°‹e_öô
();

2306 i‡(
r
) {

2307 
	`DMERR
("FailedÅo initializeÉxception stores");

2308  
r
;

2311 
r
 = 
	`dm_ªgi°î_èrgë
(&
¢≠shŸ_èrgë
);

2312 i‡(
r
 < 0) {

2313 
	`DMERR
("¢≠shŸÅ¨gëÑegi°î faûed %d", 
r
);

2314 
bad_ªgi°î_¢≠shŸ_èrgë
;

2317 
r
 = 
	`dm_ªgi°î_èrgë
(&
‹igö_èrgë
);

2318 i‡(
r
 < 0) {

2319 
	`DMERR
("OrigöÅ¨gëÑegi°î faûed %d", 
r
);

2320 
bad_ªgi°î_‹igö_èrgë
;

2323 
r
 = 
	`dm_ªgi°î_èrgë
(&
mîge_èrgë
);

2324 i‡(
r
 < 0) {

2325 
	`DMERR
("MîgêèrgëÑegi°î faûed %d", 
r
);

2326 
bad_ªgi°î_mîge_èrgë
;

2329 
r
 = 
	`öô_‹igö_hash
();

2330 i‡(
r
) {

2331 
	`DMERR
("init_origin_hash failed.");

2332 
bad_‹igö_hash
;

2335 
ex˚±i⁄_ˇche
 = 
	`KMEM_CACHE
(
dm_ex˚±i⁄
, 0);

2336 i‡(!
ex˚±i⁄_ˇche
) {

2337 
	`DMERR
("Couldn't createÉxception cache.");

2338 
r
 = -
ENOMEM
;

2339 
bad_ex˚±i⁄_ˇche
;

2342 
≥ndög_ˇche
 = 
	`KMEM_CACHE
(
dm_¢≠_≥ndög_ex˚±i⁄
, 0);

2343 i‡(!
≥ndög_ˇche
) {

2344 
	`DMERR
("Couldn't createÖending cache.");

2345 
r
 = -
ENOMEM
;

2346 
bad_≥ndög_ˇche
;

2351 
bad_≥ndög_ˇche
:

2352 
	`kmem_ˇche_de°roy
(
ex˚±i⁄_ˇche
);

2353 
bad_ex˚±i⁄_ˇche
:

2354 
	`exô_‹igö_hash
();

2355 
bad_‹igö_hash
:

2356 
	`dm_uƒegi°î_èrgë
(&
mîge_èrgë
);

2357 
bad_ªgi°î_mîge_èrgë
:

2358 
	`dm_uƒegi°î_èrgë
(&
‹igö_èrgë
);

2359 
bad_ªgi°î_‹igö_èrgë
:

2360 
	`dm_uƒegi°î_èrgë
(&
¢≠shŸ_èrgë
);

2361 
bad_ªgi°î_¢≠shŸ_èrgë
:

2362 
	`dm_ex˚±i⁄_°‹e_exô
();

2364  
r
;

2365 
	}
}

2367 
__exô
 
	$dm_¢≠shŸ_exô
()

2369 
	`dm_uƒegi°î_èrgë
(&
¢≠shŸ_èrgë
);

2370 
	`dm_uƒegi°î_èrgë
(&
‹igö_èrgë
);

2371 
	`dm_uƒegi°î_èrgë
(&
mîge_èrgë
);

2373 
	`exô_‹igö_hash
();

2374 
	`kmem_ˇche_de°roy
(
≥ndög_ˇche
);

2375 
	`kmem_ˇche_de°roy
(
ex˚±i⁄_ˇche
);

2377 
	`dm_ex˚±i⁄_°‹e_exô
();

2378 
	}
}

2381 
moduÀ_öô
(
dm_¢≠shŸ_öô
);

2382 
moduÀ_exô
(
dm_¢≠shŸ_exô
);

2384 
MODULE_DESCRIPTION
(
DM_NAME
 " snapshotÅarget");

2385 
MODULE_AUTHOR
("Joe Thornber");

2386 
MODULE_LICENSE
("GPL");

2387 
MODULE_ALIAS
("dm-snapshot-origin");

2388 
MODULE_ALIAS
("dm-snapshot-merge");

	@dm-snapshot.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

24 { 0x402b8281, 
__VMLINUX_SYMBOL_STR
(
__ªque°_moduÀ
) },

25 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

26 { 0xf9a482f9, 
__VMLINUX_SYMBOL_STR
(
m¶ìp
) },

27 { 0x268682d2, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_f‹gë
) },

28 { 0x5876c094, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

29 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

30 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

31 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

32 { 0xa0fbac79, 
__VMLINUX_SYMBOL_STR
(
wake_up_bô
) },

33 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

34 { 0x2b5a58a3, 
__VMLINUX_SYMBOL_STR
(
dm_io
) },

35 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

36 { 0x9c256008, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_devi˚_size
) },

37 { 0x72f07bf4, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_£t_möimum_buf„rs
) },

38 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

39 { 0x154c6338, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_de°roy
) },

40 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

41 { 0xc79bcd36, 
__VMLINUX_SYMBOL_STR
(
dm_vˇŒoc
) },

42 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

43 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

44 { 0xeˇb91e1, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_c›y
) },

45 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

46 { 0xf96cc7e, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

47 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

48 { 0x9e4Áìf, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_de°roy
) },

49 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

50 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

51 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

52 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

53 { 0x11089ac7, 
__VMLINUX_SYMBOL_STR
(
_˘y≥
) },

54 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

55 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

56 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

57 { 0xe6024e59, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªÀa£
) },

58 { 0x486e239f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_¸óã
) },

59 { 0x5406d4ec, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_‰ì
) },

60 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

61 { 0x960f071e, 
__VMLINUX_SYMBOL_STR
(
dm_su•íded
) },

62 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

63 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

64 { 0x6e5db7e4, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

65 { 0x2ed55c8e, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

66 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

67 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

68 { 0xeˇ7949e, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_de°roy
) },

69 { 0xbe0498f3, 
__VMLINUX_SYMBOL_STR
(
moduÀ_put
) },

70 { 0x5c2b866, 
__VMLINUX_SYMBOL_STR
(
bô_waô
) },

71 { 0x9f984513, 
__VMLINUX_SYMBOL_STR
(
°ºchr
) },

72 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vzÆloc
) },

73 { 0xc4d6c774, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc
) },

74 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

75 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

76 { 0xde942Á0, 
__VMLINUX_SYMBOL_STR
(
dm_ac˚±_∑πül_bio
) },

77 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

78 { 0xd688716b, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_¸óã
) },

79 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

80 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

81 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

82 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

83 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

84 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

85 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

86 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

87 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

88 { 0x2cˇbb5b, 
__VMLINUX_SYMBOL_STR
(
out_of_löe_waô_⁄_bô
) },

89 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

90 { 0x601f665f, 
__VMLINUX_SYMBOL_STR
(
dm_io_˛õ¡_¸óã
) },

91 { 0xa1d2413a, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªad
) },

92 { 0x7880c781, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_¥ï¨e_ˇŒback
) },

93 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

94 { 0x69ad2f20, 
__VMLINUX_SYMBOL_STR
(
k°πouöt
) },

95 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

96 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

97 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

98 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

99 { 0xa448e19f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_¥e„tch
) },

100 { 0x99d3a43c, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_size
) },

101 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

102 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

103 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢¥ötf
) },

104 { 0x4b5fd49e, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_do_ˇŒback
) },

105 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

106 { 0xa88bd3e3, 
__VMLINUX_SYMBOL_STR
(
__öô_rw£m
) },

107 { 0x8ó31722, 
__VMLINUX_SYMBOL_STR
(
åy_moduÀ_gë
) },

110 c⁄° 
	g__moduÀ_dïíds
[]

111 
__u£d


112 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

116 
MODULE_INFO
(
§cvîsi⁄
, "684DC27DBD677EAE83B97E9");

	@dm-stats.c

1 
	~<löux/î∫o.h
>

2 
	~<löux/numa.h
>

3 
	~<löux/¶ab.h
>

4 
	~<löux/rculi°.h
>

5 
	~<löux/thªads.h
>

6 
	~<löux/¥ìm±.h
>

7 
	~<löux/úqÊags.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/devi˚-m≠≥r.h
>

13 
	~"dm.h
"

14 
	~"dm-°©s.h
"

16 
	#DM_MSG_PREFIX
 "°©s"

	)

18 
	gdm_°©_√ed_rcu_b¨rõr
;

24 
	sdm_°©_≥r˝u
 {

25 
	m£˘‹s
[2];

26 
	mios
[2];

27 
	mmîges
[2];

28 
	mticks
[2];

29 
	mio_ticks
[2];

30 
	mio_ticks_tŸÆ
;

31 
	mtime_ö_queue
;

34 
	sdm_°©_sh¨ed
 {

35 
©omic_t
 
	mö_Êight
[2];

36 
	m°amp
;

37 
dm_°©_≥r˝u
 
	mtmp
;

40 
	sdm_°©
 {

41 
li°_hód
 
	mli°_íåy
;

42 
	mid
;

43 
size_t
 
	mn_íåõs
;

44 
£˘‹_t
 
	m°¨t
;

45 
£˘‹_t
 
	míd
;

46 
£˘‹_t
 
	m°ï
;

47 c⁄° *
	m¥ogøm_id
;

48 c⁄° *
	maux_d©a
;

49 
rcu_hód
 
	mrcu_hód
;

50 
size_t
 
	msh¨ed_Æloc_size
;

51 
size_t
 
	m≥r˝u_Æloc_size
;

52 
dm_°©_≥r˝u
 *
	m°©_≥r˝u
[
NR_CPUS
];

53 
dm_°©_sh¨ed
 
	m°©_sh¨ed
[0];

56 
	sdm_°©s_œ°_posôi⁄
 {

57 
£˘‹_t
 
	mœ°_£˘‹
;

58 
	mœ°_rw
;

66 
	#DM_STATS_MEMORY_FACTOR
 4

	)

67 
	#DM_STATS_VMALLOC_FACTOR
 2

	)

69 
DEFINE_SPINLOCK
(
sh¨ed_mem‹y_lock
);

71 
	gsh¨ed_mem‹y_amou¡
;

73 
boﬁ
 
	$__check_sh¨ed_mem‹y
(
size_t
 
Æloc_size
)

75 
size_t
 
a
;

77 
a
 = 
sh¨ed_mem‹y_amou¡
 + 
Æloc_size
;

78 i‡(
a
 < 
sh¨ed_mem‹y_amou¡
)

79  
Ál£
;

80 i‡(
a
 >> 
PAGE_SHIFT
 > 
tŸÆøm_∑ges
 / 
DM_STATS_MEMORY_FACTOR
)

81  
Ál£
;

82 #ifde‡
CONFIG_MMU


83 i‡(
a
 > (
VMALLOC_END
 - 
VMALLOC_START
Ë/ 
DM_STATS_VMALLOC_FACTOR
)

84  
Ál£
;

86  
åue
;

87 
	}
}

89 
boﬁ
 
	$check_sh¨ed_mem‹y
(
size_t
 
Æloc_size
)

91 
boﬁ
 
ªt
;

93 
	`•ö_lock_úq
(&
sh¨ed_mem‹y_lock
);

95 
ªt
 = 
	`__check_sh¨ed_mem‹y
(
Æloc_size
);

97 
	`•ö_u∆ock_úq
(&
sh¨ed_mem‹y_lock
);

99  
ªt
;

100 
	}
}

102 
boﬁ
 
	$˛aim_sh¨ed_mem‹y
(
size_t
 
Æloc_size
)

104 
	`•ö_lock_úq
(&
sh¨ed_mem‹y_lock
);

106 i‡(!
	`__check_sh¨ed_mem‹y
(
Æloc_size
)) {

107 
	`•ö_u∆ock_úq
(&
sh¨ed_mem‹y_lock
);

108  
Ál£
;

111 
sh¨ed_mem‹y_amou¡
 +
Æloc_size
;

113 
	`•ö_u∆ock_úq
(&
sh¨ed_mem‹y_lock
);

115  
åue
;

116 
	}
}

118 
	$‰ì_sh¨ed_mem‹y
(
size_t
 
Æloc_size
)

120 
Êags
;

122 
	`•ö_lock_úqßve
(&
sh¨ed_mem‹y_lock
, 
Êags
);

124 i‡(
	`WARN_ON_ONCE
(
sh¨ed_mem‹y_amou¡
 < 
Æloc_size
)) {

125 
	`•ö_u∆ock_úqª°‹e
(&
sh¨ed_mem‹y_lock
, 
Êags
);

126 
	`DMCRIT
("Memory usageáccounting bug.");

130 
sh¨ed_mem‹y_amou¡
 -
Æloc_size
;

132 
	`•ö_u∆ock_úqª°‹e
(&
sh¨ed_mem‹y_lock
, 
Êags
);

133 
	}
}

135 *
	$dm_kvzÆloc
(
size_t
 
Æloc_size
, 
node
)

137 *
p
;

139 i‡(!
	`˛aim_sh¨ed_mem‹y
(
Æloc_size
))

140  
NULL
;

142 i‡(
Æloc_size
 <
KMALLOC_MAX_SIZE
) {

143 
p
 = 
	`kzÆloc_node
(
Æloc_size
, 
GFP_KERNEL
 | 
__GFP_NORETRY
 | 
__GFP_NOMEMALLOC
 | 
__GFP_NOWARN
, 
node
);

144 i‡(
p
)

145  
p
;

147 
p
 = 
	`vzÆloc_node
(
Æloc_size
, 
node
);

148 i‡(
p
)

149  
p
;

151 
	`‰ì_sh¨ed_mem‹y
(
Æloc_size
);

153  
NULL
;

154 
	}
}

156 
	$dm_kv‰ì
(*
±r
, 
size_t
 
Æloc_size
)

158 i‡(!
±r
)

161 
	`‰ì_sh¨ed_mem‹y
(
Æloc_size
);

163 i‡(
	`is_vmÆloc_addr
(
±r
))

164 
	`v‰ì
(
±r
);

166 
	`k‰ì
(
±r
);

167 
	}
}

169 
	$dm_°©_‰ì
(
rcu_hód
 *
hód
)

171 
˝u
;

172 
dm_°©
 *
s
 = 
	`c⁄èöî_of
(
hód
, dm_°©, 
rcu_hód
);

174 
	`k‰ì
(
s
->
¥ogøm_id
);

175 
	`k‰ì
(
s
->
aux_d©a
);

176 
	`f‹_óch_possibÀ_˝u
(
˝u
)

177 
	`dm_kv‰ì
(
s
->
°©_≥r˝u
[
˝u
], s->
≥r˝u_Æloc_size
);

178 
	`dm_kv‰ì
(
s
, s->
sh¨ed_Æloc_size
);

179 
	}
}

181 
	$dm_°©_ö_Êight
(
dm_°©_sh¨ed
 *
sh¨ed
)

183  
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
READ
]) +

184 
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
WRITE
]);

185 
	}
}

187 
	$dm_°©s_öô
(
dm_°©s
 *
°©s
)

189 
˝u
;

190 
dm_°©s_œ°_posôi⁄
 *
œ°
;

192 
	`muãx_öô
(&
°©s
->
muãx
);

193 
	`INIT_LIST_HEAD
(&
°©s
->
li°
);

194 
°©s
->
œ°
 = 
	`Æloc_≥r˝u
(
dm_°©s_œ°_posôi⁄
);

195 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

196 
œ°
 = 
	`≥r_˝u_±r
(
°©s
->œ°, 
˝u
);

197 
œ°
->
œ°_£˘‹
 = (
£˘‹_t
)
ULLONG_MAX
;

198 
œ°
->
œ°_rw
 = 
UINT_MAX
;

200 
	}
}

202 
	$dm_°©s_˛ónup
(
dm_°©s
 *
°©s
)

204 
size_t
 
ni
;

205 
dm_°©
 *
s
;

206 
dm_°©_sh¨ed
 *
sh¨ed
;

208 !
	`li°_em±y
(&
°©s
->
li°
)) {

209 
s
 = 
	`c⁄èöî_of
(
°©s
->
li°
.
√xt
, 
dm_°©
, 
li°_íåy
);

210 
	`li°_dñ
(&
s
->
li°_íåy
);

211 
ni
 = 0;Çò< 
s
->
n_íåõs
;Çi++) {

212 
sh¨ed
 = &
s
->
°©_sh¨ed
[
ni
];

213 i‡(
	`WARN_ON
(
	`dm_°©_ö_Êight
(
sh¨ed
))) {

214 
	`DMCRIT
("leaked in-flight counterát index %lu "

216 ()
ni
,

217 ()
s
->
°¨t
,

218 ()
s
->
íd
,

219 ()
s
->
°ï
,

220 
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
READ
]),

221 
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
WRITE
]));

224 
	`dm_°©_‰ì
(&
s
->
rcu_hód
);

226 
	`‰ì_≥r˝u
(
°©s
->
œ°
);

227 
	}
}

229 
dm_°©s_¸óã
(
dm_°©s
 *
°©s
, 
£˘‹_t
 
°¨t
, se˘‹_à
íd
,

230 
£˘‹_t
 
°ï
, c⁄° *
¥ogøm_id
, c⁄° *
aux_d©a
,

231 (*
su•íd_ˇŒback
)(
m≠≥d_devi˚
 *),

232 (*
ªsume_ˇŒback
)(
m≠≥d_devi˚
 *),

233 
m≠≥d_devi˚
 *
md
)

235 
li°_hód
 *
l
;

236 
dm_°©
 *
s
, *
tmp_s
;

237 
£˘‹_t
 
n_íåõs
;

238 
size_t
 
ni
;

239 
size_t
 
sh¨ed_Æloc_size
;

240 
size_t
 
≥r˝u_Æloc_size
;

241 
dm_°©_≥r˝u
 *
p
;

242 
˝u
;

243 
ªt_id
;

244 
r
;

246 i‡(
íd
 < 
°¨t
 || !
°ï
)

247  -
EINVAL
;

249 
n_íåõs
 = 
íd
 - 
°¨t
;

250 i‡(
	`dm_£˘‹_div64
(
n_íåõs
, 
°ï
))

251 
n_íåõs
++;

253 i‡(
n_íåõs
 !(
size_t
)n_entries || !(size_t)(n_entries + 1))

254  -
EOVERFLOW
;

256 
sh¨ed_Æloc_size
 = (
dm_°©
Ë+ (
size_t
)
n_íåõs
 * (
dm_°©_sh¨ed
);

257 i‡((
sh¨ed_Æloc_size
 - (
dm_°©
)Ë/ (
dm_°©_sh¨ed
Ë!
n_íåõs
)

258  -
EOVERFLOW
;

260 
≥r˝u_Æloc_size
 = (
size_t
)
n_íåõs
 * (
dm_°©_≥r˝u
);

261 i‡(
≥r˝u_Æloc_size
 / (
dm_°©_≥r˝u
Ë!
n_íåõs
)

262  -
EOVERFLOW
;

264 i‡(!
	`check_sh¨ed_mem‹y
(
sh¨ed_Æloc_size
 + 
	`num_possibÀ_˝us
(Ë* 
≥r˝u_Æloc_size
))

265  -
ENOMEM
;

267 
s
 = 
	`dm_kvzÆloc
(
sh¨ed_Æloc_size
, 
NUMA_NO_NODE
);

268 i‡(!
s
)

269  -
ENOMEM
;

271 
s
->
n_íåõs
 =Ç_entries;

272 
s
->
°¨t
 = start;

273 
s
->
íd
 =Énd;

274 
s
->
°ï
 = step;

275 
s
->
sh¨ed_Æloc_size
 = shared_alloc_size;

276 
s
->
≥r˝u_Æloc_size
 =Öercpu_alloc_size;

278 
s
->
¥ogøm_id
 = 
	`k°rdup
’rogøm_id, 
GFP_KERNEL
);

279 i‡(!
s
->
¥ogøm_id
) {

280 
r
 = -
ENOMEM
;

281 
out
;

283 
s
->
aux_d©a
 = 
	`k°rdup
◊ux_d©a, 
GFP_KERNEL
);

284 i‡(!
s
->
aux_d©a
) {

285 
r
 = -
ENOMEM
;

286 
out
;

289 
ni
 = 0;Çò< 
n_íåõs
;Çi++) {

290 
	`©omic_£t
(&
s
->
°©_sh¨ed
[
ni
].
ö_Êight
[
READ
], 0);

291 
	`©omic_£t
(&
s
->
°©_sh¨ed
[
ni
].
ö_Êight
[
WRITE
], 0);

294 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

295 
p
 = 
	`dm_kvzÆloc
(
≥r˝u_Æloc_size
, 
	`˝u_to_node
(
˝u
));

296 i‡(!
p
) {

297 
r
 = -
ENOMEM
;

298 
out
;

300 
s
->
°©_≥r˝u
[
˝u
] = 
p
;

310 
	`su•íd_ˇŒback
(
md
);

312 
	`muãx_lock
(&
°©s
->
muãx
);

313 
s
->
id
 = 0;

314 
	`li°_f‹_óch
(
l
, &
°©s
->
li°
) {

315 
tmp_s
 = 
	`c⁄èöî_of
(
l
, 
dm_°©
, 
li°_íåy
);

316 i‡(
	`WARN_ON
(
tmp_s
->
id
 < 
s
->id)) {

317 
r
 = -
EINVAL
;

318 
out_u∆ock_ªsume
;

320 i‡(
tmp_s
->
id
 > 
s
->id)

322 i‡(
	`u∆ikñy
(
s
->
id
 =
INT_MAX
)) {

323 
r
 = -
ENFILE
;

324 
out_u∆ock_ªsume
;

326 
s
->
id
++;

328 
ªt_id
 = 
s
->
id
;

329 
	`li°_add_èû_rcu
(&
s
->
li°_íåy
, 
l
);

330 
	`muãx_u∆ock
(&
°©s
->
muãx
);

332 
	`ªsume_ˇŒback
(
md
);

334  
ªt_id
;

336 
out_u∆ock_ªsume
:

337 
	`muãx_u∆ock
(&
°©s
->
muãx
);

338 
	`ªsume_ˇŒback
(
md
);

339 
out
:

340 
	`dm_°©_‰ì
(&
s
->
rcu_hód
);

341  
r
;

342 
	}
}

344 
dm_°©
 *
	$__dm_°©s_föd
(
dm_°©s
 *
°©s
, 
id
)

346 
dm_°©
 *
s
;

348 
	`li°_f‹_óch_íåy
(
s
, &
°©s
->
li°
, 
li°_íåy
) {

349 i‡(
s
->
id
 > id)

351 i‡(
s
->
id
 == id)

352  
s
;

355  
NULL
;

356 
	}
}

358 
	$dm_°©s_dñëe
(
dm_°©s
 *
°©s
, 
id
)

360 
dm_°©
 *
s
;

361 
˝u
;

363 
	`muãx_lock
(&
°©s
->
muãx
);

365 
s
 = 
	`__dm_°©s_föd
(
°©s
, 
id
);

366 i‡(!
s
) {

367 
	`muãx_u∆ock
(&
°©s
->
muãx
);

368  -
ENOENT
;

371 
	`li°_dñ_rcu
(&
s
->
li°_íåy
);

372 
	`muãx_u∆ock
(&
°©s
->
muãx
);

377 
	`f‹_óch_possibÀ_˝u
(
˝u
)

378 i‡(
	`is_vmÆloc_addr
(
s
->
°©_≥r˝u
))

379 
do_sync_‰ì
;

380 i‡(
	`is_vmÆloc_addr
(
s
)) {

381 
do_sync_‰ì
:

382 
	`synchr⁄ize_rcu_ex≥dôed
();

383 
	`dm_°©_‰ì
(&
s
->
rcu_hód
);

385 
	`ACCESS_ONCE
(
dm_°©_√ed_rcu_b¨rõr
) = 1;

386 
	`ˇŒ_rcu
(&
s
->
rcu_hód
, 
dm_°©_‰ì
);

389 
	}
}

391 
	$dm_°©s_li°
(
dm_°©s
 *
°©s
, c⁄° *
¥ogøm
,

392 *
ªsu…
, 
maxÀn
)

394 
dm_°©
 *
s
;

395 
£˘‹_t
 
Àn
;

396 
sz
 = 0;

403 
	`muãx_lock
(&
°©s
->
muãx
);

404 
	`li°_f‹_óch_íåy
(
s
, &
°©s
->
li°
, 
li°_íåy
) {

405 i‡(!
¥ogøm
 || !
	`°rcmp
’rogøm, 
s
->
¥ogøm_id
)) {

406 
Àn
 = 
s
->
íd
 - s->
°¨t
;

407 
	`DMEMIT
("%d: %Œu+%Œu %Œu %†%s\n", 
s
->
id
,

408 ()
s
->
°¨t
,

409 ()
Àn
,

410 ()
s
->
°ï
,

411 
s
->
¥ogøm_id
,

412 
s
->
aux_d©a
);

415 
	`muãx_u∆ock
(&
°©s
->
muãx
);

418 
	}
}

420 
	$dm_°©_round
(
dm_°©_sh¨ed
 *
sh¨ed
, 
dm_°©_≥r˝u
 *
p
)

425 
now
 = 
jiffõs
;

426 
ö_Êight_ªad
;

427 
ö_Êight_wrôe
;

428 
dif„ªn˚
 = 
now
 - 
sh¨ed
->
°amp
;

430 i‡(!
dif„ªn˚
)

432 
ö_Êight_ªad
 = ()
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
READ
]);

433 
ö_Êight_wrôe
 = ()
	`©omic_ªad
(&
sh¨ed
->
ö_Êight
[
WRITE
]);

434 i‡(
ö_Êight_ªad
)

435 
p
->
io_ticks
[
READ
] +
dif„ªn˚
;

436 i‡(
ö_Êight_wrôe
)

437 
p
->
io_ticks
[
WRITE
] +
dif„ªn˚
;

438 i‡(
ö_Êight_ªad
 + 
ö_Êight_wrôe
) {

439 
p
->
io_ticks_tŸÆ
 +
dif„ªn˚
;

440 
p
->
time_ö_queue
 +(
ö_Êight_ªad
 + 
ö_Êight_wrôe
Ë* 
dif„ªn˚
;

442 
sh¨ed
->
°amp
 = 
now
;

443 
	}
}

445 
	$dm_°©_f‹_íåy
(
dm_°©
 *
s
, 
size_t
 
íåy
,

446 
bi_rw
, 
£˘‹_t
 
Àn
, 
boﬁ
 
mîged
,

447 
boﬁ
 
íd
, 
duøti⁄
)

449 
idx
 = 
bi_rw
 & 
REQ_WRITE
;

450 
dm_°©_sh¨ed
 *
sh¨ed
 = &
s
->
°©_sh¨ed
[
íåy
];

451 
dm_°©_≥r˝u
 *
p
;

468 #i‡
BITS_PER_LONG
 == 32

469 
Êags
;

470 
	`loˇl_úq_ßve
(
Êags
);

472 
	`¥ìm±_dißbÀ
();

474 
p
 = &
s
->
°©_≥r˝u
[
	`smp_¥o˚ss‹_id
()][
íåy
];

476 i‡(!
íd
) {

477 
	`dm_°©_round
(
sh¨ed
, 
p
);

478 
	`©omic_öc
(&
sh¨ed
->
ö_Êight
[
idx
]);

480 
	`dm_°©_round
(
sh¨ed
, 
p
);

481 
	`©omic_dec
(&
sh¨ed
->
ö_Êight
[
idx
]);

482 
p
->
£˘‹s
[
idx
] +
Àn
;

483 
p
->
ios
[
idx
] += 1;

484 
p
->
mîges
[
idx
] +
mîged
;

485 
p
->
ticks
[
idx
] +
duøti⁄
;

488 #i‡
BITS_PER_LONG
 == 32

489 
	`loˇl_úq_ª°‹e
(
Êags
);

491 
	`¥ìm±_íabÀ
();

493 
	}
}

495 
	$__dm_°©_bio
(
dm_°©
 *
s
, 
bi_rw
,

496 
£˘‹_t
 
bi_£˘‹
, se˘‹_à
íd_£˘‹
,

497 
boﬁ
 
íd
, 
duøti⁄
,

498 
dm_°©s_aux
 *
°©s_aux
)

500 
£˘‹_t
 
ªl_£˘‹
, 
off£t
, 
todo
, 
‰agmít_Àn
;

501 
size_t
 
íåy
;

503 i‡(
íd_£˘‹
 <
s
->
°¨t
 || 
bi_£˘‹
 >s->
íd
)

505 i‡(
	`u∆ikñy
(
bi_£˘‹
 < 
s
->
°¨t
)) {

506 
ªl_£˘‹
 = 0;

507 
todo
 = 
íd_£˘‹
 - 
s
->
°¨t
;

509 
ªl_£˘‹
 = 
bi_£˘‹
 - 
s
->
°¨t
;

510 
todo
 = 
íd_£˘‹
 - 
bi_£˘‹
;

512 i‡(
	`u∆ikñy
(
íd_£˘‹
 > 
s
->
íd
))

513 
todo
 -(
íd_£˘‹
 - 
s
->
íd
);

515 
off£t
 = 
	`dm_£˘‹_div64
(
ªl_£˘‹
, 
s
->
°ï
);

516 
íåy
 = 
ªl_£˘‹
;

518 i‡(
	`WARN_ON_ONCE
(
íåy
 >
s
->
n_íåõs
)) {

519 
	`DMCRIT
("InvÆidáª®ac˚s†öÑegi⁄ id %d", 
s
->
id
);

522 
‰agmít_Àn
 = 
todo
;

523 i‡(
‰agmít_Àn
 > 
s
->
°ï
 - 
off£t
)

524 
‰agmít_Àn
 = 
s
->
°ï
 - 
off£t
;

525 
	`dm_°©_f‹_íåy
(
s
, 
íåy
, 
bi_rw
, 
‰agmít_Àn
,

526 
°©s_aux
->
mîged
, 
íd
, 
duøti⁄
);

527 
todo
 -
‰agmít_Àn
;

528 
íåy
++;

529 
off£t
 = 0;

530 } 
	`u∆ikñy
(
todo
 != 0));

531 
	}
}

533 
	$dm_°©s_accou¡_io
(
dm_°©s
 *
°©s
, 
bi_rw
,

534 
£˘‹_t
 
bi_£˘‹
, 
bi_£˘‹s
, 
boﬁ
 
íd
,

535 
duøti⁄
, 
dm_°©s_aux
 *
°©s_aux
)

537 
dm_°©
 *
s
;

538 
£˘‹_t
 
íd_£˘‹
;

539 
dm_°©s_œ°_posôi⁄
 *
œ°
;

541 i‡(
	`u∆ikñy
(!
bi_£˘‹s
))

544 
íd_£˘‹
 = 
bi_£˘‹
 + 
bi_£˘‹s
;

546 i‡(!
íd
) {

551 
œ°
 = 
	`__this_˝u_±r
(
°©s
->last);

552 
°©s_aux
->
mîged
 =

553 (
bi_£˘‹
 =(
	`ACCESS_ONCE
(
œ°
->
œ°_£˘‹
) &&

554 ((
bi_rw
 & (
REQ_WRITE
 | 
REQ_DISCARD
)) ==

555 (
	`ACCESS_ONCE
(
œ°
->
œ°_rw
Ë& (
REQ_WRITE
 | 
REQ_DISCARD
)))

557 
	`ACCESS_ONCE
(
œ°
->
œ°_£˘‹
Ë
íd_£˘‹
;

558 
	`ACCESS_ONCE
(
œ°
->
œ°_rw
Ë
bi_rw
;

561 
	`rcu_ªad_lock
();

563 
	`li°_f‹_óch_íåy_rcu
(
s
, &
°©s
->
li°
, 
li°_íåy
)

564 
	`__dm_°©_bio
(
s
, 
bi_rw
, 
bi_£˘‹
, 
íd_£˘‹
, 
íd
, 
duøti⁄
, 
°©s_aux
);

566 
	`rcu_ªad_u∆ock
();

567 
	}
}

569 
	$__dm_°©_öô_ãmp‹¨y_≥r˝u_tŸÆs
(
dm_°©_sh¨ed
 *
sh¨ed
,

570 
dm_°©
 *
s
, 
size_t
 
x
)

572 
˝u
;

573 
dm_°©_≥r˝u
 *
p
;

575 
	`loˇl_úq_dißbÀ
();

576 
p
 = &
s
->
°©_≥r˝u
[
	`smp_¥o˚ss‹_id
()][
x
];

577 
	`dm_°©_round
(
sh¨ed
, 
p
);

578 
	`loˇl_úq_íabÀ
();

580 
	`mem£t
(&
sh¨ed
->
tmp
, 0, (shared->tmp));

581 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

582 
p
 = &
s
->
°©_≥r˝u
[
˝u
][
x
];

583 
sh¨ed
->
tmp
.
£˘‹s
[
READ
] +
	`ACCESS_ONCE
(
p
->sectors[READ]);

584 
sh¨ed
->
tmp
.
£˘‹s
[
WRITE
] +
	`ACCESS_ONCE
(
p
->sectors[WRITE]);

585 
sh¨ed
->
tmp
.
ios
[
READ
] +
	`ACCESS_ONCE
(
p
->ios[READ]);

586 
sh¨ed
->
tmp
.
ios
[
WRITE
] +
	`ACCESS_ONCE
(
p
->ios[WRITE]);

587 
sh¨ed
->
tmp
.
mîges
[
READ
] +
	`ACCESS_ONCE
(
p
->merges[READ]);

588 
sh¨ed
->
tmp
.
mîges
[
WRITE
] +
	`ACCESS_ONCE
(
p
->merges[WRITE]);

589 
sh¨ed
->
tmp
.
ticks
[
READ
] +
	`ACCESS_ONCE
(
p
->ticks[READ]);

590 
sh¨ed
->
tmp
.
ticks
[
WRITE
] +
	`ACCESS_ONCE
(
p
->ticks[WRITE]);

591 
sh¨ed
->
tmp
.
io_ticks
[
READ
] +
	`ACCESS_ONCE
(
p
->io_ticks[READ]);

592 
sh¨ed
->
tmp
.
io_ticks
[
WRITE
] +
	`ACCESS_ONCE
(
p
->io_ticks[WRITE]);

593 
sh¨ed
->
tmp
.
io_ticks_tŸÆ
 +
	`ACCESS_ONCE
(
p
->io_ticks_total);

594 
sh¨ed
->
tmp
.
time_ö_queue
 +
	`ACCESS_ONCE
(
p
->time_in_queue);

596 
	}
}

598 
	$__dm_°©_˛ór
(
dm_°©
 *
s
, 
size_t
 
idx_°¨t
, size_à
idx_íd
,

599 
boﬁ
 
öô_tmp_≥r˝u_tŸÆs
)

601 
size_t
 
x
;

602 
dm_°©_sh¨ed
 *
sh¨ed
;

603 
dm_°©_≥r˝u
 *
p
;

605 
x
 = 
idx_°¨t
; x < 
idx_íd
; x++) {

606 
sh¨ed
 = &
s
->
°©_sh¨ed
[
x
];

607 i‡(
öô_tmp_≥r˝u_tŸÆs
)

608 
	`__dm_°©_öô_ãmp‹¨y_≥r˝u_tŸÆs
(
sh¨ed
, 
s
, 
x
);

609 
	`loˇl_úq_dißbÀ
();

610 
p
 = &
s
->
°©_≥r˝u
[
	`smp_¥o˚ss‹_id
()][
x
];

611 
p
->
£˘‹s
[
READ
] -
sh¨ed
->
tmp
.sectors[READ];

612 
p
->
£˘‹s
[
WRITE
] -
sh¨ed
->
tmp
.sectors[WRITE];

613 
p
->
ios
[
READ
] -
sh¨ed
->
tmp
.ios[READ];

614 
p
->
ios
[
WRITE
] -
sh¨ed
->
tmp
.ios[WRITE];

615 
p
->
mîges
[
READ
] -
sh¨ed
->
tmp
.merges[READ];

616 
p
->
mîges
[
WRITE
] -
sh¨ed
->
tmp
.merges[WRITE];

617 
p
->
ticks
[
READ
] -
sh¨ed
->
tmp
.ticks[READ];

618 
p
->
ticks
[
WRITE
] -
sh¨ed
->
tmp
.ticks[WRITE];

619 
p
->
io_ticks
[
READ
] -
sh¨ed
->
tmp
.io_ticks[READ];

620 
p
->
io_ticks
[
WRITE
] -
sh¨ed
->
tmp
.io_ticks[WRITE];

621 
p
->
io_ticks_tŸÆ
 -
sh¨ed
->
tmp
.io_ticks_total;

622 
p
->
time_ö_queue
 -
sh¨ed
->
tmp
.time_in_queue;

623 
	`loˇl_úq_íabÀ
();

625 
	}
}

627 
	$dm_°©s_˛ór
(
dm_°©s
 *
°©s
, 
id
)

629 
dm_°©
 *
s
;

631 
	`muãx_lock
(&
°©s
->
muãx
);

633 
s
 = 
	`__dm_°©s_föd
(
°©s
, 
id
);

634 i‡(!
s
) {

635 
	`muãx_u∆ock
(&
°©s
->
muãx
);

636  -
ENOENT
;

639 
	`__dm_°©_˛ór
(
s
, 0, s->
n_íåõs
, 
åue
);

641 
	`muãx_u∆ock
(&
°©s
->
muãx
);

644 
	}
}

649 
	$dm_jiffõs_to_m£c64
(
j
)

651 
ªsu…
 = 0;

652 
mu…
;

654 i‡(
j
)

655 
ªsu…
 = 
	`jiffõs_to_m£cs
(
j
 & 0x3fffff);

656 i‡(
j
 >= 1 << 22) {

657 
mu…
 = 
	`jiffõs_to_m£cs
(1 << 22);

658 
ªsu…
 +()
mu…
 * ()
	`jiffõs_to_m£cs
((
j
 >> 22) & 0x3fffff);

660 i‡(
j
 >= 1ULL << 44)

661 
ªsu…
 +()
mu…
 * ()mu… * ()
	`jiffõs_to_m£cs
(
j
 >> 44);

663  
ªsu…
;

664 
	}
}

666 
	$dm_°©s_¥öt
(
dm_°©s
 *
°©s
, 
id
,

667 
size_t
 
idx_°¨t
, size_à
idx_Àn
,

668 
boﬁ
 
˛ór
, *
ªsu…
, 
maxÀn
)

670 
sz
 = 0;

671 
dm_°©
 *
s
;

672 
size_t
 
x
;

673 
£˘‹_t
 
°¨t
, 
íd
, 
°ï
;

674 
size_t
 
idx_íd
;

675 
dm_°©_sh¨ed
 *
sh¨ed
;

682 
	`muãx_lock
(&
°©s
->
muãx
);

684 
s
 = 
	`__dm_°©s_föd
(
°©s
, 
id
);

685 i‡(!
s
) {

686 
	`muãx_u∆ock
(&
°©s
->
muãx
);

687  -
ENOENT
;

690 
idx_íd
 = 
idx_°¨t
 + 
idx_Àn
;

691 i‡(
idx_íd
 < 
idx_°¨t
 ||

692 
idx_íd
 > 
s
->
n_íåõs
)

693 
idx_íd
 = 
s
->
n_íåõs
;

695 i‡(
idx_°¨t
 > 
idx_íd
)

696 
idx_°¨t
 = 
idx_íd
;

698 
°ï
 = 
s
->step;

699 
°¨t
 = 
s
->°¨à+ (
°ï
 * 
idx_°¨t
);

701 
x
 = 
idx_°¨t
; x < 
idx_íd
; x++, 
°¨t
 = 
íd
) {

702 
sh¨ed
 = &
s
->
°©_sh¨ed
[
x
];

703 
íd
 = 
°¨t
 + 
°ï
;

704 i‡(
	`u∆ikñy
(
íd
 > 
s
->end))

705 
íd
 = 
s
->end;

707 
	`__dm_°©_öô_ãmp‹¨y_≥r˝u_tŸÆs
(
sh¨ed
, 
s
, 
x
);

709 
	`DMEMIT
("%llu+%llu %llu %llu %llu %llu %llu %llu %llu %llu %d %llu %llu %llu %llu\n",

710 ()
°¨t
,

711 ()
°ï
,

712 
sh¨ed
->
tmp
.
ios
[
READ
],

713 
sh¨ed
->
tmp
.
mîges
[
READ
],

714 
sh¨ed
->
tmp
.
£˘‹s
[
READ
],

715 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
ticks
[
READ
]),

716 
sh¨ed
->
tmp
.
ios
[
WRITE
],

717 
sh¨ed
->
tmp
.
mîges
[
WRITE
],

718 
sh¨ed
->
tmp
.
£˘‹s
[
WRITE
],

719 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
ticks
[
WRITE
]),

720 
	`dm_°©_ö_Êight
(
sh¨ed
),

721 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
io_ticks_tŸÆ
),

722 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
time_ö_queue
),

723 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
io_ticks
[
READ
]),

724 
	`dm_jiffõs_to_m£c64
(
sh¨ed
->
tmp
.
io_ticks
[
WRITE
]));

726 i‡(
	`u∆ikñy
(
sz
 + 1 >
maxÀn
))

727 
buf„r_ovîÊow
;

730 i‡(
˛ór
)

731 
	`__dm_°©_˛ór
(
s
, 
idx_°¨t
, 
idx_íd
, 
Ál£
);

733 
buf„r_ovîÊow
:

734 
	`muãx_u∆ock
(&
°©s
->
muãx
);

737 
	}
}

739 
	$dm_°©s_£t_aux
(
dm_°©s
 *
°©s
, 
id
, c⁄° *
aux_d©a
)

741 
dm_°©
 *
s
;

742 c⁄° *
√w_aux_d©a
;

744 
	`muãx_lock
(&
°©s
->
muãx
);

746 
s
 = 
	`__dm_°©s_föd
(
°©s
, 
id
);

747 i‡(!
s
) {

748 
	`muãx_u∆ock
(&
°©s
->
muãx
);

749  -
ENOENT
;

752 
√w_aux_d©a
 = 
	`k°rdup
(
aux_d©a
, 
GFP_KERNEL
);

753 i‡(!
√w_aux_d©a
) {

754 
	`muãx_u∆ock
(&
°©s
->
muãx
);

755  -
ENOMEM
;

758 
	`k‰ì
(
s
->
aux_d©a
);

759 
s
->
aux_d©a
 = 
√w_aux_d©a
;

761 
	`muãx_u∆ock
(&
°©s
->
muãx
);

764 
	}
}

766 
	$mesßge_°©s_¸óã
(
m≠≥d_devi˚
 *
md
,

767 
¨gc
, **
¨gv
,

768 *
ªsu…
, 
maxÀn
)

770 
id
;

771 
dummy
;

772 
°¨t
, 
íd
, 
Àn
, 
°ï
;

773 
divis‹
;

774 c⁄° *
¥ogøm_id
, *
aux_d©a
;

781 i‡(
¨gc
 < 3 ||árgc > 5)

782  -
EINVAL
;

784 i‡(!
	`°rcmp
(
¨gv
[1], "-")) {

785 
°¨t
 = 0;

786 
Àn
 = 
	`dm_gë_size
(
md
);

787 i‡(!
Àn
)

788 
Àn
 = 1;

789 } i‡(
	`ssˇnf
(
¨gv
[1], "%Œu+%Œu%c", &
°¨t
, &
Àn
, &
dummy
) != 2 ||

790 
°¨t
 !(
£˘‹_t
)°¨à|| 
Àn
 != (sector_t)len)

791  -
EINVAL
;

793 
íd
 = 
°¨t
 + 
Àn
;

794 i‡(
°¨t
 >
íd
)

795  -
EINVAL
;

797 i‡(
	`ssˇnf
(
¨gv
[2], "/%u%c", &
divis‹
, &
dummy
) == 1) {

798 
°ï
 = 
íd
 - 
°¨t
;

799 i‡(
	`do_div
(
°ï
, 
divis‹
))

800 
°ï
++;

801 i‡(!
°ï
)

802 
°ï
 = 1;

803 } i‡(
	`ssˇnf
(
¨gv
[2], "%Œu%c", &
°ï
, &
dummy
) != 1 ||

804 
°ï
 !(
£˘‹_t
)step || !step)

805  -
EINVAL
;

807 
¥ogøm_id
 = "-";

808 
aux_d©a
 = "-";

810 i‡(
¨gc
 > 3)

811 
¥ogøm_id
 = 
¨gv
[3];

813 i‡(
¨gc
 > 4)

814 
aux_d©a
 = 
¨gv
[4];

822 
	`¢¥ötf
(
ªsu…
, 
maxÀn
, "%d", 
INT_MAX
);

823 i‡(
	`dm_mesßge_ã°_buf„r_ovîÊow
(
ªsu…
, 
maxÀn
))

826 
id
 = 
	`dm_°©s_¸óã
(
	`dm_gë_°©s
(
md
), 
°¨t
, 
íd
, 
°ï
, 
¥ogøm_id
, 
aux_d©a
,

827 
dm_öã∫Æ_su•íd
, 
dm_öã∫Æ_ªsume
, 
md
);

828 i‡(
id
 < 0)

829  
id
;

831 
	`¢¥ötf
(
ªsu…
, 
maxÀn
, "%d", 
id
);

834 
	}
}

836 
	$mesßge_°©s_dñëe
(
m≠≥d_devi˚
 *
md
,

837 
¨gc
, **
¨gv
)

839 
id
;

840 
dummy
;

842 i‡(
¨gc
 != 2)

843  -
EINVAL
;

845 i‡(
	`ssˇnf
(
¨gv
[1], "%d%c", &
id
, &
dummy
) != 1 || id < 0)

846  -
EINVAL
;

848  
	`dm_°©s_dñëe
(
	`dm_gë_°©s
(
md
), 
id
);

849 
	}
}

851 
	$mesßge_°©s_˛ór
(
m≠≥d_devi˚
 *
md
,

852 
¨gc
, **
¨gv
)

854 
id
;

855 
dummy
;

857 i‡(
¨gc
 != 2)

858  -
EINVAL
;

860 i‡(
	`ssˇnf
(
¨gv
[1], "%d%c", &
id
, &
dummy
) != 1 || id < 0)

861  -
EINVAL
;

863  
	`dm_°©s_˛ór
(
	`dm_gë_°©s
(
md
), 
id
);

864 
	}
}

866 
	$mesßge_°©s_li°
(
m≠≥d_devi˚
 *
md
,

867 
¨gc
, **
¨gv
,

868 *
ªsu…
, 
maxÀn
)

870 
r
;

871 c⁄° *
¥ogøm
 = 
NULL
;

873 i‡(
¨gc
 < 1 ||árgc > 2)

874  -
EINVAL
;

876 i‡(
¨gc
 > 1) {

877 
¥ogøm
 = 
	`k°rdup
(
¨gv
[1], 
GFP_KERNEL
);

878 i‡(!
¥ogøm
)

879  -
ENOMEM
;

882 
r
 = 
	`dm_°©s_li°
(
	`dm_gë_°©s
(
md
), 
¥ogøm
, 
ªsu…
, 
maxÀn
);

884 
	`k‰ì
(
¥ogøm
);

886  
r
;

887 
	}
}

889 
	$mesßge_°©s_¥öt
(
m≠≥d_devi˚
 *
md
,

890 
¨gc
, **
¨gv
, 
boﬁ
 
˛ór
,

891 *
ªsu…
, 
maxÀn
)

893 
id
;

894 
dummy
;

895 
idx_°¨t
 = 0, 
idx_Àn
 = 
ULONG_MAX
;

897 i‡(
¨gc
 != 2 &&árgc != 4)

898  -
EINVAL
;

900 i‡(
	`ssˇnf
(
¨gv
[1], "%d%c", &
id
, &
dummy
) != 1 || id < 0)

901  -
EINVAL
;

903 i‡(
¨gc
 > 3) {

904 i‡(
	`°rcmp
(
¨gv
[2], "-") &&

905 
	`ssˇnf
(
¨gv
[2], "%lu%c", &
idx_°¨t
, &
dummy
) != 1)

906  -
EINVAL
;

907 i‡(
	`°rcmp
(
¨gv
[3], "-") &&

908 
	`ssˇnf
(
¨gv
[3], "%lu%c", &
idx_Àn
, &
dummy
) != 1)

909  -
EINVAL
;

912  
	`dm_°©s_¥öt
(
	`dm_gë_°©s
(
md
), 
id
, 
idx_°¨t
, 
idx_Àn
, 
˛ór
,

913 
ªsu…
, 
maxÀn
);

914 
	}
}

916 
	$mesßge_°©s_£t_aux
(
m≠≥d_devi˚
 *
md
,

917 
¨gc
, **
¨gv
)

919 
id
;

920 
dummy
;

922 i‡(
¨gc
 != 3)

923  -
EINVAL
;

925 i‡(
	`ssˇnf
(
¨gv
[1], "%d%c", &
id
, &
dummy
) != 1 || id < 0)

926  -
EINVAL
;

928  
	`dm_°©s_£t_aux
(
	`dm_gë_°©s
(
md
), 
id
, 
¨gv
[2]);

929 
	}
}

931 
	$dm_°©s_mesßge
(
m≠≥d_devi˚
 *
md
, 
¨gc
, **
¨gv
,

932 *
ªsu…
, 
maxÀn
)

934 
r
;

936 i‡(
	`dm_ªque°_ba£d
(
md
)) {

937 
	`DMWARN
("Statisticsáre only supported for bio-based devices");

938  -
EOPNOTSUPP
;

942 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_create"))

943 
r
 = 
	`mesßge_°©s_¸óã
(
md
, 
¨gc
, 
¨gv
, 
ªsu…
, 
maxÀn
);

944 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_delete"))

945 
r
 = 
	`mesßge_°©s_dñëe
(
md
, 
¨gc
, 
¨gv
);

946 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_clear"))

947 
r
 = 
	`mesßge_°©s_˛ór
(
md
, 
¨gc
, 
¨gv
);

948 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_list"))

949 
r
 = 
	`mesßge_°©s_li°
(
md
, 
¨gc
, 
¨gv
, 
ªsu…
, 
maxÀn
);

950 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_print"))

951 
r
 = 
	`mesßge_°©s_¥öt
(
md
, 
¨gc
, 
¨gv
, 
Ál£
, 
ªsu…
, 
maxÀn
);

952 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_print_clear"))

953 
r
 = 
	`mesßge_°©s_¥öt
(
md
, 
¨gc
, 
¨gv
, 
åue
, 
ªsu…
, 
maxÀn
);

954 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "@stats_set_aux"))

955 
r
 = 
	`mesßge_°©s_£t_aux
(
md
, 
¨gc
, 
¨gv
);

959 i‡(
r
 =-
EINVAL
)

960 
	`DMWARN
("InvÆidÖ¨amëî†f‹ mesßgê%s", 
¨gv
[0]);

962  
r
;

963 
	}
}

965 
__öô
 
	$dm_°©i°ics_öô
()

967 
sh¨ed_mem‹y_amou¡
 = 0;

968 
dm_°©_√ed_rcu_b¨rõr
 = 0;

970 
	}
}

972 
	$dm_°©i°ics_exô
()

974 i‡(
dm_°©_√ed_rcu_b¨rõr
)

975 
	`rcu_b¨rõr
();

976 i‡(
	`WARN_ON
(
sh¨ed_mem‹y_amou¡
))

977 
	`DMCRIT
("sh¨ed_mem‹y_amou¡Üóked: %lu", 
sh¨ed_mem‹y_amou¡
);

978 
	}
}

980 
moduÀ_∑øm_«med
(
°©s_cuºít_Æloˇãd_byãs
, 
sh¨ed_mem‹y_amou¡
, 
ul⁄g
, 
S_IRUGO
);

981 
MODULE_PARM_DESC
(
°©s_cuºít_Æloˇãd_byãs
, "Memory currently used by statistics");

	@dm-stats.h

1 #i‚de‡
DM_STATS_H


2 
	#DM_STATS_H


	)

4 
	~<löux/ty≥s.h
>

5 
	~<löux/muãx.h
>

6 
	~<löux/li°.h
>

8 
dm_°©i°ics_öô
();

9 
dm_°©i°ics_exô
();

11 
	sdm_°©s
 {

12 
muãx
 
	mmuãx
;

13 
li°_hód
 
	mli°
;

14 
dm_°©s_œ°_posôi⁄
 
__≥r˝u
 *
	mœ°
;

15 
£˘‹_t
 
	mœ°_£˘‹
;

16 
	mœ°_rw
;

19 
	sdm_°©s_aux
 {

20 
boﬁ
 
	mmîged
;

23 
dm_°©s_öô
(
dm_°©s
 *
°
);

24 
dm_°©s_˛ónup
(
dm_°©s
 *
°
);

26 
	gm≠≥d_devi˚
;

28 
dm_°©s_mesßge
(
m≠≥d_devi˚
 *
md
, 
¨gc
, **
¨gv
,

29 *
ªsu…
, 
maxÀn
);

31 
dm_°©s_accou¡_io
(
dm_°©s
 *
°©s
, 
bi_rw
,

32 
£˘‹_t
 
bi_£˘‹
, 
bi_£˘‹s
, 
boﬁ
 
íd
,

33 
duøti⁄
, 
dm_°©s_aux
 *
aux
);

35 
ölöe
 
boﬁ
 
	$dm_°©s_u£d
(
dm_°©s
 *
°
)

37  !
	`li°_em±y
(&
°
->
li°
);

38 
	}
}

	@dm-stripe.c

7 
	~"dm.h
"

8 
	~<löux/devi˚-m≠≥r.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/blkdev.h
>

13 
	~<löux/bio.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/log2.h
>

17 
	#DM_MSG_PREFIX
 "°rùed"

	)

18 
	#DM_IO_ERROR_THRESHOLD
 15

	)

20 
	s°rùe
 {

21 
dm_dev
 *
	mdev
;

22 
£˘‹_t
 
	mphysiˇl_°¨t
;

24 
©omic_t
 
	mîr‹_cou¡
;

27 
	s°rùe_c
 {

28 
uöt32_t
 
	m°rùes
;

29 
	m°rùes_shi·
;

32 
£˘‹_t
 
	m°rùe_width
;

34 
uöt32_t
 
	mchunk_size
;

35 
	mchunk_size_shi·
;

38 
dm_èrgë
 *
	mti
;

41 
w‹k_°ru˘
 
	måiggî_evít
;

43 
°rùe
 
	m°rùe
[0];

50 
	$åiggî_evít
(
w‹k_°ru˘
 *
w‹k
)

52 
°rùe_c
 *
sc
 = 
	`c⁄èöî_of
(
w‹k
, stripe_c,

53 
åiggî_evít
);

54 
	`dm_èbÀ_evít
(
sc
->
ti
->
èbÀ
);

55 
	}
}

57 
ölöe
 
°rùe_c
 *
	$Æloc_c⁄ãxt
(
°rùes
)

59 
size_t
 
Àn
;

61 i‡(
	`dm_¨øy_too_big
((
°rùe_c
), (
°rùe
),

62 
°rùes
))

63  
NULL
;

65 
Àn
 = (
°rùe_c
Ë+ ((
°rùe
Ë* 
°rùes
);

67  
	`kmÆloc
(
Àn
, 
GFP_KERNEL
);

68 
	}
}

73 
	$gë_°rùe
(
dm_èrgë
 *
ti
, 
°rùe_c
 *
sc
,

74 
°rùe
, **
¨gv
)

76 
°¨t
;

77 
dummy
;

79 i‡(
	`ssˇnf
(
¨gv
[1], "%Œu%c", &
°¨t
, &
dummy
) != 1)

80  -
EINVAL
;

82 i‡(
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

83 &
sc
->
°rùe
[°rùe].
dev
))

84  -
ENXIO
;

86 
sc
->
°rùe
[°rùe].
physiˇl_°¨t
 = 
°¨t
;

89 
	}
}

95 
	$°rùe_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

97 
°rùe_c
 *
sc
;

98 
£˘‹_t
 
width
, 
tmp_Àn
;

99 
uöt32_t
 
°rùes
;

100 
uöt32_t
 
chunk_size
;

101 
r
;

102 
i
;

104 i‡(
¨gc
 < 2) {

105 
ti
->
îr‹
 = "NotÉnoughárguments";

106  -
EINVAL
;

109 i‡(
	`k°πouöt
(
¨gv
[0], 10, &
°rùes
) || !stripes) {

110 
ti
->
îr‹
 = "Invalid stripe count";

111  -
EINVAL
;

114 i‡(
	`k°πouöt
(
¨gv
[1], 10, &
chunk_size
) || !chunk_size) {

115 
ti
->
îr‹
 = "Invalid chunk_size";

116  -
EINVAL
;

119 
width
 = 
ti
->
Àn
;

120 i‡(
	`£˘‹_div
(
width
, 
°rùes
)) {

121 
ti
->
îr‹
 = "TargetÜengthÇot divisible by "

123  -
EINVAL
;

126 
tmp_Àn
 = 
width
;

127 i‡(
	`£˘‹_div
(
tmp_Àn
, 
chunk_size
)) {

128 
ti
->
îr‹
 = "TargetÜengthÇot divisible by "

130  -
EINVAL
;

136 i‡(
¨gc
 !(2 + 2 * 
°rùes
)) {

137 
ti
->
îr‹
 = "NotÉnough destinations "

139  -
EINVAL
;

142 
sc
 = 
	`Æloc_c⁄ãxt
(
°rùes
);

143 i‡(!
sc
) {

144 
ti
->
îr‹
 = "Memoryállocation for striped context "

146  -
ENOMEM
;

149 
	`INIT_WORK
(&
sc
->
åiggî_evít
,Årigger_event);

152 
sc
->
ti
 =Åi;

153 
sc
->
°rùes
 = stripes;

154 
sc
->
°rùe_width
 = 
width
;

156 i‡(
°rùes
 & (stripes - 1))

157 
sc
->
°rùes_shi·
 = -1;

159 
sc
->
°rùes_shi·
 = 
	`__ffs
(
°rùes
);

161 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
chunk_size
);

162 i‡(
r
)

163  
r
;

165 
ti
->
num_Êush_bios
 = 
°rùes
;

166 
ti
->
num_disˇrd_bios
 = 
°rùes
;

167 
ti
->
num_wrôe_ßme_bios
 = 
°rùes
;

169 
sc
->
chunk_size
 = chunk_size;

170 i‡(
chunk_size
 & (chunk_size - 1))

171 
sc
->
chunk_size_shi·
 = -1;

173 
sc
->
chunk_size_shi·
 = 
	`__ffs
(
chunk_size
);

178 
i
 = 0; i < 
°rùes
; i++) {

179 
¨gv
 += 2;

181 
r
 = 
	`gë_°rùe
(
ti
, 
sc
, 
i
, 
¨gv
);

182 i‡(
r
 < 0) {

183 
ti
->
îr‹
 = "Couldn'tÖarse stripe destination";

184 
i
--)

185 
	`dm_put_devi˚
(
ti
, 
sc
->
°rùe
[
i
].
dev
);

186 
	`k‰ì
(
sc
);

187  
r
;

189 
	`©omic_£t
(&(
sc
->
°rùe
[
i
].
îr‹_cou¡
), 0);

192 
ti
->
¥iv©e
 = 
sc
;

195 
	}
}

197 
	$°rùe_då
(
dm_èrgë
 *
ti
)

199 
i
;

200 
°rùe_c
 *
sc
 = (°rùe_¯*Ë
ti
->
¥iv©e
;

202 
i
 = 0; i < 
sc
->
°rùes
; i++)

203 
	`dm_put_devi˚
(
ti
, 
sc
->
°rùe
[
i
].
dev
);

205 
	`Êush_w‹k
(&
sc
->
åiggî_evít
);

206 
	`k‰ì
(
sc
);

207 
	}
}

209 
	$°rùe_m≠_£˘‹
(
°rùe_c
 *
sc
, 
£˘‹_t
 
£˘‹
,

210 
uöt32_t
 *
°rùe
, 
£˘‹_t
 *
ªsu…
)

212 
£˘‹_t
 
chunk
 = 
	`dm_èrgë_off£t
(
sc
->
ti
, 
£˘‹
);

213 
£˘‹_t
 
chunk_off£t
;

215 i‡(
sc
->
chunk_size_shi·
 < 0)

216 
chunk_off£t
 = 
	`£˘‹_div
(
chunk
, 
sc
->
chunk_size
);

218 
chunk_off£t
 = 
chunk
 & (
sc
->
chunk_size
 - 1);

219 
chunk
 >>
sc
->
chunk_size_shi·
;

222 i‡(
sc
->
°rùes_shi·
 < 0)

223 *
°rùe
 = 
	`£˘‹_div
(
chunk
, 
sc
->
°rùes
);

225 *
°rùe
 = 
chunk
 & (
sc
->
°rùes
 - 1);

226 
chunk
 >>
sc
->
°rùes_shi·
;

229 i‡(
sc
->
chunk_size_shi·
 < 0)

230 
chunk
 *
sc
->
chunk_size
;

232 
chunk
 <<
sc
->
chunk_size_shi·
;

234 *
ªsu…
 = 
chunk
 + 
chunk_off£t
;

235 
	}
}

237 
	$°rùe_m≠_ønge_£˘‹
(
°rùe_c
 *
sc
, 
£˘‹_t
 
£˘‹
,

238 
uöt32_t
 
èrgë_°rùe
, 
£˘‹_t
 *
ªsu…
)

240 
uöt32_t
 
°rùe
;

242 
	`°rùe_m≠_£˘‹
(
sc
, 
£˘‹
, &
°rùe
, 
ªsu…
);

243 i‡(
°rùe
 =
èrgë_°rùe
)

247 
£˘‹
 = *
ªsu…
;

248 i‡(
sc
->
chunk_size_shi·
 < 0)

249 *
ªsu…
 -
	`£˘‹_div
(
£˘‹
, 
sc
->
chunk_size
);

251 *
ªsu…
 = 
£˘‹
 & ~(
£˘‹_t
)(
sc
->
chunk_size
 - 1);

253 i‡(
èrgë_°rùe
 < 
°rùe
)

254 *
ªsu…
 +
sc
->
chunk_size
;

255 
	}
}

257 
	$°rùe_m≠_ønge
(
°rùe_c
 *
sc
, 
bio
 *bio,

258 
uöt32_t
 
èrgë_°rùe
)

260 
£˘‹_t
 
begö
, 
íd
;

262 
	`°rùe_m≠_ønge_£˘‹
(
sc
, 
bio
->
bi_ôî
.
bi_£˘‹
,

263 
èrgë_°rùe
, &
begö
);

264 
	`°rùe_m≠_ønge_£˘‹
(
sc
, 
	`bio_íd_£˘‹
(
bio
),

265 
èrgë_°rùe
, &
íd
);

266 i‡(
begö
 < 
íd
) {

267 
bio
->
bi_bdev
 = 
sc
->
°rùe
[
èrgë_°rùe
].
dev
->
bdev
;

268 
bio
->
bi_ôî
.
bi_£˘‹
 = 
begö
 +

269 
sc
->
°rùe
[
èrgë_°rùe
].
physiˇl_°¨t
;

270 
bio
->
bi_ôî
.
bi_size
 = 
	`to_byãs
(
íd
 - 
begö
);

271  
DM_MAPIO_REMAPPED
;

274 
	`bio_ídio
(
bio
, 0);

275  
DM_MAPIO_SUBMITTED
;

277 
	}
}

279 
	$°rùe_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

281 
°rùe_c
 *
sc
 = 
ti
->
¥iv©e
;

282 
uöt32_t
 
°rùe
;

283 
èrgë_bio_ƒ
;

285 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

286 
èrgë_bio_ƒ
 = 
	`dm_bio_gë_èrgë_bio_ƒ
(
bio
);

287 
	`BUG_ON
(
èrgë_bio_ƒ
 >
sc
->
°rùes
);

288 
bio
->
bi_bdev
 = 
sc
->
°rùe
[
èrgë_bio_ƒ
].
dev
->
bdev
;

289  
DM_MAPIO_REMAPPED
;

291 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_DISCARD
) ||

292 
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_WRITE_SAME
)) {

293 
èrgë_bio_ƒ
 = 
	`dm_bio_gë_èrgë_bio_ƒ
(
bio
);

294 
	`BUG_ON
(
èrgë_bio_ƒ
 >
sc
->
°rùes
);

295  
	`°rùe_m≠_ønge
(
sc
, 
bio
, 
èrgë_bio_ƒ
);

298 
	`°rùe_m≠_£˘‹
(
sc
, 
bio
->
bi_ôî
.
bi_£˘‹
,

299 &
°rùe
, &
bio
->
bi_ôî
.
bi_£˘‹
);

301 
bio
->
bi_ôî
.
bi_£˘‹
 +
sc
->
°rùe
[°rùe].
physiˇl_°¨t
;

302 
bio
->
bi_bdev
 = 
sc
->
°rùe
[°rùe].
dev
->
bdev
;

304  
DM_MAPIO_REMAPPED
;

305 
	}
}

320 
	$°rùe_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

321 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

323 
°rùe_c
 *
sc
 = (°rùe_¯*Ë
ti
->
¥iv©e
;

324 
buf„r
[
sc
->
°rùes
 + 1];

325 
sz
 = 0;

326 
i
;

328 
ty≥
) {

329 
STATUSTYPE_INFO
:

330 
	`DMEMIT
("%d ", 
sc
->
°rùes
);

331 
i
 = 0; i < 
sc
->
°rùes
; i++) {

332 
	`DMEMIT
("%†", 
sc
->
°rùe
[
i
].
dev
->
«me
);

333 
buf„r
[
i
] = 
	`©omic_ªad
(&(
sc
->
°rùe
[i].
îr‹_cou¡
)) ?

336 
buf„r
[
i
] = '\0';

337 
	`DMEMIT
("1 %s", 
buf„r
);

340 
STATUSTYPE_TABLE
:

341 
	`DMEMIT
("%d %Œu", 
sc
->
°rùes
,

342 ()
sc
->
chunk_size
);

343 
i
 = 0; i < 
sc
->
°rùes
; i++)

344 
	`DMEMIT
(" %†%Œu", 
sc
->
°rùe
[
i
].
dev
->
«me
,

345 ()
sc
->
°rùe
[
i
].
physiˇl_°¨t
);

348 
	}
}

350 
	$°rùe_íd_io
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr‹
)

352 
i
;

353 
maj‹_mö‹
[16];

354 
°rùe_c
 *
sc
 = 
ti
->
¥iv©e
;

356 i‡(!
îr‹
)

359 i‡((
îr‹
 =-
EWOULDBLOCK
Ë&& (
bio
->
bi_rw
 & 
REQ_RAHEAD
))

360  
îr‹
;

362 i‡(
îr‹
 =-
EOPNOTSUPP
)

363  
îr‹
;

365 
	`mem£t
(
maj‹_mö‹
, 0, (major_minor));

366 
	`•rötf
(
maj‹_mö‹
, "%d:%d",

367 
	`MAJOR
(
	`disk_devt
(
bio
->
bi_bdev
->
bd_disk
)),

368 
	`MINOR
(
	`disk_devt
(
bio
->
bi_bdev
->
bd_disk
)));

376 
i
 = 0; i < 
sc
->
°rùes
; i++)

377 i‡(!
	`°rcmp
(
sc
->
°rùe
[
i
].
dev
->
«me
, 
maj‹_mö‹
)) {

378 
	`©omic_öc
(&(
sc
->
°rùe
[
i
].
îr‹_cou¡
));

379 i‡(
	`©omic_ªad
(&(
sc
->
°rùe
[
i
].
îr‹_cou¡
)) <

380 
DM_IO_ERROR_THRESHOLD
)

381 
	`scheduÀ_w‹k
(&
sc
->
åiggî_evít
);

384  
îr‹
;

385 
	}
}

387 
	$°rùe_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

388 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

390 
°rùe_c
 *
sc
 = 
ti
->
¥iv©e
;

391 
ªt
 = 0;

392 
i
 = 0;

395 
ªt
 = 
	`‚
(
ti
, 
sc
->
°rùe
[
i
].
dev
,

396 
sc
->
°rùe
[
i
].
physiˇl_°¨t
,

397 
sc
->
°rùe_width
, 
d©a
);

398 } !
ªt
 && ++
i
 < 
sc
->
°rùes
);

400  
ªt
;

401 
	}
}

403 
	$°rùe_io_höts
(
dm_èrgë
 *
ti
,

404 
queue_limôs
 *
limôs
)

406 
°rùe_c
 *
sc
 = 
ti
->
¥iv©e
;

407 
chunk_size
 = 
sc
->chunk_sizê<< 
SECTOR_SHIFT
;

409 
	`blk_limôs_io_mö
(
limôs
, 
chunk_size
);

410 
	`blk_limôs_io_›t
(
limôs
, 
chunk_size
 * 
sc
->
°rùes
);

411 
	}
}

413 
	$°rùe_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

414 
bio_vec
 *
biovec
, 
max_size
)

416 
°rùe_c
 *
sc
 = 
ti
->
¥iv©e
;

417 
£˘‹_t
 
bvm_£˘‹
 = 
bvm
->
bi_£˘‹
;

418 
uöt32_t
 
°rùe
;

419 
ªque°_queue
 *
q
;

421 
	`°rùe_m≠_£˘‹
(
sc
, 
bvm_£˘‹
, &
°rùe
, &bvm_sector);

423 
q
 = 
	`bdev_gë_queue
(
sc
->
°rùe
[°rùe].
dev
->
bdev
);

424 i‡(!
q
->
mîge_bvec_‚
)

425  
max_size
;

427 
bvm
->
bi_bdev
 = 
sc
->
°rùe
[°rùe].
dev
->
bdev
;

428 
bvm
->
bi_£˘‹
 = 
sc
->
°rùe
[°rùe].
physiˇl_°¨t
 + 
bvm_£˘‹
;

430  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

431 
	}
}

433 
èrgë_ty≥
 
	g°rùe_èrgë
 = {

434 .
«me
 = "striped",

435 .
	gvîsi⁄
 = {1, 5, 1},

436 .
	gmoduÀ
 = 
THIS_MODULE
,

437 .
	g˘r
 = 
°rùe_˘r
,

438 .
	gdå
 = 
°rùe_då
,

439 .
	gm≠
 = 
°rùe_m≠
,

440 .
	gíd_io
 = 
°rùe_íd_io
,

441 .
	g°©us
 = 
°rùe_°©us
,

442 .
	gôî©e_devi˚s
 = 
°rùe_ôî©e_devi˚s
,

443 .
	gio_höts
 = 
°rùe_io_höts
,

444 .
	gmîge
 = 
°rùe_mîge
,

447 
__öô
 
	$dm_°rùe_öô
()

449 
r
;

451 
r
 = 
	`dm_ªgi°î_èrgë
(&
°rùe_èrgë
);

452 i‡(
r
 < 0) {

453 
	`DMWARN
("targetÑegistration failed");

454  
r
;

457  
r
;

458 
	}
}

460 
	$dm_°rùe_exô
()

462 
	`dm_uƒegi°î_èrgë
(&
°rùe_èrgë
);

463 
	}
}

	@dm-switch.c

13 
	~<löux/devi˚-m≠≥r.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/vmÆloc.h
>

19 
	#DM_MSG_PREFIX
 "swôch"

	)

25 
	tªgi⁄_èbÀ_¶Ÿ_t
;

30 
	sswôch_∑th
 {

31 
dm_dev
 *
	mdmdev
;

32 
£˘‹_t
 
	m°¨t
;

38 
	sswôch_˘x
 {

39 
dm_èrgë
 *
	mti
;

41 
	mƒ_∑ths
;

43 
	mªgi⁄_size
;

44 
	mƒ_ªgi⁄s
;

45 sig√d 
	mªgi⁄_size_bôs
;

47 
	mªgi⁄_èbÀ_íåy_bôs
;

48 
	mªgi⁄_íåõs_≥r_¶Ÿ
;

49 sig√d 
	mªgi⁄_íåõs_≥r_¶Ÿ_bôs
;

51 
ªgi⁄_èbÀ_¶Ÿ_t
 *
	mªgi⁄_èbÀ
;

56 
swôch_∑th
 
	m∑th_li°
[0];

59 
swôch_˘x
 *
	$Æloc_swôch_˘x
(
dm_èrgë
 *
ti
, 
ƒ_∑ths
,

60 
ªgi⁄_size
)

62 
swôch_˘x
 *
s˘x
;

64 
s˘x
 = 
	`kzÆloc
((
swôch_˘x
Ë+ 
ƒ_∑ths
 * (
swôch_∑th
),

65 
GFP_KERNEL
);

66 i‡(!
s˘x
)

67  
NULL
;

69 
s˘x
->
ti
 =Åi;

70 
s˘x
->
ªgi⁄_size
 =Ñegion_size;

72 
ti
->
¥iv©e
 = 
s˘x
;

74  
s˘x
;

75 
	}
}

77 
	$Æloc_ªgi⁄_èbÀ
(
dm_èrgë
 *
ti
, 
ƒ_∑ths
)

79 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

80 
£˘‹_t
 
ƒ_ªgi⁄s
 = 
ti
->
Àn
;

81 
£˘‹_t
 
ƒ_¶Ÿs
;

83 i‡(!(
s˘x
->
ªgi⁄_size
 & (sctx->region_size - 1)))

84 
s˘x
->
ªgi⁄_size_bôs
 = 
	`__ffs
(s˘x->
ªgi⁄_size
);

86 
s˘x
->
ªgi⁄_size_bôs
 = -1;

88 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
 = 1;

89 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
 < (
ªgi⁄_èbÀ_¶Ÿ_t
) * 8 &&

90 (
ªgi⁄_èbÀ_¶Ÿ_t
)1 << 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
 < 
ƒ_∑ths
)

91 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
++;

93 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
 = ((
ªgi⁄_èbÀ_¶Ÿ_t
Ë* 8Ë/ s˘x->
ªgi⁄_èbÀ_íåy_bôs
;

94 i‡(!(
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
 & (sctx->region_entries_per_slot - 1)))

95 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ_bôs
 = 
	`__ffs
(s˘x->
ªgi⁄_íåõs_≥r_¶Ÿ
);

97 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ_bôs
 = -1;

99 i‡(
	`£˘‹_div
(
ƒ_ªgi⁄s
, 
s˘x
->
ªgi⁄_size
))

100 
ƒ_ªgi⁄s
++;

102 
s˘x
->
ƒ_ªgi⁄s
 =Çr_regions;

103 i‡(
s˘x
->
ƒ_ªgi⁄s
 !ƒ_ªgi⁄†|| s˘x->ƒ_ªgi⁄†>
ULONG_MAX
) {

104 
ti
->
îr‹
 = "RegionÅableÅooÜarge";

105  -
EINVAL
;

108 
ƒ_¶Ÿs
 = 
ƒ_ªgi⁄s
;

109 i‡(
	`£˘‹_div
(
ƒ_¶Ÿs
, 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
))

110 
ƒ_¶Ÿs
++;

112 i‡(
ƒ_¶Ÿs
 > 
ULONG_MAX
 / (
ªgi⁄_èbÀ_¶Ÿ_t
)) {

113 
ti
->
îr‹
 = "RegionÅableÅooÜarge";

114  -
EINVAL
;

117 
s˘x
->
ªgi⁄_èbÀ
 = 
	`vmÆloc
(
ƒ_¶Ÿs
 * (
ªgi⁄_èbÀ_¶Ÿ_t
));

118 i‡(!
s˘x
->
ªgi⁄_èbÀ
) {

119 
ti
->
îr‹
 = "CannotállocateÑegionÅable";

120  -
ENOMEM
;

124 
	}
}

126 
	$swôch_gë_posôi⁄
(
swôch_˘x
 *
s˘x
, 
ªgi⁄_ƒ
,

127 *
ªgi⁄_ödex
, *
bô
)

129 i‡(
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ_bôs
 >= 0) {

130 *
ªgi⁄_ödex
 = 
ªgi⁄_ƒ
 >> 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ_bôs
;

131 *
bô
 = 
ªgi⁄_ƒ
 & (
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
 - 1);

133 *
ªgi⁄_ödex
 = 
ªgi⁄_ƒ
 / 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
;

134 *
bô
 = 
ªgi⁄_ƒ
 % 
s˘x
->
ªgi⁄_íåõs_≥r_¶Ÿ
;

137 *
bô
 *
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
;

138 
	}
}

140 
	$swôch_ªgi⁄_èbÀ_ªad
(
swôch_˘x
 *
s˘x
, 
ªgi⁄_ƒ
)

142 
ªgi⁄_ödex
;

143 
bô
;

145 
	`swôch_gë_posôi⁄
(
s˘x
, 
ªgi⁄_ƒ
, &
ªgi⁄_ödex
, &
bô
);

147  (
	`ACCESS_ONCE
(
s˘x
->
ªgi⁄_èbÀ
[
ªgi⁄_ödex
]Ë>> 
bô
) &

148 ((1 << 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
) - 1);

149 
	}
}

154 
	$swôch_gë_∑th_ƒ
(
swôch_˘x
 *
s˘x
, 
£˘‹_t
 
off£t
)

156 
∑th_ƒ
;

157 
£˘‹_t
 
p
;

159 
p
 = 
off£t
;

160 i‡(
s˘x
->
ªgi⁄_size_bôs
 >= 0)

161 
p
 >>
s˘x
->
ªgi⁄_size_bôs
;

163 
	`£˘‹_div
(
p
, 
s˘x
->
ªgi⁄_size
);

165 
∑th_ƒ
 = 
	`swôch_ªgi⁄_èbÀ_ªad
(
s˘x
, 
p
);

168 i‡(
	`u∆ikñy
(
∑th_ƒ
 >
s˘x
->
ƒ_∑ths
))

169 
∑th_ƒ
 = 0;

171  
∑th_ƒ
;

172 
	}
}

174 
	$swôch_ªgi⁄_èbÀ_wrôe
(
swôch_˘x
 *
s˘x
, 
ªgi⁄_ƒ
,

175 
vÆue
)

177 
ªgi⁄_ödex
;

178 
bô
;

179 
ªgi⁄_èbÀ_¶Ÿ_t
 
±e
;

181 
	`swôch_gë_posôi⁄
(
s˘x
, 
ªgi⁄_ƒ
, &
ªgi⁄_ödex
, &
bô
);

183 
±e
 = 
s˘x
->
ªgi⁄_èbÀ
[
ªgi⁄_ödex
];

184 
±e
 &~((((
ªgi⁄_èbÀ_¶Ÿ_t
)1 << 
s˘x
->
ªgi⁄_èbÀ_íåy_bôs
Ë- 1Ë<< 
bô
);

185 
±e
 |(
ªgi⁄_èbÀ_¶Ÿ_t
)
vÆue
 << 
bô
;

186 
s˘x
->
ªgi⁄_èbÀ
[
ªgi⁄_ödex
] = 
±e
;

187 
	}
}

192 
	$öôüli£_ªgi⁄_èbÀ
(
swôch_˘x
 *
s˘x
)

194 
∑th_ƒ
 = 0;

195 
ªgi⁄_ƒ
;

197 
ªgi⁄_ƒ
 = 0;Ñegi⁄_ƒ < 
s˘x
->
ƒ_ªgi⁄s
;Ñegion_nr++) {

198 
	`swôch_ªgi⁄_èbÀ_wrôe
(
s˘x
, 
ªgi⁄_ƒ
, 
∑th_ƒ
);

199 i‡(++
∑th_ƒ
 >
s˘x
->
ƒ_∑ths
)

200 
∑th_ƒ
 = 0;

202 
	}
}

204 
	$∑r£_∑th
(
dm_¨g_£t
 *
as
, 
dm_èrgë
 *
ti
)

206 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

207 
°¨t
;

208 
r
;

210 
r
 = 
	`dm_gë_devi˚
(
ti
, 
	`dm_shi·_¨g
(
as
), 
	`dm_èbÀ_gë_mode
—i->
èbÀ
),

211 &
s˘x
->
∑th_li°
[s˘x->
ƒ_∑ths
].
dmdev
);

212 i‡(
r
) {

213 
ti
->
îr‹
 = "DeviceÜookup failed";

214  
r
;

217 i‡(
	`k°πouŒ
(
	`dm_shi·_¨g
(
as
), 10, &
°¨t
Ë|| sèπ !(
£˘‹_t
)start) {

218 
ti
->
îr‹
 = "Invalid device starting offset";

219 
	`dm_put_devi˚
(
ti
, 
s˘x
->
∑th_li°
[s˘x->
ƒ_∑ths
].
dmdev
);

220  -
EINVAL
;

223 
s˘x
->
∑th_li°
[s˘x->
ƒ_∑ths
].
°¨t
 = start;

225 
s˘x
->
ƒ_∑ths
++;

228 
	}
}

233 
	$swôch_då
(
dm_èrgë
 *
ti
)

235 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

237 
s˘x
->
ƒ_∑ths
--)

238 
	`dm_put_devi˚
(
ti
, 
s˘x
->
∑th_li°
[s˘x->
ƒ_∑ths
].
dmdev
);

240 
	`v‰ì
(
s˘x
->
ªgi⁄_èbÀ
);

241 
	`k‰ì
(
s˘x
);

242 
	}
}

252 
	$swôch_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

254 
dm_¨g
 
_¨gs
[] = {

255 {1, (
KMALLOC_MAX_SIZE
 - (
swôch_˘x
)Ë/ (
swôch_∑th
), "InvalidÇumber ofÖaths"},

256 {1, 
UINT_MAX
, "InvalidÑegion size"},

260 
swôch_˘x
 *
s˘x
;

261 
dm_¨g_£t
 
as
;

262 
ƒ_∑ths
, 
ªgi⁄_size
, 
ƒ_›ti⁄Æ_¨gs
;

263 
r
;

265 
as
.
¨gc
 =árgc;

266 
as
.
¨gv
 =árgv;

268 
r
 = 
	`dm_ªad_¨g
(
_¨gs
, &
as
, &
ƒ_∑ths
, &
ti
->
îr‹
);

269 i‡(
r
)

270  -
EINVAL
;

272 
r
 = 
	`dm_ªad_¨g
(
_¨gs
 + 1, &
as
, &
ªgi⁄_size
, &
ti
->
îr‹
);

273 i‡(
r
)

274  
r
;

276 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
 + 2, &
as
, &
ƒ_›ti⁄Æ_¨gs
, &
ti
->
îr‹
);

277 i‡(
r
)

278  
r
;

281 i‡(
as
.
¨gc
 !
ƒ_∑ths
 * 2) {

282 
ti
->
îr‹
 = "IncorrectÇumber ofÖathárguments";

283  -
EINVAL
;

286 
s˘x
 = 
	`Æloc_swôch_˘x
(
ti
, 
ƒ_∑ths
, 
ªgi⁄_size
);

287 i‡(!
s˘x
) {

288 
ti
->
îr‹
 = "CannotállocateÑedirection context";

289  -
ENOMEM
;

292 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
ªgi⁄_size
);

293 i‡(
r
)

294 
îr‹
;

296 
as
.
¨gc
) {

297 
r
 = 
	`∑r£_∑th
(&
as
, 
ti
);

298 i‡(
r
)

299 
îr‹
;

302 
r
 = 
	`Æloc_ªgi⁄_èbÀ
(
ti
, 
ƒ_∑ths
);

303 i‡(
r
)

304 
îr‹
;

306 
	`öôüli£_ªgi⁄_èbÀ
(
s˘x
);

309 
ti
->
num_disˇrd_bios
 = 1;

313 
îr‹
:

314 
	`swôch_då
(
ti
);

316  
r
;

317 
	}
}

319 
	$swôch_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

321 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

322 
£˘‹_t
 
off£t
 = 
	`dm_èrgë_off£t
(
ti
, 
bio
->
bi_ôî
.
bi_£˘‹
);

323 
∑th_ƒ
 = 
	`swôch_gë_∑th_ƒ
(
s˘x
, 
off£t
);

325 
bio
->
bi_bdev
 = 
s˘x
->
∑th_li°
[
∑th_ƒ
].
dmdev
->
bdev
;

326 
bio
->
bi_ôî
.
bi_£˘‹
 = 
s˘x
->
∑th_li°
[
∑th_ƒ
].
°¨t
 + 
off£t
;

328  
DM_MAPIO_REMAPPED
;

329 
	}
}

341 c⁄° 
	ghex_èbÀ
[256] = {

360 
__Æways_ölöe
 
	$∑r£_hex
(c⁄° **
°rög
)

362 
d
;

363 
r
 = 0;

365 (
d
 = 
hex_èbÀ
[()**
°rög
]) < 16) {

366 
r
 = (∏<< 4Ë| 
d
;

367 (*
°rög
)++;

370  
r
;

371 
	}
}

373 
	$¥o˚ss_£t_ªgi⁄_m≠pögs
(
swôch_˘x
 *
s˘x
,

374 
¨gc
, **
¨gv
)

376 
i
;

377 
ªgi⁄_ödex
 = 0;

379 
i
 = 1; i < 
¨gc
; i++) {

380 
∑th_ƒ
;

381 c⁄° *
°rög
 = 
¨gv
[
i
];

383 i‡((*
°rög
 & 0xdf) == 'R') {

384 
cy˛e_Àngth
, 
num_wrôe
;

386 
°rög
++;

387 i‡(
	`u∆ikñy
(*
°rög
 == ',')) {

388 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

389  -
EINVAL
;

391 
cy˛e_Àngth
 = 
	`∑r£_hex
(&
°rög
);

392 i‡(
	`u∆ikñy
(*
°rög
 != ',')) {

393 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

394  -
EINVAL
;

396 
°rög
++;

397 i‡(
	`u∆ikñy
(!*
°rög
)) {

398 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

399  -
EINVAL
;

401 
num_wrôe
 = 
	`∑r£_hex
(&
°rög
);

402 i‡(
	`u∆ikñy
(*
°rög
)) {

403 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

404  -
EINVAL
;

407 i‡(
	`u∆ikñy
(!
cy˛e_Àngth
Ë|| u∆ikñy(cy˛e_Àngth - 1 > 
ªgi⁄_ödex
)) {

408 
	`DMWARN
("invalid set_region_mappings cycleÜength: %lu > %lu",

409 
cy˛e_Àngth
 - 1, 
ªgi⁄_ödex
);

410  -
EINVAL
;

412 i‡(
	`u∆ikñy
(
ªgi⁄_ödex
 + 
num_wrôe
 <Ñegion_index) ||

413 
	`u∆ikñy
(
ªgi⁄_ödex
 + 
num_wrôe
 >
s˘x
->
ƒ_ªgi⁄s
)) {

414 
	`DMWARN
("invalid set_region_mappingsÑegionÇumber: %lu + %lu >= %lu",

415 
ªgi⁄_ödex
, 
num_wrôe
, 
s˘x
->
ƒ_ªgi⁄s
);

416  -
EINVAL
;

419 
num_wrôe
--) {

420 
ªgi⁄_ödex
++;

421 
∑th_ƒ
 = 
	`swôch_ªgi⁄_èbÀ_ªad
(
s˘x
, 
ªgi⁄_ödex
 - 
cy˛e_Àngth
);

422 
	`swôch_ªgi⁄_èbÀ_wrôe
(
s˘x
, 
ªgi⁄_ödex
, 
∑th_ƒ
);

428 i‡(*
°rög
 == ':')

429 
ªgi⁄_ödex
++;

431 
ªgi⁄_ödex
 = 
	`∑r£_hex
(&
°rög
);

432 i‡(
	`u∆ikñy
(*
°rög
 != ':')) {

433 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

434  -
EINVAL
;

438 
°rög
++;

439 i‡(
	`u∆ikñy
(!*
°rög
)) {

440 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

441  -
EINVAL
;

444 
∑th_ƒ
 = 
	`∑r£_hex
(&
°rög
);

445 i‡(
	`u∆ikñy
(*
°rög
)) {

446 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†¨gumít: '%s'", 
¨gv
[
i
]);

447  -
EINVAL
;

449 i‡(
	`u∆ikñy
(
ªgi⁄_ödex
 >
s˘x
->
ƒ_ªgi⁄s
)) {

450 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†ªgi⁄Çumbî: %lu >%lu", 
ªgi⁄_ödex
, 
s˘x
->
ƒ_ªgi⁄s
);

451  -
EINVAL
;

453 i‡(
	`u∆ikñy
(
∑th_ƒ
 >
s˘x
->
ƒ_∑ths
)) {

454 
	`DMWARN
("övÆid së_ªgi⁄_m≠pög†devi˚: %lu >%u", 
∑th_ƒ
, 
s˘x
->
ƒ_∑ths
);

455  -
EINVAL
;

458 
	`swôch_ªgi⁄_èbÀ_wrôe
(
s˘x
, 
ªgi⁄_ödex
, 
∑th_ƒ
);

462 
	}
}

469 
	$swôch_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

471 
	`DEFINE_MUTEX
(
mesßge_muãx
);

473 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

474 
r
 = -
EINVAL
;

476 
	`muãx_lock
(&
mesßge_muãx
);

478 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "set_region_mappings"))

479 
r
 = 
	`¥o˚ss_£t_ªgi⁄_m≠pögs
(
s˘x
, 
¨gc
, 
¨gv
);

481 
	`DMWARN
("Unrecognised messageÑeceived.");

483 
	`muãx_u∆ock
(&
mesßge_muãx
);

485  
r
;

486 
	}
}

488 
	$swôch_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

489 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

491 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

492 
sz
 = 0;

493 
∑th_ƒ
;

495 
ty≥
) {

496 
STATUSTYPE_INFO
:

497 
ªsu…
[0] = '\0';

500 
STATUSTYPE_TABLE
:

501 
	`DMEMIT
("%u %u 0", 
s˘x
->
ƒ_∑ths
, s˘x->
ªgi⁄_size
);

502 
∑th_ƒ
 = 0;Ö©h_ƒ < 
s˘x
->
ƒ_∑ths
;Öath_nr++)

503 
	`DMEMIT
(" %†%Œu", 
s˘x
->
∑th_li°
[
∑th_ƒ
].
dmdev
->
«me
,

504 ()
s˘x
->
∑th_li°
[
∑th_ƒ
].
°¨t
);

507 
	}
}

514 
	$swôch_io˘l
(
dm_èrgë
 *
ti
, 
cmd
,

515 
¨g
)

517 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

518 
block_devi˚
 *
bdev
;

519 
fmode_t
 
mode
;

520 
∑th_ƒ
;

521 
r
 = 0;

523 
∑th_ƒ
 = 
	`swôch_gë_∑th_ƒ
(
s˘x
, 0);

525 
bdev
 = 
s˘x
->
∑th_li°
[
∑th_ƒ
].
dmdev
->bdev;

526 
mode
 = 
s˘x
->
∑th_li°
[
∑th_ƒ
].
dmdev
->mode;

531 i‡(
ti
->
Àn
 + 
s˘x
->
∑th_li°
[
∑th_ƒ
].
°¨t
 !
	`i_size_ªad
(
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
)

532 
r
 = 
	`scsi_vîify_blk_io˘l
(
NULL
, 
cmd
);

534  
r
 ? : 
	`__blkdev_drivî_io˘l
(
bdev
, 
mode
, 
cmd
, 
¨g
);

535 
	}
}

537 
	$swôch_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

538 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

540 
swôch_˘x
 *
s˘x
 = 
ti
->
¥iv©e
;

541 
∑th_ƒ
;

542 
r
;

544 
∑th_ƒ
 = 0;Ö©h_ƒ < 
s˘x
->
ƒ_∑ths
;Öath_nr++) {

545 
r
 = 
	`‚
(
ti
, 
s˘x
->
∑th_li°
[
∑th_ƒ
].
dmdev
,

546 
s˘x
->
∑th_li°
[
∑th_ƒ
].
°¨t
, 
ti
->
Àn
, 
d©a
);

547 i‡(
r
)

548  
r
;

552 
	}
}

554 
èrgë_ty≥
 
	gswôch_èrgë
 = {

555 .
«me
 = "switch",

556 .
	gvîsi⁄
 = {1, 1, 0},

557 .
	gmoduÀ
 = 
THIS_MODULE
,

558 .
	g˘r
 = 
swôch_˘r
,

559 .
	gdå
 = 
swôch_då
,

560 .
	gm≠
 = 
swôch_m≠
,

561 .
	gmesßge
 = 
swôch_mesßge
,

562 .
	g°©us
 = 
swôch_°©us
,

563 .
	gio˘l
 = 
swôch_io˘l
,

564 .
	gôî©e_devi˚s
 = 
swôch_ôî©e_devi˚s
,

567 
__öô
 
	$dm_swôch_öô
()

569 
r
;

571 
r
 = 
	`dm_ªgi°î_èrgë
(&
swôch_èrgë
);

572 i‡(
r
 < 0)

573 
	`DMERR
("dm_ªgi°î_èrgë(ËÁûed %d", 
r
);

575  
r
;

576 
	}
}

578 
__exô
 
	$dm_swôch_exô
()

580 
	`dm_uƒegi°î_èrgë
(&
swôch_èrgë
);

581 
	}
}

583 
moduÀ_öô
(
dm_swôch_öô
);

584 
moduÀ_exô
(
dm_swôch_exô
);

586 
MODULE_DESCRIPTION
(
DM_NAME
 " dynamicÖath switchingÅarget");

587 
MODULE_AUTHOR
("Kevin D. O'Kelley <Kevin_OKelley@dell.com>");

588 
MODULE_AUTHOR
("Narendran Ganapathy <Narendran_Ganapathy@dell.com>");

589 
MODULE_AUTHOR
("Jim Ramsay <Jim_Ramsay@dell.com>");

590 
MODULE_AUTHOR
("Mikulas Patocka <mpatocka@redhat.com>");

591 
MODULE_LICENSE
("GPL");

	@dm-switch.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

25 { 0xd6ì688f, 
__VMLINUX_SYMBOL_STR
(
vmÆloc
) },

26 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

27 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

28 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

29 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

30 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

31 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

32 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

33 { 0x46„b099, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g
) },

34 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

35 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

36 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

37 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

38 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

39 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
v‰ì
) },

40 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

41 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

42 { 0xf8c0f16e, 
__VMLINUX_SYMBOL_STR
(
__blkdev_drivî_io˘l
) },

43 { 0x4df6e7a2, 
__VMLINUX_SYMBOL_STR
(
scsi_vîify_blk_io˘l
) },

44 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

47 c⁄° 
	g__moduÀ_dïíds
[]

48 
__u£d


49 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

53 
MODULE_INFO
(
§cvîsi⁄
, "180CEEAA37089A4EC60CCD7");

	@dm-sysfs.c

7 
	~<löux/sysfs.h
>

8 
	~<löux/dm-io˘l.h
>

9 
	~"dm.h
"

11 
	sdm_sysfs_©å
 {

12 
©åibuã
 
	m©å
;

13 
ssize_t
 (*
show
)(
	mm≠≥d_devi˚
 *, *);

14 
ssize_t
 (*
°‹e
)(
	mm≠≥d_devi˚
 *, *);

17 
	#DM_ATTR_RO
(
_«me
) \

18 
dm_sysfs_©å
 
dm_©å_
##
_«me
 = \

19 
	`__ATTR
(
_«me
, 
S_IRUGO
, 
dm_©å_
##_«me##
_show
, 
NULL
)

	)

21 
ssize_t
 
	$dm_©å_show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

22 *
∑ge
)

24 
dm_sysfs_©å
 *
dm_©å
;

25 
m≠≥d_devi˚
 *
md
;

26 
ssize_t
 
ªt
;

28 
dm_©å
 = 
	`c⁄èöî_of
(
©å
, 
dm_sysfs_©å
,áttr);

29 i‡(!
dm_©å
->
show
)

30  -
EIO
;

32 
md
 = 
	`dm_gë_‰om_kobje˘
(
kobj
);

33 i‡(!
md
)

34  -
EINVAL
;

36 
ªt
 = 
dm_©å
->
	`show
(
md
, 
∑ge
);

37 
	`dm_put
(
md
);

39  
ªt
;

40 
	}
}

42 
ssize_t
 
	$dm_©å_«me_show
(
m≠≥d_devi˚
 *
md
, *
buf
)

44 i‡(
	`dm_c›y_«me_™d_uuid
(
md
, 
buf
, 
NULL
))

45  -
EIO
;

47 
	`°rˇt
(
buf
, "\n");

48  
	`°æí
(
buf
);

49 
	}
}

51 
ssize_t
 
	$dm_©å_uuid_show
(
m≠≥d_devi˚
 *
md
, *
buf
)

53 i‡(
	`dm_c›y_«me_™d_uuid
(
md
, 
NULL
, 
buf
))

54  -
EIO
;

56 
	`°rˇt
(
buf
, "\n");

57  
	`°æí
(
buf
);

58 
	}
}

60 
ssize_t
 
	$dm_©å_su•íded_show
(
m≠≥d_devi˚
 *
md
, *
buf
)

62 
	`•rötf
(
buf
, "%d\n", 
	`dm_su•íded_md
(
md
));

64  
	`°æí
(
buf
);

65 
	}
}

67 
DM_ATTR_RO
(
«me
);

68 
DM_ATTR_RO
(
uuid
);

69 
DM_ATTR_RO
(
su•íded
);

71 
©åibuã
 *
	gdm_©ås
[] = {

72 &
dm_©å_«me
.
©å
,

73 &
dm_©å_uuid
.
©å
,

74 &
dm_©å_su•íded
.
©å
,

75 
NULL
,

78 c⁄° 
sysfs_›s
 
	gdm_sysfs_›s
 = {

79 .
show
 = 
dm_©å_show
,

86 
kobj_ty≥
 
	gdm_kty≥
 = {

87 .
sysfs_›s
 = &
dm_sysfs_›s
,

88 .
	gdeÁu…_©ås
 = 
dm_©ås
,

89 .
	gªÀa£
 = 
dm_kobje˘_ªÀa£
,

96 
	$dm_sysfs_öô
(
m≠≥d_devi˚
 *
md
)

98  
	`kobje˘_öô_™d_add
(
	`dm_kobje˘
(
md
), &
dm_kty≥
,

99 &
	`disk_to_dev
(
	`dm_disk
(
md
))->
kobj
,

101 
	}
}

106 
	$dm_sysfs_exô
(
m≠≥d_devi˚
 *
md
)

108 
kobje˘
 *
kobj
 = 
	`dm_kobje˘
(
md
);

109 
	`kobje˘_put
(
kobj
);

110 
	`waô_f‹_com∂ëi⁄
(
	`dm_gë_com∂ëi⁄_‰om_kobje˘
(
kobj
));

111 
	}
}

	@dm-table.c

8 
	~"dm.h
"

10 
	~<löux/moduÀ.h
>

11 
	~<löux/vmÆloc.h
>

12 
	~<löux/blkdev.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/˘y≥.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/öãºu±.h
>

18 
	~<löux/muãx.h
>

19 
	~<löux/dñay.h
>

20 
	~<löux/©omic.h
>

22 
	#DM_MSG_PREFIX
 "èbÀ"

	)

24 
	#MAX_DEPTH
 16

	)

25 
	#NODE_SIZE
 
L1_CACHE_BYTES


	)

26 
	#KEYS_PER_NODE
 (
NODE_SIZE
 / (
£˘‹_t
))

	)

27 
	#CHILDREN_PER_NODE
 (
KEYS_PER_NODE
 + 1)

	)

29 
	sdm_èbÀ
 {

30 
m≠≥d_devi˚
 *
	mmd
;

31 
	mty≥
;

34 
	mdïth
;

35 
	mcou¡s
[
MAX_DEPTH
];

36 
£˘‹_t
 *
	mödex
[
MAX_DEPTH
];

38 
	mnum_èrgës
;

39 
	mnum_Æloˇãd
;

40 
£˘‹_t
 *
	mhighs
;

41 
dm_èrgë
 *
	mèrgës
;

43 
èrgë_ty≥
 *
	mimmuèbÀ_èrgë_ty≥
;

44 
	möãgrôy_suµ‹ãd
:1;

45 
	msögÀt⁄
:1;

52 
fmode_t
 
	mmode
;

55 
li°_hód
 
	mdevi˚s
;

58 (*
	mevít_‚
)(*);

59 *
	mevít_c⁄ãxt
;

61 
dm_md_mempoﬁs
 *
	mmempoﬁs
;

63 
li°_hód
 
	mèrgë_ˇŒbacks
;

69 
	$öt_log
(
n
, 
ba£
)

71 
ªsu…
 = 0;

73 
n
 > 1) {

74 
n
 = 
	`dm_div_up
“, 
ba£
);

75 
ªsu…
++;

78  
ªsu…
;

79 
	}
}

84 
ölöe
 
	$gë_chûd
(
n
, 
k
)

86  (
n
 * 
CHILDREN_PER_NODE
Ë+ 
k
;

87 
	}
}

92 
ölöe
 
£˘‹_t
 *
	$gë_node
(
dm_èbÀ
 *
t
,

93 
l
, 
n
)

95  
t
->
ödex
[
l
] + (
n
 * 
KEYS_PER_NODE
);

96 
	}
}

102 
£˘‹_t
 
	$high
(
dm_èbÀ
 *
t
, 
l
, 
n
)

104 ; 
l
 < 
t
->
dïth
 - 1;Ü++)

105 
n
 = 
	`gë_chûd
“, 
CHILDREN_PER_NODE
 - 1);

107 i‡(
n
 >
t
->
cou¡s
[
l
])

108  (
£˘‹_t
) - 1;

110  
	`gë_node
(
t
, 
l
, 
n
)[
KEYS_PER_NODE
 - 1];

111 
	}
}

117 
	$£tup_båì_ödex
(
l
, 
dm_èbÀ
 *
t
)

119 
n
, 
k
;

120 
£˘‹_t
 *
node
;

122 
n
 = 0U;Ç < 
t
->
cou¡s
[
l
];Ç++) {

123 
node
 = 
	`gë_node
(
t
, 
l
, 
n
);

125 
k
 = 0U; k < 
KEYS_PER_NODE
; k++)

126 
node
[
k
] = 
	`high
(
t
, 
l
 + 1, 
	`gë_chûd
(
n
, k));

130 
	}
}

132 *
	$dm_vˇŒoc
(
nmemb
, 
ñem_size
)

134 
size
;

135 *
addr
;

140 i‡(
nmemb
 > (
ULONG_MAX
 / 
ñem_size
))

141  
NULL
;

143 
size
 = 
nmemb
 * 
ñem_size
;

144 
addr
 = 
	`vzÆloc
(
size
);

146  
addr
;

147 
	}
}

148 
EXPORT_SYMBOL
(
dm_vˇŒoc
);

154 
	$Æloc_èrgës
(
dm_èbÀ
 *
t
, 
num
)

156 
£˘‹_t
 *
n_highs
;

157 
dm_èrgë
 *
n_èrgës
;

164 
n_highs
 = (
£˘‹_t
 *Ë
	`dm_vˇŒoc
(
num
 + 1, (
dm_èrgë
) +

165 (
£˘‹_t
));

166 i‡(!
n_highs
)

167  -
ENOMEM
;

169 
n_èrgës
 = (
dm_èrgë
 *Ë(
n_highs
 + 
num
);

171 
	`mem£t
(
n_highs
, -1, (*n_highsË* 
num
);

172 
	`v‰ì
(
t
->
highs
);

174 
t
->
num_Æloˇãd
 = 
num
;

175 
t
->
highs
 = 
n_highs
;

176 
t
->
èrgës
 = 
n_èrgës
;

179 
	}
}

181 
	$dm_èbÀ_¸óã
(
dm_èbÀ
 **
ªsu…
, 
fmode_t
 
mode
,

182 
num_èrgës
, 
m≠≥d_devi˚
 *
md
)

184 
dm_èbÀ
 *
t
 = 
	`kzÆloc
((*t), 
GFP_KERNEL
);

186 i‡(!
t
)

187  -
ENOMEM
;

189 
	`INIT_LIST_HEAD
(&
t
->
devi˚s
);

190 
	`INIT_LIST_HEAD
(&
t
->
èrgë_ˇŒbacks
);

192 i‡(!
num_èrgës
)

193 
num_èrgës
 = 
KEYS_PER_NODE
;

195 
num_èrgës
 = 
	`dm_round_up
“um_èrgës, 
KEYS_PER_NODE
);

197 i‡(!
num_èrgës
) {

198 
	`k‰ì
(
t
);

199  -
ENOMEM
;

202 i‡(
	`Æloc_èrgës
(
t
, 
num_èrgës
)) {

203 
	`k‰ì
(
t
);

204  -
ENOMEM
;

207 
t
->
mode
 = mode;

208 
t
->
md
 = md;

209 *
ªsu…
 = 
t
;

211 
	}
}

213 
	$‰ì_devi˚s
(
li°_hód
 *
devi˚s
, 
m≠≥d_devi˚
 *
md
)

215 
li°_hód
 *
tmp
, *
√xt
;

217 
	`li°_f‹_óch_ß„
(
tmp
, 
√xt
, 
devi˚s
) {

218 
dm_dev_öã∫Æ
 *
dd
 =

219 
	`li°_íåy
(
tmp
, 
dm_dev_öã∫Æ
, 
li°
);

220 
	`DMWARN
("%s: dm_table_destroy: dm_put_device call missing for %s",

221 
	`dm_devi˚_«me
(
md
), 
dd
->
dm_dev
->
«me
);

222 
	`dm_put_èbÀ_devi˚
(
md
, 
dd
->
dm_dev
);

223 
	`k‰ì
(
dd
);

225 
	}
}

227 
	$dm_èbÀ_de°roy
(
dm_èbÀ
 *
t
)

229 
i
;

231 i‡(!
t
)

235 i‡(
t
->
dïth
 >= 2)

236 
	`v‰ì
(
t
->
ödex
[t->
dïth
 - 2]);

239 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

240 
dm_èrgë
 *
tgt
 = 
t
->
èrgës
 + 
i
;

242 i‡(
tgt
->
ty≥
->
då
)

243 
tgt
->
ty≥
->
	`då
(tgt);

245 
	`dm_put_èrgë_ty≥
(
tgt
->
ty≥
);

248 
	`v‰ì
(
t
->
highs
);

251 
	`‰ì_devi˚s
(&
t
->
devi˚s
,Å->
md
);

253 
	`dm_‰ì_md_mempoﬁs
(
t
->
mempoﬁs
);

255 
	`k‰ì
(
t
);

256 
	}
}

261 
dm_dev_öã∫Æ
 *
	$föd_devi˚
(
li°_hód
 *
l
, 
dev_t
 
dev
)

263 
dm_dev_öã∫Æ
 *
dd
;

265 
	`li°_f‹_óch_íåy
 (
dd
, 
l
, 
li°
)

266 i‡(
dd
->
dm_dev
->
bdev
->
bd_dev
 =
dev
)

267  
dd
;

269  
NULL
;

270 
	}
}

275 
	$devi˚_¨ó_is_övÆid
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

276 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

278 
ªque°_queue
 *
q
;

279 
queue_limôs
 *
limôs
 = 
d©a
;

280 
block_devi˚
 *
bdev
 = 
dev
->bdev;

281 
£˘‹_t
 
dev_size
 =

282 
	`i_size_ªad
(
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

283 
logiˇl_block_size_£˘‹s
 =

284 
limôs
->
logiˇl_block_size
 >> 
SECTOR_SHIFT
;

285 
b
[
BDEVNAME_SIZE
];

292 
q
 = 
	`bdev_gë_queue
(
bdev
);

293 i‡(!
q
 || !q->
make_ªque°_‚
) {

294 
	`DMWARN
("%s: %s isÇot yet initialised: "

296 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
), 
	`bdev«me
(
bdev
, 
b
),

297 ()
°¨t
,

298 ()
Àn
,

299 ()
dev_size
);

303 i‡(!
dev_size
)

306 i‡((
°¨t
 >
dev_size
Ë|| (°¨à+ 
Àn
 > dev_size)) {

307 
	`DMWARN
("%s: %sÅoo small forÅarget: "

309 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
), 
	`bdev«me
(
bdev
, 
b
),

310 ()
°¨t
,

311 ()
Àn
,

312 ()
dev_size
);

316 i‡(
logiˇl_block_size_£˘‹s
 <= 1)

319 i‡(
°¨t
 & (
logiˇl_block_size_£˘‹s
 - 1)) {

320 
	`DMWARN
("%s: start=%lluÇotálignedÅo h/w "

322 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
),

323 ()
°¨t
,

324 
limôs
->
logiˇl_block_size
, 
	`bdev«me
(
bdev
, 
b
));

328 i‡(
Àn
 & (
logiˇl_block_size_£˘‹s
 - 1)) {

329 
	`DMWARN
("%s:Üen=%lluÇotálignedÅo h/w "

331 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
),

332 ()
Àn
,

333 
limôs
->
logiˇl_block_size
, 
	`bdev«me
(
bdev
, 
b
));

338 
	}
}

346 
	$upgøde_mode
(
dm_dev_öã∫Æ
 *
dd
, 
fmode_t
 
√w_mode
,

347 
m≠≥d_devi˚
 *
md
)

349 
r
;

350 
dm_dev
 *
ﬁd_dev
, *
√w_dev
;

352 
ﬁd_dev
 = 
dd
->
dm_dev
;

354 
r
 = 
	`dm_gë_èbÀ_devi˚
(
md
, 
dd
->
dm_dev
->
bdev
->
bd_dev
,

355 
dd
->
dm_dev
->
mode
 | 
√w_mode
, &
√w_dev
);

356 i‡(
r
)

357  
r
;

359 
dd
->
dm_dev
 = 
√w_dev
;

360 
	`dm_put_èbÀ_devi˚
(
md
, 
ﬁd_dev
);

363 
	}
}

369 
	$dm_gë_devi˚
(
dm_èrgë
 *
ti
, c⁄° *
∑th
, 
fmode_t
 
mode
,

370 
dm_dev
 **
ªsu…
)

372 
r
;

373 
dev_t
 
	`unöôülized_v¨
(
dev
);

374 
dm_dev_öã∫Æ
 *
dd
;

375 
maj‹
, 
mö‹
;

376 
dm_èbÀ
 *
t
 = 
ti
->
èbÀ
;

377 
dummy
;

379 
	`BUG_ON
(!
t
);

381 i‡(
	`ssˇnf
(
∑th
, "%u:%u%c", &
maj‹
, &
mö‹
, &
dummy
) == 2) {

383 
dev
 = 
	`MKDEV
(
maj‹
, 
mö‹
);

384 i‡(
	`MAJOR
(
dev
Ë!
maj‹
 || 
	`MINOR
(devË!
mö‹
)

385  -
EOVERFLOW
;

388 
block_devi˚
 *
bdev
 = 
	`lookup_bdev
(
∑th
);

390 i‡(
	`IS_ERR
(
bdev
))

391  
	`PTR_ERR
(
bdev
);

392 
dev
 = 
bdev
->
bd_dev
;

393 
	`bdput
(
bdev
);

396 
dd
 = 
	`föd_devi˚
(&
t
->
devi˚s
, 
dev
);

397 i‡(!
dd
) {

398 
dd
 = 
	`kmÆloc
((*dd), 
GFP_KERNEL
);

399 i‡(!
dd
)

400  -
ENOMEM
;

402 i‡((
r
 = 
	`dm_gë_èbÀ_devi˚
(
t
->
md
, 
dev
, 
mode
, &
dd
->
dm_dev
))) {

403 
	`k‰ì
(
dd
);

404  
r
;

407 
	`©omic_£t
(&
dd
->
cou¡
, 0);

408 
	`li°_add
(&
dd
->
li°
, &
t
->
devi˚s
);

410 } i‡(
dd
->
dm_dev
->
mode
 != (mode | dd->dm_dev->mode)) {

411 
r
 = 
	`upgøde_mode
(
dd
, 
mode
, 
t
->
md
);

412 i‡(
r
)

413  
r
;

415 
	`©omic_öc
(&
dd
->
cou¡
);

417 *
ªsu…
 = 
dd
->
dm_dev
;

419 
	}
}

420 
EXPORT_SYMBOL
(
dm_gë_devi˚
);

422 
	$dm_£t_devi˚_limôs
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

423 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

425 
queue_limôs
 *
limôs
 = 
d©a
;

426 
block_devi˚
 *
bdev
 = 
dev
->bdev;

427 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
bdev
);

428 
b
[
BDEVNAME_SIZE
];

430 i‡(
	`u∆ikñy
(!
q
)) {

431 
	`DMWARN
("%s: Cannot setÜimits forÇonexistent device %s",

432 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
), 
	`bdev«me
(
bdev
, 
b
));

436 i‡(
	`bdev_°ack_limôs
(
limôs
, 
bdev
, 
°¨t
) < 0)

437 
	`DMWARN
("%s:áddingÅarget device %s causedánálignment inconsistency: "

440 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
), 
	`bdev«me
(
bdev
, 
b
),

441 
q
->
limôs
.
physiˇl_block_size
,

442 
q
->
limôs
.
logiˇl_block_size
,

443 
q
->
limôs
.
Æignmít_off£t
,

444 (Ë
°¨t
 << 
SECTOR_SHIFT
);

451 i‡(
	`dm_queue_mîge_is_compuls‹y
(
q
Ë&& !
ti
->
ty≥
->
mîge
)

452 
	`blk_limôs_max_hw_£˘‹s
(
limôs
,

453 (Ë(
PAGE_SIZE
 >> 9));

455 
	}
}

460 
	$dm_put_devi˚
(
dm_èrgë
 *
ti
, 
dm_dev
 *
d
)

462 
found
 = 0;

463 
li°_hód
 *
devi˚s
 = &
ti
->
èbÀ
->devices;

464 
dm_dev_öã∫Æ
 *
dd
;

466 
	`li°_f‹_óch_íåy
(
dd
, 
devi˚s
, 
li°
) {

467 i‡(
dd
->
dm_dev
 =
d
) {

468 
found
 = 1;

472 i‡(!
found
) {

473 
	`DMWARN
("%s: device %sÇot inÅable devicesÜist",

474 
	`dm_devi˚_«me
(
ti
->
èbÀ
->
md
), 
d
->
«me
);

477 i‡(
	`©omic_dec_™d_ã°
(&
dd
->
cou¡
)) {

478 
	`dm_put_èbÀ_devi˚
(
ti
->
èbÀ
->
md
, 
d
);

479 
	`li°_dñ
(&
dd
->
li°
);

480 
	`k‰ì
(
dd
);

482 
	}
}

483 
EXPORT_SYMBOL
(
dm_put_devi˚
);

488 
	$adjoö
(
dm_èbÀ
 *
èbÀ
, 
dm_èrgë
 *
ti
)

490 
dm_èrgë
 *
¥ev
;

492 i‡(!
èbÀ
->
num_èrgës
)

493  !
ti
->
begö
;

495 
¥ev
 = &
èbÀ
->
èrgës
[èbÀ->
num_èrgës
 - 1];

496  (
ti
->
begö
 =(
¥ev
->begö +Öªv->
Àn
));

497 
	}
}

509 **
	$ªÆloc_¨gv
(*
¨øy_size
, **
ﬁd_¨gv
)

511 **
¨gv
;

512 
√w_size
;

513 
gÂ_t
 
gÂ
;

515 i‡(*
¨øy_size
) {

516 
√w_size
 = *
¨øy_size
 * 2;

517 
gÂ
 = 
GFP_KERNEL
;

519 
√w_size
 = 8;

520 
gÂ
 = 
GFP_NOIO
;

522 
¨gv
 = 
	`kmÆloc
(
√w_size
 * (*¨gv), 
gÂ
);

523 i‡(
¨gv
) {

524 
	`mem˝y
(
¨gv
, 
ﬁd_¨gv
, *
¨øy_size
 * (*argv));

525 *
¨øy_size
 = 
√w_size
;

528 
	`k‰ì
(
ﬁd_¨gv
);

529  
¨gv
;

530 
	}
}

535 
	$dm_•lô_¨gs
(*
¨gc
, ***
¨gvp
, *
öput
)

537 *
°¨t
, *
íd
 = 
öput
, *
out
, **
¨gv
 = 
NULL
;

538 
¨øy_size
 = 0;

540 *
¨gc
 = 0;

542 i‡(!
öput
) {

543 *
¨gvp
 = 
NULL
;

547 
¨gv
 = 
	`ªÆloc_¨gv
(&
¨øy_size
,árgv);

548 i‡(!
¨gv
)

549  -
ENOMEM
;

553 
°¨t
 = 
	`skù_•a˚s
(
íd
);

555 i‡(!*
°¨t
)

559 
íd
 = 
out
 = 
°¨t
;

560 *
íd
) {

562 i‡(*
íd
 == '\\' && *(end + 1)) {

563 *
out
++ = *(
íd
 + 1);

564 
íd
 += 2;

568 i‡(
	`is•a˚
(*
íd
))

571 *
out
++ = *
íd
++;

575 i‡((*
¨gc
 + 1Ë> 
¨øy_size
) {

576 
¨gv
 = 
	`ªÆloc_¨gv
(&
¨øy_size
,árgv);

577 i‡(!
¨gv
)

578  -
ENOMEM
;

582 i‡(*
íd
)

583 
íd
++;

586 *
out
 = '\0';

587 
¨gv
[*
¨gc
] = 
°¨t
;

588 (*
¨gc
)++;

591 *
¨gvp
 = 
¨gv
;

593 
	}
}

602 
	$vÆid©e_h¨dw¨e_logiˇl_block_Æignmít
(
dm_èbÀ
 *
èbÀ
,

603 
queue_limôs
 *
limôs
)

609 
devi˚_logiˇl_block_size_£˘s
 =

610 
limôs
->
logiˇl_block_size
 >> 
SECTOR_SHIFT
;

615 
√xt_èrgë_°¨t
 = 0;

621 
ªmaöög
 = 0;

623 
dm_èrgë
 *
	`unöôülized_v¨
(
ti
);

624 
queue_limôs
 
ti_limôs
;

625 
i
 = 0;

630 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
)) {

631 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
èbÀ
, 
i
++);

633 
	`blk_£t_°ackög_limôs
(&
ti_limôs
);

636 i‡(
ti
->
ty≥
->
ôî©e_devi˚s
)

637 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
dm_£t_devi˚_limôs
,

638 &
ti_limôs
);

644 i‡(
ªmaöög
 < 
ti
->
Àn
 &&

645 
ªmaöög
 & ((
ti_limôs
.
logiˇl_block_size
 >>

646 
SECTOR_SHIFT
) - 1))

649 
√xt_èrgë_°¨t
 =

650 (Ë((
√xt_èrgë_°¨t
 + 
ti
->
Àn
) &

651 (
devi˚_logiˇl_block_size_£˘s
 - 1));

652 
ªmaöög
 = 
√xt_èrgë_°¨t
 ?

653 
devi˚_logiˇl_block_size_£˘s
 - 
√xt_èrgë_°¨t
 : 0;

656 i‡(
ªmaöög
) {

657 
	`DMWARN
("%s:ÅableÜine %u (start sect %lluÜen %llu) "

659 
	`dm_devi˚_«me
(
èbÀ
->
md
), 
i
,

660 (Ë
ti
->
begö
,

661 (Ë
ti
->
Àn
,

662 
limôs
->
logiˇl_block_size
);

663  -
EINVAL
;

667 
	}
}

669 
	$dm_èbÀ_add_èrgë
(
dm_èbÀ
 *
t
, c⁄° *
ty≥
,

670 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
∑øms
)

672 
r
 = -
EINVAL
, 
¨gc
;

673 **
¨gv
;

674 
dm_èrgë
 *
tgt
;

676 i‡(
t
->
sögÀt⁄
) {

677 
	`DMERR
("%s:ÅargetÅype %s mustáppearálone inÅable",

678 
	`dm_devi˚_«me
(
t
->
md
),Å->
èrgës
->
ty≥
->
«me
);

679  -
EINVAL
;

682 
	`BUG_ON
(
t
->
num_èrgës
 >t->
num_Æloˇãd
);

684 
tgt
 = 
t
->
èrgës
 +Å->
num_èrgës
;

685 
	`mem£t
(
tgt
, 0, (*tgt));

687 i‡(!
Àn
) {

688 
	`DMERR
("%s: zîo-ÀngthÅ¨gë", 
	`dm_devi˚_«me
(
t
->
md
));

689  -
EINVAL
;

692 
tgt
->
ty≥
 = 
	`dm_gë_èrgë_ty≥
(type);

693 i‡(!
tgt
->
ty≥
) {

694 
	`DMERR
("%s: %s: unknow¿èrgëÅy≥", 
	`dm_devi˚_«me
(
t
->
md
),

695 
ty≥
);

696  -
EINVAL
;

699 i‡(
	`dm_èrgë_√eds_sögÀt⁄
(
tgt
->
ty≥
)) {

700 i‡(
t
->
num_èrgës
) {

701 
	`DMERR
("%s:ÅargetÅype %s mustáppearálone inÅable",

702 
	`dm_devi˚_«me
(
t
->
md
), 
ty≥
);

703  -
EINVAL
;

705 
t
->
sögÀt⁄
 = 1;

708 i‡(
	`dm_èrgë_Æways_wrôóbÀ
(
tgt
->
ty≥
Ë&& !(
t
->
mode
 & 
FMODE_WRITE
)) {

709 
	`DMERR
("%s:ÅargetÅype %s mayÇot be included inÑead-onlyÅables",

710 
	`dm_devi˚_«me
(
t
->
md
), 
ty≥
);

711  -
EINVAL
;

714 i‡(
t
->
immuèbÀ_èrgë_ty≥
) {

715 i‡(
t
->
immuèbÀ_èrgë_ty≥
 !
tgt
->
ty≥
) {

716 
	`DMERR
("%s: immutableÅargetÅype %s cannot be mixed with otherÅargetÅypes",

717 
	`dm_devi˚_«me
(
t
->
md
),Å->
immuèbÀ_èrgë_ty≥
->
«me
);

718  -
EINVAL
;

720 } i‡(
	`dm_èrgë_is_immuèbÀ
(
tgt
->
ty≥
)) {

721 i‡(
t
->
num_èrgës
) {

722 
	`DMERR
("%s: immutableÅargetÅype %s cannot be mixed with otherÅargetÅypes",

723 
	`dm_devi˚_«me
(
t
->
md
), 
tgt
->
ty≥
->
«me
);

724  -
EINVAL
;

726 
t
->
immuèbÀ_èrgë_ty≥
 = 
tgt
->
ty≥
;

729 
tgt
->
èbÀ
 = 
t
;

730 
tgt
->
begö
 = 
°¨t
;

731 
tgt
->
Àn
 =Üen;

732 
tgt
->
îr‹
 = "UnknownÉrror";

737 i‡(!
	`adjoö
(
t
, 
tgt
)) {

738 
tgt
->
îr‹
 = "Gap inÅable";

739 
r
 = -
EINVAL
;

740 
bad
;

743 
r
 = 
	`dm_•lô_¨gs
(&
¨gc
, &
¨gv
, 
∑øms
);

744 i‡(
r
) {

745 
tgt
->
îr‹
 = "couldn't splitÖarameters (insufficient memory)";

746 
bad
;

749 
r
 = 
tgt
->
ty≥
->
	`˘r
—gt, 
¨gc
, 
¨gv
);

750 
	`k‰ì
(
¨gv
);

751 i‡(
r
)

752 
bad
;

754 
t
->
highs
[t->
num_èrgës
++] = 
tgt
->
begö
 +Ågt->
Àn
 - 1;

756 i‡(!
tgt
->
num_disˇrd_bios
 &&Ågt->
disˇrds_suµ‹ãd
)

757 
	`DMWARN
("%s: %s: ignoring discards_supported becauseÇum_discard_bios is zero.",

758 
	`dm_devi˚_«me
(
t
->
md
), 
ty≥
);

762 
bad
:

763 
	`DMERR
("%s: %s: %s", 
	`dm_devi˚_«me
(
t
->
md
), 
ty≥
, 
tgt
->
îr‹
);

764 
	`dm_put_èrgë_ty≥
(
tgt
->
ty≥
);

765  
r
;

766 
	}
}

771 
	$vÆid©e_√xt_¨g
(
dm_¨g
 *
¨g
, 
dm_¨g_£t
 *
¨g_£t
,

772 *
vÆue
, **
îr‹
, 
grou≥d
)

774 c⁄° *
¨g_°r
 = 
	`dm_shi·_¨g
(
¨g_£t
);

775 
dummy
;

777 i‡(!
¨g_°r
 ||

778 (
	`ssˇnf
(
¨g_°r
, "%u%c", 
vÆue
, &
dummy
) != 1) ||

779 (*
vÆue
 < 
¨g
->
mö
) ||

780 (*
vÆue
 > 
¨g
->
max
) ||

781 (
grou≥d
 && 
¨g_£t
->
¨gc
 < *
vÆue
)) {

782 *
îr‹
 = 
¨g
->error;

783  -
EINVAL
;

787 
	}
}

789 
	$dm_ªad_¨g
(
dm_¨g
 *
¨g
, 
dm_¨g_£t
 *
¨g_£t
,

790 *
vÆue
, **
îr‹
)

792  
	`vÆid©e_√xt_¨g
(
¨g
, 
¨g_£t
, 
vÆue
, 
îr‹
, 0);

793 
	}
}

794 
EXPORT_SYMBOL
(
dm_ªad_¨g
);

796 
	$dm_ªad_¨g_group
(
dm_¨g
 *
¨g
, 
dm_¨g_£t
 *
¨g_£t
,

797 *
vÆue
, **
îr‹
)

799  
	`vÆid©e_√xt_¨g
(
¨g
, 
¨g_£t
, 
vÆue
, 
îr‹
, 1);

800 
	}
}

801 
EXPORT_SYMBOL
(
dm_ªad_¨g_group
);

803 c⁄° *
	$dm_shi·_¨g
(
dm_¨g_£t
 *
as
)

805 *
r
;

807 i‡(
as
->
¨gc
) {

808 
as
->
¨gc
--;

809 
r
 = *
as
->
¨gv
;

810 
as
->
¨gv
++;

811  
r
;

814  
NULL
;

815 
	}
}

816 
EXPORT_SYMBOL
(
dm_shi·_¨g
);

818 
	$dm_c⁄sume_¨gs
(
dm_¨g_£t
 *
as
, 
num_¨gs
)

820 
	`BUG_ON
(
as
->
¨gc
 < 
num_¨gs
);

821 
as
->
¨gc
 -
num_¨gs
;

822 
as
->
¨gv
 +
num_¨gs
;

823 
	}
}

824 
EXPORT_SYMBOL
(
dm_c⁄sume_¨gs
);

826 
	$dm_èbÀ_£t_ty≥
(
dm_èbÀ
 *
t
)

828 
i
;

829 
bio_ba£d
 = 0, 
ªque°_ba£d
 = 0, 
hybrid
 = 0;

830 
dm_èrgë
 *
tgt
;

831 
dm_dev_öã∫Æ
 *
dd
;

832 
li°_hód
 *
devi˚s
;

833 
live_md_ty≥
;

835 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

836 
tgt
 = 
t
->
èrgës
 + 
i
;

837 i‡(
	`dm_èrgë_hybrid
(
tgt
))

838 
hybrid
 = 1;

839 i‡(
	`dm_èrgë_ªque°_ba£d
(
tgt
))

840 
ªque°_ba£d
 = 1;

842 
bio_ba£d
 = 1;

844 i‡(
bio_ba£d
 && 
ªque°_ba£d
) {

845 
	`DMWARN
("InconsistentÅable: differentÅargetÅypes"

847  -
EINVAL
;

851 i‡(
hybrid
 && !
bio_ba£d
 && !
ªque°_ba£d
) {

857 
live_md_ty≥
 = 
	`dm_gë_md_ty≥
(
t
->
md
);

858 i‡(
live_md_ty≥
 =
DM_TYPE_REQUEST_BASED
)

859 
ªque°_ba£d
 = 1;

861 
bio_ba£d
 = 1;

864 i‡(
bio_ba£d
) {

866 
t
->
ty≥
 = 
DM_TYPE_BIO_BASED
;

870 
	`BUG_ON
(!
ªque°_ba£d
);

873 
devi˚s
 = 
	`dm_èbÀ_gë_devi˚s
(
t
);

874 
	`li°_f‹_óch_íåy
(
dd
, 
devi˚s
, 
li°
) {

875 i‡(!
	`blk_queue_°ackabÀ
(
	`bdev_gë_queue
(
dd
->
dm_dev
->
bdev
))) {

876 
	`DMWARN
("tableÜoadÑejected: including"

878  -
EINVAL
;

888 i‡(
t
->
num_èrgës
 > 1) {

889 
	`DMWARN
("Request-based dm doesn't support multipleÅargets yet");

890  -
EINVAL
;

893 
t
->
ty≥
 = 
DM_TYPE_REQUEST_BASED
;

896 
	}
}

898 
	$dm_èbÀ_gë_ty≥
(
dm_èbÀ
 *
t
)

900  
t
->
ty≥
;

901 
	}
}

903 
èrgë_ty≥
 *
	$dm_èbÀ_gë_immuèbÀ_èrgë_ty≥
(
dm_èbÀ
 *
t
)

905  
t
->
immuèbÀ_èrgë_ty≥
;

906 
	}
}

908 
boﬁ
 
	$dm_èbÀ_ªque°_ba£d
(
dm_èbÀ
 *
t
)

910  
	`dm_èbÀ_gë_ty≥
(
t
Ë=
DM_TYPE_REQUEST_BASED
;

911 
	}
}

913 
	$dm_èbÀ_Æloc_md_mempoﬁs
(
dm_èbÀ
 *
t
)

915 
ty≥
 = 
	`dm_èbÀ_gë_ty≥
(
t
);

916 
≥r_bio_d©a_size
 = 0;

917 
dm_èrgë
 *
tgt
;

918 
i
;

920 i‡(
	`u∆ikñy
(
ty≥
 =
DM_TYPE_NONE
)) {

921 
	`DMWARN
("noÅableÅype is set, can'tállocate mempools");

922  -
EINVAL
;

925 i‡(
ty≥
 =
DM_TYPE_BIO_BASED
)

926 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

927 
tgt
 = 
t
->
èrgës
 + 
i
;

928 
≥r_bio_d©a_size
 = 
	`max
’î_bio_d©a_size, 
tgt
->per_bio_data_size);

931 
t
->
mempoﬁs
 = 
	`dm_Æloc_md_mempoﬁs
(
ty≥
,Å->
öãgrôy_suµ‹ãd
, 
≥r_bio_d©a_size
);

932 i‡(!
t
->
mempoﬁs
)

933  -
ENOMEM
;

936 
	}
}

938 
	$dm_èbÀ_‰ì_md_mempoﬁs
(
dm_èbÀ
 *
t
)

940 
	`dm_‰ì_md_mempoﬁs
(
t
->
mempoﬁs
);

941 
t
->
mempoﬁs
 = 
NULL
;

942 
	}
}

944 
dm_md_mempoﬁs
 *
	$dm_èbÀ_gë_md_mempoﬁs
(
dm_èbÀ
 *
t
)

946  
t
->
mempoﬁs
;

947 
	}
}

949 
	$£tup_ödexes
(
dm_èbÀ
 *
t
)

951 
i
;

952 
tŸÆ
 = 0;

953 
£˘‹_t
 *
ödexes
;

956 
i
 = 
t
->
dïth
 - 2; i >= 0; i--) {

957 
t
->
cou¡s
[
i
] = 
	`dm_div_up
—->cou¡s[ò+ 1], 
CHILDREN_PER_NODE
);

958 
tŸÆ
 +
t
->
cou¡s
[
i
];

961 
ödexes
 = (
£˘‹_t
 *Ë
	`dm_vˇŒoc
(
tŸÆ
, (Ë
NODE_SIZE
);

962 i‡(!
ödexes
)

963  -
ENOMEM
;

966 
i
 = 
t
->
dïth
 - 2; i >= 0; i--) {

967 
t
->
ödex
[
i
] = 
ödexes
;

968 
ödexes
 +(
KEYS_PER_NODE
 * 
t
->
cou¡s
[
i
]);

969 
	`£tup_båì_ödex
(
i
, 
t
);

973 
	}
}

978 
	$dm_èbÀ_buûd_ödex
(
dm_èbÀ
 *
t
)

980 
r
 = 0;

981 
Àaf_nodes
;

984 
Àaf_nodes
 = 
	`dm_div_up
(
t
->
num_èrgës
, 
KEYS_PER_NODE
);

985 
t
->
dïth
 = 1 + 
	`öt_log
(
Àaf_nodes
, 
CHILDREN_PER_NODE
);

988 
t
->
cou¡s
[t->
dïth
 - 1] = 
Àaf_nodes
;

989 
t
->
ödex
[t->
dïth
 - 1] =Å->
highs
;

991 i‡(
t
->
dïth
 >= 2)

992 
r
 = 
	`£tup_ödexes
(
t
);

994  
r
;

995 
	}
}

1004 
gídisk
 * 
	$dm_èbÀ_gë_öãgrôy_disk
(
dm_èbÀ
 *
t
,

1005 
boﬁ
 
m©ch_Æl
)

1007 
li°_hód
 *
devi˚s
 = 
	`dm_èbÀ_gë_devi˚s
(
t
);

1008 
dm_dev_öã∫Æ
 *
dd
 = 
NULL
;

1009 
gídisk
 *
¥ev_disk
 = 
NULL
, *
ãm∂©e_disk
 = NULL;

1011 
	`li°_f‹_óch_íåy
(
dd
, 
devi˚s
, 
li°
) {

1012 
ãm∂©e_disk
 = 
dd
->
dm_dev
->
bdev
->
bd_disk
;

1013 i‡(!
	`blk_gë_öãgrôy
(
ãm∂©e_disk
))

1014 
no_öãgrôy
;

1015 i‡(!
m©ch_Æl
 && !
	`blk_öãgrôy_is_öôülized
(
ãm∂©e_disk
))

1017 i‡(
¥ev_disk
 &&

1018 
	`blk_öãgrôy_com∑ª
(
¥ev_disk
, 
ãm∂©e_disk
) < 0)

1019 
no_öãgrôy
;

1020 
¥ev_disk
 = 
ãm∂©e_disk
;

1023  
ãm∂©e_disk
;

1025 
no_öãgrôy
:

1026 i‡(
¥ev_disk
)

1027 
	`DMWARN
("%s: integrityÇot set: %sánd %sÖrofile mismatch",

1028 
	`dm_devi˚_«me
(
t
->
md
),

1029 
¥ev_disk
->
disk_«me
,

1030 
ãm∂©e_disk
->
disk_«me
);

1031  
NULL
;

1032 
	}
}

1044 
	$dm_èbÀ_¥óŒoc_öãgrôy
(
dm_èbÀ
 *
t
, 
m≠≥d_devi˚
 *
md
)

1046 
gídisk
 *
ãm∂©e_disk
 = 
NULL
;

1048 
ãm∂©e_disk
 = 
	`dm_èbÀ_gë_öãgrôy_disk
(
t
, 
Ál£
);

1049 i‡(!
ãm∂©e_disk
)

1052 i‡(!
	`blk_öãgrôy_is_öôülized
(
	`dm_disk
(
md
))) {

1053 
t
->
öãgrôy_suµ‹ãd
 = 1;

1054  
	`blk_öãgrôy_ªgi°î
(
	`dm_disk
(
md
), 
NULL
);

1061 i‡(
	`blk_öãgrôy_is_öôülized
(
ãm∂©e_disk
) &&

1062 
	`blk_öãgrôy_com∑ª
(
	`dm_disk
(
md
), 
ãm∂©e_disk
) < 0) {

1063 
	`DMWARN
("%s: conflict withÉxisting integrityÖrofile: "

1065 
	`dm_devi˚_«me
(
t
->
md
),

1066 
ãm∂©e_disk
->
disk_«me
);

1071 
t
->
öãgrôy_suµ‹ãd
 = 1;

1073 
	}
}

1079 
	$dm_èbÀ_com∂ëe
(
dm_èbÀ
 *
t
)

1081 
r
;

1083 
r
 = 
	`dm_èbÀ_£t_ty≥
(
t
);

1084 i‡(
r
) {

1085 
	`DMERR
("unableÅo setÅableÅype");

1086  
r
;

1089 
r
 = 
	`dm_èbÀ_buûd_ödex
(
t
);

1090 i‡(
r
) {

1091 
	`DMERR
("unableÅo build btrees");

1092  
r
;

1095 
r
 = 
	`dm_èbÀ_¥óŒoc_öãgrôy
(
t
,Å->
md
);

1096 i‡(
r
) {

1097 
	`DMERR
("couldÇotÑegister integrityÖrofile.");

1098  
r
;

1101 
r
 = 
	`dm_èbÀ_Æloc_md_mempoﬁs
(
t
);

1102 i‡(
r
)

1103 
	`DMERR
("unableÅoállocate mempools");

1105  
r
;

1106 
	}
}

1108 
DEFINE_MUTEX
(
_evít_lock
);

1109 
dm_èbÀ_evít_ˇŒback
(
dm_èbÀ
 *
t
,

1110 (*
‚
)(*), *
c⁄ãxt
)

1112 
	`muãx_lock
(&
_evít_lock
);

1113 
t
->
evít_‚
 = 
‚
;

1114 
t
->
evít_c⁄ãxt
 = 
c⁄ãxt
;

1115 
	`muãx_u∆ock
(&
_evít_lock
);

1116 
	}
}

1118 
	$dm_èbÀ_evít
(
dm_èbÀ
 *
t
)

1124 
	`BUG_ON
(
	`ö_öãºu±
());

1126 
	`muãx_lock
(&
_evít_lock
);

1127 i‡(
t
->
evít_‚
)

1128 
t
->
	`evít_‚
—->
evít_c⁄ãxt
);

1129 
	`muãx_u∆ock
(&
_evít_lock
);

1130 
	}
}

1131 
EXPORT_SYMBOL
(
dm_èbÀ_evít
);

1133 
£˘‹_t
 
	$dm_èbÀ_gë_size
(
dm_èbÀ
 *
t
)

1135  
t
->
num_èrgës
 ? (t->
highs
[t->num_targets - 1] + 1) : 0;

1136 
	}
}

1137 
EXPORT_SYMBOL
(
dm_èbÀ_gë_size
);

1139 
dm_èrgë
 *
	$dm_èbÀ_gë_èrgë
(
dm_èbÀ
 *
t
, 
ödex
)

1141 i‡(
ödex
 >
t
->
num_èrgës
)

1142  
NULL
;

1144  
t
->
èrgës
 + 
ödex
;

1145 
	}
}

1153 
dm_èrgë
 *
	$dm_èbÀ_föd_èrgë
(
dm_èbÀ
 *
t
, 
£˘‹_t
 
£˘‹
)

1155 
l
, 
n
 = 0, 
k
 = 0;

1156 
£˘‹_t
 *
node
;

1158 
l
 = 0;Ü < 
t
->
dïth
;Ü++) {

1159 
n
 = 
	`gë_chûd
“, 
k
);

1160 
node
 = 
	`gë_node
(
t
, 
l
, 
n
);

1162 
k
 = 0; k < 
KEYS_PER_NODE
; k++)

1163 i‡(
node
[
k
] >
£˘‹
)

1167  &
t
->
èrgës
[(
KEYS_PER_NODE
 * 
n
Ë+ 
k
];

1168 
	}
}

1170 
	$cou¡_devi˚
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1171 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1173 *
num_devi˚s
 = 
d©a
;

1175 (*
num_devi˚s
)++;

1178 
	}
}

1186 
boﬁ
 
	$dm_èbÀ_has_no_d©a_devi˚s
(
dm_èbÀ
 *
èbÀ
)

1188 
dm_èrgë
 *
	`unöôülized_v¨
(
ti
);

1189 
i
 = 0, 
num_devi˚s
 = 0;

1191 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
)) {

1192 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
èbÀ
, 
i
++);

1194 i‡(!
ti
->
ty≥
->
ôî©e_devi˚s
)

1195  
Ál£
;

1197 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
cou¡_devi˚
, &
num_devi˚s
);

1198 i‡(
num_devi˚s
)

1199  
Ál£
;

1202  
åue
;

1203 
	}
}

1208 
	$dm_ˇlcuœã_queue_limôs
(
dm_èbÀ
 *
èbÀ
,

1209 
queue_limôs
 *
limôs
)

1211 
dm_èrgë
 *
	`unöôülized_v¨
(
ti
);

1212 
queue_limôs
 
ti_limôs
;

1213 
i
 = 0;

1215 
	`blk_£t_°ackög_limôs
(
limôs
);

1217 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
)) {

1218 
	`blk_£t_°ackög_limôs
(&
ti_limôs
);

1220 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
èbÀ
, 
i
++);

1222 i‡(!
ti
->
ty≥
->
ôî©e_devi˚s
)

1223 
comböe_limôs
;

1228 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
dm_£t_devi˚_limôs
,

1229 &
ti_limôs
);

1232 i‡(
ti
->
ty≥
->
io_höts
)

1233 
ti
->
ty≥
->
	`io_höts
—i, &
ti_limôs
);

1239 i‡(
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
devi˚_¨ó_is_övÆid
,

1240 &
ti_limôs
))

1241  -
EINVAL
;

1243 
comböe_limôs
:

1248 i‡(
	`blk_°ack_limôs
(
limôs
, &
ti_limôs
, 0) < 0)

1249 
	`DMWARN
("%s:áddingÅarget device "

1252 
	`dm_devi˚_«me
(
èbÀ
->
md
),

1253 (Ë
ti
->
begö
,

1254 (Ë
ti
->
Àn
);

1257  
	`vÆid©e_h¨dw¨e_logiˇl_block_Æignmít
(
èbÀ
, 
limôs
);

1258 
	}
}

1267 
	$dm_èbÀ_£t_öãgrôy
(
dm_èbÀ
 *
t
)

1269 
gídisk
 *
ãm∂©e_disk
 = 
NULL
;

1271 i‡(!
	`blk_gë_öãgrôy
(
	`dm_disk
(
t
->
md
)))

1274 
ãm∂©e_disk
 = 
	`dm_èbÀ_gë_öãgrôy_disk
(
t
, 
åue
);

1275 i‡(
ãm∂©e_disk
)

1276 
	`blk_öãgrôy_ªgi°î
(
	`dm_disk
(
t
->
md
),

1277 
	`blk_gë_öãgrôy
(
ãm∂©e_disk
));

1278 i‡(
	`blk_öãgrôy_is_öôülized
(
	`dm_disk
(
t
->
md
)))

1279 
	`DMWARN
("%s: deviceÇoÜonger hasá valid integrityÖrofile",

1280 
	`dm_devi˚_«me
(
t
->
md
));

1282 
	`DMWARN
("%s: unableÅoÉstablishán integrityÖrofile",

1283 
	`dm_devi˚_«me
(
t
->
md
));

1284 
	}
}

1286 
	$devi˚_Êush_ˇ∑bÀ
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1287 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1289 
Êush
 = (*(*)
d©a
);

1290 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1292  
q
 && (q->
Êush_Êags
 & 
Êush
);

1293 
	}
}

1295 
boﬁ
 
	$dm_èbÀ_suµ‹ts_Êush
(
dm_èbÀ
 *
t
, 
Êush
)

1297 
dm_èrgë
 *
ti
;

1298 
i
 = 0;

1306 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
t
)) {

1307 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
t
, 
i
++);

1309 i‡(!
ti
->
num_Êush_bios
)

1312 i‡(
ti
->
Êush_suµ‹ãd
)

1315 i‡(
ti
->
ty≥
->
ôî©e_devi˚s
 &&

1316 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
devi˚_Êush_ˇ∑bÀ
, &
Êush
))

1321 
	}
}

1323 
boﬁ
 
	$dm_èbÀ_disˇrd_zî€s_d©a
(
dm_èbÀ
 *
t
)

1325 
dm_èrgë
 *
ti
;

1326 
i
 = 0;

1329 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
t
)) {

1330 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
t
, 
i
++);

1332 i‡(
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
)

1337 
	}
}

1339 
	$devi˚_is_n⁄rŸ
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1340 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1342 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1344  
q
 && 
	`blk_queue_n⁄rŸ
(q);

1345 
	}
}

1347 
	$devi˚_is_nŸ_øndom
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1348 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1350 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1352  
q
 && !
	`blk_queue_add_øndom
(q);

1353 
	}
}

1355 
	$queue_suµ‹ts_sg_mîge
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1356 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1358 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1360  
q
 && !
	`ã°_bô
(
QUEUE_FLAG_NO_SG_MERGE
, &q->
queue_Êags
);

1361 
	}
}

1363 
boﬁ
 
	$dm_èbÀ_Æl_devi˚s_©åibuã
(
dm_èbÀ
 *
t
,

1364 
ôî©e_devi˚s_ˇŒout_‚
 
func
)

1366 
dm_èrgë
 *
ti
;

1367 
i
 = 0;

1369 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
t
)) {

1370 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
t
, 
i
++);

1372 i‡(!
ti
->
ty≥
->
ôî©e_devi˚s
 ||

1373 !
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
func
, 
NULL
))

1378 
	}
}

1380 
	$devi˚_nŸ_wrôe_ßme_ˇ∑bÀ
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1381 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1383 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1385  
q
 && !q->
limôs
.
max_wrôe_ßme_£˘‹s
;

1386 
	}
}

1388 
boﬁ
 
	$dm_èbÀ_suµ‹ts_wrôe_ßme
(
dm_èbÀ
 *
t
)

1390 
dm_èrgë
 *
ti
;

1391 
i
 = 0;

1393 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
t
)) {

1394 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
t
, 
i
++);

1396 i‡(!
ti
->
num_wrôe_ßme_bios
)

1397  
Ál£
;

1399 i‡(!
ti
->
ty≥
->
ôî©e_devi˚s
 ||

1400 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
devi˚_nŸ_wrôe_ßme_ˇ∑bÀ
, 
NULL
))

1401  
Ál£
;

1404  
åue
;

1405 
	}
}

1407 
	$devi˚_disˇrd_ˇ∑bÀ
(
dm_èrgë
 *
ti
, 
dm_dev
 *
dev
,

1408 
£˘‹_t
 
°¨t
, se˘‹_à
Àn
, *
d©a
)

1410 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dev
->
bdev
);

1412  
q
 && 
	`blk_queue_disˇrd
(q);

1413 
	}
}

1415 
boﬁ
 
	$dm_èbÀ_suµ‹ts_disˇrds
(
dm_èbÀ
 *
t
)

1417 
dm_èrgë
 *
ti
;

1418 
i
 = 0;

1427 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
t
)) {

1428 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
t
, 
i
++);

1430 i‡(!
ti
->
num_disˇrd_bios
)

1433 i‡(
ti
->
disˇrds_suµ‹ãd
)

1436 i‡(
ti
->
ty≥
->
ôî©e_devi˚s
 &&

1437 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
devi˚_disˇrd_ˇ∑bÀ
, 
NULL
))

1442 
	}
}

1444 
	$dm_èbÀ_£t_ª°ri˘i⁄s
(
dm_èbÀ
 *
t
, 
ªque°_queue
 *
q
,

1445 
queue_limôs
 *
limôs
)

1447 
Êush
 = 0;

1452 
q
->
limôs
 = *limits;

1454 i‡(!
	`dm_èbÀ_suµ‹ts_disˇrds
(
t
))

1455 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
q
);

1457 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
q
);

1459 i‡(
	`dm_èbÀ_suµ‹ts_Êush
(
t
, 
REQ_FLUSH
)) {

1460 
Êush
 |
REQ_FLUSH
;

1461 i‡(
	`dm_èbÀ_suµ‹ts_Êush
(
t
, 
REQ_FUA
))

1462 
Êush
 |
REQ_FUA
;

1464 
	`blk_queue_Êush
(
q
, 
Êush
);

1466 i‡(!
	`dm_èbÀ_disˇrd_zî€s_d©a
(
t
))

1467 
q
->
limôs
.
disˇrd_zî€s_d©a
 = 0;

1470 i‡(
	`dm_èbÀ_Æl_devi˚s_©åibuã
(
t
, 
devi˚_is_n⁄rŸ
))

1471 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_NONROT
, 
q
);

1473 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_NONROT
, 
q
);

1475 i‡(!
	`dm_èbÀ_suµ‹ts_wrôe_ßme
(
t
))

1476 
q
->
limôs
.
max_wrôe_ßme_£˘‹s
 = 0;

1478 i‡(
	`dm_èbÀ_Æl_devi˚s_©åibuã
(
t
, 
queue_suµ‹ts_sg_mîge
))

1479 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_NO_SG_MERGE
, 
q
);

1481 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_NO_SG_MERGE
, 
q
);

1483 
	`dm_èbÀ_£t_öãgrôy
(
t
);

1491 i‡(
	`blk_queue_add_øndom
(
q
Ë&& 
	`dm_èbÀ_Æl_devi˚s_©åibuã
(
t
, 
devi˚_is_nŸ_øndom
))

1492 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_ADD_RANDOM
, 
q
);

1503 
	`smp_mb
();

1504 i‡(
	`dm_èbÀ_ªque°_ba£d
(
t
))

1505 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_STACKABLE
, 
q
);

1506 
	}
}

1508 
	$dm_èbÀ_gë_num_èrgës
(
dm_èbÀ
 *
t
)

1510  
t
->
num_èrgës
;

1511 
	}
}

1513 
li°_hód
 *
	$dm_èbÀ_gë_devi˚s
(
dm_èbÀ
 *
t
)

1515  &
t
->
devi˚s
;

1516 
	}
}

1518 
fmode_t
 
	$dm_èbÀ_gë_mode
(
dm_èbÀ
 *
t
)

1520  
t
->
mode
;

1521 
	}
}

1522 
EXPORT_SYMBOL
(
dm_èbÀ_gë_mode
);

1524 
	$su•íd_èrgës
(
dm_èbÀ
 *
t
, 
po°su•íd
)

1526 
i
 = 
t
->
num_èrgës
;

1527 
dm_èrgë
 *
ti
 = 
t
->
èrgës
;

1529 
i
--) {

1530 i‡(
po°su•íd
) {

1531 i‡(
ti
->
ty≥
->
po°su•íd
)

1532 
ti
->
ty≥
->
	`po°su•íd
(ti);

1533 } i‡(
ti
->
ty≥
->
¥esu•íd
)

1534 
ti
->
ty≥
->
	`¥esu•íd
(ti);

1536 
ti
++;

1538 
	}
}

1540 
	$dm_èbÀ_¥esu•íd_èrgës
(
dm_èbÀ
 *
t
)

1542 i‡(!
t
)

1545 
	`su•íd_èrgës
(
t
, 0);

1546 
	}
}

1548 
	$dm_èbÀ_po°su•íd_èrgës
(
dm_èbÀ
 *
t
)

1550 i‡(!
t
)

1553 
	`su•íd_èrgës
(
t
, 1);

1554 
	}
}

1556 
	$dm_èbÀ_ªsume_èrgës
(
dm_èbÀ
 *
t
)

1558 
i
, 
r
 = 0;

1560 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

1561 
dm_èrgë
 *
ti
 = 
t
->
èrgës
 + 
i
;

1563 i‡(!
ti
->
ty≥
->
¥îesume
)

1566 
r
 = 
ti
->
ty≥
->
	`¥îesume
(ti);

1567 i‡(
r
) {

1568 
	`DMERR
("%s: %s:Öreresume failed,Érror = %d",

1569 
	`dm_devi˚_«me
(
t
->
md
), 
ti
->
ty≥
->
«me
, 
r
);

1570  
r
;

1574 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

1575 
dm_èrgë
 *
ti
 = 
t
->
èrgës
 + 
i
;

1577 i‡(
ti
->
ty≥
->
ªsume
)

1578 
ti
->
ty≥
->
	`ªsume
(ti);

1582 
	}
}

1584 
	$dm_èbÀ_add_èrgë_ˇŒbacks
(
dm_èbÀ
 *
t
, 
dm_èrgë_ˇŒbacks
 *
cb
)

1586 
	`li°_add
(&
cb
->
li°
, &
t
->
èrgë_ˇŒbacks
);

1587 
	}
}

1588 
EXPORT_SYMBOL_GPL
(
dm_èbÀ_add_èrgë_ˇŒbacks
);

1590 
	$dm_èbÀ_™y_c⁄ge°ed
(
dm_èbÀ
 *
t
, 
bdi_bôs
)

1592 
dm_dev_öã∫Æ
 *
dd
;

1593 
li°_hód
 *
devi˚s
 = 
	`dm_èbÀ_gë_devi˚s
(
t
);

1594 
dm_èrgë_ˇŒbacks
 *
cb
;

1595 
r
 = 0;

1597 
	`li°_f‹_óch_íåy
(
dd
, 
devi˚s
, 
li°
) {

1598 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
dd
->
dm_dev
->
bdev
);

1599 
b
[
BDEVNAME_SIZE
];

1601 i‡(
	`likñy
(
q
))

1602 
r
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bdi_bôs
);

1604 
	`DMWARN_LIMIT
("%s:ány_congested:Çonexistent device %s",

1605 
	`dm_devi˚_«me
(
t
->
md
),

1606 
	`bdev«me
(
dd
->
dm_dev
->
bdev
, 
b
));

1609 
	`li°_f‹_óch_íåy
(
cb
, &
t
->
èrgë_ˇŒbacks
, 
li°
)

1610 i‡(
cb
->
c⁄ge°ed_‚
)

1611 
r
 |
cb
->
	`c⁄ge°ed_‚
(cb, 
bdi_bôs
);

1613  
r
;

1614 
	}
}

1616 
	$dm_èbÀ_™y_busy_èrgë
(
dm_èbÀ
 *
t
)

1618 
i
;

1619 
dm_èrgë
 *
ti
;

1621 
i
 = 0; i < 
t
->
num_èrgës
; i++) {

1622 
ti
 = 
t
->
èrgës
 + 
i
;

1623 i‡(
ti
->
ty≥
->
busy
 &&Åi->ty≥->
	`busy
(ti))

1628 
	}
}

1630 
m≠≥d_devi˚
 *
	$dm_èbÀ_gë_md
(
dm_èbÀ
 *
t
)

1632  
t
->
md
;

1633 
	}
}

1634 
EXPORT_SYMBOL
(
dm_èbÀ_gë_md
);

1636 
	$dm_èbÀ_run_md_queue_async
(
dm_èbÀ
 *
t
)

1638 
m≠≥d_devi˚
 *
md
;

1639 
ªque°_queue
 *
queue
;

1640 
Êags
;

1642 i‡(!
	`dm_èbÀ_ªque°_ba£d
(
t
))

1645 
md
 = 
	`dm_èbÀ_gë_md
(
t
);

1646 
queue
 = 
	`dm_gë_md_queue
(
md
);

1647 i‡(
queue
) {

1648 
	`•ö_lock_úqßve
(
queue
->
queue_lock
, 
Êags
);

1649 
	`blk_run_queue_async
(
queue
);

1650 
	`•ö_u∆ock_úqª°‹e
(
queue
->
queue_lock
, 
Êags
);

1652 
	}
}

1653 
EXPORT_SYMBOL
(
dm_èbÀ_run_md_queue_async
);

	@dm-target.c

7 
	~"dm.h
"

9 
	~<löux/moduÀ.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/kmod.h
>

12 
	~<löux/bio.h
>

14 
	#DM_MSG_PREFIX
 "èrgë"

	)

16 
LIST_HEAD
(
_èrgës
);

17 
DECLARE_RWSEM
(
_lock
);

19 
	#DM_MOD_NAME_SIZE
 32

	)

21 
ölöe
 
èrgë_ty≥
 *
	$__föd_èrgë_ty≥
(c⁄° *
«me
)

23 
èrgë_ty≥
 *
â
;

25 
	`li°_f‹_óch_íåy
(
â
, &
_èrgës
, 
li°
)

26 i‡(!
	`°rcmp
(
«me
, 
â
->name))

27  
â
;

29  
NULL
;

30 
	}
}

32 
èrgë_ty≥
 *
	$gë_èrgë_ty≥
(c⁄° *
«me
)

34 
èrgë_ty≥
 *
â
;

36 
	`down_ªad
(&
_lock
);

38 
â
 = 
	`__föd_èrgë_ty≥
(
«me
);

39 i‡(
â
 && !
	`åy_moduÀ_gë
—t->
moduÀ
))

40 
â
 = 
NULL
;

42 
	`up_ªad
(&
_lock
);

43  
â
;

44 
	}
}

46 
	$lﬂd_moduÀ
(c⁄° *
«me
)

48 
	`ªque°_moduÀ
("dm-%s", 
«me
);

49 
	}
}

51 
èrgë_ty≥
 *
	$dm_gë_èrgë_ty≥
(c⁄° *
«me
)

53 
èrgë_ty≥
 *
â
 = 
	`gë_èrgë_ty≥
(
«me
);

55 i‡(!
â
) {

56 
	`lﬂd_moduÀ
(
«me
);

57 
â
 = 
	`gë_èrgë_ty≥
(
«me
);

60  
â
;

61 
	}
}

63 
	$dm_put_èrgë_ty≥
(
èrgë_ty≥
 *
â
)

65 
	`down_ªad
(&
_lock
);

66 
	`moduÀ_put
(
â
->
moduÀ
);

67 
	`up_ªad
(&
_lock
);

68 
	}
}

70 
dm_èrgë_ôî©e
((*
ôî_func
)(
èrgë_ty≥
 *
â
,

71 *
∑øm
), *param)

73 
èrgë_ty≥
 *
â
;

75 
	`down_ªad
(&
_lock
);

76 
	`li°_f‹_óch_íåy
(
â
, &
_èrgës
, 
li°
)

77 
	`ôî_func
(
â
, 
∑øm
);

78 
	`up_ªad
(&
_lock
);

81 
	}
}

83 
	$dm_ªgi°î_èrgë
(
èrgë_ty≥
 *
â
)

85 
rv
 = 0;

87 
	`down_wrôe
(&
_lock
);

88 i‡(
	`__föd_èrgë_ty≥
(
â
->
«me
))

89 
rv
 = -
EEXIST
;

91 
	`li°_add
(&
â
->
li°
, &
_èrgës
);

93 
	`up_wrôe
(&
_lock
);

94  
rv
;

95 
	}
}

97 
	$dm_uƒegi°î_èrgë
(
èrgë_ty≥
 *
â
)

99 
	`down_wrôe
(&
_lock
);

100 i‡(!
	`__föd_èrgë_ty≥
(
â
->
«me
)) {

101 
	`DMCRIT
("Uƒegi°îög uƒecogni£dÅ¨gë: %s", 
â
->
«me
);

102 
	`BUG
();

105 
	`li°_dñ
(&
â
->
li°
);

107 
	`up_wrôe
(&
_lock
);

108 
	}
}

114 
	$io_îr_˘r
(
dm_èrgë
 *
â
, 
¨gc
, **
¨gs
)

119 
â
->
num_disˇrd_bios
 = 1;

122 
	}
}

124 
	$io_îr_då
(
dm_èrgë
 *
â
)

127 
	}
}

129 
	$io_îr_m≠
(
dm_èrgë
 *
â
, 
bio
 *bio)

131  -
EIO
;

132 
	}
}

134 
	$io_îr_m≠_rq
(
dm_èrgë
 *
ti
, 
ªque°
 *
˛⁄e
,

135 
m≠_öfo
 *
m≠_c⁄ãxt
)

137  -
EIO
;

138 
	}
}

140 
èrgë_ty≥
 
	gîr‹_èrgë
 = {

141 .
«me
 = "error",

142 .
	gvîsi⁄
 = {1, 2, 0},

143 .
	g˘r
 = 
io_îr_˘r
,

144 .
	gdå
 = 
io_îr_då
,

145 .
	gm≠
 = 
io_îr_m≠
,

146 .
	gm≠_rq
 = 
io_îr_m≠_rq
,

149 
__öô
 
	$dm_èrgë_öô
()

151  
	`dm_ªgi°î_èrgë
(&
îr‹_èrgë
);

152 
	}
}

154 
	$dm_èrgë_exô
()

156 
	`dm_uƒegi°î_èrgë
(&
îr‹_èrgë
);

157 
	}
}

159 
EXPORT_SYMBOL
(
dm_ªgi°î_èrgë
);

160 
EXPORT_SYMBOL
(
dm_uƒegi°î_èrgë
);

	@dm-thin-metadata.c

7 
	~"dm-thö-mëad©a.h
"

8 
	~"≥rsi°ít-d©a/dm-båì.h
"

9 
	~"≥rsi°ít-d©a/dm-•a˚-m≠.h
"

10 
	~"≥rsi°ít-d©a/dm-•a˚-m≠-disk.h
"

11 
	~"≥rsi°ít-d©a/dm-å™ß˘i⁄-m™agî.h
"

13 
	~<löux/li°.h
>

14 
	~<löux/devi˚-m≠≥r.h
>

15 
	~<löux/w‹kqueue.h
>

75 
	#DM_MSG_PREFIX
 "thö mëad©a"

	)

77 
	#THIN_SUPERBLOCK_MAGIC
 27022010

	)

78 
	#THIN_SUPERBLOCK_LOCATION
 0

	)

79 
	#THIN_VERSION
 2

	)

80 
	#THIN_METADATA_CACHE_SIZE
 64

	)

81 
	#SECTOR_TO_BLOCK_SHIFT
 3

	)

87 
	#THIN_MAX_CONCURRENT_LOCKS
 5

	)

90 
	#SPACE_MAP_ROOT_SIZE
 128

	)

95 
	sthö_disk_su≥rblock
 {

96 
__À32
 
	mcsum
;

97 
__À32
 
	mÊags
;

98 
__À64
 
	mblockƒ
;

100 
__u8
 
	muuid
[16];

101 
__À64
 
	mmagic
;

102 
__À32
 
	mvîsi⁄
;

103 
__À32
 
	mtime
;

105 
__À64
 
	må™s_id
;

110 
__À64
 
	mhñd_roŸ
;

112 
__u8
 
	md©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

113 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

118 
__À64
 
	md©a_m≠pög_roŸ
;

123 
__À64
 
	mdevi˚_dëaûs_roŸ
;

125 
__À32
 
	md©a_block_size
;

127 
__À32
 
	mmëad©a_block_size
;

128 
__À64
 
	mmëad©a_ƒ_blocks
;

130 
__À32
 
	mcom∑t_Êags
;

131 
__À32
 
	mcom∑t_ro_Êags
;

132 
__À32
 
	möcom∑t_Êags
;

133 } 
	g__∑cked
;

135 
	sdisk_devi˚_dëaûs
 {

136 
__À64
 
	mm≠≥d_blocks
;

137 
__À64
 
	må™ß˘i⁄_id
;

138 
__À32
 
	m¸óti⁄_time
;

139 
__À32
 
	m¢≠shŸãd_time
;

140 } 
	g__∑cked
;

142 
	sdm_poﬁ_mëad©a
 {

143 
hli°_node
 
	mhash
;

145 
block_devi˚
 *
	mbdev
;

146 
dm_block_m™agî
 *
	mbm
;

147 
dm_•a˚_m≠
 *
	mmëad©a_sm
;

148 
dm_•a˚_m≠
 *
	md©a_sm
;

149 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

150 
dm_å™ß˘i⁄_m™agî
 *
	mnb_tm
;

157 
dm_båì_öfo
 
	möfo
;

162 
dm_båì_öfo
 
	mnb_öfo
;

167 
dm_båì_öfo
 
	mé_öfo
;

172 
dm_båì_öfo
 
	mbl_öfo
;

177 
dm_båì_öfo
 
	mdëaûs_öfo
;

179 
rw_£m≠h‹e
 
	mroŸ_lock
;

180 
uöt32_t
 
	mtime
;

181 
dm_block_t
 
	mroŸ
;

182 
dm_block_t
 
	mdëaûs_roŸ
;

183 
li°_hód
 
	mthö_devi˚s
;

184 
uöt64_t
 
	må™s_id
;

185 
	mÊags
;

186 
£˘‹_t
 
	md©a_block_size
;

187 
boﬁ
 
	mªad_⁄ly
:1;

194 
boﬁ
 
	mÁû_io
:1;

200 
__u8
 
	md©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

201 
__u8
 
	mmëad©a_•a˚_m≠_roŸ
[
SPACE_MAP_ROOT_SIZE
];

204 
	sdm_thö_devi˚
 {

205 
li°_hód
 
	mli°
;

206 
dm_poﬁ_mëad©a
 *
	mpmd
;

207 
dm_thö_id
 
	mid
;

209 
	m›í_cou¡
;

210 
boﬁ
 
	mch™ged
:1;

211 
boﬁ
 
	mab‹ãd_wôh_ch™ges
:1;

212 
uöt64_t
 
	mm≠≥d_blocks
;

213 
uöt64_t
 
	må™ß˘i⁄_id
;

214 
uöt32_t
 
	m¸óti⁄_time
;

215 
uöt32_t
 
	m¢≠shŸãd_time
;

222 
	#SUPERBLOCK_CSUM_XOR
 160774

	)

224 
	$sb_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

225 
dm_block
 *
b
,

226 
size_t
 
block_size
)

228 
thö_disk_su≥rblock
 *
disk_su≥r
 = 
	`dm_block_d©a
(
b
);

230 
disk_su≥r
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

231 
disk_su≥r
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&disk_su≥r->
Êags
,

232 
block_size
 - (
__À32
),

233 
SUPERBLOCK_CSUM_XOR
));

234 
	}
}

236 
	$sb_check
(
dm_block_vÆid©‹
 *
v
,

237 
dm_block
 *
b
,

238 
size_t
 
block_size
)

240 
thö_disk_su≥rblock
 *
disk_su≥r
 = 
	`dm_block_d©a
(
b
);

241 
__À32
 
csum_À
;

243 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
disk_su≥r
->
blockƒ
)) {

244 
	`DMERR
("sb_check failed: blocknr %llu: "

245 "w™ãd %Œu", 
	`À64_to_˝u
(
disk_su≥r
->
blockƒ
),

246 ()
	`dm_block_loˇti⁄
(
b
));

247  -
ENOTBLK
;

250 i‡(
	`À64_to_˝u
(
disk_su≥r
->
magic
Ë!
THIN_SUPERBLOCK_MAGIC
) {

251 
	`DMERR
("sb_check failed: magic %llu: "

252 "w™ãd %Œu", 
	`À64_to_˝u
(
disk_su≥r
->
magic
),

253 ()
THIN_SUPERBLOCK_MAGIC
);

254  -
EILSEQ
;

257 
csum_À
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
disk_su≥r
->
Êags
,

258 
block_size
 - (
__À32
),

259 
SUPERBLOCK_CSUM_XOR
));

260 i‡(
csum_À
 !
disk_su≥r
->
csum
) {

261 
	`DMERR
("sb_check failed: csum %u: wanted %u",

262 
	`À32_to_˝u
(
csum_À
),Üe32_to_˝u(
disk_su≥r
->
csum
));

263  -
EILSEQ
;

267 
	}
}

269 
dm_block_vÆid©‹
 
	gsb_vÆid©‹
 = {

270 .
«me
 = "superblock",

271 .
	g¥ï¨e_f‹_wrôe
 = 
sb_¥ï¨e_f‹_wrôe
,

272 .
	gcheck
 = 
sb_check


279 
uöt64_t
 
	$∑ck_block_time
(
dm_block_t
 
b
, 
uöt32_t
 
t
)

281  (
b
 << 24Ë| 
t
;

282 
	}
}

284 
	$u≈ack_block_time
(
uöt64_t
 
v
, 
dm_block_t
 *
b
, 
uöt32_t
 *
t
)

286 *
b
 = 
v
 >> 24;

287 *
t
 = 
v
 & ((1 << 24) - 1);

288 
	}
}

290 
	$d©a_block_öc
(*
c⁄ãxt
, c⁄° *
vÆue_À
)

292 
dm_•a˚_m≠
 *
sm
 = 
c⁄ãxt
;

293 
__À64
 
v_À
;

294 
uöt64_t
 
b
;

295 
uöt32_t
 
t
;

297 
	`mem˝y
(&
v_À
, 
vÆue_À
, (v_le));

298 
	`u≈ack_block_time
(
	`À64_to_˝u
(
v_À
), &
b
, &
t
);

299 
	`dm_sm_öc_block
(
sm
, 
b
);

300 
	}
}

302 
	$d©a_block_dec
(*
c⁄ãxt
, c⁄° *
vÆue_À
)

304 
dm_•a˚_m≠
 *
sm
 = 
c⁄ãxt
;

305 
__À64
 
v_À
;

306 
uöt64_t
 
b
;

307 
uöt32_t
 
t
;

309 
	`mem˝y
(&
v_À
, 
vÆue_À
, (v_le));

310 
	`u≈ack_block_time
(
	`À64_to_˝u
(
v_À
), &
b
, &
t
);

311 
	`dm_sm_dec_block
(
sm
, 
b
);

312 
	}
}

314 
	$d©a_block_equÆ
(*
c⁄ãxt
, c⁄° *
vÆue1_À
, c⁄° *
vÆue2_À
)

316 
__À64
 
v1_À
, 
v2_À
;

317 
uöt64_t
 
b1
, 
b2
;

318 
uöt32_t
 
t
;

320 
	`mem˝y
(&
v1_À
, 
vÆue1_À
, (v1_le));

321 
	`mem˝y
(&
v2_À
, 
vÆue2_À
, (v2_le));

322 
	`u≈ack_block_time
(
	`À64_to_˝u
(
v1_À
), &
b1
, &
t
);

323 
	`u≈ack_block_time
(
	`À64_to_˝u
(
v2_À
), &
b2
, &
t
);

325  
b1
 =
b2
;

326 
	}
}

328 
	$subåì_öc
(*
c⁄ãxt
, c⁄° *
vÆue
)

330 
dm_båì_öfo
 *
öfo
 = 
c⁄ãxt
;

331 
__À64
 
roŸ_À
;

332 
uöt64_t
 
roŸ
;

334 
	`mem˝y
(&
roŸ_À
, 
vÆue
, (root_le));

335 
roŸ
 = 
	`À64_to_˝u
(
roŸ_À
);

336 
	`dm_tm_öc
(
öfo
->
tm
, 
roŸ
);

337 
	}
}

339 
	$subåì_dec
(*
c⁄ãxt
, c⁄° *
vÆue
)

341 
dm_båì_öfo
 *
öfo
 = 
c⁄ãxt
;

342 
__À64
 
roŸ_À
;

343 
uöt64_t
 
roŸ
;

345 
	`mem˝y
(&
roŸ_À
, 
vÆue
, (root_le));

346 
roŸ
 = 
	`À64_to_˝u
(
roŸ_À
);

347 i‡(
	`dm_båì_dñ
(
öfo
, 
roŸ
))

348 
	`DMERR
("btree delete failed\n");

349 
	}
}

351 
	$subåì_equÆ
(*
c⁄ãxt
, c⁄° *
vÆue1_À
, c⁄° *
vÆue2_À
)

353 
__À64
 
v1_À
, 
v2_À
;

354 
	`mem˝y
(&
v1_À
, 
vÆue1_À
, (v1_le));

355 
	`mem˝y
(&
v2_À
, 
vÆue2_À
, (v2_le));

357  
v1_À
 =
v2_À
;

358 
	}
}

362 
	$su≥rblock_lock_zîo
(
dm_poﬁ_mëad©a
 *
pmd
,

363 
dm_block
 **
sblock
)

365  
	`dm_bm_wrôe_lock_zîo
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

366 &
sb_vÆid©‹
, 
sblock
);

367 
	}
}

369 
	$su≥rblock_lock
(
dm_poﬁ_mëad©a
 *
pmd
,

370 
dm_block
 **
sblock
)

372  
	`dm_bm_wrôe_lock
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

373 &
sb_vÆid©‹
, 
sblock
);

374 
	}
}

376 
	$__su≥rblock_Æl_zî€s
(
dm_block_m™agî
 *
bm
, *
ªsu…
)

378 
r
;

379 
i
;

380 
dm_block
 *
b
;

381 
__À64
 *
d©a_À
, 
zîo
 = 
	`˝u_to_À64
(0);

382 
block_size
 = 
	`dm_bm_block_size
(
bm
Ë/ (
__À64
);

387 
r
 = 
	`dm_bm_ªad_lock
(
bm
, 
THIN_SUPERBLOCK_LOCATION
, 
NULL
, &
b
);

388 i‡(
r
)

389  
r
;

391 
d©a_À
 = 
	`dm_block_d©a
(
b
);

392 *
ªsu…
 = 1;

393 
i
 = 0; i < 
block_size
; i++) {

394 i‡(
d©a_À
[
i
] !
zîo
) {

395 *
ªsu…
 = 0;

400  
	`dm_bm_u∆ock
(
b
);

401 
	}
}

403 
	$__£tup_båì_dëaûs
(
dm_poﬁ_mëad©a
 *
pmd
)

405 
pmd
->
öfo
.
tm
 =Ömd->tm;

406 
pmd
->
öfo
.
Àvñs
 = 2;

407 
pmd
->
öfo
.
vÆue_ty≥
.
c⁄ãxt
 =Ömd->
d©a_sm
;

408 
pmd
->
öfo
.
vÆue_ty≥
.
size
 = (
__À64
);

409 
pmd
->
öfo
.
vÆue_ty≥
.
öc
 = 
d©a_block_öc
;

410 
pmd
->
öfo
.
vÆue_ty≥
.
dec
 = 
d©a_block_dec
;

411 
pmd
->
öfo
.
vÆue_ty≥
.
equÆ
 = 
d©a_block_equÆ
;

413 
	`mem˝y
(&
pmd
->
nb_öfo
, &pmd->
öfo
, (pmd->nb_info));

414 
pmd
->
nb_öfo
.
tm
 =Ömd->
nb_tm
;

416 
pmd
->
é_öfo
.
tm
 =Ömd->tm;

417 
pmd
->
é_öfo
.
Àvñs
 = 1;

418 
pmd
->
é_öfo
.
vÆue_ty≥
.
c⁄ãxt
 = &pmd->
bl_öfo
;

419 
pmd
->
é_öfo
.
vÆue_ty≥
.
size
 = (
__À64
);

420 
pmd
->
é_öfo
.
vÆue_ty≥
.
öc
 = 
subåì_öc
;

421 
pmd
->
é_öfo
.
vÆue_ty≥
.
dec
 = 
subåì_dec
;

422 
pmd
->
é_öfo
.
vÆue_ty≥
.
equÆ
 = 
subåì_equÆ
;

424 
pmd
->
bl_öfo
.
tm
 =Ömd->tm;

425 
pmd
->
bl_öfo
.
Àvñs
 = 1;

426 
pmd
->
bl_öfo
.
vÆue_ty≥
.
c⁄ãxt
 =Ömd->
d©a_sm
;

427 
pmd
->
bl_öfo
.
vÆue_ty≥
.
size
 = (
__À64
);

428 
pmd
->
bl_öfo
.
vÆue_ty≥
.
öc
 = 
d©a_block_öc
;

429 
pmd
->
bl_öfo
.
vÆue_ty≥
.
dec
 = 
d©a_block_dec
;

430 
pmd
->
bl_öfo
.
vÆue_ty≥
.
equÆ
 = 
d©a_block_equÆ
;

432 
pmd
->
dëaûs_öfo
.
tm
 =Ömd->tm;

433 
pmd
->
dëaûs_öfo
.
Àvñs
 = 1;

434 
pmd
->
dëaûs_öfo
.
vÆue_ty≥
.
c⁄ãxt
 = 
NULL
;

435 
pmd
->
dëaûs_öfo
.
vÆue_ty≥
.
size
 = (
disk_devi˚_dëaûs
);

436 
pmd
->
dëaûs_öfo
.
vÆue_ty≥
.
öc
 = 
NULL
;

437 
pmd
->
dëaûs_öfo
.
vÆue_ty≥
.
dec
 = 
NULL
;

438 
pmd
->
dëaûs_öfo
.
vÆue_ty≥
.
equÆ
 = 
NULL
;

439 
	}
}

441 
	$ßve_sm_roŸs
(
dm_poﬁ_mëad©a
 *
pmd
)

443 
r
;

444 
size_t
 
Àn
;

446 
r
 = 
	`dm_sm_roŸ_size
(
pmd
->
mëad©a_sm
, &
Àn
);

447 i‡(
r
 < 0)

448  
r
;

450 
r
 = 
	`dm_sm_c›y_roŸ
(
pmd
->
mëad©a_sm
, &pmd->
mëad©a_•a˚_m≠_roŸ
, 
Àn
);

451 i‡(
r
 < 0)

452  
r
;

454 
r
 = 
	`dm_sm_roŸ_size
(
pmd
->
d©a_sm
, &
Àn
);

455 i‡(
r
 < 0)

456  
r
;

458  
	`dm_sm_c›y_roŸ
(
pmd
->
d©a_sm
, &pmd->
d©a_•a˚_m≠_roŸ
, 
Àn
);

459 
	}
}

461 
	$c›y_sm_roŸs
(
dm_poﬁ_mëad©a
 *
pmd
,

462 
thö_disk_su≥rblock
 *
disk
)

464 
	`mem˝y
(&
disk
->
mëad©a_•a˚_m≠_roŸ
,

465 &
pmd
->
mëad©a_•a˚_m≠_roŸ
,

466 (
pmd
->
mëad©a_•a˚_m≠_roŸ
));

468 
	`mem˝y
(&
disk
->
d©a_•a˚_m≠_roŸ
,

469 &
pmd
->
d©a_•a˚_m≠_roŸ
,

470 (
pmd
->
d©a_•a˚_m≠_roŸ
));

471 
	}
}

473 
	$__wrôe_öôül_su≥rblock
(
dm_poﬁ_mëad©a
 *
pmd
)

475 
r
;

476 
dm_block
 *
sblock
;

477 
thö_disk_su≥rblock
 *
disk_su≥r
;

478 
£˘‹_t
 
bdev_size
 = 
	`i_size_ªad
(
pmd
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

480 i‡(
bdev_size
 > 
THIN_METADATA_MAX_SECTORS
)

481 
bdev_size
 = 
THIN_METADATA_MAX_SECTORS
;

483 
r
 = 
	`dm_sm_commô
(
pmd
->
d©a_sm
);

484 i‡(
r
 < 0)

485  
r
;

487 
r
 = 
	`ßve_sm_roŸs
(
pmd
);

488 i‡(
r
 < 0)

489  
r
;

491 
r
 = 
	`dm_tm_¥e_commô
(
pmd
->
tm
);

492 i‡(
r
 < 0)

493  
r
;

495 
r
 = 
	`su≥rblock_lock_zîo
(
pmd
, &
sblock
);

496 i‡(
r
)

497  
r
;

499 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

500 
disk_su≥r
->
Êags
 = 0;

501 
	`mem£t
(
disk_su≥r
->
uuid
, 0, (disk_super->uuid));

502 
disk_su≥r
->
magic
 = 
	`˝u_to_À64
(
THIN_SUPERBLOCK_MAGIC
);

503 
disk_su≥r
->
vîsi⁄
 = 
	`˝u_to_À32
(
THIN_VERSION
);

504 
disk_su≥r
->
time
 = 0;

505 
disk_su≥r
->
å™s_id
 = 0;

506 
disk_su≥r
->
hñd_roŸ
 = 0;

508 
	`c›y_sm_roŸs
(
pmd
, 
disk_su≥r
);

510 
disk_su≥r
->
d©a_m≠pög_roŸ
 = 
	`˝u_to_À64
(
pmd
->
roŸ
);

511 
disk_su≥r
->
devi˚_dëaûs_roŸ
 = 
	`˝u_to_À64
(
pmd
->
dëaûs_roŸ
);

512 
disk_su≥r
->
mëad©a_block_size
 = 
	`˝u_to_À32
(
THIN_METADATA_BLOCK_SIZE
);

513 
disk_su≥r
->
mëad©a_ƒ_blocks
 = 
	`˝u_to_À64
(
bdev_size
 >> 
SECTOR_TO_BLOCK_SHIFT
);

514 
disk_su≥r
->
d©a_block_size
 = 
	`˝u_to_À32
(
pmd
->data_block_size);

516  
	`dm_tm_commô
(
pmd
->
tm
, 
sblock
);

517 
	}
}

519 
	$__f‹m©_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
)

521 
r
;

523 
r
 = 
	`dm_tm_¸óã_wôh_sm
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

524 &
pmd
->
tm
, &pmd->
mëad©a_sm
);

525 i‡(
r
 < 0) {

526 
	`DMERR
("tm_create_with_sm failed");

527  
r
;

530 
pmd
->
d©a_sm
 = 
	`dm_sm_disk_¸óã
’md->
tm
, 0);

531 i‡(
	`IS_ERR
(
pmd
->
d©a_sm
)) {

532 
	`DMERR
("sm_disk_create failed");

533 
r
 = 
	`PTR_ERR
(
pmd
->
d©a_sm
);

534 
bad_˛ónup_tm
;

537 
pmd
->
nb_tm
 = 
	`dm_tm_¸óã_n⁄_blockög_˛⁄e
’md->
tm
);

538 i‡(!
pmd
->
nb_tm
) {

539 
	`DMERR
("couldÇot createÇon-blocking cloneÅm");

540 
r
 = -
ENOMEM
;

541 
bad_˛ónup_d©a_sm
;

544 
	`__£tup_båì_dëaûs
(
pmd
);

546 
r
 = 
	`dm_båì_em±y
(&
pmd
->
öfo
, &pmd->
roŸ
);

547 i‡(
r
 < 0)

548 
bad_˛ónup_nb_tm
;

550 
r
 = 
	`dm_båì_em±y
(&
pmd
->
dëaûs_öfo
, &pmd->
dëaûs_roŸ
);

551 i‡(
r
 < 0) {

552 
	`DMERR
("couldn't create devicesÑoot");

553 
bad_˛ónup_nb_tm
;

556 
r
 = 
	`__wrôe_öôül_su≥rblock
(
pmd
);

557 i‡(
r
)

558 
bad_˛ónup_nb_tm
;

562 
bad_˛ónup_nb_tm
:

563 
	`dm_tm_de°roy
(
pmd
->
nb_tm
);

564 
bad_˛ónup_d©a_sm
:

565 
	`dm_sm_de°roy
(
pmd
->
d©a_sm
);

566 
bad_˛ónup_tm
:

567 
	`dm_tm_de°roy
(
pmd
->
tm
);

568 
	`dm_sm_de°roy
(
pmd
->
mëad©a_sm
);

570  
r
;

571 
	}
}

573 
	$__check_öcom∑t_„©uªs
(
thö_disk_su≥rblock
 *
disk_su≥r
,

574 
dm_poﬁ_mëad©a
 *
pmd
)

576 
uöt32_t
 
„©uªs
;

578 
„©uªs
 = 
	`À32_to_˝u
(
disk_su≥r
->
öcom∑t_Êags
Ë& ~
THIN_FEATURE_INCOMPAT_SUPP
;

579 i‡(
„©uªs
) {

580 
	`DMERR
("couldÇotáccess metadata dueÅo unsupported optional features (%lx).",

581 ()
„©uªs
);

582  -
EINVAL
;

588 i‡(
	`gë_disk_ro
(
pmd
->
bdev
->
bd_disk
))

591 
„©uªs
 = 
	`À32_to_˝u
(
disk_su≥r
->
com∑t_ro_Êags
Ë& ~
THIN_FEATURE_COMPAT_RO_SUPP
;

592 i‡(
„©uªs
) {

593 
	`DMERR
("couldÇotáccess metadata RDWR dueÅo unsupported optional features (%lx).",

594 ()
„©uªs
);

595  -
EINVAL
;

599 
	}
}

601 
	$__›í_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
)

603 
r
;

604 
dm_block
 *
sblock
;

605 
thö_disk_su≥rblock
 *
disk_su≥r
;

607 
r
 = 
	`dm_bm_ªad_lock
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

608 &
sb_vÆid©‹
, &
sblock
);

609 i‡(
r
 < 0) {

610 
	`DMERR
("couldn'tÑead superblock");

611  
r
;

614 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

617 i‡(
	`À32_to_˝u
(
disk_su≥r
->
d©a_block_size
Ë!
pmd
->data_block_size) {

618 
	`DMERR
("changingÅhe data block size (from %uÅo %llu) isÇot supported",

619 
	`À32_to_˝u
(
disk_su≥r
->
d©a_block_size
),

620 ()
pmd
->
d©a_block_size
);

621 
r
 = -
EINVAL
;

622 
bad_u∆ock_sblock
;

625 
r
 = 
	`__check_öcom∑t_„©uªs
(
disk_su≥r
, 
pmd
);

626 i‡(
r
 < 0)

627 
bad_u∆ock_sblock
;

629 
r
 = 
	`dm_tm_›í_wôh_sm
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

630 
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
,

631 (
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
),

632 &
pmd
->
tm
, &pmd->
mëad©a_sm
);

633 i‡(
r
 < 0) {

634 
	`DMERR
("tm_open_with_sm failed");

635 
bad_u∆ock_sblock
;

638 
pmd
->
d©a_sm
 = 
	`dm_sm_disk_›í
’md->
tm
, 
disk_su≥r
->
d©a_•a˚_m≠_roŸ
,

639 (
disk_su≥r
->
d©a_•a˚_m≠_roŸ
));

640 i‡(
	`IS_ERR
(
pmd
->
d©a_sm
)) {

641 
	`DMERR
("sm_disk_open failed");

642 
r
 = 
	`PTR_ERR
(
pmd
->
d©a_sm
);

643 
bad_˛ónup_tm
;

646 
pmd
->
nb_tm
 = 
	`dm_tm_¸óã_n⁄_blockög_˛⁄e
’md->
tm
);

647 i‡(!
pmd
->
nb_tm
) {

648 
	`DMERR
("couldÇot createÇon-blocking cloneÅm");

649 
r
 = -
ENOMEM
;

650 
bad_˛ónup_d©a_sm
;

653 
	`__£tup_båì_dëaûs
(
pmd
);

654  
	`dm_bm_u∆ock
(
sblock
);

656 
bad_˛ónup_d©a_sm
:

657 
	`dm_sm_de°roy
(
pmd
->
d©a_sm
);

658 
bad_˛ónup_tm
:

659 
	`dm_tm_de°roy
(
pmd
->
tm
);

660 
	`dm_sm_de°roy
(
pmd
->
mëad©a_sm
);

661 
bad_u∆ock_sblock
:

662 
	`dm_bm_u∆ock
(
sblock
);

664  
r
;

665 
	}
}

667 
	$__›í_‹_f‹m©_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
, 
boﬁ
 
f‹m©_devi˚
)

669 
r
, 
unf‹m©ãd
;

671 
r
 = 
	`__su≥rblock_Æl_zî€s
(
pmd
->
bm
, &
unf‹m©ãd
);

672 i‡(
r
)

673  
r
;

675 i‡(
unf‹m©ãd
)

676  
f‹m©_devi˚
 ? 
	`__f‹m©_mëad©a
(
pmd
Ë: -
EPERM
;

678  
	`__›í_mëad©a
(
pmd
);

679 
	}
}

681 
	$__¸óã_≥rsi°ít_d©a_obje˘s
(
dm_poﬁ_mëad©a
 *
pmd
, 
boﬁ
 
f‹m©_devi˚
)

683 
r
;

685 
pmd
->
bm
 = 
	`dm_block_m™agî_¸óã
’md->
bdev
, 
THIN_METADATA_BLOCK_SIZE
 << 
SECTOR_SHIFT
,

686 
THIN_METADATA_CACHE_SIZE
,

687 
THIN_MAX_CONCURRENT_LOCKS
);

688 i‡(
	`IS_ERR
(
pmd
->
bm
)) {

689 
	`DMERR
("couldÇot create block manager");

690  
	`PTR_ERR
(
pmd
->
bm
);

693 
r
 = 
	`__›í_‹_f‹m©_mëad©a
(
pmd
, 
f‹m©_devi˚
);

694 i‡(
r
)

695 
	`dm_block_m™agî_de°roy
(
pmd
->
bm
);

697  
r
;

698 
	}
}

700 
	$__de°roy_≥rsi°ít_d©a_obje˘s
(
dm_poﬁ_mëad©a
 *
pmd
)

702 
	`dm_sm_de°roy
(
pmd
->
d©a_sm
);

703 
	`dm_sm_de°roy
(
pmd
->
mëad©a_sm
);

704 
	`dm_tm_de°roy
(
pmd
->
nb_tm
);

705 
	`dm_tm_de°roy
(
pmd
->
tm
);

706 
	`dm_block_m™agî_de°roy
(
pmd
->
bm
);

707 
	}
}

709 
	$__begö_å™ß˘i⁄
(
dm_poﬁ_mëad©a
 *
pmd
)

711 
r
;

712 
thö_disk_su≥rblock
 *
disk_su≥r
;

713 
dm_block
 *
sblock
;

719 
r
 = 
	`dm_bm_ªad_lock
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

720 &
sb_vÆid©‹
, &
sblock
);

721 i‡(
r
)

722  
r
;

724 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

725 
pmd
->
time
 = 
	`À32_to_˝u
(
disk_su≥r
->time);

726 
pmd
->
roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->
d©a_m≠pög_roŸ
);

727 
pmd
->
dëaûs_roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->
devi˚_dëaûs_roŸ
);

728 
pmd
->
å™s_id
 = 
	`À64_to_˝u
(
disk_su≥r
->trans_id);

729 
pmd
->
Êags
 = 
	`À32_to_˝u
(
disk_su≥r
->flags);

730 
pmd
->
d©a_block_size
 = 
	`À32_to_˝u
(
disk_su≥r
->data_block_size);

732 
	`dm_bm_u∆ock
(
sblock
);

734 
	}
}

736 
	$__wrôe_ch™ged_dëaûs
(
dm_poﬁ_mëad©a
 *
pmd
)

738 
r
;

739 
dm_thö_devi˚
 *
td
, *
tmp
;

740 
disk_devi˚_dëaûs
 
dëaûs
;

741 
uöt64_t
 
key
;

743 
	`li°_f‹_óch_íåy_ß„
(
td
, 
tmp
, &
pmd
->
thö_devi˚s
, 
li°
) {

744 i‡(!
td
->
ch™ged
)

747 
key
 = 
td
->
id
;

749 
dëaûs
.
m≠≥d_blocks
 = 
	`˝u_to_À64
(
td
->mapped_blocks);

750 
dëaûs
.
å™ß˘i⁄_id
 = 
	`˝u_to_À64
(
td
->transaction_id);

751 
dëaûs
.
¸óti⁄_time
 = 
	`˝u_to_À32
(
td
->creation_time);

752 
dëaûs
.
¢≠shŸãd_time
 = 
	`˝u_to_À32
(
td
->snapshotted_time);

753 
	`__dm_bÀss_f‹_disk
(&
dëaûs
);

755 
r
 = 
	`dm_båì_ö£π
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

756 &
key
, &
dëaûs
, &
pmd
->
dëaûs_roŸ
);

757 i‡(
r
)

758  
r
;

760 i‡(
td
->
›í_cou¡
)

761 
td
->
ch™ged
 = 0;

763 
	`li°_dñ
(&
td
->
li°
);

764 
	`k‰ì
(
td
);

769 
	}
}

771 
	$__commô_å™ß˘i⁄
(
dm_poﬁ_mëad©a
 *
pmd
)

773 
r
;

774 
size_t
 
mëad©a_Àn
, 
d©a_Àn
;

775 
thö_disk_su≥rblock
 *
disk_su≥r
;

776 
dm_block
 *
sblock
;

781 
	`BUILD_BUG_ON
((
thö_disk_su≥rblock
) > 512);

783 
r
 = 
	`__wrôe_ch™ged_dëaûs
(
pmd
);

784 i‡(
r
 < 0)

785  
r
;

787 
r
 = 
	`dm_sm_commô
(
pmd
->
d©a_sm
);

788 i‡(
r
 < 0)

789  
r
;

791 
r
 = 
	`dm_tm_¥e_commô
(
pmd
->
tm
);

792 i‡(
r
 < 0)

793  
r
;

795 
r
 = 
	`dm_sm_roŸ_size
(
pmd
->
mëad©a_sm
, &
mëad©a_Àn
);

796 i‡(
r
 < 0)

797  
r
;

799 
r
 = 
	`dm_sm_roŸ_size
(
pmd
->
d©a_sm
, &
d©a_Àn
);

800 i‡(
r
 < 0)

801  
r
;

803 
r
 = 
	`ßve_sm_roŸs
(
pmd
);

804 i‡(
r
 < 0)

805  
r
;

807 
r
 = 
	`su≥rblock_lock
(
pmd
, &
sblock
);

808 i‡(
r
)

809  
r
;

811 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

812 
disk_su≥r
->
time
 = 
	`˝u_to_À32
(
pmd
->time);

813 
disk_su≥r
->
d©a_m≠pög_roŸ
 = 
	`˝u_to_À64
(
pmd
->
roŸ
);

814 
disk_su≥r
->
devi˚_dëaûs_roŸ
 = 
	`˝u_to_À64
(
pmd
->
dëaûs_roŸ
);

815 
disk_su≥r
->
å™s_id
 = 
	`˝u_to_À64
(
pmd
->trans_id);

816 
disk_su≥r
->
Êags
 = 
	`˝u_to_À32
(
pmd
->flags);

818 
	`c›y_sm_roŸs
(
pmd
, 
disk_su≥r
);

820  
	`dm_tm_commô
(
pmd
->
tm
, 
sblock
);

821 
	}
}

823 
dm_poﬁ_mëad©a
 *
	$dm_poﬁ_mëad©a_›í
(
block_devi˚
 *
bdev
,

824 
£˘‹_t
 
d©a_block_size
,

825 
boﬁ
 
f‹m©_devi˚
)

827 
r
;

828 
dm_poﬁ_mëad©a
 *
pmd
;

830 
pmd
 = 
	`kmÆloc
((*pmd), 
GFP_KERNEL
);

831 i‡(!
pmd
) {

832 
	`DMERR
("couldÇotállocate metadata struct");

833  
	`ERR_PTR
(-
ENOMEM
);

836 
	`öô_rw£m
(&
pmd
->
roŸ_lock
);

837 
pmd
->
time
 = 0;

838 
	`INIT_LIST_HEAD
(&
pmd
->
thö_devi˚s
);

839 
pmd
->
ªad_⁄ly
 = 
Ál£
;

840 
pmd
->
Áû_io
 = 
Ál£
;

841 
pmd
->
bdev
 = bdev;

842 
pmd
->
d©a_block_size
 = data_block_size;

844 
r
 = 
	`__¸óã_≥rsi°ít_d©a_obje˘s
(
pmd
, 
f‹m©_devi˚
);

845 i‡(
r
) {

846 
	`k‰ì
(
pmd
);

847  
	`ERR_PTR
(
r
);

850 
r
 = 
	`__begö_å™ß˘i⁄
(
pmd
);

851 i‡(
r
 < 0) {

852 i‡(
	`dm_poﬁ_mëad©a_˛o£
(
pmd
) < 0)

853 
	`DMWARN
("%s: dm_poﬁ_mëad©a_˛o£(ËÁûed.", 
__func__
);

854  
	`ERR_PTR
(
r
);

857  
pmd
;

858 
	}
}

860 
	$dm_poﬁ_mëad©a_˛o£
(
dm_poﬁ_mëad©a
 *
pmd
)

862 
r
;

863 
›í_devi˚s
 = 0;

864 
dm_thö_devi˚
 *
td
, *
tmp
;

866 
	`down_ªad
(&
pmd
->
roŸ_lock
);

867 
	`li°_f‹_óch_íåy_ß„
(
td
, 
tmp
, &
pmd
->
thö_devi˚s
, 
li°
) {

868 i‡(
td
->
›í_cou¡
)

869 
›í_devi˚s
++;

871 
	`li°_dñ
(&
td
->
li°
);

872 
	`k‰ì
(
td
);

875 
	`up_ªad
(&
pmd
->
roŸ_lock
);

877 i‡(
›í_devi˚s
) {

878 
	`DMERR
("attemptÅo closeÖmd when %u device(s)áre still open",

879 
›í_devi˚s
);

880  -
EBUSY
;

883 i‡(!
pmd
->
ªad_⁄ly
 && !pmd->
Áû_io
) {

884 
r
 = 
	`__commô_å™ß˘i⁄
(
pmd
);

885 i‡(
r
 < 0)

886 
	`DMWARN
("%s: __commit_transaction() failed,Érror = %d",

887 
__func__
, 
r
);

890 i‡(!
pmd
->
Áû_io
)

891 
	`__de°roy_≥rsi°ít_d©a_obje˘s
(
pmd
);

893 
	`k‰ì
(
pmd
);

895 
	}
}

902 
	$__›í_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
,

903 
dm_thö_id
 
dev
, 
¸óã
,

904 
dm_thö_devi˚
 **
td
)

906 
r
, 
ch™ged
 = 0;

907 
dm_thö_devi˚
 *
td2
;

908 
uöt64_t
 
key
 = 
dev
;

909 
disk_devi˚_dëaûs
 
dëaûs_À
;

914 
	`li°_f‹_óch_íåy
(
td2
, &
pmd
->
thö_devi˚s
, 
li°
)

915 i‡(
td2
->
id
 =
dev
) {

919 i‡(
¸óã
)

920  -
EEXIST
;

922 
td2
->
›í_cou¡
++;

923 *
td
 = 
td2
;

930 
r
 = 
	`dm_båì_lookup
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

931 &
key
, &
dëaûs_À
);

932 i‡(
r
) {

933 i‡(
r
 !-
ENODATA
 || !
¸óã
)

934  
r
;

939 
ch™ged
 = 1;

940 
dëaûs_À
.
m≠≥d_blocks
 = 0;

941 
dëaûs_À
.
å™ß˘i⁄_id
 = 
	`˝u_to_À64
(
pmd
->
å™s_id
);

942 
dëaûs_À
.
¸óti⁄_time
 = 
	`˝u_to_À32
(
pmd
->
time
);

943 
dëaûs_À
.
¢≠shŸãd_time
 = 
	`˝u_to_À32
(
pmd
->
time
);

946 *
td
 = 
	`kmÆloc
((**td), 
GFP_NOIO
);

947 i‡(!*
td
)

948  -
ENOMEM
;

950 (*
td
)->
pmd
 =Ömd;

951 (*
td
)->
id
 = 
dev
;

952 (*
td
)->
›í_cou¡
 = 1;

953 (*
td
)->
ch™ged
 = changed;

954 (*
td
)->
ab‹ãd_wôh_ch™ges
 = 
Ál£
;

955 (*
td
)->
m≠≥d_blocks
 = 
	`À64_to_˝u
(
dëaûs_À
.mapped_blocks);

956 (*
td
)->
å™ß˘i⁄_id
 = 
	`À64_to_˝u
(
dëaûs_À
.transaction_id);

957 (*
td
)->
¸óti⁄_time
 = 
	`À32_to_˝u
(
dëaûs_À
.creation_time);

958 (*
td
)->
¢≠shŸãd_time
 = 
	`À32_to_˝u
(
dëaûs_À
.snapshotted_time);

960 
	`li°_add
(&(*
td
)->
li°
, &
pmd
->
thö_devi˚s
);

963 
	}
}

965 
	$__˛o£_devi˚
(
dm_thö_devi˚
 *
td
)

967 --
td
->
›í_cou¡
;

968 
	}
}

970 
	$__¸óã_thö
(
dm_poﬁ_mëad©a
 *
pmd
,

971 
dm_thö_id
 
dev
)

973 
r
;

974 
dm_block_t
 
dev_roŸ
;

975 
uöt64_t
 
key
 = 
dev
;

976 
disk_devi˚_dëaûs
 
dëaûs_À
;

977 
dm_thö_devi˚
 *
td
;

978 
__À64
 
vÆue
;

980 
r
 = 
	`dm_båì_lookup
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

981 &
key
, &
dëaûs_À
);

982 i‡(!
r
)

983  -
EEXIST
;

988 
r
 = 
	`dm_båì_em±y
(&
pmd
->
bl_öfo
, &
dev_roŸ
);

989 i‡(
r
)

990  
r
;

995 
vÆue
 = 
	`˝u_to_À64
(
dev_roŸ
);

996 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

997 
r
 = 
	`dm_båì_ö£π
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &
vÆue
, &pmd->root);

998 i‡(
r
) {

999 
	`dm_båì_dñ
(&
pmd
->
bl_öfo
, 
dev_roŸ
);

1000  
r
;

1003 
r
 = 
	`__›í_devi˚
(
pmd
, 
dev
, 1, &
td
);

1004 i‡(
r
) {

1005 
	`dm_båì_ªmove
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &pmd->root);

1006 
	`dm_båì_dñ
(&
pmd
->
bl_öfo
, 
dev_roŸ
);

1007  
r
;

1009 
	`__˛o£_devi˚
(
td
);

1011  
r
;

1012 
	}
}

1014 
	$dm_poﬁ_¸óã_thö
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
)

1016 
r
 = -
EINVAL
;

1018 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1019 i‡(!
pmd
->
Áû_io
)

1020 
r
 = 
	`__¸óã_thö
(
pmd
, 
dev
);

1021 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1023  
r
;

1024 
	}
}

1026 
	$__£t_¢≠shŸ_dëaûs
(
dm_poﬁ_mëad©a
 *
pmd
,

1027 
dm_thö_devi˚
 *
¢≠
,

1028 
dm_thö_id
 
‹igö
, 
uöt32_t
 
time
)

1030 
r
;

1031 
dm_thö_devi˚
 *
td
;

1033 
r
 = 
	`__›í_devi˚
(
pmd
, 
‹igö
, 0, &
td
);

1034 i‡(
r
)

1035  
r
;

1037 
td
->
ch™ged
 = 1;

1038 
td
->
¢≠shŸãd_time
 = 
time
;

1040 
¢≠
->
m≠≥d_blocks
 = 
td
->mapped_blocks;

1041 
¢≠
->
¢≠shŸãd_time
 = 
time
;

1042 
	`__˛o£_devi˚
(
td
);

1045 
	}
}

1047 
	$__¸óã_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
,

1048 
dm_thö_id
 
dev
, dm_thö_id 
‹igö
)

1050 
r
;

1051 
dm_block_t
 
‹igö_roŸ
;

1052 
uöt64_t
 
key
 = 
‹igö
, 
dev_key
 = 
dev
;

1053 
dm_thö_devi˚
 *
td
;

1054 
disk_devi˚_dëaûs
 
dëaûs_À
;

1055 
__À64
 
vÆue
;

1058 
r
 = 
	`dm_båì_lookup
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

1059 &
dev_key
, &
dëaûs_À
);

1060 i‡(!
r
)

1061  -
EEXIST
;

1064 
r
 = 
	`dm_båì_lookup
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &
vÆue
);

1065 i‡(
r
)

1066  
r
;

1067 
‹igö_roŸ
 = 
	`À64_to_˝u
(
vÆue
);

1070 
	`dm_tm_öc
(
pmd
->
tm
, 
‹igö_roŸ
);

1073 
vÆue
 = 
	`˝u_to_À64
(
‹igö_roŸ
);

1074 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

1075 
key
 = 
dev
;

1076 
r
 = 
	`dm_båì_ö£π
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &
vÆue
, &pmd->root);

1077 i‡(
r
) {

1078 
	`dm_tm_dec
(
pmd
->
tm
, 
‹igö_roŸ
);

1079  
r
;

1082 
pmd
->
time
++;

1084 
r
 = 
	`__›í_devi˚
(
pmd
, 
dev
, 1, &
td
);

1085 i‡(
r
)

1086 
bad
;

1088 
r
 = 
	`__£t_¢≠shŸ_dëaûs
(
pmd
, 
td
, 
‹igö
,Ömd->
time
);

1089 
	`__˛o£_devi˚
(
td
);

1091 i‡(
r
)

1092 
bad
;

1096 
bad
:

1097 
	`dm_båì_ªmove
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &pmd->root);

1098 
	`dm_båì_ªmove
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

1099 &
key
, &
pmd
->
dëaûs_roŸ
);

1100  
r
;

1101 
	}
}

1103 
	$dm_poﬁ_¸óã_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
,

1104 
dm_thö_id
 
dev
,

1105 
dm_thö_id
 
‹igö
)

1107 
r
 = -
EINVAL
;

1109 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1110 i‡(!
pmd
->
Áû_io
)

1111 
r
 = 
	`__¸óã_¢≠
(
pmd
, 
dev
, 
‹igö
);

1112 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1114  
r
;

1115 
	}
}

1117 
	$__dñëe_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
)

1119 
r
;

1120 
uöt64_t
 
key
 = 
dev
;

1121 
dm_thö_devi˚
 *
td
;

1124 
r
 = 
	`__›í_devi˚
(
pmd
, 
dev
, 0, &
td
);

1125 i‡(
r
)

1126  
r
;

1128 i‡(
td
->
›í_cou¡
 > 1) {

1129 
	`__˛o£_devi˚
(
td
);

1130  -
EBUSY
;

1133 
	`li°_dñ
(&
td
->
li°
);

1134 
	`k‰ì
(
td
);

1135 
r
 = 
	`dm_båì_ªmove
(&
pmd
->
dëaûs_öfo
,Ömd->
dëaûs_roŸ
,

1136 &
key
, &
pmd
->
dëaûs_roŸ
);

1137 i‡(
r
)

1138  
r
;

1140 
r
 = 
	`dm_båì_ªmove
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
key
, &pmd->root);

1141 i‡(
r
)

1142  
r
;

1145 
	}
}

1147 
	$dm_poﬁ_dñëe_thö_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
,

1148 
dm_thö_id
 
dev
)

1150 
r
 = -
EINVAL
;

1152 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1153 i‡(!
pmd
->
Áû_io
)

1154 
r
 = 
	`__dñëe_devi˚
(
pmd
, 
dev
);

1155 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1157  
r
;

1158 
	}
}

1160 
	$dm_poﬁ_£t_mëad©a_å™ß˘i⁄_id
(
dm_poﬁ_mëad©a
 *
pmd
,

1161 
uöt64_t
 
cuºít_id
,

1162 
uöt64_t
 
√w_id
)

1164 
r
 = -
EINVAL
;

1166 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1168 i‡(
pmd
->
Áû_io
)

1169 
out
;

1171 i‡(
pmd
->
å™s_id
 !
cuºít_id
) {

1172 
	`DMERR
("mismatchedÅransaction id");

1173 
out
;

1176 
pmd
->
å™s_id
 = 
√w_id
;

1177 
r
 = 0;

1179 
out
:

1180 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1182  
r
;

1183 
	}
}

1185 
	$dm_poﬁ_gë_mëad©a_å™ß˘i⁄_id
(
dm_poﬁ_mëad©a
 *
pmd
,

1186 
uöt64_t
 *
ªsu…
)

1188 
r
 = -
EINVAL
;

1190 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1191 i‡(!
pmd
->
Áû_io
) {

1192 *
ªsu…
 = 
pmd
->
å™s_id
;

1193 
r
 = 0;

1195 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1197  
r
;

1198 
	}
}

1200 
	$__ª£rve_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
)

1202 
r
, 
öc
;

1203 
thö_disk_su≥rblock
 *
disk_su≥r
;

1204 
dm_block
 *
c›y
, *
sblock
;

1205 
dm_block_t
 
hñd_roŸ
;

1210 
	`dm_sm_öc_block
(
pmd
->
mëad©a_sm
, 
THIN_SUPERBLOCK_LOCATION
);

1211 
r
 = 
	`dm_tm_shadow_block
(
pmd
->
tm
, 
THIN_SUPERBLOCK_LOCATION
,

1212 &
sb_vÆid©‹
, &
c›y
, &
öc
);

1213 i‡(
r
)

1214  
r
;

1216 
	`BUG_ON
(!
öc
);

1218 
hñd_roŸ
 = 
	`dm_block_loˇti⁄
(
c›y
);

1219 
disk_su≥r
 = 
	`dm_block_d©a
(
c›y
);

1221 i‡(
	`À64_to_˝u
(
disk_su≥r
->
hñd_roŸ
)) {

1222 
	`DMWARN
("Pool metadata snapshotálreadyÉxists:ÑeleaseÅhis beforeÅakingánother.");

1224 
	`dm_tm_dec
(
pmd
->
tm
, 
hñd_roŸ
);

1225 
	`dm_tm_u∆ock
(
pmd
->
tm
, 
c›y
);

1226  -
EBUSY
;

1232 
	`mem£t
(&
disk_su≥r
->
d©a_•a˚_m≠_roŸ
, 0,

1233 (
disk_su≥r
->
d©a_•a˚_m≠_roŸ
));

1234 
	`mem£t
(&
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
, 0,

1235 (
disk_su≥r
->
mëad©a_•a˚_m≠_roŸ
));

1240 
	`dm_tm_öc
(
pmd
->
tm
, 
	`À64_to_˝u
(
disk_su≥r
->
d©a_m≠pög_roŸ
));

1241 
	`dm_tm_öc
(
pmd
->
tm
, 
	`À64_to_˝u
(
disk_su≥r
->
devi˚_dëaûs_roŸ
));

1242 
	`dm_tm_u∆ock
(
pmd
->
tm
, 
c›y
);

1247 
r
 = 
	`su≥rblock_lock
(
pmd
, &
sblock
);

1248 i‡(
r
) {

1249 
	`dm_tm_dec
(
pmd
->
tm
, 
hñd_roŸ
);

1250  
r
;

1253 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

1254 
disk_su≥r
->
hñd_roŸ
 = 
	`˝u_to_À64
(held_root);

1255 
	`dm_bm_u∆ock
(
sblock
);

1257 
	}
}

1259 
	$dm_poﬁ_ª£rve_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
)

1261 
r
 = -
EINVAL
;

1263 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1264 i‡(!
pmd
->
Áû_io
)

1265 
r
 = 
	`__ª£rve_mëad©a_¢≠
(
pmd
);

1266 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1268  
r
;

1269 
	}
}

1271 
	$__ªÀa£_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
)

1273 
r
;

1274 
thö_disk_su≥rblock
 *
disk_su≥r
;

1275 
dm_block
 *
sblock
, *
c›y
;

1276 
dm_block_t
 
hñd_roŸ
;

1278 
r
 = 
	`su≥rblock_lock
(
pmd
, &
sblock
);

1279 i‡(
r
)

1280  
r
;

1282 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

1283 
hñd_roŸ
 = 
	`À64_to_˝u
(
disk_su≥r
->held_root);

1284 
disk_su≥r
->
hñd_roŸ
 = 
	`˝u_to_À64
(0);

1286 
	`dm_bm_u∆ock
(
sblock
);

1288 i‡(!
hñd_roŸ
) {

1289 
	`DMWARN
("NoÖool metadata snapshot found:ÇothingÅoÑelease.");

1290  -
EINVAL
;

1293 
r
 = 
	`dm_tm_ªad_lock
(
pmd
->
tm
, 
hñd_roŸ
, &
sb_vÆid©‹
, &
c›y
);

1294 i‡(
r
)

1295  
r
;

1297 
disk_su≥r
 = 
	`dm_block_d©a
(
c›y
);

1298 
	`dm_sm_dec_block
(
pmd
->
mëad©a_sm
, 
	`À64_to_˝u
(
disk_su≥r
->
d©a_m≠pög_roŸ
));

1299 
	`dm_sm_dec_block
(
pmd
->
mëad©a_sm
, 
	`À64_to_˝u
(
disk_su≥r
->
devi˚_dëaûs_roŸ
));

1300 
	`dm_sm_dec_block
(
pmd
->
mëad©a_sm
, 
hñd_roŸ
);

1302  
	`dm_tm_u∆ock
(
pmd
->
tm
, 
c›y
);

1303 
	}
}

1305 
	$dm_poﬁ_ªÀa£_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
)

1307 
r
 = -
EINVAL
;

1309 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1310 i‡(!
pmd
->
Áû_io
)

1311 
r
 = 
	`__ªÀa£_mëad©a_¢≠
(
pmd
);

1312 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1314  
r
;

1315 
	}
}

1317 
	$__gë_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
,

1318 
dm_block_t
 *
ªsu…
)

1320 
r
;

1321 
thö_disk_su≥rblock
 *
disk_su≥r
;

1322 
dm_block
 *
sblock
;

1324 
r
 = 
	`dm_bm_ªad_lock
(
pmd
->
bm
, 
THIN_SUPERBLOCK_LOCATION
,

1325 &
sb_vÆid©‹
, &
sblock
);

1326 i‡(
r
)

1327  
r
;

1329 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

1330 *
ªsu…
 = 
	`À64_to_˝u
(
disk_su≥r
->
hñd_roŸ
);

1332  
	`dm_bm_u∆ock
(
sblock
);

1333 
	}
}

1335 
	$dm_poﬁ_gë_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
,

1336 
dm_block_t
 *
ªsu…
)

1338 
r
 = -
EINVAL
;

1340 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1341 i‡(!
pmd
->
Áû_io
)

1342 
r
 = 
	`__gë_mëad©a_¢≠
(
pmd
, 
ªsu…
);

1343 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1345  
r
;

1346 
	}
}

1348 
	$dm_poﬁ_›í_thö_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
,

1349 
dm_thö_devi˚
 **
td
)

1351 
r
 = -
EINVAL
;

1353 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1354 i‡(!
pmd
->
Áû_io
)

1355 
r
 = 
	`__›í_devi˚
(
pmd
, 
dev
, 0, 
td
);

1356 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1358  
r
;

1359 
	}
}

1361 
	$dm_poﬁ_˛o£_thö_devi˚
(
dm_thö_devi˚
 *
td
)

1363 
	`down_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1364 
	`__˛o£_devi˚
(
td
);

1365 
	`up_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1368 
	}
}

1370 
dm_thö_id
 
	$dm_thö_dev_id
(
dm_thö_devi˚
 *
td
)

1372  
td
->
id
;

1373 
	}
}

1381 
boﬁ
 
	$__¢≠shŸãd_sö˚
(
dm_thö_devi˚
 *
td
, 
uöt32_t
 
time
)

1383  
td
->
¢≠shŸãd_time
 > 
time
;

1384 
	}
}

1386 
	$dm_thö_föd_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
,

1387 
ˇn_block
, 
dm_thö_lookup_ªsu…
 *
ªsu…
)

1389 
r
 = -
EINVAL
;

1390 
uöt64_t
 
block_time
 = 0;

1391 
__À64
 
vÆue
;

1392 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1393 
dm_block_t
 
keys
[2] = { 
td
->
id
, 
block
 };

1394 
dm_båì_öfo
 *
öfo
;

1396 i‡(
ˇn_block
) {

1397 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1398 
öfo
 = &
pmd
->info;

1399 } i‡(
	`down_ªad_åylock
(&
pmd
->
roŸ_lock
))

1400 
öfo
 = &
pmd
->
nb_öfo
;

1402  -
EWOULDBLOCK
;

1404 i‡(
pmd
->
Áû_io
)

1405 
out
;

1407 
r
 = 
	`dm_båì_lookup
(
öfo
, 
pmd
->
roŸ
, 
keys
, &
vÆue
);

1408 i‡(!
r
)

1409 
block_time
 = 
	`À64_to_˝u
(
vÆue
);

1411 
out
:

1412 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1414 i‡(!
r
) {

1415 
dm_block_t
 
ex˚±i⁄_block
;

1416 
uöt32_t
 
ex˚±i⁄_time
;

1417 
	`u≈ack_block_time
(
block_time
, &
ex˚±i⁄_block
,

1418 &
ex˚±i⁄_time
);

1419 
ªsu…
->
block
 = 
ex˚±i⁄_block
;

1420 
ªsu…
->
sh¨ed
 = 
	`__¢≠shŸãd_sö˚
(
td
, 
ex˚±i⁄_time
);

1423  
r
;

1424 
	}
}

1426 
	$__ö£π
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
,

1427 
dm_block_t
 
d©a_block
)

1429 
r
, 
ö£πed
;

1430 
__À64
 
vÆue
;

1431 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1432 
dm_block_t
 
keys
[2] = { 
td
->
id
, 
block
 };

1434 
vÆue
 = 
	`˝u_to_À64
(
	`∑ck_block_time
(
d©a_block
, 
pmd
->
time
));

1435 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

1437 
r
 = 
	`dm_båì_ö£π_nŸify
(&
pmd
->
öfo
,Ömd->
roŸ
, 
keys
, &
vÆue
,

1438 &
pmd
->
roŸ
, &
ö£πed
);

1439 i‡(
r
)

1440  
r
;

1442 
td
->
ch™ged
 = 1;

1443 i‡(
ö£πed
)

1444 
td
->
m≠≥d_blocks
++;

1447 
	}
}

1449 
	$dm_thö_ö£π_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
,

1450 
dm_block_t
 
d©a_block
)

1452 
r
 = -
EINVAL
;

1454 
	`down_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1455 i‡(!
td
->
pmd
->
Áû_io
)

1456 
r
 = 
	`__ö£π
(
td
, 
block
, 
d©a_block
);

1457 
	`up_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1459  
r
;

1460 
	}
}

1462 
	$__ªmove
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
)

1464 
r
;

1465 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1466 
dm_block_t
 
keys
[2] = { 
td
->
id
, 
block
 };

1468 
r
 = 
	`dm_båì_ªmove
(&
pmd
->
öfo
,Ömd->
roŸ
, 
keys
, &pmd->root);

1469 i‡(
r
)

1470  
r
;

1472 
td
->
m≠≥d_blocks
--;

1473 
td
->
ch™ged
 = 1;

1476 
	}
}

1478 
	$dm_thö_ªmove_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
)

1480 
r
 = -
EINVAL
;

1482 
	`down_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1483 i‡(!
td
->
pmd
->
Áû_io
)

1484 
r
 = 
	`__ªmove
(
td
, 
block
);

1485 
	`up_wrôe
(&
td
->
pmd
->
roŸ_lock
);

1487  
r
;

1488 
	}
}

1490 
	$dm_poﬁ_block_is_u£d
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
b
, 
boﬁ
 *
ªsu…
)

1492 
r
;

1493 
uöt32_t
 
ªf_cou¡
;

1495 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1496 
r
 = 
	`dm_sm_gë_cou¡
(
pmd
->
d©a_sm
, 
b
, &
ªf_cou¡
);

1497 i‡(!
r
)

1498 *
ªsu…
 = (
ªf_cou¡
 != 0);

1499 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1501  
r
;

1502 
	}
}

1504 
boﬁ
 
	$dm_thö_ch™ged_this_å™ß˘i⁄
(
dm_thö_devi˚
 *
td
)

1506 
r
;

1508 
	`down_ªad
(&
td
->
pmd
->
roŸ_lock
);

1509 
r
 = 
td
->
ch™ged
;

1510 
	`up_ªad
(&
td
->
pmd
->
roŸ_lock
);

1512  
r
;

1513 
	}
}

1515 
boﬁ
 
	$dm_poﬁ_ch™ged_this_å™ß˘i⁄
(
dm_poﬁ_mëad©a
 *
pmd
)

1517 
boﬁ
 
r
 = 
Ál£
;

1518 
dm_thö_devi˚
 *
td
, *
tmp
;

1520 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1521 
	`li°_f‹_óch_íåy_ß„
(
td
, 
tmp
, &
pmd
->
thö_devi˚s
, 
li°
) {

1522 i‡(
td
->
ch™ged
) {

1523 
r
 = 
td
->
ch™ged
;

1527 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1529  
r
;

1530 
	}
}

1532 
boﬁ
 
	$dm_thö_ab‹ãd_ch™ges
(
dm_thö_devi˚
 *
td
)

1534 
boﬁ
 
r
;

1536 
	`down_ªad
(&
td
->
pmd
->
roŸ_lock
);

1537 
r
 = 
td
->
ab‹ãd_wôh_ch™ges
;

1538 
	`up_ªad
(&
td
->
pmd
->
roŸ_lock
);

1540  
r
;

1541 
	}
}

1543 
	$dm_poﬁ_Æloc_d©a_block
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 *
ªsu…
)

1545 
r
 = -
EINVAL
;

1547 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1548 i‡(!
pmd
->
Áû_io
)

1549 
r
 = 
	`dm_sm_√w_block
(
pmd
->
d©a_sm
, 
ªsu…
);

1550 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1552  
r
;

1553 
	}
}

1555 
	$dm_poﬁ_commô_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
)

1557 
r
 = -
EINVAL
;

1559 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1560 i‡(
pmd
->
Áû_io
)

1561 
out
;

1563 
r
 = 
	`__commô_å™ß˘i⁄
(
pmd
);

1564 i‡(
r
 <= 0)

1565 
out
;

1570 
r
 = 
	`__begö_å™ß˘i⁄
(
pmd
);

1571 
out
:

1572 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1573  
r
;

1574 
	}
}

1576 
	$__£t_ab‹t_wôh_ch™ges_Êags
(
dm_poﬁ_mëad©a
 *
pmd
)

1578 
dm_thö_devi˚
 *
td
;

1580 
	`li°_f‹_óch_íåy
(
td
, &
pmd
->
thö_devi˚s
, 
li°
)

1581 
td
->
ab‹ãd_wôh_ch™ges
 =Åd->
ch™ged
;

1582 
	}
}

1584 
	$dm_poﬁ_ab‹t_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
)

1586 
r
 = -
EINVAL
;

1588 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1589 i‡(
pmd
->
Áû_io
)

1590 
out
;

1592 
	`__£t_ab‹t_wôh_ch™ges_Êags
(
pmd
);

1593 
	`__de°roy_≥rsi°ít_d©a_obje˘s
(
pmd
);

1594 
r
 = 
	`__¸óã_≥rsi°ít_d©a_obje˘s
(
pmd
, 
Ál£
);

1595 i‡(
r
)

1596 
pmd
->
Áû_io
 = 
åue
;

1598 
out
:

1599 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1601  
r
;

1602 
	}
}

1604 
	$dm_poﬁ_gë_‰ì_block_cou¡
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 *
ªsu…
)

1606 
r
 = -
EINVAL
;

1608 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1609 i‡(!
pmd
->
Áû_io
)

1610 
r
 = 
	`dm_sm_gë_ƒ_‰ì
(
pmd
->
d©a_sm
, 
ªsu…
);

1611 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1613  
r
;

1614 
	}
}

1616 
	$dm_poﬁ_gë_‰ì_mëad©a_block_cou¡
(
dm_poﬁ_mëad©a
 *
pmd
,

1617 
dm_block_t
 *
ªsu…
)

1619 
r
 = -
EINVAL
;

1621 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1622 i‡(!
pmd
->
Áû_io
)

1623 
r
 = 
	`dm_sm_gë_ƒ_‰ì
(
pmd
->
mëad©a_sm
, 
ªsu…
);

1624 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1626  
r
;

1627 
	}
}

1629 
	$dm_poﬁ_gë_mëad©a_dev_size
(
dm_poﬁ_mëad©a
 *
pmd
,

1630 
dm_block_t
 *
ªsu…
)

1632 
r
 = -
EINVAL
;

1634 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1635 i‡(!
pmd
->
Áû_io
)

1636 
r
 = 
	`dm_sm_gë_ƒ_blocks
(
pmd
->
mëad©a_sm
, 
ªsu…
);

1637 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1639  
r
;

1640 
	}
}

1642 
	$dm_poﬁ_gë_d©a_block_size
(
dm_poﬁ_mëad©a
 *
pmd
, 
£˘‹_t
 *
ªsu…
)

1644 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1645 *
ªsu…
 = 
pmd
->
d©a_block_size
;

1646 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1649 
	}
}

1651 
	$dm_poﬁ_gë_d©a_dev_size
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 *
ªsu…
)

1653 
r
 = -
EINVAL
;

1655 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1656 i‡(!
pmd
->
Áû_io
)

1657 
r
 = 
	`dm_sm_gë_ƒ_blocks
(
pmd
->
d©a_sm
, 
ªsu…
);

1658 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1660  
r
;

1661 
	}
}

1663 
	$dm_thö_gë_m≠≥d_cou¡
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 *
ªsu…
)

1665 
r
 = -
EINVAL
;

1666 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1668 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1669 i‡(!
pmd
->
Áû_io
) {

1670 *
ªsu…
 = 
td
->
m≠≥d_blocks
;

1671 
r
 = 0;

1673 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1675  
r
;

1676 
	}
}

1678 
	$__highe°_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 *
ªsu…
)

1680 
r
;

1681 
__À64
 
vÆue_À
;

1682 
dm_block_t
 
thö_roŸ
;

1683 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1685 
r
 = 
	`dm_båì_lookup
(&
pmd
->
é_öfo
,Ömd->
roŸ
, &
td
->
id
, &
vÆue_À
);

1686 i‡(
r
)

1687  
r
;

1689 
thö_roŸ
 = 
	`À64_to_˝u
(
vÆue_À
);

1691  
	`dm_båì_föd_highe°_key
(&
pmd
->
bl_öfo
, 
thö_roŸ
, 
ªsu…
);

1692 
	}
}

1694 
	$dm_thö_gë_highe°_m≠≥d_block
(
dm_thö_devi˚
 *
td
,

1695 
dm_block_t
 *
ªsu…
)

1697 
r
 = -
EINVAL
;

1698 
dm_poﬁ_mëad©a
 *
pmd
 = 
td
->pmd;

1700 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1701 i‡(!
pmd
->
Áû_io
)

1702 
r
 = 
	`__highe°_block
(
td
, 
ªsu…
);

1703 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1705  
r
;

1706 
	}
}

1708 
	$__ªsize_•a˚_m≠
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
√w_cou¡
)

1710 
r
;

1711 
dm_block_t
 
ﬁd_cou¡
;

1713 
r
 = 
	`dm_sm_gë_ƒ_blocks
(
sm
, &
ﬁd_cou¡
);

1714 i‡(
r
)

1715  
r
;

1717 i‡(
√w_cou¡
 =
ﬁd_cou¡
)

1720 i‡(
√w_cou¡
 < 
ﬁd_cou¡
) {

1721 
	`DMERR
("cannotÑeduce size of space map");

1722  -
EINVAL
;

1725  
	`dm_sm_exãnd
(
sm
, 
√w_cou¡
 - 
ﬁd_cou¡
);

1726 
	}
}

1728 
	$dm_poﬁ_ªsize_d©a_dev
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
√w_cou¡
)

1730 
r
 = -
EINVAL
;

1732 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1733 i‡(!
pmd
->
Áû_io
)

1734 
r
 = 
	`__ªsize_•a˚_m≠
(
pmd
->
d©a_sm
, 
√w_cou¡
);

1735 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1737  
r
;

1738 
	}
}

1740 
	$dm_poﬁ_ªsize_mëad©a_dev
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
√w_cou¡
)

1742 
r
 = -
EINVAL
;

1744 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1745 i‡(!
pmd
->
Áû_io
)

1746 
r
 = 
	`__ªsize_•a˚_m≠
(
pmd
->
mëad©a_sm
, 
√w_cou¡
);

1747 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1749  
r
;

1750 
	}
}

1752 
	$dm_poﬁ_mëad©a_ªad_⁄ly
(
dm_poﬁ_mëad©a
 *
pmd
)

1754 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1755 
pmd
->
ªad_⁄ly
 = 
åue
;

1756 
	`dm_bm_£t_ªad_⁄ly
(
pmd
->
bm
);

1757 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1758 
	}
}

1760 
	$dm_poﬁ_mëad©a_ªad_wrôe
(
dm_poﬁ_mëad©a
 *
pmd
)

1762 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1763 
pmd
->
ªad_⁄ly
 = 
Ál£
;

1764 
	`dm_bm_£t_ªad_wrôe
(
pmd
->
bm
);

1765 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1766 
	}
}

1768 
	$dm_poﬁ_ªgi°î_mëad©a_thªshﬁd
(
dm_poﬁ_mëad©a
 *
pmd
,

1769 
dm_block_t
 
thªshﬁd
,

1770 
dm_sm_thªshﬁd_‚
 
‚
,

1771 *
c⁄ãxt
)

1773 
r
;

1775 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1776 
r
 = 
	`dm_sm_ªgi°î_thªshﬁd_ˇŒback
(
pmd
->
mëad©a_sm
, 
thªshﬁd
, 
‚
, 
c⁄ãxt
);

1777 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1779  
r
;

1780 
	}
}

1782 
	$dm_poﬁ_mëad©a_£t_√eds_check
(
dm_poﬁ_mëad©a
 *
pmd
)

1784 
r
;

1785 
dm_block
 *
sblock
;

1786 
thö_disk_su≥rblock
 *
disk_su≥r
;

1788 
	`down_wrôe
(&
pmd
->
roŸ_lock
);

1789 
pmd
->
Êags
 |
THIN_METADATA_NEEDS_CHECK_FLAG
;

1791 
r
 = 
	`su≥rblock_lock
(
pmd
, &
sblock
);

1792 i‡(
r
) {

1793 
	`DMERR
("couldn'tÑead superblock");

1794 
out
;

1797 
disk_su≥r
 = 
	`dm_block_d©a
(
sblock
);

1798 
disk_su≥r
->
Êags
 = 
	`˝u_to_À32
(
pmd
->flags);

1800 
	`dm_bm_u∆ock
(
sblock
);

1801 
out
:

1802 
	`up_wrôe
(&
pmd
->
roŸ_lock
);

1803  
r
;

1804 
	}
}

1806 
boﬁ
 
	$dm_poﬁ_mëad©a_√eds_check
(
dm_poﬁ_mëad©a
 *
pmd
)

1808 
boﬁ
 
√eds_check
;

1810 
	`down_ªad
(&
pmd
->
roŸ_lock
);

1811 
√eds_check
 = 
pmd
->
Êags
 & 
THIN_METADATA_NEEDS_CHECK_FLAG
;

1812 
	`up_ªad
(&
pmd
->
roŸ_lock
);

1814  
√eds_check
;

1815 
	}
}

	@dm-thin-metadata.h

7 #i‚de‡
DM_THIN_METADATA_H


8 
	#DM_THIN_METADATA_H


	)

10 
	~"≥rsi°ít-d©a/dm-block-m™agî.h
"

11 
	~"≥rsi°ít-d©a/dm-•a˚-m≠.h
"

12 
	~"≥rsi°ít-d©a/dm-•a˚-m≠-mëad©a.h
"

14 
	#THIN_METADATA_BLOCK_SIZE
 
DM_SM_METADATA_BLOCK_SIZE


	)

19 
	#THIN_METADATA_MAX_SECTORS
 
DM_SM_METADATA_MAX_SECTORS


	)

24 
	#THIN_METADATA_MAX_SECTORS_WARNING
 (16 * (1024 * 1024 * 1024 >> 
SECTOR_SHIFT
))

	)

31 
	#THIN_METADATA_NEEDS_CHECK_FLAG
 (1 << 0)

	)

33 
	gdm_poﬁ_mëad©a
;

34 
	gdm_thö_devi˚
;

39 
uöt64_t
 
	tdm_thö_id
;

44 
dm_poﬁ_mëad©a
 *
dm_poﬁ_mëad©a_›í
(
block_devi˚
 *
bdev
,

45 
£˘‹_t
 
d©a_block_size
,

46 
boﬁ
 
f‹m©_devi˚
);

48 
dm_poﬁ_mëad©a_˛o£
(
dm_poﬁ_mëad©a
 *
pmd
);

54 
	#THIN_FEATURE_COMPAT_SUPP
 0UL

	)

55 
	#THIN_FEATURE_COMPAT_RO_SUPP
 0UL

	)

56 
	#THIN_FEATURE_INCOMPAT_SUPP
 0UL

	)

61 
dm_poﬁ_¸óã_thö
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
);

69 
dm_poﬁ_¸óã_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
,

70 
dm_thö_id
 
‹igö
);

77 
dm_poﬁ_dñëe_thö_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
,

78 
dm_thö_id
 
dev
);

84 
dm_poﬁ_commô_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
);

94 
dm_poﬁ_ab‹t_mëad©a
(
dm_poﬁ_mëad©a
 *
pmd
);

99 
dm_poﬁ_£t_mëad©a_å™ß˘i⁄_id
(
dm_poﬁ_mëad©a
 *
pmd
,

100 
uöt64_t
 
cuºít_id
,

101 
uöt64_t
 
√w_id
);

103 
dm_poﬁ_gë_mëad©a_å™ß˘i⁄_id
(
dm_poﬁ_mëad©a
 *
pmd
,

104 
uöt64_t
 *
ªsu…
);

115 
dm_poﬁ_ª£rve_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
);

116 
dm_poﬁ_ªÀa£_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
);

118 
dm_poﬁ_gë_mëad©a_¢≠
(
dm_poﬁ_mëad©a
 *
pmd
,

119 
dm_block_t
 *
ªsu…
);

128 
dm_poﬁ_›í_thö_devi˚
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_thö_id
 
dev
,

129 
dm_thö_devi˚
 **
td
);

131 
dm_poﬁ_˛o£_thö_devi˚
(
dm_thö_devi˚
 *
td
);

133 
dm_thö_id
 
dm_thö_dev_id
(
dm_thö_devi˚
 *
td
);

135 
	sdm_thö_lookup_ªsu…
 {

136 
dm_block_t
 
	mblock
;

137 
boﬁ
 
	msh¨ed
:1;

146 
dm_thö_föd_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
,

147 
ˇn_block
, 
dm_thö_lookup_ªsu…
 *
ªsu…
);

152 
dm_poﬁ_Æloc_d©a_block
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 *
ªsu…
);

157 
dm_thö_ö£π_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
,

158 
dm_block_t
 
d©a_block
);

160 
dm_thö_ªmove_block
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
block
);

165 
boﬁ
 
dm_thö_ch™ged_this_å™ß˘i⁄
(
dm_thö_devi˚
 *
td
);

167 
boﬁ
 
dm_poﬁ_ch™ged_this_å™ß˘i⁄
(
dm_poﬁ_mëad©a
 *
pmd
);

169 
boﬁ
 
dm_thö_ab‹ãd_ch™ges
(
dm_thö_devi˚
 *
td
);

171 
dm_thö_gë_highe°_m≠≥d_block
(
dm_thö_devi˚
 *
td
,

172 
dm_block_t
 *
highe°_m≠≥d
);

174 
dm_thö_gë_m≠≥d_cou¡
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 *
ªsu…
);

176 
dm_poﬁ_gë_‰ì_block_cou¡
(
dm_poﬁ_mëad©a
 *
pmd
,

177 
dm_block_t
 *
ªsu…
);

179 
dm_poﬁ_gë_‰ì_mëad©a_block_cou¡
(
dm_poﬁ_mëad©a
 *
pmd
,

180 
dm_block_t
 *
ªsu…
);

182 
dm_poﬁ_gë_mëad©a_dev_size
(
dm_poﬁ_mëad©a
 *
pmd
,

183 
dm_block_t
 *
ªsu…
);

185 
dm_poﬁ_gë_d©a_block_size
(
dm_poﬁ_mëad©a
 *
pmd
, 
£˘‹_t
 *
ªsu…
);

187 
dm_poﬁ_gë_d©a_dev_size
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 *
ªsu…
);

189 
dm_poﬁ_block_is_u£d
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
b
, 
boﬁ
 *
ªsu…
);

195 
dm_poﬁ_ªsize_d©a_dev
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
√w_size
);

196 
dm_poﬁ_ªsize_mëad©a_dev
(
dm_poﬁ_mëad©a
 *
pmd
, 
dm_block_t
 
√w_size
);

202 
dm_poﬁ_mëad©a_ªad_⁄ly
(
dm_poﬁ_mëad©a
 *
pmd
);

203 
dm_poﬁ_mëad©a_ªad_wrôe
(
dm_poﬁ_mëad©a
 *
pmd
);

205 
dm_poﬁ_ªgi°î_mëad©a_thªshﬁd
(
dm_poﬁ_mëad©a
 *
pmd
,

206 
dm_block_t
 
thªshﬁd
,

207 
dm_sm_thªshﬁd_‚
 
‚
,

208 *
c⁄ãxt
);

213 
dm_poﬁ_mëad©a_£t_√eds_check
(
dm_poﬁ_mëad©a
 *
pmd
);

214 
boﬁ
 
dm_poﬁ_mëad©a_√eds_check
(
dm_poﬁ_mëad©a
 *
pmd
);

	@dm-thin-pool.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x827a42f4, 
__VMLINUX_SYMBOL_STR
(
dm_tm_›í_wôh_sm
) },

24 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

25 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

26 { 0x40f7bd91, 
__VMLINUX_SYMBOL_STR
(
dm_tm_öc
) },

27 { 0x7deff673, 
__VMLINUX_SYMBOL_STR
(
dm_c⁄sume_¨gs
) },

28 { 0xb7bad799, 
__VMLINUX_SYMBOL_STR
(
dm_bm_u∆ock
) },

29 { 0x5876c094, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

30 { 0xed1e1f96, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ªmove
) },

31 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

32 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

33 { 0xd75f42b2, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_›t
) },

34 { 0x43f23311, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_md
) },

35 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

36 { 0x1445176, 
__VMLINUX_SYMBOL_STR
(
dm_båì_föd_highe°_key
) },

37 { 0x688d422d, 
__VMLINUX_SYMBOL_STR
(
dm_bm_block_size
) },

38 { 0xd00dbc46, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_‰ì_˚Œ
) },

39 { 0x6b06fd˚, 
__VMLINUX_SYMBOL_STR
(
dñayed_w‹k_timî_‚
) },

40 { 0x154c6338, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_de°roy
) },

41 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

42 { 0x593a99b, 
__VMLINUX_SYMBOL_STR
(
öô_timî_key
) },

43 { 0xcbbfb419, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

44 { 0x80c89b3d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_u∆ock
) },

45 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

46 { 0xeˇb91e1, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_c›y
) },

47 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

48 { 0x118a5e56, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_mö
) },

49 { 0xd163ˇde, 
__VMLINUX_SYMBOL_STR
(
dm_tm_commô
) },

50 { 0x6791a44e, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_íåy_dec
) },

51 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

52 { 0xf96cc7e, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

53 { 0x9f624559, 
__VMLINUX_SYMBOL_STR
(
dm_sm_disk_›í
) },

54 { 0x31c0c2d1, 
__VMLINUX_SYMBOL_STR
(
dm_put
) },

55 { 0xe˚784c2, 
__VMLINUX_SYMBOL_STR
(
rb_fú°
) },

56 { 0x´e02382, 
__VMLINUX_SYMBOL_STR
(
dm_båì_em±y
) },

57 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

58 { 0xb70b342a, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_de°roy
) },

59 { 0xd292ed14, 
__VMLINUX_SYMBOL_STR
(
dm_˚Œ_ªÀa£
) },

60 { 0x183Á88b, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc_¶ab
) },

61 { 0x6d0aba34, 
__VMLINUX_SYMBOL_STR
(
waô_f‹_com∂ëi⁄
) },

62 { 0xe04f7ˇa, 
__VMLINUX_SYMBOL_STR
(
dm_ªad_¨g_group
) },

63 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

64 { 0xad84bef8, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_evít
) },

65 { 0xa0a7bd62, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_zîo
) },

66 { 0x2f40da68, 
__VMLINUX_SYMBOL_STR
(
dm_bm_£t_ªad_wrôe
) },

67 { 0x5991219c, 
__VMLINUX_SYMBOL_STR
(
ˇn˚l_dñayed_w‹k
) },

68 { 0x72319cdd, 
__VMLINUX_SYMBOL_STR
(
dm_£t_èrgë_max_io_Àn
) },

69 { 0x17c36f29, 
__VMLINUX_SYMBOL_STR
(
dm_bm_checksum
) },

70 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

71 { 0x796c2d48, 
__VMLINUX_SYMBOL_STR
(
dm_gë_md
) },

72 { 0xbf333e27, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

73 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

74 { 0x72289260, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_de°roy
) },

75 { 0xb138d0bf, 
__VMLINUX_SYMBOL_STR
(
dm_øãlimô_°©e
) },

76 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

77 { 0xØfdc258, 
__VMLINUX_SYMBOL_STR
(
°rˇ£cmp
) },

78 { 0xˇ2e3a88, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_íåy_öc
) },

79 { 0x4d9b652b, 
__VMLINUX_SYMBOL_STR
(
rb_îa£
) },

80 { 0x5eb24829, 
__VMLINUX_SYMBOL_STR
(
dm_shi·_¨g
) },

81 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_nuŒ
) },

82 { 0xf375d009, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock
) },

83 { 0x896ac21b, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

84 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

85 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchr⁄ize_sched
) },

86 { 0x960f071e, 
__VMLINUX_SYMBOL_STR
(
dm_su•íded
) },

87 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

88 { 0x8a99a016, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì_¶ab
) },

89 { 0x6e5db7e4, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

90 { 0x2ed55c8e, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

91 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

92 { 0x9e798e22, 
__VMLINUX_SYMBOL_STR
(
dm_bm_£t_ªad_⁄ly
) },

93 { 0x8e4150e1, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_Æloc_˚Œ
) },

94 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

95 { 0x7b047bd9, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¸óã_n⁄_blockög_˛⁄e
) },

96 { 0x7ade1071, 
__VMLINUX_SYMBOL_STR
(
dm_tm_de°roy
) },

97 { 0x966a8838, 
__VMLINUX_SYMBOL_STR
(
dm_båì_lookup
) },

98 { 0xb9a6ecf8, 
__VMLINUX_SYMBOL_STR
(
dm_tm_dec
) },

99 { 0xa„da29f, 
__VMLINUX_SYMBOL_STR
(
dm_bm_wrôe_lock_zîo
) },

100 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

101 { 0xb968aˇ0, 
__VMLINUX_SYMBOL_STR
(
dm_˚Œ_ªÀa£_no_hﬁdî
) },

102 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

103 { 0x49b35849, 
__VMLINUX_SYMBOL_STR
(
dm_sm_disk_¸óã
) },

104 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

105 { 0x55b4bd4d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¸óã_wôh_sm
) },

106 { 0xìec26a7, 
__VMLINUX_SYMBOL_STR
(
queue_dñayed_w‹k_⁄
) },

107 { 0xf5455120, 
__VMLINUX_SYMBOL_STR
(
dm_bm_ªad_lock
) },

108 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

109 { 0x89f1e1cc, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ö£π_nŸify
) },

110 { 0xd688716b, 
__VMLINUX_SYMBOL_STR
(
dm_kc›yd_˛õ¡_¸óã
) },

111 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

112 { 0x2eb01e04, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_de°roy
) },

113 { 0x16000a3c, 
__VMLINUX_SYMBOL_STR
(
dm_devi˚_«me
) },

114 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

115 { 0x376bd26d, 
__VMLINUX_SYMBOL_STR
(
down_ªad_åylock
) },

116 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

117 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

118 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

119 { 0xa5526619, 
__VMLINUX_SYMBOL_STR
(
rb_ö£π_cﬁ‹
) },

120 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

121 { 0x54f69d, 
__VMLINUX_SYMBOL_STR
(
dm_tm_¥e_commô
) },

122 { 0x6104ba2, 
__VMLINUX_SYMBOL_STR
(
dm_˚Œ_îr‹
) },

123 { 0x2c112836, 
__VMLINUX_SYMBOL_STR
(
dm_block_loˇti⁄
) },

124 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

125 { 0xd29923fb, 
__VMLINUX_SYMBOL_STR
(
dm_tm_shadow_block
) },

126 { 0xb6d5c65d, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_add_w‹k
) },

127 { 0xbd50ebbb, 
__VMLINUX_SYMBOL_STR
(
dm_båì_dñ
) },

128 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

129 { 0xebd06óf, 
__VMLINUX_SYMBOL_STR
(
dm_bio_¥is⁄_¸óã
) },

130 { 0xd091cdcf, 
__VMLINUX_SYMBOL_STR
(
dm_block_m™agî_¸óã
) },

131 { 0xˇ9360b5, 
__VMLINUX_SYMBOL_STR
(
rb_√xt
) },

132 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

133 { 0x1008b78b, 
__VMLINUX_SYMBOL_STR
(
dm_noÊush_su•ídög
) },

134 { 0x1e3f728d, 
__VMLINUX_SYMBOL_STR
(
dm_block_d©a
) },

135 { 0x42dbdfc3, 
__VMLINUX_SYMBOL_STR
(
dm_tm_ªad_lock
) },

136 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

137 { 0x4b06d2e7, 
__VMLINUX_SYMBOL_STR
(
com∂ëe
) },

138 { 0xˇ40abd5, 
__VMLINUX_SYMBOL_STR
(
dm_båì_ö£π
) },

139 { 0xb1425b32, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_add_èrgë_ˇŒbacks
) },

140 { 0x869526c5, 
__VMLINUX_SYMBOL_STR
(
zîo_fûl_bio
) },

141 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

142 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

143 { 0xa88bd3e3, 
__VMLINUX_SYMBOL_STR
(
__öô_rw£m
) },

144 { 0x17dd39d6, 
__VMLINUX_SYMBOL_STR
(
dm_de„ºed_£t_¸óã
) },

145 { 0xa4fd3f13, 
__VMLINUX_SYMBOL_STR
(
dm_bio_dëaö
) },

148 c⁄° 
	g__moduÀ_dïíds
[]

149 
__u£d


150 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

154 
MODULE_INFO
(
§cvîsi⁄
, "CBAB0F237EBBF76AB403692");

	@dm-thin.c

7 
	~"dm-thö-mëad©a.h
"

8 
	~"dm-bio-¥is⁄.h
"

9 
	~"dm.h
"

11 
	~<löux/devi˚-m≠≥r.h
>

12 
	~<löux/dm-io.h
>

13 
	~<löux/dm-kc›yd.h
>

14 
	~<löux/li°.h
>

15 
	~<löux/rculi°.h
>

16 
	~<löux/öô.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/rbåì.h
>

21 
	#DM_MSG_PREFIX
 "thö"

	)

26 
	#ENDIO_HOOK_POOL_SIZE
 1024

	)

27 
	#MAPPING_POOL_SIZE
 1024

	)

28 
	#PRISON_CELLS
 1024

	)

29 
	#COMMIT_PERIOD
 
HZ


	)

30 
	#NO_SPACE_TIMEOUT_SECS
 60

	)

32 
	gno_•a˚_timeout_£cs
 = 
NO_SPACE_TIMEOUT_SECS
;

34 
DECLARE_DM_KCOPYD_THROTTLE_WITH_MODULE_PARM
(
¢≠shŸ_c›y_thrŸée
,

41 
	#DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 (64 * 1024 >> 
SECTOR_SHIFT
)

	)

42 
	#DATA_DEV_BLOCK_SIZE_MAX_SECTORS
 (1024 * 1024 * 1024 >> 
SECTOR_SHIFT
)

	)

47 
	#MAX_DEV_ID
 ((1 << 24Ë- 1)

	)

112 
	$buûd_d©a_key
(
dm_thö_devi˚
 *
td
,

113 
dm_block_t
 
b
, 
dm_˚Œ_key
 *
key
)

115 
key
->
vútuÆ
 = 0;

116 
key
->
dev
 = 
	`dm_thö_dev_id
(
td
);

117 
key
->
block
 = 
b
;

118 
	}
}

120 
	$buûd_vútuÆ_key
(
dm_thö_devi˚
 *
td
, 
dm_block_t
 
b
,

121 
dm_˚Œ_key
 *
key
)

123 
key
->
vútuÆ
 = 1;

124 
key
->
dev
 = 
	`dm_thö_dev_id
(
td
);

125 
key
->
block
 = 
b
;

126 
	}
}

135 
	gdm_thö_√w_m≠pög
;

140 
	epoﬁ_mode
 {

141 
	mPM_WRITE
,

142 
	mPM_OUT_OF_DATA_SPACE
,

143 
	mPM_READ_ONLY
,

144 
	mPM_FAIL
,

147 
	spoﬁ_„©uªs
 {

148 
poﬁ_mode
 
	mmode
;

150 
boﬁ
 
	mzîo_√w_blocks
:1;

151 
boﬁ
 
	mdisˇrd_íabÀd
:1;

152 
boﬁ
 
	mdisˇrd_∑ssdown
:1;

153 
boﬁ
 
	mîr‹_if_no_•a˚
:1;

156 
	gthö_c
;

157 (*
	t¥o˚ss_bio_‚
)(
	tthö_c
 *
	ttc
, 
	tbio
 *bio);

158 (*
	t¥o˚ss_m≠pög_‚
)(
	tdm_thö_√w_m≠pög
 *
	tm
);

160 
	spoﬁ
 {

161 
li°_hód
 
li°
;

162 
dm_èrgë
 *
ti
;

164 
m≠≥d_devi˚
 *
poﬁ_md
;

165 
block_devi˚
 *
md_dev
;

166 
dm_poﬁ_mëad©a
 *
pmd
;

168 
dm_block_t
 
low_w©î_blocks
;

169 
uöt32_t
 
£˘‹s_≥r_block
;

170 
£˘‹s_≥r_block_shi·
;

172 
poﬁ_„©uªs
 
pf
;

173 
boﬁ
 
low_w©î_åiggîed
:1;

175 
dm_bio_¥is⁄
 *
¥is⁄
;

176 
dm_kc›yd_˛õ¡
 *
c›õr
;

178 
w‹kqueue_°ru˘
 *
wq
;

179 
w‹k_°ru˘
 
w‹kî
;

180 
dñayed_w‹k
 
wakî
;

181 
dñayed_w‹k
 
no_•a˚_timeout
;

183 
œ°_commô_jiffõs
;

184 
ªf_cou¡
;

186 
•ölock_t
 
lock
;

187 
bio_li°
 
de„ºed_Êush_bios
;

188 
li°_hód
 
¥ï¨ed_m≠pögs
;

189 
li°_hód
 
¥ï¨ed_disˇrds
;

190 
li°_hód
 
a˘ive_thös
;

192 
dm_de„ºed_£t
 *
sh¨ed_ªad_ds
;

193 
dm_de„ºed_£t
 *
Æl_io_ds
;

195 
dm_thö_√w_m≠pög
 *
√xt_m≠pög
;

196 
mempoﬁ_t
 *
m≠pög_poﬁ
;

198 
¥o˚ss_bio_‚
 
¥o˚ss_bio
;

199 
¥o˚ss_bio_‚
 
¥o˚ss_disˇrd
;

201 
¥o˚ss_m≠pög_‚
 
¥o˚ss_¥ï¨ed_m≠pög
;

202 
¥o˚ss_m≠pög_‚
 
¥o˚ss_¥ï¨ed_disˇrd
;

205 
poﬁ_mode
 
	`gë_poﬁ_mode
(
poﬁ
 *pool);

206 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
 *poﬁ, c⁄° *
›
, 
r
);

211 
	spoﬁ_c
 {

212 
dm_èrgë
 *
ti
;

213 
poﬁ
 *pool;

214 
dm_dev
 *
d©a_dev
;

215 
dm_dev
 *
mëad©a_dev
;

216 
dm_èrgë_ˇŒbacks
 
ˇŒbacks
;

218 
dm_block_t
 
low_w©î_blocks
;

219 
poﬁ_„©uªs
 
ªque°ed_pf
;

220 
poﬁ_„©uªs
 
adju°ed_pf
;

226 
	sthö_c
 {

227 
li°_hód
 
li°
;

228 
dm_dev
 *
poﬁ_dev
;

229 
dm_dev
 *
‹igö_dev
;

230 
£˘‹_t
 
‹igö_size
;

231 
dm_thö_id
 
dev_id
;

233 
poﬁ
 *pool;

234 
dm_thö_devi˚
 *
td
;

235 
boﬁ
 
ªqueue_mode
:1;

236 
•ölock_t
 
lock
;

237 
bio_li°
 
de„ºed_bio_li°
;

238 
bio_li°
 
ªåy_⁄_ªsume_li°
;

239 
rb_roŸ
 
s‹t_bio_li°
;

245 
©omic_t
 
ªfcou¡
;

246 
com∂ëi⁄
 
ˇn_de°roy
;

255 
	$wake_w‹kî
(
poﬁ
 *pool)

257 
	`queue_w‹k
(
poﬁ
->
wq
, &poﬁ->
w‹kî
);

258 
	}
}

262 
	$bio_dëaö
(
poﬁ
 *poﬁ, 
dm_˚Œ_key
 *
key
, 
bio
 *bio,

263 
dm_bio_¥is⁄_˚Œ
 **
˚Œ_ªsu…
)

265 
r
;

266 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_¥óŒoc
;

272 
˚Œ_¥óŒoc
 = 
	`dm_bio_¥is⁄_Æloc_˚Œ
(
poﬁ
->
¥is⁄
, 
GFP_NOIO
);

274 
r
 = 
	`dm_bio_dëaö
(
poﬁ
->
¥is⁄
, 
key
, 
bio
, 
˚Œ_¥óŒoc
, 
˚Œ_ªsu…
);

275 i‡(
r
)

280 
	`dm_bio_¥is⁄_‰ì_˚Œ
(
poﬁ
->
¥is⁄
, 
˚Œ_¥óŒoc
);

282  
r
;

283 
	}
}

285 
	$˚Œ_ªÀa£
(
poﬁ
 *pool,

286 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

287 
bio_li°
 *
bios
)

289 
	`dm_˚Œ_ªÀa£
(
poﬁ
->
¥is⁄
, 
˚Œ
, 
bios
);

290 
	`dm_bio_¥is⁄_‰ì_˚Œ
(
poﬁ
->
¥is⁄
, 
˚Œ
);

291 
	}
}

293 
	$˚Œ_ªÀa£_no_hﬁdî
(
poﬁ
 *pool,

294 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

295 
bio_li°
 *
bios
)

297 
	`dm_˚Œ_ªÀa£_no_hﬁdî
(
poﬁ
->
¥is⁄
, 
˚Œ
, 
bios
);

298 
	`dm_bio_¥is⁄_‰ì_˚Œ
(
poﬁ
->
¥is⁄
, 
˚Œ
);

299 
	}
}

301 
	$˚Œ_de„r_no_hﬁdî_no_‰ì
(
thö_c
 *
tc
,

302 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

304 
poﬁ
 *poﬁ = 
tc
->pool;

305 
Êags
;

307 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

308 
	`dm_˚Œ_ªÀa£_no_hﬁdî
(
poﬁ
->
¥is⁄
, 
˚Œ
, &
tc
->
de„ºed_bio_li°
);

309 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

311 
	`wake_w‹kî
(
poﬁ
);

312 
	}
}

314 
	$˚Œ_îr‹_wôh_code
(
poﬁ
 *pool,

315 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
îr‹_code
)

317 
	`dm_˚Œ_îr‹
(
poﬁ
->
¥is⁄
, 
˚Œ
, 
îr‹_code
);

318 
	`dm_bio_¥is⁄_‰ì_˚Œ
(
poﬁ
->
¥is⁄
, 
˚Œ
);

319 
	}
}

321 
	$˚Œ_îr‹
(
poﬁ
 *poﬁ, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

323 
	`˚Œ_îr‹_wôh_code
(
poﬁ
, 
˚Œ
, -
EIO
);

324 
	}
}

331 
	sdm_thö_poﬁ_èbÀ
 {

332 
muãx
 
	mmuãx
;

333 
li°_hód
 
	mpoﬁs
;

334 } 
	gdm_thö_poﬁ_èbÀ
;

336 
	$poﬁ_èbÀ_öô
()

338 
	`muãx_öô
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

339 
	`INIT_LIST_HEAD
(&
dm_thö_poﬁ_èbÀ
.
poﬁs
);

340 
	}
}

342 
	$__poﬁ_èbÀ_ö£π
(
poﬁ
 *pool)

344 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

345 
	`li°_add
(&
poﬁ
->
li°
, &
dm_thö_poﬁ_èbÀ
.
poﬁs
);

346 
	}
}

348 
	$__poﬁ_èbÀ_ªmove
(
poﬁ
 *pool)

350 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

351 
	`li°_dñ
(&
poﬁ
->
li°
);

352 
	}
}

354 
poﬁ
 *
	$__poﬁ_èbÀ_lookup
(
m≠≥d_devi˚
 *
md
)

356 
poﬁ
 *poﬁ = 
NULL
, *
tmp
;

358 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

360 
	`li°_f‹_óch_íåy
(
tmp
, &
dm_thö_poﬁ_èbÀ
.
poﬁs
, 
li°
) {

361 i‡(
tmp
->
poﬁ_md
 =
md
) {

362 
poﬁ
 = 
tmp
;

367  
poﬁ
;

368 
	}
}

370 
poﬁ
 *
	$__poﬁ_èbÀ_lookup_mëad©a_dev
(
block_devi˚
 *
md_dev
)

372 
poﬁ
 *poﬁ = 
NULL
, *
tmp
;

374 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

376 
	`li°_f‹_óch_íåy
(
tmp
, &
dm_thö_poﬁ_èbÀ
.
poﬁs
, 
li°
) {

377 i‡(
tmp
->
md_dev
 == md_dev) {

378 
poﬁ
 = 
tmp
;

383  
poﬁ
;

384 
	}
}

388 
	sdm_thö_ídio_hook
 {

389 
thö_c
 *
	mtc
;

390 
dm_de„ºed_íåy
 *
	msh¨ed_ªad_íåy
;

391 
dm_de„ºed_íåy
 *
	mÆl_io_íåy
;

392 
dm_thö_√w_m≠pög
 *
	movîwrôe_m≠pög
;

393 
rb_node
 
	mrb_node
;

396 
	$ªqueue_bio_li°
(
thö_c
 *
tc
, 
bio_li°
 *
ma°î
)

398 
bio
 *bio;

399 
bio_li°
 
bios
;

400 
Êags
;

402 
	`bio_li°_öô
(&
bios
);

404 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

405 
	`bio_li°_mîge
(&
bios
, 
ma°î
);

406 
	`bio_li°_öô
(
ma°î
);

407 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

409 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

410 
	`bio_ídio
(
bio
, 
DM_ENDIO_REQUEUE
);

411 
	}
}

413 
	$ªqueue_io
(
thö_c
 *
tc
)

415 
	`ªqueue_bio_li°
(
tc
, &tc->
de„ºed_bio_li°
);

416 
	`ªqueue_bio_li°
(
tc
, &tc->
ªåy_⁄_ªsume_li°
);

417 
	}
}

419 
	$îr‹_thö_ªåy_li°
(
thö_c
 *
tc
)

421 
bio
 *bio;

422 
Êags
;

423 
bio_li°
 
bios
;

425 
	`bio_li°_öô
(&
bios
);

427 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

428 
	`bio_li°_mîge
(&
bios
, &
tc
->
ªåy_⁄_ªsume_li°
);

429 
	`bio_li°_öô
(&
tc
->
ªåy_⁄_ªsume_li°
);

430 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

432 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

433 
	`bio_io_îr‹
(
bio
);

434 
	}
}

436 
	$îr‹_ªåy_li°
(
poﬁ
 *pool)

438 
thö_c
 *
tc
;

440 
	`rcu_ªad_lock
();

441 
	`li°_f‹_óch_íåy_rcu
(
tc
, &
poﬁ
->
a˘ive_thös
, 
li°
)

442 
	`îr‹_thö_ªåy_li°
(
tc
);

443 
	`rcu_ªad_u∆ock
();

444 
	}
}

453 
boﬁ
 
	$block_size_is_powî_of_two
(
poﬁ
 *pool)

455  
poﬁ
->
£˘‹s_≥r_block_shi·
 >= 0;

456 
	}
}

458 
dm_block_t
 
	$gë_bio_block
(
thö_c
 *
tc
, 
bio
 *bio)

460 
poﬁ
 *poﬁ = 
tc
->pool;

461 
£˘‹_t
 
block_ƒ
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

463 i‡(
	`block_size_is_powî_of_two
(
poﬁ
))

464 
block_ƒ
 >>
poﬁ
->
£˘‹s_≥r_block_shi·
;

466 (Ë
	`£˘‹_div
(
block_ƒ
, 
poﬁ
->
£˘‹s_≥r_block
);

468  
block_ƒ
;

469 
	}
}

471 
	$ªm≠
(
thö_c
 *
tc
, 
bio
 *bio, 
dm_block_t
 
block
)

473 
poﬁ
 *poﬁ = 
tc
->pool;

474 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

476 
bio
->
bi_bdev
 = 
tc
->
poﬁ_dev
->
bdev
;

477 i‡(
	`block_size_is_powî_of_two
(
poﬁ
))

478 
bio
->
bi_ôî
.
bi_£˘‹
 =

479 (
block
 << 
poﬁ
->
£˘‹s_≥r_block_shi·
) |

480 (
bi_£˘‹
 & (
poﬁ
->
£˘‹s_≥r_block
 - 1));

482 
bio
->
bi_ôî
.
bi_£˘‹
 = (
block
 * 
poﬁ
->
£˘‹s_≥r_block
) +

483 
	`£˘‹_div
(
bi_£˘‹
, 
poﬁ
->
£˘‹s_≥r_block
);

484 
	}
}

486 
	$ªm≠_to_‹igö
(
thö_c
 *
tc
, 
bio
 *bio)

488 
bio
->
bi_bdev
 = 
tc
->
‹igö_dev
->
bdev
;

489 
	}
}

491 
	$bio_åiggîs_commô
(
thö_c
 *
tc
, 
bio
 *bio)

493  (
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_FUA
)) &&

494 
	`dm_thö_ch™ged_this_å™ß˘i⁄
(
tc
->
td
);

495 
	}
}

497 
	$öc_Æl_io_íåy
(
poﬁ
 *poﬁ, 
bio
 *bio)

499 
dm_thö_ídio_hook
 *
h
;

501 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

504 
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (
dm_thö_ídio_hook
));

505 
h
->
Æl_io_íåy
 = 
	`dm_de„ºed_íåy_öc
(
poﬁ
->
Æl_io_ds
);

506 
	}
}

508 
	$issue
(
thö_c
 *
tc
, 
bio
 *bio)

510 
poﬁ
 *poﬁ = 
tc
->pool;

511 
Êags
;

513 i‡(!
	`bio_åiggîs_commô
(
tc
, 
bio
)) {

514 
	`gíîic_make_ªque°
(
bio
);

523 i‡(
	`dm_thö_ab‹ãd_ch™ges
(
tc
->
td
)) {

524 
	`bio_io_îr‹
(
bio
);

532 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

533 
	`bio_li°_add
(&
poﬁ
->
de„ºed_Êush_bios
, 
bio
);

534 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

535 
	}
}

537 
	$ªm≠_to_‹igö_™d_issue
(
thö_c
 *
tc
, 
bio
 *bio)

539 
	`ªm≠_to_‹igö
(
tc
, 
bio
);

540 
	`issue
(
tc
, 
bio
);

541 
	}
}

543 
	$ªm≠_™d_issue
(
thö_c
 *
tc
, 
bio
 *bio,

544 
dm_block_t
 
block
)

546 
	`ªm≠
(
tc
, 
bio
, 
block
);

547 
	`issue
(
tc
, 
bio
);

548 
	}
}

555 
	sdm_thö_√w_m≠pög
 {

556 
li°_hód
 
	mli°
;

558 
boﬁ
 
	m∑ss_disˇrd
:1;

559 
boﬁ
 
	mdeföôñy_nŸ_sh¨ed
:1;

566 
©omic_t
 
	m¥ï¨e_a˘i⁄s
;

568 
	mîr
;

569 
thö_c
 *
	mtc
;

570 
dm_block_t
 
	mvút_block
;

571 
dm_block_t
 
	md©a_block
;

572 
dm_bio_¥is⁄_˚Œ
 *
	m˚Œ
, *
	m˚Œ2
;

580 
bio
 *
	mbio
;

581 
bio_íd_io_t
 *
	mßved_bi_íd_io
;

584 
	$__com∂ëe_m≠pög_¥ï¨©i⁄
(
dm_thö_√w_m≠pög
 *
m
)

586 
poﬁ
 *poﬁ = 
m
->
tc
->pool;

588 i‡(
	`©omic_dec_™d_ã°
(&
m
->
¥ï¨e_a˘i⁄s
)) {

589 
	`li°_add_èû
(&
m
->
li°
, &
poﬁ
->
¥ï¨ed_m≠pögs
);

590 
	`wake_w‹kî
(
poﬁ
);

592 
	}
}

594 
	$com∂ëe_m≠pög_¥ï¨©i⁄
(
dm_thö_√w_m≠pög
 *
m
)

596 
Êags
;

597 
poﬁ
 *poﬁ = 
m
->
tc
->pool;

599 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

600 
	`__com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

601 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

602 
	}
}

604 
	$c›y_com∂ëe
(
ªad_îr
, 
wrôe_îr
, *
c⁄ãxt
)

606 
dm_thö_√w_m≠pög
 *
m
 = 
c⁄ãxt
;

608 
m
->
îr
 = 
ªad_îr
 || 
wrôe_îr
 ? -
EIO
 : 0;

609 
	`com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

610 
	}
}

612 
	$ovîwrôe_ídio
(
bio
 *bio, 
îr
)

614 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

615 
dm_thö_√w_m≠pög
 *
m
 = 
h
->
ovîwrôe_m≠pög
;

617 
m
->
îr
 =Érr;

618 
	`com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

619 
	}
}

634 
	$˚Œ_de„r
(
thö_c
 *
tc
, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

636 
poﬁ
 *poﬁ = 
tc
->pool;

637 
Êags
;

639 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

640 
	`˚Œ_ªÀa£
(
poﬁ
, 
˚Œ
, &
tc
->
de„ºed_bio_li°
);

641 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

643 
	`wake_w‹kî
(
poﬁ
);

644 
	}
}

649 
	$˚Œ_de„r_no_hﬁdî
(
thö_c
 *
tc
, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

651 
poﬁ
 *poﬁ = 
tc
->pool;

652 
Êags
;

654 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

655 
	`˚Œ_ªÀa£_no_hﬁdî
(
poﬁ
, 
˚Œ
, &
tc
->
de„ºed_bio_li°
);

656 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

658 
	`wake_w‹kî
(
poﬁ
);

659 
	}
}

661 
	$¥o˚ss_¥ï¨ed_m≠pög_Áû
(
dm_thö_√w_m≠pög
 *
m
)

663 i‡(
m
->
bio
) {

664 
m
->
bio
->
bi_íd_io
 = m->
ßved_bi_íd_io
;

665 
	`©omic_öc
(&
m
->
bio
->
bi_ªmaöög
);

667 
	`˚Œ_îr‹
(
m
->
tc
->
poﬁ
, m->
˚Œ
);

668 
	`li°_dñ
(&
m
->
li°
);

669 
	`mempoﬁ_‰ì
(
m
, m->
tc
->
poﬁ
->
m≠pög_poﬁ
);

670 
	}
}

672 
	$¥o˚ss_¥ï¨ed_m≠pög
(
dm_thö_√w_m≠pög
 *
m
)

674 
thö_c
 *
tc
 = 
m
->tc;

675 
poﬁ
 *poﬁ = 
tc
->pool;

676 
bio
 *bio;

677 
r
;

679 
bio
 = 
m
->bio;

680 i‡(
bio
) {

681 
bio
->
bi_íd_io
 = 
m
->
ßved_bi_íd_io
;

682 
	`©omic_öc
(&
bio
->
bi_ªmaöög
);

685 i‡(
m
->
îr
) {

686 
	`˚Œ_îr‹
(
poﬁ
, 
m
->
˚Œ
);

687 
out
;

695 
r
 = 
	`dm_thö_ö£π_block
(
tc
->
td
, 
m
->
vút_block
, m->
d©a_block
);

696 i‡(
r
) {

697 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_thö_ö£π_block", 
r
);

698 
	`˚Œ_îr‹
(
poﬁ
, 
m
->
˚Œ
);

699 
out
;

708 i‡(
bio
) {

709 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
m
->
˚Œ
);

710 
	`bio_ídio
(
bio
, 0);

712 
	`˚Œ_de„r
(
tc
, 
m
->
˚Œ
);

714 
out
:

715 
	`li°_dñ
(&
m
->
li°
);

716 
	`mempoﬁ_‰ì
(
m
, 
poﬁ
->
m≠pög_poﬁ
);

717 
	}
}

719 
	$¥o˚ss_¥ï¨ed_disˇrd_Áû
(
dm_thö_√w_m≠pög
 *
m
)

721 
thö_c
 *
tc
 = 
m
->tc;

723 
	`bio_io_îr‹
(
m
->
bio
);

724 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
m
->
˚Œ
);

725 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
m
->
˚Œ2
);

726 
	`mempoﬁ_‰ì
(
m
, 
tc
->
poﬁ
->
m≠pög_poﬁ
);

727 
	}
}

729 
	$¥o˚ss_¥ï¨ed_disˇrd_∑ssdown
(
dm_thö_√w_m≠pög
 *
m
)

731 
thö_c
 *
tc
 = 
m
->tc;

733 
	`öc_Æl_io_íåy
(
tc
->
poﬁ
, 
m
->
bio
);

734 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
m
->
˚Œ
);

735 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
m
->
˚Œ2
);

737 i‡(
m
->
∑ss_disˇrd
)

738 i‡(
m
->
deföôñy_nŸ_sh¨ed
)

739 
	`ªm≠_™d_issue
(
tc
, 
m
->
bio
, m->
d©a_block
);

741 
boﬁ
 
u£d
 = 
Ál£
;

742 i‡(
	`dm_poﬁ_block_is_u£d
(
tc
->
poﬁ
->
pmd
, 
m
->
d©a_block
, &
u£d
) || used)

743 
	`bio_ídio
(
m
->
bio
, 0);

745 
	`ªm≠_™d_issue
(
tc
, 
m
->
bio
, m->
d©a_block
);

748 
	`bio_ídio
(
m
->
bio
, 0);

750 
	`mempoﬁ_‰ì
(
m
, 
tc
->
poﬁ
->
m≠pög_poﬁ
);

751 
	}
}

753 
	$¥o˚ss_¥ï¨ed_disˇrd
(
dm_thö_√w_m≠pög
 *
m
)

755 
r
;

756 
thö_c
 *
tc
 = 
m
->tc;

758 
r
 = 
	`dm_thö_ªmove_block
(
tc
->
td
, 
m
->
vút_block
);

759 i‡(
r
)

760 
	`DMERR_LIMIT
("dm_thin_remove_block() failed");

762 
	`¥o˚ss_¥ï¨ed_disˇrd_∑ssdown
(
m
);

763 
	}
}

765 
	$¥o˚ss_¥ï¨ed
(
poﬁ
 *poﬁ, 
li°_hód
 *
hód
,

766 
¥o˚ss_m≠pög_‚
 *
‚
)

768 
Êags
;

769 
li°_hód
 
m≠s
;

770 
dm_thö_√w_m≠pög
 *
m
, *
tmp
;

772 
	`INIT_LIST_HEAD
(&
m≠s
);

773 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

774 
	`li°_•li˚_öô
(
hód
, &
m≠s
);

775 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

777 
	`li°_f‹_óch_íåy_ß„
(
m
, 
tmp
, &
m≠s
, 
li°
)

778 (*
‚
)(
m
);

779 
	}
}

784 
	$io_ovîœps_block
(
poﬁ
 *poﬁ, 
bio
 *bio)

786  
bio
->
bi_ôî
.
bi_size
 ==

787 (
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

788 
	}
}

790 
	$io_ovîwrôes_block
(
poﬁ
 *poﬁ, 
bio
 *bio)

792  (
	`bio_d©a_dú
(
bio
Ë=
WRITE
) &&

793 
	`io_ovîœps_block
(
poﬁ
, 
bio
);

794 
	}
}

796 
	$ßve_™d_£t_ídio
(
bio
 *bio, 
bio_íd_io_t
 **
ßve
,

797 
bio_íd_io_t
 *
‚
)

799 *
ßve
 = 
bio
->
bi_íd_io
;

800 
bio
->
bi_íd_io
 = 
‚
;

801 
	}
}

803 
	$ísuª_√xt_m≠pög
(
poﬁ
 *pool)

805 i‡(
poﬁ
->
√xt_m≠pög
)

808 
poﬁ
->
√xt_m≠pög
 = 
	`mempoﬁ_Æloc
’oﬁ->
m≠pög_poﬁ
, 
GFP_ATOMIC
);

810  
poﬁ
->
√xt_m≠pög
 ? 0 : -
ENOMEM
;

811 
	}
}

813 
dm_thö_√w_m≠pög
 *
	$gë_√xt_m≠pög
(
poﬁ
 *pool)

815 
dm_thö_√w_m≠pög
 *
m
 = 
poﬁ
->
√xt_m≠pög
;

817 
	`BUG_ON
(!
poﬁ
->
√xt_m≠pög
);

819 
	`mem£t
(
m
, 0, (
dm_thö_√w_m≠pög
));

820 
	`INIT_LIST_HEAD
(&
m
->
li°
);

821 
m
->
bio
 = 
NULL
;

823 
poﬁ
->
√xt_m≠pög
 = 
NULL
;

825  
m
;

826 
	}
}

828 
	$Œ_zîo
(
thö_c
 *
tc
, 
dm_thö_√w_m≠pög
 *
m
,

829 
£˘‹_t
 
begö
, se˘‹_à
íd
)

831 
r
;

832 
dm_io_ªgi⁄
 
to
;

834 
to
.
bdev
 = 
tc
->
poﬁ_dev
->bdev;

835 
to
.
£˘‹
 = 
begö
;

836 
to
.
cou¡
 = 
íd
 - 
begö
;

838 
r
 = 
	`dm_kc›yd_zîo
(
tc
->
poﬁ
->
c›õr
, 1, &
to
, 0, 
c›y_com∂ëe
, 
m
);

839 i‡(
r
 < 0) {

840 
	`DMERR_LIMIT
("dm_kcopyd_zero() failed");

841 
	`c›y_com∂ëe
(1, 1, 
m
);

843 
	}
}

848 
	$scheduÀ_c›y
(
thö_c
 *
tc
, 
dm_block_t
 
vút_block
,

849 
dm_dev
 *
‹igö
, 
dm_block_t
 
d©a_‹igö
,

850 
dm_block_t
 
d©a_de°
,

851 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
bio
 *bio,

852 
£˘‹_t
 
Àn
)

854 
r
;

855 
poﬁ
 *poﬁ = 
tc
->pool;

856 
dm_thö_√w_m≠pög
 *
m
 = 
	`gë_√xt_m≠pög
(
poﬁ
);

858 
m
->
tc
 =Åc;

859 
m
->
vút_block
 = virt_block;

860 
m
->
d©a_block
 = 
d©a_de°
;

861 
m
->
˚Œ
 = cell;

868 
	`©omic_£t
(&
m
->
¥ï¨e_a˘i⁄s
, 3);

870 i‡(!
	`dm_de„ºed_£t_add_w‹k
(
poﬁ
->
sh¨ed_ªad_ds
, &
m
->
li°
))

871 
	`com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

879 i‡(
	`io_ovîwrôes_block
(
poﬁ
, 
bio
)) {

880 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

882 
h
->
ovîwrôe_m≠pög
 = 
m
;

883 
m
->
bio
 = bio;

884 
	`ßve_™d_£t_ídio
(
bio
, &
m
->
ßved_bi_íd_io
, 
ovîwrôe_ídio
);

885 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

886 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
d©a_de°
);

888 
dm_io_ªgi⁄
 
‰om
, 
to
;

890 
‰om
.
bdev
 = 
‹igö
->bdev;

891 
‰om
.
£˘‹
 = 
d©a_‹igö
 * 
poﬁ
->
£˘‹s_≥r_block
;

892 
‰om
.
cou¡
 = 
Àn
;

894 
to
.
bdev
 = 
tc
->
poﬁ_dev
->bdev;

895 
to
.
£˘‹
 = 
d©a_de°
 * 
poﬁ
->
£˘‹s_≥r_block
;

896 
to
.
cou¡
 = 
Àn
;

898 
r
 = 
	`dm_kc›yd_c›y
(
poﬁ
->
c›õr
, &
‰om
, 1, &
to
,

899 0, 
c›y_com∂ëe
, 
m
);

900 i‡(
r
 < 0) {

901 
	`DMERR_LIMIT
("dm_kcopyd_copy() failed");

902 
	`c›y_com∂ëe
(1, 1, 
m
);

915 i‡(
Àn
 < 
poﬁ
->
£˘‹s_≥r_block
 &&Öoﬁ->
pf
.
zîo_√w_blocks
) {

916 
	`©omic_öc
(&
m
->
¥ï¨e_a˘i⁄s
);

917 
	`Œ_zîo
(
tc
, 
m
,

918 
d©a_de°
 * 
poﬁ
->
£˘‹s_≥r_block
 + 
Àn
,

919 (
d©a_de°
 + 1Ë* 
poﬁ
->
£˘‹s_≥r_block
);

923 
	`com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

924 
	}
}

926 
	$scheduÀ_öã∫Æ_c›y
(
thö_c
 *
tc
, 
dm_block_t
 
vút_block
,

927 
dm_block_t
 
d©a_‹igö
, dm_block_à
d©a_de°
,

928 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
bio
 *bio)

930 
	`scheduÀ_c›y
(
tc
, 
vút_block
,Åc->
poﬁ_dev
,

931 
d©a_‹igö
, 
d©a_de°
, 
˚Œ
, 
bio
,

932 
tc
->
poﬁ
->
£˘‹s_≥r_block
);

933 
	}
}

935 
	$scheduÀ_zîo
(
thö_c
 *
tc
, 
dm_block_t
 
vút_block
,

936 
dm_block_t
 
d©a_block
, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
,

937 
bio
 *bio)

939 
poﬁ
 *poﬁ = 
tc
->pool;

940 
dm_thö_√w_m≠pög
 *
m
 = 
	`gë_√xt_m≠pög
(
poﬁ
);

942 
	`©omic_£t
(&
m
->
¥ï¨e_a˘i⁄s
, 1);

943 
m
->
tc
 =Åc;

944 
m
->
vút_block
 = virt_block;

945 
m
->
d©a_block
 = data_block;

946 
m
->
˚Œ
 = cell;

953 i‡(!
poﬁ
->
pf
.
zîo_√w_blocks
)

954 
	`¥o˚ss_¥ï¨ed_m≠pög
(
m
);

956 i‡(
	`io_ovîwrôes_block
(
poﬁ
, 
bio
)) {

957 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

959 
h
->
ovîwrôe_m≠pög
 = 
m
;

960 
m
->
bio
 = bio;

961 
	`ßve_™d_£t_ídio
(
bio
, &
m
->
ßved_bi_íd_io
, 
ovîwrôe_ídio
);

962 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

963 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
d©a_block
);

966 
	`Œ_zîo
(
tc
, 
m
,

967 
d©a_block
 * 
poﬁ
->
£˘‹s_≥r_block
,

968 (
d©a_block
 + 1Ë* 
poﬁ
->
£˘‹s_≥r_block
);

969 
	}
}

971 
	$scheduÀ_exã∫Æ_c›y
(
thö_c
 *
tc
, 
dm_block_t
 
vút_block
,

972 
dm_block_t
 
d©a_de°
,

973 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, 
bio
 *bio)

975 
poﬁ
 *poﬁ = 
tc
->pool;

976 
£˘‹_t
 
vút_block_begö
 = 
vút_block
 * 
poﬁ
->
£˘‹s_≥r_block
;

977 
£˘‹_t
 
vút_block_íd
 = (
vút_block
 + 1Ë* 
poﬁ
->
£˘‹s_≥r_block
;

979 i‡(
vút_block_íd
 <
tc
->
‹igö_size
)

980 
	`scheduÀ_c›y
(
tc
, 
vút_block
,Åc->
‹igö_dev
,

981 
vút_block
, 
d©a_de°
, 
˚Œ
, 
bio
,

982 
poﬁ
->
£˘‹s_≥r_block
);

984 i‡(
vút_block_begö
 < 
tc
->
‹igö_size
)

985 
	`scheduÀ_c›y
(
tc
, 
vút_block
,Åc->
‹igö_dev
,

986 
vút_block
, 
d©a_de°
, 
˚Œ
, 
bio
,

987 
tc
->
‹igö_size
 - 
vút_block_begö
);

990 
	`scheduÀ_zîo
(
tc
, 
vút_block
, 
d©a_de°
, 
˚Œ
, 
bio
);

991 
	}
}

997 
	$commô
(
poﬁ
 *pool)

999 
r
;

1001 i‡(
	`gë_poﬁ_mode
(
poﬁ
Ë>
PM_READ_ONLY
)

1002  -
EINVAL
;

1004 
r
 = 
	`dm_poﬁ_commô_mëad©a
(
poﬁ
->
pmd
);

1005 i‡(
r
)

1006 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_commô_mëad©a", 
r
);

1008  
r
;

1009 
	}
}

1011 
	$check_low_w©î_m¨k
(
poﬁ
 *poﬁ, 
dm_block_t
 
‰ì_blocks
)

1013 
Êags
;

1015 i‡(
‰ì_blocks
 <
poﬁ
->
low_w©î_blocks
 && !poﬁ->
low_w©î_åiggîed
) {

1016 
	`DMWARN
("%s:ÑeachedÜow water mark for data device: sendingÉvent.",

1017 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

1018 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

1019 
poﬁ
->
low_w©î_åiggîed
 = 
åue
;

1020 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

1021 
	`dm_èbÀ_evít
(
poﬁ
->
ti
->
èbÀ
);

1023 
	}
}

1025 
£t_poﬁ_mode
(
poﬁ
 *poﬁ, 
poﬁ_mode
 
√w_mode
);

1027 
	$Æloc_d©a_block
(
thö_c
 *
tc
, 
dm_block_t
 *
ªsu…
)

1029 
r
;

1030 
dm_block_t
 
‰ì_blocks
;

1031 
poﬁ
 *poﬁ = 
tc
->pool;

1033 i‡(
	`WARN_ON
(
	`gë_poﬁ_mode
(
poﬁ
Ë!
PM_WRITE
))

1034  -
EINVAL
;

1036 
r
 = 
	`dm_poﬁ_gë_‰ì_block_cou¡
(
poﬁ
->
pmd
, &
‰ì_blocks
);

1037 i‡(
r
) {

1038 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_gë_‰ì_block_cou¡", 
r
);

1039  
r
;

1042 
	`check_low_w©î_m¨k
(
poﬁ
, 
‰ì_blocks
);

1044 i‡(!
‰ì_blocks
) {

1049 
r
 = 
	`commô
(
poﬁ
);

1050 i‡(
r
)

1051  
r
;

1053 
r
 = 
	`dm_poﬁ_gë_‰ì_block_cou¡
(
poﬁ
->
pmd
, &
‰ì_blocks
);

1054 i‡(
r
) {

1055 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_gë_‰ì_block_cou¡", 
r
);

1056  
r
;

1059 i‡(!
‰ì_blocks
) {

1060 
	`£t_poﬁ_mode
(
poﬁ
, 
PM_OUT_OF_DATA_SPACE
);

1061  -
ENOSPC
;

1065 
r
 = 
	`dm_poﬁ_Æloc_d©a_block
(
poﬁ
->
pmd
, 
ªsu…
);

1066 i‡(
r
) {

1067 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_Æloc_d©a_block", 
r
);

1068  
r
;

1072 
	}
}

1078 
	$ªåy_⁄_ªsume
(
bio
 *bio)

1080 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

1081 
thö_c
 *
tc
 = 
h
->tc;

1082 
Êags
;

1084 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

1085 
	`bio_li°_add
(&
tc
->
ªåy_⁄_ªsume_li°
, 
bio
);

1086 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

1087 
	}
}

1089 
	$should_îr‹_un£rvi˚abÀ_bio
(
poﬁ
 *pool)

1091 
poﬁ_mode
 
m
 = 
	`gë_poﬁ_mode
(
poﬁ
);

1093 
m
) {

1094 
PM_WRITE
:

1096 
	`DMERR_LIMIT
("bio unserviceable, yetÖool is in PM_WRITE mode");

1097  -
EIO
;

1099 
PM_OUT_OF_DATA_SPACE
:

1100  
poﬁ
->
pf
.
îr‹_if_no_•a˚
 ? -
ENOSPC
 : 0;

1102 
PM_READ_ONLY
:

1103 
PM_FAIL
:

1104  -
EIO
;

1107 
	`DMERR_LIMIT
("bio unserviceable, yetÖool hasán unknown mode");

1108  -
EIO
;

1110 
	}
}

1112 
	$h™dÀ_un£rvi˚abÀ_bio
(
poﬁ
 *poﬁ, 
bio
 *bio)

1114 
îr‹
 = 
	`should_îr‹_un£rvi˚abÀ_bio
(
poﬁ
);

1116 i‡(
îr‹
)

1117 
	`bio_ídio
(
bio
, 
îr‹
);

1119 
	`ªåy_⁄_ªsume
(
bio
);

1120 
	}
}

1122 
	$ªåy_bios_⁄_ªsume
(
poﬁ
 *poﬁ, 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1124 
bio
 *bio;

1125 
bio_li°
 
bios
;

1126 
îr‹
;

1128 
îr‹
 = 
	`should_îr‹_un£rvi˚abÀ_bio
(
poﬁ
);

1129 i‡(
îr‹
) {

1130 
	`˚Œ_îr‹_wôh_code
(
poﬁ
, 
˚Œ
, 
îr‹
);

1134 
	`bio_li°_öô
(&
bios
);

1135 
	`˚Œ_ªÀa£
(
poﬁ
, 
˚Œ
, &
bios
);

1137 
îr‹
 = 
	`should_îr‹_un£rvi˚abÀ_bio
(
poﬁ
);

1138 i‡(
îr‹
)

1139 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1140 
	`bio_ídio
(
bio
, 
îr‹
);

1142 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1143 
	`ªåy_⁄_ªsume
(
bio
);

1144 
	}
}

1146 
	$¥o˚ss_disˇrd
(
thö_c
 *
tc
, 
bio
 *bio)

1148 
r
;

1149 
Êags
;

1150 
poﬁ
 *poﬁ = 
tc
->pool;

1151 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
, *
˚Œ2
;

1152 
dm_˚Œ_key
 
key
, 
key2
;

1153 
dm_block_t
 
block
 = 
	`gë_bio_block
(
tc
, 
bio
);

1154 
dm_thö_lookup_ªsu…
 
lookup_ªsu…
;

1155 
dm_thö_√w_m≠pög
 *
m
;

1157 
	`buûd_vútuÆ_key
(
tc
->
td
, 
block
, &
key
);

1158 i‡(
	`bio_dëaö
(
tc
->
poﬁ
, &
key
, 
bio
, &
˚Œ
))

1161 
r
 = 
	`dm_thö_föd_block
(
tc
->
td
, 
block
, 1, &
lookup_ªsu…
);

1162 
r
) {

1169 
	`buûd_d©a_key
(
tc
->
td
, 
lookup_ªsu…
.
block
, &
key2
);

1170 i‡(
	`bio_dëaö
(
tc
->
poﬁ
, &
key2
, 
bio
, &
˚Œ2
)) {

1171 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1175 i‡(
	`io_ovîœps_block
(
poﬁ
, 
bio
)) {

1180 
m
 = 
	`gë_√xt_m≠pög
(
poﬁ
);

1181 
m
->
tc
 =Åc;

1182 
m
->
∑ss_disˇrd
 = 
poﬁ
->
pf
.
disˇrd_∑ssdown
;

1183 
m
->
deföôñy_nŸ_sh¨ed
 = !
lookup_ªsu…
.
sh¨ed
;

1184 
m
->
vút_block
 = 
block
;

1185 
m
->
d©a_block
 = 
lookup_ªsu…
.
block
;

1186 
m
->
˚Œ
 = cell;

1187 
m
->
˚Œ2
 = cell2;

1188 
m
->
bio
 = bio;

1190 i‡(!
	`dm_de„ºed_£t_add_w‹k
(
poﬁ
->
Æl_io_ds
, &
m
->
li°
)) {

1191 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

1192 
	`li°_add_èû
(&
m
->
li°
, &
poﬁ
->
¥ï¨ed_disˇrds
);

1193 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

1194 
	`wake_w‹kî
(
poﬁ
);

1197 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

1198 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1199 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ2
);

1206 i‡((!
lookup_ªsu…
.
sh¨ed
Ë&& 
poﬁ
->
pf
.
disˇrd_∑ssdown
)

1207 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
lookup_ªsu…
.
block
);

1209 
	`bio_ídio
(
bio
, 0);

1213 -
ENODATA
:

1217 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1218 
	`bio_ídio
(
bio
, 0);

1222 
	`DMERR_LIMIT
("%s: dm_thin_find_block() failed:Érror = %d",

1223 
__func__
, 
r
);

1224 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1225 
	`bio_io_îr‹
(
bio
);

1228 
	}
}

1230 
	$bªak_sh¨ög
(
thö_c
 *
tc
, 
bio
 *bio, 
dm_block_t
 
block
,

1231 
dm_˚Œ_key
 *
key
,

1232 
dm_thö_lookup_ªsu…
 *
lookup_ªsu…
,

1233 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1235 
r
;

1236 
dm_block_t
 
d©a_block
;

1237 
poﬁ
 *poﬁ = 
tc
->pool;

1239 
r
 = 
	`Æloc_d©a_block
(
tc
, &
d©a_block
);

1240 
r
) {

1242 
	`scheduÀ_öã∫Æ_c›y
(
tc
, 
block
, 
lookup_ªsu…
->block,

1243 
d©a_block
, 
˚Œ
, 
bio
);

1246 -
ENOSPC
:

1247 
	`ªåy_bios_⁄_ªsume
(
poﬁ
, 
˚Œ
);

1251 
	`DMERR_LIMIT
("%s:álloc_data_block() failed:Érror = %d",

1252 
__func__
, 
r
);

1253 
	`˚Œ_îr‹
(
poﬁ
, 
˚Œ
);

1256 
	}
}

1258 
	$¥o˚ss_sh¨ed_bio
(
thö_c
 *
tc
, 
bio
 *bio,

1259 
dm_block_t
 
block
,

1260 
dm_thö_lookup_ªsu…
 *
lookup_ªsu…
)

1262 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
;

1263 
poﬁ
 *poﬁ = 
tc
->pool;

1264 
dm_˚Œ_key
 
key
;

1270 
	`buûd_d©a_key
(
tc
->
td
, 
lookup_ªsu…
->
block
, &
key
);

1271 i‡(
	`bio_dëaö
(
poﬁ
, &
key
, 
bio
, &
˚Œ
))

1274 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
 && bio->
bi_ôî
.
bi_size
)

1275 
	`bªak_sh¨ög
(
tc
, 
bio
, 
block
, &
key
, 
lookup_ªsu…
, 
˚Œ
);

1277 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

1279 
h
->
sh¨ed_ªad_íåy
 = 
	`dm_de„ºed_íåy_öc
(
poﬁ
->
sh¨ed_ªad_ds
);

1280 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

1281 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1283 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
lookup_ªsu…
->
block
);

1285 
	}
}

1287 
	$¥ovisi⁄_block
(
thö_c
 *
tc
, 
bio
 *bio, 
dm_block_t
 
block
,

1288 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
)

1290 
r
;

1291 
dm_block_t
 
d©a_block
;

1292 
poﬁ
 *poﬁ = 
tc
->pool;

1297 i‡(!
bio
->
bi_ôî
.
bi_size
) {

1298 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

1299 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1301 
	`ªm≠_™d_issue
(
tc
, 
bio
, 0);

1308 i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
) {

1309 
	`zîo_fûl_bio
(
bio
);

1310 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1311 
	`bio_ídio
(
bio
, 0);

1315 
r
 = 
	`Æloc_d©a_block
(
tc
, &
d©a_block
);

1316 
r
) {

1318 i‡(
tc
->
‹igö_dev
)

1319 
	`scheduÀ_exã∫Æ_c›y
(
tc
, 
block
, 
d©a_block
, 
˚Œ
, 
bio
);

1321 
	`scheduÀ_zîo
(
tc
, 
block
, 
d©a_block
, 
˚Œ
, 
bio
);

1324 -
ENOSPC
:

1325 
	`ªåy_bios_⁄_ªsume
(
poﬁ
, 
˚Œ
);

1329 
	`DMERR_LIMIT
("%s:álloc_data_block() failed:Érror = %d",

1330 
__func__
, 
r
);

1331 
	`˚Œ_îr‹
(
poﬁ
, 
˚Œ
);

1334 
	}
}

1336 
	$¥o˚ss_bio
(
thö_c
 *
tc
, 
bio
 *bio)

1338 
r
;

1339 
poﬁ
 *poﬁ = 
tc
->pool;

1340 
dm_block_t
 
block
 = 
	`gë_bio_block
(
tc
, 
bio
);

1341 
dm_bio_¥is⁄_˚Œ
 *
˚Œ
;

1342 
dm_˚Œ_key
 
key
;

1343 
dm_thö_lookup_ªsu…
 
lookup_ªsu…
;

1349 
	`buûd_vútuÆ_key
(
tc
->
td
, 
block
, &
key
);

1350 i‡(
	`bio_dëaö
(
poﬁ
, &
key
, 
bio
, &
˚Œ
))

1353 
r
 = 
	`dm_thö_föd_block
(
tc
->
td
, 
block
, 1, &
lookup_ªsu…
);

1354 
r
) {

1356 i‡(
lookup_ªsu…
.
sh¨ed
) {

1357 
	`¥o˚ss_sh¨ed_bio
(
tc
, 
bio
, 
block
, &
lookup_ªsu…
);

1358 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1360 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

1361 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1363 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
lookup_ªsu…
.
block
);

1367 -
ENODATA
:

1368 i‡(
	`bio_d©a_dú
(
bio
Ë=
READ
 && 
tc
->
‹igö_dev
) {

1369 
	`öc_Æl_io_íåy
(
poﬁ
, 
bio
);

1370 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1372 i‡(
	`bio_íd_£˘‹
(
bio
Ë<
tc
->
‹igö_size
)

1373 
	`ªm≠_to_‹igö_™d_issue
(
tc
, 
bio
);

1375 i‡(
bio
->
bi_ôî
.
bi_£˘‹
 < 
tc
->
‹igö_size
) {

1376 
	`zîo_fûl_bio
(
bio
);

1377 
bio
->
bi_ôî
.
bi_size
 = (
tc
->
‹igö_size
 - bio->bi_ôî.
bi_£˘‹
Ë<< 
SECTOR_SHIFT
;

1378 
	`ªm≠_to_‹igö_™d_issue
(
tc
, 
bio
);

1381 
	`zîo_fûl_bio
(
bio
);

1382 
	`bio_ídio
(
bio
, 0);

1385 
	`¥ovisi⁄_block
(
tc
, 
bio
, 
block
, 
˚Œ
);

1389 
	`DMERR_LIMIT
("%s: dm_thin_find_block() failed:Érror = %d",

1390 
__func__
, 
r
);

1391 
	`˚Œ_de„r_no_hﬁdî
(
tc
, 
˚Œ
);

1392 
	`bio_io_îr‹
(
bio
);

1395 
	}
}

1397 
	$¥o˚ss_bio_ªad_⁄ly
(
thö_c
 *
tc
, 
bio
 *bio)

1399 
r
;

1400 
rw
 = 
	`bio_d©a_dú
(
bio
);

1401 
dm_block_t
 
block
 = 
	`gë_bio_block
(
tc
, 
bio
);

1402 
dm_thö_lookup_ªsu…
 
lookup_ªsu…
;

1404 
r
 = 
	`dm_thö_föd_block
(
tc
->
td
, 
block
, 1, &
lookup_ªsu…
);

1405 
r
) {

1407 i‡(
lookup_ªsu…
.
sh¨ed
 && (
rw
 =
WRITE
Ë&& 
bio
->
bi_ôî
.
bi_size
)

1408 
	`h™dÀ_un£rvi˚abÀ_bio
(
tc
->
poﬁ
, 
bio
);

1410 
	`öc_Æl_io_íåy
(
tc
->
poﬁ
, 
bio
);

1411 
	`ªm≠_™d_issue
(
tc
, 
bio
, 
lookup_ªsu…
.
block
);

1415 -
ENODATA
:

1416 i‡(
rw
 !
READ
) {

1417 
	`h™dÀ_un£rvi˚abÀ_bio
(
tc
->
poﬁ
, 
bio
);

1421 i‡(
tc
->
‹igö_dev
) {

1422 
	`öc_Æl_io_íåy
(
tc
->
poﬁ
, 
bio
);

1423 
	`ªm≠_to_‹igö_™d_issue
(
tc
, 
bio
);

1427 
	`zîo_fûl_bio
(
bio
);

1428 
	`bio_ídio
(
bio
, 0);

1432 
	`DMERR_LIMIT
("%s: dm_thin_find_block() failed:Érror = %d",

1433 
__func__
, 
r
);

1434 
	`bio_io_îr‹
(
bio
);

1437 
	}
}

1439 
	$¥o˚ss_bio_suc˚ss
(
thö_c
 *
tc
, 
bio
 *bio)

1441 
	`bio_ídio
(
bio
, 0);

1442 
	}
}

1444 
	$¥o˚ss_bio_Áû
(
thö_c
 *
tc
, 
bio
 *bio)

1446 
	`bio_io_îr‹
(
bio
);

1447 
	}
}

1453 
	$√ed_commô_due_to_time
(
poﬁ
 *pool)

1455  
jiffõs
 < 
poﬁ
->
œ°_commô_jiffõs
 ||

1456 
jiffõs
 > 
poﬁ
->
œ°_commô_jiffõs
 + 
COMMIT_PERIOD
;

1457 
	}
}

1459 
	#thö_pbd
(
node
Ë
	`rb_íåy
(“ode), 
dm_thö_ídio_hook
, 
rb_node
)

	)

1460 
	#thö_bio
(
pbd
Ë
	`dm_bio_‰om_≥r_bio_d©a
(’bd), (
dm_thö_ídio_hook
))

	)

1462 
	$__thö_bio_rb_add
(
thö_c
 *
tc
, 
bio
 *bio)

1464 
rb_node
 **
rbp
, *
∑ª¡
;

1465 
dm_thö_ídio_hook
 *
pbd
;

1466 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

1468 
rbp
 = &
tc
->
s‹t_bio_li°
.
rb_node
;

1469 
∑ª¡
 = 
NULL
;

1470 *
rbp
) {

1471 
∑ª¡
 = *
rbp
;

1472 
pbd
 = 
	`thö_pbd
(
∑ª¡
);

1474 i‡(
bi_£˘‹
 < 
	`thö_bio
(
pbd
)->
bi_ôî
.bi_sector)

1475 
rbp
 = &(*rbp)->
rb_À·
;

1477 
rbp
 = &(*rbp)->
rb_right
;

1480 
pbd
 = 
	`dm_≥r_bio_d©a
(
bio
, (
dm_thö_ídio_hook
));

1481 
	`rb_lök_node
(&
pbd
->
rb_node
, 
∑ª¡
, 
rbp
);

1482 
	`rb_ö£π_cﬁ‹
(&
pbd
->
rb_node
, &
tc
->
s‹t_bio_li°
);

1483 
	}
}

1485 
	$__exåa˘_s‹ãd_bios
(
thö_c
 *
tc
)

1487 
rb_node
 *
node
;

1488 
dm_thö_ídio_hook
 *
pbd
;

1489 
bio
 *bio;

1491 
node
 = 
	`rb_fú°
(&
tc
->
s‹t_bio_li°
);Çode;Çodê
	`rb_√xt
(node)) {

1492 
pbd
 = 
	`thö_pbd
(
node
);

1493 
bio
 = 
	`thö_bio
(
pbd
);

1495 
	`bio_li°_add
(&
tc
->
de„ºed_bio_li°
, 
bio
);

1496 
	`rb_îa£
(&
pbd
->
rb_node
, &
tc
->
s‹t_bio_li°
);

1499 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
tc
->
s‹t_bio_li°
));

1500 
	}
}

1502 
	$__s‹t_thö_de„ºed_bios
(
thö_c
 *
tc
)

1504 
bio
 *bio;

1505 
bio_li°
 
bios
;

1507 
	`bio_li°_öô
(&
bios
);

1508 
	`bio_li°_mîge
(&
bios
, &
tc
->
de„ºed_bio_li°
);

1509 
	`bio_li°_öô
(&
tc
->
de„ºed_bio_li°
);

1512 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1513 
	`__thö_bio_rb_add
(
tc
, 
bio
);

1520 
	`__exåa˘_s‹ãd_bios
(
tc
);

1521 
	}
}

1523 
	$¥o˚ss_thö_de„ºed_bios
(
thö_c
 *
tc
)

1525 
poﬁ
 *poﬁ = 
tc
->pool;

1526 
Êags
;

1527 
bio
 *bio;

1528 
bio_li°
 
bios
;

1529 
blk_∂ug
 
∂ug
;

1531 i‡(
tc
->
ªqueue_mode
) {

1532 
	`ªqueue_bio_li°
(
tc
, &tc->
de„ºed_bio_li°
);

1536 
	`bio_li°_öô
(&
bios
);

1538 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

1540 i‡(
	`bio_li°_em±y
(&
tc
->
de„ºed_bio_li°
)) {

1541 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

1545 
	`__s‹t_thö_de„ºed_bios
(
tc
);

1547 
	`bio_li°_mîge
(&
bios
, &
tc
->
de„ºed_bio_li°
);

1548 
	`bio_li°_öô
(&
tc
->
de„ºed_bio_li°
);

1550 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

1552 
	`blk_°¨t_∂ug
(&
∂ug
);

1553 (
bio
 = 
	`bio_li°_p›
(&
bios
))) {

1559 i‡(
	`ísuª_√xt_m≠pög
(
poﬁ
)) {

1560 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

1561 
	`bio_li°_add
(&
tc
->
de„ºed_bio_li°
, 
bio
);

1562 
	`bio_li°_mîge
(&
tc
->
de„ºed_bio_li°
, &
bios
);

1563 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

1567 i‡(
bio
->
bi_rw
 & 
REQ_DISCARD
)

1568 
poﬁ
->
	`¥o˚ss_disˇrd
(
tc
, 
bio
);

1570 
poﬁ
->
	`¥o˚ss_bio
(
tc
, 
bio
);

1572 
	`blk_föish_∂ug
(&
∂ug
);

1573 
	}
}

1575 
thö_gë
(
thö_c
 *
tc
);

1576 
thö_put
(
thö_c
 *
tc
);

1583 
thö_c
 *
	$gë_fú°_thö
(
poﬁ
 *pool)

1585 
thö_c
 *
tc
 = 
NULL
;

1587 
	`rcu_ªad_lock
();

1588 i‡(!
	`li°_em±y
(&
poﬁ
->
a˘ive_thös
)) {

1589 
tc
 = 
	`li°_íåy_rcu
(
poﬁ
->
a˘ive_thös
.
√xt
, 
thö_c
, 
li°
);

1590 
	`thö_gë
(
tc
);

1592 
	`rcu_ªad_u∆ock
();

1594  
tc
;

1595 
	}
}

1597 
thö_c
 *
	$gë_√xt_thö
(
poﬁ
 *poﬁ, 
thö_c
 *
tc
)

1599 
thö_c
 *
ﬁd_tc
 = 
tc
;

1601 
	`rcu_ªad_lock
();

1602 
	`li°_f‹_óch_íåy_c⁄töue_rcu
(
tc
, &
poﬁ
->
a˘ive_thös
, 
li°
) {

1603 
	`thö_gë
(
tc
);

1604 
	`thö_put
(
ﬁd_tc
);

1605 
	`rcu_ªad_u∆ock
();

1606  
tc
;

1608 
	`thö_put
(
ﬁd_tc
);

1609 
	`rcu_ªad_u∆ock
();

1611  
NULL
;

1612 
	}
}

1614 
	$¥o˚ss_de„ºed_bios
(
poﬁ
 *pool)

1616 
Êags
;

1617 
bio
 *bio;

1618 
bio_li°
 
bios
;

1619 
thö_c
 *
tc
;

1621 
tc
 = 
	`gë_fú°_thö
(
poﬁ
);

1622 
tc
) {

1623 
	`¥o˚ss_thö_de„ºed_bios
(
tc
);

1624 
tc
 = 
	`gë_√xt_thö
(
poﬁ
,Åc);

1631 
	`bio_li°_öô
(&
bios
);

1632 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

1633 
	`bio_li°_mîge
(&
bios
, &
poﬁ
->
de„ºed_Êush_bios
);

1634 
	`bio_li°_öô
(&
poﬁ
->
de„ºed_Êush_bios
);

1635 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

1637 i‡(
	`bio_li°_em±y
(&
bios
) &&

1638 !(
	`dm_poﬁ_ch™ged_this_å™ß˘i⁄
(
poﬁ
->
pmd
Ë&& 
	`√ed_commô_due_to_time
(pool)))

1641 i‡(
	`commô
(
poﬁ
)) {

1642 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1643 
	`bio_io_îr‹
(
bio
);

1646 
poﬁ
->
œ°_commô_jiffõs
 = 
jiffõs
;

1648 (
bio
 = 
	`bio_li°_p›
(&
bios
)))

1649 
	`gíîic_make_ªque°
(
bio
);

1650 
	}
}

1652 
	$do_w‹kî
(
w‹k_°ru˘
 *
ws
)

1654 
poﬁ
 *poﬁ = 
	`c⁄èöî_of
(
ws
, poﬁ, 
w‹kî
);

1656 
	`¥o˚ss_¥ï¨ed
(
poﬁ
, &poﬁ->
¥ï¨ed_m≠pögs
, &poﬁ->
¥o˚ss_¥ï¨ed_m≠pög
);

1657 
	`¥o˚ss_¥ï¨ed
(
poﬁ
, &poﬁ->
¥ï¨ed_disˇrds
, &poﬁ->
¥o˚ss_¥ï¨ed_disˇrd
);

1658 
	`¥o˚ss_de„ºed_bios
(
poﬁ
);

1659 
	}
}

1665 
	$do_wakî
(
w‹k_°ru˘
 *
ws
)

1667 
poﬁ
 *poﬁ = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
ws
), poﬁ, 
wakî
);

1668 
	`wake_w‹kî
(
poﬁ
);

1669 
	`queue_dñayed_w‹k
(
poﬁ
->
wq
, &poﬁ->
wakî
, 
COMMIT_PERIOD
);

1670 
	}
}

1677 
	$do_no_•a˚_timeout
(
w‹k_°ru˘
 *
ws
)

1679 
poﬁ
 *poﬁ = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
ws
), pool,

1680 
no_•a˚_timeout
);

1682 i‡(
	`gë_poﬁ_mode
(
poﬁ
Ë=
PM_OUT_OF_DATA_SPACE
 && !poﬁ->
pf
.
îr‹_if_no_•a˚
)

1683 
	`£t_poﬁ_mode
(
poﬁ
, 
PM_READ_ONLY
);

1684 
	}
}

1688 
	spoﬁ_w‹k
 {

1689 
w‹k_°ru˘
 
	mw‹kî
;

1690 
com∂ëi⁄
 
	mcom∂ëe
;

1693 
poﬁ_w‹k
 *
	$to_poﬁ_w‹k
(
w‹k_°ru˘
 *
ws
)

1695  
	`c⁄èöî_of
(
ws
, 
poﬁ_w‹k
, 
w‹kî
);

1696 
	}
}

1698 
	$poﬁ_w‹k_com∂ëe
(
poﬁ_w‹k
 *
pw
)

1700 
	`com∂ëe
(&
pw
->
com∂ëe
);

1701 
	}
}

1703 
poﬁ_w‹k_waô
(
poﬁ_w‹k
 *
pw
, 
poﬁ
 *pool,

1704 (*
‚
)(
w‹k_°ru˘
 *))

1706 
	`INIT_WORK_ONSTACK
(&
pw
->
w‹kî
, 
‚
);

1707 
	`öô_com∂ëi⁄
(&
pw
->
com∂ëe
);

1708 
	`queue_w‹k
(
poﬁ
->
wq
, &
pw
->
w‹kî
);

1709 
	`waô_f‹_com∂ëi⁄
(&
pw
->
com∂ëe
);

1710 
	}
}

1714 
	snoÊush_w‹k
 {

1715 
poﬁ_w‹k
 
	mpw
;

1716 
thö_c
 *
	mtc
;

1719 
noÊush_w‹k
 *
	$to_noÊush
(
w‹k_°ru˘
 *
ws
)

1721  
	`c⁄èöî_of
(
	`to_poﬁ_w‹k
(
ws
), 
noÊush_w‹k
, 
pw
);

1722 
	}
}

1724 
	$do_noÊush_°¨t
(
w‹k_°ru˘
 *
ws
)

1726 
noÊush_w‹k
 *
w
 = 
	`to_noÊush
(
ws
);

1727 
w
->
tc
->
ªqueue_mode
 = 
åue
;

1728 
	`ªqueue_io
(
w
->
tc
);

1729 
	`poﬁ_w‹k_com∂ëe
(&
w
->
pw
);

1730 
	}
}

1732 
	$do_noÊush_°›
(
w‹k_°ru˘
 *
ws
)

1734 
noÊush_w‹k
 *
w
 = 
	`to_noÊush
(
ws
);

1735 
w
->
tc
->
ªqueue_mode
 = 
Ál£
;

1736 
	`poﬁ_w‹k_com∂ëe
(&
w
->
pw
);

1737 
	}
}

1739 
noÊush_w‹k
(
thö_c
 *
tc
, (*
‚
)(
w‹k_°ru˘
 *))

1741 
noÊush_w‹k
 
w
;

1743 
w
.
tc
 =Åc;

1744 
	`poﬁ_w‹k_waô
(&
w
.
pw
, 
tc
->
poﬁ
, 
‚
);

1745 
	}
}

1749 
poﬁ_mode
 
	$gë_poﬁ_mode
(
poﬁ
 *pool)

1751  
poﬁ
->
pf
.
mode
;

1752 
	}
}

1754 
	$nŸify_of_poﬁ_mode_ch™ge
(
poﬁ
 *poﬁ, c⁄° *
√w_mode
)

1756 
	`dm_èbÀ_evít
(
poﬁ
->
ti
->
èbÀ
);

1757 
	`DMINFO
("%s: switchingÖoolÅo %s mode",

1758 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
√w_mode
);

1759 
	}
}

1761 
	$£t_poﬁ_mode
(
poﬁ
 *poﬁ, 
poﬁ_mode
 
√w_mode
)

1763 
poﬁ_c
 *
±
 = 
poﬁ
->
ti
->
¥iv©e
;

1764 
boﬁ
 
√eds_check
 = 
	`dm_poﬁ_mëad©a_√eds_check
(
poﬁ
->
pmd
);

1765 
poﬁ_mode
 
ﬁd_mode
 = 
	`gë_poﬁ_mode
(
poﬁ
);

1766 
no_•a˚_timeout
 = 
	`ACCESS_ONCE
(
no_•a˚_timeout_£cs
Ë* 
HZ
;

1772 i‡(
√w_mode
 =
PM_WRITE
 && 
√eds_check
) {

1773 
	`DMERR
("%s: unableÅo switchÖoolÅo write mode untilÑepaired.",

1774 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

1775 i‡(
ﬁd_mode
 !
√w_mode
)

1776 
√w_mode
 = 
ﬁd_mode
;

1778 
√w_mode
 = 
PM_READ_ONLY
;

1785 i‡(
ﬁd_mode
 =
PM_FAIL
)

1786 
√w_mode
 = 
ﬁd_mode
;

1788 
√w_mode
) {

1789 
PM_FAIL
:

1790 i‡(
ﬁd_mode
 !
√w_mode
)

1791 
	`nŸify_of_poﬁ_mode_ch™ge
(
poﬁ
, "failure");

1792 
	`dm_poﬁ_mëad©a_ªad_⁄ly
(
poﬁ
->
pmd
);

1793 
poﬁ
->
¥o˚ss_bio
 = 
¥o˚ss_bio_Áû
;

1794 
poﬁ
->
¥o˚ss_disˇrd
 = 
¥o˚ss_bio_Áû
;

1795 
poﬁ
->
¥o˚ss_¥ï¨ed_m≠pög
 = 
¥o˚ss_¥ï¨ed_m≠pög_Áû
;

1796 
poﬁ
->
¥o˚ss_¥ï¨ed_disˇrd
 = 
¥o˚ss_¥ï¨ed_disˇrd_Áû
;

1798 
	`îr‹_ªåy_li°
(
poﬁ
);

1801 
PM_READ_ONLY
:

1802 i‡(
ﬁd_mode
 !
√w_mode
)

1803 
	`nŸify_of_poﬁ_mode_ch™ge
(
poﬁ
, "read-only");

1804 
	`dm_poﬁ_mëad©a_ªad_⁄ly
(
poﬁ
->
pmd
);

1805 
poﬁ
->
¥o˚ss_bio
 = 
¥o˚ss_bio_ªad_⁄ly
;

1806 
poﬁ
->
¥o˚ss_disˇrd
 = 
¥o˚ss_bio_suc˚ss
;

1807 
poﬁ
->
¥o˚ss_¥ï¨ed_m≠pög
 = 
¥o˚ss_¥ï¨ed_m≠pög_Áû
;

1808 
poﬁ
->
¥o˚ss_¥ï¨ed_disˇrd
 = 
¥o˚ss_¥ï¨ed_disˇrd_∑ssdown
;

1810 
	`îr‹_ªåy_li°
(
poﬁ
);

1813 
PM_OUT_OF_DATA_SPACE
:

1822 i‡(
ﬁd_mode
 !
√w_mode
)

1823 
	`nŸify_of_poﬁ_mode_ch™ge
(
poﬁ
, "out-of-data-space");

1824 
poﬁ
->
¥o˚ss_bio
 = 
¥o˚ss_bio_ªad_⁄ly
;

1825 
poﬁ
->
¥o˚ss_disˇrd
 =Örocess_discard;

1826 
poﬁ
->
¥o˚ss_¥ï¨ed_m≠pög
 =Örocess_prepared_mapping;

1827 
poﬁ
->
¥o˚ss_¥ï¨ed_disˇrd
 = 
¥o˚ss_¥ï¨ed_disˇrd_∑ssdown
;

1829 i‡(!
poﬁ
->
pf
.
îr‹_if_no_•a˚
 && 
no_•a˚_timeout
)

1830 
	`queue_dñayed_w‹k
(
poﬁ
->
wq
, &poﬁ->
no_•a˚_timeout
,Ço_space_timeout);

1833 
PM_WRITE
:

1834 i‡(
ﬁd_mode
 !
√w_mode
)

1835 
	`nŸify_of_poﬁ_mode_ch™ge
(
poﬁ
, "write");

1836 
	`dm_poﬁ_mëad©a_ªad_wrôe
(
poﬁ
->
pmd
);

1837 
poﬁ
->
¥o˚ss_bio
 =Örocess_bio;

1838 
poﬁ
->
¥o˚ss_disˇrd
 =Örocess_discard;

1839 
poﬁ
->
¥o˚ss_¥ï¨ed_m≠pög
 =Örocess_prepared_mapping;

1840 
poﬁ
->
¥o˚ss_¥ï¨ed_disˇrd
 =Örocess_prepared_discard;

1844 
poﬁ
->
pf
.
mode
 = 
√w_mode
;

1849 
±
->
adju°ed_pf
.
mode
 = 
√w_mode
;

1850 
	}
}

1852 
	$ab‹t_å™ß˘i⁄
(
poﬁ
 *pool)

1854 c⁄° *
dev_«me
 = 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
);

1856 
	`DMERR_LIMIT
("%s:áb‹tög cuºíàmëad©®å™ß˘i⁄", 
dev_«me
);

1857 i‡(
	`dm_poﬁ_ab‹t_mëad©a
(
poﬁ
->
pmd
)) {

1858 
	`DMERR
("%s: faûedÅÿab‹àmëad©®å™ß˘i⁄", 
dev_«me
);

1859 
	`£t_poﬁ_mode
(
poﬁ
, 
PM_FAIL
);

1862 i‡(
	`dm_poﬁ_mëad©a_£t_√eds_check
(
poﬁ
->
pmd
)) {

1863 
	`DMERR
("%s: faûedÅÿ£à'√eds_check' fœg i¿mëad©a", 
dev_«me
);

1864 
	`£t_poﬁ_mode
(
poﬁ
, 
PM_FAIL
);

1866 
	}
}

1868 
	$mëad©a_›î©i⁄_Áûed
(
poﬁ
 *poﬁ, c⁄° *
›
, 
r
)

1870 
	`DMERR_LIMIT
("%s: metadata operation '%s' failed:Érror = %d",

1871 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
›
, 
r
);

1873 
	`ab‹t_å™ß˘i⁄
(
poﬁ
);

1874 
	`£t_poﬁ_mode
(
poﬁ
, 
PM_READ_ONLY
);

1875 
	}
}

1886 
	$thö_de„r_bio
(
thö_c
 *
tc
, 
bio
 *bio)

1888 
Êags
;

1889 
poﬁ
 *poﬁ = 
tc
->pool;

1891 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

1892 
	`bio_li°_add
(&
tc
->
de„ºed_bio_li°
, 
bio
);

1893 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

1895 
	`wake_w‹kî
(
poﬁ
);

1896 
	}
}

1898 
	$thö_hook_bio
(
thö_c
 *
tc
, 
bio
 *bio)

1900 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

1902 
h
->
tc
 =Åc;

1903 
h
->
sh¨ed_ªad_íåy
 = 
NULL
;

1904 
h
->
Æl_io_íåy
 = 
NULL
;

1905 
h
->
ovîwrôe_m≠pög
 = 
NULL
;

1906 
	}
}

1911 
	$thö_bio_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

1913 
r
;

1914 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

1915 
dm_block_t
 
block
 = 
	`gë_bio_block
(
tc
, 
bio
);

1916 
dm_thö_devi˚
 *
td
 = 
tc
->td;

1917 
dm_thö_lookup_ªsu…
 
ªsu…
;

1918 
dm_bio_¥is⁄_˚Œ
 
˚Œ1
, 
˚Œ2
;

1919 
dm_bio_¥is⁄_˚Œ
 *
˚Œ_ªsu…
;

1920 
dm_˚Œ_key
 
key
;

1922 
	`thö_hook_bio
(
tc
, 
bio
);

1924 i‡(
tc
->
ªqueue_mode
) {

1925 
	`bio_ídio
(
bio
, 
DM_ENDIO_REQUEUE
);

1926  
DM_MAPIO_SUBMITTED
;

1929 i‡(
	`gë_poﬁ_mode
(
tc
->
poﬁ
Ë=
PM_FAIL
) {

1930 
	`bio_io_îr‹
(
bio
);

1931  
DM_MAPIO_SUBMITTED
;

1934 i‡(
bio
->
bi_rw
 & (
REQ_DISCARD
 | 
REQ_FLUSH
 | 
REQ_FUA
)) {

1935 
	`thö_de„r_bio
(
tc
, 
bio
);

1936  
DM_MAPIO_SUBMITTED
;

1939 
r
 = 
	`dm_thö_föd_block
(
td
, 
block
, 0, &
ªsu…
);

1944 
r
) {

1946 i‡(
	`u∆ikñy
(
ªsu…
.
sh¨ed
)) {

1961 
	`thö_de„r_bio
(
tc
, 
bio
);

1962  
DM_MAPIO_SUBMITTED
;

1965 
	`buûd_vútuÆ_key
(
tc
->
td
, 
block
, &
key
);

1966 i‡(
	`dm_bio_dëaö
(
tc
->
poﬁ
->
¥is⁄
, &
key
, 
bio
, &
˚Œ1
, &
˚Œ_ªsu…
))

1967  
DM_MAPIO_SUBMITTED
;

1969 
	`buûd_d©a_key
(
tc
->
td
, 
ªsu…
.
block
, &
key
);

1970 i‡(
	`dm_bio_dëaö
(
tc
->
poﬁ
->
¥is⁄
, &
key
, 
bio
, &
˚Œ2
, &
˚Œ_ªsu…
)) {

1971 
	`˚Œ_de„r_no_hﬁdî_no_‰ì
(
tc
, &
˚Œ1
);

1972  
DM_MAPIO_SUBMITTED
;

1975 
	`öc_Æl_io_íåy
(
tc
->
poﬁ
, 
bio
);

1976 
	`˚Œ_de„r_no_hﬁdî_no_‰ì
(
tc
, &
˚Œ2
);

1977 
	`˚Œ_de„r_no_hﬁdî_no_‰ì
(
tc
, &
˚Œ1
);

1979 
	`ªm≠
(
tc
, 
bio
, 
ªsu…
.
block
);

1980  
DM_MAPIO_REMAPPED
;

1982 -
ENODATA
:

1983 i‡(
	`gë_poﬁ_mode
(
tc
->
poﬁ
Ë=
PM_READ_ONLY
) {

1988 
	`h™dÀ_un£rvi˚abÀ_bio
(
tc
->
poﬁ
, 
bio
);

1989  
DM_MAPIO_SUBMITTED
;

1993 -
EWOULDBLOCK
:

1998 
	`thö_de„r_bio
(
tc
, 
bio
);

1999  
DM_MAPIO_SUBMITTED
;

2007 
	`bio_io_îr‹
(
bio
);

2008  
DM_MAPIO_SUBMITTED
;

2010 
	}
}

2012 
	$poﬁ_is_c⁄ge°ed
(
dm_èrgë_ˇŒbacks
 *
cb
, 
bdi_bôs
)

2014 
poﬁ_c
 *
±
 = 
	`c⁄èöî_of
(
cb
, poﬁ_c, 
ˇŒbacks
);

2015 
ªque°_queue
 *
q
;

2017 i‡(
	`gë_poﬁ_mode
(
±
->
poﬁ
Ë=
PM_OUT_OF_DATA_SPACE
)

2020 
q
 = 
	`bdev_gë_queue
(
±
->
d©a_dev
->
bdev
);

2021  
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bdi_bôs
);

2022 
	}
}

2024 
	$ªqueue_bios
(
poﬁ
 *pool)

2026 
Êags
;

2027 
thö_c
 *
tc
;

2029 
	`rcu_ªad_lock
();

2030 
	`li°_f‹_óch_íåy_rcu
(
tc
, &
poﬁ
->
a˘ive_thös
, 
li°
) {

2031 
	`•ö_lock_úqßve
(&
tc
->
lock
, 
Êags
);

2032 
	`bio_li°_mîge
(&
tc
->
de„ºed_bio_li°
, &tc->
ªåy_⁄_ªsume_li°
);

2033 
	`bio_li°_öô
(&
tc
->
ªåy_⁄_ªsume_li°
);

2034 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
lock
, 
Êags
);

2036 
	`rcu_ªad_u∆ock
();

2037 
	}
}

2042 
boﬁ
 
	$d©a_dev_suµ‹ts_disˇrd
(
poﬁ_c
 *
±
)

2044 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
±
->
d©a_dev
->
bdev
);

2046  
q
 && 
	`blk_queue_disˇrd
(q);

2047 
	}
}

2049 
boﬁ
 
	$is_Á˘‹
(
£˘‹_t
 
block_size
, 
uöt32_t
 
n
)

2051  !
	`£˘‹_div
(
block_size
, 
n
);

2052 
	}
}

2058 
	$dißbÀ_∑ssdown_if_nŸ_suµ‹ãd
(
poﬁ_c
 *
±
)

2060 
poﬁ
 *poﬁ = 
±
->pool;

2061 
block_devi˚
 *
d©a_bdev
 = 
±
->
d©a_dev
->
bdev
;

2062 
queue_limôs
 *
d©a_limôs
 = &
	`bdev_gë_queue
(
d©a_bdev
)->
limôs
;

2063 
£˘‹_t
 
block_size
 = 
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
;

2064 c⁄° *
ªas⁄
 = 
NULL
;

2065 
buf
[
BDEVNAME_SIZE
];

2067 i‡(!
±
->
adju°ed_pf
.
disˇrd_∑ssdown
)

2070 i‡(!
	`d©a_dev_suµ‹ts_disˇrd
(
±
))

2071 
ªas⁄
 = "discard unsupported";

2073 i‡(
d©a_limôs
->
max_disˇrd_£˘‹s
 < 
poﬁ
->
£˘‹s_≥r_block
)

2074 
ªas⁄
 = "max discard sectors smallerÅhaná block";

2076 i‡(
d©a_limôs
->
disˇrd_gønuœrôy
 > 
block_size
)

2077 
ªas⁄
 = "discard granularityÜargerÅhaná block";

2079 i‡(!
	`is_Á˘‹
(
block_size
, 
d©a_limôs
->
disˇrd_gønuœrôy
))

2080 
ªas⁄
 = "discard granularityÇotá factor of block size";

2082 i‡(
ªas⁄
) {

2083 
	`DMWARN
("D©®devi˚ (%sË%s: Dißblög disˇrdÖassdown.", 
	`bdev«me
(
d©a_bdev
, 
buf
), 
ªas⁄
);

2084 
±
->
adju°ed_pf
.
disˇrd_∑ssdown
 = 
Ál£
;

2086 
	}
}

2088 
	$böd_c⁄åﬁ_èrgë
(
poﬁ
 *poﬁ, 
dm_èrgë
 *
ti
)

2090 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2095 
poﬁ_mode
 
ﬁd_mode
 = 
	`gë_poﬁ_mode
(
poﬁ
);

2096 
poﬁ_mode
 
√w_mode
 = 
±
->
adju°ed_pf
.
mode
;

2103 
±
->
adju°ed_pf
.
mode
 = 
ﬁd_mode
;

2105 
poﬁ
->
ti
 =Åi;

2106 
poﬁ
->
pf
 = 
±
->
adju°ed_pf
;

2107 
poﬁ
->
low_w©î_blocks
 = 
±
->low_water_blocks;

2109 
	`£t_poﬁ_mode
(
poﬁ
, 
√w_mode
);

2112 
	}
}

2114 
	$unböd_c⁄åﬁ_èrgë
(
poﬁ
 *poﬁ, 
dm_èrgë
 *
ti
)

2116 i‡(
poﬁ
->
ti
 ==Åi)

2117 
poﬁ
->
ti
 = 
NULL
;

2118 
	}
}

2124 
	$poﬁ_„©uªs_öô
(
poﬁ_„©uªs
 *
pf
)

2126 
pf
->
mode
 = 
PM_WRITE
;

2127 
pf
->
zîo_√w_blocks
 = 
åue
;

2128 
pf
->
disˇrd_íabÀd
 = 
åue
;

2129 
pf
->
disˇrd_∑ssdown
 = 
åue
;

2130 
pf
->
îr‹_if_no_•a˚
 = 
Ál£
;

2131 
	}
}

2133 
	$__poﬁ_de°roy
(
poﬁ
 *pool)

2135 
	`__poﬁ_èbÀ_ªmove
(
poﬁ
);

2137 i‡(
	`dm_poﬁ_mëad©a_˛o£
(
poﬁ
->
pmd
) < 0)

2138 
	`DMWARN
("%s: dm_poﬁ_mëad©a_˛o£(ËÁûed.", 
__func__
);

2140 
	`dm_bio_¥is⁄_de°roy
(
poﬁ
->
¥is⁄
);

2141 
	`dm_kc›yd_˛õ¡_de°roy
(
poﬁ
->
c›õr
);

2143 i‡(
poﬁ
->
wq
)

2144 
	`de°roy_w‹kqueue
(
poﬁ
->
wq
);

2146 i‡(
poﬁ
->
√xt_m≠pög
)

2147 
	`mempoﬁ_‰ì
(
poﬁ
->
√xt_m≠pög
,Öoﬁ->
m≠pög_poﬁ
);

2148 
	`mempoﬁ_de°roy
(
poﬁ
->
m≠pög_poﬁ
);

2149 
	`dm_de„ºed_£t_de°roy
(
poﬁ
->
sh¨ed_ªad_ds
);

2150 
	`dm_de„ºed_£t_de°roy
(
poﬁ
->
Æl_io_ds
);

2151 
	`k‰ì
(
poﬁ
);

2152 
	}
}

2154 
kmem_ˇche
 *
	g_√w_m≠pög_ˇche
;

2156 
poﬁ
 *
	$poﬁ_¸óã
(
m≠≥d_devi˚
 *
poﬁ_md
,

2157 
block_devi˚
 *
mëad©a_dev
,

2158 
block_size
,

2159 
ªad_⁄ly
, **
îr‹
)

2161 
r
;

2162 *
îr_p
;

2163 
poﬁ
 *pool;

2164 
dm_poﬁ_mëad©a
 *
pmd
;

2165 
boﬁ
 
f‹m©_devi˚
 = 
ªad_⁄ly
 ? 
Ál£
 : 
åue
;

2167 
pmd
 = 
	`dm_poﬁ_mëad©a_›í
(
mëad©a_dev
, 
block_size
, 
f‹m©_devi˚
);

2168 i‡(
	`IS_ERR
(
pmd
)) {

2169 *
îr‹
 = "Error creating metadata object";

2170  (
poﬁ
 *)
pmd
;

2173 
poﬁ
 = 
	`kmÆloc
((*poﬁ), 
GFP_KERNEL
);

2174 i‡(!
poﬁ
) {

2175 *
îr‹
 = "Errorállocating memory forÖool";

2176 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2177 
bad_poﬁ
;

2180 
poﬁ
->
pmd
 =Ömd;

2181 
poﬁ
->
£˘‹s_≥r_block
 = 
block_size
;

2182 i‡(
block_size
 & (block_size - 1))

2183 
poﬁ
->
£˘‹s_≥r_block_shi·
 = -1;

2185 
poﬁ
->
£˘‹s_≥r_block_shi·
 = 
	`__ffs
(
block_size
);

2186 
poﬁ
->
low_w©î_blocks
 = 0;

2187 
	`poﬁ_„©uªs_öô
(&
poﬁ
->
pf
);

2188 
poﬁ
->
¥is⁄
 = 
	`dm_bio_¥is⁄_¸óã
(
PRISON_CELLS
);

2189 i‡(!
poﬁ
->
¥is⁄
) {

2190 *
îr‹
 = "Error creatingÖool's bioÖrison";

2191 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2192 
bad_¥is⁄
;

2195 
poﬁ
->
c›õr
 = 
	`dm_kc›yd_˛õ¡_¸óã
(&
dm_kc›yd_thrŸée
);

2196 i‡(
	`IS_ERR
(
poﬁ
->
c›õr
)) {

2197 
r
 = 
	`PTR_ERR
(
poﬁ
->
c›õr
);

2198 *
îr‹
 = "Error creatingÖool's kcopyd client";

2199 
îr_p
 = 
	`ERR_PTR
(
r
);

2200 
bad_kc›yd_˛õ¡
;

2207 
poﬁ
->
wq
 = 
	`Æloc_‹dîed_w‹kqueue
("dm-" 
DM_MSG_PREFIX
, 
WQ_MEM_RECLAIM
);

2208 i‡(!
poﬁ
->
wq
) {

2209 *
îr‹
 = "Error creatingÖool's workqueue";

2210 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2211 
bad_wq
;

2214 
	`INIT_WORK
(&
poﬁ
->
w‹kî
, 
do_w‹kî
);

2215 
	`INIT_DELAYED_WORK
(&
poﬁ
->
wakî
, 
do_wakî
);

2216 
	`INIT_DELAYED_WORK
(&
poﬁ
->
no_•a˚_timeout
, 
do_no_•a˚_timeout
);

2217 
	`•ö_lock_öô
(&
poﬁ
->
lock
);

2218 
	`bio_li°_öô
(&
poﬁ
->
de„ºed_Êush_bios
);

2219 
	`INIT_LIST_HEAD
(&
poﬁ
->
¥ï¨ed_m≠pögs
);

2220 
	`INIT_LIST_HEAD
(&
poﬁ
->
¥ï¨ed_disˇrds
);

2221 
	`INIT_LIST_HEAD
(&
poﬁ
->
a˘ive_thös
);

2222 
poﬁ
->
low_w©î_åiggîed
 = 
Ál£
;

2224 
poﬁ
->
sh¨ed_ªad_ds
 = 
	`dm_de„ºed_£t_¸óã
();

2225 i‡(!
poﬁ
->
sh¨ed_ªad_ds
) {

2226 *
îr‹
 = "Error creatingÖool's sharedÑead deferred set";

2227 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2228 
bad_sh¨ed_ªad_ds
;

2231 
poﬁ
->
Æl_io_ds
 = 
	`dm_de„ºed_£t_¸óã
();

2232 i‡(!
poﬁ
->
Æl_io_ds
) {

2233 *
îr‹
 = "Error creatingÖool'sáll io deferred set";

2234 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2235 
bad_Æl_io_ds
;

2238 
poﬁ
->
√xt_m≠pög
 = 
NULL
;

2239 
poﬁ
->
m≠pög_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
MAPPING_POOL_SIZE
,

2240 
_√w_m≠pög_ˇche
);

2241 i‡(!
poﬁ
->
m≠pög_poﬁ
) {

2242 *
îr‹
 = "Error creatingÖool's mapping mempool";

2243 
îr_p
 = 
	`ERR_PTR
(-
ENOMEM
);

2244 
bad_m≠pög_poﬁ
;

2247 
poﬁ
->
ªf_cou¡
 = 1;

2248 
poﬁ
->
œ°_commô_jiffõs
 = 
jiffõs
;

2249 
poﬁ
->
poﬁ_md
 =Öool_md;

2250 
poﬁ
->
md_dev
 = 
mëad©a_dev
;

2251 
	`__poﬁ_èbÀ_ö£π
(
poﬁ
);

2253  
poﬁ
;

2255 
bad_m≠pög_poﬁ
:

2256 
	`dm_de„ºed_£t_de°roy
(
poﬁ
->
Æl_io_ds
);

2257 
bad_Æl_io_ds
:

2258 
	`dm_de„ºed_£t_de°roy
(
poﬁ
->
sh¨ed_ªad_ds
);

2259 
bad_sh¨ed_ªad_ds
:

2260 
	`de°roy_w‹kqueue
(
poﬁ
->
wq
);

2261 
bad_wq
:

2262 
	`dm_kc›yd_˛õ¡_de°roy
(
poﬁ
->
c›õr
);

2263 
bad_kc›yd_˛õ¡
:

2264 
	`dm_bio_¥is⁄_de°roy
(
poﬁ
->
¥is⁄
);

2265 
bad_¥is⁄
:

2266 
	`k‰ì
(
poﬁ
);

2267 
bad_poﬁ
:

2268 i‡(
	`dm_poﬁ_mëad©a_˛o£
(
pmd
))

2269 
	`DMWARN
("%s: dm_poﬁ_mëad©a_˛o£(ËÁûed.", 
__func__
);

2271  
îr_p
;

2272 
	}
}

2274 
	$__poﬁ_öc
(
poﬁ
 *pool)

2276 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

2277 
poﬁ
->
ªf_cou¡
++;

2278 
	}
}

2280 
	$__poﬁ_dec
(
poﬁ
 *pool)

2282 
	`BUG_ON
(!
	`muãx_is_locked
(&
dm_thö_poﬁ_èbÀ
.
muãx
));

2283 
	`BUG_ON
(!
poﬁ
->
ªf_cou¡
);

2284 i‡(!--
poﬁ
->
ªf_cou¡
)

2285 
	`__poﬁ_de°roy
(
poﬁ
);

2286 
	}
}

2288 
poﬁ
 *
	$__poﬁ_föd
(
m≠≥d_devi˚
 *
poﬁ_md
,

2289 
block_devi˚
 *
mëad©a_dev
,

2290 
block_size
, 
ªad_⁄ly
,

2291 **
îr‹
, *
¸óãd
)

2293 
poﬁ
 *poﬁ = 
	`__poﬁ_èbÀ_lookup_mëad©a_dev
(
mëad©a_dev
);

2295 i‡(
poﬁ
) {

2296 i‡(
poﬁ
->
poﬁ_md
 !=Öool_md) {

2297 *
îr‹
 = "metadata deviceálready in use byáÖool";

2298  
	`ERR_PTR
(-
EBUSY
);

2300 
	`__poﬁ_öc
(
poﬁ
);

2303 
poﬁ
 = 
	`__poﬁ_èbÀ_lookup
(
poﬁ_md
);

2304 i‡(
poﬁ
) {

2305 i‡(
poﬁ
->
md_dev
 !
mëad©a_dev
) {

2306 *
îr‹
 = "differentÖool cannotÑeplaceáÖool";

2307  
	`ERR_PTR
(-
EINVAL
);

2309 
	`__poﬁ_öc
(
poﬁ
);

2312 
poﬁ
 = 
	`poﬁ_¸óã
(
poﬁ_md
, 
mëad©a_dev
, 
block_size
, 
ªad_⁄ly
, 
îr‹
);

2313 *
¸óãd
 = 1;

2317  
poﬁ
;

2318 
	}
}

2323 
	$poﬁ_då
(
dm_èrgë
 *
ti
)

2325 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2327 
	`muãx_lock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

2329 
	`unböd_c⁄åﬁ_èrgë
(
±
->
poﬁ
, 
ti
);

2330 
	`__poﬁ_dec
(
±
->
poﬁ
);

2331 
	`dm_put_devi˚
(
ti
, 
±
->
mëad©a_dev
);

2332 
	`dm_put_devi˚
(
ti
, 
±
->
d©a_dev
);

2333 
	`k‰ì
(
±
);

2335 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

2336 
	}
}

2338 
	$∑r£_poﬁ_„©uªs
(
dm_¨g_£t
 *
as
, 
poﬁ_„©uªs
 *
pf
,

2339 
dm_èrgë
 *
ti
)

2341 
r
;

2342 
¨gc
;

2343 c⁄° *
¨g_«me
;

2345 
dm_¨g
 
_¨gs
[] = {

2352 i‡(!
as
->
¨gc
)

2355 
r
 = 
	`dm_ªad_¨g_group
(
_¨gs
, 
as
, &
¨gc
, &
ti
->
îr‹
);

2356 i‡(
r
)

2357  -
EINVAL
;

2359 
¨gc
 && !
r
) {

2360 
¨g_«me
 = 
	`dm_shi·_¨g
(
as
);

2361 
¨gc
--;

2363 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "skip_block_zeroing"))

2364 
pf
->
zîo_√w_blocks
 = 
Ál£
;

2366 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "ignore_discard"))

2367 
pf
->
disˇrd_íabÀd
 = 
Ál£
;

2369 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "no_discard_passdown"))

2370 
pf
->
disˇrd_∑ssdown
 = 
Ál£
;

2372 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "read_only"))

2373 
pf
->
mode
 = 
PM_READ_ONLY
;

2375 i‡(!
	`°rˇ£cmp
(
¨g_«me
, "error_if_no_space"))

2376 
pf
->
îr‹_if_no_•a˚
 = 
åue
;

2379 
ti
->
îr‹
 = "UnrecognisedÖool featureÑequested";

2380 
r
 = -
EINVAL
;

2385  
r
;

2386 
	}
}

2388 
	$mëad©a_low_ˇŒback
(*
c⁄ãxt
)

2390 
poﬁ
 *poﬁ = 
c⁄ãxt
;

2392 
	`DMWARN
("%s:ÑeachedÜow water mark for metadata device: sendingÉvent.",

2393 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

2395 
	`dm_èbÀ_evít
(
poﬁ
->
ti
->
èbÀ
);

2396 
	}
}

2398 
£˘‹_t
 
	$gë_dev_size
(
block_devi˚
 *
bdev
)

2400  
	`i_size_ªad
(
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
;

2401 
	}
}

2403 
	$w¨n_if_mëad©a_devi˚_too_big
(
block_devi˚
 *
bdev
)

2405 
£˘‹_t
 
mëad©a_dev_size
 = 
	`gë_dev_size
(
bdev
);

2406 
buf„r
[
BDEVNAME_SIZE
];

2408 i‡(
mëad©a_dev_size
 > 
THIN_METADATA_MAX_SECTORS_WARNING
)

2409 
	`DMWARN
("Metadata device %s isÜargerÅhan %u sectors:Éxcess space willÇot be used.",

2410 
	`bdev«me
(
bdev
, 
buf„r
), 
THIN_METADATA_MAX_SECTORS
);

2411 
	}
}

2413 
£˘‹_t
 
	$gë_mëad©a_dev_size
(
block_devi˚
 *
bdev
)

2415 
£˘‹_t
 
mëad©a_dev_size
 = 
	`gë_dev_size
(
bdev
);

2417 i‡(
mëad©a_dev_size
 > 
THIN_METADATA_MAX_SECTORS
)

2418 
mëad©a_dev_size
 = 
THIN_METADATA_MAX_SECTORS
;

2420  
mëad©a_dev_size
;

2421 
	}
}

2423 
dm_block_t
 
	$gë_mëad©a_dev_size_ö_blocks
(
block_devi˚
 *
bdev
)

2425 
£˘‹_t
 
mëad©a_dev_size
 = 
	`gë_mëad©a_dev_size
(
bdev
);

2427 
	`£˘‹_div
(
mëad©a_dev_size
, 
THIN_METADATA_BLOCK_SIZE
);

2429  
mëad©a_dev_size
;

2430 
	}
}

2438 
dm_block_t
 
	$ˇlc_mëad©a_thªshﬁd
(
poﬁ_c
 *
±
)

2445 
dm_block_t
 
qu¨ãr
 = 
	`gë_mëad©a_dev_size_ö_blocks
(
±
->
mëad©a_dev
->
bdev
) / 4;

2446  
	`mö
((
dm_block_t
)1024ULL , 
qu¨ãr
);

2447 
	}
}

2462 
	$poﬁ_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

2464 
r
, 
poﬁ_¸óãd
 = 0;

2465 
poﬁ_c
 *
±
;

2466 
poﬁ
 *pool;

2467 
poﬁ_„©uªs
 
pf
;

2468 
dm_¨g_£t
 
as
;

2469 
dm_dev
 *
d©a_dev
;

2470 
block_size
;

2471 
dm_block_t
 
low_w©î_blocks
;

2472 
dm_dev
 *
mëad©a_dev
;

2473 
fmode_t
 
mëad©a_mode
;

2478 
	`muãx_lock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

2480 i‡(
¨gc
 < 4) {

2481 
ti
->
îr‹
 = "Invalidárgument count";

2482 
r
 = -
EINVAL
;

2483 
out_u∆ock
;

2486 
as
.
¨gc
 =árgc;

2487 
as
.
¨gv
 =árgv;

2492 
	`poﬁ_„©uªs_öô
(&
pf
);

2494 
	`dm_c⁄sume_¨gs
(&
as
, 4);

2495 
r
 = 
	`∑r£_poﬁ_„©uªs
(&
as
, &
pf
, 
ti
);

2496 i‡(
r
)

2497 
out_u∆ock
;

2499 
mëad©a_mode
 = 
FMODE_READ
 | ((
pf
.
mode
 =
PM_READ_ONLY
Ë? 0 : 
FMODE_WRITE
);

2500 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
mëad©a_mode
, &
mëad©a_dev
);

2501 i‡(
r
) {

2502 
ti
->
îr‹
 = "Error opening metadata block device";

2503 
out_u∆ock
;

2505 
	`w¨n_if_mëad©a_devi˚_too_big
(
mëad©a_dev
->
bdev
);

2507 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[1], 
FMODE_READ
 | 
FMODE_WRITE
, &
d©a_dev
);

2508 i‡(
r
) {

2509 
ti
->
îr‹
 = "Error getting data device";

2510 
out_mëad©a
;

2513 i‡(
	`k°πoul
(
¨gv
[2], 10, &
block_size
) || !block_size ||

2514 
block_size
 < 
DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 ||

2515 
block_size
 > 
DATA_DEV_BLOCK_SIZE_MAX_SECTORS
 ||

2516 
block_size
 & (
DATA_DEV_BLOCK_SIZE_MIN_SECTORS
 - 1)) {

2517 
ti
->
îr‹
 = "Invalid block size";

2518 
r
 = -
EINVAL
;

2519 
out
;

2522 i‡(
	`k°πouŒ
(
¨gv
[3], 10, (*)&
low_w©î_blocks
)) {

2523 
ti
->
îr‹
 = "InvalidÜow water mark";

2524 
r
 = -
EINVAL
;

2525 
out
;

2528 
±
 = 
	`kzÆloc
((*±), 
GFP_KERNEL
);

2529 i‡(!
±
) {

2530 
r
 = -
ENOMEM
;

2531 
out
;

2534 
poﬁ
 = 
	`__poﬁ_föd
(
	`dm_èbÀ_gë_md
(
ti
->
èbÀ
), 
mëad©a_dev
->
bdev
,

2535 
block_size
, 
pf
.
mode
 =
PM_READ_ONLY
, &
ti
->
îr‹
, &
poﬁ_¸óãd
);

2536 i‡(
	`IS_ERR
(
poﬁ
)) {

2537 
r
 = 
	`PTR_ERR
(
poﬁ
);

2538 
out_‰ì_±
;

2547 i‡(!
poﬁ_¸óãd
 && 
pf
.
disˇrd_íabÀd
 !
poﬁ
->pf.discard_enabled) {

2548 
ti
->
îr‹
 = "Discard support cannot be disabled onceÉnabled";

2549 
r
 = -
EINVAL
;

2550 
out_Êags_ch™ged
;

2553 
±
->
poﬁ
 =Öool;

2554 
±
->
ti
 =Åi;

2555 
±
->
mëad©a_dev
 = metadata_dev;

2556 
±
->
d©a_dev
 = data_dev;

2557 
±
->
low_w©î_blocks
 =Üow_water_blocks;

2558 
±
->
adju°ed_pf
 =Öt->
ªque°ed_pf
 = 
pf
;

2559 
ti
->
num_Êush_bios
 = 1;

2566 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

2567 i‡(
pf
.
disˇrd_íabÀd
 &&Öf.
disˇrd_∑ssdown
) {

2568 
ti
->
num_disˇrd_bios
 = 1;

2575 
ti
->
disˇrds_suµ‹ãd
 = 
åue
;

2577 
ti
->
¥iv©e
 = 
±
;

2579 
r
 = 
	`dm_poﬁ_ªgi°î_mëad©a_thªshﬁd
(
±
->
poﬁ
->
pmd
,

2580 
	`ˇlc_mëad©a_thªshﬁd
(
±
),

2581 
mëad©a_low_ˇŒback
,

2582 
poﬁ
);

2583 i‡(
r
)

2584 
out_‰ì_±
;

2586 
±
->
ˇŒbacks
.
c⁄ge°ed_‚
 = 
poﬁ_is_c⁄ge°ed
;

2587 
	`dm_èbÀ_add_èrgë_ˇŒbacks
(
ti
->
èbÀ
, &
±
->
ˇŒbacks
);

2589 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

2593 
out_Êags_ch™ged
:

2594 
	`__poﬁ_dec
(
poﬁ
);

2595 
out_‰ì_±
:

2596 
	`k‰ì
(
±
);

2597 
out
:

2598 
	`dm_put_devi˚
(
ti
, 
d©a_dev
);

2599 
out_mëad©a
:

2600 
	`dm_put_devi˚
(
ti
, 
mëad©a_dev
);

2601 
out_u∆ock
:

2602 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

2604  
r
;

2605 
	}
}

2607 
	$poﬁ_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

2609 
r
;

2610 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2611 
poﬁ
 *poﬁ = 
±
->pool;

2612 
Êags
;

2617 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

2618 
bio
->
bi_bdev
 = 
±
->
d©a_dev
->
bdev
;

2619 
r
 = 
DM_MAPIO_REMAPPED
;

2620 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

2622  
r
;

2623 
	}
}

2625 
	$maybe_ªsize_d©a_dev
(
dm_èrgë
 *
ti
, 
boﬁ
 *
√ed_commô
)

2627 
r
;

2628 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2629 
poﬁ
 *poﬁ = 
±
->pool;

2630 
£˘‹_t
 
d©a_size
 = 
ti
->
Àn
;

2631 
dm_block_t
 
sb_d©a_size
;

2633 *
√ed_commô
 = 
Ál£
;

2635 (Ë
	`£˘‹_div
(
d©a_size
, 
poﬁ
->
£˘‹s_≥r_block
);

2637 
r
 = 
	`dm_poﬁ_gë_d©a_dev_size
(
poﬁ
->
pmd
, &
sb_d©a_size
);

2638 i‡(
r
) {

2639 
	`DMERR
("%s: failedÅoÑetrieve data device size",

2640 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

2641  
r
;

2644 i‡(
d©a_size
 < 
sb_d©a_size
) {

2645 
	`DMERR
("%s:ÖoolÅarget (%llu blocks)Åoo small:Éxpected %llu",

2646 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
),

2647 ()
d©a_size
, 
sb_d©a_size
);

2648  -
EINVAL
;

2650 } i‡(
d©a_size
 > 
sb_d©a_size
) {

2651 i‡(
	`dm_poﬁ_mëad©a_√eds_check
(
poﬁ
->
pmd
)) {

2652 
	`DMERR
("%s: unableÅo growÅhe data device untilÑepaired.",

2653 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

2657 i‡(
sb_d©a_size
)

2658 
	`DMINFO
("%s: growingÅhe data device from %lluÅo %llu blocks",

2659 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
),

2660 
sb_d©a_size
, ()
d©a_size
);

2661 
r
 = 
	`dm_poﬁ_ªsize_d©a_dev
(
poﬁ
->
pmd
, 
d©a_size
);

2662 i‡(
r
) {

2663 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_ªsize_d©a_dev", 
r
);

2664  
r
;

2667 *
√ed_commô
 = 
åue
;

2671 
	}
}

2673 
	$maybe_ªsize_mëad©a_dev
(
dm_èrgë
 *
ti
, 
boﬁ
 *
√ed_commô
)

2675 
r
;

2676 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2677 
poﬁ
 *poﬁ = 
±
->pool;

2678 
dm_block_t
 
mëad©a_dev_size
, 
sb_mëad©a_dev_size
;

2680 *
√ed_commô
 = 
Ál£
;

2682 
mëad©a_dev_size
 = 
	`gë_mëad©a_dev_size_ö_blocks
(
poﬁ
->
md_dev
);

2684 
r
 = 
	`dm_poﬁ_gë_mëad©a_dev_size
(
poﬁ
->
pmd
, &
sb_mëad©a_dev_size
);

2685 i‡(
r
) {

2686 
	`DMERR
("%s: failedÅoÑetrieve metadata device size",

2687 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

2688  
r
;

2691 i‡(
mëad©a_dev_size
 < 
sb_mëad©a_dev_size
) {

2692 
	`DMERR
("%s: metadata device (%llu blocks)Åoo small:Éxpected %llu",

2693 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
),

2694 
mëad©a_dev_size
, 
sb_mëad©a_dev_size
);

2695  -
EINVAL
;

2697 } i‡(
mëad©a_dev_size
 > 
sb_mëad©a_dev_size
) {

2698 i‡(
	`dm_poﬁ_mëad©a_√eds_check
(
poﬁ
->
pmd
)) {

2699 
	`DMERR
("%s: unableÅo growÅhe metadata device untilÑepaired.",

2700 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
));

2704 
	`w¨n_if_mëad©a_devi˚_too_big
(
poﬁ
->
md_dev
);

2705 
	`DMINFO
("%s: growingÅhe metadata device from %lluÅo %llu blocks",

2706 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
),

2707 
sb_mëad©a_dev_size
, 
mëad©a_dev_size
);

2708 
r
 = 
	`dm_poﬁ_ªsize_mëad©a_dev
(
poﬁ
->
pmd
, 
mëad©a_dev_size
);

2709 i‡(
r
) {

2710 
	`mëad©a_›î©i⁄_Áûed
(
poﬁ
, "dm_poﬁ_ªsize_mëad©a_dev", 
r
);

2711  
r
;

2714 *
√ed_commô
 = 
åue
;

2718 
	}
}

2731 
	$poﬁ_¥îesume
(
dm_èrgë
 *
ti
)

2733 
r
;

2734 
boﬁ
 
√ed_commô1
, 
√ed_commô2
;

2735 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2736 
poﬁ
 *poﬁ = 
±
->pool;

2741 
r
 = 
	`böd_c⁄åﬁ_èrgë
(
poﬁ
, 
ti
);

2742 i‡(
r
)

2743  
r
;

2745 
r
 = 
	`maybe_ªsize_d©a_dev
(
ti
, &
√ed_commô1
);

2746 i‡(
r
)

2747  
r
;

2749 
r
 = 
	`maybe_ªsize_mëad©a_dev
(
ti
, &
√ed_commô2
);

2750 i‡(
r
)

2751  
r
;

2753 i‡(
√ed_commô1
 || 
√ed_commô2
)

2754 (Ë
	`commô
(
poﬁ
);

2757 
	}
}

2759 
	$poﬁ_ªsume
(
dm_èrgë
 *
ti
)

2761 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2762 
poﬁ
 *poﬁ = 
±
->pool;

2763 
Êags
;

2765 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

2766 
poﬁ
->
low_w©î_åiggîed
 = 
Ál£
;

2767 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

2768 
	`ªqueue_bios
(
poﬁ
);

2770 
	`do_wakî
(&
poﬁ
->
wakî
.
w‹k
);

2771 
	}
}

2773 
	$poﬁ_po°su•íd
(
dm_èrgë
 *
ti
)

2775 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2776 
poﬁ
 *poﬁ = 
±
->pool;

2778 
	`ˇn˚l_dñayed_w‹k
(&
poﬁ
->
wakî
);

2779 
	`ˇn˚l_dñayed_w‹k
(&
poﬁ
->
no_•a˚_timeout
);

2780 
	`Êush_w‹kqueue
(
poﬁ
->
wq
);

2781 (Ë
	`commô
(
poﬁ
);

2782 
	}
}

2784 
	$check_¨g_cou¡
(
¨gc
, 
¨gs_ªquúed
)

2786 i‡(
¨gc
 !
¨gs_ªquúed
) {

2787 
	`DMWARN
("MessageÑeceived with %uárguments instead of %u.",

2788 
¨gc
, 
¨gs_ªquúed
);

2789  -
EINVAL
;

2793 
	}
}

2795 
	$ªad_dev_id
(*
¨g
, 
dm_thö_id
 *
dev_id
, 
w¨nög
)

2797 i‡(!
	`k°πouŒ
(
¨g
, 10, (*)
dev_id
) &&

2798 *
dev_id
 <
MAX_DEV_ID
)

2801 i‡(
w¨nög
)

2802 
	`DMWARN
("Mesßgêª˚ived wôh invÆid devi˚ id: %s", 
¨g
);

2804  -
EINVAL
;

2805 
	}
}

2807 
	$¥o˚ss_¸óã_thö_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2809 
dm_thö_id
 
dev_id
;

2810 
r
;

2812 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 2);

2813 i‡(
r
)

2814  
r
;

2816 
r
 = 
	`ªad_dev_id
(
¨gv
[1], &
dev_id
, 1);

2817 i‡(
r
)

2818  
r
;

2820 
r
 = 
	`dm_poﬁ_¸óã_thö
(
poﬁ
->
pmd
, 
dev_id
);

2821 i‡(
r
) {

2822 
	`DMWARN
("Creation ofÇewÅhinly-provisioned device with id %s failed.",

2823 
¨gv
[1]);

2824  
r
;

2828 
	}
}

2830 
	$¥o˚ss_¸óã_¢≠_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2832 
dm_thö_id
 
dev_id
;

2833 
dm_thö_id
 
‹igö_dev_id
;

2834 
r
;

2836 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 3);

2837 i‡(
r
)

2838  
r
;

2840 
r
 = 
	`ªad_dev_id
(
¨gv
[1], &
dev_id
, 1);

2841 i‡(
r
)

2842  
r
;

2844 
r
 = 
	`ªad_dev_id
(
¨gv
[2], &
‹igö_dev_id
, 1);

2845 i‡(
r
)

2846  
r
;

2848 
r
 = 
	`dm_poﬁ_¸óã_¢≠
(
poﬁ
->
pmd
, 
dev_id
, 
‹igö_dev_id
);

2849 i‡(
r
) {

2850 
	`DMWARN
("Creation ofÇew snapshot %s of device %s failed.",

2851 
¨gv
[1],árgv[2]);

2852  
r
;

2856 
	}
}

2858 
	$¥o˚ss_dñëe_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2860 
dm_thö_id
 
dev_id
;

2861 
r
;

2863 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 2);

2864 i‡(
r
)

2865  
r
;

2867 
r
 = 
	`ªad_dev_id
(
¨gv
[1], &
dev_id
, 1);

2868 i‡(
r
)

2869  
r
;

2871 
r
 = 
	`dm_poﬁ_dñëe_thö_devi˚
(
poﬁ
->
pmd
, 
dev_id
);

2872 i‡(
r
)

2873 
	`DMWARN
("Dñëi⁄ o‡thö devi˚ %†Áûed.", 
¨gv
[1]);

2875  
r
;

2876 
	}
}

2878 
	$¥o˚ss_£t_å™ß˘i⁄_id_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2880 
dm_thö_id
 
ﬁd_id
, 
√w_id
;

2881 
r
;

2883 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 3);

2884 i‡(
r
)

2885  
r
;

2887 i‡(
	`k°πouŒ
(
¨gv
[1], 10, (*)&
ﬁd_id
)) {

2888 
	`DMWARN
("£t_å™ß˘i⁄_id mesßge: Uƒecogni£d id %s.", 
¨gv
[1]);

2889  -
EINVAL
;

2892 i‡(
	`k°πouŒ
(
¨gv
[2], 10, (*)&
√w_id
)) {

2893 
	`DMWARN
("£t_å™ß˘i⁄_id mesßge: Uƒecogni£dÇew id %s.", 
¨gv
[2]);

2894  -
EINVAL
;

2897 
r
 = 
	`dm_poﬁ_£t_mëad©a_å™ß˘i⁄_id
(
poﬁ
->
pmd
, 
ﬁd_id
, 
√w_id
);

2898 i‡(
r
) {

2899 
	`DMWARN
("FailedÅo changeÅransaction id from %sÅo %s.",

2900 
¨gv
[1],árgv[2]);

2901  
r
;

2905 
	}
}

2907 
	$¥o˚ss_ª£rve_mëad©a_¢≠_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2909 
r
;

2911 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 1);

2912 i‡(
r
)

2913  
r
;

2915 (Ë
	`commô
(
poﬁ
);

2917 
r
 = 
	`dm_poﬁ_ª£rve_mëad©a_¢≠
(
poﬁ
->
pmd
);

2918 i‡(
r
)

2919 
	`DMWARN
("reserve_metadata_snap message failed.");

2921  
r
;

2922 
	}
}

2924 
	$¥o˚ss_ªÀa£_mëad©a_¢≠_mesg
(
¨gc
, **
¨gv
, 
poﬁ
 *pool)

2926 
r
;

2928 
r
 = 
	`check_¨g_cou¡
(
¨gc
, 1);

2929 i‡(
r
)

2930  
r
;

2932 
r
 = 
	`dm_poﬁ_ªÀa£_mëad©a_¢≠
(
poﬁ
->
pmd
);

2933 i‡(
r
)

2934 
	`DMWARN
("release_metadata_snap message failed.");

2936  
r
;

2937 
	}
}

2949 
	$poﬁ_mesßge
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

2951 
r
 = -
EINVAL
;

2952 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

2953 
poﬁ
 *poﬁ = 
±
->pool;

2955 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "create_thin"))

2956 
r
 = 
	`¥o˚ss_¸óã_thö_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2958 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "create_snap"))

2959 
r
 = 
	`¥o˚ss_¸óã_¢≠_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2961 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "delete"))

2962 
r
 = 
	`¥o˚ss_dñëe_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2964 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "set_transaction_id"))

2965 
r
 = 
	`¥o˚ss_£t_å™ß˘i⁄_id_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2967 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "reserve_metadata_snap"))

2968 
r
 = 
	`¥o˚ss_ª£rve_mëad©a_¢≠_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2970 i‡(!
	`°rˇ£cmp
(
¨gv
[0], "release_metadata_snap"))

2971 
r
 = 
	`¥o˚ss_ªÀa£_mëad©a_¢≠_mesg
(
¨gc
, 
¨gv
, 
poﬁ
);

2974 
	`DMWARN
("Uƒecogni£dÅhöÖoﬁÅ¨gë mesßgêª˚ived: %s", 
¨gv
[0]);

2976 i‡(!
r
)

2977 (Ë
	`commô
(
poﬁ
);

2979  
r
;

2980 
	}
}

2982 
	$emô_Êags
(
poﬁ_„©uªs
 *
pf
, *
ªsu…
,

2983 
sz
, 
maxÀn
)

2985 
cou¡
 = !
pf
->
zîo_√w_blocks
 + !pf->
disˇrd_íabÀd
 +

2986 !
pf
->
disˇrd_∑ssdown
 + (pf->
mode
 =
PM_READ_ONLY
) +

2987 
pf
->
îr‹_if_no_•a˚
;

2988 
	`DMEMIT
("%u ", 
cou¡
);

2990 i‡(!
pf
->
zîo_√w_blocks
)

2991 
	`DMEMIT
("skip_block_zeroing ");

2993 i‡(!
pf
->
disˇrd_íabÀd
)

2994 
	`DMEMIT
("ignore_discard ");

2996 i‡(!
pf
->
disˇrd_∑ssdown
)

2997 
	`DMEMIT
("no_discard_passdown ");

2999 i‡(
pf
->
mode
 =
PM_READ_ONLY
)

3000 
	`DMEMIT
("read_only ");

3002 i‡(
pf
->
îr‹_if_no_•a˚
)

3003 
	`DMEMIT
("error_if_no_space ");

3004 
	}
}

3011 
	$poﬁ_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

3012 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

3014 
r
;

3015 
sz
 = 0;

3016 
uöt64_t
 
å™ß˘i⁄_id
;

3017 
dm_block_t
 
ƒ_‰ì_blocks_d©a
;

3018 
dm_block_t
 
ƒ_‰ì_blocks_mëad©a
;

3019 
dm_block_t
 
ƒ_blocks_d©a
;

3020 
dm_block_t
 
ƒ_blocks_mëad©a
;

3021 
dm_block_t
 
hñd_roŸ
;

3022 
buf
[
BDEVNAME_SIZE
];

3023 
buf2
[
BDEVNAME_SIZE
];

3024 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

3025 
poﬁ
 *poﬁ = 
±
->pool;

3027 
ty≥
) {

3028 
STATUSTYPE_INFO
:

3029 i‡(
	`gë_poﬁ_mode
(
poﬁ
Ë=
PM_FAIL
) {

3030 
	`DMEMIT
("Fail");

3035 i‡(!(
°©us_Êags
 & 
DM_STATUS_NOFLUSH_FLAG
Ë&& !
	`dm_su•íded
(
ti
))

3036 (Ë
	`commô
(
poﬁ
);

3038 
r
 = 
	`dm_poﬁ_gë_mëad©a_å™ß˘i⁄_id
(
poﬁ
->
pmd
, &
å™ß˘i⁄_id
);

3039 i‡(
r
) {

3040 
	`DMERR
("%s: dm_pool_get_metadata_transaction_idÑeturned %d",

3041 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3042 
îr
;

3045 
r
 = 
	`dm_poﬁ_gë_‰ì_mëad©a_block_cou¡
(
poﬁ
->
pmd
, &
ƒ_‰ì_blocks_mëad©a
);

3046 i‡(
r
) {

3047 
	`DMERR
("%s: dm_pool_get_free_metadata_block_countÑeturned %d",

3048 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3049 
îr
;

3052 
r
 = 
	`dm_poﬁ_gë_mëad©a_dev_size
(
poﬁ
->
pmd
, &
ƒ_blocks_mëad©a
);

3053 i‡(
r
) {

3054 
	`DMERR
("%s: dm_pool_get_metadata_dev_sizeÑeturned %d",

3055 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3056 
îr
;

3059 
r
 = 
	`dm_poﬁ_gë_‰ì_block_cou¡
(
poﬁ
->
pmd
, &
ƒ_‰ì_blocks_d©a
);

3060 i‡(
r
) {

3061 
	`DMERR
("%s: dm_pool_get_free_block_countÑeturned %d",

3062 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3063 
îr
;

3066 
r
 = 
	`dm_poﬁ_gë_d©a_dev_size
(
poﬁ
->
pmd
, &
ƒ_blocks_d©a
);

3067 i‡(
r
) {

3068 
	`DMERR
("%s: dm_pool_get_data_dev_sizeÑeturned %d",

3069 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3070 
îr
;

3073 
r
 = 
	`dm_poﬁ_gë_mëad©a_¢≠
(
poﬁ
->
pmd
, &
hñd_roŸ
);

3074 i‡(
r
) {

3075 
	`DMERR
("%s: dm_pool_get_metadata_snapÑeturned %d",

3076 
	`dm_devi˚_«me
(
poﬁ
->
poﬁ_md
), 
r
);

3077 
îr
;

3080 
	`DMEMIT
("%llu %llu/%llu %llu/%llu ",

3081 ()
å™ß˘i⁄_id
,

3082 ()(
ƒ_blocks_mëad©a
 - 
ƒ_‰ì_blocks_mëad©a
),

3083 ()
ƒ_blocks_mëad©a
,

3084 ()(
ƒ_blocks_d©a
 - 
ƒ_‰ì_blocks_d©a
),

3085 ()
ƒ_blocks_d©a
);

3087 i‡(
hñd_roŸ
)

3088 
	`DMEMIT
("%Œu ", 
hñd_roŸ
);

3090 
	`DMEMIT
("- ");

3092 i‡(
poﬁ
->
pf
.
mode
 =
PM_OUT_OF_DATA_SPACE
)

3093 
	`DMEMIT
("out_of_data_space ");

3094 i‡(
poﬁ
->
pf
.
mode
 =
PM_READ_ONLY
)

3095 
	`DMEMIT
("ro ");

3097 
	`DMEMIT
("rw ");

3099 i‡(!
poﬁ
->
pf
.
disˇrd_íabÀd
)

3100 
	`DMEMIT
("ignore_discard ");

3101 i‡(
poﬁ
->
pf
.
disˇrd_∑ssdown
)

3102 
	`DMEMIT
("discard_passdown ");

3104 
	`DMEMIT
("no_discard_passdown ");

3106 i‡(
poﬁ
->
pf
.
îr‹_if_no_•a˚
)

3107 
	`DMEMIT
("error_if_no_space ");

3109 
	`DMEMIT
("queue_if_no_space ");

3113 
STATUSTYPE_TABLE
:

3114 
	`DMEMIT
("%s %s %lu %llu ",

3115 
	`f‹m©_dev_t
(
buf
, 
±
->
mëad©a_dev
->
bdev
->
bd_dev
),

3116 
	`f‹m©_dev_t
(
buf2
, 
±
->
d©a_dev
->
bdev
->
bd_dev
),

3117 ()
poﬁ
->
£˘‹s_≥r_block
,

3118 ()
±
->
low_w©î_blocks
);

3119 
	`emô_Êags
(&
±
->
ªque°ed_pf
, 
ªsu…
, 
sz
, 
maxÀn
);

3124 
îr
:

3125 
	`DMEMIT
("Error");

3126 
	}
}

3128 
	$poﬁ_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

3129 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

3131 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

3133  
	`‚
(
ti
, 
±
->
d©a_dev
, 0,Åi->
Àn
, 
d©a
);

3134 
	}
}

3136 
	$poﬁ_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

3137 
bio_vec
 *
biovec
, 
max_size
)

3139 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

3140 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
±
->
d©a_dev
->
bdev
);

3142 i‡(!
q
->
mîge_bvec_‚
)

3143  
max_size
;

3145 
bvm
->
bi_bdev
 = 
±
->
d©a_dev
->
bdev
;

3147  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

3148 
	}
}

3150 
	$£t_disˇrd_limôs
(
poﬁ_c
 *
±
, 
queue_limôs
 *
limôs
)

3152 
poﬁ
 *poﬁ = 
±
->pool;

3153 
queue_limôs
 *
d©a_limôs
;

3155 
limôs
->
max_disˇrd_£˘‹s
 = 
poﬁ
->
£˘‹s_≥r_block
;

3160 i‡(
±
->
adju°ed_pf
.
disˇrd_∑ssdown
) {

3161 
d©a_limôs
 = &
	`bdev_gë_queue
(
±
->
d©a_dev
->
bdev
)->
limôs
;

3162 
limôs
->
disˇrd_gønuœrôy
 = 
	`max
(
d©a_limôs
->discard_granularity,

3163 
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

3165 
limôs
->
disˇrd_gønuœrôy
 = 
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
;

3166 
	}
}

3168 
	$poﬁ_io_höts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

3170 
poﬁ_c
 *
±
 = 
ti
->
¥iv©e
;

3171 
poﬁ
 *poﬁ = 
±
->pool;

3172 
uöt64_t
 
io_›t_£˘‹s
 = 
limôs
->
io_›t
 >> 
SECTOR_SHIFT
;

3178 i‡(
io_›t_£˘‹s
 < 
poﬁ
->
£˘‹s_≥r_block
 ||

3179 
	`do_div
(
io_›t_£˘‹s
, 
poﬁ
->
£˘‹s_≥r_block
)) {

3180 
	`blk_limôs_io_mö
(
limôs
, 
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

3181 
	`blk_limôs_io_›t
(
limôs
, 
poﬁ
->
£˘‹s_≥r_block
 << 
SECTOR_SHIFT
);

3189 i‡(!
±
->
adju°ed_pf
.
disˇrd_íabÀd
) {

3196 
limôs
->
disˇrd_gønuœrôy
 = 0;

3200 
	`dißbÀ_∑ssdown_if_nŸ_suµ‹ãd
(
±
);

3202 
	`£t_disˇrd_limôs
(
±
, 
limôs
);

3203 
	}
}

3205 
èrgë_ty≥
 
	gpoﬁ_èrgë
 = {

3206 .
«me
 = "thin-pool",

3207 .
	g„©uªs
 = 
DM_TARGET_SINGLETON
 | 
DM_TARGET_ALWAYS_WRITEABLE
 |

3208 
DM_TARGET_IMMUTABLE
,

3209 .
	gvîsi⁄
 = {1, 13, 0},

3210 .
	gmoduÀ
 = 
THIS_MODULE
,

3211 .
	g˘r
 = 
poﬁ_˘r
,

3212 .
	gdå
 = 
poﬁ_då
,

3213 .
	gm≠
 = 
poﬁ_m≠
,

3214 .
	gpo°su•íd
 = 
poﬁ_po°su•íd
,

3215 .
	g¥îesume
 = 
poﬁ_¥îesume
,

3216 .
	gªsume
 = 
poﬁ_ªsume
,

3217 .
	gmesßge
 = 
poﬁ_mesßge
,

3218 .
	g°©us
 = 
poﬁ_°©us
,

3219 .
	gmîge
 = 
poﬁ_mîge
,

3220 .
	gôî©e_devi˚s
 = 
poﬁ_ôî©e_devi˚s
,

3221 .
	gio_höts
 = 
poﬁ_io_höts
,

3227 
	$thö_gë
(
thö_c
 *
tc
)

3229 
	`©omic_öc
(&
tc
->
ªfcou¡
);

3230 
	}
}

3232 
	$thö_put
(
thö_c
 *
tc
)

3234 i‡(
	`©omic_dec_™d_ã°
(&
tc
->
ªfcou¡
))

3235 
	`com∂ëe
(&
tc
->
ˇn_de°roy
);

3236 
	}
}

3238 
	$thö_då
(
dm_èrgë
 *
ti
)

3240 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3241 
Êags
;

3243 
	`thö_put
(
tc
);

3244 
	`waô_f‹_com∂ëi⁄
(&
tc
->
ˇn_de°roy
);

3246 
	`•ö_lock_úqßve
(&
tc
->
poﬁ
->
lock
, 
Êags
);

3247 
	`li°_dñ_rcu
(&
tc
->
li°
);

3248 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
poﬁ
->
lock
, 
Êags
);

3249 
	`synchr⁄ize_rcu
();

3251 
	`muãx_lock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

3253 
	`__poﬁ_dec
(
tc
->
poﬁ
);

3254 
	`dm_poﬁ_˛o£_thö_devi˚
(
tc
->
td
);

3255 
	`dm_put_devi˚
(
ti
, 
tc
->
poﬁ_dev
);

3256 i‡(
tc
->
‹igö_dev
)

3257 
	`dm_put_devi˚
(
ti
, 
tc
->
‹igö_dev
);

3258 
	`k‰ì
(
tc
);

3260 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

3261 
	}
}

3275 
	$thö_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

3277 
r
;

3278 
thö_c
 *
tc
;

3279 
dm_dev
 *
poﬁ_dev
, *
‹igö_dev
;

3280 
m≠≥d_devi˚
 *
poﬁ_md
;

3281 
Êags
;

3283 
	`muãx_lock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

3285 i‡(
¨gc
 != 2 &&árgc != 3) {

3286 
ti
->
îr‹
 = "Invalidárgument count";

3287 
r
 = -
EINVAL
;

3288 
out_u∆ock
;

3291 
tc
 = 
ti
->
¥iv©e
 = 
	`kzÆloc
((*tc), 
GFP_KERNEL
);

3292 i‡(!
tc
) {

3293 
ti
->
îr‹
 = "Out of memory";

3294 
r
 = -
ENOMEM
;

3295 
out_u∆ock
;

3297 
	`•ö_lock_öô
(&
tc
->
lock
);

3298 
	`bio_li°_öô
(&
tc
->
de„ºed_bio_li°
);

3299 
	`bio_li°_öô
(&
tc
->
ªåy_⁄_ªsume_li°
);

3300 
tc
->
s‹t_bio_li°
 = 
RB_ROOT
;

3302 i‡(
¨gc
 == 3) {

3303 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[2], 
FMODE_READ
, &
‹igö_dev
);

3304 i‡(
r
) {

3305 
ti
->
îr‹
 = "Error opening origin device";

3306 
bad_‹igö_dev
;

3308 
tc
->
‹igö_dev
 = origin_dev;

3311 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[0], 
	`dm_èbÀ_gë_mode
—i->
èbÀ
), &
poﬁ_dev
);

3312 i‡(
r
) {

3313 
ti
->
îr‹
 = "Error openingÖool device";

3314 
bad_poﬁ_dev
;

3316 
tc
->
poﬁ_dev
 =Öool_dev;

3318 i‡(
	`ªad_dev_id
(
¨gv
[1], (*)&
tc
->
dev_id
, 0)) {

3319 
ti
->
îr‹
 = "Invalid device id";

3320 
r
 = -
EINVAL
;

3321 
bad_comm⁄
;

3324 
poﬁ_md
 = 
	`dm_gë_md
(
tc
->
poﬁ_dev
->
bdev
->
bd_dev
);

3325 i‡(!
poﬁ_md
) {

3326 
ti
->
îr‹
 = "Couldn't getÖool mapped device";

3327 
r
 = -
EINVAL
;

3328 
bad_comm⁄
;

3331 
tc
->
poﬁ
 = 
	`__poﬁ_èbÀ_lookup
(
poﬁ_md
);

3332 i‡(!
tc
->
poﬁ
) {

3333 
ti
->
îr‹
 = "Couldn't findÖool object";

3334 
r
 = -
EINVAL
;

3335 
bad_poﬁ_lookup
;

3337 
	`__poﬁ_öc
(
tc
->
poﬁ
);

3339 i‡(
	`gë_poﬁ_mode
(
tc
->
poﬁ
Ë=
PM_FAIL
) {

3340 
ti
->
îr‹
 = "Couldn't openÅhin device, Pool is in fail mode";

3341 
r
 = -
EINVAL
;

3342 
bad_thö_›í
;

3345 
r
 = 
	`dm_poﬁ_›í_thö_devi˚
(
tc
->
poﬁ
->
pmd
,Åc->
dev_id
, &tc->
td
);

3346 i‡(
r
) {

3347 
ti
->
îr‹
 = "Couldn't openÅhin internal device";

3348 
bad_thö_›í
;

3351 
r
 = 
	`dm_£t_èrgë_max_io_Àn
(
ti
, 
tc
->
poﬁ
->
£˘‹s_≥r_block
);

3352 i‡(
r
)

3353 
bad_èrgë_max_io_Àn
;

3355 
ti
->
num_Êush_bios
 = 1;

3356 
ti
->
Êush_suµ‹ãd
 = 
åue
;

3357 
ti
->
≥r_bio_d©a_size
 = (
dm_thö_ídio_hook
);

3360 
ti
->
disˇrd_zî€s_d©a_unsuµ‹ãd
 = 
åue
;

3361 i‡(
tc
->
poﬁ
->
pf
.
disˇrd_íabÀd
) {

3362 
ti
->
disˇrds_suµ‹ãd
 = 
åue
;

3363 
ti
->
num_disˇrd_bios
 = 1;

3365 
ti
->
•lô_disˇrd_bios
 = 
åue
;

3368 
	`dm_put
(
poﬁ_md
);

3370 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

3372 
	`©omic_£t
(&
tc
->
ªfcou¡
, 1);

3373 
	`öô_com∂ëi⁄
(&
tc
->
ˇn_de°roy
);

3375 
	`•ö_lock_úqßve
(&
tc
->
poﬁ
->
lock
, 
Êags
);

3376 
	`li°_add_èû_rcu
(&
tc
->
li°
, &tc->
poﬁ
->
a˘ive_thös
);

3377 
	`•ö_u∆ock_úqª°‹e
(&
tc
->
poﬁ
->
lock
, 
Êags
);

3384 
	`synchr⁄ize_rcu
();

3388 
bad_èrgë_max_io_Àn
:

3389 
	`dm_poﬁ_˛o£_thö_devi˚
(
tc
->
td
);

3390 
bad_thö_›í
:

3391 
	`__poﬁ_dec
(
tc
->
poﬁ
);

3392 
bad_poﬁ_lookup
:

3393 
	`dm_put
(
poﬁ_md
);

3394 
bad_comm⁄
:

3395 
	`dm_put_devi˚
(
ti
, 
tc
->
poﬁ_dev
);

3396 
bad_poﬁ_dev
:

3397 i‡(
tc
->
‹igö_dev
)

3398 
	`dm_put_devi˚
(
ti
, 
tc
->
‹igö_dev
);

3399 
bad_‹igö_dev
:

3400 
	`k‰ì
(
tc
);

3401 
out_u∆ock
:

3402 
	`muãx_u∆ock
(&
dm_thö_poﬁ_èbÀ
.
muãx
);

3404  
r
;

3405 
	}
}

3407 
	$thö_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

3409 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`dm_èrgë_off£t
(
ti
, bio->bi_iter.bi_sector);

3411  
	`thö_bio_m≠
(
ti
, 
bio
);

3412 
	}
}

3414 
	$thö_ídio
(
dm_èrgë
 *
ti
, 
bio
 *bio, 
îr
)

3416 
Êags
;

3417 
dm_thö_ídio_hook
 *
h
 = 
	`dm_≥r_bio_d©a
(
bio
, (dm_thin_endio_hook));

3418 
li°_hód
 
w‹k
;

3419 
dm_thö_√w_m≠pög
 *
m
, *
tmp
;

3420 
poﬁ
 *poﬁ = 
h
->
tc
->pool;

3422 i‡(
h
->
sh¨ed_ªad_íåy
) {

3423 
	`INIT_LIST_HEAD
(&
w‹k
);

3424 
	`dm_de„ºed_íåy_dec
(
h
->
sh¨ed_ªad_íåy
, &
w‹k
);

3426 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

3427 
	`li°_f‹_óch_íåy_ß„
(
m
, 
tmp
, &
w‹k
, 
li°
) {

3428 
	`li°_dñ
(&
m
->
li°
);

3429 
	`__com∂ëe_m≠pög_¥ï¨©i⁄
(
m
);

3431 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

3434 i‡(
h
->
Æl_io_íåy
) {

3435 
	`INIT_LIST_HEAD
(&
w‹k
);

3436 
	`dm_de„ºed_íåy_dec
(
h
->
Æl_io_íåy
, &
w‹k
);

3437 i‡(!
	`li°_em±y
(&
w‹k
)) {

3438 
	`•ö_lock_úqßve
(&
poﬁ
->
lock
, 
Êags
);

3439 
	`li°_f‹_óch_íåy_ß„
(
m
, 
tmp
, &
w‹k
, 
li°
)

3440 
	`li°_add_èû
(&
m
->
li°
, &
poﬁ
->
¥ï¨ed_disˇrds
);

3441 
	`•ö_u∆ock_úqª°‹e
(&
poﬁ
->
lock
, 
Êags
);

3442 
	`wake_w‹kî
(
poﬁ
);

3447 
	}
}

3449 
	$thö_¥esu•íd
(
dm_èrgë
 *
ti
)

3451 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3453 i‡(
	`dm_noÊush_su•ídög
(
ti
))

3454 
	`noÊush_w‹k
(
tc
, 
do_noÊush_°¨t
);

3455 
	}
}

3457 
	$thö_po°su•íd
(
dm_èrgë
 *
ti
)

3459 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3465 
	`noÊush_w‹k
(
tc
, 
do_noÊush_°›
);

3466 
	}
}

3468 
	$thö_¥îesume
(
dm_èrgë
 *
ti
)

3470 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3472 i‡(
tc
->
‹igö_dev
)

3473 
tc
->
‹igö_size
 = 
	`gë_dev_size
—c->
‹igö_dev
->
bdev
);

3476 
	}
}

3481 
	$thö_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

3482 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

3484 
r
;

3485 
ssize_t
 
sz
 = 0;

3486 
dm_block_t
 
m≠≥d
, 
highe°
;

3487 
buf
[
BDEVNAME_SIZE
];

3488 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3490 i‡(
	`gë_poﬁ_mode
(
tc
->
poﬁ
Ë=
PM_FAIL
) {

3491 
	`DMEMIT
("Fail");

3495 i‡(!
tc
->
td
)

3496 
	`DMEMIT
("-");

3498 
ty≥
) {

3499 
STATUSTYPE_INFO
:

3500 
r
 = 
	`dm_thö_gë_m≠≥d_cou¡
(
tc
->
td
, &
m≠≥d
);

3501 i‡(
r
) {

3502 
	`DMERR
("dm_thö_gë_m≠≥d_cou¡Ñëu∫ed %d", 
r
);

3503 
îr
;

3506 
r
 = 
	`dm_thö_gë_highe°_m≠≥d_block
(
tc
->
td
, &
highe°
);

3507 i‡(
r
 < 0) {

3508 
	`DMERR
("dm_thö_gë_highe°_m≠≥d_blockÑëu∫ed %d", 
r
);

3509 
îr
;

3512 
	`DMEMIT
("%Œu ", 
m≠≥d
 * 
tc
->
poﬁ
->
£˘‹s_≥r_block
);

3513 i‡(
r
)

3514 
	`DMEMIT
("%Œu", ((
highe°
 + 1) *

3515 
tc
->
poﬁ
->
£˘‹s_≥r_block
) - 1);

3517 
	`DMEMIT
("-");

3520 
STATUSTYPE_TABLE
:

3521 
	`DMEMIT
("%s %lu",

3522 
	`f‹m©_dev_t
(
buf
, 
tc
->
poﬁ_dev
->
bdev
->
bd_dev
),

3523 (Ë
tc
->
dev_id
);

3524 i‡(
tc
->
‹igö_dev
)

3525 
	`DMEMIT
(" %s", 
	`f‹m©_dev_t
(
buf
, 
tc
->
‹igö_dev
->
bdev
->
bd_dev
));

3532 
îr
:

3533 
	`DMEMIT
("Error");

3534 
	}
}

3536 
	$thö_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

3537 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

3539 
£˘‹_t
 
blocks
;

3540 
thö_c
 *
tc
 = 
ti
->
¥iv©e
;

3541 
poﬁ
 *poﬁ = 
tc
->pool;

3547 i‡(!
poﬁ
->
ti
)

3550 
blocks
 = 
poﬁ
->
ti
->
Àn
;

3551 (Ë
	`£˘‹_div
(
blocks
, 
poﬁ
->
£˘‹s_≥r_block
);

3552 i‡(
blocks
)

3553  
	`‚
(
ti
, 
tc
->
poﬁ_dev
, 0, 
poﬁ
->
£˘‹s_≥r_block
 * 
blocks
, 
d©a
);

3556 
	}
}

3558 
èrgë_ty≥
 
	gthö_èrgë
 = {

3559 .
«me
 = "thin",

3560 .
	gvîsi⁄
 = {1, 13, 0},

3561 .
	gmoduÀ
 = 
THIS_MODULE
,

3562 .
	g˘r
 = 
thö_˘r
,

3563 .
	gdå
 = 
thö_då
,

3564 .
	gm≠
 = 
thö_m≠
,

3565 .
	gíd_io
 = 
thö_ídio
,

3566 .
	g¥îesume
 = 
thö_¥îesume
,

3567 .
	g¥esu•íd
 = 
thö_¥esu•íd
,

3568 .
	gpo°su•íd
 = 
thö_po°su•íd
,

3569 .
	g°©us
 = 
thö_°©us
,

3570 .
	gôî©e_devi˚s
 = 
thö_ôî©e_devi˚s
,

3575 
__öô
 
	$dm_thö_öô
()

3577 
r
;

3579 
	`poﬁ_èbÀ_öô
();

3581 
r
 = 
	`dm_ªgi°î_èrgë
(&
thö_èrgë
);

3582 i‡(
r
)

3583  
r
;

3585 
r
 = 
	`dm_ªgi°î_èrgë
(&
poﬁ_èrgë
);

3586 i‡(
r
)

3587 
bad_poﬁ_èrgë
;

3589 
r
 = -
ENOMEM
;

3591 
_√w_m≠pög_ˇche
 = 
	`KMEM_CACHE
(
dm_thö_√w_m≠pög
, 0);

3592 i‡(!
_√w_m≠pög_ˇche
)

3593 
bad_√w_m≠pög_ˇche
;

3597 
bad_√w_m≠pög_ˇche
:

3598 
	`dm_uƒegi°î_èrgë
(&
poﬁ_èrgë
);

3599 
bad_poﬁ_èrgë
:

3600 
	`dm_uƒegi°î_èrgë
(&
thö_èrgë
);

3602  
r
;

3603 
	}
}

3605 
	$dm_thö_exô
()

3607 
	`dm_uƒegi°î_èrgë
(&
thö_èrgë
);

3608 
	`dm_uƒegi°î_èrgë
(&
poﬁ_èrgë
);

3610 
	`kmem_ˇche_de°roy
(
_√w_m≠pög_ˇche
);

3611 
	}
}

3613 
moduÀ_öô
(
dm_thö_öô
);

3614 
moduÀ_exô
(
dm_thö_exô
);

3616 
moduÀ_∑øm_«med
(
no_•a˚_timeout
, 
no_•a˚_timeout_£cs
, 
uöt
, 
S_IRUGO
 | 
S_IWUSR
);

3617 
MODULE_PARM_DESC
(
no_•a˚_timeout
, "Out of data space queue IOÅimeout in seconds");

3619 
MODULE_DESCRIPTION
(
DM_NAME
 "ÅhinÖrovisioningÅarget");

3620 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

3621 
MODULE_LICENSE
("GPL");

	@dm-uevent.c

21 
	~<löux/li°.h
>

22 
	~<löux/¶ab.h
>

23 
	~<löux/kobje˘.h
>

24 
	~<löux/dm-io˘l.h
>

25 
	~<löux/exp‹t.h
>

27 
	~"dm.h
"

28 
	~"dm-uevít.h
"

30 
	#DM_MSG_PREFIX
 "uevít"

	)

33 
dm_uevít_ty≥
 
	mty≥
;

34 
kobje˘_a˘i⁄
 
	ma˘i⁄
;

35 *
	m«me
;

36 } 
	g_dm_uevít_ty≥_«mes
[] = {

37 {
DM_UEVENT_PATH_FAILED
, 
KOBJ_CHANGE
, "PATH_FAILED"},

38 {
DM_UEVENT_PATH_REINSTATED
, 
KOBJ_CHANGE
, "PATH_REINSTATED"},

41 
kmem_ˇche
 *
	g_dm_evít_ˇche
;

43 
	sdm_uevít
 {

44 
m≠≥d_devi˚
 *
	mmd
;

45 
kobje˘_a˘i⁄
 
	ma˘i⁄
;

46 
kobj_uevít_ív
 
	mku_ív
;

47 
li°_hód
 
	mñi°
;

48 
	m«me
[
DM_NAME_LEN
];

49 
	muuid
[
DM_UUID_LEN
];

52 
	$dm_uevít_‰ì
(
dm_uevít
 *
evít
)

54 
	`kmem_ˇche_‰ì
(
_dm_evít_ˇche
, 
evít
);

55 
	}
}

57 
dm_uevít
 *
	$dm_uevít_Æloc
(
m≠≥d_devi˚
 *
md
)

59 
dm_uevít
 *
evít
;

61 
evít
 = 
	`kmem_ˇche_zÆloc
(
_dm_evít_ˇche
, 
GFP_ATOMIC
);

62 i‡(!
evít
)

63  
NULL
;

65 
	`INIT_LIST_HEAD
(&
evít
->
ñi°
);

66 
evít
->
md
 = md;

68  
evít
;

69 
	}
}

71 
dm_uevít
 *
	$dm_buûd_∑th_uevít
(
m≠≥d_devi˚
 *
md
,

72 
dm_èrgë
 *
ti
,

73 
kobje˘_a˘i⁄
 
a˘i⁄
,

74 c⁄° *
dm_a˘i⁄
,

75 c⁄° *
∑th
,

76 
ƒ_vÆid_∑ths
)

78 
dm_uevít
 *
evít
;

80 
evít
 = 
	`dm_uevít_Æloc
(
md
);

81 i‡(!
evít
) {

82 
	`DMERR
("%s: dm_uevít_Æloc(ËÁûed", 
__func__
);

83 
îr_nomem
;

86 
evít
->
a˘i⁄
 =áction;

88 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_TARGET=%s", 
ti
->
ty≥
->
«me
)) {

89 
	`DMERR
("%s:ádd_uevent_var() for DM_TARGET failed",

90 
__func__
);

91 
îr_add
;

94 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_ACTION=%s", 
dm_a˘i⁄
)) {

95 
	`DMERR
("%s:ádd_uevent_var() for DM_ACTION failed",

96 
__func__
);

97 
îr_add
;

100 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_SEQNUM=%u",

101 
	`dm_√xt_uevít_£q
(
md
))) {

102 
	`DMERR
("%s:ádd_uevent_var() for DM_SEQNUM failed",

103 
__func__
);

104 
îr_add
;

107 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_PATH=%s", 
∑th
)) {

108 
	`DMERR
("%s:ádd_uevít_v¨(Ëf‹ DM_PATH faûed", 
__func__
);

109 
îr_add
;

112 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_NR_VALID_PATHS=%d",

113 
ƒ_vÆid_∑ths
)) {

114 
	`DMERR
("%s:ádd_uevent_var() for DM_NR_VALID_PATHS failed",

115 
__func__
);

116 
îr_add
;

119  
evít
;

121 
îr_add
:

122 
	`dm_uevít_‰ì
(
evít
);

123 
îr_nomem
:

124  
	`ERR_PTR
(-
ENOMEM
);

125 
	}
}

134 
	$dm_£nd_uevíts
(
li°_hód
 *
evíts
, 
kobje˘
 *
kobj
)

136 
r
;

137 
dm_uevít
 *
evít
, *
√xt
;

139 
	`li°_f‹_óch_íåy_ß„
(
evít
, 
√xt
, 
evíts
, 
ñi°
) {

140 
	`li°_dñ_öô
(&
evít
->
ñi°
);

146 i‡(
	`dm_c›y_«me_™d_uuid
(
evít
->
md
,Évít->
«me
,

147 
evít
->
uuid
)) {

148 
	`DMINFO
("%s: skipping sending uevent forÜost device",

149 
__func__
);

150 
uevít_‰ì
;

153 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_NAME=%s",Évít->
«me
)) {

154 
	`DMERR
("%s:ádd_uevent_var() for DM_NAME failed",

155 
__func__
);

156 
uevít_‰ì
;

159 i‡(
	`add_uevít_v¨
(&
evít
->
ku_ív
, "DM_UUID=%s",Évít->
uuid
)) {

160 
	`DMERR
("%s:ádd_uevent_var() for DM_UUID failed",

161 
__func__
);

162 
uevít_‰ì
;

165 
r
 = 
	`kobje˘_uevít_ív
(
kobj
, 
evít
->
a˘i⁄
,Évít->
ku_ív
.
ívp
);

166 i‡(
r
)

167 
	`DMERR
("%s: kobje˘_uevít_ív faûed", 
__func__
);

168 
uevít_‰ì
:

169 
	`dm_uevít_‰ì
(
evít
);

171 
	}
}

172 
EXPORT_SYMBOL_GPL
(
dm_£nd_uevíts
);

183 
	$dm_∑th_uevít
(
dm_uevít_ty≥
 
evít_ty≥
, 
dm_èrgë
 *
ti
,

184 c⁄° *
∑th
, 
ƒ_vÆid_∑ths
)

186 
m≠≥d_devi˚
 *
md
 = 
	`dm_èbÀ_gë_md
(
ti
->
èbÀ
);

187 
dm_uevít
 *
evít
;

189 i‡(
evít_ty≥
 >
	`ARRAY_SIZE
(
_dm_uevít_ty≥_«mes
)) {

190 
	`DMERR
("%s: InvÆidÉvít_ty≥ %d", 
__func__
, 
evít_ty≥
);

194 
evít
 = 
	`dm_buûd_∑th_uevít
(
md
, 
ti
,

195 
_dm_uevít_ty≥_«mes
[
evít_ty≥
].
a˘i⁄
,

196 
_dm_uevít_ty≥_«mes
[
evít_ty≥
].
«me
,

197 
∑th
, 
ƒ_vÆid_∑ths
);

198 i‡(
	`IS_ERR
(
evít
))

201 
	`dm_uevít_add
(
md
, &
evít
->
ñi°
);

202 
	}
}

203 
EXPORT_SYMBOL_GPL
(
dm_∑th_uevít
);

205 
	$dm_uevít_öô
()

207 
_dm_evít_ˇche
 = 
	`KMEM_CACHE
(
dm_uevít
, 0);

208 i‡(!
_dm_evít_ˇche
)

209  -
ENOMEM
;

211 
	`DMINFO
("version 1.0.3");

214 
	}
}

216 
	$dm_uevít_exô
()

218 
	`kmem_ˇche_de°roy
(
_dm_evít_ˇche
);

219 
	}
}

	@dm-uevent.h

21 #i‚de‡
DM_UEVENT_H


22 
	#DM_UEVENT_H


	)

24 
	edm_uevít_ty≥
 {

25 
	mDM_UEVENT_PATH_FAILED
,

26 
	mDM_UEVENT_PATH_REINSTATED
,

29 #ifde‡
CONFIG_DM_UEVENT


31 
dm_uevít_öô
();

32 
dm_uevít_exô
();

33 
dm_£nd_uevíts
(
li°_hód
 *
evíts
, 
kobje˘
 *
kobj
);

34 
dm_∑th_uevít
(
dm_uevít_ty≥
 
evít_ty≥
,

35 
dm_èrgë
 *
ti
, c⁄° *
∑th
,

36 
ƒ_vÆid_∑ths
);

40 
ölöe
 
	$dm_uevít_öô
()

43 
	}
}

44 
ölöe
 
	$dm_uevít_exô
()

46 
	}
}

47 
ölöe
 
	$dm_£nd_uevíts
(
li°_hód
 *
evíts
,

48 
kobje˘
 *
kobj
)

50 
	}
}

51 
ölöe
 
	$dm_∑th_uevít
(
dm_uevít_ty≥
 
evít_ty≥
,

52 
dm_èrgë
 *
ti
, c⁄° *
∑th
,

53 
ƒ_vÆid_∑ths
)

55 
	}
}

	@dm-verity.c

17 
	~"dm-bufio.h
"

19 
	~<löux/moduÀ.h
>

20 
	~<löux/devi˚-m≠≥r.h
>

21 
	~<¸y±o/hash.h
>

23 
	#DM_MSG_PREFIX
 "vîôy"

	)

25 
	#DM_VERITY_IO_VEC_INLINE
 16

	)

26 
	#DM_VERITY_MEMPOOL_SIZE
 4

	)

27 
	#DM_VERITY_DEFAULT_PREFETCH_SIZE
 262144

	)

29 
	#DM_VERITY_MAX_LEVELS
 63

	)

31 
	gdm_vîôy_¥e„tch_˛u°î
 = 
DM_VERITY_DEFAULT_PREFETCH_SIZE
;

33 
moduÀ_∑øm_«med
(
¥e„tch_˛u°î
, 
dm_vîôy_¥e„tch_˛u°î
, 
uöt
, 
S_IRUGO
 | 
S_IWUSR
);

35 
	sdm_vîôy
 {

36 
dm_dev
 *
	md©a_dev
;

37 
dm_dev
 *
	mhash_dev
;

38 
dm_èrgë
 *
	mti
;

39 
dm_bufio_˛õ¡
 *
	mbufio
;

40 *
	mÆg_«me
;

41 
¸y±o_shash
 *
	mtfm
;

42 
u8
 *
	mroŸ_dige°
;

43 
u8
 *
	mß…
;

44 
	mß…_size
;

45 
£˘‹_t
 
	md©a_°¨t
;

46 
£˘‹_t
 
	mhash_°¨t
;

47 
£˘‹_t
 
	md©a_blocks
;

48 
£˘‹_t
 
	mhash_blocks
;

49 
	md©a_dev_block_bôs
;

50 
	mhash_dev_block_bôs
;

51 
	mhash_≥r_block_bôs
;

52 
	mÀvñs
;

53 
	mvîsi⁄
;

54 
	mdige°_size
;

55 
	mshash_descsize
;

56 
	mhash_Áûed
;

58 
mempoﬁ_t
 *
	mvec_mempoﬁ
;

60 
w‹kqueue_°ru˘
 *
	mvîify_wq
;

63 
£˘‹_t
 
	mhash_Àvñ_block
[
DM_VERITY_MAX_LEVELS
];

66 
	sdm_vîôy_io
 {

67 
dm_vîôy
 *
	mv
;

70 
bio_íd_io_t
 *
	m‹ig_bi_íd_io
;

71 *
	m‹ig_bi_¥iv©e
;

73 
£˘‹_t
 
	mblock
;

74 
	mn_blocks
;

76 
bvec_ôî
 
	môî
;

78 
w‹k_°ru˘
 
	mw‹k
;

91 
	sdm_vîôy_¥e„tch_w‹k
 {

92 
w‹k_°ru˘
 
	mw‹k
;

93 
dm_vîôy
 *
	mv
;

94 
£˘‹_t
 
	mblock
;

95 
	mn_blocks
;

98 
shash_desc
 *
	$io_hash_desc
(
dm_vîôy
 *
v
, 
dm_vîôy_io
 *
io
)

100  (
shash_desc
 *)(
io
 + 1);

101 
	}
}

103 
u8
 *
	$io_ªÆ_dige°
(
dm_vîôy
 *
v
, 
dm_vîôy_io
 *
io
)

105  (
u8
 *)(
io
 + 1Ë+ 
v
->
shash_descsize
;

106 
	}
}

108 
u8
 *
	$io_w™t_dige°
(
dm_vîôy
 *
v
, 
dm_vîôy_io
 *
io
)

110  (
u8
 *)(
io
 + 1Ë+ 
v
->
shash_descsize
 + v->
dige°_size
;

111 
	}
}

125 
	sbuf„r_aux
 {

126 
	mhash_vîifõd
;

132 
	$dm_bufio_Æloc_ˇŒback
(
dm_buf„r
 *
buf
)

134 
buf„r_aux
 *
aux
 = 
	`dm_bufio_gë_aux_d©a
(
buf
);

136 
aux
->
hash_vîifõd
 = 0;

137 
	}
}

142 
£˘‹_t
 
	$vîôy_m≠_£˘‹
(
dm_vîôy
 *
v
, 
£˘‹_t
 
bi_£˘‹
)

144  
v
->
d©a_°¨t
 + 
	`dm_èrgë_off£t
(v->
ti
, 
bi_£˘‹
);

145 
	}
}

153 
£˘‹_t
 
	$vîôy_posôi⁄_©_Àvñ
(
dm_vîôy
 *
v
, 
£˘‹_t
 
block
,

154 
Àvñ
)

156  
block
 >> (
Àvñ
 * 
v
->
hash_≥r_block_bôs
);

157 
	}
}

159 
	$vîôy_hash_©_Àvñ
(
dm_vîôy
 *
v
, 
£˘‹_t
 
block
, 
Àvñ
,

160 
£˘‹_t
 *
hash_block
, *
off£t
)

162 
£˘‹_t
 
posôi⁄
 = 
	`vîôy_posôi⁄_©_Àvñ
(
v
, 
block
, 
Àvñ
);

163 
idx
;

165 *
hash_block
 = 
v
->
hash_Àvñ_block
[
Àvñ
] + (
posôi⁄
 >> v->
hash_≥r_block_bôs
);

167 i‡(!
off£t
)

170 
idx
 = 
posôi⁄
 & ((1 << 
v
->
hash_≥r_block_bôs
) - 1);

171 i‡(!
v
->
vîsi⁄
)

172 *
off£t
 = 
idx
 * 
v
->
dige°_size
;

174 *
off£t
 = 
idx
 << (
v
->
hash_dev_block_bôs
 - v->
hash_≥r_block_bôs
);

175 
	}
}

188 
	$vîôy_vîify_Àvñ
(
dm_vîôy_io
 *
io
, 
£˘‹_t
 
block
,

189 
Àvñ
, 
boﬁ
 
skù_unvîifõd
)

191 
dm_vîôy
 *
v
 = 
io
->v;

192 
dm_buf„r
 *
buf
;

193 
buf„r_aux
 *
aux
;

194 
u8
 *
d©a
;

195 
r
;

196 
£˘‹_t
 
hash_block
;

197 
off£t
;

199 
	`vîôy_hash_©_Àvñ
(
v
, 
block
, 
Àvñ
, &
hash_block
, &
off£t
);

201 
d©a
 = 
	`dm_bufio_ªad
(
v
->
bufio
, 
hash_block
, &
buf
);

202 i‡(
	`u∆ikñy
(
	`IS_ERR
(
d©a
)))

203  
	`PTR_ERR
(
d©a
);

205 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
buf
);

207 i‡(!
aux
->
hash_vîifõd
) {

208 
shash_desc
 *
desc
;

209 
u8
 *
ªsu…
;

211 i‡(
skù_unvîifõd
) {

212 
r
 = 1;

213 
ªÀa£_ªt_r
;

216 
desc
 = 
	`io_hash_desc
(
v
, 
io
);

217 
desc
->
tfm
 = 
v
->tfm;

218 
desc
->
Êags
 = 
CRYPTO_TFM_REQ_MAY_SLEEP
;

219 
r
 = 
	`¸y±o_shash_öô
(
desc
);

220 i‡(
r
 < 0) {

221 
	`DMERR
("¸y±o_shash_öô faûed: %d", 
r
);

222 
ªÀa£_ªt_r
;

225 i‡(
	`likñy
(
v
->
vîsi⁄
 >= 1)) {

226 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
v
->
ß…
, v->
ß…_size
);

227 i‡(
r
 < 0) {

228 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

229 
ªÀa£_ªt_r
;

233 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
d©a
, 1 << 
v
->
hash_dev_block_bôs
);

234 i‡(
r
 < 0) {

235 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

236 
ªÀa£_ªt_r
;

239 i‡(!
v
->
vîsi⁄
) {

240 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
v
->
ß…
, v->
ß…_size
);

241 i‡(
r
 < 0) {

242 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

243 
ªÀa£_ªt_r
;

247 
ªsu…
 = 
	`io_ªÆ_dige°
(
v
, 
io
);

248 
r
 = 
	`¸y±o_shash_föÆ
(
desc
, 
ªsu…
);

249 i‡(
r
 < 0) {

250 
	`DMERR
("¸y±o_shash_föÆ faûed: %d", 
r
);

251 
ªÀa£_ªt_r
;

253 i‡(
	`u∆ikñy
(
	`memcmp
(
ªsu…
, 
	`io_w™t_dige°
(
v
, 
io
), v->
dige°_size
))) {

254 
	`DMERR_LIMIT
("metadata block %llu is corrupted",

255 ()
hash_block
);

256 
v
->
hash_Áûed
 = 1;

257 
r
 = -
EIO
;

258 
ªÀa£_ªt_r
;

260 
aux
->
hash_vîifõd
 = 1;

263 
d©a
 +
off£t
;

265 
	`mem˝y
(
	`io_w™t_dige°
(
v
, 
io
), 
d©a
, v->
dige°_size
);

267 
	`dm_bufio_ªÀa£
(
buf
);

270 
ªÀa£_ªt_r
:

271 
	`dm_bufio_ªÀa£
(
buf
);

273  
r
;

274 
	}
}

279 
	$vîôy_vîify_io
(
dm_vîôy_io
 *
io
)

281 
dm_vîôy
 *
v
 = 
io
->v;

282 
bio
 *biÿ
	`dm_bio_‰om_≥r_bio_d©a
(
io
,

283 
v
->
ti
->
≥r_bio_d©a_size
);

284 
b
;

285 
i
;

287 
b
 = 0; b < 
io
->
n_blocks
; b++) {

288 
shash_desc
 *
desc
;

289 
u8
 *
ªsu…
;

290 
r
;

291 
todo
;

293 i‡(
	`likñy
(
v
->
Àvñs
)) {

301 
r
 = 
	`vîôy_vîify_Àvñ
(
io
, io->
block
 + 
b
, 0, 
åue
);

302 i‡(
	`likñy
(!
r
))

303 
ã°_block_hash
;

304 i‡(
r
 < 0)

305  
r
;

308 
	`mem˝y
(
	`io_w™t_dige°
(
v
, 
io
), v->
roŸ_dige°
, v->
dige°_size
);

310 
i
 = 
v
->
Àvñs
 - 1; i >= 0; i--) {

311 
r
 = 
	`vîôy_vîify_Àvñ
(
io
, io->
block
 + 
b
, 
i
, 
Ál£
);

312 i‡(
	`u∆ikñy
(
r
))

313  
r
;

316 
ã°_block_hash
:

317 
desc
 = 
	`io_hash_desc
(
v
, 
io
);

318 
desc
->
tfm
 = 
v
->tfm;

319 
desc
->
Êags
 = 
CRYPTO_TFM_REQ_MAY_SLEEP
;

320 
r
 = 
	`¸y±o_shash_öô
(
desc
);

321 i‡(
r
 < 0) {

322 
	`DMERR
("¸y±o_shash_öô faûed: %d", 
r
);

323  
r
;

326 i‡(
	`likñy
(
v
->
vîsi⁄
 >= 1)) {

327 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
v
->
ß…
, v->
ß…_size
);

328 i‡(
r
 < 0) {

329 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

330  
r
;

333 
todo
 = 1 << 
v
->
d©a_dev_block_bôs
;

335 
u8
 *
∑ge
;

336 
Àn
;

337 
bio_vec
 
bv
 = 
	`bio_ôî_iovec
(
bio
, 
io
->
ôî
);

339 
∑ge
 = 
	`km≠_©omic
(
bv
.
bv_∑ge
);

340 
Àn
 = 
bv
.
bv_Àn
;

341 i‡(
	`likñy
(
Àn
 >
todo
))

342 
Àn
 = 
todo
;

343 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
∑ge
 + 
bv
.
bv_off£t
, 
Àn
);

344 
	`kunm≠_©omic
(
∑ge
);

346 i‡(
r
 < 0) {

347 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

348  
r
;

351 
	`bio_adv™˚_ôî
(
bio
, &
io
->
ôî
, 
Àn
);

352 
todo
 -
Àn
;

353 } 
todo
);

355 i‡(!
v
->
vîsi⁄
) {

356 
r
 = 
	`¸y±o_shash_upd©e
(
desc
, 
v
->
ß…
, v->
ß…_size
);

357 i‡(
r
 < 0) {

358 
	`DMERR
("¸y±o_shash_upd©êÁûed: %d", 
r
);

359  
r
;

363 
ªsu…
 = 
	`io_ªÆ_dige°
(
v
, 
io
);

364 
r
 = 
	`¸y±o_shash_föÆ
(
desc
, 
ªsu…
);

365 i‡(
r
 < 0) {

366 
	`DMERR
("¸y±o_shash_föÆ faûed: %d", 
r
);

367  
r
;

369 i‡(
	`u∆ikñy
(
	`memcmp
(
ªsu…
, 
	`io_w™t_dige°
(
v
, 
io
), v->
dige°_size
))) {

370 
	`DMERR_LIMIT
("data block %llu is corrupted",

371 ()(
io
->
block
 + 
b
));

372 
v
->
hash_Áûed
 = 1;

373  -
EIO
;

378 
	}
}

383 
	$vîôy_föish_io
(
dm_vîôy_io
 *
io
, 
îr‹
)

385 
dm_vîôy
 *
v
 = 
io
->v;

386 
bio
 *biÿ
	`dm_bio_‰om_≥r_bio_d©a
(
io
, 
v
->
ti
->
≥r_bio_d©a_size
);

388 
bio
->
bi_íd_io
 = 
io
->
‹ig_bi_íd_io
;

389 
bio
->
bi_¥iv©e
 = 
io
->
‹ig_bi_¥iv©e
;

391 
	`bio_ídio_nodec
(
bio
, 
îr‹
);

392 
	}
}

394 
	$vîôy_w‹k
(
w‹k_°ru˘
 *
w
)

396 
dm_vîôy_io
 *
io
 = 
	`c⁄èöî_of
(
w
, dm_vîôy_io, 
w‹k
);

398 
	`vîôy_föish_io
(
io
, 
	`vîôy_vîify_io
(io));

399 
	}
}

401 
	$vîôy_íd_io
(
bio
 *bio, 
îr‹
)

403 
dm_vîôy_io
 *
io
 = 
bio
->
bi_¥iv©e
;

405 i‡(
îr‹
) {

406 
	`vîôy_föish_io
(
io
, 
îr‹
);

410 
	`INIT_WORK
(&
io
->
w‹k
, 
vîôy_w‹k
);

411 
	`queue_w‹k
(
io
->
v
->
vîify_wq
, &io->
w‹k
);

412 
	}
}

419 
	$vîôy_¥e„tch_io
(
w‹k_°ru˘
 *
w‹k
)

421 
dm_vîôy_¥e„tch_w‹k
 *
pw
 =

422 
	`c⁄èöî_of
(
w‹k
, 
dm_vîôy_¥e„tch_w‹k
, work);

423 
dm_vîôy
 *
v
 = 
pw
->v;

424 
i
;

426 
i
 = 
v
->
Àvñs
 - 2; i >= 0; i--) {

427 
£˘‹_t
 
hash_block_°¨t
;

428 
£˘‹_t
 
hash_block_íd
;

429 
	`vîôy_hash_©_Àvñ
(
v
, 
pw
->
block
, 
i
, &
hash_block_°¨t
, 
NULL
);

430 
	`vîôy_hash_©_Àvñ
(
v
, 
pw
->
block
 +Öw->
n_blocks
 - 1, 
i
, &
hash_block_íd
, 
NULL
);

431 i‡(!
i
) {

432 
˛u°î
 = 
	`ACCESS_ONCE
(
dm_vîôy_¥e„tch_˛u°î
);

434 
˛u°î
 >>
v
->
d©a_dev_block_bôs
;

435 i‡(
	`u∆ikñy
(!
˛u°î
))

436 
no_¥e„tch_˛u°î
;

438 i‡(
	`u∆ikñy
(
˛u°î
 & (cluster - 1)))

439 
˛u°î
 = 1 << 
	`__Ês
(cluster);

441 
hash_block_°¨t
 &~(
£˘‹_t
)(
˛u°î
 - 1);

442 
hash_block_íd
 |
˛u°î
 - 1;

443 i‡(
	`u∆ikñy
(
hash_block_íd
 >
v
->
hash_blocks
))

444 
hash_block_íd
 = 
v
->
hash_blocks
 - 1;

446 
no_¥e„tch_˛u°î
:

447 
	`dm_bufio_¥e„tch
(
v
->
bufio
, 
hash_block_°¨t
,

448 
hash_block_íd
 - 
hash_block_°¨t
 + 1);

451 
	`k‰ì
(
pw
);

452 
	}
}

454 
	$vîôy_submô_¥e„tch
(
dm_vîôy
 *
v
, 
dm_vîôy_io
 *
io
)

456 
dm_vîôy_¥e„tch_w‹k
 *
pw
;

458 
pw
 = 
	`kmÆloc
((
dm_vîôy_¥e„tch_w‹k
),

459 
GFP_NOIO
 | 
__GFP_NORETRY
 | 
__GFP_NOMEMALLOC
 | 
__GFP_NOWARN
);

461 i‡(!
pw
)

464 
	`INIT_WORK
(&
pw
->
w‹k
, 
vîôy_¥e„tch_io
);

465 
pw
->
v
 = v;

466 
pw
->
block
 = 
io
->block;

467 
pw
->
n_blocks
 = 
io
->n_blocks;

468 
	`queue_w‹k
(
v
->
vîify_wq
, &
pw
->
w‹k
);

469 
	}
}

475 
	$vîôy_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

477 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

478 
dm_vîôy_io
 *
io
;

480 
bio
->
bi_bdev
 = 
v
->
d©a_dev
->
bdev
;

481 
bio
->
bi_ôî
.
bi_£˘‹
 = 
	`vîôy_m≠_£˘‹
(
v
, bio->bi_iter.bi_sector);

483 i‡((()
bio
->
bi_ôî
.
bi_£˘‹
 | 
	`bio_£˘‹s
(bio)) &

484 ((1 << (
v
->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
)) - 1)) {

485 
	`DMERR_LIMIT
("unaligned io");

486  -
EIO
;

489 i‡(
	`bio_íd_£˘‹
(
bio
) >>

490 (
v
->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
Ë> v->
d©a_blocks
) {

491 
	`DMERR_LIMIT
("io out ofÑange");

492  -
EIO
;

495 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
)

496  -
EIO
;

498 
io
 = 
	`dm_≥r_bio_d©a
(
bio
, 
ti
->
≥r_bio_d©a_size
);

499 
io
->
v
 = v;

500 
io
->
‹ig_bi_íd_io
 = 
bio
->
bi_íd_io
;

501 
io
->
‹ig_bi_¥iv©e
 = 
bio
->
bi_¥iv©e
;

502 
io
->
block
 = 
bio
->
bi_ôî
.
bi_£˘‹
 >> (
v
->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
);

503 
io
->
n_blocks
 = 
bio
->
bi_ôî
.
bi_size
 >> 
v
->
d©a_dev_block_bôs
;

505 
bio
->
bi_íd_io
 = 
vîôy_íd_io
;

506 
bio
->
bi_¥iv©e
 = 
io
;

507 
io
->
ôî
 = 
bio
->
bi_ôî
;

509 
	`vîôy_submô_¥e„tch
(
v
, 
io
);

511 
	`gíîic_make_ªque°
(
bio
);

513  
DM_MAPIO_SUBMITTED
;

514 
	}
}

519 
	$vîôy_°©us
(
dm_èrgë
 *
ti
, 
°©us_ty≥_t
 
ty≥
,

520 
°©us_Êags
, *
ªsu…
, 
maxÀn
)

522 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

523 
sz
 = 0;

524 
x
;

526 
ty≥
) {

527 
STATUSTYPE_INFO
:

528 
	`DMEMIT
("%c", 
v
->
hash_Áûed
 ? 'C' : 'V');

530 
STATUSTYPE_TABLE
:

531 
	`DMEMIT
("%u %s %s %u %u %llu %llu %s ",

532 
v
->
vîsi⁄
,

533 
v
->
d©a_dev
->
«me
,

534 
v
->
hash_dev
->
«me
,

535 1 << 
v
->
d©a_dev_block_bôs
,

536 1 << 
v
->
hash_dev_block_bôs
,

537 ()
v
->
d©a_blocks
,

538 ()
v
->
hash_°¨t
,

539 
v
->
Æg_«me


541 
x
 = 0; x < 
v
->
dige°_size
; x++)

542 
	`DMEMIT
("%02x", 
v
->
roŸ_dige°
[
x
]);

543 
	`DMEMIT
(" ");

544 i‡(!
v
->
ß…_size
)

545 
	`DMEMIT
("-");

547 
x
 = 0; x < 
v
->
ß…_size
; x++)

548 
	`DMEMIT
("%02x", 
v
->
ß…
[
x
]);

551 
	}
}

553 
	$vîôy_io˘l
(
dm_èrgë
 *
ti
, 
cmd
,

554 
¨g
)

556 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

557 
r
 = 0;

559 i‡(
v
->
d©a_°¨t
 ||

560 
ti
->
Àn
 !
	`i_size_ªad
(
v
->
d©a_dev
->
bdev
->
bd_öode
Ë>> 
SECTOR_SHIFT
)

561 
r
 = 
	`scsi_vîify_blk_io˘l
(
NULL
, 
cmd
);

563  
r
 ? : 
	`__blkdev_drivî_io˘l
(
v
->
d©a_dev
->
bdev
, v->d©a_dev->
mode
,

564 
cmd
, 
¨g
);

565 
	}
}

567 
	$vîôy_mîge
(
dm_èrgë
 *
ti
, 
bvec_mîge_d©a
 *
bvm
,

568 
bio_vec
 *
biovec
, 
max_size
)

570 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

571 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
v
->
d©a_dev
->
bdev
);

573 i‡(!
q
->
mîge_bvec_‚
)

574  
max_size
;

576 
bvm
->
bi_bdev
 = 
v
->
d©a_dev
->
bdev
;

577 
bvm
->
bi_£˘‹
 = 
	`vîôy_m≠_£˘‹
(
v
, bvm->bi_sector);

579  
	`mö
(
max_size
, 
q
->
	`mîge_bvec_‚
(q, 
bvm
, 
biovec
));

580 
	}
}

582 
	$vîôy_ôî©e_devi˚s
(
dm_èrgë
 *
ti
,

583 
ôî©e_devi˚s_ˇŒout_‚
 
‚
, *
d©a
)

585 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

587  
	`‚
(
ti
, 
v
->
d©a_dev
, v->
d©a_°¨t
,Åi->
Àn
, 
d©a
);

588 
	}
}

590 
	$vîôy_io_höts
(
dm_èrgë
 *
ti
, 
queue_limôs
 *
limôs
)

592 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

594 i‡(
limôs
->
logiˇl_block_size
 < 1 << 
v
->
d©a_dev_block_bôs
)

595 
limôs
->
logiˇl_block_size
 = 1 << 
v
->
d©a_dev_block_bôs
;

597 i‡(
limôs
->
physiˇl_block_size
 < 1 << 
v
->
d©a_dev_block_bôs
)

598 
limôs
->
physiˇl_block_size
 = 1 << 
v
->
d©a_dev_block_bôs
;

600 
	`blk_limôs_io_mö
(
limôs
,Üimôs->
logiˇl_block_size
);

601 
	}
}

603 
	$vîôy_då
(
dm_èrgë
 *
ti
)

605 
dm_vîôy
 *
v
 = 
ti
->
¥iv©e
;

607 i‡(
v
->
vîify_wq
)

608 
	`de°roy_w‹kqueue
(
v
->
vîify_wq
);

610 i‡(
v
->
vec_mempoﬁ
)

611 
	`mempoﬁ_de°roy
(
v
->
vec_mempoﬁ
);

613 i‡(
v
->
bufio
)

614 
	`dm_bufio_˛õ¡_de°roy
(
v
->
bufio
);

616 
	`k‰ì
(
v
->
ß…
);

617 
	`k‰ì
(
v
->
roŸ_dige°
);

619 i‡(
v
->
tfm
)

620 
	`¸y±o_‰ì_shash
(
v
->
tfm
);

622 
	`k‰ì
(
v
->
Æg_«me
);

624 i‡(
v
->
hash_dev
)

625 
	`dm_put_devi˚
(
ti
, 
v
->
hash_dev
);

627 i‡(
v
->
d©a_dev
)

628 
	`dm_put_devi˚
(
ti
, 
v
->
d©a_dev
);

630 
	`k‰ì
(
v
);

631 
	}
}

647 
	$vîôy_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

649 
dm_vîôy
 *
v
;

650 
num
;

651 
num_Œ
;

652 
r
;

653 
i
;

654 
£˘‹_t
 
hash_posôi⁄
;

655 
dummy
;

657 
v
 = 
	`kzÆloc
((
dm_vîôy
), 
GFP_KERNEL
);

658 i‡(!
v
) {

659 
ti
->
îr‹
 = "Cannotállocate verity structure";

660  -
ENOMEM
;

662 
ti
->
¥iv©e
 = 
v
;

663 
v
->
ti
 =Åi;

665 i‡((
	`dm_èbÀ_gë_mode
(
ti
->
èbÀ
Ë& ~
FMODE_READ
)) {

666 
ti
->
îr‹
 = "Device must beÑeadonly";

667 
r
 = -
EINVAL
;

668 
bad
;

671 i‡(
¨gc
 != 10) {

672 
ti
->
îr‹
 = "Invalidárgument count:Éxactly 10árgumentsÑequired";

673 
r
 = -
EINVAL
;

674 
bad
;

677 i‡(
	`ssˇnf
(
¨gv
[0], "%u%c", &
num
, &
dummy
) != 1 ||

678 
num
 > 1) {

679 
ti
->
îr‹
 = "Invalid version";

680 
r
 = -
EINVAL
;

681 
bad
;

683 
v
->
vîsi⁄
 = 
num
;

685 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[1], 
FMODE_READ
, &
v
->
d©a_dev
);

686 i‡(
r
) {

687 
ti
->
îr‹
 = "Data deviceÜookup failed";

688 
bad
;

691 
r
 = 
	`dm_gë_devi˚
(
ti
, 
¨gv
[2], 
FMODE_READ
, &
v
->
hash_dev
);

692 i‡(
r
) {

693 
ti
->
îr‹
 = "Data deviceÜookup failed";

694 
bad
;

697 i‡(
	`ssˇnf
(
¨gv
[3], "%u%c", &
num
, &
dummy
) != 1 ||

698 !
num
 || (num & (num - 1)) ||

699 
num
 < 
	`bdev_logiˇl_block_size
(
v
->
d©a_dev
->
bdev
) ||

700 
num
 > 
PAGE_SIZE
) {

701 
ti
->
îr‹
 = "Invalid data device block size";

702 
r
 = -
EINVAL
;

703 
bad
;

705 
v
->
d©a_dev_block_bôs
 = 
	`__ffs
(
num
);

707 i‡(
	`ssˇnf
(
¨gv
[4], "%u%c", &
num
, &
dummy
) != 1 ||

708 !
num
 || (num & (num - 1)) ||

709 
num
 < 
	`bdev_logiˇl_block_size
(
v
->
hash_dev
->
bdev
) ||

710 
num
 > 
INT_MAX
) {

711 
ti
->
îr‹
 = "Invalid hash device block size";

712 
r
 = -
EINVAL
;

713 
bad
;

715 
v
->
hash_dev_block_bôs
 = 
	`__ffs
(
num
);

717 i‡(
	`ssˇnf
(
¨gv
[5], "%Œu%c", &
num_Œ
, &
dummy
) != 1 ||

718 (
£˘‹_t
)(
num_Œ
 << (
v
->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
))

719 >> (
v
->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
Ë!
num_Œ
) {

720 
ti
->
îr‹
 = "Invalid data blocks";

721 
r
 = -
EINVAL
;

722 
bad
;

724 
v
->
d©a_blocks
 = 
num_Œ
;

726 i‡(
ti
->
Àn
 > (
v
->
d©a_blocks
 << (v->
d©a_dev_block_bôs
 - 
SECTOR_SHIFT
))) {

727 
ti
->
îr‹
 = "Data device isÅoo small";

728 
r
 = -
EINVAL
;

729 
bad
;

732 i‡(
	`ssˇnf
(
¨gv
[6], "%Œu%c", &
num_Œ
, &
dummy
) != 1 ||

733 (
£˘‹_t
)(
num_Œ
 << (
v
->
hash_dev_block_bôs
 - 
SECTOR_SHIFT
))

734 >> (
v
->
hash_dev_block_bôs
 - 
SECTOR_SHIFT
Ë!
num_Œ
) {

735 
ti
->
îr‹
 = "Invalid hash start";

736 
r
 = -
EINVAL
;

737 
bad
;

739 
v
->
hash_°¨t
 = 
num_Œ
;

741 
v
->
Æg_«me
 = 
	`k°rdup
(
¨gv
[7], 
GFP_KERNEL
);

742 i‡(!
v
->
Æg_«me
) {

743 
ti
->
îr‹
 = "CannotállocateálgorithmÇame";

744 
r
 = -
ENOMEM
;

745 
bad
;

748 
v
->
tfm
 = 
	`¸y±o_Æloc_shash
(v->
Æg_«me
, 0, 0);

749 i‡(
	`IS_ERR
(
v
->
tfm
)) {

750 
ti
->
îr‹
 = "Cannot initialize hash function";

751 
r
 = 
	`PTR_ERR
(
v
->
tfm
);

752 
v
->
tfm
 = 
NULL
;

753 
bad
;

755 
v
->
dige°_size
 = 
	`¸y±o_shash_dige°size
(v->
tfm
);

756 i‡((1 << 
v
->
hash_dev_block_bôs
Ë< v->
dige°_size
 * 2) {

757 
ti
->
îr‹
 = "Digest sizeÅoo big";

758 
r
 = -
EINVAL
;

759 
bad
;

761 
v
->
shash_descsize
 =

762 (
shash_desc
Ë+ 
	`¸y±o_shash_descsize
(
v
->
tfm
);

764 
v
->
roŸ_dige°
 = 
	`kmÆloc
(v->
dige°_size
, 
GFP_KERNEL
);

765 i‡(!
v
->
roŸ_dige°
) {

766 
ti
->
îr‹
 = "CannotállocateÑoot digest";

767 
r
 = -
ENOMEM
;

768 
bad
;

770 i‡(
	`°æí
(
¨gv
[8]Ë!
v
->
dige°_size
 * 2 ||

771 
	`hex2bö
(
v
->
roŸ_dige°
, 
¨gv
[8], v->
dige°_size
)) {

772 
ti
->
îr‹
 = "InvalidÑoot digest";

773 
r
 = -
EINVAL
;

774 
bad
;

777 i‡(
	`°rcmp
(
¨gv
[9], "-")) {

778 
v
->
ß…_size
 = 
	`°æí
(
¨gv
[9]) / 2;

779 
v
->
ß…
 = 
	`kmÆloc
(v->
ß…_size
, 
GFP_KERNEL
);

780 i‡(!
v
->
ß…
) {

781 
ti
->
îr‹
 = "Cannotállocate salt";

782 
r
 = -
ENOMEM
;

783 
bad
;

785 i‡(
	`°æí
(
¨gv
[9]Ë!
v
->
ß…_size
 * 2 ||

786 
	`hex2bö
(
v
->
ß…
, 
¨gv
[9], v->
ß…_size
)) {

787 
ti
->
îr‹
 = "Invalid salt";

788 
r
 = -
EINVAL
;

789 
bad
;

793 
v
->
hash_≥r_block_bôs
 =

794 
	`__Ês
((1 << 
v
->
hash_dev_block_bôs
Ë/ v->
dige°_size
);

796 
v
->
Àvñs
 = 0;

797 i‡(
v
->
d©a_blocks
)

798 
v
->
hash_≥r_block_bôs
 * v->
Àvñs
 < 64 &&

799 ()(
v
->
d©a_blocks
 - 1) >>

800 (
v
->
hash_≥r_block_bôs
 * v->
Àvñs
))

801 
v
->
Àvñs
++;

803 i‡(
v
->
Àvñs
 > 
DM_VERITY_MAX_LEVELS
) {

804 
ti
->
îr‹
 = "Too manyÅreeÜevels";

805 
r
 = -
E2BIG
;

806 
bad
;

809 
hash_posôi⁄
 = 
v
->
hash_°¨t
;

810 
i
 = 
v
->
Àvñs
 - 1; i >= 0; i--) {

811 
£˘‹_t
 
s
;

812 
v
->
hash_Àvñ_block
[
i
] = 
hash_posôi⁄
;

813 
s
 = (
v
->
d©a_blocks
 + ((
£˘‹_t
)1 << ((
i
 + 1Ë* v->
hash_≥r_block_bôs
)) - 1)

814 >> ((
i
 + 1Ë* 
v
->
hash_≥r_block_bôs
);

815 i‡(
hash_posôi⁄
 + 
s
 < hash_position) {

816 
ti
->
îr‹
 = "Hash device offset overflow";

817 
r
 = -
E2BIG
;

818 
bad
;

820 
hash_posôi⁄
 +
s
;

822 
v
->
hash_blocks
 = 
hash_posôi⁄
;

824 
v
->
bufio
 = 
	`dm_bufio_˛õ¡_¸óã
(v->
hash_dev
->
bdev
,

825 1 << 
v
->
hash_dev_block_bôs
, 1, (
buf„r_aux
),

826 
dm_bufio_Æloc_ˇŒback
, 
NULL
);

827 i‡(
	`IS_ERR
(
v
->
bufio
)) {

828 
ti
->
îr‹
 = "Cannot initialize dm-bufio";

829 
r
 = 
	`PTR_ERR
(
v
->
bufio
);

830 
v
->
bufio
 = 
NULL
;

831 
bad
;

834 i‡(
	`dm_bufio_gë_devi˚_size
(
v
->
bufio
Ë< v->
hash_blocks
) {

835 
ti
->
îr‹
 = "Hash device isÅoo small";

836 
r
 = -
E2BIG
;

837 
bad
;

840 
ti
->
≥r_bio_d©a_size
 = 
	`roundup
((
dm_vîôy_io
Ë+ 
v
->
shash_descsize
 + v->
dige°_size
 * 2, 
	`__Æignof__
(dm_verity_io));

842 
v
->
vec_mempoﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
DM_VERITY_MEMPOOL_SIZE
,

843 
BIO_MAX_PAGES
 * (
bio_vec
));

844 i‡(!
v
->
vec_mempoﬁ
) {

845 
ti
->
îr‹
 = "Cannotállocate vector mempool";

846 
r
 = -
ENOMEM
;

847 
bad
;

851 
v
->
vîify_wq
 = 
	`Æloc_w‹kqueue
("kvîôyd", 
WQ_CPU_INTENSIVE
 | 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 
	`num_⁄löe_˝us
());

852 i‡(!
v
->
vîify_wq
) {

853 
ti
->
îr‹
 = "Cannotállocate workqueue";

854 
r
 = -
ENOMEM
;

855 
bad
;

860 
bad
:

861 
	`vîôy_då
(
ti
);

863  
r
;

864 
	}
}

866 
èrgë_ty≥
 
	gvîôy_èrgë
 = {

867 .
«me
 = "verity",

868 .
	gvîsi⁄
 = {1, 2, 0},

869 .
	gmoduÀ
 = 
THIS_MODULE
,

870 .
	g˘r
 = 
vîôy_˘r
,

871 .
	gdå
 = 
vîôy_då
,

872 .
	gm≠
 = 
vîôy_m≠
,

873 .
	g°©us
 = 
vîôy_°©us
,

874 .
	gio˘l
 = 
vîôy_io˘l
,

875 .
	gmîge
 = 
vîôy_mîge
,

876 .
	gôî©e_devi˚s
 = 
vîôy_ôî©e_devi˚s
,

877 .
	gio_höts
 = 
vîôy_io_höts
,

880 
__öô
 
	$dm_vîôy_öô
()

882 
r
;

884 
r
 = 
	`dm_ªgi°î_èrgë
(&
vîôy_èrgë
);

885 i‡(
r
 < 0)

886 
	`DMERR
("ªgi°î faûed %d", 
r
);

888  
r
;

889 
	}
}

891 
__exô
 
	$dm_vîôy_exô
()

893 
	`dm_uƒegi°î_èrgë
(&
vîôy_èrgë
);

894 
	}
}

896 
moduÀ_öô
(
dm_vîôy_öô
);

897 
moduÀ_exô
(
dm_vîôy_exô
);

899 
MODULE_AUTHOR
("Mikulas Patocka <mpatocka@redhat.com>");

900 
MODULE_AUTHOR
("Mandeep Baines <msb@chromium.org>");

901 
MODULE_AUTHOR
("Will Drewry <wad@chromium.org>");

902 
MODULE_DESCRIPTION
(
DM_NAME
 "Åarget forÅransparent disk integrity checking");

903 
MODULE_LICENSE
("GPL");

	@dm-verity.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x47c8baf4, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_uöt
) },

24 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

25 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

26 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

27 { 0x63c4d61f, 
__VMLINUX_SYMBOL_STR
(
__bôm≠_weight
) },

28 { 0xbd100793, 
__VMLINUX_SYMBOL_STR
(
˝u_⁄löe_mask
) },

29 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

30 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

31 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

32 { 0x9c256008, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_devi˚_size
) },

33 { 0x486e239f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_¸óã
) },

34 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
°rcmp
) },

35 { 0x5377e556, 
__VMLINUX_SYMBOL_STR
(
hex2bö
) },

36 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

37 { 0x82cb7df, 
__VMLINUX_SYMBOL_STR
(
¸y±o_Æloc_shash
) },

38 { 0xc499´1e, 
__VMLINUX_SYMBOL_STR
(
k°rdup
) },

39 { 0xf92d9198, 
__VMLINUX_SYMBOL_STR
(
dm_gë_devi˚
) },

40 { 0x20c55´0, 
__VMLINUX_SYMBOL_STR
(
ssˇnf
) },

41 { 0x6d0f1f89, 
__VMLINUX_SYMBOL_STR
(
dm_èbÀ_gë_mode
) },

42 { 0xa448e19f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_¥e„tch
) },

43 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

44 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

45 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

46 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

47 { 0x4629334c, 
__VMLINUX_SYMBOL_STR
(
__¥ìm±_cou¡
) },

48 { 0xb781414f, 
__VMLINUX_SYMBOL_STR
(
dm_put_devi˚
) },

49 { 0x18489876, 
__VMLINUX_SYMBOL_STR
(
¸y±o_de°roy_tfm
) },

50 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

51 { 0xeˇ7949e, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_de°roy
) },

52 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

53 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

54 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

55 { 0xecd85ddb, 
__VMLINUX_SYMBOL_STR
(
bio_ídio_nodec
) },

56 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

57 { 0xb138d0bf, 
__VMLINUX_SYMBOL_STR
(
dm_øãlimô_°©e
) },

58 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

59 { 0xe6024e59, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªÀa£
) },

60 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

61 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

62 { 0xf7026158, 
__VMLINUX_SYMBOL_STR
(
¸y±o_shash_föÆ
) },

63 { 0xfdc8de49, 
__VMLINUX_SYMBOL_STR
(
¸y±o_shash_upd©e
) },

64 { 0xa1d2413a, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªad
) },

65 { 0x74dcd98c, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_aux_d©a
) },

66 { 0x4ˇ9669f, 
__VMLINUX_SYMBOL_STR
(
s˙¥ötf
) },

67 { 0xf8c0f16e, 
__VMLINUX_SYMBOL_STR
(
__blkdev_drivî_io˘l
) },

68 { 0x4df6e7a2, 
__VMLINUX_SYMBOL_STR
(
scsi_vîify_blk_io˘l
) },

69 { 0x118a5e56, 
__VMLINUX_SYMBOL_STR
(
blk_limôs_io_mö
) },

70 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

73 c⁄° 
	g__moduÀ_dïíds
[]

74 
__u£d


75 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

79 
MODULE_INFO
(
§cvîsi⁄
, "D4773F4967B7B8F756537E1");

	@dm-zero.c

7 
	~<löux/devi˚-m≠≥r.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/öô.h
>

11 
	~<löux/bio.h
>

13 
	#DM_MSG_PREFIX
 "zîo"

	)

18 
	$zîo_˘r
(
dm_èrgë
 *
ti
, 
¨gc
, **
¨gv
)

20 i‡(
¨gc
 != 0) {

21 
ti
->
îr‹
 = "NoárgumentsÑequired";

22  -
EINVAL
;

28 
ti
->
num_disˇrd_bios
 = 1;

31 
	}
}

36 
	$zîo_m≠
(
dm_èrgë
 *
ti
, 
bio
 *bio)

38 
	`bio_rw
(
bio
)) {

39 
READ
:

40 
	`zîo_fûl_bio
(
bio
);

42 
READA
:

44  -
EIO
;

45 
WRITE
:

50 
	`bio_ídio
(
bio
, 0);

53  
DM_MAPIO_SUBMITTED
;

54 
	}
}

56 
èrgë_ty≥
 
	gzîo_èrgë
 = {

57 .
«me
 = "zero",

58 .
	gvîsi⁄
 = {1, 1, 0},

59 .
	gmoduÀ
 = 
THIS_MODULE
,

60 .
	g˘r
 = 
zîo_˘r
,

61 .
	gm≠
 = 
zîo_m≠
,

64 
__öô
 
	$dm_zîo_öô
()

66 
r
 = 
	`dm_ªgi°î_èrgë
(&
zîo_èrgë
);

68 i‡(
r
 < 0)

69 
	`DMERR
("ªgi°î faûed %d", 
r
);

71  
r
;

72 
	}
}

74 
__exô
 
	$dm_zîo_exô
()

76 
	`dm_uƒegi°î_èrgë
(&
zîo_èrgë
);

77 
	}
}

79 
	$moduÀ_öô
(
dm_zîo_öô
)

80 
	$moduÀ_exô
(
dm_zîo_exô
)

82 
	`MODULE_AUTHOR
("Jana Saout <jana@saout.de>");

83 
	`MODULE_DESCRIPTION
(
DM_NAME
 " dummyÅargetÑeturning zeros");

84 
	`MODULE_LICENSE
("GPL");

	@dm-zero.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xcde055a1, 
__VMLINUX_SYMBOL_STR
(
dm_uƒegi°î_èrgë
) },

24 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

25 { 0x6b76d57e, 
__VMLINUX_SYMBOL_STR
(
dm_ªgi°î_èrgë
) },

26 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

27 { 0x869526c5, 
__VMLINUX_SYMBOL_STR
(
zîo_fûl_bio
) },

28 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

31 c⁄° 
	g__moduÀ_dïíds
[]

32 
__u£d


33 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

37 
MODULE_INFO
(
§cvîsi⁄
, "A53E3D4E3ECF5F477CDB7A7");

	@dm.c

8 
	~"dm.h
"

9 
	~"dm-uevít.h
"

11 
	~<löux/öô.h
>

12 
	~<löux/moduÀ.h
>

13 
	~<löux/muãx.h
>

14 
	~<löux/moduÀ∑øm.h
>

15 
	~<löux/blkpg.h
>

16 
	~<löux/bio.h
>

17 
	~<löux/mempoﬁ.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/idr.h
>

20 
	~<löux/hdªg.h
>

21 
	~<löux/dñay.h
>

23 
	~<åa˚/evíts/block.h
>

25 
	#DM_MSG_PREFIX
 "c‹e"

	)

27 #ifde‡
CONFIG_PRINTK


31 
DEFINE_RATELIMIT_STATE
(
dm_øãlimô_°©e
,

32 
DEFAULT_RATELIMIT_INTERVAL
,

33 
DEFAULT_RATELIMIT_BURST
);

34 
EXPORT_SYMBOL
(
dm_øãlimô_°©e
);

41 
	#DM_COOKIE_ENV_VAR_NAME
 "DM_COOKIE"

	)

42 
	#DM_COOKIE_LENGTH
 24

	)

44 c⁄° *
	g_«me
 = 
DM_NAME
;

46 
	gmaj‹
 = 0;

47 
	g_maj‹
 = 0;

49 
DEFINE_IDR
(
_mö‹_idr
);

51 
DEFINE_SPINLOCK
(
_mö‹_lock
);

53 
do_de„ºed_ªmove
(
w‹k_°ru˘
 *
w
);

55 
DECLARE_WORK
(
de„ºed_ªmove_w‹k
, 
do_de„ºed_ªmove
);

57 
w‹kqueue_°ru˘
 *
	gde„ºed_ªmove_w‹kqueue
;

63 
	sdm_io
 {

64 
m≠≥d_devi˚
 *
	mmd
;

65 
	mîr‹
;

66 
©omic_t
 
	mio_cou¡
;

67 
bio
 *
	mbio
;

68 
	m°¨t_time
;

69 
•ölock_t
 
	mídio_lock
;

70 
dm_°©s_aux
 
	m°©s_aux
;

77 
	sdm_rq_èrgë_io
 {

78 
m≠≥d_devi˚
 *
	mmd
;

79 
dm_èrgë
 *
	mti
;

80 
ªque°
 *
	m‹ig
, 
	m˛⁄e
;

81 
	mîr‹
;

82 
m≠_öfo
 
	möfo
;

93 
	sdm_rq_˛⁄e_bio_öfo
 {

94 
bio
 *
	m‹ig
;

95 
dm_rq_èrgë_io
 *
	mtio
;

96 
bio
 
	m˛⁄e
;

99 
m≠_öfo
 *
	$dm_gë_rq_m≠öfo
(
ªque°
 *
rq
)

101 i‡(
rq
 &&Ñq->
íd_io_d©a
)

102  &((
dm_rq_èrgë_io
 *)
rq
->
íd_io_d©a
)->
öfo
;

103  
NULL
;

104 
	}
}

105 
EXPORT_SYMBOL_GPL
(
dm_gë_rq_m≠öfo
);

107 
	#MINOR_ALLOCED
 ((*)-1)

	)

112 
	#DMF_BLOCK_IO_FOR_SUSPEND
 0

	)

113 
	#DMF_SUSPENDED
 1

	)

114 
	#DMF_FROZEN
 2

	)

115 
	#DMF_FREEING
 3

	)

116 
	#DMF_DELETING
 4

	)

117 
	#DMF_NOFLUSH_SUSPENDING
 5

	)

118 
	#DMF_MERGE_IS_OPTIONAL
 6

	)

119 
	#DMF_DEFERRED_REMOVE
 7

	)

125 
	sdm_èbÀ
 {

126 
	mundeföed__
;

132 
	sm≠≥d_devi˚
 {

133 
§cu_°ru˘
 
	mio_b¨rõr
;

134 
muãx
 
	msu•íd_lock
;

135 
©omic_t
 
	mhﬁdîs
;

136 
©omic_t
 
	m›í_cou¡
;

143 
dm_èbÀ
 *
	mm≠
;

145 
li°_hód
 
	mèbÀ_devi˚s
;

146 
muãx
 
	mèbÀ_devi˚s_lock
;

148 
	mÊags
;

150 
ªque°_queue
 *
	mqueue
;

151 
	mty≥
;

153 
muãx
 
	mty≥_lock
;

155 
èrgë_ty≥
 *
	mimmuèbÀ_èrgë_ty≥
;

157 
gídisk
 *
	mdisk
;

158 
	m«me
[16];

160 *
	möãrÁ˚_±r
;

165 
©omic_t
 
	m≥ndög
[2];

166 
waô_queue_hód_t
 
	mwaô
;

167 
w‹k_°ru˘
 
	mw‹k
;

168 
bio_li°
 
	mde„ºed
;

169 
•ölock_t
 
	mde„ºed_lock
;

174 
w‹kqueue_°ru˘
 *
	mwq
;

179 
mempoﬁ_t
 *
	mio_poﬁ
;

181 
bio_£t
 *
	mbs
;

186 
©omic_t
 
	mevít_ƒ
;

187 
waô_queue_hód_t
 
	mevítq
;

188 
©omic_t
 
	muevít_£q
;

189 
li°_hód
 
	muevít_li°
;

190 
•ölock_t
 
	muevít_lock
;

195 
su≥r_block
 *
	m‰ozí_sb
;

196 
block_devi˚
 *
	mbdev
;

199 
hd_geomëry
 
	mgeomëry
;

202 
dm_kobje˘_hﬁdî
 
	mkobj_hﬁdî
;

205 
bio
 
	mÊush_bio
;

207 
dm_°©s
 
	m°©s
;

213 
	sdm_md_mempoﬁs
 {

214 
mempoﬁ_t
 *
	mio_poﬁ
;

215 
bio_£t
 *
	mbs
;

218 
	sèbÀ_devi˚
 {

219 
li°_hód
 
	mli°
;

220 
©omic_t
 
	mcou¡
;

221 
dm_dev
 
	mdm_dev
;

224 
	#RESERVED_BIO_BASED_IOS
 16

	)

225 
	#RESERVED_REQUEST_BASED_IOS
 256

	)

226 
	#RESERVED_MAX_IOS
 1024

	)

227 
kmem_ˇche
 *
	g_io_ˇche
;

228 
kmem_ˇche
 *
	g_rq_tio_ˇche
;

233 
	gª£rved_bio_ba£d_ios
 = 
RESERVED_BIO_BASED_IOS
;

238 
	gª£rved_rq_ba£d_ios
 = 
RESERVED_REQUEST_BASED_IOS
;

240 
	$__dm_gë_ª£rved_ios
(*
ª£rved_ios
,

241 
def
, 
max
)

243 
ios
 = 
	`ACCESS_ONCE
(*
ª£rved_ios
);

244 
modifõd_ios
 = 0;

246 i‡(!
ios
)

247 
modifõd_ios
 = 
def
;

248 i‡(
ios
 > 
max
)

249 
modifõd_ios
 = 
max
;

251 i‡(
modifõd_ios
) {

252 ()
	`cmpxchg
(
ª£rved_ios
, 
ios
, 
modifõd_ios
);

253 
ios
 = 
modifõd_ios
;

256  
ios
;

257 
	}
}

259 
	$dm_gë_ª£rved_bio_ba£d_ios
()

261  
	`__dm_gë_ª£rved_ios
(&
ª£rved_bio_ba£d_ios
,

262 
RESERVED_BIO_BASED_IOS
, 
RESERVED_MAX_IOS
);

263 
	}
}

264 
EXPORT_SYMBOL_GPL
(
dm_gë_ª£rved_bio_ba£d_ios
);

266 
	$dm_gë_ª£rved_rq_ba£d_ios
()

268  
	`__dm_gë_ª£rved_ios
(&
ª£rved_rq_ba£d_ios
,

269 
RESERVED_REQUEST_BASED_IOS
, 
RESERVED_MAX_IOS
);

270 
	}
}

271 
EXPORT_SYMBOL_GPL
(
dm_gë_ª£rved_rq_ba£d_ios
);

273 
__öô
 
	$loˇl_öô
()

275 
r
 = -
ENOMEM
;

278 
_io_ˇche
 = 
	`KMEM_CACHE
(
dm_io
, 0);

279 i‡(!
_io_ˇche
)

280  
r
;

282 
_rq_tio_ˇche
 = 
	`KMEM_CACHE
(
dm_rq_èrgë_io
, 0);

283 i‡(!
_rq_tio_ˇche
)

284 
out_‰ì_io_ˇche
;

286 
r
 = 
	`dm_uevít_öô
();

287 i‡(
r
)

288 
out_‰ì_rq_tio_ˇche
;

290 
de„ºed_ªmove_w‹kqueue
 = 
	`Æloc_w‹kqueue
("kdmªmove", 
WQ_UNBOUND
, 1);

291 i‡(!
de„ºed_ªmove_w‹kqueue
) {

292 
r
 = -
ENOMEM
;

293 
out_uevít_exô
;

296 
_maj‹
 = 
maj‹
;

297 
r
 = 
	`ªgi°î_blkdev
(
_maj‹
, 
_«me
);

298 i‡(
r
 < 0)

299 
out_‰ì_w‹kqueue
;

301 i‡(!
_maj‹
)

302 
_maj‹
 = 
r
;

306 
out_‰ì_w‹kqueue
:

307 
	`de°roy_w‹kqueue
(
de„ºed_ªmove_w‹kqueue
);

308 
out_uevít_exô
:

309 
	`dm_uevít_exô
();

310 
out_‰ì_rq_tio_ˇche
:

311 
	`kmem_ˇche_de°roy
(
_rq_tio_ˇche
);

312 
out_‰ì_io_ˇche
:

313 
	`kmem_ˇche_de°roy
(
_io_ˇche
);

315  
r
;

316 
	}
}

318 
	$loˇl_exô
()

320 
	`Êush_scheduÀd_w‹k
();

321 
	`de°roy_w‹kqueue
(
de„ºed_ªmove_w‹kqueue
);

323 
	`kmem_ˇche_de°roy
(
_rq_tio_ˇche
);

324 
	`kmem_ˇche_de°roy
(
_io_ˇche
);

325 
	`uƒegi°î_blkdev
(
_maj‹
, 
_«me
);

326 
	`dm_uevít_exô
();

328 
_maj‹
 = 0;

330 
	`DMINFO
("cleaned up");

331 
	}
}

333 (*
_öôs
[])(Ë
__öôd©a
 = {

334 
loˇl_öô
,

335 
dm_èrgë_öô
,

336 
dm_löór_öô
,

337 
dm_°rùe_öô
,

338 
dm_io_öô
,

339 
dm_kc›yd_öô
,

340 
dm_öãrÁ˚_öô
,

341 
dm_°©i°ics_öô
,

342 
	}
};

344 (*
_exôs
[])() = {

345 
loˇl_exô
,

346 
dm_èrgë_exô
,

347 
dm_löór_exô
,

348 
dm_°rùe_exô
,

349 
dm_io_exô
,

350 
dm_kc›yd_exô
,

351 
dm_öãrÁ˚_exô
,

352 
dm_°©i°ics_exô
,

353 
	}
};

355 
__öô
 
	$dm_öô
()

357 c⁄° 
cou¡
 = 
	`ARRAY_SIZE
(
_öôs
);

359 
r
, 
i
;

361 
i
 = 0; i < 
cou¡
; i++) {

362 
r
 = 
_öôs
[
i
]();

363 i‡(
r
)

364 
bad
;

369 
bad
:

370 
i
--)

371 
_exôs
[
i
]();

373  
r
;

374 
	}
}

376 
__exô
 
	$dm_exô
()

378 
i
 = 
	`ARRAY_SIZE
(
_exôs
);

380 
i
--)

381 
_exôs
[
i
]();

386 
	`idr_de°roy
(&
_mö‹_idr
);

387 
	}
}

392 
	$dm_dñëög_md
(
m≠≥d_devi˚
 *
md
)

394  
	`ã°_bô
(
DMF_DELETING
, &
md
->
Êags
);

395 
	}
}

397 
	$dm_blk_›í
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
)

399 
m≠≥d_devi˚
 *
md
;

401 
	`•ö_lock
(&
_mö‹_lock
);

403 
md
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

404 i‡(!
md
)

405 
out
;

407 i‡(
	`ã°_bô
(
DMF_FREEING
, &
md
->
Êags
) ||

408 
	`dm_dñëög_md
(
md
)) {

409 
md
 = 
NULL
;

410 
out
;

413 
	`dm_gë
(
md
);

414 
	`©omic_öc
(&
md
->
›í_cou¡
);

416 
out
:

417 
	`•ö_u∆ock
(&
_mö‹_lock
);

419  
md
 ? 0 : -
ENXIO
;

420 
	}
}

422 
	$dm_blk_˛o£
(
gídisk
 *
disk
, 
fmode_t
 
mode
)

424 
m≠≥d_devi˚
 *
md
 = 
disk
->
¥iv©e_d©a
;

426 
	`•ö_lock
(&
_mö‹_lock
);

428 i‡(
	`©omic_dec_™d_ã°
(&
md
->
›í_cou¡
) &&

429 (
	`ã°_bô
(
DMF_DEFERRED_REMOVE
, &
md
->
Êags
)))

430 
	`queue_w‹k
(
de„ºed_ªmove_w‹kqueue
, &
de„ºed_ªmove_w‹k
);

432 
	`dm_put
(
md
);

434 
	`•ö_u∆ock
(&
_mö‹_lock
);

435 
	}
}

437 
	$dm_›í_cou¡
(
m≠≥d_devi˚
 *
md
)

439  
	`©omic_ªad
(&
md
->
›í_cou¡
);

440 
	}
}

445 
	$dm_lock_f‹_dñëi⁄
(
m≠≥d_devi˚
 *
md
, 
boﬁ
 
m¨k_de„ºed
, boﬁ 
⁄ly_de„ºed
)

447 
r
 = 0;

449 
	`•ö_lock
(&
_mö‹_lock
);

451 i‡(
	`dm_›í_cou¡
(
md
)) {

452 
r
 = -
EBUSY
;

453 i‡(
m¨k_de„ºed
)

454 
	`£t_bô
(
DMF_DEFERRED_REMOVE
, &
md
->
Êags
);

455 } i‡(
⁄ly_de„ºed
 && !
	`ã°_bô
(
DMF_DEFERRED_REMOVE
, &
md
->
Êags
))

456 
r
 = -
EEXIST
;

458 
	`£t_bô
(
DMF_DELETING
, &
md
->
Êags
);

460 
	`•ö_u∆ock
(&
_mö‹_lock
);

462  
r
;

463 
	}
}

465 
	$dm_ˇn˚l_de„ºed_ªmove
(
m≠≥d_devi˚
 *
md
)

467 
r
 = 0;

469 
	`•ö_lock
(&
_mö‹_lock
);

471 i‡(
	`ã°_bô
(
DMF_DELETING
, &
md
->
Êags
))

472 
r
 = -
EBUSY
;

474 
	`˛ór_bô
(
DMF_DEFERRED_REMOVE
, &
md
->
Êags
);

476 
	`•ö_u∆ock
(&
_mö‹_lock
);

478  
r
;

479 
	}
}

481 
	$do_de„ºed_ªmove
(
w‹k_°ru˘
 *
w
)

483 
	`dm_de„ºed_ªmove
();

484 
	}
}

486 
£˘‹_t
 
	$dm_gë_size
(
m≠≥d_devi˚
 *
md
)

488  
	`gë_ˇ∑côy
(
md
->
disk
);

489 
	}
}

491 
ªque°_queue
 *
	$dm_gë_md_queue
(
m≠≥d_devi˚
 *
md
)

493  
md
->
queue
;

494 
	}
}

496 
dm_°©s
 *
	$dm_gë_°©s
(
m≠≥d_devi˚
 *
md
)

498  &
md
->
°©s
;

499 
	}
}

501 
	$dm_blk_gëgeo
(
block_devi˚
 *
bdev
, 
hd_geomëry
 *
geo
)

503 
m≠≥d_devi˚
 *
md
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

505  
	`dm_gë_geomëry
(
md
, 
geo
);

506 
	}
}

508 
	$dm_blk_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

509 
cmd
, 
¨g
)

511 
m≠≥d_devi˚
 *
md
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

512 
§cu_idx
;

513 
dm_èbÀ
 *
m≠
;

514 
dm_èrgë
 *
tgt
;

515 
r
 = -
ENOTTY
;

517 
ªåy
:

518 
m≠
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

520 i‡(!
m≠
 || !
	`dm_èbÀ_gë_size
(map))

521 
out
;

524 i‡(
	`dm_èbÀ_gë_num_èrgës
(
m≠
) != 1)

525 
out
;

527 
tgt
 = 
	`dm_èbÀ_gë_èrgë
(
m≠
, 0);

529 i‡(
	`dm_su•íded_md
(
md
)) {

530 
r
 = -
EAGAIN
;

531 
out
;

534 i‡(
tgt
->
ty≥
->
io˘l
)

535 
r
 = 
tgt
->
ty≥
->
	`io˘l
—gt, 
cmd
, 
¨g
);

537 
out
:

538 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

540 i‡(
r
 =-
ENOTCONN
) {

541 
	`m¶ìp
(10);

542 
ªåy
;

545  
r
;

546 
	}
}

548 
dm_io
 *
	$Æloc_io
(
m≠≥d_devi˚
 *
md
)

550  
	`mempoﬁ_Æloc
(
md
->
io_poﬁ
, 
GFP_NOIO
);

551 
	}
}

553 
	$‰ì_io
(
m≠≥d_devi˚
 *
md
, 
dm_io
 *
io
)

555 
	`mempoﬁ_‰ì
(
io
, 
md
->
io_poﬁ
);

556 
	}
}

558 
	$‰ì_tio
(
m≠≥d_devi˚
 *
md
, 
dm_èrgë_io
 *
tio
)

560 
	`bio_put
(&
tio
->
˛⁄e
);

561 
	}
}

563 
dm_rq_èrgë_io
 *
	$Æloc_rq_tio
(
m≠≥d_devi˚
 *
md
,

564 
gÂ_t
 
gÂ_mask
)

566  
	`mempoﬁ_Æloc
(
md
->
io_poﬁ
, 
gÂ_mask
);

567 
	}
}

569 
	$‰ì_rq_tio
(
dm_rq_èrgë_io
 *
tio
)

571 
	`mempoﬁ_‰ì
(
tio
,Åio->
md
->
io_poﬁ
);

572 
	}
}

574 
	$md_ö_Êight
(
m≠≥d_devi˚
 *
md
)

576  
	`©omic_ªad
(&
md
->
≥ndög
[
READ
]) +

577 
	`©omic_ªad
(&
md
->
≥ndög
[
WRITE
]);

578 
	}
}

580 
	$°¨t_io_ac˘
(
dm_io
 *
io
)

582 
m≠≥d_devi˚
 *
md
 = 
io
->md;

583 
bio
 *biÿ
io
->bio;

584 
˝u
;

585 
rw
 = 
	`bio_d©a_dú
(
bio
);

587 
io
->
°¨t_time
 = 
jiffõs
;

589 
˝u
 = 
	`∑π_°©_lock
();

590 
	`∑π_round_°©s
(
˝u
, &
	`dm_disk
(
md
)->
∑π0
);

591 
	`∑π_°©_u∆ock
();

592 
	`©omic_£t
(&
	`dm_disk
(
md
)->
∑π0
.
ö_Êight
[
rw
],

593 
	`©omic_öc_ªtu∫
(&
md
->
≥ndög
[
rw
]));

595 i‡(
	`u∆ikñy
(
	`dm_°©s_u£d
(&
md
->
°©s
)))

596 
	`dm_°©s_accou¡_io
(&
md
->
°©s
, 
bio
->
bi_rw
, bio->
bi_ôî
.
bi_£˘‹
,

597 
	`bio_£˘‹s
(
bio
), 
Ál£
, 0, &
io
->
°©s_aux
);

598 
	}
}

600 
	$íd_io_ac˘
(
dm_io
 *
io
)

602 
m≠≥d_devi˚
 *
md
 = 
io
->md;

603 
bio
 *biÿ
io
->bio;

604 
duøti⁄
 = 
jiffõs
 - 
io
->
°¨t_time
;

605 
≥ndög
, 
˝u
;

606 
rw
 = 
	`bio_d©a_dú
(
bio
);

608 
˝u
 = 
	`∑π_°©_lock
();

609 
	`∑π_round_°©s
(
˝u
, &
	`dm_disk
(
md
)->
∑π0
);

610 
	`∑π_°©_add
(
˝u
, &
	`dm_disk
(
md
)->
∑π0
, 
ticks
[
rw
], 
duøti⁄
);

611 
	`∑π_°©_u∆ock
();

613 i‡(
	`u∆ikñy
(
	`dm_°©s_u£d
(&
md
->
°©s
)))

614 
	`dm_°©s_accou¡_io
(&
md
->
°©s
, 
bio
->
bi_rw
, bio->
bi_ôî
.
bi_£˘‹
,

615 
	`bio_£˘‹s
(
bio
), 
åue
, 
duøti⁄
, &
io
->
°©s_aux
);

621 
≥ndög
 = 
	`©omic_dec_ªtu∫
(&
md
->≥ndög[
rw
]);

622 
	`©omic_£t
(&
	`dm_disk
(
md
)->
∑π0
.
ö_Êight
[
rw
], 
≥ndög
);

623 
≥ndög
 +
	`©omic_ªad
(&
md
->≥ndög[
rw
^0x1]);

626 i‡(!
≥ndög
)

627 
	`wake_up
(&
md
->
waô
);

628 
	}
}

633 
	$queue_io
(
m≠≥d_devi˚
 *
md
, 
bio
 *bio)

635 
Êags
;

637 
	`•ö_lock_úqßve
(&
md
->
de„ºed_lock
, 
Êags
);

638 
	`bio_li°_add
(&
md
->
de„ºed
, 
bio
);

639 
	`•ö_u∆ock_úqª°‹e
(&
md
->
de„ºed_lock
, 
Êags
);

640 
	`queue_w‹k
(
md
->
wq
, &md->
w‹k
);

641 
	}
}

648 
dm_èbÀ
 *
	$dm_gë_live_èbÀ
(
m≠≥d_devi˚
 *
md
, *
§cu_idx
Ë
	`__acquúes
(md->
io_b¨rõr
)

650 *
§cu_idx
 = 
	`§cu_ªad_lock
(&
md
->
io_b¨rõr
);

652  
	`§cu_dîe„ªn˚
(
md
->
m≠
, &md->
io_b¨rõr
);

653 
	}
}

655 
	$dm_put_live_èbÀ
(
m≠≥d_devi˚
 *
md
, 
§cu_idx
Ë
	`__ªÀa£s
(md->
io_b¨rõr
)

657 
	`§cu_ªad_u∆ock
(&
md
->
io_b¨rõr
, 
§cu_idx
);

658 
	}
}

660 
	$dm_sync_èbÀ
(
m≠≥d_devi˚
 *
md
)

662 
	`synchr⁄ize_§cu
(&
md
->
io_b¨rõr
);

663 
	`synchr⁄ize_rcu_ex≥dôed
();

664 
	}
}

670 
dm_èbÀ
 *
	$dm_gë_live_èbÀ_Á°
(
m≠≥d_devi˚
 *
md
Ë
	$__acquúes
(
RCU
)

672 
	`rcu_ªad_lock
();

673  
	`rcu_dîe„ªn˚
(
md
->
m≠
);

674 
	}
}

676 
	$dm_put_live_èbÀ_Á°
(
m≠≥d_devi˚
 *
md
Ë
	$__ªÀa£s
(
RCU
)

678 
	`rcu_ªad_u∆ock
();

679 
	}
}

684 
	$›í_èbÀ_devi˚
(
èbÀ_devi˚
 *
td
, 
dev_t
 
dev
,

685 
m≠≥d_devi˚
 *
md
)

687 *
_˛aim_±r
 = "I belongÅo device-mapper";

688 
block_devi˚
 *
bdev
;

690 
r
;

692 
	`BUG_ON
(
td
->
dm_dev
.
bdev
);

694 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
td
->
dm_dev
.
mode
 | 
FMODE_EXCL
, 
_˛aim_±r
);

695 i‡(
	`IS_ERR
(
bdev
))

696  
	`PTR_ERR
(
bdev
);

698 
r
 = 
	`bd_lök_disk_hﬁdî
(
bdev
, 
	`dm_disk
(
md
));

699 i‡(
r
) {

700 
	`blkdev_put
(
bdev
, 
td
->
dm_dev
.
mode
 | 
FMODE_EXCL
);

701  
r
;

704 
td
->
dm_dev
.
bdev
 = bdev;

706 
	}
}

711 
	$˛o£_èbÀ_devi˚
(
èbÀ_devi˚
 *
td
, 
m≠≥d_devi˚
 *
md
)

713 i‡(!
td
->
dm_dev
.
bdev
)

716 
	`bd_u∆ök_disk_hﬁdî
(
td
->
dm_dev
.
bdev
, 
	`dm_disk
(
md
));

717 
	`blkdev_put
(
td
->
dm_dev
.
bdev
,Åd->dm_dev.
mode
 | 
FMODE_EXCL
);

718 
td
->
dm_dev
.
bdev
 = 
NULL
;

719 
	}
}

721 
èbÀ_devi˚
 *
	$föd_èbÀ_devi˚
(
li°_hód
 *
l
, 
dev_t
 
dev
,

722 
fmode_t
 
mode
) {

723 
èbÀ_devi˚
 *
td
;

725 
	`li°_f‹_óch_íåy
(
td
, 
l
, 
li°
)

726 i‡(
td
->
dm_dev
.
bdev
->
bd_dev
 =
dev
 &&Åd->dm_dev.
mode
 == mode)

727  
td
;

729  
NULL
;

730 
	}
}

732 
	$dm_gë_èbÀ_devi˚
(
m≠≥d_devi˚
 *
md
, 
dev_t
 
dev
, 
fmode_t
 
mode
,

733 
dm_dev
 **
ªsu…
) {

734 
r
;

735 
èbÀ_devi˚
 *
td
;

737 
	`muãx_lock
(&
md
->
èbÀ_devi˚s_lock
);

738 
td
 = 
	`föd_èbÀ_devi˚
(&
md
->
èbÀ_devi˚s
, 
dev
, 
mode
);

739 i‡(!
td
) {

740 
td
 = 
	`kmÆloc
((*td), 
GFP_KERNEL
);

741 i‡(!
td
) {

742 
	`muãx_u∆ock
(&
md
->
èbÀ_devi˚s_lock
);

743  -
ENOMEM
;

746 
td
->
dm_dev
.
mode
 = mode;

747 
td
->
dm_dev
.
bdev
 = 
NULL
;

749 i‡((
r
 = 
	`›í_èbÀ_devi˚
(
td
, 
dev
, 
md
))) {

750 
	`muãx_u∆ock
(&
md
->
èbÀ_devi˚s_lock
);

751 
	`k‰ì
(
td
);

752  
r
;

755 
	`f‹m©_dev_t
(
td
->
dm_dev
.
«me
, 
dev
);

757 
	`©omic_£t
(&
td
->
cou¡
, 0);

758 
	`li°_add
(&
td
->
li°
, &
md
->
èbÀ_devi˚s
);

760 
	`©omic_öc
(&
td
->
cou¡
);

761 
	`muãx_u∆ock
(&
md
->
èbÀ_devi˚s_lock
);

763 *
ªsu…
 = &
td
->
dm_dev
;

765 
	}
}

766 
EXPORT_SYMBOL_GPL
(
dm_gë_èbÀ_devi˚
);

768 
	$dm_put_èbÀ_devi˚
(
m≠≥d_devi˚
 *
md
, 
dm_dev
 *
d
)

770 
èbÀ_devi˚
 *
td
 = 
	`c⁄èöî_of
(
d
, èbÀ_devi˚, 
dm_dev
);

772 
	`muãx_lock
(&
md
->
èbÀ_devi˚s_lock
);

773 i‡(
	`©omic_dec_™d_ã°
(&
td
->
cou¡
)) {

774 
	`˛o£_èbÀ_devi˚
(
td
, 
md
);

775 
	`li°_dñ
(&
td
->
li°
);

776 
	`k‰ì
(
td
);

778 
	`muãx_u∆ock
(&
md
->
èbÀ_devi˚s_lock
);

779 
	}
}

780 
EXPORT_SYMBOL
(
dm_put_èbÀ_devi˚
);

782 
	$‰ì_èbÀ_devi˚s
(
li°_hód
 *
devi˚s
)

784 
li°_hód
 *
tmp
, *
√xt
;

786 
	`li°_f‹_óch_ß„
(
tmp
, 
√xt
, 
devi˚s
) {

787 
èbÀ_devi˚
 *
td
 = 
	`li°_íåy
(
tmp
, èbÀ_devi˚, 
li°
);

789 
	`DMWARN
("dm_destroy: %s stillÉxists with %dÑeferences",

790 
td
->
dm_dev
.
«me
, 
	`©omic_ªad
(&td->
cou¡
));

791 
	`k‰ì
(
td
);

793 
	}
}

798 
	$dm_gë_geomëry
(
m≠≥d_devi˚
 *
md
, 
hd_geomëry
 *
geo
)

800 *
geo
 = 
md
->
geomëry
;

803 
	}
}

808 
	$dm_£t_geomëry
(
m≠≥d_devi˚
 *
md
, 
hd_geomëry
 *
geo
)

810 
£˘‹_t
 
sz
 = (£˘‹_t)
geo
->
cylödîs
 * geo->
hóds
 * geo->
£˘‹s
;

812 i‡(
geo
->
°¨t
 > 
sz
) {

813 
	`DMWARN
("Start sector is beyondÅhe geometryÜimits.");

814  -
EINVAL
;

817 
md
->
geomëry
 = *
geo
;

820 
	}
}

831 
	$__noÊush_su•ídög
(
m≠≥d_devi˚
 *
md
)

833  
	`ã°_bô
(
DMF_NOFLUSH_SUSPENDING
, &
md
->
Êags
);

834 
	}
}

840 
	$dec_≥ndög
(
dm_io
 *
io
, 
îr‹
)

842 
Êags
;

843 
io_îr‹
;

844 
bio
 *bio;

845 
m≠≥d_devi˚
 *
md
 = 
io
->md;

848 i‡(
	`u∆ikñy
(
îr‹
)) {

849 
	`•ö_lock_úqßve
(&
io
->
ídio_lock
, 
Êags
);

850 i‡(!(
io
->
îr‹
 > 0 && 
	`__noÊush_su•ídög
(
md
)))

851 
io
->
îr‹
 =Érror;

852 
	`•ö_u∆ock_úqª°‹e
(&
io
->
ídio_lock
, 
Êags
);

855 i‡(
	`©omic_dec_™d_ã°
(&
io
->
io_cou¡
)) {

856 i‡(
io
->
îr‹
 =
DM_ENDIO_REQUEUE
) {

860 
	`•ö_lock_úqßve
(&
md
->
de„ºed_lock
, 
Êags
);

861 i‡(
	`__noÊush_su•ídög
(
md
))

862 
	`bio_li°_add_hód
(&
md
->
de„ºed
, 
io
->
bio
);

865 
io
->
îr‹
 = -
EIO
;

866 
	`•ö_u∆ock_úqª°‹e
(&
md
->
de„ºed_lock
, 
Êags
);

869 
io_îr‹
 = 
io
->
îr‹
;

870 
bio
 = 
io
->bio;

871 
	`íd_io_ac˘
(
io
);

872 
	`‰ì_io
(
md
, 
io
);

874 i‡(
io_îr‹
 =
DM_ENDIO_REQUEUE
)

877 i‡((
bio
->
bi_rw
 & 
REQ_FLUSH
Ë&& bio->
bi_ôî
.
bi_size
) {

882 
bio
->
bi_rw
 &~
REQ_FLUSH
;

883 
	`queue_io
(
md
, 
bio
);

886 
	`åa˚_block_bio_com∂ëe
(
md
->
queue
, 
bio
, 
io_îr‹
);

887 
	`bio_ídio
(
bio
, 
io_îr‹
);

890 
	}
}

892 
	$dißbÀ_wrôe_ßme
(
m≠≥d_devi˚
 *
md
)

894 
queue_limôs
 *
limôs
 = 
	`dm_gë_queue_limôs
(
md
);

897 
limôs
->
max_wrôe_ßme_£˘‹s
 = 0;

898 
	}
}

900 
	$˛⁄e_ídio
(
bio
 *bio, 
îr‹
)

902 
r
 = 0;

903 
dm_èrgë_io
 *
tio
 = 
	`c⁄èöî_of
(
bio
, dm_èrgë_io, 
˛⁄e
);

904 
dm_io
 *
io
 = 
tio
->io;

905 
m≠≥d_devi˚
 *
md
 = 
tio
->
io
->md;

906 
dm_ídio_‚
 
ídio
 = 
tio
->
ti
->
ty≥
->
íd_io
;

908 i‡(!
	`bio_Êagged
(
bio
, 
BIO_UPTODATE
Ë&& !
îr‹
)

909 
îr‹
 = -
EIO
;

911 i‡(
ídio
) {

912 
r
 = 
	`ídio
(
tio
->
ti
, 
bio
, 
îr‹
);

913 i‡(
r
 < 0 ||Ñ =
DM_ENDIO_REQUEUE
)

918 
îr‹
 = 
r
;

919 i‡(
r
 =
DM_ENDIO_INCOMPLETE
)

922 i‡(
r
) {

923 
	`DMWARN
("unim∂emíãdÅ¨gëÉndiÿªtu∫ vÆue: %d", 
r
);

924 
	`BUG
();

928 i‡(
	`u∆ikñy
(
r
 =-
EREMOTEIO
 && (
bio
->
bi_rw
 & 
REQ_WRITE_SAME
) &&

929 !
	`bdev_gë_queue
(
bio
->
bi_bdev
)->
limôs
.
max_wrôe_ßme_£˘‹s
))

930 
	`dißbÀ_wrôe_ßme
(
md
);

932 
	`‰ì_tio
(
md
, 
tio
);

933 
	`dec_≥ndög
(
io
, 
îr‹
);

934 
	}
}

939 
	$íd_˛⁄e_bio
(
bio
 *
˛⁄e
, 
îr‹
)

941 
dm_rq_˛⁄e_bio_öfo
 *
öfo
 =

942 
	`c⁄èöî_of
(
˛⁄e
, 
dm_rq_˛⁄e_bio_öfo
, clone);

943 
dm_rq_èrgë_io
 *
tio
 = 
öfo
->tio;

944 
bio
 *biÿ
öfo
->
‹ig
;

945 
ƒ_byãs
 = 
öfo
->
‹ig
->
bi_ôî
.
bi_size
;

947 
	`bio_put
(
˛⁄e
);

949 i‡(
tio
->
îr‹
)

956 i‡(
îr‹
) {

962 
tio
->
îr‹
 =Érror;

976 i‡(
tio
->
‹ig
->
bio
 != bio)

977 
	`DMERR
("bio completion is going inÅhe middle ofÅheÑequest");

984 
	`blk_upd©e_ªque°
(
tio
->
‹ig
, 0, 
ƒ_byãs
);

985 
	}
}

992 
	$rq_com∂ëed
(
m≠≥d_devi˚
 *
md
, 
rw
, 
run_queue
)

994 
	`©omic_dec
(&
md
->
≥ndög
[
rw
]);

997 i‡(!
	`md_ö_Êight
(
md
))

998 
	`wake_up
(&
md
->
waô
);

1006 i‡(
run_queue
)

1007 
	`blk_run_queue_async
(
md
->
queue
);

1012 
	`dm_put
(
md
);

1013 
	}
}

1015 
	$‰ì_rq_˛⁄e
(
ªque°
 *
˛⁄e
)

1017 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1019 
	`blk_rq_u≈ªp_˛⁄e
(
˛⁄e
);

1020 
	`‰ì_rq_tio
(
tio
);

1021 
	}
}

1027 
	$dm_íd_ªque°
(
ªque°
 *
˛⁄e
, 
îr‹
)

1029 
rw
 = 
	`rq_d©a_dú
(
˛⁄e
);

1030 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1031 
m≠≥d_devi˚
 *
md
 = 
tio
->md;

1032 
ªque°
 *
rq
 = 
tio
->
‹ig
;

1034 i‡(
rq
->
cmd_ty≥
 =
REQ_TYPE_BLOCK_PC
) {

1035 
rq
->
îr‹s
 = 
˛⁄e
->errors;

1036 
rq
->
ªsid_Àn
 = 
˛⁄e
->resid_len;

1038 i‡(
rq
->
£n£
)

1044 
rq
->
£n£_Àn
 = 
˛⁄e
->sense_len;

1047 
	`‰ì_rq_˛⁄e
(
˛⁄e
);

1048 
	`blk_íd_ªque°_Æl
(
rq
, 
îr‹
);

1049 
	`rq_com∂ëed
(
md
, 
rw
, 
åue
);

1050 
	}
}

1052 
	$dm_u≈ªp_ªque°
(
ªque°
 *
rq
)

1054 
ªque°
 *
˛⁄e
 = 
rq
->
•ecül
;

1056 
rq
->
•ecül
 = 
NULL
;

1057 
rq
->
cmd_Êags
 &~
REQ_DONTPREP
;

1059 
	`‰ì_rq_˛⁄e
(
˛⁄e
);

1060 
	}
}

1065 
	$dm_ªqueue_unm≠≥d_ªque°
(
ªque°
 *
˛⁄e
)

1067 
rw
 = 
	`rq_d©a_dú
(
˛⁄e
);

1068 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1069 
m≠≥d_devi˚
 *
md
 = 
tio
->md;

1070 
ªque°
 *
rq
 = 
tio
->
‹ig
;

1071 
ªque°_queue
 *
q
 = 
rq
->q;

1072 
Êags
;

1074 
	`dm_u≈ªp_ªque°
(
rq
);

1076 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

1077 
	`blk_ªqueue_ªque°
(
q
, 
rq
);

1078 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

1080 
	`rq_com∂ëed
(
md
, 
rw
, 0);

1081 
	}
}

1082 
EXPORT_SYMBOL_GPL
(
dm_ªqueue_unm≠≥d_ªque°
);

1084 
	$__°›_queue
(
ªque°_queue
 *
q
)

1086 
	`blk_°›_queue
(
q
);

1087 
	}
}

1089 
	$°›_queue
(
ªque°_queue
 *
q
)

1091 
Êags
;

1093 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

1094 
	`__°›_queue
(
q
);

1095 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

1096 
	}
}

1098 
	$__°¨t_queue
(
ªque°_queue
 *
q
)

1100 i‡(
	`blk_queue_°›≥d
(
q
))

1101 
	`blk_°¨t_queue
(
q
);

1102 
	}
}

1104 
	$°¨t_queue
(
ªque°_queue
 *
q
)

1106 
Êags
;

1108 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

1109 
	`__°¨t_queue
(
q
);

1110 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

1111 
	}
}

1113 
	$dm_d⁄e
(
ªque°
 *
˛⁄e
, 
îr‹
, 
boﬁ
 
m≠≥d
)

1115 
r
 = 
îr‹
;

1116 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1117 
dm_ªque°_ídio_‚
 
rq_íd_io
 = 
NULL
;

1119 i‡(
tio
->
ti
) {

1120 
rq_íd_io
 = 
tio
->
ti
->
ty≥
->rq_end_io;

1122 i‡(
m≠≥d
 && 
rq_íd_io
)

1123 
r
 = 
	`rq_íd_io
(
tio
->
ti
, 
˛⁄e
, 
îr‹
, &tio->
öfo
);

1126 i‡(
	`u∆ikñy
(
r
 =-
EREMOTEIO
 && (
˛⁄e
->
cmd_Êags
 & 
REQ_WRITE_SAME
) &&

1127 !
˛⁄e
->
q
->
limôs
.
max_wrôe_ßme_£˘‹s
))

1128 
	`dißbÀ_wrôe_ßme
(
tio
->
md
);

1130 i‡(
r
 <= 0)

1132 
	`dm_íd_ªque°
(
˛⁄e
, 
r
);

1133 i‡(
r
 =
DM_ENDIO_INCOMPLETE
)

1136 i‡(
r
 =
DM_ENDIO_REQUEUE
)

1138 
	`dm_ªqueue_unm≠≥d_ªque°
(
˛⁄e
);

1140 
	`DMWARN
("unim∂emíãdÅ¨gëÉndiÿªtu∫ vÆue: %d", 
r
);

1141 
	`BUG
();

1143 
	}
}

1148 
	$dm_so·úq_d⁄e
(
ªque°
 *
rq
)

1150 
boﬁ
 
m≠≥d
 = 
åue
;

1151 
ªque°
 *
˛⁄e
 = 
rq
->
com∂ëi⁄_d©a
;

1152 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1154 i‡(
rq
->
cmd_Êags
 & 
REQ_FAILED
)

1155 
m≠≥d
 = 
Ál£
;

1157 
	`dm_d⁄e
(
˛⁄e
, 
tio
->
îr‹
, 
m≠≥d
);

1158 
	}
}

1164 
	$dm_com∂ëe_ªque°
(
ªque°
 *
˛⁄e
, 
îr‹
)

1166 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1167 
ªque°
 *
rq
 = 
tio
->
‹ig
;

1169 
tio
->
îr‹
 =Érror;

1170 
rq
->
com∂ëi⁄_d©a
 = 
˛⁄e
;

1171 
	`blk_com∂ëe_ªque°
(
rq
);

1172 
	}
}

1180 
	$dm_kûl_unm≠≥d_ªque°
(
ªque°
 *
˛⁄e
, 
îr‹
)

1182 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1183 
ªque°
 *
rq
 = 
tio
->
‹ig
;

1185 
rq
->
cmd_Êags
 |
REQ_FAILED
;

1186 
	`dm_com∂ëe_ªque°
(
˛⁄e
, 
îr‹
);

1187 
	}
}

1188 
EXPORT_SYMBOL_GPL
(
dm_kûl_unm≠≥d_ªque°
);

1193 
	$íd_˛⁄e_ªque°
(
ªque°
 *
˛⁄e
, 
îr‹
)

1201 
	`__blk_put_ªque°
(
˛⁄e
->
q
, clone);

1211 
	`dm_com∂ëe_ªque°
(
˛⁄e
, 
îr‹
);

1212 
	}
}

1218 
£˘‹_t
 
	$max_io_Àn_èrgë_bound¨y
(
£˘‹_t
 
£˘‹
, 
dm_èrgë
 *
ti
)

1220 
£˘‹_t
 
èrgë_off£t
 = 
	`dm_èrgë_off£t
(
ti
, 
£˘‹
);

1222  
ti
->
Àn
 - 
èrgë_off£t
;

1223 
	}
}

1225 
£˘‹_t
 
	$max_io_Àn
(
£˘‹_t
 
£˘‹
, 
dm_èrgë
 *
ti
)

1227 
£˘‹_t
 
Àn
 = 
	`max_io_Àn_èrgë_bound¨y
(
£˘‹
, 
ti
);

1228 
£˘‹_t
 
off£t
, 
max_Àn
;

1233 i‡(
ti
->
max_io_Àn
) {

1234 
off£t
 = 
	`dm_èrgë_off£t
(
ti
, 
£˘‹
);

1235 i‡(
	`u∆ikñy
(
ti
->
max_io_Àn
 & (ti->max_io_len - 1)))

1236 
max_Àn
 = 
	`£˘‹_div
(
off£t
, 
ti
->
max_io_Àn
);

1238 
max_Àn
 = 
off£t
 & (
ti
->
max_io_Àn
 - 1);

1239 
max_Àn
 = 
ti
->
max_io_Àn
 - max_len;

1241 i‡(
Àn
 > 
max_Àn
)

1242 
Àn
 = 
max_Àn
;

1245  
Àn
;

1246 
	}
}

1248 
	$dm_£t_èrgë_max_io_Àn
(
dm_èrgë
 *
ti
, 
£˘‹_t
 
Àn
)

1250 i‡(
Àn
 > 
UINT_MAX
) {

1251 
	`DMERR
("Specified maximum size ofÅarget IO (%llu)ÉxceedsÜimit (%u)",

1252 ()
Àn
, 
UINT_MAX
);

1253 
ti
->
îr‹
 = "Maximum size ofÅarget IO isÅooÜarge";

1254  -
EINVAL
;

1257 
ti
->
max_io_Àn
 = (
uöt32_t
Ë
Àn
;

1260 
	}
}

1261 
EXPORT_SYMBOL_GPL
(
dm_£t_èrgë_max_io_Àn
);

1291 
	$dm_ac˚±_∑πül_bio
(
bio
 *bio, 
n_£˘‹s
)

1293 
dm_èrgë_io
 *
tio
 = 
	`c⁄èöî_of
(
bio
, dm_èrgë_io, 
˛⁄e
);

1294 
bi_size
 = 
bio
->
bi_ôî
.bi_sizê>> 
SECTOR_SHIFT
;

1295 
	`BUG_ON
(
bio
->
bi_rw
 & 
REQ_FLUSH
);

1296 
	`BUG_ON
(
bi_size
 > *
tio
->
Àn_±r
);

1297 
	`BUG_ON
(
n_£˘‹s
 > 
bi_size
);

1298 *
tio
->
Àn_±r
 -
bi_size
 - 
n_£˘‹s
;

1299 
bio
->
bi_ôî
.
bi_size
 = 
n_£˘‹s
 << 
SECTOR_SHIFT
;

1300 
	}
}

1301 
EXPORT_SYMBOL_GPL
(
dm_ac˚±_∑πül_bio
);

1303 
	$__m≠_bio
(
dm_èrgë_io
 *
tio
)

1305 
r
;

1306 
£˘‹_t
 
£˘‹
;

1307 
m≠≥d_devi˚
 *
md
;

1308 
bio
 *
˛⁄e
 = &
tio
->clone;

1309 
dm_èrgë
 *
ti
 = 
tio
->ti;

1311 
˛⁄e
->
bi_íd_io
 = 
˛⁄e_ídio
;

1318 
	`©omic_öc
(&
tio
->
io
->
io_cou¡
);

1319 
£˘‹
 = 
˛⁄e
->
bi_ôî
.
bi_£˘‹
;

1320 
r
 = 
ti
->
ty≥
->
	`m≠
—i, 
˛⁄e
);

1321 i‡(
r
 =
DM_MAPIO_REMAPPED
) {

1324 
	`åa˚_block_bio_ªm≠
(
	`bdev_gë_queue
(
˛⁄e
->
bi_bdev
), clone,

1325 
tio
->
io
->
bio
->
bi_bdev
->
bd_dev
, 
£˘‹
);

1327 
	`gíîic_make_ªque°
(
˛⁄e
);

1328 } i‡(
r
 < 0 ||Ñ =
DM_MAPIO_REQUEUE
) {

1330 
md
 = 
tio
->
io
->md;

1331 
	`dec_≥ndög
(
tio
->
io
, 
r
);

1332 
	`‰ì_tio
(
md
, 
tio
);

1333 } i‡(
r
) {

1334 
	`DMWARN
("unim∂emíãdÅ¨gë m≠Ñëu∫ vÆue: %d", 
r
);

1335 
	`BUG
();

1337 
	}
}

1339 
	s˛⁄e_öfo
 {

1340 
m≠≥d_devi˚
 *
	mmd
;

1341 
dm_èbÀ
 *
	mm≠
;

1342 
bio
 *
	mbio
;

1343 
dm_io
 *
	mio
;

1344 
£˘‹_t
 
	m£˘‹
;

1345 
	m£˘‹_cou¡
;

1348 
	$bio_£tup_£˘‹
(
bio
 *bio, 
£˘‹_t
 
£˘‹
, 
Àn
)

1350 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
;

1351 
bio
->
bi_ôî
.
bi_size
 = 
	`to_byãs
(
Àn
);

1352 
	}
}

1357 
	$˛⁄e_bio
(
dm_èrgë_io
 *
tio
, 
bio
 *bio,

1358 
£˘‹_t
 
£˘‹
, 
Àn
)

1360 
bio
 *
˛⁄e
 = &
tio
->clone;

1362 
	`__bio_˛⁄e_Á°
(
˛⁄e
, 
bio
);

1364 i‡(
	`bio_öãgrôy
(
bio
))

1365 
	`bio_öãgrôy_˛⁄e
(
˛⁄e
, 
bio
, 
GFP_NOIO
);

1367 
	`bio_adv™˚
(
˛⁄e
, 
	`to_byãs
(
£˘‹
 - cl⁄e->
bi_ôî
.
bi_£˘‹
));

1368 
˛⁄e
->
bi_ôî
.
bi_size
 = 
	`to_byãs
(
Àn
);

1370 i‡(
	`bio_öãgrôy
(
bio
))

1371 
	`bio_öãgrôy_åim
(
˛⁄e
, 0, 
Àn
);

1372 
	}
}

1374 
dm_èrgë_io
 *
	$Æloc_tio
(
˛⁄e_öfo
 *
ci
,

1375 
dm_èrgë
 *
ti
, 
ƒ_iovecs
,

1376 
èrgë_bio_ƒ
)

1378 
dm_èrgë_io
 *
tio
;

1379 
bio
 *
˛⁄e
;

1381 
˛⁄e
 = 
	`bio_Æloc_bio£t
(
GFP_NOIO
, 
ƒ_iovecs
, 
ci
->
md
->
bs
);

1382 
tio
 = 
	`c⁄èöî_of
(
˛⁄e
, 
dm_èrgë_io
, clone);

1384 
tio
->
io
 = 
ci
->io;

1385 
tio
->
ti
 =Åi;

1386 
tio
->
èrgë_bio_ƒ
 =Åarget_bio_nr;

1388  
tio
;

1389 
	}
}

1391 
	$__˛⁄e_™d_m≠_sim∂e_bio
(
˛⁄e_öfo
 *
ci
,

1392 
dm_èrgë
 *
ti
,

1393 
èrgë_bio_ƒ
, *
Àn
)

1395 
dm_èrgë_io
 *
tio
 = 
	`Æloc_tio
(
ci
, 
ti
, ci->
bio
->
bi_max_vecs
, 
èrgë_bio_ƒ
);

1396 
bio
 *
˛⁄e
 = &
tio
->clone;

1398 
tio
->
Àn_±r
 = 
Àn
;

1405 
	`__bio_˛⁄e_Á°
(
˛⁄e
, 
ci
->
bio
);

1406 i‡(
Àn
)

1407 
	`bio_£tup_£˘‹
(
˛⁄e
, 
ci
->
£˘‹
, *
Àn
);

1409 
	`__m≠_bio
(
tio
);

1410 
	}
}

1412 
	$__£nd_du∂iˇã_bios
(
˛⁄e_öfo
 *
ci
, 
dm_èrgë
 *
ti
,

1413 
num_bios
, *
Àn
)

1415 
èrgë_bio_ƒ
;

1417 
èrgë_bio_ƒ
 = 0;Å¨gë_bio_ƒ < 
num_bios
;Åarget_bio_nr++)

1418 
	`__˛⁄e_™d_m≠_sim∂e_bio
(
ci
, 
ti
, 
èrgë_bio_ƒ
, 
Àn
);

1419 
	}
}

1421 
	$__£nd_em±y_Êush
(
˛⁄e_öfo
 *
ci
)

1423 
èrgë_ƒ
 = 0;

1424 
dm_èrgë
 *
ti
;

1426 
	`BUG_ON
(
	`bio_has_d©a
(
ci
->
bio
));

1427 (
ti
 = 
	`dm_èbÀ_gë_èrgë
(
ci
->
m≠
, 
èrgë_ƒ
++)))

1428 
	`__£nd_du∂iˇã_bios
(
ci
, 
ti
,Åi->
num_Êush_bios
, 
NULL
);

1431 
	}
}

1433 
	$__˛⁄e_™d_m≠_d©a_bio
(
˛⁄e_öfo
 *
ci
, 
dm_èrgë
 *
ti
,

1434 
£˘‹_t
 
£˘‹
, *
Àn
)

1436 
bio
 *biÿ
ci
->bio;

1437 
dm_èrgë_io
 *
tio
;

1438 
èrgë_bio_ƒ
;

1439 
num_èrgë_bios
 = 1;

1444 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
 && 
ti
->
num_wrôe_bios
)

1445 
num_èrgë_bios
 = 
ti
->
	`num_wrôe_bios
—i, 
bio
);

1447 
èrgë_bio_ƒ
 = 0;Å¨gë_bio_ƒ < 
num_èrgë_bios
;Åarget_bio_nr++) {

1448 
tio
 = 
	`Æloc_tio
(
ci
, 
ti
, 0, 
èrgë_bio_ƒ
);

1449 
tio
->
Àn_±r
 = 
Àn
;

1450 
	`˛⁄e_bio
(
tio
, 
bio
, 
£˘‹
, *
Àn
);

1451 
	`__m≠_bio
(
tio
);

1453 
	}
}

1455 (*
	tgë_num_bios_‚
)(
	tdm_èrgë
 *
	tti
);

1457 
	$gë_num_disˇrd_bios
(
dm_èrgë
 *
ti
)

1459  
ti
->
num_disˇrd_bios
;

1460 
	}
}

1462 
	$gë_num_wrôe_ßme_bios
(
dm_èrgë
 *
ti
)

1464  
ti
->
num_wrôe_ßme_bios
;

1465 
	}
}

1467 
	$boﬁ
 (*
	tis_•lô_ªquúed_‚
)(
	tdm_èrgë
 *
	tti
);

1469 
boﬁ
 
	$is_•lô_ªquúed_f‹_disˇrd
(
dm_èrgë
 *
ti
)

1471  
ti
->
•lô_disˇrd_bios
;

1472 
	}
}

1474 
	$__£nd_ch™gög_exã¡_⁄ly
(
˛⁄e_öfo
 *
ci
,

1475 
gë_num_bios_‚
 
gë_num_bios
,

1476 
is_•lô_ªquúed_‚
 
is_•lô_ªquúed
)

1478 
dm_èrgë
 *
ti
;

1479 
Àn
;

1480 
num_bios
;

1483 
ti
 = 
	`dm_èbÀ_föd_èrgë
(
ci
->
m≠
, ci->
£˘‹
);

1484 i‡(!
	`dm_èrgë_is_vÆid
(
ti
))

1485  -
EIO
;

1493 
num_bios
 = 
gë_num_bios
 ? 
	`gë_num_bios
(
ti
) : 0;

1494 i‡(!
num_bios
)

1495  -
EOPNOTSUPP
;

1497 i‡(
is_•lô_ªquúed
 && !
	`is_•lô_ªquúed
(
ti
))

1498 
Àn
 = 
	`mö
((
£˘‹_t
)
ci
->
£˘‹_cou¡
, 
	`max_io_Àn_èrgë_bound¨y
(ci->
£˘‹
, 
ti
));

1500 
Àn
 = 
	`mö
((
£˘‹_t
)
ci
->
£˘‹_cou¡
, 
	`max_io_Àn
(ci->
£˘‹
, 
ti
));

1502 
	`__£nd_du∂iˇã_bios
(
ci
, 
ti
, 
num_bios
, &
Àn
);

1504 
ci
->
£˘‹
 +
Àn
;

1505 } 
ci
->
£˘‹_cou¡
 -
Àn
);

1508 
	}
}

1510 
	$__£nd_disˇrd
(
˛⁄e_öfo
 *
ci
)

1512  
	`__£nd_ch™gög_exã¡_⁄ly
(
ci
, 
gë_num_disˇrd_bios
,

1513 
is_•lô_ªquúed_f‹_disˇrd
);

1514 
	}
}

1516 
	$__£nd_wrôe_ßme
(
˛⁄e_öfo
 *
ci
)

1518  
	`__£nd_ch™gög_exã¡_⁄ly
(
ci
, 
gë_num_wrôe_ßme_bios
, 
NULL
);

1519 
	}
}

1524 
	$__•lô_™d_¥o˚ss_n⁄_Êush
(
˛⁄e_öfo
 *
ci
)

1526 
bio
 *biÿ
ci
->bio;

1527 
dm_èrgë
 *
ti
;

1528 
Àn
;

1530 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_DISCARD
))

1531  
	`__£nd_disˇrd
(
ci
);

1532 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_WRITE_SAME
))

1533  
	`__£nd_wrôe_ßme
(
ci
);

1535 
ti
 = 
	`dm_èbÀ_föd_èrgë
(
ci
->
m≠
, ci->
£˘‹
);

1536 i‡(!
	`dm_èrgë_is_vÆid
(
ti
))

1537  -
EIO
;

1539 
Àn
 = 
	`mö_t
(
£˘‹_t
, 
	`max_io_Àn
(
ci
->
£˘‹
, 
ti
), ci->
£˘‹_cou¡
);

1541 
	`__˛⁄e_™d_m≠_d©a_bio
(
ci
, 
ti
, ci->
£˘‹
, &
Àn
);

1543 
ci
->
£˘‹
 +
Àn
;

1544 
ci
->
£˘‹_cou¡
 -
Àn
;

1547 
	}
}

1552 
	$__•lô_™d_¥o˚ss_bio
(
m≠≥d_devi˚
 *
md
,

1553 
dm_èbÀ
 *
m≠
, 
bio
 *bio)

1555 
˛⁄e_öfo
 
ci
;

1556 
îr‹
 = 0;

1558 i‡(
	`u∆ikñy
(!
m≠
)) {

1559 
	`bio_io_îr‹
(
bio
);

1563 
ci
.
m≠
 = map;

1564 
ci
.
md
 = md;

1565 
ci
.
io
 = 
	`Æloc_io
(
md
);

1566 
ci
.
io
->
îr‹
 = 0;

1567 
	`©omic_£t
(&
ci
.
io
->
io_cou¡
, 1);

1568 
ci
.
io
->
bio
 = bio;

1569 
ci
.
io
->
md
 = md;

1570 
	`•ö_lock_öô
(&
ci
.
io
->
ídio_lock
);

1571 
ci
.
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

1573 
	`°¨t_io_ac˘
(
ci
.
io
);

1575 i‡(
bio
->
bi_rw
 & 
REQ_FLUSH
) {

1576 
ci
.
bio
 = &ci.
md
->
Êush_bio
;

1577 
ci
.
£˘‹_cou¡
 = 0;

1578 
îr‹
 = 
	`__£nd_em±y_Êush
(&
ci
);

1581 
ci
.
bio
 = bio;

1582 
ci
.
£˘‹_cou¡
 = 
	`bio_£˘‹s
(
bio
);

1583 
ci
.
£˘‹_cou¡
 && !
îr‹
)

1584 
îr‹
 = 
	`__•lô_™d_¥o˚ss_n⁄_Êush
(&
ci
);

1588 
	`dec_≥ndög
(
ci
.
io
, 
îr‹
);

1589 
	}
}

1594 
	$dm_mîge_bvec
(
ªque°_queue
 *
q
,

1595 
bvec_mîge_d©a
 *
bvm
,

1596 
bio_vec
 *
biovec
)

1598 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1599 
dm_èbÀ
 *
m≠
 = 
	`dm_gë_live_èbÀ_Á°
(
md
);

1600 
dm_èrgë
 *
ti
;

1601 
£˘‹_t
 
max_£˘‹s
;

1602 
max_size
 = 0;

1604 i‡(
	`u∆ikñy
(!
m≠
))

1605 
out
;

1607 
ti
 = 
	`dm_èbÀ_föd_èrgë
(
m≠
, 
bvm
->
bi_£˘‹
);

1608 i‡(!
	`dm_èrgë_is_vÆid
(
ti
))

1609 
out
;

1614 
max_£˘‹s
 = 
	`mö
(
	`max_io_Àn
(
bvm
->
bi_£˘‹
, 
ti
),

1615 (
£˘‹_t
Ë
BIO_MAX_SECTORS
);

1616 
max_size
 = (
max_£˘‹s
 << 
SECTOR_SHIFT
Ë- 
bvm
->
bi_size
;

1617 i‡(
max_size
 < 0)

1618 
max_size
 = 0;

1625 i‡(
max_size
 && 
ti
->
ty≥
->
mîge
)

1626 
max_size
 = 
ti
->
ty≥
->
	`mîge
—i, 
bvm
, 
biovec
, max_size);

1634 i‡(
	`queue_max_hw_£˘‹s
(
q
Ë<
PAGE_SIZE
 >> 9)

1635 
max_size
 = 0;

1637 
out
:

1638 
	`dm_put_live_èbÀ_Á°
(
md
);

1642 i‡(
max_size
 <
biovec
->
bv_Àn
 && !(
bvm
->
bi_size
 >> 
SECTOR_SHIFT
))

1643 
max_size
 = 
biovec
->
bv_Àn
;

1645  
max_size
;

1646 
	}
}

1652 
	$_dm_ªque°
(
ªque°_queue
 *
q
, 
bio
 *bio)

1654 
rw
 = 
	`bio_d©a_dú
(
bio
);

1655 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1656 
˝u
;

1657 
§cu_idx
;

1658 
dm_èbÀ
 *
m≠
;

1660 
m≠
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

1662 
˝u
 = 
	`∑π_°©_lock
();

1663 
	`∑π_°©_öc
(
˝u
, &
	`dm_disk
(
md
)->
∑π0
, 
ios
[
rw
]);

1664 
	`∑π_°©_add
(
˝u
, &
	`dm_disk
(
md
)->
∑π0
, 
£˘‹s
[
rw
], 
	`bio_£˘‹s
(
bio
));

1665 
	`∑π_°©_u∆ock
();

1668 i‡(
	`u∆ikñy
(
	`ã°_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
))) {

1669 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1671 i‡(
	`bio_rw
(
bio
Ë!
READA
)

1672 
	`queue_io
(
md
, 
bio
);

1674 
	`bio_io_îr‹
(
bio
);

1678 
	`__•lô_™d_¥o˚ss_bio
(
md
, 
m≠
, 
bio
);

1679 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1681 
	}
}

1683 
	$dm_ªque°_ba£d
(
m≠≥d_devi˚
 *
md
)

1685  
	`blk_queue_°ackabÀ
(
md
->
queue
);

1686 
	}
}

1688 
	$dm_ªque°
(
ªque°_queue
 *
q
, 
bio
 *bio)

1690 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1692 i‡(
	`dm_ªque°_ba£d
(
md
))

1693 
	`blk_queue_bio
(
q
, 
bio
);

1695 
	`_dm_ªque°
(
q
, 
bio
);

1696 
	}
}

1698 
	$dm_di•©ch_ªque°
(
ªque°
 *
rq
)

1700 
r
;

1702 i‡(
	`blk_queue_io_°©
(
rq
->
q
))

1703 
rq
->
cmd_Êags
 |
REQ_IO_STAT
;

1705 
rq
->
°¨t_time
 = 
jiffõs
;

1706 
r
 = 
	`blk_ö£π_˛⁄ed_ªque°
(
rq
->
q
,Ñq);

1707 i‡(
r
)

1708 
	`dm_com∂ëe_ªque°
(
rq
, 
r
);

1709 
	}
}

1710 
EXPORT_SYMBOL_GPL
(
dm_di•©ch_ªque°
);

1712 
	$dm_rq_bio_c⁄°ru˘‹
(
bio
 *bio, biÿ*
bio_‹ig
,

1713 *
d©a
)

1715 
dm_rq_èrgë_io
 *
tio
 = 
d©a
;

1716 
dm_rq_˛⁄e_bio_öfo
 *
öfo
 =

1717 
	`c⁄èöî_of
(
bio
, 
dm_rq_˛⁄e_bio_öfo
, 
˛⁄e
);

1719 
öfo
->
‹ig
 = 
bio_‹ig
;

1720 
öfo
->
tio
 =Åio;

1721 
bio
->
bi_íd_io
 = 
íd_˛⁄e_bio
;

1724 
	}
}

1726 
	$£tup_˛⁄e
(
ªque°
 *
˛⁄e
, ªque° *
rq
,

1727 
dm_rq_èrgë_io
 *
tio
)

1729 
r
;

1731 
r
 = 
	`blk_rq_¥ï_˛⁄e
(
˛⁄e
, 
rq
, 
tio
->
md
->
bs
, 
GFP_ATOMIC
,

1732 
dm_rq_bio_c⁄°ru˘‹
, 
tio
);

1733 i‡(
r
)

1734  
r
;

1736 
˛⁄e
->
cmd
 = 
rq
->cmd;

1737 
˛⁄e
->
cmd_Àn
 = 
rq
->cmd_len;

1738 
˛⁄e
->
£n£
 = 
rq
->sense;

1739 
˛⁄e
->
íd_io
 = 
íd_˛⁄e_ªque°
;

1740 
˛⁄e
->
íd_io_d©a
 = 
tio
;

1743 
	}
}

1745 
ªque°
 *
	$˛⁄e_rq
(
ªque°
 *
rq
, 
m≠≥d_devi˚
 *
md
,

1746 
gÂ_t
 
gÂ_mask
)

1748 
ªque°
 *
˛⁄e
;

1749 
dm_rq_èrgë_io
 *
tio
;

1751 
tio
 = 
	`Æloc_rq_tio
(
md
, 
gÂ_mask
);

1752 i‡(!
tio
)

1753  
NULL
;

1755 
tio
->
md
 = md;

1756 
tio
->
ti
 = 
NULL
;

1757 
tio
->
‹ig
 = 
rq
;

1758 
tio
->
îr‹
 = 0;

1759 
	`mem£t
(&
tio
->
öfo
, 0, (tio->info));

1761 
˛⁄e
 = &
tio
->clone;

1762 i‡(
	`£tup_˛⁄e
(
˛⁄e
, 
rq
, 
tio
)) {

1764 
	`‰ì_rq_tio
(
tio
);

1765  
NULL
;

1768  
˛⁄e
;

1769 
	}
}

1774 
	$dm_¥ï_‚
(
ªque°_queue
 *
q
, 
ªque°
 *
rq
)

1776 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1777 
ªque°
 *
˛⁄e
;

1779 i‡(
	`u∆ikñy
(
rq
->
•ecül
)) {

1780 
	`DMWARN
("Already has something inÑq->special.");

1781  
BLKPREP_KILL
;

1784 
˛⁄e
 = 
	`˛⁄e_rq
(
rq
, 
md
, 
GFP_ATOMIC
);

1785 i‡(!
˛⁄e
)

1786  
BLKPREP_DEFER
;

1788 
rq
->
•ecül
 = 
˛⁄e
;

1789 
rq
->
cmd_Êags
 |
REQ_DONTPREP
;

1791  
BLKPREP_OK
;

1792 
	}
}

1799 
	$m≠_ªque°
(
dm_èrgë
 *
ti
, 
ªque°
 *
˛⁄e
,

1800 
m≠≥d_devi˚
 *
md
)

1802 
r
, 
ªqueued
 = 0;

1803 
dm_rq_èrgë_io
 *
tio
 = 
˛⁄e
->
íd_io_d©a
;

1805 
tio
->
ti
 =Åi;

1806 
r
 = 
ti
->
ty≥
->
	`m≠_rq
—i, 
˛⁄e
, &
tio
->
öfo
);

1807 
r
) {

1808 
DM_MAPIO_SUBMITTED
:

1811 
DM_MAPIO_REMAPPED
:

1813 
	`åa˚_block_rq_ªm≠
(
˛⁄e
->
q
, cl⁄e, 
	`disk_devt
(
	`dm_disk
(
md
)),

1814 
	`blk_rq_pos
(
tio
->
‹ig
));

1815 
	`dm_di•©ch_ªque°
(
˛⁄e
);

1817 
DM_MAPIO_REQUEUE
:

1819 
	`dm_ªqueue_unm≠≥d_ªque°
(
˛⁄e
);

1820 
ªqueued
 = 1;

1823 i‡(
r
 > 0) {

1824 
	`DMWARN
("unim∂emíãdÅ¨gë m≠Ñëu∫ vÆue: %d", 
r
);

1825 
	`BUG
();

1829 
	`dm_kûl_unm≠≥d_ªque°
(
˛⁄e
, 
r
);

1833  
ªqueued
;

1834 
	}
}

1836 
ªque°
 *
	$dm_°¨t_ªque°
(
m≠≥d_devi˚
 *
md
, 
ªque°
 *
‹ig
)

1838 
ªque°
 *
˛⁄e
;

1840 
	`blk_°¨t_ªque°
(
‹ig
);

1841 
˛⁄e
 = 
‹ig
->
•ecül
;

1842 
	`©omic_öc
(&
md
->
≥ndög
[
	`rq_d©a_dú
(
˛⁄e
)]);

1851 
	`dm_gë
(
md
);

1853  
˛⁄e
;

1854 
	}
}

1860 
	$dm_ªque°_‚
(
ªque°_queue
 *
q
)

1862 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1863 
§cu_idx
;

1864 
dm_èbÀ
 *
m≠
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

1865 
dm_èrgë
 *
ti
;

1866 
ªque°
 *
rq
, *
˛⁄e
;

1867 
£˘‹_t
 
pos
;

1875 !
	`blk_queue_°›≥d
(
q
)) {

1876 
rq
 = 
	`blk_≥ek_ªque°
(
q
);

1877 i‡(!
rq
)

1878 
dñay_™d_out
;

1881 
pos
 = 0;

1882 i‡(!(
rq
->
cmd_Êags
 & 
REQ_FLUSH
))

1883 
pos
 = 
	`blk_rq_pos
(
rq
);

1885 
ti
 = 
	`dm_èbÀ_föd_èrgë
(
m≠
, 
pos
);

1886 i‡(!
	`dm_èrgë_is_vÆid
(
ti
)) {

1891 
	`DMERR_LIMIT
("requestáttemptedáccess beyondÅheÉnd of device");

1892 
˛⁄e
 = 
	`dm_°¨t_ªque°
(
md
, 
rq
);

1893 
	`dm_kûl_unm≠≥d_ªque°
(
˛⁄e
, -
EIO
);

1897 i‡(
ti
->
ty≥
->
busy
 &&Åi->ty≥->
	`busy
(ti))

1898 
dñay_™d_out
;

1900 
˛⁄e
 = 
	`dm_°¨t_ªque°
(
md
, 
rq
);

1902 
	`•ö_u∆ock
(
q
->
queue_lock
);

1903 i‡(
	`m≠_ªque°
(
ti
, 
˛⁄e
, 
md
))

1904 
ªqueued
;

1906 
	`BUG_ON
(!
	`úqs_dißbÀd
());

1907 
	`•ö_lock
(
q
->
queue_lock
);

1910 
out
;

1912 
ªqueued
:

1913 
	`BUG_ON
(!
	`úqs_dißbÀd
());

1914 
	`•ö_lock
(
q
->
queue_lock
);

1916 
dñay_™d_out
:

1917 
	`blk_dñay_queue
(
q
, 
HZ
 / 10);

1918 
out
:

1919 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

1920 
	}
}

1922 
	$dm_undîlyög_devi˚_busy
(
ªque°_queue
 *
q
)

1924  
	`blk_Œd_busy
(
q
);

1925 
	}
}

1926 
EXPORT_SYMBOL_GPL
(
dm_undîlyög_devi˚_busy
);

1928 
	$dm_Œd_busy
(
ªque°_queue
 *
q
)

1930 
r
;

1931 
m≠≥d_devi˚
 *
md
 = 
q
->
queued©a
;

1932 
dm_èbÀ
 *
m≠
 = 
	`dm_gë_live_èbÀ_Á°
(
md
);

1934 i‡(!
m≠
 || 
	`ã°_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
))

1935 
r
 = 1;

1937 
r
 = 
	`dm_èbÀ_™y_busy_èrgë
(
m≠
);

1939 
	`dm_put_live_èbÀ_Á°
(
md
);

1941  
r
;

1942 
	}
}

1944 
	$dm_™y_c⁄ge°ed
(*
c⁄ge°ed_d©a
, 
bdi_bôs
)

1946 
r
 = 
bdi_bôs
;

1947 
m≠≥d_devi˚
 *
md
 = 
c⁄ge°ed_d©a
;

1948 
dm_èbÀ
 *
m≠
;

1950 i‡(!
	`ã°_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
)) {

1951 
m≠
 = 
	`dm_gë_live_èbÀ_Á°
(
md
);

1952 i‡(
m≠
) {

1957 i‡(
	`dm_ªque°_ba£d
(
md
))

1958 
r
 = 
md
->
queue
->
backög_dev_öfo
.
°©e
 &

1959 
bdi_bôs
;

1961 
r
 = 
	`dm_èbÀ_™y_c⁄ge°ed
(
m≠
, 
bdi_bôs
);

1963 
	`dm_put_live_èbÀ_Á°
(
md
);

1966  
r
;

1967 
	}
}

1972 
	$‰ì_mö‹
(
mö‹
)

1974 
	`•ö_lock
(&
_mö‹_lock
);

1975 
	`idr_ªmove
(&
_mö‹_idr
, 
mö‹
);

1976 
	`•ö_u∆ock
(&
_mö‹_lock
);

1977 
	}
}

1982 
	$•ecific_mö‹
(
mö‹
)

1984 
r
;

1986 i‡(
mö‹
 >(1 << 
MINORBITS
))

1987  -
EINVAL
;

1989 
	`idr_¥ñﬂd
(
GFP_KERNEL
);

1990 
	`•ö_lock
(&
_mö‹_lock
);

1992 
r
 = 
	`idr_Æloc
(&
_mö‹_idr
, 
MINOR_ALLOCED
, 
mö‹
, mö‹ + 1, 
GFP_NOWAIT
);

1994 
	`•ö_u∆ock
(&
_mö‹_lock
);

1995 
	`idr_¥ñﬂd_íd
();

1996 i‡(
r
 < 0)

1997  
r
 =-
ENOSPC
 ? -
EBUSY
 :Ñ;

1999 
	}
}

2001 
	$√xt_‰ì_mö‹
(*
mö‹
)

2003 
r
;

2005 
	`idr_¥ñﬂd
(
GFP_KERNEL
);

2006 
	`•ö_lock
(&
_mö‹_lock
);

2008 
r
 = 
	`idr_Æloc
(&
_mö‹_idr
, 
MINOR_ALLOCED
, 0, 1 << 
MINORBITS
, 
GFP_NOWAIT
);

2010 
	`•ö_u∆ock
(&
_mö‹_lock
);

2011 
	`idr_¥ñﬂd_íd
();

2012 i‡(
r
 < 0)

2013  
r
;

2014 *
mö‹
 = 
r
;

2016 
	}
}

2018 c⁄° 
block_devi˚_›î©i⁄s
 
	gdm_blk_d›s
;

2020 
dm_wq_w‹k
(
w‹k_°ru˘
 *
w‹k
);

2022 
	$dm_öô_md_queue
(
m≠≥d_devi˚
 *
md
)

2033 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_STACKABLE
, 
md
->
queue
);

2035 
md
->
queue
->
queued©a
 = md;

2036 
md
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
dm_™y_c⁄ge°ed
;

2037 
md
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = md;

2038 
	`blk_queue_make_ªque°
(
md
->
queue
, 
dm_ªque°
);

2039 
	`blk_queue_boun˚_limô
(
md
->
queue
, 
BLK_BOUNCE_ANY
);

2040 
	`blk_queue_mîge_bvec
(
md
->
queue
, 
dm_mîge_bvec
);

2041 
	}
}

2046 
m≠≥d_devi˚
 *
	$Æloc_dev
(
mö‹
)

2048 
r
;

2049 
m≠≥d_devi˚
 *
md
 = 
	`kzÆloc
((*md), 
GFP_KERNEL
);

2050 *
ﬁd_md
;

2052 i‡(!
md
) {

2053 
	`DMWARN
("unableÅoállocate device, out of memory.");

2054  
NULL
;

2057 i‡(!
	`åy_moduÀ_gë
(
THIS_MODULE
))

2058 
bad_moduÀ_gë
;

2061 i‡(
mö‹
 =
DM_ANY_MINOR
)

2062 
r
 = 
	`√xt_‰ì_mö‹
(&
mö‹
);

2064 
r
 = 
	`•ecific_mö‹
(
mö‹
);

2065 i‡(
r
 < 0)

2066 
bad_mö‹
;

2068 
r
 = 
	`öô_§cu_°ru˘
(&
md
->
io_b¨rõr
);

2069 i‡(
r
 < 0)

2070 
bad_io_b¨rõr
;

2072 
md
->
ty≥
 = 
DM_TYPE_NONE
;

2073 
	`muãx_öô
(&
md
->
su•íd_lock
);

2074 
	`muãx_öô
(&
md
->
ty≥_lock
);

2075 
	`muãx_öô
(&
md
->
èbÀ_devi˚s_lock
);

2076 
	`•ö_lock_öô
(&
md
->
de„ºed_lock
);

2077 
	`©omic_£t
(&
md
->
hﬁdîs
, 1);

2078 
	`©omic_£t
(&
md
->
›í_cou¡
, 0);

2079 
	`©omic_£t
(&
md
->
evít_ƒ
, 0);

2080 
	`©omic_£t
(&
md
->
uevít_£q
, 0);

2081 
	`INIT_LIST_HEAD
(&
md
->
uevít_li°
);

2082 
	`INIT_LIST_HEAD
(&
md
->
èbÀ_devi˚s
);

2083 
	`•ö_lock_öô
(&
md
->
uevít_lock
);

2085 
md
->
queue
 = 
	`blk_Æloc_queue
(
GFP_KERNEL
);

2086 i‡(!
md
->
queue
)

2087 
bad_queue
;

2089 
	`dm_öô_md_queue
(
md
);

2091 
md
->
disk
 = 
	`Æloc_disk
(1);

2092 i‡(!
md
->
disk
)

2093 
bad_disk
;

2095 
	`©omic_£t
(&
md
->
≥ndög
[0], 0);

2096 
	`©omic_£t
(&
md
->
≥ndög
[1], 0);

2097 
	`öô_waôqueue_hód
(&
md
->
waô
);

2098 
	`INIT_WORK
(&
md
->
w‹k
, 
dm_wq_w‹k
);

2099 
	`öô_waôqueue_hód
(&
md
->
evítq
);

2100 
	`öô_com∂ëi⁄
(&
md
->
kobj_hﬁdî
.
com∂ëi⁄
);

2102 
md
->
disk
->
maj‹
 = 
_maj‹
;

2103 
md
->
disk
->
fú°_mö‹
 = 
mö‹
;

2104 
md
->
disk
->
f›s
 = &
dm_blk_d›s
;

2105 
md
->
disk
->
queue
 = md->queue;

2106 
md
->
disk
->
¥iv©e_d©a
 = md;

2107 
	`•rötf
(
md
->
disk
->
disk_«me
, "dm-%d", 
mö‹
);

2108 
	`add_disk
(
md
->
disk
);

2109 
	`f‹m©_dev_t
(
md
->
«me
, 
	`MKDEV
(
_maj‹
, 
mö‹
));

2111 
md
->
wq
 = 
	`Æloc_w‹kqueue
("kdmÊush", 
WQ_MEM_RECLAIM
, 0);

2112 i‡(!
md
->
wq
)

2113 
bad_thªad
;

2115 
md
->
bdev
 = 
	`bdgë_disk
(md->
disk
, 0);

2116 i‡(!
md
->
bdev
)

2117 
bad_bdev
;

2119 
	`bio_öô
(&
md
->
Êush_bio
);

2120 
md
->
Êush_bio
.
bi_bdev
 = md->
bdev
;

2121 
md
->
Êush_bio
.
bi_rw
 = 
WRITE_FLUSH
;

2123 
	`dm_°©s_öô
(&
md
->
°©s
);

2126 
	`•ö_lock
(&
_mö‹_lock
);

2127 
ﬁd_md
 = 
	`idr_ª∂a˚
(&
_mö‹_idr
, 
md
, 
mö‹
);

2128 
	`•ö_u∆ock
(&
_mö‹_lock
);

2130 
	`BUG_ON
(
ﬁd_md
 !
MINOR_ALLOCED
);

2132  
md
;

2134 
bad_bdev
:

2135 
	`de°roy_w‹kqueue
(
md
->
wq
);

2136 
bad_thªad
:

2137 
	`dñ_gídisk
(
md
->
disk
);

2138 
	`put_disk
(
md
->
disk
);

2139 
bad_disk
:

2140 
	`blk_˛ónup_queue
(
md
->
queue
);

2141 
bad_queue
:

2142 
	`˛ónup_§cu_°ru˘
(&
md
->
io_b¨rõr
);

2143 
bad_io_b¨rõr
:

2144 
	`‰ì_mö‹
(
mö‹
);

2145 
bad_mö‹
:

2146 
	`moduÀ_put
(
THIS_MODULE
);

2147 
bad_moduÀ_gë
:

2148 
	`k‰ì
(
md
);

2149  
NULL
;

2150 
	}
}

2152 
u∆ock_fs
(
m≠≥d_devi˚
 *
md
);

2154 
	$‰ì_dev
(
m≠≥d_devi˚
 *
md
)

2156 
mö‹
 = 
	`MINOR
(
	`disk_devt
(
md
->
disk
));

2158 
	`u∆ock_fs
(
md
);

2159 
	`bdput
(
md
->
bdev
);

2160 
	`de°roy_w‹kqueue
(
md
->
wq
);

2161 i‡(
md
->
io_poﬁ
)

2162 
	`mempoﬁ_de°roy
(
md
->
io_poﬁ
);

2163 i‡(
md
->
bs
)

2164 
	`bio£t_‰ì
(
md
->
bs
);

2165 
	`blk_öãgrôy_uƒegi°î
(
md
->
disk
);

2166 
	`dñ_gídisk
(
md
->
disk
);

2167 
	`˛ónup_§cu_°ru˘
(&
md
->
io_b¨rõr
);

2168 
	`‰ì_èbÀ_devi˚s
(&
md
->
èbÀ_devi˚s
);

2169 
	`‰ì_mö‹
(
mö‹
);

2171 
	`•ö_lock
(&
_mö‹_lock
);

2172 
md
->
disk
->
¥iv©e_d©a
 = 
NULL
;

2173 
	`•ö_u∆ock
(&
_mö‹_lock
);

2175 
	`put_disk
(
md
->
disk
);

2176 
	`blk_˛ónup_queue
(
md
->
queue
);

2177 
	`dm_°©s_˛ónup
(&
md
->
°©s
);

2178 
	`moduÀ_put
(
THIS_MODULE
);

2179 
	`k‰ì
(
md
);

2180 
	}
}

2182 
	$__böd_mempoﬁs
(
m≠≥d_devi˚
 *
md
, 
dm_èbÀ
 *
t
)

2184 
dm_md_mempoﬁs
 *
p
 = 
	`dm_èbÀ_gë_md_mempoﬁs
(
t
);

2186 i‡(
md
->
io_poﬁ
 && md->
bs
) {

2188 i‡(
	`dm_èbÀ_gë_ty≥
(
t
Ë=
DM_TYPE_BIO_BASED
) {

2193 
	`bio£t_‰ì
(
md
->
bs
);

2194 
md
->
bs
 = 
p
->bs;

2195 
p
->
bs
 = 
NULL
;

2196 } i‡(
	`dm_èbÀ_gë_ty≥
(
t
Ë=
DM_TYPE_REQUEST_BASED
) {

2206 
out
;

2209 
	`BUG_ON
(!
p
 || 
md
->
io_poﬁ
 || md->
bs
);

2211 
md
->
io_poﬁ
 = 
p
->io_pool;

2212 
p
->
io_poﬁ
 = 
NULL
;

2213 
md
->
bs
 = 
p
->bs;

2214 
p
->
bs
 = 
NULL
;

2216 
out
:

2218 
	`dm_èbÀ_‰ì_md_mempoﬁs
(
t
);

2219 
	}
}

2224 
	$evít_ˇŒback
(*
c⁄ãxt
)

2226 
Êags
;

2227 
	`LIST_HEAD
(
uevíts
);

2228 
m≠≥d_devi˚
 *
md
 = (m≠≥d_devi˚ *Ë
c⁄ãxt
;

2230 
	`•ö_lock_úqßve
(&
md
->
uevít_lock
, 
Êags
);

2231 
	`li°_•li˚_öô
(&
md
->
uevít_li°
, &
uevíts
);

2232 
	`•ö_u∆ock_úqª°‹e
(&
md
->
uevít_lock
, 
Êags
);

2234 
	`dm_£nd_uevíts
(&
uevíts
, &
	`disk_to_dev
(
md
->
disk
)->
kobj
);

2236 
	`©omic_öc
(&
md
->
evít_ƒ
);

2237 
	`wake_up
(&
md
->
evítq
);

2238 
	}
}

2243 
	$__£t_size
(
m≠≥d_devi˚
 *
md
, 
£˘‹_t
 
size
)

2245 
	`£t_ˇ∑côy
(
md
->
disk
, 
size
);

2247 
	`i_size_wrôe
(
md
->
bdev
->
bd_öode
, (
loff_t
)
size
 << 
SECTOR_SHIFT
);

2248 
	}
}

2257 
	$dm_queue_mîge_is_compuls‹y
(
ªque°_queue
 *
q
)

2259 
m≠≥d_devi˚
 *
dev_md
;

2261 i‡(!
q
->
mîge_bvec_‚
)

2264 i‡(
q
->
make_ªque°_‚
 =
dm_ªque°
) {

2265 
dev_md
 = 
q
->
queued©a
;

2266 i‡(
	`ã°_bô
(
DMF_MERGE_IS_OPTIONAL
, &
dev_md
->
Êags
))

2271 
	}
}

2273 
	$dm_devi˚_mîge_is_compuls‹y
(
dm_èrgë
 *
ti
,

2274 
dm_dev
 *
dev
, 
£˘‹_t
 
°¨t
,

2275 
£˘‹_t
 
Àn
, *
d©a
)

2277 
block_devi˚
 *
bdev
 = 
dev
->bdev;

2278 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
bdev
);

2280  
	`dm_queue_mîge_is_compuls‹y
(
q
);

2281 
	}
}

2287 
	$dm_èbÀ_mîge_is_›ti⁄Æ
(
dm_èbÀ
 *
èbÀ
)

2289 
i
 = 0;

2290 
dm_èrgë
 *
ti
;

2292 
i
 < 
	`dm_èbÀ_gë_num_èrgës
(
èbÀ
)) {

2293 
ti
 = 
	`dm_èbÀ_gë_èrgë
(
èbÀ
, 
i
++);

2295 i‡(
ti
->
ty≥
->
ôî©e_devi˚s
 &&

2296 
ti
->
ty≥
->
	`ôî©e_devi˚s
—i, 
dm_devi˚_mîge_is_compuls‹y
, 
NULL
))

2301 
	}
}

2306 
dm_èbÀ
 *
	$__böd
(
m≠≥d_devi˚
 *
md
, 
dm_èbÀ
 *
t
,

2307 
queue_limôs
 *
limôs
)

2309 
dm_èbÀ
 *
ﬁd_m≠
;

2310 
ªque°_queue
 *
q
 = 
md
->
queue
;

2311 
£˘‹_t
 
size
;

2312 
mîge_is_›ti⁄Æ
;

2314 
size
 = 
	`dm_èbÀ_gë_size
(
t
);

2319 i‡(
size
 !
	`dm_gë_size
(
md
))

2320 
	`mem£t
(&
md
->
geomëry
, 0, (md->geometry));

2322 
	`__£t_size
(
md
, 
size
);

2324 
	`dm_èbÀ_evít_ˇŒback
(
t
, 
evít_ˇŒback
, 
md
);

2333 i‡(
	`dm_èbÀ_ªque°_ba£d
(
t
Ë&& !
	`blk_queue_°›≥d
(
q
))

2334 
	`°›_queue
(
q
);

2336 
	`__böd_mempoﬁs
(
md
, 
t
);

2338 
mîge_is_›ti⁄Æ
 = 
	`dm_èbÀ_mîge_is_›ti⁄Æ
(
t
);

2340 
ﬁd_m≠
 = 
md
->
m≠
;

2341 
	`rcu_assign_poöãr
(
md
->
m≠
, 
t
);

2342 
md
->
immuèbÀ_èrgë_ty≥
 = 
	`dm_èbÀ_gë_immuèbÀ_èrgë_ty≥
(
t
);

2344 
	`dm_èbÀ_£t_ª°ri˘i⁄s
(
t
, 
q
, 
limôs
);

2345 i‡(
mîge_is_›ti⁄Æ
)

2346 
	`£t_bô
(
DMF_MERGE_IS_OPTIONAL
, &
md
->
Êags
);

2348 
	`˛ór_bô
(
DMF_MERGE_IS_OPTIONAL
, &
md
->
Êags
);

2349 
	`dm_sync_èbÀ
(
md
);

2351  
ﬁd_m≠
;

2352 
	}
}

2357 
dm_èbÀ
 *
	$__unböd
(
m≠≥d_devi˚
 *
md
)

2359 
dm_èbÀ
 *
m≠
 = 
md
->map;

2361 i‡(!
m≠
)

2362  
NULL
;

2364 
	`dm_èbÀ_evít_ˇŒback
(
m≠
, 
NULL
, NULL);

2365 
	`RCU_INIT_POINTER
(
md
->
m≠
, 
NULL
);

2366 
	`dm_sync_èbÀ
(
md
);

2368  
m≠
;

2369 
	}
}

2374 
	$dm_¸óã
(
mö‹
, 
m≠≥d_devi˚
 **
ªsu…
)

2376 
m≠≥d_devi˚
 *
md
;

2378 
md
 = 
	`Æloc_dev
(
mö‹
);

2379 i‡(!
md
)

2380  -
ENXIO
;

2382 
	`dm_sysfs_öô
(
md
);

2384 *
ªsu…
 = 
md
;

2386 
	}
}

2392 
	$dm_lock_md_ty≥
(
m≠≥d_devi˚
 *
md
)

2394 
	`muãx_lock
(&
md
->
ty≥_lock
);

2395 
	}
}

2397 
	$dm_u∆ock_md_ty≥
(
m≠≥d_devi˚
 *
md
)

2399 
	`muãx_u∆ock
(&
md
->
ty≥_lock
);

2400 
	}
}

2402 
	$dm_£t_md_ty≥
(
m≠≥d_devi˚
 *
md
, 
ty≥
)

2404 
	`BUG_ON
(!
	`muãx_is_locked
(&
md
->
ty≥_lock
));

2405 
md
->
ty≥
 =Åype;

2406 
	}
}

2408 
	$dm_gë_md_ty≥
(
m≠≥d_devi˚
 *
md
)

2410 
	`BUG_ON
(!
	`muãx_is_locked
(&
md
->
ty≥_lock
));

2411  
md
->
ty≥
;

2412 
	}
}

2414 
èrgë_ty≥
 *
	$dm_gë_immuèbÀ_èrgë_ty≥
(
m≠≥d_devi˚
 *
md
)

2416  
md
->
immuèbÀ_èrgë_ty≥
;

2417 
	}
}

2423 
queue_limôs
 *
	$dm_gë_queue_limôs
(
m≠≥d_devi˚
 *
md
)

2425 
	`BUG_ON
(!
	`©omic_ªad
(&
md
->
hﬁdîs
));

2426  &
md
->
queue
->
limôs
;

2427 
	}
}

2428 
EXPORT_SYMBOL_GPL
(
dm_gë_queue_limôs
);

2433 
	$dm_öô_ªque°_ba£d_queue
(
m≠≥d_devi˚
 *
md
)

2435 
ªque°_queue
 *
q
 = 
NULL
;

2437 i‡(
md
->
queue
->
ñev©‹
)

2441 
q
 = 
	`blk_öô_Æloˇãd_queue
(
md
->
queue
, 
dm_ªque°_‚
, 
NULL
);

2442 i‡(!
q
)

2445 
md
->
queue
 = 
q
;

2446 
	`dm_öô_md_queue
(
md
);

2447 
	`blk_queue_so·úq_d⁄e
(
md
->
queue
, 
dm_so·úq_d⁄e
);

2448 
	`blk_queue_¥ï_rq
(
md
->
queue
, 
dm_¥ï_‚
);

2449 
	`blk_queue_Œd_busy
(
md
->
queue
, 
dm_Œd_busy
);

2451 
	`ñv_ªgi°î_queue
(
md
->
queue
);

2454 
	}
}

2459 
	$dm_£tup_md_queue
(
m≠≥d_devi˚
 *
md
)

2461 i‡((
	`dm_gë_md_ty≥
(
md
Ë=
DM_TYPE_REQUEST_BASED
) &&

2462 !
	`dm_öô_ªque°_ba£d_queue
(
md
)) {

2463 
	`DMWARN
("Cannot initialize queue forÑequest-based mapped device");

2464  -
EINVAL
;

2468 
	}
}

2470 
m≠≥d_devi˚
 *
	$dm_föd_md
(
dev_t
 
dev
)

2472 
m≠≥d_devi˚
 *
md
;

2473 
mö‹
 = 
	`MINOR
(
dev
);

2475 i‡(
	`MAJOR
(
dev
Ë!
_maj‹
 || 
mö‹
 >(1 << 
MINORBITS
))

2476  
NULL
;

2478 
	`•ö_lock
(&
_mö‹_lock
);

2480 
md
 = 
	`idr_föd
(&
_mö‹_idr
, 
mö‹
);

2481 i‡(
md
 && (md =
MINOR_ALLOCED
 ||

2482 (
	`MINOR
(
	`disk_devt
(
	`dm_disk
(
md
))Ë!
mö‹
) ||

2483 
	`dm_dñëög_md
(
md
) ||

2484 
	`ã°_bô
(
DMF_FREEING
, &
md
->
Êags
))) {

2485 
md
 = 
NULL
;

2486 
out
;

2489 
out
:

2490 
	`•ö_u∆ock
(&
_mö‹_lock
);

2492  
md
;

2493 
	}
}

2495 
m≠≥d_devi˚
 *
	$dm_gë_md
(
dev_t
 
dev
)

2497 
m≠≥d_devi˚
 *
md
 = 
	`dm_föd_md
(
dev
);

2499 i‡(
md
)

2500 
	`dm_gë
(
md
);

2502  
md
;

2503 
	}
}

2504 
EXPORT_SYMBOL_GPL
(
dm_gë_md
);

2506 *
	$dm_gë_md±r
(
m≠≥d_devi˚
 *
md
)

2508  
md
->
öãrÁ˚_±r
;

2509 
	}
}

2511 
	$dm_£t_md±r
(
m≠≥d_devi˚
 *
md
, *
±r
)

2513 
md
->
öãrÁ˚_±r
 = 
±r
;

2514 
	}
}

2516 
	$dm_gë
(
m≠≥d_devi˚
 *
md
)

2518 
	`©omic_öc
(&
md
->
hﬁdîs
);

2519 
	`BUG_ON
(
	`ã°_bô
(
DMF_FREEING
, &
md
->
Êags
));

2520 
	}
}

2522 c⁄° *
	$dm_devi˚_«me
(
m≠≥d_devi˚
 *
md
)

2524  
md
->
«me
;

2525 
	}
}

2526 
EXPORT_SYMBOL_GPL
(
dm_devi˚_«me
);

2528 
	$__dm_de°roy
(
m≠≥d_devi˚
 *
md
, 
boﬁ
 
waô
)

2530 
dm_èbÀ
 *
m≠
;

2531 
§cu_idx
;

2533 
	`might_¶ìp
();

2535 
	`•ö_lock
(&
_mö‹_lock
);

2536 
m≠
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

2537 
	`idr_ª∂a˚
(&
_mö‹_idr
, 
MINOR_ALLOCED
, 
	`MINOR
(
	`disk_devt
(
	`dm_disk
(
md
))));

2538 
	`£t_bô
(
DMF_FREEING
, &
md
->
Êags
);

2539 
	`•ö_u∆ock
(&
_mö‹_lock
);

2541 i‡(!
	`dm_su•íded_md
(
md
)) {

2542 
	`dm_èbÀ_¥esu•íd_èrgës
(
m≠
);

2543 
	`dm_èbÀ_po°su•íd_èrgës
(
m≠
);

2547 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

2555 i‡(
waô
)

2556 
	`©omic_ªad
(&
md
->
hﬁdîs
))

2557 
	`m¶ìp
(1);

2558 i‡(
	`©omic_ªad
(&
md
->
hﬁdîs
))

2559 
	`DMWARN
("%s: ForciblyÑemoving mapped_device still in use! (%d users)",

2560 
	`dm_devi˚_«me
(
md
), 
	`©omic_ªad
(&md->
hﬁdîs
));

2562 
	`dm_sysfs_exô
(
md
);

2563 
	`dm_èbÀ_de°roy
(
	`__unböd
(
md
));

2564 
	`‰ì_dev
(
md
);

2565 
	}
}

2567 
	$dm_de°roy
(
m≠≥d_devi˚
 *
md
)

2569 
	`__dm_de°roy
(
md
, 
åue
);

2570 
	}
}

2572 
	$dm_de°roy_immedüã
(
m≠≥d_devi˚
 *
md
)

2574 
	`__dm_de°roy
(
md
, 
Ál£
);

2575 
	}
}

2577 
	$dm_put
(
m≠≥d_devi˚
 *
md
)

2579 
	`©omic_dec
(&
md
->
hﬁdîs
);

2580 
	}
}

2581 
EXPORT_SYMBOL_GPL
(
dm_put
);

2583 
	$dm_waô_f‹_com∂ëi⁄
(
m≠≥d_devi˚
 *
md
, 
öãºu±ibÀ
)

2585 
r
 = 0;

2586 
	`DECLARE_WAITQUEUE
(
waô
, 
cuºít
);

2588 
	`add_waô_queue
(&
md
->
waô
, &wait);

2591 
	`£t_cuºít_°©e
(
öãºu±ibÀ
);

2593 i‡(!
	`md_ö_Êight
(
md
))

2596 i‡(
öãºu±ibÀ
 =
TASK_INTERRUPTIBLE
 &&

2597 
	`sig«l_≥ndög
(
cuºít
)) {

2598 
r
 = -
EINTR
;

2602 
	`io_scheduÀ
();

2604 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

2606 
	`ªmove_waô_queue
(&
md
->
waô
, &wait);

2608  
r
;

2609 
	}
}

2614 
	$dm_wq_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2616 
m≠≥d_devi˚
 *
md
 = 
	`c⁄èöî_of
(
w‹k
, mapped_device,

2617 
w‹k
);

2618 
bio
 *
c
;

2619 
§cu_idx
;

2620 
dm_èbÀ
 *
m≠
;

2622 
m≠
 = 
	`dm_gë_live_èbÀ
(
md
, &
§cu_idx
);

2624 !
	`ã°_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
)) {

2625 
	`•ö_lock_úq
(&
md
->
de„ºed_lock
);

2626 
c
 = 
	`bio_li°_p›
(&
md
->
de„ºed
);

2627 
	`•ö_u∆ock_úq
(&
md
->
de„ºed_lock
);

2629 i‡(!
c
)

2632 i‡(
	`dm_ªque°_ba£d
(
md
))

2633 
	`gíîic_make_ªque°
(
c
);

2635 
	`__•lô_™d_¥o˚ss_bio
(
md
, 
m≠
, 
c
);

2638 
	`dm_put_live_èbÀ
(
md
, 
§cu_idx
);

2639 
	}
}

2641 
	$dm_queue_Êush
(
m≠≥d_devi˚
 *
md
)

2643 
	`˛ór_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
);

2644 
	`smp_mb__a·î_©omic
();

2645 
	`queue_w‹k
(
md
->
wq
, &md->
w‹k
);

2646 
	}
}

2651 
dm_èbÀ
 *
	$dm_sw≠_èbÀ
(
m≠≥d_devi˚
 *
md
, 
dm_èbÀ
 *
èbÀ
)

2653 
dm_èbÀ
 *
live_m≠
 = 
NULL
, *
m≠
 = 
	`ERR_PTR
(-
EINVAL
);

2654 
queue_limôs
 
limôs
;

2655 
r
;

2657 
	`muãx_lock
(&
md
->
su•íd_lock
);

2660 i‡(!
	`dm_su•íded_md
(
md
))

2661 
out
;

2669 i‡(
	`dm_èbÀ_has_no_d©a_devi˚s
(
èbÀ
)) {

2670 
live_m≠
 = 
	`dm_gë_live_èbÀ_Á°
(
md
);

2671 i‡(
live_m≠
)

2672 
limôs
 = 
md
->
queue
->limits;

2673 
	`dm_put_live_èbÀ_Á°
(
md
);

2676 i‡(!
live_m≠
) {

2677 
r
 = 
	`dm_ˇlcuœã_queue_limôs
(
èbÀ
, &
limôs
);

2678 i‡(
r
) {

2679 
m≠
 = 
	`ERR_PTR
(
r
);

2680 
out
;

2684 
m≠
 = 
	`__böd
(
md
, 
èbÀ
, &
limôs
);

2686 
out
:

2687 
	`muãx_u∆ock
(&
md
->
su•íd_lock
);

2688  
m≠
;

2689 
	}
}

2695 
	$lock_fs
(
m≠≥d_devi˚
 *
md
)

2697 
r
;

2699 
	`WARN_ON
(
md
->
‰ozí_sb
);

2701 
md
->
‰ozí_sb
 = 
	`‰ìze_bdev
(md->
bdev
);

2702 i‡(
	`IS_ERR
(
md
->
‰ozí_sb
)) {

2703 
r
 = 
	`PTR_ERR
(
md
->
‰ozí_sb
);

2704 
md
->
‰ozí_sb
 = 
NULL
;

2705  
r
;

2708 
	`£t_bô
(
DMF_FROZEN
, &
md
->
Êags
);

2711 
	}
}

2713 
	$u∆ock_fs
(
m≠≥d_devi˚
 *
md
)

2715 i‡(!
	`ã°_bô
(
DMF_FROZEN
, &
md
->
Êags
))

2718 
	`thaw_bdev
(
md
->
bdev
, md->
‰ozí_sb
);

2719 
md
->
‰ozí_sb
 = 
NULL
;

2720 
	`˛ór_bô
(
DMF_FROZEN
, &
md
->
Êags
);

2721 
	}
}

2739 
	$dm_su•íd
(
m≠≥d_devi˚
 *
md
, 
su•íd_Êags
)

2741 
dm_èbÀ
 *
m≠
 = 
NULL
;

2742 
r
 = 0;

2743 
do_lockfs
 = 
su•íd_Êags
 & 
DM_SUSPEND_LOCKFS_FLAG
 ? 1 : 0;

2744 
noÊush
 = 
su•íd_Êags
 & 
DM_SUSPEND_NOFLUSH_FLAG
 ? 1 : 0;

2746 
	`muãx_lock
(&
md
->
su•íd_lock
);

2748 i‡(
	`dm_su•íded_md
(
md
)) {

2749 
r
 = -
EINVAL
;

2750 
out_u∆ock
;

2753 
m≠
 = 
md
->map;

2759 i‡(
noÊush
)

2760 
	`£t_bô
(
DMF_NOFLUSH_SUSPENDING
, &
md
->
Êags
);

2763 
	`dm_èbÀ_¥esu•íd_èrgës
(
m≠
);

2771 i‡(!
noÊush
 && 
do_lockfs
) {

2772 
r
 = 
	`lock_fs
(
md
);

2773 i‡(
r
)

2774 
out_u∆ock
;

2789 
	`£t_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
);

2790 
	`synchr⁄ize_§cu
(&
md
->
io_b¨rõr
);

2796 i‡(
	`dm_ªque°_ba£d
(
md
))

2797 
	`°›_queue
(
md
->
queue
);

2799 
	`Êush_w‹kqueue
(
md
->
wq
);

2806 
r
 = 
	`dm_waô_f‹_com∂ëi⁄
(
md
, 
TASK_INTERRUPTIBLE
);

2808 i‡(
noÊush
)

2809 
	`˛ór_bô
(
DMF_NOFLUSH_SUSPENDING
, &
md
->
Êags
);

2810 
	`synchr⁄ize_§cu
(&
md
->
io_b¨rõr
);

2813 i‡(
r
 < 0) {

2814 
	`dm_queue_Êush
(
md
);

2816 i‡(
	`dm_ªque°_ba£d
(
md
))

2817 
	`°¨t_queue
(
md
->
queue
);

2819 
	`u∆ock_fs
(
md
);

2820 
out_u∆ock
;

2829 
	`£t_bô
(
DMF_SUSPENDED
, &
md
->
Êags
);

2831 
	`dm_èbÀ_po°su•íd_èrgës
(
m≠
);

2833 
out_u∆ock
:

2834 
	`muãx_u∆ock
(&
md
->
su•íd_lock
);

2835  
r
;

2836 
	}
}

2838 
	$dm_ªsume
(
m≠≥d_devi˚
 *
md
)

2840 
r
 = -
EINVAL
;

2841 
dm_èbÀ
 *
m≠
 = 
NULL
;

2843 
	`muãx_lock
(&
md
->
su•íd_lock
);

2844 i‡(!
	`dm_su•íded_md
(
md
))

2845 
out
;

2847 
m≠
 = 
md
->map;

2848 i‡(!
m≠
 || !
	`dm_èbÀ_gë_size
(map))

2849 
out
;

2851 
r
 = 
	`dm_èbÀ_ªsume_èrgës
(
m≠
);

2852 i‡(
r
)

2853 
out
;

2855 
	`dm_queue_Êush
(
md
);

2862 i‡(
	`dm_ªque°_ba£d
(
md
))

2863 
	`°¨t_queue
(
md
->
queue
);

2865 
	`u∆ock_fs
(
md
);

2867 
	`˛ór_bô
(
DMF_SUSPENDED
, &
md
->
Êags
);

2869 
r
 = 0;

2870 
out
:

2871 
	`muãx_u∆ock
(&
md
->
su•íd_lock
);

2873  
r
;

2874 
	}
}

2885 
	$dm_öã∫Æ_su•íd
(
m≠≥d_devi˚
 *
md
)

2887 
	`muãx_lock
(&
md
->
su•íd_lock
);

2888 i‡(
	`dm_su•íded_md
(
md
))

2891 
	`£t_bô
(
DMF_BLOCK_IO_FOR_SUSPEND
, &
md
->
Êags
);

2892 
	`synchr⁄ize_§cu
(&
md
->
io_b¨rõr
);

2893 
	`Êush_w‹kqueue
(
md
->
wq
);

2894 
	`dm_waô_f‹_com∂ëi⁄
(
md
, 
TASK_UNINTERRUPTIBLE
);

2895 
	}
}

2897 
	$dm_öã∫Æ_ªsume
(
m≠≥d_devi˚
 *
md
)

2899 i‡(
	`dm_su•íded_md
(
md
))

2900 
d⁄e
;

2902 
	`dm_queue_Êush
(
md
);

2904 
d⁄e
:

2905 
	`muãx_u∆ock
(&
md
->
su•íd_lock
);

2906 
	}
}

2911 
	$dm_kobje˘_uevít
(
m≠≥d_devi˚
 *
md
, 
kobje˘_a˘i⁄
 
a˘i⁄
,

2912 
cookõ
)

2914 
udev_cookõ
[
DM_COOKIE_LENGTH
];

2915 *
ívp
[] = { 
udev_cookõ
, 
NULL
 };

2917 i‡(!
cookõ
)

2918  
	`kobje˘_uevít
(&
	`disk_to_dev
(
md
->
disk
)->
kobj
, 
a˘i⁄
);

2920 
	`¢¥ötf
(
udev_cookõ
, 
DM_COOKIE_LENGTH
, "%s=%u",

2921 
DM_COOKIE_ENV_VAR_NAME
, 
cookõ
);

2922  
	`kobje˘_uevít_ív
(&
	`disk_to_dev
(
md
->
disk
)->
kobj
,

2923 
a˘i⁄
, 
ívp
);

2925 
	}
}

2927 
uöt32_t
 
	$dm_√xt_uevít_£q
(
m≠≥d_devi˚
 *
md
)

2929  
	`©omic_add_ªtu∫
(1, &
md
->
uevít_£q
);

2930 
	}
}

2932 
uöt32_t
 
	$dm_gë_evít_ƒ
(
m≠≥d_devi˚
 *
md
)

2934  
	`©omic_ªad
(&
md
->
evít_ƒ
);

2935 
	}
}

2937 
	$dm_waô_evít
(
m≠≥d_devi˚
 *
md
, 
evít_ƒ
)

2939  
	`waô_evít_öãºu±ibÀ
(
md
->
evítq
,

2940 (
evít_ƒ
 !
	`©omic_ªad
(&
md
->event_nr)));

2941 
	}
}

2943 
	$dm_uevít_add
(
m≠≥d_devi˚
 *
md
, 
li°_hód
 *
ñi°
)

2945 
Êags
;

2947 
	`•ö_lock_úqßve
(&
md
->
uevít_lock
, 
Êags
);

2948 
	`li°_add
(
ñi°
, &
md
->
uevít_li°
);

2949 
	`•ö_u∆ock_úqª°‹e
(&
md
->
uevít_lock
, 
Êags
);

2950 
	}
}

2956 
gídisk
 *
	$dm_disk
(
m≠≥d_devi˚
 *
md
)

2958  
md
->
disk
;

2959 
	}
}

2961 
kobje˘
 *
	$dm_kobje˘
(
m≠≥d_devi˚
 *
md
)

2963  &
md
->
kobj_hﬁdî
.
kobj
;

2964 
	}
}

2966 
m≠≥d_devi˚
 *
	$dm_gë_‰om_kobje˘
(
kobje˘
 *
kobj
)

2968 
m≠≥d_devi˚
 *
md
;

2970 
md
 = 
	`c⁄èöî_of
(
kobj
, 
m≠≥d_devi˚
, 
kobj_hﬁdî
.kobj);

2972 i‡(
	`ã°_bô
(
DMF_FREEING
, &
md
->
Êags
) ||

2973 
	`dm_dñëög_md
(
md
))

2974  
NULL
;

2976 
	`dm_gë
(
md
);

2977  
md
;

2978 
	}
}

2980 
	$dm_su•íded_md
(
m≠≥d_devi˚
 *
md
)

2982  
	`ã°_bô
(
DMF_SUSPENDED
, &
md
->
Êags
);

2983 
	}
}

2985 
	$dm_ã°_de„ºed_ªmove_Êag
(
m≠≥d_devi˚
 *
md
)

2987  
	`ã°_bô
(
DMF_DEFERRED_REMOVE
, &
md
->
Êags
);

2988 
	}
}

2990 
	$dm_su•íded
(
dm_èrgë
 *
ti
)

2992  
	`dm_su•íded_md
(
	`dm_èbÀ_gë_md
(
ti
->
èbÀ
));

2993 
	}
}

2994 
EXPORT_SYMBOL_GPL
(
dm_su•íded
);

2996 
	$dm_noÊush_su•ídög
(
dm_èrgë
 *
ti
)

2998  
	`__noÊush_su•ídög
(
	`dm_èbÀ_gë_md
(
ti
->
èbÀ
));

2999 
	}
}

3000 
EXPORT_SYMBOL_GPL
(
dm_noÊush_su•ídög
);

3002 
dm_md_mempoﬁs
 *
	$dm_Æloc_md_mempoﬁs
(
ty≥
, 
öãgrôy
, 
≥r_bio_d©a_size
)

3004 
dm_md_mempoﬁs
 *
poﬁs
 = 
	`kzÆloc
((*poﬁs), 
GFP_KERNEL
);

3005 
kmem_ˇche
 *
ˇchï
;

3006 
poﬁ_size
;

3007 
‰⁄t_∑d
;

3009 i‡(!
poﬁs
)

3010  
NULL
;

3012 i‡(
ty≥
 =
DM_TYPE_BIO_BASED
) {

3013 
ˇchï
 = 
_io_ˇche
;

3014 
poﬁ_size
 = 
	`dm_gë_ª£rved_bio_ba£d_ios
();

3015 
‰⁄t_∑d
 = 
	`roundup
(
≥r_bio_d©a_size
, 
	`__Æignof__
(
dm_èrgë_io
)Ë+ 
	`off£tof
(dm_èrgë_io, 
˛⁄e
);

3016 } i‡(
ty≥
 =
DM_TYPE_REQUEST_BASED
) {

3017 
ˇchï
 = 
_rq_tio_ˇche
;

3018 
poﬁ_size
 = 
	`dm_gë_ª£rved_rq_ba£d_ios
();

3019 
‰⁄t_∑d
 = 
	`off£tof
(
dm_rq_˛⁄e_bio_öfo
, 
˛⁄e
);

3021 
	`WARN_ON
(
≥r_bio_d©a_size
 != 0);

3023 
out
;

3025 
poﬁs
->
io_poﬁ
 = 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
poﬁ_size
, 
ˇchï
);

3026 i‡(!
poﬁs
->
io_poﬁ
)

3027 
out
;

3029 
poﬁs
->
bs
 = 
	`bio£t_¸óã
(
poﬁ_size
, 
‰⁄t_∑d
);

3030 i‡(!
poﬁs
->
bs
)

3031 
out
;

3033 i‡(
öãgrôy
 && 
	`bio£t_öãgrôy_¸óã
(
poﬁs
->
bs
, 
poﬁ_size
))

3034 
out
;

3036  
poﬁs
;

3038 
out
:

3039 
	`dm_‰ì_md_mempoﬁs
(
poﬁs
);

3041  
NULL
;

3042 
	}
}

3044 
	$dm_‰ì_md_mempoﬁs
(
dm_md_mempoﬁs
 *
poﬁs
)

3046 i‡(!
poﬁs
)

3049 i‡(
poﬁs
->
io_poﬁ
)

3050 
	`mempoﬁ_de°roy
(
poﬁs
->
io_poﬁ
);

3052 i‡(
poﬁs
->
bs
)

3053 
	`bio£t_‰ì
(
poﬁs
->
bs
);

3055 
	`k‰ì
(
poﬁs
);

3056 
	}
}

3058 c⁄° 
block_devi˚_›î©i⁄s
 
	gdm_blk_d›s
 = {

3059 .
›í
 = 
dm_blk_›í
,

3060 .
	gªÀa£
 = 
dm_blk_˛o£
,

3061 .
	gio˘l
 = 
dm_blk_io˘l
,

3062 .
	ggëgeo
 = 
dm_blk_gëgeo
,

3063 .
	gow√r
 = 
THIS_MODULE


3069 
moduÀ_öô
(
dm_öô
);

3070 
moduÀ_exô
(
dm_exô
);

3072 
moduÀ_∑øm
(
maj‹
, 
uöt
, 0);

3073 
MODULE_PARM_DESC
(
maj‹
, "The majorÇumber ofÅhe device mapper");

3075 
moduÀ_∑øm
(
ª£rved_bio_ba£d_ios
, 
uöt
, 
S_IRUGO
 | 
S_IWUSR
);

3076 
MODULE_PARM_DESC
(
ª£rved_bio_ba£d_ios
, "Reserved IOs in bio-based mempools");

3078 
moduÀ_∑øm
(
ª£rved_rq_ba£d_ios
, 
uöt
, 
S_IRUGO
 | 
S_IWUSR
);

3079 
MODULE_PARM_DESC
(
ª£rved_rq_ba£d_ios
, "Reserved IOs inÑequest-based mempools");

3081 
MODULE_DESCRIPTION
(
DM_NAME
 " driver");

3082 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

3083 
MODULE_LICENSE
("GPL");

	@dm.h

10 #i‚de‡
DM_INTERNAL_H


11 
	#DM_INTERNAL_H


	)

13 
	~<löux/fs.h
>

14 
	~<löux/devi˚-m≠≥r.h
>

15 
	~<löux/li°.h
>

16 
	~<löux/blkdev.h
>

17 
	~<löux/hdªg.h
>

18 
	~<löux/com∂ëi⁄.h
>

19 
	~<löux/kobje˘.h
>

21 
	~"dm-°©s.h
"

26 
	#DM_SUSPEND_LOCKFS_FLAG
 (1 << 0)

	)

27 
	#DM_SUSPEND_NOFLUSH_FLAG
 (1 << 1)

	)

32 
	#DM_STATUS_NOFLUSH_FLAG
 (1 << 0)

	)

37 
	#DM_TYPE_NONE
 0

	)

38 
	#DM_TYPE_BIO_BASED
 1

	)

39 
	#DM_TYPE_REQUEST_BASED
 2

	)

44 
	sdm_dev_öã∫Æ
 {

45 
li°_hód
 
	mli°
;

46 
©omic_t
 
	mcou¡
;

47 
dm_dev
 *
	mdm_dev
;

50 
	gdm_èbÀ
;

51 
	gdm_md_mempoﬁs
;

56 
dm_èbÀ_de°roy
(
dm_èbÀ
 *
t
);

57 
dm_èbÀ_evít_ˇŒback
(
dm_èbÀ
 *
t
,

58 (*
‚
)(*), *
c⁄ãxt
);

59 
dm_èrgë
 *
	`dm_èbÀ_gë_èrgë
(
dm_èbÀ
 *
t
, 
ödex
);

60 
dm_èrgë
 *
	`dm_èbÀ_föd_èrgë
(
dm_èbÀ
 *
t
, 
£˘‹_t
 
£˘‹
);

61 
boﬁ
 
	`dm_èbÀ_has_no_d©a_devi˚s
(
dm_èbÀ
 *
èbÀ
);

62 
	`dm_ˇlcuœã_queue_limôs
(
dm_èbÀ
 *
èbÀ
,

63 
queue_limôs
 *
limôs
);

64 
	`dm_èbÀ_£t_ª°ri˘i⁄s
(
dm_èbÀ
 *
t
, 
ªque°_queue
 *
q
,

65 
queue_limôs
 *
limôs
);

66 
li°_hód
 *
	`dm_èbÀ_gë_devi˚s
(
dm_èbÀ
 *
t
);

67 
	`dm_èbÀ_¥esu•íd_èrgës
(
dm_èbÀ
 *
t
);

68 
	`dm_èbÀ_po°su•íd_èrgës
(
dm_èbÀ
 *
t
);

69 
	`dm_èbÀ_ªsume_èrgës
(
dm_èbÀ
 *
t
);

70 
	`dm_èbÀ_™y_c⁄ge°ed
(
dm_èbÀ
 *
t
, 
bdi_bôs
);

71 
	`dm_èbÀ_™y_busy_èrgë
(
dm_èbÀ
 *
t
);

72 
	`dm_èbÀ_gë_ty≥
(
dm_èbÀ
 *
t
);

73 
èrgë_ty≥
 *
	`dm_èbÀ_gë_immuèbÀ_èrgë_ty≥
(
dm_èbÀ
 *
t
);

74 
boﬁ
 
	`dm_èbÀ_ªque°_ba£d
(
dm_èbÀ
 *
t
);

75 
	`dm_èbÀ_‰ì_md_mempoﬁs
(
dm_èbÀ
 *
t
);

76 
dm_md_mempoﬁs
 *
	`dm_èbÀ_gë_md_mempoﬁs
(
dm_èbÀ
 *
t
);

78 
	`dm_queue_mîge_is_compuls‹y
(
ªque°_queue
 *
q
);

80 
	`dm_lock_md_ty≥
(
m≠≥d_devi˚
 *
md
);

81 
	`dm_u∆ock_md_ty≥
(
m≠≥d_devi˚
 *
md
);

82 
	`dm_£t_md_ty≥
(
m≠≥d_devi˚
 *
md
, 
ty≥
);

83 
	`dm_gë_md_ty≥
(
m≠≥d_devi˚
 *
md
);

84 
èrgë_ty≥
 *
	`dm_gë_immuèbÀ_èrgë_ty≥
(
m≠≥d_devi˚
 *
md
);

86 
	`dm_£tup_md_queue
(
m≠≥d_devi˚
 *
md
);

91 
	#dm_èrgë_is_vÆid
(
t
Ë(—)->
èbÀ
)

	)

96 
	#dm_èrgë_bio_ba£d
(
t
Ë(—)->
ty≥
->
m≠
 !
NULL
)

	)

101 
	#dm_èrgë_ªque°_ba£d
(
t
Ë(—)->
ty≥
->
m≠_rq
 !
NULL
)

	)

107 
	#dm_èrgë_hybrid
(
t
Ë(
	`dm_èrgë_bio_ba£d
—Ë&& 
	`dm_èrgë_ªque°_ba£d
—))

	)

112 
	`dm_èrgë_öô
();

113 
	`dm_èrgë_exô
();

114 
èrgë_ty≥
 *
	`dm_gë_èrgë_ty≥
(c⁄° *
«me
);

115 
	`dm_put_èrgë_ty≥
(
èrgë_ty≥
 *
â
);

116 
	`dm_èrgë_ôî©e
((*
ôî_func
)(
èrgë_ty≥
 *
â
,

117 *
∑øm
), *param);

119 
	`dm_•lô_¨gs
(*
¨gc
, ***
¨gvp
, *
öput
);

124 
	`dm_dñëög_md
(
m≠≥d_devi˚
 *
md
);

129 
	`dm_su•íded_md
(
m≠≥d_devi˚
 *
md
);

134 
	`dm_ã°_de„ºed_ªmove_Êag
(
m≠≥d_devi˚
 *
md
);

139 
	`dm_de„ºed_ªmove
();

145 
	`dm_öãrÁ˚_öô
();

146 
	`dm_öãrÁ˚_exô
();

151 
	sdm_kobje˘_hﬁdî
 {

152 
kobje˘
 
kobj
;

153 
com∂ëi⁄
 completion;

156 
ölöe
 
com∂ëi⁄
 *
	$dm_gë_com∂ëi⁄_‰om_kobje˘
(
kobje˘
 *
kobj
)

158  &
	`c⁄èöî_of
(
kobj
, 
dm_kobje˘_hﬁdî
, kobj)->
com∂ëi⁄
;

159 
	}
}

161 
dm_sysfs_öô
(
m≠≥d_devi˚
 *
md
);

162 
dm_sysfs_exô
(
m≠≥d_devi˚
 *
md
);

163 
kobje˘
 *
dm_kobje˘
(
m≠≥d_devi˚
 *
md
);

164 
m≠≥d_devi˚
 *
dm_gë_‰om_kobje˘
(
kobje˘
 *
kobj
);

169 
dm_kobje˘_ªÀa£
(
kobje˘
 *
kobj
);

174 
dm_löór_öô
();

175 
dm_löór_exô
();

177 
dm_°rùe_öô
();

178 
dm_°rùe_exô
();

183 
dm_de°roy
(
m≠≥d_devi˚
 *
md
);

184 
dm_de°roy_immedüã
(
m≠≥d_devi˚
 *
md
);

185 
dm_›í_cou¡
(
m≠≥d_devi˚
 *
md
);

186 
dm_lock_f‹_dñëi⁄
(
m≠≥d_devi˚
 *
md
, 
boﬁ
 
m¨k_de„ºed
, boﬁ 
⁄ly_de„ºed
);

187 
dm_ˇn˚l_de„ºed_ªmove
(
m≠≥d_devi˚
 *
md
);

188 
dm_ªque°_ba£d
(
m≠≥d_devi˚
 *
md
);

189 
£˘‹_t
 
dm_gë_size
(
m≠≥d_devi˚
 *
md
);

190 
ªque°_queue
 *
dm_gë_md_queue
(
m≠≥d_devi˚
 *
md
);

191 
dm_gë_èbÀ_devi˚
(
m≠≥d_devi˚
 *
md
, 
dev_t
 
dev
, 
fmode_t
 
mode
,

192 
dm_dev
 **
ªsu…
);

193 
dm_put_èbÀ_devi˚
(
m≠≥d_devi˚
 *
md
, 
dm_dev
 *
d
);

194 
dm_°©s
 *
dm_gë_°©s
(
m≠≥d_devi˚
 *
md
);

196 
dm_kobje˘_uevít
(
m≠≥d_devi˚
 *
md
, 
kobje˘_a˘i⁄
 
a˘i⁄
,

197 
cookõ
);

199 
dm_öã∫Æ_su•íd
(
m≠≥d_devi˚
 *
md
);

200 
dm_öã∫Æ_ªsume
(
m≠≥d_devi˚
 *
md
);

202 
dm_io_öô
();

203 
dm_io_exô
();

205 
dm_kc›yd_öô
();

206 
dm_kc›yd_exô
();

211 
dm_md_mempoﬁs
 *
dm_Æloc_md_mempoﬁs
(
ty≥
, 
öãgrôy
, 
≥r_bio_d©a_size
);

212 
dm_‰ì_md_mempoﬁs
(
dm_md_mempoﬁs
 *
poﬁs
);

217 
dm_gë_ª£rved_bio_ba£d_ios
();

218 
dm_gë_ª£rved_rq_ba£d_ios
();

220 
ölöe
 
boﬁ
 
	$dm_mesßge_ã°_buf„r_ovîÊow
(*
ªsu…
, 
maxÀn
)

222  !
maxÀn
 || 
	`°æí
(
ªsu…
) + 1 >= maxlen;

223 
	}
}

	@faulty.c

47 
	#WrôeTønsõ¡
 0

	)

48 
	#RódTønsõ¡
 1

	)

49 
	#WrôePîsi°ít
 2

	)

50 
	#RódPîsi°ít
 3

	)

51 
	#WrôeAŒ
 4

	)

52 
	#RódFixabÀ
 5

	)

53 
	#Modes
 6

	)

55 
	#CÀ¨Eº‹s
 31

	)

56 
	#CÀ¨Fau…s
 30

	)

58 
	#AŒPîsi°
 100

	)

59 
	#NoPîsi°
 101

	)

61 
	#ModeMask
 0x1f

	)

62 
	#ModeShi·
 5

	)

64 
	#MaxFau…
 50

	)

65 
	~<löux/blkdev.h
>

66 
	~<löux/moduÀ.h
>

67 
	~<löux/øid/md_u.h
>

68 
	~<löux/¶ab.h
>

69 
	~"md.h
"

70 
	~<löux/£q_fûe.h
>

73 
	$Áu…y_Áû
(
bio
 *bio, 
îr‹
)

75 
bio
 *
b
 = bio->
bi_¥iv©e
;

77 
b
->
bi_ôî
.
bi_size
 = 
bio
->bi_iter.bi_size;

78 
b
->
bi_ôî
.
bi_£˘‹
 = 
bio
->bi_iter.bi_sector;

80 
	`bio_put
(
bio
);

82 
	`bio_io_îr‹
(
b
);

83 
	}
}

85 
	sÁu…y_c⁄f
 {

86 
	m≥riod
[
Modes
];

87 
©omic_t
 
	mcou¡îs
[
Modes
];

88 
£˘‹_t
 
	mÁu…s
[
MaxFau…
];

89 
	mmodes
[
MaxFau…
];

90 
	mnÁu…s
;

91 
md_rdev
 *
	mrdev
;

94 
	$check_mode
(
Áu…y_c⁄f
 *
c⁄f
, 
mode
)

96 i‡(
c⁄f
->
≥riod
[
mode
] == 0 &&

97 
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
mode
]) <= 0)

101 i‡(
	`©omic_dec_™d_ã°
(&
c⁄f
->
cou¡îs
[
mode
])) {

102 i‡(
c⁄f
->
≥riod
[
mode
])

103 
	`©omic_£t
(&
c⁄f
->
cou¡îs
[
mode
], c⁄f->
≥riod
[mode]);

107 
	}
}

109 
	$check_£˘‹
(
Áu…y_c⁄f
 *
c⁄f
, 
£˘‹_t
 
°¨t
, se˘‹_à
íd
, 
dú
)

112 
i
;

113 
i
=0; i<
c⁄f
->
nÁu…s
; i++)

114 i‡(
c⁄f
->
Áu…s
[
i
] >
°¨t
 &&

115 
c⁄f
->
Áu…s
[
i
] < 
íd
) {

117 
c⁄f
->
modes
[
i
] * 2 + 
dú
) {

118 
WrôePîsi°ít
*2+
WRITE
:  1;

119 
RódPîsi°ít
*2+
READ
:  1;

120 
RódFixabÀ
*2+
READ
:  1;

121 
RódFixabÀ
*2+
WRITE
:

122 
c⁄f
->
modes
[
i
] = 
NoPîsi°
;

124 
AŒPîsi°
*2+
READ
:

125 
AŒPîsi°
*2+
WRITE
:  1;

131 
	}
}

133 
	$add_£˘‹
(
Áu…y_c⁄f
 *
c⁄f
, 
£˘‹_t
 
°¨t
, 
mode
)

135 
i
;

136 
n
 = 
c⁄f
->
nÁu…s
;

137 
i
=0; i<
c⁄f
->
nÁu…s
; i++)

138 i‡(
c⁄f
->
Áu…s
[
i
] =
°¨t
) {

139 
mode
) {

140 
NoPîsi°
: 
c⁄f
->
modes
[
i
] = 
mode
; ;

141 
WrôePîsi°ít
:

142 i‡(
c⁄f
->
modes
[
i
] =
RódPîsi°ít
 ||

143 
c⁄f
->
modes
[
i
] =
RódFixabÀ
)

144 
c⁄f
->
modes
[
i
] = 
AŒPîsi°
;

146 
c⁄f
->
modes
[
i
] = 
WrôePîsi°ít
;

148 
RódPîsi°ít
:

149 i‡(
c⁄f
->
modes
[
i
] =
WrôePîsi°ít
)

150 
c⁄f
->
modes
[
i
] = 
AŒPîsi°
;

152 
c⁄f
->
modes
[
i
] = 
RódPîsi°ít
;

154 
RódFixabÀ
:

155 i‡(
c⁄f
->
modes
[
i
] =
WrôePîsi°ít
 ||

156 
c⁄f
->
modes
[
i
] =
RódPîsi°ít
)

157 
c⁄f
->
modes
[
i
] = 
AŒPîsi°
;

159 
c⁄f
->
modes
[
i
] = 
RódFixabÀ
;

162 } i‡(
c⁄f
->
modes
[
i
] =
NoPîsi°
)

163 
n
 = 
i
;

165 i‡(
n
 >
MaxFau…
)

167 
c⁄f
->
Áu…s
[
n
] = 
°¨t
;

168 
c⁄f
->
modes
[
n
] = 
mode
;

169 i‡(
c⁄f
->
nÁu…s
 =
n
)

170 
c⁄f
->
nÁu…s
 = 
n
+1;

171 
	}
}

173 
	$make_ªque°
(
mddev
 *mddev, 
bio
 *bio)

175 
Áu…y_c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

176 
Áûô
 = 0;

178 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

180 i‡(
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
WrôeAŒ
])) {

184 
	`bio_ídio
(
bio
, -
EIO
);

188 i‡(
	`check_£˘‹
(
c⁄f
, 
bio
->
bi_ôî
.
bi_£˘‹
,

189 
	`bio_íd_£˘‹
(
bio
), 
WRITE
))

190 
Áûô
 = 1;

191 i‡(
	`check_mode
(
c⁄f
, 
WrôePîsi°ít
)) {

192 
	`add_£˘‹
(
c⁄f
, 
bio
->
bi_ôî
.
bi_£˘‹
,

193 
WrôePîsi°ít
);

194 
Áûô
 = 1;

196 i‡(
	`check_mode
(
c⁄f
, 
WrôeTønsõ¡
))

197 
Áûô
 = 1;

200 i‡(
	`check_£˘‹
(
c⁄f
, 
bio
->
bi_ôî
.
bi_£˘‹
,

201 
	`bio_íd_£˘‹
(
bio
), 
READ
))

202 
Áûô
 = 1;

203 i‡(
	`check_mode
(
c⁄f
, 
RódTønsõ¡
))

204 
Áûô
 = 1;

205 i‡(
	`check_mode
(
c⁄f
, 
RódPîsi°ít
)) {

206 
	`add_£˘‹
(
c⁄f
, 
bio
->
bi_ôî
.
bi_£˘‹
,

207 
RódPîsi°ít
);

208 
Áûô
 = 1;

210 i‡(
	`check_mode
(
c⁄f
, 
RódFixabÀ
)) {

211 
	`add_£˘‹
(
c⁄f
, 
bio
->
bi_ôî
.
bi_£˘‹
,

212 
RódFixabÀ
);

213 
Áûô
 = 1;

216 i‡(
Áûô
) {

217 
bio
 *
b
 = 
	`bio_˛⁄e_mddev
(bio, 
GFP_NOIO
, 
mddev
);

219 
b
->
bi_bdev
 = 
c⁄f
->
rdev
->
bdev
;

220 
b
->
bi_¥iv©e
 = 
bio
;

221 
b
->
bi_íd_io
 = 
Áu…y_Áû
;

222 
bio
 = 
b
;

224 
bio
->
bi_bdev
 = 
c⁄f
->
rdev
->
bdev
;

226 
	`gíîic_make_ªque°
(
bio
);

227 
	}
}

229 
	$°©us
(
£q_fûe
 *
£q
, 
mddev
 *mddev)

231 
Áu…y_c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

232 
n
;

234 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
WrôeTønsõ¡
])) != 0)

235 
	`£q_¥ötf
(
£q
, " WriteTransient=%d(%d)",

236 
n
, 
c⁄f
->
≥riod
[
WrôeTønsõ¡
]);

238 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
RódTønsõ¡
])) != 0)

239 
	`£q_¥ötf
(
£q
, " ReadTransient=%d(%d)",

240 
n
, 
c⁄f
->
≥riod
[
RódTønsõ¡
]);

242 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
WrôePîsi°ít
])) != 0)

243 
	`£q_¥ötf
(
£q
, " WritePersistent=%d(%d)",

244 
n
, 
c⁄f
->
≥riod
[
WrôePîsi°ít
]);

246 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
RódPîsi°ít
])) != 0)

247 
	`£q_¥ötf
(
£q
, " ReadPersistent=%d(%d)",

248 
n
, 
c⁄f
->
≥riod
[
RódPîsi°ít
]);

251 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
RódFixabÀ
])) != 0)

252 
	`£q_¥ötf
(
£q
, " ReadFixable=%d(%d)",

253 
n
, 
c⁄f
->
≥riod
[
RódFixabÀ
]);

255 i‡((
n
=
	`©omic_ªad
(&
c⁄f
->
cou¡îs
[
WrôeAŒ
])) != 0)

256 
	`£q_¥ötf
(
£q
, " WriteAll");

258 
	`£q_¥ötf
(
£q
, "ÇÁu…s=%d", 
c⁄f
->
nÁu…s
);

259 
	}
}

262 
	$ªsh≠e
(
mddev
 *mddev)

264 
mode
 = 
mddev
->
√w_œyout
 & 
ModeMask
;

265 
cou¡
 = 
mddev
->
√w_œyout
 >> 
ModeShi·
;

266 
Áu…y_c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

268 i‡(
mddev
->
√w_œyout
 < 0)

272 i‡(
mode
 =
CÀ¨Fau…s
)

273 
c⁄f
->
nÁu…s
 = 0;

274 i‡(
mode
 =
CÀ¨Eº‹s
) {

275 
i
;

276 
i
=0 ; i < 
Modes
 ; i++) {

277 
c⁄f
->
≥riod
[
i
] = 0;

278 
	`©omic_£t
(&
c⁄f
->
cou¡îs
[
i
], 0);

280 } i‡(
mode
 < 
Modes
) {

281 
c⁄f
->
≥riod
[
mode
] = 
cou¡
;

282 i‡(!
cou¡
) count++;

283 
	`©omic_£t
(&
c⁄f
->
cou¡îs
[
mode
], 
cou¡
);

285  -
EINVAL
;

286 
mddev
->
√w_œyout
 = -1;

287 
mddev
->
œyout
 = -1;

289 
	}
}

291 
£˘‹_t
 
	$Áu…y_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

293 
	`WARN_ONCE
(
øid_disks
,

294 "%†d€†nŸ suµ‹àgíîi¯ªsh≠e\n", 
__func__
);

296 i‡(
£˘‹s
 == 0)

297  
mddev
->
dev_£˘‹s
;

299  
£˘‹s
;

300 
	}
}

302 
	$run
(
mddev
 *mddev)

304 
md_rdev
 *
rdev
;

305 
i
;

306 
Áu…y_c⁄f
 *
c⁄f
;

308 i‡(
	`md_check_no_bôm≠
(
mddev
))

309  -
EINVAL
;

311 
c⁄f
 = 
	`kmÆloc
((*c⁄f), 
GFP_KERNEL
);

312 i‡(!
c⁄f
)

313  -
ENOMEM
;

315 
i
=0; i<
Modes
; i++) {

316 
	`©omic_£t
(&
c⁄f
->
cou¡îs
[
i
], 0);

317 
c⁄f
->
≥riod
[
i
] = 0;

319 
c⁄f
->
nÁu…s
 = 0;

321 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

322 
c⁄f
->
rdev
 =Ñdev;

323 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

324 
rdev
->
d©a_off£t
 << 9);

327 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`Áu…y_size
(mddev, 0, 0));

328 
mddev
->
¥iv©e
 = 
c⁄f
;

330 
	`ªsh≠e
(
mddev
);

333 
	}
}

335 
	$°›
(
mddev
 *mddev)

337 
Áu…y_c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

339 
	`k‰ì
(
c⁄f
);

340 
mddev
->
¥iv©e
 = 
NULL
;

342 
	}
}

344 
md_≥rs⁄Æôy
 
	gÁu…y_≥rs⁄Æôy
 =

346 .
«me
 = "faulty",

347 .
	gÀvñ
 = 
LEVEL_FAULTY
,

348 .
	gow√r
 = 
THIS_MODULE
,

349 .
	gmake_ªque°
 = 
make_ªque°
,

350 .
	grun
 = 
run
,

351 .
	g°›
 = 
°›
,

352 .
	g°©us
 = 
°©us
,

353 .
	gcheck_ªsh≠e
 = 
ªsh≠e
,

354 .
	gsize
 = 
Áu…y_size
,

357 
__öô
 
	$øid_öô
()

359  
	`ªgi°î_md_≥rs⁄Æôy
(&
Áu…y_≥rs⁄Æôy
);

360 
	}
}

362 
	$øid_exô
()

364 
	`uƒegi°î_md_≥rs⁄Æôy
(&
Áu…y_≥rs⁄Æôy
);

365 
	}
}

367 
moduÀ_öô
(
øid_öô
);

368 
moduÀ_exô
(
øid_exô
);

369 
MODULE_LICENSE
("GPL");

370 
MODULE_DESCRIPTION
("Fault injectionÖersonality for MD");

371 
MODULE_ALIAS
("md-personality-10");

372 
MODULE_ALIAS
("md-faulty");

373 
MODULE_ALIAS
("md-level--5");

	@faulty.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

24 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

25 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

26 { 0xb78f29de, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_mddev
) },

27 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

28 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

29 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

30 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

31 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

32 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

33 { 0x35d3fbad, 
__VMLINUX_SYMBOL_STR
(
md_check_no_bôm≠
) },

34 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

35 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

36 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

37 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

40 c⁄° 
	g__moduÀ_dïíds
[]

41 
__u£d


42 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

46 
MODULE_INFO
(
§cvîsi⁄
, "034EAAA9A7D3678EDA8DBD2");

	@linear.c

19 
	~<löux/blkdev.h
>

20 
	~<löux/øid/md_u.h
>

21 
	~<löux/£q_fûe.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/¶ab.h
>

24 
	~"md.h
"

25 
	~"löór.h
"

30 
ölöe
 
dev_öfo
 *
	$which_dev
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹
)

32 
lo
, 
mid
, 
hi
;

33 
löór_c⁄f
 *
c⁄f
;

35 
lo
 = 0;

36 
hi
 = 
mddev
->
øid_disks
 - 1;

37 
c⁄f
 = 
	`rcu_dîe„ªn˚
(
mddev
->
¥iv©e
);

43 
hi
 > 
lo
) {

45 
mid
 = (
hi
 + 
lo
) / 2;

46 i‡(
£˘‹
 < 
c⁄f
->
disks
[
mid
].
íd_£˘‹
)

47 
hi
 = 
mid
;

49 
lo
 = 
mid
 + 1;

52  
c⁄f
->
disks
 + 
lo
;

53 
	}
}

63 
	$löór_mîgóbÀ_bvec
(
ªque°_queue
 *
q
,

64 
bvec_mîge_d©a
 *
bvm
,

65 
bio_vec
 *
biovec
)

67 
mddev
 *mddev = 
q
->
queued©a
;

68 
dev_öfo
 *
dev0
;

69 
max£˘‹s
, 
bio_£˘‹s
 = 
bvm
->
bi_size
 >> 9;

70 
£˘‹_t
 
£˘‹
 = 
bvm
->
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bvm->
bi_bdev
);

71 
maxbyãs
 = 
biovec
->
bv_Àn
;

72 
ªque°_queue
 *
subq
;

74 
	`rcu_ªad_lock
();

75 
dev0
 = 
	`which_dev
(
mddev
, 
£˘‹
);

76 
max£˘‹s
 = 
dev0
->
íd_£˘‹
 - 
£˘‹
;

77 
subq
 = 
	`bdev_gë_queue
(
dev0
->
rdev
->
bdev
);

78 i‡(
subq
->
mîge_bvec_‚
) {

79 
bvm
->
bi_bdev
 = 
dev0
->
rdev
->
bdev
;

80 
bvm
->
bi_£˘‹
 -
dev0
->
íd_£˘‹
 - dev0->
rdev
->
£˘‹s
;

81 
maxbyãs
 = 
	`mö
(maxbyãs, 
subq
->
	`mîge_bvec_‚
(subq, 
bvm
,

82 
biovec
));

84 
	`rcu_ªad_u∆ock
();

86 i‡(
max£˘‹s
 < 
bio_£˘‹s
)

87 
max£˘‹s
 = 0;

89 
max£˘‹s
 -
bio_£˘‹s
;

91 i‡(
max£˘‹s
 <(
PAGE_SIZE
 >> 9 ) && 
bio_£˘‹s
 == 0)

92  
maxbyãs
;

94 i‡(
max£˘‹s
 > (
maxbyãs
 >> 9))

95  
maxbyãs
;

97  
max£˘‹s
 << 9;

98 
	}
}

100 
	$löór_c⁄ge°ed
(*
d©a
, 
bôs
)

102 
mddev
 *mddev = 
d©a
;

103 
löór_c⁄f
 *
c⁄f
;

104 
i
, 
ªt
 = 0;

106 i‡(
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
))

109 
	`rcu_ªad_lock
();

110 
c⁄f
 = 
	`rcu_dîe„ªn˚
(
mddev
->
¥iv©e
);

112 
i
 = 0; i < 
mddev
->
øid_disks
 && !
ªt
 ; i++) {

113 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
c⁄f
->
disks
[
i
].
rdev
->
bdev
);

114 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

117 
	`rcu_ªad_u∆ock
();

118  
ªt
;

119 
	}
}

121 
£˘‹_t
 
	$löór_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

123 
löór_c⁄f
 *
c⁄f
;

124 
£˘‹_t
 
¨øy_£˘‹s
;

126 
	`rcu_ªad_lock
();

127 
c⁄f
 = 
	`rcu_dîe„ªn˚
(
mddev
->
¥iv©e
);

128 
	`WARN_ONCE
(
£˘‹s
 || 
øid_disks
,

129 "%†d€†nŸ suµ‹àgíîi¯ªsh≠e\n", 
__func__
);

130 
¨øy_£˘‹s
 = 
c⁄f
->array_sectors;

131 
	`rcu_ªad_u∆ock
();

133  
¨øy_£˘‹s
;

134 
	}
}

136 
löór_c⁄f
 *
	$löór_c⁄f
(
mddev
 *mddev, 
øid_disks
)

138 
löór_c⁄f
 *
c⁄f
;

139 
md_rdev
 *
rdev
;

140 
i
, 
˙t
;

141 
boﬁ
 
disˇrd_suµ‹ãd
 = 
Ál£
;

143 
c⁄f
 = 
	`kzÆloc
 ( (*c⁄fË+ 
øid_disks
*(
dev_öfo
),

144 
GFP_KERNEL
);

145 i‡(!
c⁄f
)

146  
NULL
;

148 
˙t
 = 0;

149 
c⁄f
->
¨øy_£˘‹s
 = 0;

151 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

152 
j
 = 
rdev
->
øid_disk
;

153 
dev_öfo
 *
disk
 = 
c⁄f
->
disks
 + 
j
;

154 
£˘‹_t
 
£˘‹s
;

156 i‡(
j
 < 0 || j >
øid_disks
 || 
disk
->
rdev
) {

157 
	`¥ötk
(
KERN_ERR
 "md/linear:%s: diskÇumberingÖroblem. Aborting!\n",

158 
	`md«me
(
mddev
));

159 
out
;

162 
disk
->
rdev
 =Ñdev;

163 i‡(
mddev
->
chunk_£˘‹s
) {

164 
£˘‹s
 = 
rdev
->sectors;

165 
	`£˘‹_div
(
£˘‹s
, 
mddev
->
chunk_£˘‹s
);

166 
rdev
->
£˘‹s
 = se˘‹†* 
mddev
->
chunk_£˘‹s
;

169 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

170 
rdev
->
d©a_off£t
 << 9);

172 
c⁄f
->
¨øy_£˘‹s
 +
rdev
->
£˘‹s
;

173 
˙t
++;

175 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)))

176 
disˇrd_suµ‹ãd
 = 
åue
;

178 i‡(
˙t
 !
øid_disks
) {

179 
	`¥ötk
(
KERN_ERR
 "md/linear:%s:ÇotÉnough drivesÖresent. Aborting!\n",

180 
	`md«me
(
mddev
));

181 
out
;

184 i‡(!
disˇrd_suµ‹ãd
)

185 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

187 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

192 
c⁄f
->
disks
[0].
íd_£˘‹
 = c⁄f->disks[0].
rdev
->
£˘‹s
;

194 
i
 = 1; i < 
øid_disks
; i++)

195 
c⁄f
->
disks
[
i
].
íd_£˘‹
 =

196 
c⁄f
->
disks
[
i
-1].
íd_£˘‹
 +

197 
c⁄f
->
disks
[
i
].
rdev
->
£˘‹s
;

199  
c⁄f
;

201 
out
:

202 
	`k‰ì
(
c⁄f
);

203  
NULL
;

204 
	}
}

206 
	$löór_run
 (
mddev
 *mddev)

208 
löór_c⁄f
 *
c⁄f
;

209 
ªt
;

211 i‡(
	`md_check_no_bôm≠
(
mddev
))

212  -
EINVAL
;

213 
c⁄f
 = 
	`löór_c⁄f
(
mddev
, mddev->
øid_disks
);

215 i‡(!
c⁄f
)

217 
mddev
->
¥iv©e
 = 
c⁄f
;

218 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`löór_size
(mddev, 0, 0));

220 
	`blk_queue_mîge_bvec
(
mddev
->
queue
, 
löór_mîgóbÀ_bvec
);

221 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
löór_c⁄ge°ed
;

222 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

224 
ªt
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

225 i‡(
ªt
) {

226 
	`k‰ì
(
c⁄f
);

227 
mddev
->
¥iv©e
 = 
NULL
;

229  
ªt
;

230 
	}
}

232 
	$löór_add
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

242 
löór_c⁄f
 *
√wc⁄f
, *
ﬁdc⁄f
;

244 i‡(
rdev
->
ßved_øid_disk
 !
mddev
->
øid_disks
)

245  -
EINVAL
;

247 
rdev
->
øid_disk
 =Ñdev->
ßved_øid_disk
;

248 
rdev
->
ßved_øid_disk
 = -1;

250 
√wc⁄f
 = 
	`löór_c⁄f
(
mddev
,mddev->
øid_disks
+1);

252 i‡(!
√wc⁄f
)

253  -
ENOMEM
;

255 
ﬁdc⁄f
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mddev
->
¥iv©e
,

256 
	`lockdï_is_hñd
(

257 &
mddev
->
ªc⁄fig_muãx
));

258 
mddev
->
øid_disks
++;

259 
	`rcu_assign_poöãr
(
mddev
->
¥iv©e
, 
√wc⁄f
);

260 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`löór_size
(mddev, 0, 0));

261 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

262 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

263 
	`k‰ì_rcu
(
ﬁdc⁄f
, 
rcu
);

265 
	}
}

267 
	$löór_°›
 (
mddev
 *mddev)

269 
löór_c⁄f
 *
c⁄f
 =

270 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mddev
->
¥iv©e
,

271 
	`lockdï_is_hñd
(

272 &
mddev
->
ªc⁄fig_muãx
));

281 
	`rcu_b¨rõr
();

282 
	`blk_sync_queue
(
mddev
->
queue
);

283 
	`k‰ì
(
c⁄f
);

284 
mddev
->
¥iv©e
 = 
NULL
;

287 
	}
}

289 
	$löór_make_ªque°
(
mddev
 *mddev, 
bio
 *bio)

291 
b
[
BDEVNAME_SIZE
];

292 
dev_öfo
 *
tmp_dev
;

293 
bio
 *
•lô
;

294 
£˘‹_t
 
°¨t_£˘‹
, 
íd_£˘‹
, 
d©a_off£t
;

296 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_FLUSH
)) {

297 
	`md_Êush_ªque°
(
mddev
, 
bio
);

302 
	`rcu_ªad_lock
();

304 
tmp_dev
 = 
	`which_dev
(
mddev
, 
bio
->
bi_ôî
.
bi_£˘‹
);

305 
°¨t_£˘‹
 = 
tmp_dev
->
íd_£˘‹
 -Åmp_dev->
rdev
->
£˘‹s
;

306 
íd_£˘‹
 = 
tmp_dev
->end_sector;

307 
d©a_off£t
 = 
tmp_dev
->
rdev
->data_offset;

308 
bio
->
bi_bdev
 = 
tmp_dev
->
rdev
->
bdev
;

310 
	`rcu_ªad_u∆ock
();

312 i‡(
	`u∆ikñy
(
bio
->
bi_ôî
.
bi_£˘‹
 >
íd_£˘‹
 ||

313 
bio
->
bi_ôî
.
bi_£˘‹
 < 
°¨t_£˘‹
))

314 
out_of_bounds
;

316 i‡(
	`u∆ikñy
(
	`bio_íd_£˘‹
(
bio
Ë> 
íd_£˘‹
)) {

320 
•lô
 = 
	`bio_•lô
(
bio
, 
íd_£˘‹
 -

321 
bio
->
bi_ôî
.
bi_£˘‹
,

322 
GFP_NOIO
, 
fs_bio_£t
);

323 
	`bio_chaö
(
•lô
, 
bio
);

325 
•lô
 = 
bio
;

328 
•lô
->
bi_ôî
.
bi_£˘‹
 = split->bi_iter.bi_sector -

329 
°¨t_£˘‹
 + 
d©a_off£t
;

331 i‡(
	`u∆ikñy
((
•lô
->
bi_rw
 & 
REQ_DISCARD
) &&

332 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
•lô
->
bi_bdev
)))) {

334 
	`bio_ídio
(
•lô
, 0);

336 
	`gíîic_make_ªque°
(
•lô
);

337 } 
•lô
 !
bio
);

340 
out_of_bounds
:

341 
	`¥ötk
(
KERN_ERR


344 
	`md«me
(
mddev
),

345 ()
bio
->
bi_ôî
.
bi_£˘‹
,

346 
	`bdev«me
(
tmp_dev
->
rdev
->
bdev
, 
b
),

347 ()
tmp_dev
->
rdev
->
£˘‹s
,

348 ()
°¨t_£˘‹
);

349 
	`bio_io_îr‹
(
bio
);

350 
	}
}

352 
	$löór_°©us
 (
£q_fûe
 *
£q
, 
mddev
 *mddev)

355 
	`£q_¥ötf
(
£q
, " %dkÑoundög", 
mddev
->
chunk_£˘‹s
 / 2);

356 
	}
}

359 
md_≥rs⁄Æôy
 
	glöór_≥rs⁄Æôy
 =

361 .
«me
 = "linear",

362 .
	gÀvñ
 = 
LEVEL_LINEAR
,

363 .
	gow√r
 = 
THIS_MODULE
,

364 .
	gmake_ªque°
 = 
löór_make_ªque°
,

365 .
	grun
 = 
löór_run
,

366 .
	g°›
 = 
löór_°›
,

367 .
	g°©us
 = 
löór_°©us
,

368 .
	ghŸ_add_disk
 = 
löór_add
,

369 .
	gsize
 = 
löór_size
,

372 
__öô
 
	$löór_öô
 ()

374  
	`ªgi°î_md_≥rs⁄Æôy
 (&
löór_≥rs⁄Æôy
);

375 
	}
}

377 
	$löór_exô
 ()

379 
	`uƒegi°î_md_≥rs⁄Æôy
 (&
löór_≥rs⁄Æôy
);

380 
	}
}

383 
moduÀ_öô
(
löór_öô
);

384 
moduÀ_exô
(
löór_exô
);

385 
MODULE_LICENSE
("GPL");

386 
MODULE_DESCRIPTION
("Linear device concatenationÖersonality for MD");

387 
MODULE_ALIAS
("md-personality-1");

388 
MODULE_ALIAS
("md-linear");

389 
MODULE_ALIAS
("md-level--1");

	@linear.h

1 #i‚de‡
_LINEAR_H


2 
	#_LINEAR_H


	)

4 
	sdev_öfo
 {

5 
md_rdev
 *
	mrdev
;

6 
£˘‹_t
 
	míd_£˘‹
;

9 
	slöór_c⁄f


11 
rcu_hód
 
	mrcu
;

12 
£˘‹_t
 
	m¨øy_£˘‹s
;

13 
dev_öfo
 
	mdisks
[0];

	@linear.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

24 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

25 { 0x719b4945, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_ªgi°î
) },

26 { 0xc1eb978a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_mîge_bvec
) },

27 { 0x35d3fbad, 
__VMLINUX_SYMBOL_STR
(
md_check_no_bôm≠
) },

28 { 0x9469482, 
__VMLINUX_SYMBOL_STR
(
k‰ì_ˇŒ_rcu
) },

29 { 0x5c750c00, 
__VMLINUX_SYMBOL_STR
(
ªvÆid©e_disk
) },

30 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

31 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

32 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

33 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

34 { 0xfb254830, 
__VMLINUX_SYMBOL_STR
(
bio_chaö
) },

35 { 0xeb594c85, 
__VMLINUX_SYMBOL_STR
(
bio_•lô
) },

36 { 0x153e70d9, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

37 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

38 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

39 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

40 { 0x4101c3c9, 
__VMLINUX_SYMBOL_STR
(
md_Êush_ªque°
) },

41 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

42 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

43 { 0x8c0603d0, 
__VMLINUX_SYMBOL_STR
(
blk_sync_queue
) },

44 { 0x60a13e90, 
__VMLINUX_SYMBOL_STR
(
rcu_b¨rõr
) },

45 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

46 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

47 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

50 c⁄° 
	g__moduÀ_dïíds
[]

51 
__u£d


52 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

56 
MODULE_INFO
(
§cvîsi⁄
, "BAA54D90BBDCB7FFC433CC5");

	@md.c

35 
	~<löux/kthªad.h
>

36 
	~<löux/blkdev.h
>

37 
	~<löux/sys˘l.h
>

38 
	~<löux/£q_fûe.h
>

39 
	~<löux/fs.h
>

40 
	~<löux/pﬁl.h
>

41 
	~<löux/˘y≥.h
>

42 
	~<löux/°rög.h
>

43 
	~<löux/hdªg.h
>

44 
	~<löux/¥oc_fs.h
>

45 
	~<löux/øndom.h
>

46 
	~<löux/moduÀ.h
>

47 
	~<löux/ªboŸ.h
>

48 
	~<löux/fûe.h
>

49 
	~<löux/com∑t.h
>

50 
	~<löux/dñay.h
>

51 
	~<löux/øid/md_p.h
>

52 
	~<löux/øid/md_u.h
>

53 
	~<löux/¶ab.h
>

54 
	~"md.h
"

55 
	~"bôm≠.h
"

57 #i‚de‡
MODULE


58 
auto°¨t_¨øys
(
∑π
);

66 
LIST_HEAD
(
≥rs_li°
);

67 
DEFINE_SPINLOCK
(
≥rs_lock
);

69 
md_¥öt_devi˚s
();

71 
DECLARE_WAIT_QUEUE_HEAD
(
ªsync_waô
);

72 
w‹kqueue_°ru˘
 *
	gmd_wq
;

73 
w‹kqueue_°ru˘
 *
	gmd_misc_wq
;

75 
ªmove_™d_add_•¨es
(
mddev
 *mddev,

76 
md_rdev
 *
this
);

78 
	#MD_BUG
(
x
...Ë{ 
	`¥ötk
("md: bug i¿fûê%s,Üöê%d\n", 
__FILE__
, 
__LINE__
); 
	`md_¥öt_devi˚s
(); }

	)

85 
	#MD_DEFAULT_MAX_CORRECTED_READ_ERRORS
 20

	)

99 
	gsys˘l_•ìd_limô_mö
 = 1000;

100 
	gsys˘l_•ìd_limô_max
 = 200000;

101 
ölöe
 
	$•ìd_mö
(
mddev
 *mddev)

103  
mddev
->
sync_•ìd_mö
 ?

104 
mddev
->
sync_•ìd_mö
 : 
sys˘l_•ìd_limô_mö
;

105 
	}
}

107 
ölöe
 
	$•ìd_max
(
mddev
 *mddev)

109  
mddev
->
sync_•ìd_max
 ?

110 
mddev
->
sync_•ìd_max
 : 
sys˘l_•ìd_limô_max
;

111 
	}
}

113 
˘l_èbÀ_hódî
 *
	gøid_èbÀ_hódî
;

115 
˘l_èbÀ
 
	gøid_èbÀ
[] = {

117 .
¥o˙ame
 = "speed_limit_min",

118 .
	gd©a
 = &
sys˘l_•ìd_limô_mö
,

119 .
	gmaxÀn
 = (),

120 .
	gmode
 = 
S_IRUGO
|
S_IWUSR
,

121 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
,

124 .
	g¥o˙ame
 = "speed_limit_max",

125 .
	gd©a
 = &
sys˘l_•ìd_limô_max
,

126 .
	gmaxÀn
 = (),

127 .
	gmode
 = 
S_IRUGO
|
S_IWUSR
,

128 .
	g¥oc_h™dÀr
 = 
¥oc_doötvec
,

133 
˘l_èbÀ
 
	gøid_dú_èbÀ
[] = {

135 .
¥o˙ame
 = "raid",

136 .
	gmaxÀn
 = 0,

137 .
	gmode
 = 
S_IRUGO
|
S_IXUGO
,

138 .
	gchûd
 = 
øid_èbÀ
,

143 
˘l_èbÀ
 
	gøid_roŸ_èbÀ
[] = {

145 .
¥o˙ame
 = "dev",

146 .
	gmaxÀn
 = 0,

147 .
	gmode
 = 0555,

148 .
	gchûd
 = 
øid_dú_èbÀ
,

153 c⁄° 
block_devi˚_›î©i⁄s
 
	gmd_f›s
;

155 
	g°¨t_ªad⁄ly
;

161 
bio
 *
	$bio_Æloc_mddev
(
gÂ_t
 
gÂ_mask
, 
ƒ_iovecs
,

162 
mddev
 *mddev)

164 
bio
 *
b
;

166 i‡(!
mddev
 || !mddev->
bio_£t
)

167  
	`bio_Æloc
(
gÂ_mask
, 
ƒ_iovecs
);

169 
b
 = 
	`bio_Æloc_bio£t
(
gÂ_mask
, 
ƒ_iovecs
, 
mddev
->
bio_£t
);

170 i‡(!
b
)

171  
NULL
;

172  
b
;

173 
	}
}

174 
EXPORT_SYMBOL_GPL
(
bio_Æloc_mddev
);

176 
bio
 *
	$bio_˛⁄e_mddev
(
bio
 *bio, 
gÂ_t
 
gÂ_mask
,

177 
mddev
 *mddev)

179 i‡(!
mddev
 || !mddev->
bio_£t
)

180  
	`bio_˛⁄e
(
bio
, 
gÂ_mask
);

182  
	`bio_˛⁄e_bio£t
(
bio
, 
gÂ_mask
, 
mddev
->
bio_£t
);

183 
	}
}

184 
EXPORT_SYMBOL_GPL
(
bio_˛⁄e_mddev
);

196 
DECLARE_WAIT_QUEUE_HEAD
(
md_evít_waôîs
);

197 
©omic_t
 
	gmd_evít_cou¡
;

198 
	$md_√w_evít
(
mddev
 *mddev)

200 
	`©omic_öc
(&
md_evít_cou¡
);

201 
	`wake_up
(&
md_evít_waôîs
);

202 
	}
}

203 
EXPORT_SYMBOL_GPL
(
md_√w_evít
);

208 
	$md_√w_evít_ööå
(
mddev
 *mddev)

210 
	`©omic_öc
(&
md_evít_cou¡
);

211 
	`wake_up
(&
md_evít_waôîs
);

212 
	}
}

218 
LIST_HEAD
(
Æl_mddevs
);

219 
DEFINE_SPINLOCK
(
Æl_mddevs_lock
);

229 
	#f‹_óch_mddev
(
_mddev
,
_tmp
) \

231 ({ 
	`•ö_lock
(&
Æl_mddevs_lock
); \

232 
_tmp
 = 
Æl_mddevs
.
√xt
; \

233 
_mddev
 = 
NULL
;}); \

234 ({ i‡(
_tmp
 !&
Æl_mddevs
) \

235 
	`mddev_gë
(
	`li°_íåy
(
_tmp
, 
mddev
, 
Æl_mddevs
));\

236 
	`•ö_u∆ock
(&
Æl_mddevs_lock
); \

237 i‡(
_mddev
Ë
	`mddev_put
(_mddev); \

238 
_mddev
 = 
	`li°_íåy
(
_tmp
, 
mddev
, 
Æl_mddevs
); \

239 
_tmp
 !&
Æl_mddevs
;}); \

240 ({ 
	`•ö_lock
(&
Æl_mddevs_lock
); \

241 
_tmp
 = _tmp->
√xt
;}) \

242 )

	)

252 
	$md_make_ªque°
(
ªque°_queue
 *
q
, 
bio
 *bio)

254 c⁄° 
rw
 = 
	`bio_d©a_dú
(
bio
);

255 
mddev
 *mddev = 
q
->
queued©a
;

256 
˝u
;

257 
£˘‹s
;

259 i‡(
mddev
 =
NULL
 || mddev->
≥rs
 == NULL

260 || !
mddev
->
ªady
) {

261 
	`bio_io_îr‹
(
bio
);

264 i‡(
mddev
->
ro
 =1 && 
	`u∆ikñy
(
rw
 =
WRITE
)) {

265 
	`bio_ídio
(
bio
, 
	`bio_£˘‹s
(bioË=0 ? 0 : -
EROFS
);

268 
	`smp_rmb
();

269 
	`rcu_ªad_lock
();

270 i‡(
mddev
->
su•íded
) {

271 
	`DEFINE_WAIT
(
__waô
);

273 
	`¥ï¨e_to_waô
(&
mddev
->
sb_waô
, &
__waô
,

274 
TASK_UNINTERRUPTIBLE
);

275 i‡(!
mddev
->
su•íded
)

277 
	`rcu_ªad_u∆ock
();

278 
	`scheduÀ
();

279 
	`rcu_ªad_lock
();

281 
	`föish_waô
(&
mddev
->
sb_waô
, &
__waô
);

283 
	`©omic_öc
(&
mddev
->
a˘ive_io
);

284 
	`rcu_ªad_u∆ock
();

290 
£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

291 
mddev
->
≥rs
->
	`make_ªque°
(mddev, 
bio
);

293 
˝u
 = 
	`∑π_°©_lock
();

294 
	`∑π_°©_öc
(
˝u
, &
mddev
->
gídisk
->
∑π0
, 
ios
[
rw
]);

295 
	`∑π_°©_add
(
˝u
, &
mddev
->
gídisk
->
∑π0
, 
£˘‹s
[
rw
], sectors);

296 
	`∑π_°©_u∆ock
();

298 i‡(
	`©omic_dec_™d_ã°
(&
mddev
->
a˘ive_io
Ë&& mddev->
su•íded
)

299 
	`wake_up
(&
mddev
->
sb_waô
);

300 
	}
}

308 
	$mddev_su•íd
(
mddev
 *mddev)

310 
	`BUG_ON
(
mddev
->
su•íded
);

311 
mddev
->
su•íded
 = 1;

312 
	`synchr⁄ize_rcu
();

313 
	`waô_evít
(
mddev
->
sb_waô
, 
	`©omic_ªad
(&mddev->
a˘ive_io
) == 0);

314 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

316 
	`dñ_timî_sync
(&
mddev
->
ß„mode_timî
);

317 
	}
}

318 
EXPORT_SYMBOL_GPL
(
mddev_su•íd
);

320 
	$mddev_ªsume
(
mddev
 *mddev)

322 
mddev
->
su•íded
 = 0;

323 
	`wake_up
(&
mddev
->
sb_waô
);

324 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

326 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

327 
	`md_wakeup_thªad
(
mddev
->
thªad
);

328 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

329 
	}
}

330 
EXPORT_SYMBOL_GPL
(
mddev_ªsume
);

332 
	$mddev_c⁄ge°ed
(
mddev
 *mddev, 
bôs
)

334  
mddev
->
su•íded
;

335 
	}
}

336 
EXPORT_SYMBOL
(
mddev_c⁄ge°ed
);

342 
	$md_íd_Êush
(
bio
 *bio, 
îr
)

344 
md_rdev
 *
rdev
 = 
bio
->
bi_¥iv©e
;

345 
mddev
 *mddev = 
rdev
->mddev;

347 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

349 i‡(
	`©omic_dec_™d_ã°
(&
mddev
->
Êush_≥ndög
)) {

351 
	`queue_w‹k
(
md_wq
, &
mddev
->
Êush_w‹k
);

353 
	`bio_put
(
bio
);

354 
	}
}

356 
md_submô_Êush_d©a
(
w‹k_°ru˘
 *
ws
);

358 
	$submô_Êushes
(
w‹k_°ru˘
 *
ws
)

360 
mddev
 *mddev = 
	`c⁄èöî_of
(
ws
, mddev, 
Êush_w‹k
);

361 
md_rdev
 *
rdev
;

363 
	`INIT_WORK
(&
mddev
->
Êush_w‹k
, 
md_submô_Êush_d©a
);

364 
	`©omic_£t
(&
mddev
->
Êush_≥ndög
, 1);

365 
	`rcu_ªad_lock
();

366 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
)

367 i‡(
rdev
->
øid_disk
 >= 0 &&

368 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

373 
bio
 *
bi
;

374 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

375 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

376 
	`rcu_ªad_u∆ock
();

377 
bi
 = 
	`bio_Æloc_mddev
(
GFP_NOIO
, 0, 
mddev
);

378 
bi
->
bi_íd_io
 = 
md_íd_Êush
;

379 
bi
->
bi_¥iv©e
 = 
rdev
;

380 
bi
->
bi_bdev
 = 
rdev
->
bdev
;

381 
	`©omic_öc
(&
mddev
->
Êush_≥ndög
);

382 
	`submô_bio
(
WRITE_FLUSH
, 
bi
);

383 
	`rcu_ªad_lock
();

384 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

386 
	`rcu_ªad_u∆ock
();

387 i‡(
	`©omic_dec_™d_ã°
(&
mddev
->
Êush_≥ndög
))

388 
	`queue_w‹k
(
md_wq
, &
mddev
->
Êush_w‹k
);

389 
	}
}

391 
	$md_submô_Êush_d©a
(
w‹k_°ru˘
 *
ws
)

393 
mddev
 *mddev = 
	`c⁄èöî_of
(
ws
, mddev, 
Êush_w‹k
);

394 
bio
 *biÿ
mddev
->
Êush_bio
;

396 i‡(
bio
->
bi_ôî
.
bi_size
 == 0)

398 
	`bio_ídio
(
bio
, 0);

400 
bio
->
bi_rw
 &~
REQ_FLUSH
;

401 
mddev
->
≥rs
->
	`make_ªque°
(mddev, 
bio
);

404 
mddev
->
Êush_bio
 = 
NULL
;

405 
	`wake_up
(&
mddev
->
sb_waô
);

406 
	}
}

408 
	$md_Êush_ªque°
(
mddev
 *mddev, 
bio
 *bio)

410 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

411 
	`waô_evít_lock_úq
(
mddev
->
sb_waô
,

412 !
mddev
->
Êush_bio
,

413 
mddev
->
wrôe_lock
);

414 
mddev
->
Êush_bio
 = 
bio
;

415 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

417 
	`INIT_WORK
(&
mddev
->
Êush_w‹k
, 
submô_Êushes
);

418 
	`queue_w‹k
(
md_wq
, &
mddev
->
Êush_w‹k
);

419 
	}
}

420 
EXPORT_SYMBOL
(
md_Êush_ªque°
);

422 
	$md_u≈lug
(
blk_∂ug_cb
 *
cb
, 
boﬁ
 
‰om_scheduÀ
)

424 
mddev
 *mddev = 
cb
->
d©a
;

425 
	`md_wakeup_thªad
(
mddev
->
thªad
);

426 
	`k‰ì
(
cb
);

427 
	}
}

428 
EXPORT_SYMBOL
(
md_u≈lug
);

430 
ölöe
 
mddev
 *
	$mddev_gë
(
mddev
 *mddev)

432 
	`©omic_öc
(&
mddev
->
a˘ive
);

433  
mddev
;

434 
	}
}

436 
mddev_dñayed_dñëe
(
w‹k_°ru˘
 *
ws
);

438 
	$mddev_put
(
mddev
 *mddev)

440 
bio_£t
 *
bs
 = 
NULL
;

442 i‡(!
	`©omic_dec_™d_lock
(&
mddev
->
a˘ive
, &
Æl_mddevs_lock
))

444 i‡(!
mddev
->
øid_disks
 && 
	`li°_em±y
(&mddev->
disks
) &&

445 
mddev
->
˘ime
 =0 && !mddev->
hﬁd_a˘ive
) {

448 
	`li°_dñ_öô
(&
mddev
->
Æl_mddevs
);

449 
bs
 = 
mddev
->
bio_£t
;

450 
mddev
->
bio_£t
 = 
NULL
;

451 i‡(
mddev
->
gídisk
) {

457 
	`INIT_WORK
(&
mddev
->
dñ_w‹k
, 
mddev_dñayed_dñëe
);

458 
	`queue_w‹k
(
md_misc_wq
, &
mddev
->
dñ_w‹k
);

460 
	`k‰ì
(
mddev
);

462 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

463 i‡(
bs
)

464 
	`bio£t_‰ì
(
bs
);

465 
	}
}

467 
	$mddev_öô
(
mddev
 *mddev)

469 
	`muãx_öô
(&
mddev
->
›í_muãx
);

470 
	`muãx_öô
(&
mddev
->
ªc⁄fig_muãx
);

471 
	`muãx_öô
(&
mddev
->
bôm≠_öfo
.
muãx
);

472 
	`INIT_LIST_HEAD
(&
mddev
->
disks
);

473 
	`INIT_LIST_HEAD
(&
mddev
->
Æl_mddevs
);

474 
	`öô_timî
(&
mddev
->
ß„mode_timî
);

475 
	`©omic_£t
(&
mddev
->
a˘ive
, 1);

476 
	`©omic_£t
(&
mddev
->
›íîs
, 0);

477 
	`©omic_£t
(&
mddev
->
a˘ive_io
, 0);

478 
	`•ö_lock_öô
(&
mddev
->
wrôe_lock
);

479 
	`©omic_£t
(&
mddev
->
Êush_≥ndög
, 0);

480 
	`öô_waôqueue_hód
(&
mddev
->
sb_waô
);

481 
	`öô_waôqueue_hód
(&
mddev
->
ªcovîy_waô
);

482 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

483 
mddev
->
ªsh≠e_backw¨ds
 = 0;

484 
mddev
->
œ°_sync_a˘i⁄
 = "none";

485 
mddev
->
ªsync_mö
 = 0;

486 
mddev
->
ªsync_max
 = 
MaxSe˘‹
;

487 
mddev
->
Àvñ
 = 
LEVEL_NONE
;

488 
	}
}

489 
EXPORT_SYMBOL_GPL
(
mddev_öô
);

491 
mddev
 * 
	$mddev_föd
(
dev_t
 
unô
)

493 
mddev
 *mddev, *
√w
 = 
NULL
;

495 i‡(
unô
 && 
	`MAJOR
(unôË!
MD_MAJOR
)

496 
unô
 &~((1<<
MdpMö‹Shi·
)-1);

498 
ªåy
:

499 
	`•ö_lock
(&
Æl_mddevs_lock
);

501 i‡(
unô
) {

502 
	`li°_f‹_óch_íåy
(
mddev
, &
Æl_mddevs
,áll_mddevs)

503 i‡(
mddev
->
unô
 == unit) {

504 
	`mddev_gë
(
mddev
);

505 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

506 
	`k‰ì
(
√w
);

507  
mddev
;

510 i‡(
√w
) {

511 
	`li°_add
(&
√w
->
Æl_mddevs
, &all_mddevs);

512 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

513 
√w
->
hﬁd_a˘ive
 = 
UNTIL_IOCTL
;

514  
√w
;

516 } i‡(
√w
) {

518 
√xt_mö‹
 = 512;

519 
°¨t
 = 
√xt_mö‹
;

520 
is_‰ì
 = 0;

521 
dev
 = 0;

522 !
is_‰ì
) {

523 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
√xt_mö‹
);

524 
√xt_mö‹
++;

525 i‡(
√xt_mö‹
 > 
MINORMASK
)

526 
√xt_mö‹
 = 0;

527 i‡(
√xt_mö‹
 =
°¨t
) {

529 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

530 
	`k‰ì
(
√w
);

531  
NULL
;

534 
is_‰ì
 = 1;

535 
	`li°_f‹_óch_íåy
(
mddev
, &
Æl_mddevs
,áll_mddevs)

536 i‡(
mddev
->
unô
 =
dev
) {

537 
is_‰ì
 = 0;

541 
√w
->
unô
 = 
dev
;

542 
√w
->
md_mö‹
 = 
	`MINOR
(
dev
);

543 
√w
->
hﬁd_a˘ive
 = 
UNTIL_STOP
;

544 
	`li°_add
(&
√w
->
Æl_mddevs
, &all_mddevs);

545 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

546  
√w
;

548 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

550 
√w
 = 
	`kzÆloc
((*√w), 
GFP_KERNEL
);

551 i‡(!
√w
)

552  
NULL
;

554 
√w
->
unô
 = unit;

555 i‡(
	`MAJOR
(
unô
Ë=
MD_MAJOR
)

556 
√w
->
md_mö‹
 = 
	`MINOR
(
unô
);

558 
√w
->
md_mö‹
 = 
	`MINOR
(
unô
Ë>> 
MdpMö‹Shi·
;

560 
	`mddev_öô
(
√w
);

562 
ªåy
;

563 
	}
}

565 
ölöe
 
__mu°_check
 
	$mddev_lock
(
mddev
 * mddev)

567  
	`muãx_lock_öãºu±ibÀ
(&
mddev
->
ªc⁄fig_muãx
);

568 
	}
}

573 
ölöe
 
	$mddev_lock_noöå
(
mddev
 * mddev)

575 
	`muãx_lock
(&
mddev
->
ªc⁄fig_muãx
);

576 
	}
}

578 
ölöe
 
	$mddev_is_locked
(
mddev
 *mddev)

580  
	`muãx_is_locked
(&
mddev
->
ªc⁄fig_muãx
);

581 
	}
}

583 
ölöe
 
	$mddev_åylock
(
mddev
 * mddev)

585  
	`muãx_åylock
(&
mddev
->
ªc⁄fig_muãx
);

586 
	}
}

588 
©åibuã_group
 
	gmd_ªdund™cy_group
;

590 
	$mddev_u∆ock
(
mddev
 * mddev)

592 i‡(
mddev
->
to_ªmove
) {

605 
©åibuã_group
 *
to_ªmove
 = 
mddev
->to_remove;

606 
mddev
->
to_ªmove
 = 
NULL
;

607 
mddev
->
sysfs_a˘ive
 = 1;

608 
	`muãx_u∆ock
(&
mddev
->
ªc⁄fig_muãx
);

610 i‡(
mddev
->
kobj
.
sd
) {

611 i‡(
to_ªmove
 !&
md_ªdund™cy_group
)

612 
	`sysfs_ªmove_group
(&
mddev
->
kobj
, 
to_ªmove
);

613 i‡(
mddev
->
≥rs
 =
NULL
 ||

614 
mddev
->
≥rs
->
sync_ªque°
 =
NULL
) {

615 
	`sysfs_ªmove_group
(&
mddev
->
kobj
, &
md_ªdund™cy_group
);

616 i‡(
mddev
->
sysfs_a˘i⁄
)

617 
	`sysfs_put
(
mddev
->
sysfs_a˘i⁄
);

618 
mddev
->
sysfs_a˘i⁄
 = 
NULL
;

621 
mddev
->
sysfs_a˘ive
 = 0;

623 
	`muãx_u∆ock
(&
mddev
->
ªc⁄fig_muãx
);

628 
	`•ö_lock
(&
≥rs_lock
);

629 
	`md_wakeup_thªad
(
mddev
->
thªad
);

630 
	`•ö_u∆ock
(&
≥rs_lock
);

631 
	}
}

633 
md_rdev
 * 
	$föd_rdev_ƒ
(
mddev
 *mddev, 
ƒ
)

635 
md_rdev
 *
rdev
;

637 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

638 i‡(
rdev
->
desc_ƒ
 =
ƒ
)

639  
rdev
;

641  
NULL
;

642 
	}
}

644 
md_rdev
 *
	$föd_rdev_ƒ_rcu
(
mddev
 *mddev, 
ƒ
)

646 
md_rdev
 *
rdev
;

648 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
)

649 i‡(
rdev
->
desc_ƒ
 =
ƒ
)

650  
rdev
;

652  
NULL
;

653 
	}
}

655 
md_rdev
 *
	$föd_rdev
(
mddev
 *mddev, 
dev_t
 
dev
)

657 
md_rdev
 *
rdev
;

659 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

660 i‡(
rdev
->
bdev
->
bd_dev
 =
dev
)

661  
rdev
;

663  
NULL
;

664 
	}
}

666 
md_rdev
 *
	$föd_rdev_rcu
(
mddev
 *mddev, 
dev_t
 
dev
)

668 
md_rdev
 *
rdev
;

670 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
)

671 i‡(
rdev
->
bdev
->
bd_dev
 =
dev
)

672  
rdev
;

674  
NULL
;

675 
	}
}

677 
md_≥rs⁄Æôy
 *
	$föd_≥rs
(
Àvñ
, *
˛evñ
)

679 
md_≥rs⁄Æôy
 *
≥rs
;

680 
	`li°_f‹_óch_íåy
(
≥rs
, &
≥rs_li°
, 
li°
) {

681 i‡(
Àvñ
 !
LEVEL_NONE
 && 
≥rs
->level ==Üevel)

682  
≥rs
;

683 i‡(
	`°rcmp
(
≥rs
->
«me
, 
˛evñ
)==0)

684  
≥rs
;

686  
NULL
;

687 
	}
}

690 
ölöe
 
£˘‹_t
 
	$ˇlc_dev_sboff£t
(
md_rdev
 *
rdev
)

692 
£˘‹_t
 
num_£˘‹s
 = 
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) / 512;

693  
	`MD_NEW_SIZE_SECTORS
(
num_£˘‹s
);

694 
	}
}

696 
	$Æloc_disk_sb
(
md_rdev
 * 
rdev
)

698 i‡(
rdev
->
sb_∑ge
)

699 
	`MD_BUG
();

701 
rdev
->
sb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

702 i‡(!
rdev
->
sb_∑ge
) {

703 
	`¥ötk
(
KERN_ALERT
 "md: out of memory.\n");

704  -
ENOMEM
;

708 
	}
}

710 
	$md_rdev_˛ór
(
md_rdev
 *
rdev
)

712 i‡(
rdev
->
sb_∑ge
) {

713 
	`put_∑ge
(
rdev
->
sb_∑ge
);

714 
rdev
->
sb_lﬂded
 = 0;

715 
rdev
->
sb_∑ge
 = 
NULL
;

716 
rdev
->
sb_°¨t
 = 0;

717 
rdev
->
£˘‹s
 = 0;

719 i‡(
rdev
->
bb_∑ge
) {

720 
	`put_∑ge
(
rdev
->
bb_∑ge
);

721 
rdev
->
bb_∑ge
 = 
NULL
;

723 
	`k‰ì
(
rdev
->
badblocks
.
∑ge
);

724 
rdev
->
badblocks
.
∑ge
 = 
NULL
;

725 
	}
}

726 
EXPORT_SYMBOL_GPL
(
md_rdev_˛ór
);

728 
	$su≥r_wrôãn
(
bio
 *bio, 
îr‹
)

730 
md_rdev
 *
rdev
 = 
bio
->
bi_¥iv©e
;

731 
mddev
 *mddev = 
rdev
->mddev;

733 i‡(
îr‹
 || !
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
)) {

734 
	`¥ötk
("md: super_written getsÉrror=%d, uptodate=%d\n",

735 
îr‹
, 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
));

736 
	`WARN_ON
(
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
));

737 
	`md_îr‹
(
mddev
, 
rdev
);

740 i‡(
	`©omic_dec_™d_ã°
(&
mddev
->
≥ndög_wrôes
))

741 
	`wake_up
(&
mddev
->
sb_waô
);

742 
	`bio_put
(
bio
);

743 
	}
}

745 
	$md_su≥r_wrôe
(
mddev
 *mddev, 
md_rdev
 *
rdev
,

746 
£˘‹_t
 
£˘‹
, 
size
, 
∑ge
 *page)

754 
bio
 *biÿ
	`bio_Æloc_mddev
(
GFP_NOIO
, 1, 
mddev
);

756 
bio
->
bi_bdev
 = 
rdev
->
mëa_bdev
 ?Ñdev->mëa_bdev :Ñdev->
bdev
;

757 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
;

758 
	`bio_add_∑ge
(
bio
, 
∑ge
, 
size
, 0);

759 
bio
->
bi_¥iv©e
 = 
rdev
;

760 
bio
->
bi_íd_io
 = 
su≥r_wrôãn
;

762 
	`©omic_öc
(&
mddev
->
≥ndög_wrôes
);

763 
	`submô_bio
(
WRITE_FLUSH_FUA
, 
bio
);

764 
	}
}

766 
	$md_su≥r_waô
(
mddev
 *mddev)

769 
	`DEFINE_WAIT
(
wq
);

771 
	`¥ï¨e_to_waô
(&
mddev
->
sb_waô
, &
wq
, 
TASK_UNINTERRUPTIBLE
);

772 i‡(
	`©omic_ªad
(&
mddev
->
≥ndög_wrôes
)==0)

774 
	`scheduÀ
();

776 
	`föish_waô
(&
mddev
->
sb_waô
, &
wq
);

777 
	}
}

779 
	$sync_∑ge_io
(
md_rdev
 *
rdev
, 
£˘‹_t
 
£˘‹
, 
size
,

780 
∑ge
 *∑ge, 
rw
, 
boﬁ
 
mëad©a_›
)

782 
bio
 *biÿ
	`bio_Æloc_mddev
(
GFP_NOIO
, 1, 
rdev
->
mddev
);

783 
ªt
;

785 
bio
->
bi_bdev
 = (
mëad©a_›
 && 
rdev
->
mëa_bdev
) ?

786 
rdev
->
mëa_bdev
 :Ñdev->
bdev
;

787 i‡(
mëad©a_›
)

788 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 + 
rdev
->
sb_°¨t
;

789 i‡(
rdev
->
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 &&

790 (
rdev
->
mddev
->
ªsh≠e_backw¨ds
 ==

791 (
£˘‹
 >
rdev
->
mddev
->
ªsh≠e_posôi⁄
)))

792 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 + 
rdev
->
√w_d©a_off£t
;

794 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 + 
rdev
->
d©a_off£t
;

795 
	`bio_add_∑ge
(
bio
, 
∑ge
, 
size
, 0);

796 
	`submô_bio_waô
(
rw
, 
bio
);

798 
ªt
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

799 
	`bio_put
(
bio
);

800  
ªt
;

801 
	}
}

802 
EXPORT_SYMBOL_GPL
(
sync_∑ge_io
);

804 
	$ªad_disk_sb
(
md_rdev
 * 
rdev
, 
size
)

806 
b
[
BDEVNAME_SIZE
];

807 i‡(!
rdev
->
sb_∑ge
) {

808 
	`MD_BUG
();

809  -
EINVAL
;

811 i‡(
rdev
->
sb_lﬂded
)

815 i‡(!
	`sync_∑ge_io
(
rdev
, 0, 
size
,Ñdev->
sb_∑ge
, 
READ
, 
åue
))

816 
Áû
;

817 
rdev
->
sb_lﬂded
 = 1;

820 
Áû
:

821 
	`¥ötk
(
KERN_WARNING
 "md: disabled device %s, couldÇotÑead superblock.\n",

822 
	`bdev«me
(
rdev
->
bdev
,
b
));

823  -
EINVAL
;

824 
	}
}

826 
	$uuid_equÆ
(
mdp_su≥r_t
 *
sb1
, mdp_su≥r_à*
sb2
)

828  
sb1
->
£t_uuid0
 =
sb2
->set_uuid0 &&

829 
sb1
->
£t_uuid1
 =
sb2
->set_uuid1 &&

830 
sb1
->
£t_uuid2
 =
sb2
->set_uuid2 &&

831 
sb1
->
£t_uuid3
 =
sb2
->set_uuid3;

832 
	}
}

834 
	$sb_equÆ
(
mdp_su≥r_t
 *
sb1
, mdp_su≥r_à*
sb2
)

836 
ªt
;

837 
mdp_su≥r_t
 *
tmp1
, *
tmp2
;

839 
tmp1
 = 
	`kmÆloc
((*tmp1),
GFP_KERNEL
);

840 
tmp2
 = 
	`kmÆloc
((*tmp2),
GFP_KERNEL
);

842 i‡(!
tmp1
 || !
tmp2
) {

843 
ªt
 = 0;

844 
	`¥ötk
(
KERN_INFO
 "md.c sb_equal(): failedÅoállocate memory!\n");

845 
ab‹t
;

848 *
tmp1
 = *
sb1
;

849 *
tmp2
 = *
sb2
;

854 
tmp1
->
ƒ_disks
 = 0;

855 
tmp2
->
ƒ_disks
 = 0;

857 
ªt
 = (
	`memcmp
(
tmp1
, 
tmp2
, 
MD_SB_GENERIC_CONSTANT_WORDS
 * 4) == 0);

858 
ab‹t
:

859 
	`k‰ì
(
tmp1
);

860 
	`k‰ì
(
tmp2
);

861  
ªt
;

862 
	}
}

865 
u32
 
	$md_csum_fﬁd
(
u32
 
csum
)

867 
csum
 = (csum & 0xffff) + (csum >> 16);

868  (
csum
 & 0xffff) + (csum >> 16);

869 
	}
}

871 
	$ˇlc_sb_csum
(
mdp_su≥r_t
 * 
sb
)

873 
u64
 
√wcsum
 = 0;

874 
u32
 *
sb32
 = (u32*)
sb
;

875 
i
;

876 
disk_csum
, 
csum
;

878 
disk_csum
 = 
sb
->
sb_csum
;

879 
sb
->
sb_csum
 = 0;

881 
i
 = 0; i < 
MD_SB_BYTES
/4 ; i++)

882 
√wcsum
 +
sb32
[
i
];

883 
csum
 = (
√wcsum
 & 0xffffffff) + (newcsum>>32);

886 #ifde‡
CONFIG_ALPHA


895 
sb
->
sb_csum
 = 
	`md_csum_fﬁd
(
disk_csum
);

897 
sb
->
sb_csum
 = 
disk_csum
;

899  
csum
;

900 
	}
}

933 
	ssu≥r_ty≥
 {

934 *
	m«me
;

935 
moduÀ
 *
	mow√r
;

936 (*
	mlﬂd_su≥r
)(
md_rdev
 *
	mrdev
,

937 
md_rdev
 *
	mªfdev
,

938 
	mmö‹_vîsi⁄
);

939 (*
	mvÆid©e_su≥r
)(
mddev
 *
	mmddev
,

940 
md_rdev
 *
	mrdev
);

941 (*
	msync_su≥r
)(
mddev
 *
	mmddev
,

942 
md_rdev
 *
	mrdev
);

943 (*
	mrdev_size_ch™ge
)(
md_rdev
 *
	mrdev
,

944 
£˘‹_t
 
	mnum_£˘‹s
);

945 (*
	mÆlow_√w_off£t
)(
md_rdev
 *
	mrdev
,

946 
	m√w_off£t
);

957 
	$md_check_no_bôm≠
(
mddev
 *mddev)

959 i‡(!
mddev
->
bôm≠_öfo
.
fûe
 && !mddev->bôm≠_öfo.
off£t
)

961 
	`¥ötk
(
KERN_ERR
 "%s: bitmapsáreÇot supported for %s\n",

962 
	`md«me
(
mddev
), mddev->
≥rs
->
«me
);

964 
	}
}

965 
EXPORT_SYMBOL
(
md_check_no_bôm≠
);

970 
	$su≥r_90_lﬂd
(
md_rdev
 *
rdev
, md_rdev *
ªfdev
, 
mö‹_vîsi⁄
)

972 
b
[
BDEVNAME_SIZE
], 
b2
[BDEVNAME_SIZE];

973 
mdp_su≥r_t
 *
sb
;

974 
ªt
;

982 
rdev
->
sb_°¨t
 = 
	`ˇlc_dev_sboff£t
(rdev);

984 
ªt
 = 
	`ªad_disk_sb
(
rdev
, 
MD_SB_BYTES
);

985 i‡(
ªt
) Ñet;

987 
ªt
 = -
EINVAL
;

989 
	`bdev«me
(
rdev
->
bdev
, 
b
);

990 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

992 i‡(
sb
->
md_magic
 !
MD_SB_MAGIC
) {

993 
	`¥ötk
(
KERN_ERR
 "md: invalidÑaid superblock magic on %s\n",

994 
b
);

995 
ab‹t
;

998 i‡(
sb
->
maj‹_vîsi⁄
 != 0 ||

999 
sb
->
mö‹_vîsi⁄
 < 90 ||

1000 
sb
->
mö‹_vîsi⁄
 > 91) {

1001 
	`¥ötk
(
KERN_WARNING
 "Bad versionÇumber %d.%d on %s\n",

1002 
sb
->
maj‹_vîsi⁄
, sb->
mö‹_vîsi⁄
,

1003 
b
);

1004 
ab‹t
;

1007 i‡(
sb
->
øid_disks
 <= 0)

1008 
ab‹t
;

1010 i‡(
	`md_csum_fﬁd
(
	`ˇlc_sb_csum
(
sb
)Ë!md_csum_fﬁd(sb->
sb_csum
)) {

1011 
	`¥ötk
(
KERN_WARNING
 "md: invalid superblock checksum on %s\n",

1012 
b
);

1013 
ab‹t
;

1016 
rdev
->
¥e„ºed_mö‹
 = 
sb
->
md_mö‹
;

1017 
rdev
->
d©a_off£t
 = 0;

1018 
rdev
->
√w_d©a_off£t
 = 0;

1019 
rdev
->
sb_size
 = 
MD_SB_BYTES
;

1020 
rdev
->
badblocks
.
shi·
 = -1;

1022 i‡(
sb
->
Àvñ
 =
LEVEL_MULTIPATH
)

1023 
rdev
->
desc_ƒ
 = -1;

1025 
rdev
->
desc_ƒ
 = 
sb
->
this_disk
.
numbî
;

1027 i‡(!
ªfdev
) {

1028 
ªt
 = 1;

1030 
__u64
 
ev1
, 
ev2
;

1031 
mdp_su≥r_t
 *
ªfsb
 = 
	`∑ge_addªss
(
ªfdev
->
sb_∑ge
);

1032 i‡(!
	`uuid_equÆ
(
ªfsb
, 
sb
)) {

1033 
	`¥ötk
(
KERN_WARNING
 "md: %s has different UUIDÅo %s\n",

1034 
b
, 
	`bdev«me
(
ªfdev
->
bdev
,
b2
));

1035 
ab‹t
;

1037 i‡(!
	`sb_equÆ
(
ªfsb
, 
sb
)) {

1038 
	`¥ötk
(
KERN_WARNING
 "md: %s has same UUID"

1040 
b
, 
	`bdev«me
(
ªfdev
->
bdev
, 
b2
));

1041 
ab‹t
;

1043 
ev1
 = 
	`md_evít
(
sb
);

1044 
ev2
 = 
	`md_evít
(
ªfsb
);

1045 i‡(
ev1
 > 
ev2
)

1046 
ªt
 = 1;

1048 
ªt
 = 0;

1050 
rdev
->
£˘‹s
 =Ñdev->
sb_°¨t
;

1055 i‡(
rdev
->
£˘‹s
 >(2ULL << 32Ë&& 
sb
->
Àvñ
 >= 1)

1056 
rdev
->
£˘‹s
 = (2ULL << 32) - 2;

1058 i‡(
rdev
->
£˘‹s
 < ((
£˘‹_t
)
sb
->
size
Ë* 2 && sb->
Àvñ
 >= 1)

1060 
ªt
 = -
EINVAL
;

1062 
ab‹t
:

1063  
ªt
;

1064 
	}
}

1069 
	$su≥r_90_vÆid©e
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1071 
mdp_disk_t
 *
desc
;

1072 
mdp_su≥r_t
 *
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1073 
__u64
 
ev1
 = 
	`md_evít
(
sb
);

1075 
rdev
->
øid_disk
 = -1;

1076 
	`˛ór_bô
(
Fau…y
, &
rdev
->
Êags
);

1077 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1078 
	`˛ór_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

1079 
	`˛ór_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

1081 i‡(
mddev
->
øid_disks
 == 0) {

1082 
mddev
->
maj‹_vîsi⁄
 = 0;

1083 
mddev
->
mö‹_vîsi⁄
 = 
sb
->minor_version;

1084 
mddev
->
∑tch_vîsi⁄
 = 
sb
->patch_version;

1085 
mddev
->
exã∫Æ
 = 0;

1086 
mddev
->
chunk_£˘‹s
 = 
sb
->
chunk_size
 >> 9;

1087 
mddev
->
˘ime
 = 
sb
->ctime;

1088 
mddev
->
utime
 = 
sb
->utime;

1089 
mddev
->
Àvñ
 = 
sb
->level;

1090 
mddev
->
˛evñ
[0] = 0;

1091 
mddev
->
œyout
 = 
sb
->layout;

1092 
mddev
->
øid_disks
 = 
sb
->raid_disks;

1093 
mddev
->
dev_£˘‹s
 = ((
£˘‹_t
)
sb
->
size
) * 2;

1094 
mddev
->
evíts
 = 
ev1
;

1095 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

1096 
mddev
->
bôm≠_öfo
.
•a˚
 = 0;

1098 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 = 
MD_SB_BYTES
 >> 9;

1099 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
 = 64*2 - (
MD_SB_BYTES
 >> 9);

1100 
mddev
->
ªsh≠e_backw¨ds
 = 0;

1102 i‡(
mddev
->
mö‹_vîsi⁄
 >= 91) {

1103 
mddev
->
ªsh≠e_posôi⁄
 = 
sb
->reshape_position;

1104 
mddev
->
dñè_disks
 = 
sb
->delta_disks;

1105 
mddev
->
√w_Àvñ
 = 
sb
->new_level;

1106 
mddev
->
√w_œyout
 = 
sb
->new_layout;

1107 
mddev
->
√w_chunk_£˘‹s
 = 
sb
->
√w_chunk
 >> 9;

1108 i‡(
mddev
->
dñè_disks
 < 0)

1109 
mddev
->
ªsh≠e_backw¨ds
 = 1;

1111 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

1112 
mddev
->
dñè_disks
 = 0;

1113 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

1114 
mddev
->
√w_œyout
 = mddev->
œyout
;

1115 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

1118 i‡(
sb
->
°©e
 & (1<<
MD_SB_CLEAN
))

1119 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

1121 i‡(
sb
->
evíts_hi
 =sb->
˝_evíts_hi
 &&

1122 
sb
->
evíts_lo
 =sb->
˝_evíts_lo
) {

1123 
mddev
->
ªcovîy_˝
 = 
sb
->recovery_cp;

1125 
mddev
->
ªcovîy_˝
 = 0;

1128 
	`mem˝y
(
mddev
->
uuid
+0, &
sb
->
£t_uuid0
, 4);

1129 
	`mem˝y
(
mddev
->
uuid
+4, &
sb
->
£t_uuid1
, 4);

1130 
	`mem˝y
(
mddev
->
uuid
+8, &
sb
->
£t_uuid2
, 4);

1131 
	`mem˝y
(
mddev
->
uuid
+12,&
sb
->
£t_uuid3
, 4);

1133 
mddev
->
max_disks
 = 
MD_SB_DISKS
;

1135 i‡(
sb
->
°©e
 & (1<<
MD_SB_BITMAP_PRESENT
) &&

1136 
mddev
->
bôm≠_öfo
.
fûe
 =
NULL
) {

1137 
mddev
->
bôm≠_öfo
.
off£t
 =

1138 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
;

1139 
mddev
->
bôm≠_öfo
.
•a˚
 =

1140 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
;

1143 } i‡(
mddev
->
≥rs
 =
NULL
) {

1146 ++
ev1
;

1147 i‡(
sb
->
disks
[
rdev
->
desc_ƒ
].
°©e
 & (

1148 (1<<
MD_DISK_SYNC
Ë| (1 << 
MD_DISK_ACTIVE
)))

1149 i‡(
ev1
 < 
mddev
->
evíts
)

1150  -
EINVAL
;

1151 } i‡(
mddev
->
bôm≠
) {

1155 i‡(
ev1
 < 
mddev
->
bôm≠
->
evíts_˛óªd
)

1157 i‡(
ev1
 < 
mddev
->
evíts
)

1158 
	`£t_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

1160 i‡(
ev1
 < 
mddev
->
evíts
)

1165 i‡(
mddev
->
Àvñ
 !
LEVEL_MULTIPATH
) {

1166 
desc
 = 
sb
->
disks
 + 
rdev
->
desc_ƒ
;

1168 i‡(
desc
->
°©e
 & (1<<
MD_DISK_FAULTY
))

1169 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1170 i‡(
desc
->
°©e
 & (1<<
MD_DISK_SYNC
)

1172 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

1173 
rdev
->
øid_disk
 = 
desc
->raid_disk;

1174 
rdev
->
ßved_øid_disk
 = 
desc
->
øid_disk
;

1175 } i‡(
desc
->
°©e
 & (1<<
MD_DISK_ACTIVE
)) {

1179 i‡(
mddev
->
mö‹_vîsi⁄
 >= 91) {

1180 
rdev
->
ªcovîy_off£t
 = 0;

1181 
rdev
->
øid_disk
 = 
desc
->raid_disk;

1184 i‡(
desc
->
°©e
 & (1<<
MD_DISK_WRITEMOSTLY
))

1185 
	`£t_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

1187 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

1189 
	}
}

1194 
	$su≥r_90_sync
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1196 
mdp_su≥r_t
 *
sb
;

1197 
md_rdev
 *
rdev2
;

1198 
√xt_•¨e
 = 
mddev
->
øid_disks
;

1211 
i
;

1212 
a˘ive
=0, 
w‹kög
=0,
Áûed
=0,
•¨e
=0,
ƒ_disks
=0;

1214 
rdev
->
sb_size
 = 
MD_SB_BYTES
;

1216 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1218 
	`mem£t
(
sb
, 0, (*sb));

1220 
sb
->
md_magic
 = 
MD_SB_MAGIC
;

1221 
sb
->
maj‹_vîsi⁄
 = 
mddev
->major_version;

1222 
sb
->
∑tch_vîsi⁄
 = 
mddev
->patch_version;

1223 
sb
->
gvÆid_w‹ds
 = 0;

1224 
	`mem˝y
(&
sb
->
£t_uuid0
, 
mddev
->
uuid
+0, 4);

1225 
	`mem˝y
(&
sb
->
£t_uuid1
, 
mddev
->
uuid
+4, 4);

1226 
	`mem˝y
(&
sb
->
£t_uuid2
, 
mddev
->
uuid
+8, 4);

1227 
	`mem˝y
(&
sb
->
£t_uuid3
, 
mddev
->
uuid
+12,4);

1229 
sb
->
˘ime
 = 
mddev
->ctime;

1230 
sb
->
Àvñ
 = 
mddev
->level;

1231 
sb
->
size
 = 
mddev
->
dev_£˘‹s
 / 2;

1232 
sb
->
øid_disks
 = 
mddev
->raid_disks;

1233 
sb
->
md_mö‹
 = 
mddev
->md_minor;

1234 
sb
->
nŸ_≥rsi°ít
 = 0;

1235 
sb
->
utime
 = 
mddev
->utime;

1236 
sb
->
°©e
 = 0;

1237 
sb
->
evíts_hi
 = (
mddev
->
evíts
>>32);

1238 
sb
->
evíts_lo
 = (
u32
)
mddev
->
evíts
;

1240 i‡(
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
)

1241 
sb
->
mö‹_vîsi⁄
 = 90;

1243 
sb
->
mö‹_vîsi⁄
 = 91;

1244 
sb
->
ªsh≠e_posôi⁄
 = 
mddev
->reshape_position;

1245 
sb
->
√w_Àvñ
 = 
mddev
->new_level;

1246 
sb
->
dñè_disks
 = 
mddev
->delta_disks;

1247 
sb
->
√w_œyout
 = 
mddev
->new_layout;

1248 
sb
->
√w_chunk
 = 
mddev
->
√w_chunk_£˘‹s
 << 9;

1250 
mddev
->
mö‹_vîsi⁄
 = 
sb
->minor_version;

1251 i‡(
mddev
->
ö_sync
)

1253 
sb
->
ªcovîy_˝
 = 
mddev
->recovery_cp;

1254 
sb
->
˝_evíts_hi
 = (
mddev
->
evíts
>>32);

1255 
sb
->
˝_evíts_lo
 = (
u32
)
mddev
->
evíts
;

1256 i‡(
mddev
->
ªcovîy_˝
 =
MaxSe˘‹
)

1257 
sb
->
°©e
 = (1<< 
MD_SB_CLEAN
);

1259 
sb
->
ªcovîy_˝
 = 0;

1261 
sb
->
œyout
 = 
mddev
->layout;

1262 
sb
->
chunk_size
 = 
mddev
->
chunk_£˘‹s
 << 9;

1264 i‡(
mddev
->
bôm≠
 && mddev->
bôm≠_öfo
.
fûe
 =
NULL
)

1265 
sb
->
°©e
 |(1<<
MD_SB_BITMAP_PRESENT
);

1267 
sb
->
disks
[0].
°©e
 = (1<<
MD_DISK_REMOVED
);

1268 
	`rdev_f‹_óch
(
rdev2
, 
mddev
) {

1269 
mdp_disk_t
 *
d
;

1270 
desc_ƒ
;

1271 
is_a˘ive
 = 
	`ã°_bô
(
In_sync
, &
rdev2
->
Êags
);

1273 i‡(
rdev2
->
øid_disk
 >= 0 &&

1274 
sb
->
mö‹_vîsi⁄
 >= 91)

1279 
is_a˘ive
 = 1;

1280 i‡(
rdev2
->
øid_disk
 < 0 ||

1281 
	`ã°_bô
(
Fau…y
, &
rdev2
->
Êags
))

1282 
is_a˘ive
 = 0;

1283 i‡(
is_a˘ive
)

1284 
desc_ƒ
 = 
rdev2
->
øid_disk
;

1286 
desc_ƒ
 = 
√xt_•¨e
++;

1287 
rdev2
->
desc_ƒ
 = desc_nr;

1288 
d
 = &
sb
->
disks
[
rdev2
->
desc_ƒ
];

1289 
ƒ_disks
++;

1290 
d
->
numbî
 = 
rdev2
->
desc_ƒ
;

1291 
d
->
maj‹
 = 
	`MAJOR
(
rdev2
->
bdev
->
bd_dev
);

1292 
d
->
mö‹
 = 
	`MINOR
(
rdev2
->
bdev
->
bd_dev
);

1293 i‡(
is_a˘ive
)

1294 
d
->
øid_disk
 = 
rdev2
->raid_disk;

1296 
d
->
øid_disk
 = 
rdev2
->
desc_ƒ
;

1297 i‡(
	`ã°_bô
(
Fau…y
, &
rdev2
->
Êags
))

1298 
d
->
°©e
 = (1<<
MD_DISK_FAULTY
);

1299 i‡(
is_a˘ive
) {

1300 
d
->
°©e
 = (1<<
MD_DISK_ACTIVE
);

1301 i‡(
	`ã°_bô
(
In_sync
, &
rdev2
->
Êags
))

1302 
d
->
°©e
 |(1<<
MD_DISK_SYNC
);

1303 
a˘ive
++;

1304 
w‹kög
++;

1306 
d
->
°©e
 = 0;

1307 
•¨e
++;

1308 
w‹kög
++;

1310 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev2
->
Êags
))

1311 
d
->
°©e
 |(1<<
MD_DISK_WRITEMOSTLY
);

1314 
i
=0 ; i < 
mddev
->
øid_disks
 ; i++) {

1315 
mdp_disk_t
 *
d
 = &
sb
->
disks
[
i
];

1316 i‡(
d
->
°©e
 =0 && d->
numbî
 == 0) {

1317 
d
->
numbî
 = 
i
;

1318 
d
->
øid_disk
 = 
i
;

1319 
d
->
°©e
 = (1<<
MD_DISK_REMOVED
);

1320 
d
->
°©e
 |(1<<
MD_DISK_FAULTY
);

1321 
Áûed
++;

1324 
sb
->
ƒ_disks
 =Çr_disks;

1325 
sb
->
a˘ive_disks
 = 
a˘ive
;

1326 
sb
->
w‹kög_disks
 = 
w‹kög
;

1327 
sb
->
Áûed_disks
 = 
Áûed
;

1328 
sb
->
•¨e_disks
 = 
•¨e
;

1330 
sb
->
this_disk
 = sb->
disks
[
rdev
->
desc_ƒ
];

1331 
sb
->
sb_csum
 = 
	`ˇlc_sb_csum
(sb);

1332 
	}
}

1338 
	$su≥r_90_rdev_size_ch™ge
(
md_rdev
 *
rdev
, 
£˘‹_t
 
num_£˘‹s
)

1340 i‡(
num_£˘‹s
 &&Çum_£˘‹†< 
rdev
->
mddev
->
dev_£˘‹s
)

1342 i‡(
rdev
->
mddev
->
bôm≠_öfo
.
off£t
)

1344 
rdev
->
sb_°¨t
 = 
	`ˇlc_dev_sboff£t
(rdev);

1345 i‡(!
num_£˘‹s
 ||Çum_£˘‹†> 
rdev
->
sb_°¨t
)

1346 
num_£˘‹s
 = 
rdev
->
sb_°¨t
;

1350 i‡(
num_£˘‹s
 >(2ULL << 32Ë&& 
rdev
->
mddev
->
Àvñ
 >= 1)

1351 
num_£˘‹s
 = (2ULL << 32) - 2;

1352 
	`md_su≥r_wrôe
(
rdev
->
mddev
,Ñdev,Ñdev->
sb_°¨t
,Ñdev->
sb_size
,

1353 
rdev
->
sb_∑ge
);

1354 
	`md_su≥r_waô
(
rdev
->
mddev
);

1355  
num_£˘‹s
;

1356 
	}
}

1359 
	$su≥r_90_Ælow_√w_off£t
(
md_rdev
 *
rdev
, 
√w_off£t
)

1362  
√w_off£t
 == 0;

1363 
	}
}

1369 
__À32
 
	$ˇlc_sb_1_csum
(
mdp_su≥rblock_1
 * 
sb
)

1371 
__À32
 
disk_csum
;

1372 
u32
 
csum
;

1373 
√wcsum
;

1374 
size
 = 256 + 
	`À32_to_˝u
(
sb
->
max_dev
)*2;

1375 
__À32
 *
isu≥r
 = (__À32*)
sb
;

1377 
disk_csum
 = 
sb
->
sb_csum
;

1378 
sb
->
sb_csum
 = 0;

1379 
√wcsum
 = 0;

1380 ; 
size
 >= 4; size -= 4)

1381 
√wcsum
 +
	`À32_to_˝u
(*
isu≥r
++);

1383 i‡(
size
 == 2)

1384 
√wcsum
 +
	`À16_to_˝u
(*(
__À16
*Ë
isu≥r
);

1386 
csum
 = (
√wcsum
 & 0xffffffff) + (newcsum >> 32);

1387 
sb
->
sb_csum
 = 
disk_csum
;

1388  
	`˝u_to_À32
(
csum
);

1389 
	}
}

1391 
md_£t_badblocks
(
badblocks
 *
bb
, 
£˘‹_t
 
s
, 
£˘‹s
,

1392 
acknowÀdged
);

1393 
	$su≥r_1_lﬂd
(
md_rdev
 *
rdev
, md_rdev *
ªfdev
, 
mö‹_vîsi⁄
)

1395 
mdp_su≥rblock_1
 *
sb
;

1396 
ªt
;

1397 
£˘‹_t
 
sb_°¨t
;

1398 
£˘‹_t
 
£˘‹s
;

1399 
b
[
BDEVNAME_SIZE
], 
b2
[BDEVNAME_SIZE];

1400 
bmask
;

1410 
mö‹_vîsi⁄
) {

1412 
sb_°¨t
 = 
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) >> 9;

1413 
sb_°¨t
 -= 8*2;

1414 
sb_°¨t
 &~(
£˘‹_t
)(4*2-1);

1417 
sb_°¨t
 = 0;

1420 
sb_°¨t
 = 8;

1423  -
EINVAL
;

1425 
rdev
->
sb_°¨t
 = sb_start;

1430 
ªt
 = 
	`ªad_disk_sb
(
rdev
, 4096);

1431 i‡(
ªt
) Ñet;

1434 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1436 i‡(
sb
->
magic
 !
	`˝u_to_À32
(
MD_SB_MAGIC
) ||

1437 
sb
->
maj‹_vîsi⁄
 !
	`˝u_to_À32
(1) ||

1438 
	`À32_to_˝u
(
sb
->
max_dev
) > (4096-256)/2 ||

1439 
	`À64_to_˝u
(
sb
->
su≥r_off£t
Ë!
rdev
->
sb_°¨t
 ||

1440 (
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& ~
MD_FEATURE_ALL
) != 0)

1441  -
EINVAL
;

1443 i‡(
	`ˇlc_sb_1_csum
(
sb
Ë!sb->
sb_csum
) {

1444 
	`¥ötk
("md: invalid superblock checksum on %s\n",

1445 
	`bdev«me
(
rdev
->
bdev
,
b
));

1446  -
EINVAL
;

1448 i‡(
	`À64_to_˝u
(
sb
->
d©a_size
) < 10) {

1449 
	`¥ötk
("md: data_sizeÅoo small on %s\n",

1450 
	`bdev«me
(
rdev
->
bdev
,
b
));

1451  -
EINVAL
;

1453 i‡(
sb
->
∑d0
 ||

1454 
sb
->
∑d3
[0] ||

1455 
	`memcmp
(
sb
->
∑d3
, sb->pad3+1, (sb->pad3) - (sb->pad3[1])))

1457  -
EINVAL
;

1459 
rdev
->
¥e„ºed_mö‹
 = 0xffff;

1460 
rdev
->
d©a_off£t
 = 
	`À64_to_˝u
(
sb
->data_offset);

1461 
rdev
->
√w_d©a_off£t
 =Ñdev->
d©a_off£t
;

1462 i‡((
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_RESHAPE_ACTIVE
) &&

1463 (
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_NEW_OFFSET
))

1464 
rdev
->
√w_d©a_off£t
 +(
s32
)
	`À32_to_˝u
(
sb
->
√w_off£t
);

1465 
	`©omic_£t
(&
rdev
->
c‹ª˘ed_îr‹s
, 
	`À32_to_˝u
(
sb
->
˙t_c‹ª˘ed_ªad
));

1467 
rdev
->
sb_size
 = 
	`À32_to_˝u
(
sb
->
max_dev
) * 2 + 256;

1468 
bmask
 = 
	`queue_logiˇl_block_size
(
rdev
->
bdev
->
bd_disk
->
queue
)-1;

1469 i‡(
rdev
->
sb_size
 & 
bmask
)

1470 
rdev
->
sb_size
 = (rdev->sb_sizê| 
bmask
) + 1;

1472 i‡(
mö‹_vîsi⁄


1473 && 
rdev
->
d©a_off£t
 < 
sb_°¨t
 + (rdev->
sb_size
/512))

1474  -
EINVAL
;

1475 i‡(
mö‹_vîsi⁄


1476 && 
rdev
->
√w_d©a_off£t
 < 
sb_°¨t
 + (rdev->
sb_size
/512))

1477  -
EINVAL
;

1479 i‡(
sb
->
Àvñ
 =
	`˝u_to_À32
(
LEVEL_MULTIPATH
))

1480 
rdev
->
desc_ƒ
 = -1;

1482 
rdev
->
desc_ƒ
 = 
	`À32_to_˝u
(
sb
->
dev_numbî
);

1484 i‡(!
rdev
->
bb_∑ge
) {

1485 
rdev
->
bb_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

1486 i‡(!
rdev
->
bb_∑ge
)

1487  -
ENOMEM
;

1489 i‡((
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_BAD_BLOCKS
) &&

1490 
rdev
->
badblocks
.
cou¡
 == 0) {

1494 
s32
 
off£t
;

1495 
£˘‹_t
 
bb_£˘‹
;

1496 
u64
 *
bbp
;

1497 
i
;

1498 
£˘‹s
 = 
	`À16_to_˝u
(
sb
->
bblog_size
);

1499 i‡(
£˘‹s
 > (
PAGE_SIZE
 / 512))

1500  -
EINVAL
;

1501 
off£t
 = 
	`À32_to_˝u
(
sb
->
bblog_off£t
);

1502 i‡(
off£t
 == 0)

1503  -
EINVAL
;

1504 
bb_£˘‹
 = ()
off£t
;

1505 i‡(!
	`sync_∑ge_io
(
rdev
, 
bb_£˘‹
, 
£˘‹s
 << 9,

1506 
rdev
->
bb_∑ge
, 
READ
, 
åue
))

1507  -
EIO
;

1508 
bbp
 = (
u64
 *)
	`∑ge_addªss
(
rdev
->
bb_∑ge
);

1509 
rdev
->
badblocks
.
shi·
 = 
sb
->
bblog_shi·
;

1510 
i
 = 0 ; i < (
£˘‹s
 << (9-3)Ë; i++, 
bbp
++) {

1511 
u64
 
bb
 = 
	`À64_to_˝u
(*
bbp
);

1512 
cou¡
 = 
bb
 & (0x3ff);

1513 
u64
 
£˘‹
 = 
bb
 >> 10;

1514 
£˘‹
 <<
sb
->
bblog_shi·
;

1515 
cou¡
 <<
sb
->
bblog_shi·
;

1516 i‡(
bb
 + 1 == 0)

1518 i‡(
	`md_£t_badblocks
(&
rdev
->
badblocks
,

1519 
£˘‹
, 
cou¡
, 1) == 0)

1520  -
EINVAL
;

1522 } i‡(
sb
->
bblog_off£t
 != 0)

1523 
rdev
->
badblocks
.
shi·
 = 0;

1525 i‡(!
ªfdev
) {

1526 
ªt
 = 1;

1528 
__u64
 
ev1
, 
ev2
;

1529 
mdp_su≥rblock_1
 *
ªfsb
 = 
	`∑ge_addªss
(
ªfdev
->
sb_∑ge
);

1531 i‡(
	`memcmp
(
sb
->
£t_uuid
, 
ªfsb
->set_uuid, 16) != 0 ||

1532 
sb
->
Àvñ
 !
ªfsb
->level ||

1533 
sb
->
œyout
 !
ªfsb
->layout ||

1534 
sb
->
chunksize
 !
ªfsb
->chunksize) {

1535 
	`¥ötk
(
KERN_WARNING
 "md: %s has strangely different"

1537 
	`bdev«me
(
rdev
->
bdev
,
b
),

1538 
	`bdev«me
(
ªfdev
->
bdev
,
b2
));

1539  -
EINVAL
;

1541 
ev1
 = 
	`À64_to_˝u
(
sb
->
evíts
);

1542 
ev2
 = 
	`À64_to_˝u
(
ªfsb
->
evíts
);

1544 i‡(
ev1
 > 
ev2
)

1545 
ªt
 = 1;

1547 
ªt
 = 0;

1549 i‡(
mö‹_vîsi⁄
) {

1550 
£˘‹s
 = (
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) >> 9);

1551 
£˘‹s
 -
rdev
->
d©a_off£t
;

1553 
£˘‹s
 = 
rdev
->
sb_°¨t
;

1554 i‡(
£˘‹s
 < 
	`À64_to_˝u
(
sb
->
d©a_size
))

1555  -
EINVAL
;

1556 
rdev
->
£˘‹s
 = 
	`À64_to_˝u
(
sb
->
d©a_size
);

1557  
ªt
;

1558 
	}
}

1560 
	$su≥r_1_vÆid©e
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1562 
mdp_su≥rblock_1
 *
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1563 
__u64
 
ev1
 = 
	`À64_to_˝u
(
sb
->
evíts
);

1565 
rdev
->
øid_disk
 = -1;

1566 
	`˛ór_bô
(
Fau…y
, &
rdev
->
Êags
);

1567 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1568 
	`˛ór_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

1569 
	`˛ór_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

1571 i‡(
mddev
->
øid_disks
 == 0) {

1572 
mddev
->
maj‹_vîsi⁄
 = 1;

1573 
mddev
->
∑tch_vîsi⁄
 = 0;

1574 
mddev
->
exã∫Æ
 = 0;

1575 
mddev
->
chunk_£˘‹s
 = 
	`À32_to_˝u
(
sb
->
chunksize
);

1576 
mddev
->
˘ime
 = 
	`À64_to_˝u
(
sb
->ctime) & ((1ULL << 32)-1);

1577 
mddev
->
utime
 = 
	`À64_to_˝u
(
sb
->utime) & ((1ULL << 32)-1);

1578 
mddev
->
Àvñ
 = 
	`À32_to_˝u
(
sb
->level);

1579 
mddev
->
˛evñ
[0] = 0;

1580 
mddev
->
œyout
 = 
	`À32_to_˝u
(
sb
->layout);

1581 
mddev
->
øid_disks
 = 
	`À32_to_˝u
(
sb
->raid_disks);

1582 
mddev
->
dev_£˘‹s
 = 
	`À64_to_˝u
(
sb
->
size
);

1583 
mddev
->
evíts
 = 
ev1
;

1584 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

1585 
mddev
->
bôm≠_öfo
.
•a˚
 = 0;

1589 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 = 1024 >> 9;

1590 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
 = (4096-1024) >> 9;

1591 
mddev
->
ªsh≠e_backw¨ds
 = 0;

1593 
mddev
->
ªcovîy_˝
 = 
	`À64_to_˝u
(
sb
->
ªsync_off£t
);

1594 
	`mem˝y
(
mddev
->
uuid
, 
sb
->
£t_uuid
, 16);

1596 
mddev
->
max_disks
 = (4096-256)/2;

1598 i‡((
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_BITMAP_OFFSET
) &&

1599 
mddev
->
bôm≠_öfo
.
fûe
 =
NULL
) {

1600 
mddev
->
bôm≠_öfo
.
off£t
 =

1601 (
__s32
)
	`À32_to_˝u
(
sb
->
bôm≠_off£t
);

1607 i‡(
mddev
->
mö‹_vîsi⁄
 > 0)

1608 
mddev
->
bôm≠_öfo
.
•a˚
 = 0;

1609 i‡(
mddev
->
bôm≠_öfo
.
off£t
 > 0)

1610 
mddev
->
bôm≠_öfo
.
•a˚
 =

1611 8 - 
mddev
->
bôm≠_öfo
.
off£t
;

1613 
mddev
->
bôm≠_öfo
.
•a˚
 =

1614 -
mddev
->
bôm≠_öfo
.
off£t
;

1617 i‡((
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_RESHAPE_ACTIVE
)) {

1618 
mddev
->
ªsh≠e_posôi⁄
 = 
	`À64_to_˝u
(
sb
->reshape_position);

1619 
mddev
->
dñè_disks
 = 
	`À32_to_˝u
(
sb
->delta_disks);

1620 
mddev
->
√w_Àvñ
 = 
	`À32_to_˝u
(
sb
->new_level);

1621 
mddev
->
√w_œyout
 = 
	`À32_to_˝u
(
sb
->new_layout);

1622 
mddev
->
√w_chunk_£˘‹s
 = 
	`À32_to_˝u
(
sb
->
√w_chunk
);

1623 i‡(
mddev
->
dñè_disks
 < 0 ||

1624 (
mddev
->
dñè_disks
 == 0 &&

1625 (
	`À32_to_˝u
(
sb
->
„©uª_m≠
)

1626 & 
MD_FEATURE_RESHAPE_BACKWARDS
)))

1627 
mddev
->
ªsh≠e_backw¨ds
 = 1;

1629 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

1630 
mddev
->
dñè_disks
 = 0;

1631 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

1632 
mddev
->
√w_œyout
 = mddev->
œyout
;

1633 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

1636 } i‡(
mddev
->
≥rs
 =
NULL
) {

1639 ++
ev1
;

1640 i‡(
rdev
->
desc_ƒ
 >= 0 &&

1641 
rdev
->
desc_ƒ
 < 
	`À32_to_˝u
(
sb
->
max_dev
) &&

1642 
	`À16_to_˝u
(
sb
->
dev_rﬁes
[
rdev
->
desc_ƒ
]) < 0xfffe)

1643 i‡(
ev1
 < 
mddev
->
evíts
)

1644  -
EINVAL
;

1645 } i‡(
mddev
->
bôm≠
) {

1649 i‡(
ev1
 < 
mddev
->
bôm≠
->
evíts_˛óªd
)

1651 i‡(
ev1
 < 
mddev
->
evíts
)

1652 
	`£t_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

1654 i‡(
ev1
 < 
mddev
->
evíts
)

1658 i‡(
mddev
->
Àvñ
 !
LEVEL_MULTIPATH
) {

1659 
rﬁe
;

1660 i‡(
rdev
->
desc_ƒ
 < 0 ||

1661 
rdev
->
desc_ƒ
 >
	`À32_to_˝u
(
sb
->
max_dev
)) {

1662 
rﬁe
 = 0xffff;

1663 
rdev
->
desc_ƒ
 = -1;

1665 
rﬁe
 = 
	`À16_to_˝u
(
sb
->
dev_rﬁes
[
rdev
->
desc_ƒ
]);

1666 
rﬁe
) {

1670 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1673 
rdev
->
ßved_øid_disk
 = 
rﬁe
;

1674 i‡((
	`À32_to_˝u
(
sb
->
„©uª_m≠
) &

1675 
MD_FEATURE_RECOVERY_OFFSET
)) {

1676 
rdev
->
ªcovîy_off£t
 = 
	`À64_to_˝u
(
sb
->recovery_offset);

1677 i‡(!(
	`À32_to_˝u
(
sb
->
„©uª_m≠
) &

1678 
MD_FEATURE_RECOVERY_BITMAP
))

1679 
rdev
->
ßved_øid_disk
 = -1;

1681 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

1682 
rdev
->
øid_disk
 = 
rﬁe
;

1685 i‡(
sb
->
devÊags
 & 
WrôeMo°ly1
)

1686 
	`£t_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

1687 i‡(
	`À32_to_˝u
(
sb
->
„©uª_m≠
Ë& 
MD_FEATURE_REPLACEMENT
)

1688 
	`£t_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

1690 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

1693 
	}
}

1695 
	$su≥r_1_sync
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1697 
mdp_su≥rblock_1
 *
sb
;

1698 
md_rdev
 *
rdev2
;

1699 
max_dev
, 
i
;

1702 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1704 
sb
->
„©uª_m≠
 = 0;

1705 
sb
->
∑d0
 = 0;

1706 
sb
->
ªcovîy_off£t
 = 
	`˝u_to_À64
(0);

1707 
	`mem£t
(
sb
->
∑d3
, 0, (sb->pad3));

1709 
sb
->
utime
 = 
	`˝u_to_À64
((
__u64
)
mddev
->utime);

1710 
sb
->
evíts
 = 
	`˝u_to_À64
(
mddev
->events);

1711 i‡(
mddev
->
ö_sync
)

1712 
sb
->
ªsync_off£t
 = 
	`˝u_to_À64
(
mddev
->
ªcovîy_˝
);

1714 
sb
->
ªsync_off£t
 = 
	`˝u_to_À64
(0);

1716 
sb
->
˙t_c‹ª˘ed_ªad
 = 
	`˝u_to_À32
(
	`©omic_ªad
(&
rdev
->
c‹ª˘ed_îr‹s
));

1718 
sb
->
øid_disks
 = 
	`˝u_to_À32
(
mddev
->raid_disks);

1719 
sb
->
size
 = 
	`˝u_to_À64
(
mddev
->
dev_£˘‹s
);

1720 
sb
->
chunksize
 = 
	`˝u_to_À32
(
mddev
->
chunk_£˘‹s
);

1721 
sb
->
Àvñ
 = 
	`˝u_to_À32
(
mddev
->level);

1722 
sb
->
œyout
 = 
	`˝u_to_À32
(
mddev
->layout);

1724 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
))

1725 
sb
->
devÊags
 |
WrôeMo°ly1
;

1727 
sb
->
devÊags
 &~
WrôeMo°ly1
;

1728 
sb
->
d©a_off£t
 = 
	`˝u_to_À64
(
rdev
->data_offset);

1729 
sb
->
d©a_size
 = 
	`˝u_to_À64
(
rdev
->
£˘‹s
);

1731 i‡(
mddev
->
bôm≠
 && mddev->
bôm≠_öfo
.
fûe
 =
NULL
) {

1732 
sb
->
bôm≠_off£t
 = 
	`˝u_to_À32
((
__u32
)
mddev
->
bôm≠_öfo
.
off£t
);

1733 
sb
->
„©uª_m≠
 = 
	`˝u_to_À32
(
MD_FEATURE_BITMAP_OFFSET
);

1736 i‡(
rdev
->
øid_disk
 >= 0 &&

1737 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

1738 
sb
->
„©uª_m≠
 |=

1739 
	`˝u_to_À32
(
MD_FEATURE_RECOVERY_OFFSET
);

1740 
sb
->
ªcovîy_off£t
 =

1741 
	`˝u_to_À64
(
rdev
->
ªcovîy_off£t
);

1742 i‡(
rdev
->
ßved_øid_disk
 >0 && 
mddev
->
bôm≠
)

1743 
sb
->
„©uª_m≠
 |=

1744 
	`˝u_to_À32
(
MD_FEATURE_RECOVERY_BITMAP
);

1746 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
))

1747 
sb
->
„©uª_m≠
 |=

1748 
	`˝u_to_À32
(
MD_FEATURE_REPLACEMENT
);

1750 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
) {

1751 
sb
->
„©uª_m≠
 |
	`˝u_to_À32
(
MD_FEATURE_RESHAPE_ACTIVE
);

1752 
sb
->
ªsh≠e_posôi⁄
 = 
	`˝u_to_À64
(
mddev
->reshape_position);

1753 
sb
->
√w_œyout
 = 
	`˝u_to_À32
(
mddev
->new_layout);

1754 
sb
->
dñè_disks
 = 
	`˝u_to_À32
(
mddev
->delta_disks);

1755 
sb
->
√w_Àvñ
 = 
	`˝u_to_À32
(
mddev
->new_level);

1756 
sb
->
√w_chunk
 = 
	`˝u_to_À32
(
mddev
->
√w_chunk_£˘‹s
);

1757 i‡(
mddev
->
dñè_disks
 == 0 &&

1758 
mddev
->
ªsh≠e_backw¨ds
)

1759 
sb
->
„©uª_m≠


1760 |
	`˝u_to_À32
(
MD_FEATURE_RESHAPE_BACKWARDS
);

1761 i‡(
rdev
->
√w_d©a_off£t
 !rdev->
d©a_off£t
) {

1762 
sb
->
„©uª_m≠


1763 |
	`˝u_to_À32
(
MD_FEATURE_NEW_OFFSET
);

1764 
sb
->
√w_off£t
 = 
	`˝u_to_À32
((
__u32
)(
rdev
->
√w_d©a_off£t


1765 - 
rdev
->
d©a_off£t
));

1769 i‡(
rdev
->
badblocks
.
cou¡
 == 0)

1771 i‡(
sb
->
bblog_off£t
 == 0)

1773 
	`md_îr‹
(
mddev
, 
rdev
);

1775 
badblocks
 *
bb
 = &
rdev
->badblocks;

1776 
u64
 *
bbp
 = (u64 *)
	`∑ge_addªss
(
rdev
->
bb_∑ge
);

1777 
u64
 *
p
 = 
bb
->
∑ge
;

1778 
sb
->
„©uª_m≠
 |
	`˝u_to_À32
(
MD_FEATURE_BAD_BLOCKS
);

1779 i‡(
bb
->
ch™ged
) {

1780 
£q
;

1782 
ªåy
:

1783 
£q
 = 
	`ªad_£qbegö
(&
bb
->
lock
);

1785 
	`mem£t
(
bbp
, 0xff, 
PAGE_SIZE
);

1787 
i
 = 0 ; i < 
bb
->
cou¡
 ; i++) {

1788 
u64
 
öã∫Æ_bb
 = 
p
[
i
];

1789 
u64
 
°‹e_bb
 = ((
	`BB_OFFSET
(
öã∫Æ_bb
) << 10)

1790 | 
	`BB_LEN
(
öã∫Æ_bb
));

1791 
bbp
[
i
] = 
	`˝u_to_À64
(
°‹e_bb
);

1793 
bb
->
ch™ged
 = 0;

1794 i‡(
	`ªad_£qªåy
(&
bb
->
lock
, 
£q
))

1795 
ªåy
;

1797 
bb
->
£˘‹
 = (
rdev
->
sb_°¨t
 +

1798 ()
	`À32_to_˝u
(
sb
->
bblog_off£t
));

1799 
bb
->
size
 = 
	`À16_to_˝u
(
sb
->
bblog_size
);

1803 
max_dev
 = 0;

1804 
	`rdev_f‹_óch
(
rdev2
, 
mddev
)

1805 i‡(
rdev2
->
desc_ƒ
+1 > 
max_dev
)

1806 
max_dev
 = 
rdev2
->
desc_ƒ
+1;

1808 i‡(
max_dev
 > 
	`À32_to_˝u
(
sb
->max_dev)) {

1809 
bmask
;

1810 
sb
->
max_dev
 = 
	`˝u_to_À32
(max_dev);

1811 
rdev
->
sb_size
 = 
max_dev
 * 2 + 256;

1812 
bmask
 = 
	`queue_logiˇl_block_size
(
rdev
->
bdev
->
bd_disk
->
queue
)-1;

1813 i‡(
rdev
->
sb_size
 & 
bmask
)

1814 
rdev
->
sb_size
 = (rdev->sb_sizê| 
bmask
) + 1;

1816 
max_dev
 = 
	`À32_to_˝u
(
sb
->max_dev);

1818 
i
=0; i<
max_dev
;i++)

1819 
sb
->
dev_rﬁes
[
i
] = 
	`˝u_to_À16
(0xfffe);

1821 
	`rdev_f‹_óch
(
rdev2
, 
mddev
) {

1822 
i
 = 
rdev2
->
desc_ƒ
;

1823 i‡(
	`ã°_bô
(
Fau…y
, &
rdev2
->
Êags
))

1824 
sb
->
dev_rﬁes
[
i
] = 
	`˝u_to_À16
(0xfffe);

1825 i‡(
	`ã°_bô
(
In_sync
, &
rdev2
->
Êags
))

1826 
sb
->
dev_rﬁes
[
i
] = 
	`˝u_to_À16
(
rdev2
->
øid_disk
);

1827 i‡(
rdev2
->
øid_disk
 >= 0)

1828 
sb
->
dev_rﬁes
[
i
] = 
	`˝u_to_À16
(
rdev2
->
øid_disk
);

1830 
sb
->
dev_rﬁes
[
i
] = 
	`˝u_to_À16
(0xffff);

1833 
sb
->
sb_csum
 = 
	`ˇlc_sb_1_csum
(sb);

1834 
	}
}

1837 
	$su≥r_1_rdev_size_ch™ge
(
md_rdev
 *
rdev
, 
£˘‹_t
 
num_£˘‹s
)

1839 
mdp_su≥rblock_1
 *
sb
;

1840 
£˘‹_t
 
max_£˘‹s
;

1841 i‡(
num_£˘‹s
 &&Çum_£˘‹†< 
rdev
->
mddev
->
dev_£˘‹s
)

1843 i‡(
rdev
->
d©a_off£t
 !rdev->
√w_d©a_off£t
)

1845 i‡(
rdev
->
sb_°¨t
 <Ñdev->
d©a_off£t
) {

1847 
max_£˘‹s
 = 
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) >> 9;

1848 
max_£˘‹s
 -
rdev
->
d©a_off£t
;

1849 i‡(!
num_£˘‹s
 ||Çum_£˘‹†> 
max_£˘‹s
)

1850 
num_£˘‹s
 = 
max_£˘‹s
;

1851 } i‡(
rdev
->
mddev
->
bôm≠_öfo
.
off£t
) {

1856 
£˘‹_t
 
sb_°¨t
;

1857 
sb_°¨t
 = (
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) >> 9) - 8*2;

1858 
sb_°¨t
 &~(
£˘‹_t
)(4*2 - 1);

1859 
max_£˘‹s
 = 
rdev
->
£˘‹s
 + 
sb_°¨t
 -Ñdev->sb_start;

1860 i‡(!
num_£˘‹s
 ||Çum_£˘‹†> 
max_£˘‹s
)

1861 
num_£˘‹s
 = 
max_£˘‹s
;

1862 
rdev
->
sb_°¨t
 = sb_start;

1864 
sb
 = 
	`∑ge_addªss
(
rdev
->
sb_∑ge
);

1865 
sb
->
d©a_size
 = 
	`˝u_to_À64
(
num_£˘‹s
);

1866 
sb
->
su≥r_off£t
 = 
rdev
->
sb_°¨t
;

1867 
sb
->
sb_csum
 = 
	`ˇlc_sb_1_csum
(sb);

1868 
	`md_su≥r_wrôe
(
rdev
->
mddev
,Ñdev,Ñdev->
sb_°¨t
,Ñdev->
sb_size
,

1869 
rdev
->
sb_∑ge
);

1870 
	`md_su≥r_waô
(
rdev
->
mddev
);

1871  
num_£˘‹s
;

1873 
	}
}

1876 
	$su≥r_1_Ælow_√w_off£t
(
md_rdev
 *
rdev
,

1877 
√w_off£t
)

1880 
bôm≠
 *bitmap;

1881 i‡(
√w_off£t
 >
rdev
->
d©a_off£t
)

1886 i‡(
rdev
->
mddev
->
mö‹_vîsi⁄
 == 0)

1895 i‡(
rdev
->
sb_°¨t
 + (32+4)*2 > 
√w_off£t
)

1897 
bôm≠
 = 
rdev
->
mddev
->bitmap;

1898 i‡(
bôm≠
 && !
rdev
->
mddev
->
bôm≠_öfo
.
fûe
 &&

1899 
rdev
->
sb_°¨t
 +Ñdev->
mddev
->
bôm≠_öfo
.
off£t
 +

1900 
bôm≠
->
°‹age
.
fûe_∑ges
 * (
PAGE_SIZE
>>9Ë> 
√w_off£t
)

1902 i‡(
rdev
->
badblocks
.
£˘‹
 +Ñdev->badblocks.
size
 > 
√w_off£t
)

1906 
	}
}

1908 
su≥r_ty≥
 
	gsu≥r_ty≥s
[] = {

1910 .
«me
 = "0.90.0",

1911 .
	gow√r
 = 
THIS_MODULE
,

1912 .
	glﬂd_su≥r
 = 
su≥r_90_lﬂd
,

1913 .
	gvÆid©e_su≥r
 = 
su≥r_90_vÆid©e
,

1914 .
	gsync_su≥r
 = 
su≥r_90_sync
,

1915 .
	grdev_size_ch™ge
 = 
su≥r_90_rdev_size_ch™ge
,

1916 .
	gÆlow_√w_off£t
 = 
su≥r_90_Ælow_√w_off£t
,

1919 .
«me
 = "md-1",

1920 .
	gow√r
 = 
THIS_MODULE
,

1921 .
	glﬂd_su≥r
 = 
su≥r_1_lﬂd
,

1922 .
	gvÆid©e_su≥r
 = 
su≥r_1_vÆid©e
,

1923 .
	gsync_su≥r
 = 
su≥r_1_sync
,

1924 .
	grdev_size_ch™ge
 = 
su≥r_1_rdev_size_ch™ge
,

1925 .
	gÆlow_√w_off£t
 = 
su≥r_1_Ælow_√w_off£t
,

1929 
	$sync_su≥r
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1931 i‡(
mddev
->
sync_su≥r
) {

1932 
mddev
->
	`sync_su≥r
(mddev, 
rdev
);

1936 
	`BUG_ON
(
mddev
->
maj‹_vîsi⁄
 >
	`ARRAY_SIZE
(
su≥r_ty≥s
));

1938 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].
	`sync_su≥r
(mddev, 
rdev
);

1939 
	}
}

1941 
	$m©ch_mddev_unôs
(
mddev
 *
mddev1
, mddev *
mddev2
)

1943 
md_rdev
 *
rdev
, *
rdev2
;

1945 
	`rcu_ªad_lock
();

1946 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev1
)

1947 
	`rdev_f‹_óch_rcu
(
rdev2
, 
mddev2
)

1948 i‡(
rdev
->
bdev
->
bd_c⁄èös
 ==

1949 
rdev2
->
bdev
->
bd_c⁄èös
) {

1950 
	`rcu_ªad_u∆ock
();

1953 
	`rcu_ªad_u∆ock
();

1955 
	}
}

1957 
LIST_HEAD
(
≥ndög_øid_disks
);

1966 
	$md_öãgrôy_ªgi°î
(
mddev
 *mddev)

1968 
md_rdev
 *
rdev
, *
ª„ªn˚
 = 
NULL
;

1970 i‡(
	`li°_em±y
(&
mddev
->
disks
))

1972 i‡(!
mddev
->
gídisk
 || 
	`blk_gë_öãgrôy
(mddev->gendisk))

1974 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

1976 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

1978 i‡(
rdev
->
øid_disk
 < 0)

1980 i‡(!
ª„ªn˚
) {

1982 
ª„ªn˚
 = 
rdev
;

1986 i‡(
	`blk_öãgrôy_com∑ª
(
ª„ªn˚
->
bdev
->
bd_disk
,

1987 
rdev
->
bdev
->
bd_disk
) < 0)

1988  -
EINVAL
;

1990 i‡(!
ª„ªn˚
 || !
	`bdev_gë_öãgrôy
‘e„ªn˚->
bdev
))

1996 i‡(
	`blk_öãgrôy_ªgi°î
(
mddev
->
gídisk
,

1997 
	`bdev_gë_öãgrôy
(
ª„ªn˚
->
bdev
)) != 0) {

1998 
	`¥ötk
(
KERN_ERR
 "md: failedÅoÑegister integrity for %s\n",

1999 
	`md«me
(
mddev
));

2000  -
EINVAL
;

2002 
	`¥ötk
(
KERN_NOTICE
 "md: d©®öãgrôyÉ«bÀd o¿%s\n", 
	`md«me
(
mddev
));

2003 i‡(
	`bio£t_öãgrôy_¸óã
(
mddev
->
bio_£t
, 
BIO_POOL_SIZE
)) {

2004 
	`¥ötk
(
KERN_ERR
 "md: failedÅo create integrityÖool for %s\n",

2005 
	`md«me
(
mddev
));

2006  -
EINVAL
;

2009 
	}
}

2010 
EXPORT_SYMBOL
(
md_öãgrôy_ªgi°î
);

2013 
	$md_öãgrôy_add_rdev
(
md_rdev
 *
rdev
, 
mddev
 *mddev)

2015 
blk_öãgrôy
 *
bi_rdev
;

2016 
blk_öãgrôy
 *
bi_mddev
;

2018 i‡(!
mddev
->
gídisk
)

2021 
bi_rdev
 = 
	`bdev_gë_öãgrôy
(
rdev
->
bdev
);

2022 
bi_mddev
 = 
	`blk_gë_öãgrôy
(
mddev
->
gídisk
);

2024 i‡(!
bi_mddev
)

2026 i‡(
rdev
->
øid_disk
 < 0)

2028 i‡(
bi_rdev
 && 
	`blk_öãgrôy_com∑ª
(
mddev
->
gídisk
,

2029 
rdev
->
bdev
->
bd_disk
) >= 0)

2031 
	`¥ötk
(
KERN_NOTICE
 "dißblög d©®öãgrôy o¿%s\n", 
	`md«me
(
mddev
));

2032 
	`blk_öãgrôy_uƒegi°î
(
mddev
->
gídisk
);

2033 
	}
}

2034 
EXPORT_SYMBOL
(
md_öãgrôy_add_rdev
);

2036 
	$böd_rdev_to_¨øy
(
md_rdev
 * 
rdev
, 
mddev
 * mddev)

2038 
b
[
BDEVNAME_SIZE
];

2039 
kobje˘
 *
ko
;

2040 *
s
;

2041 
îr
;

2043 i‡(
rdev
->
mddev
) {

2044 
	`MD_BUG
();

2045  -
EINVAL
;

2049 i‡(
	`föd_rdev
(
mddev
, 
rdev
->
bdev
->
bd_dev
))

2050  -
EEXIST
;

2053 i‡(
rdev
->
£˘‹s
 && (
mddev
->
dev_£˘‹s
 == 0 ||

2054 
rdev
->
£˘‹s
 < 
mddev
->
dev_£˘‹s
)) {

2055 i‡(
mddev
->
≥rs
) {

2060 i‡(
mddev
->
Àvñ
 > 0)

2061  -
ENOSPC
;

2063 
mddev
->
dev_£˘‹s
 = 
rdev
->
£˘‹s
;

2070 i‡(
rdev
->
desc_ƒ
 < 0) {

2071 
choi˚
 = 0;

2072 i‡(
mddev
->
≥rs
Ë
choi˚
 = mddev->
øid_disks
;

2073 
	`föd_rdev_ƒ
(
mddev
, 
choi˚
))

2074 
choi˚
++;

2075 
rdev
->
desc_ƒ
 = 
choi˚
;

2077 i‡(
	`föd_rdev_ƒ
(
mddev
, 
rdev
->
desc_ƒ
))

2078  -
EBUSY
;

2080 i‡(
mddev
->
max_disks
 && 
rdev
->
desc_ƒ
 >= mddev->max_disks) {

2081 
	`¥ötk
(
KERN_WARNING
 "md: %s:árray isÜimitedÅo %d devices\n",

2082 
	`md«me
(
mddev
), mddev->
max_disks
);

2083  -
EBUSY
;

2085 
	`bdev«me
(
rdev
->
bdev
,
b
);

2086  (
s
=
	`°rchr
(
b
, '/')Ë!
NULL
)

2087 *
s
 = '!';

2089 
rdev
->
mddev
 = mddev;

2090 
	`¥ötk
(
KERN_INFO
 "md: böd<%s>\n", 
b
);

2092 i‡((
îr
 = 
	`kobje˘_add
(&
rdev
->
kobj
, &
mddev
->kobj, "dev-%s", 
b
)))

2093 
Áû
;

2095 
ko
 = &
	`∑π_to_dev
(
rdev
->
bdev
->
bd_∑π
)->
kobj
;

2096 i‡(
	`sysfs_¸óã_lök
(&
rdev
->
kobj
, 
ko
, "block"))

2098 
rdev
->
sysfs_°©e
 = 
	`sysfs_gë_dúít_ß„
‘dev->
kobj
.
sd
, "state");

2100 
	`li°_add_rcu
(&
rdev
->
ßme_£t
, &
mddev
->
disks
);

2101 
	`bd_lök_disk_hﬁdî
(
rdev
->
bdev
, 
mddev
->
gídisk
);

2104 
mddev
->
ªcovîy_dißbÀd
++;

2108 
Áû
:

2109 
	`¥ötk
(
KERN_WARNING
 "md: failedÅoÑegister dev-%s for %s\n",

2110 
b
, 
	`md«me
(
mddev
));

2111  
îr
;

2112 
	}
}

2114 
	$md_dñayed_dñëe
(
w‹k_°ru˘
 *
ws
)

2116 
md_rdev
 *
rdev
 = 
	`c⁄èöî_of
(
ws
, md_rdev, 
dñ_w‹k
);

2117 
	`kobje˘_dñ
(&
rdev
->
kobj
);

2118 
	`kobje˘_put
(&
rdev
->
kobj
);

2119 
	}
}

2121 
	$unböd_rdev_‰om_¨øy
(
md_rdev
 * 
rdev
)

2123 
b
[
BDEVNAME_SIZE
];

2124 i‡(!
rdev
->
mddev
) {

2125 
	`MD_BUG
();

2128 
	`bd_u∆ök_disk_hﬁdî
(
rdev
->
bdev
,Ñdev->
mddev
->
gídisk
);

2129 
	`li°_dñ_rcu
(&
rdev
->
ßme_£t
);

2130 
	`¥ötk
(
KERN_INFO
 "md: unböd<%s>\n", 
	`bdev«me
(
rdev
->
bdev
,
b
));

2131 
rdev
->
mddev
 = 
NULL
;

2132 
	`sysfs_ªmove_lök
(&
rdev
->
kobj
, "block");

2133 
	`sysfs_put
(
rdev
->
sysfs_°©e
);

2134 
rdev
->
sysfs_°©e
 = 
NULL
;

2135 
rdev
->
badblocks
.
cou¡
 = 0;

2140 
	`synchr⁄ize_rcu
();

2141 
	`INIT_WORK
(&
rdev
->
dñ_w‹k
, 
md_dñayed_dñëe
);

2142 
	`kobje˘_gë
(&
rdev
->
kobj
);

2143 
	`queue_w‹k
(
md_misc_wq
, &
rdev
->
dñ_w‹k
);

2144 
	}
}

2151 
	$lock_rdev
(
md_rdev
 *
rdev
, 
dev_t
 
dev
, 
sh¨ed
)

2153 
îr
 = 0;

2154 
block_devi˚
 *
bdev
;

2155 
b
[
BDEVNAME_SIZE
];

2157 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
,

2158 
sh¨ed
 ? (
md_rdev
 *)
lock_rdev
 : 
rdev
);

2159 i‡(
	`IS_ERR
(
bdev
)) {

2160 
	`¥ötk
(
KERN_ERR
 "md: couldÇot open %s.\n",

2161 
	`__bdev«me
(
dev
, 
b
));

2162  
	`PTR_ERR
(
bdev
);

2164 
rdev
->
bdev
 = bdev;

2165  
îr
;

2166 
	}
}

2168 
	$u∆ock_rdev
(
md_rdev
 *
rdev
)

2170 
block_devi˚
 *
bdev
 = 
rdev
->bdev;

2171 
rdev
->
bdev
 = 
NULL
;

2172 i‡(!
bdev
)

2173 
	`MD_BUG
();

2174 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

2175 
	}
}

2177 
md_autodëe˘_dev
(
dev_t
 
dev
);

2179 
	$exp‹t_rdev
(
md_rdev
 * 
rdev
)

2181 
b
[
BDEVNAME_SIZE
];

2182 
	`¥ötk
(
KERN_INFO
 "md:Éxport_rdev(%s)\n",

2183 
	`bdev«me
(
rdev
->
bdev
,
b
));

2184 i‡(
rdev
->
mddev
)

2185 
	`MD_BUG
();

2186 
	`md_rdev_˛ór
(
rdev
);

2187 #i‚de‡
MODULE


2188 i‡(
	`ã°_bô
(
AutoDëe˘ed
, &
rdev
->
Êags
))

2189 
	`md_autodëe˘_dev
(
rdev
->
bdev
->
bd_dev
);

2191 
	`u∆ock_rdev
(
rdev
);

2192 
	`kobje˘_put
(&
rdev
->
kobj
);

2193 
	}
}

2195 
	$kick_rdev_‰om_¨øy
(
md_rdev
 * 
rdev
)

2197 
	`unböd_rdev_‰om_¨øy
(
rdev
);

2198 
	`exp‹t_rdev
(
rdev
);

2199 
	}
}

2201 
	$exp‹t_¨øy
(
mddev
 *mddev)

2203 
md_rdev
 *
rdev
, *
tmp
;

2205 
	`rdev_f‹_óch_ß„
(
rdev
, 
tmp
, 
mddev
) {

2206 i‡(!
rdev
->
mddev
) {

2207 
	`MD_BUG
();

2210 
	`kick_rdev_‰om_¨øy
(
rdev
);

2212 i‡(!
	`li°_em±y
(&
mddev
->
disks
))

2213 
	`MD_BUG
();

2214 
mddev
->
øid_disks
 = 0;

2215 
mddev
->
maj‹_vîsi⁄
 = 0;

2216 
	}
}

2218 
	$¥öt_desc
(
mdp_disk_t
 *
desc
)

2220 
	`¥ötk
(" DISK<N:%d,(%d,%d),R:%d,S:%d>\n", 
desc
->
numbî
,

2221 
desc
->
maj‹
,desc->
mö‹
,desc->
øid_disk
,desc->
°©e
);

2222 
	}
}

2224 
	$¥öt_sb_90
(
mdp_su≥r_t
 *
sb
)

2226 
i
;

2228 
	`¥ötk
(
KERN_INFO


2230 
sb
->
maj‹_vîsi⁄
, sb->
mö‹_vîsi⁄
, sb->
∑tch_vîsi⁄
,

2231 
sb
->
£t_uuid0
, sb->
£t_uuid1
, sb->
£t_uuid2
, sb->
£t_uuid3
,

2232 
sb
->
˘ime
);

2233 
	`¥ötk
(
KERN_INFO
 "md: L%d S%08d ND:%d RD:%d md%d LO:%d CS:%d\n",

2234 
sb
->
Àvñ
, sb->
size
, sb->
ƒ_disks
, sb->
øid_disks
,

2235 
sb
->
md_mö‹
, sb->
œyout
, sb->
chunk_size
);

2236 
	`¥ötk
(
KERN_INFO
 "md: UT:%08x ST:%d AD:%d WD:%d"

2238 
sb
->
utime
, sb->
°©e
, sb->
a˘ive_disks
, sb->
w‹kög_disks
,

2239 
sb
->
Áûed_disks
, sb->
•¨e_disks
,

2240 
sb
->
sb_csum
, ()sb->
evíts_lo
);

2242 
	`¥ötk
(
KERN_INFO
);

2243 
i
 = 0; i < 
MD_SB_DISKS
; i++) {

2244 
mdp_disk_t
 *
desc
;

2246 
desc
 = 
sb
->
disks
 + 
i
;

2247 i‡(
desc
->
numbî
 || desc->
maj‹
 || desc->
mö‹
 ||

2248 
desc
->
øid_disk
 || (desc->
°©e
 && (desc->state != 4))) {

2249 
	`¥ötk
(" D %2d: ", 
i
);

2250 
	`¥öt_desc
(
desc
);

2253 
	`¥ötk
(
KERN_INFO
 "md: THIS: ");

2254 
	`¥öt_desc
(&
sb
->
this_disk
);

2255 
	}
}

2257 
	$¥öt_sb_1
(
mdp_su≥rblock_1
 *
sb
)

2259 
__u8
 *
uuid
;

2261 
uuid
 = 
sb
->
£t_uuid
;

2262 
	`¥ötk
(
KERN_INFO


2265 
	`À32_to_˝u
(
sb
->
maj‹_vîsi⁄
),

2266 
	`À32_to_˝u
(
sb
->
„©uª_m≠
),

2267 
uuid
,

2268 
sb
->
£t_«me
,

2269 ()
	`À64_to_˝u
(
sb
->
˘ime
)

2270 & 
MD_SUPERBLOCK_1_TIME_SEC_MASK
);

2272 
uuid
 = 
sb
->
devi˚_uuid
;

2273 
	`¥ötk
(
KERN_INFO


2279 
	`À32_to_˝u
(
sb
->
Àvñ
),

2280 ()
	`À64_to_˝u
(
sb
->
size
),

2281 
	`À32_to_˝u
(
sb
->
øid_disks
),

2282 
	`À32_to_˝u
(
sb
->
œyout
),

2283 
	`À32_to_˝u
(
sb
->
chunksize
),

2284 ()
	`À64_to_˝u
(
sb
->
d©a_off£t
),

2285 ()
	`À64_to_˝u
(
sb
->
d©a_size
),

2286 ()
	`À64_to_˝u
(
sb
->
su≥r_off£t
),

2287 ()
	`À64_to_˝u
(
sb
->
ªcovîy_off£t
),

2288 
	`À32_to_˝u
(
sb
->
dev_numbî
),

2289 
uuid
,

2290 
sb
->
devÊags
,

2291 ()
	`À64_to_˝u
(
sb
->
utime
Ë& 
MD_SUPERBLOCK_1_TIME_SEC_MASK
,

2292 ()
	`À64_to_˝u
(
sb
->
evíts
),

2293 ()
	`À64_to_˝u
(
sb
->
ªsync_off£t
),

2294 
	`À32_to_˝u
(
sb
->
sb_csum
),

2295 
	`À32_to_˝u
(
sb
->
max_dev
)

2297 
	}
}

2299 
	$¥öt_rdev
(
md_rdev
 *
rdev
, 
maj‹_vîsi⁄
)

2301 
b
[
BDEVNAME_SIZE
];

2302 
	`¥ötk
(
KERN_INFO
 "md:Ñdev %s, Sect:%08llu F:%d S:%d DN:%u\n",

2303 
	`bdev«me
(
rdev
->
bdev
, 
b
), (Ïdev->
£˘‹s
,

2304 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
),Åe°_bô(
In_sync
, &rdev->flags),

2305 
rdev
->
desc_ƒ
);

2306 i‡(
rdev
->
sb_lﬂded
) {

2307 
	`¥ötk
(
KERN_INFO
 "md:Ñdev su≥rblock (MJ:%d):\n", 
maj‹_vîsi⁄
);

2308 
maj‹_vîsi⁄
) {

2310 
	`¥öt_sb_90
(
	`∑ge_addªss
(
rdev
->
sb_∑ge
));

2313 
	`¥öt_sb_1
(
	`∑ge_addªss
(
rdev
->
sb_∑ge
));

2317 
	`¥ötk
(
KERN_INFO
 "md:ÇoÑdev superblock!\n");

2318 
	}
}

2320 
	$md_¥öt_devi˚s
()

2322 
li°_hód
 *
tmp
;

2323 
md_rdev
 *
rdev
;

2324 
mddev
 *mddev;

2325 
b
[
BDEVNAME_SIZE
];

2327 
	`¥ötk
("\n");

2328 
	`¥ötk
("md: **********************************\n");

2329 
	`¥ötk
("md: * <COMPLETE RAID STATE PRINTOUT> *\n");

2330 
	`¥ötk
("md: **********************************\n");

2331 
	`f‹_óch_mddev
(
mddev
, 
tmp
) {

2333 i‡(
mddev
->
bôm≠
)

2334 
	`bôm≠_¥öt_sb
(
mddev
->
bôm≠
);

2336 
	`¥ötk
("%s: ", 
	`md«me
(
mddev
));

2337 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

2338 
	`¥ötk
("<%s>", 
	`bdev«me
(
rdev
->
bdev
,
b
));

2339 
	`¥ötk
("\n");

2341 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

2342 
	`¥öt_rdev
(
rdev
, 
mddev
->
maj‹_vîsi⁄
);

2344 
	`¥ötk
("md: **********************************\n");

2345 
	`¥ötk
("\n");

2346 
	}
}

2349 
	$sync_sbs
(
mddev
 * mddev, 
no•¨es
)

2357 
md_rdev
 *
rdev
;

2358 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2359 i‡(
rdev
->
sb_evíts
 =
mddev
->
evíts
 ||

2360 (
no•¨es
 &&

2361 
rdev
->
øid_disk
 < 0 &&

2362 
rdev
->
sb_evíts
+1 =
mddev
->
evíts
)) {

2364 
rdev
->
sb_lﬂded
 = 2;

2366 
	`sync_su≥r
(
mddev
, 
rdev
);

2367 
rdev
->
sb_lﬂded
 = 1;

2370 
	}
}

2372 
	$md_upd©e_sb
(
mddev
 * mddev, 
f‹˚_ch™ge
)

2374 
md_rdev
 *
rdev
;

2375 
sync_ªq
;

2376 
no•¨es
 = 0;

2377 
™y_badblocks_ch™ged
 = 0;

2379 i‡(
mddev
->
ro
) {

2380 i‡(
f‹˚_ch™ge
)

2381 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

2384 
ª≥©
:

2386 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2387 i‡(
rdev
->
øid_disk
 >= 0 &&

2388 
mddev
->
dñè_disks
 >= 0 &&

2389 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

2390 
mddev
->
cuº_ªsync_com∂ëed
 > 
rdev
->
ªcovîy_off£t
)

2391 
rdev
->
ªcovîy_off£t
 = 
mddev
->
cuº_ªsync_com∂ëed
;

2394 i‡(!
mddev
->
≥rsi°ít
) {

2395 
	`˛ór_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

2396 
	`˛ór_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

2397 i‡(!
mddev
->
exã∫Æ
) {

2398 
	`˛ór_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

2399 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2400 i‡(
rdev
->
badblocks
.
ch™ged
) {

2401 
rdev
->
badblocks
.
ch™ged
 = 0;

2402 
	`md_ack_Æl_badblocks
(&
rdev
->
badblocks
);

2403 
	`md_îr‹
(
mddev
, 
rdev
);

2405 
	`˛ór_bô
(
Blocked
, &
rdev
->
Êags
);

2406 
	`˛ór_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

2407 
	`wake_up
(&
rdev
->
blocked_waô
);

2410 
	`wake_up
(&
mddev
->
sb_waô
);

2414 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

2416 
mddev
->
utime
 = 
	`gë_£c⁄ds
();

2418 i‡(
	`ã°_™d_˛ór_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
))

2419 
f‹˚_ch™ge
 = 1;

2420 i‡(
	`ã°_™d_˛ór_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
))

2425 
no•¨es
 = 1;

2426 i‡(
f‹˚_ch™ge
)

2427 
no•¨es
 = 0;

2428 i‡(
mddev
->
degøded
)

2438 
no•¨es
 = 0;

2440 
sync_ªq
 = 
mddev
->
ö_sync
;

2444 i‡(
no•¨es


2445 && (
mddev
->
ö_sync
 && mddev->
ªcovîy_˝
 =
MaxSe˘‹
)

2446 && 
mddev
->
ˇn_de¸ó£_evíts


2447 && 
mddev
->
evíts
 != 1) {

2448 
mddev
->
evíts
--;

2449 
mddev
->
ˇn_de¸ó£_evíts
 = 0;

2452 
mddev
->
evíts
 ++;

2453 
mddev
->
ˇn_de¸ó£_evíts
 = 
no•¨es
;

2456 i‡(!
mddev
->
evíts
) {

2462 
	`MD_BUG
();

2463 
mddev
->
evíts
 --;

2466 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2467 i‡(
rdev
->
badblocks
.
ch™ged
)

2468 
™y_badblocks_ch™ged
++;

2469 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

2470 
	`£t_bô
(
Fau…Rec‹ded
, &
rdev
->
Êags
);

2473 
	`sync_sbs
(
mddev
, 
no•¨es
);

2474 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

2476 
	`¥_debug
("md: updating %s RAID superblock on device (in sync %d)\n",

2477 
	`md«me
(
mddev
), mddev->
ö_sync
);

2479 
	`bôm≠_upd©e_sb
(
mddev
->
bôm≠
);

2480 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2481 
b
[
BDEVNAME_SIZE
];

2483 i‡(
rdev
->
sb_lﬂded
 != 1)

2486 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

2487 
	`md_su≥r_wrôe
(
mddev
,
rdev
,

2488 
rdev
->
sb_°¨t
,Ñdev->
sb_size
,

2489 
rdev
->
sb_∑ge
);

2490 
	`¥_debug
("md: (write) %s's sb offset: %llu\n",

2491 
	`bdev«me
(
rdev
->
bdev
, 
b
),

2492 ()
rdev
->
sb_°¨t
);

2493 
rdev
->
sb_evíts
 = 
mddev
->
evíts
;

2494 i‡(
rdev
->
badblocks
.
size
) {

2495 
	`md_su≥r_wrôe
(
mddev
, 
rdev
,

2496 
rdev
->
badblocks
.
£˘‹
,

2497 
rdev
->
badblocks
.
size
 << 9,

2498 
rdev
->
bb_∑ge
);

2499 
rdev
->
badblocks
.
size
 = 0;

2503 
	`¥_debug
("md: %s (skipping faulty)\n",

2504 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2506 i‡(
mddev
->
Àvñ
 =
LEVEL_MULTIPATH
)

2510 
	`md_su≥r_waô
(
mddev
);

2513 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

2514 i‡(
mddev
->
ö_sync
 !
sync_ªq
 ||

2515 
	`ã°_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
)) {

2517 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

2518 
ª≥©
;

2520 
	`˛ór_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

2521 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

2522 
	`wake_up
(&
mddev
->
sb_waô
);

2523 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

2524 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

2526 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2527 i‡(
	`ã°_™d_˛ór_bô
(
Fau…Rec‹ded
, &
rdev
->
Êags
))

2528 
	`˛ór_bô
(
Blocked
, &
rdev
->
Êags
);

2530 i‡(
™y_badblocks_ch™ged
)

2531 
	`md_ack_Æl_badblocks
(&
rdev
->
badblocks
);

2532 
	`˛ór_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

2533 
	`wake_up
(&
rdev
->
blocked_waô
);

2535 
	}
}

2540 
	$cmd_m©ch
(c⁄° *
cmd
, c⁄° *
°r
)

2546 *
cmd
 && *
°r
 && *cmd == *str) {

2547 
cmd
++;

2548 
°r
++;

2550 i‡(*
cmd
 == '\n')

2551 
cmd
++;

2552 i‡(*
°r
 || *
cmd
)

2555 
	}
}

2557 
	srdev_sysfs_íåy
 {

2558 
©åibuã
 
	m©å
;

2559 
ssize_t
 (*
show
)(
	mmd_rdev
 *, *);

2560 
ssize_t
 (*
°‹e
)(
	mmd_rdev
 *, c⁄° *, 
	msize_t
);

2563 
ssize_t


2564 
	$°©e_show
(
md_rdev
 *
rdev
, *
∑ge
)

2566 *
£p
 = "";

2567 
size_t
 
Àn
 = 0;

2569 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) ||

2570 
rdev
->
badblocks
.
u«cked_exi°
) {

2571 
Àn
+
	`•rötf
(
∑ge
+Àn, "%sÁu…y",
£p
);

2572 
£p
 = ",";

2574 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

2575 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%sö_sync",
£p
);

2576 
£p
 = ",";

2578 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
)) {

2579 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%swrôe_mo°ly",
£p
);

2580 
£p
 = ",";

2582 i‡(
	`ã°_bô
(
Blocked
, &
rdev
->
Êags
) ||

2583 (
rdev
->
badblocks
.
u«cked_exi°


2584 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))) {

2585 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%sblocked", 
£p
);

2586 
£p
 = ",";

2588 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

2589 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

2590 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%s•¨e", 
£p
);

2591 
£p
 = ",";

2593 i‡(
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
)) {

2594 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%swrôe_îr‹", 
£p
);

2595 
£p
 = ",";

2597 i‡(
	`ã°_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
)) {

2598 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%sw™t_ª∂a˚mít", 
£p
);

2599 
£p
 = ",";

2601 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
)) {

2602 
Àn
 +
	`•rötf
(
∑ge
+Àn, "%§ïœ˚mít", 
£p
);

2603 
£p
 = ",";

2606  
Àn
+
	`•rötf
(
∑ge
+len, "\n");

2607 
	}
}

2609 
ssize_t


2610 
	$°©e_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

2625 
îr
 = -
EINVAL
;

2626 i‡(
	`cmd_m©ch
(
buf
, "Áu…y"Ë&& 
rdev
->
mddev
->
≥rs
) {

2627 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

2628 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

2629 
îr
 = 0;

2631 
îr
 = -
EBUSY
;

2632 } i‡(
	`cmd_m©ch
(
buf
, "remove")) {

2633 i‡(
rdev
->
øid_disk
 >= 0)

2634 
îr
 = -
EBUSY
;

2636 
mddev
 *mddev = 
rdev
->mddev;

2637 
	`kick_rdev_‰om_¨øy
(
rdev
);

2638 i‡(
mddev
->
≥rs
)

2639 
	`md_upd©e_sb
(
mddev
, 1);

2640 
	`md_√w_evít
(
mddev
);

2641 
îr
 = 0;

2643 } i‡(
	`cmd_m©ch
(
buf
, "writemostly")) {

2644 
	`£t_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

2645 
îr
 = 0;

2646 } i‡(
	`cmd_m©ch
(
buf
, "-writemostly")) {

2647 
	`˛ór_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

2648 
îr
 = 0;

2649 } i‡(
	`cmd_m©ch
(
buf
, "blocked")) {

2650 
	`£t_bô
(
Blocked
, &
rdev
->
Êags
);

2651 
îr
 = 0;

2652 } i‡(
	`cmd_m©ch
(
buf
, "-blocked")) {

2653 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

2654 
rdev
->
badblocks
.
u«cked_exi°
) {

2658 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

2660 
	`˛ór_bô
(
Blocked
, &
rdev
->
Êags
);

2661 
	`˛ór_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

2662 
	`wake_up
(&
rdev
->
blocked_waô
);

2663 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
rdev
->
mddev
->
ªcovîy
);

2664 
	`md_wakeup_thªad
(
rdev
->
mddev
->
thªad
);

2666 
îr
 = 0;

2667 } i‡(
	`cmd_m©ch
(
buf
, "ösync"Ë&& 
rdev
->
øid_disk
 == -1) {

2668 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

2669 
îr
 = 0;

2670 } i‡(
	`cmd_m©ch
(
buf
, "-ösync"Ë&& 
rdev
->
øid_disk
 >= 0) {

2671 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

2672 
rdev
->
ßved_øid_disk
 =Ñdev->
øid_disk
;

2673 
rdev
->
øid_disk
 = -1;

2674 
îr
 = 0;

2675 } i‡(
	`cmd_m©ch
(
buf
, "write_error")) {

2676 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2677 
îr
 = 0;

2678 } i‡(
	`cmd_m©ch
(
buf
, "-write_error")) {

2679 
	`˛ór_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2680 
îr
 = 0;

2681 } i‡(
	`cmd_m©ch
(
buf
, "want_replacement")) {

2686 i‡(
rdev
->
øid_disk
 >= 0 &&

2687 !
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
))

2688 
	`£t_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

2689 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
rdev
->
mddev
->
ªcovîy
);

2690 
	`md_wakeup_thªad
(
rdev
->
mddev
->
thªad
);

2691 
îr
 = 0;

2692 } i‡(
	`cmd_m©ch
(
buf
, "-want_replacement")) {

2696 
îr
 = 0;

2697 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

2698 } i‡(
	`cmd_m©ch
(
buf
, "replacement")) {

2703 i‡(
rdev
->
mddev
->
≥rs
)

2704 
îr
 = -
EBUSY
;

2706 
	`£t_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

2707 
îr
 = 0;

2709 } i‡(
	`cmd_m©ch
(
buf
, "-replacement")) {

2711 i‡(
rdev
->
mddev
->
≥rs
)

2712 
îr
 = -
EBUSY
;

2714 
	`˛ór_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

2715 
îr
 = 0;

2718 i‡(!
îr
)

2719 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

2720  
îr
 ?Éº : 
Àn
;

2721 
	}
}

2722 
rdev_sysfs_íåy
 
	grdev_°©e
 =

2723 
__ATTR
(
°©e
, 
S_IRUGO
|
S_IWUSR
, 
°©e_show
, 
°©e_°‹e
);

2725 
ssize_t


2726 
	$îr‹s_show
(
md_rdev
 *
rdev
, *
∑ge
)

2728  
	`•rötf
(
∑ge
, "%d\n", 
	`©omic_ªad
(&
rdev
->
c‹ª˘ed_îr‹s
));

2729 
	}
}

2731 
ssize_t


2732 
	$îr‹s_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

2734 *
e
;

2735 
n
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

2736 i‡(*
buf
 && (*
e
 == 0 || *e == '\n')) {

2737 
	`©omic_£t
(&
rdev
->
c‹ª˘ed_îr‹s
, 
n
);

2738  
Àn
;

2740  -
EINVAL
;

2741 
	}
}

2742 
rdev_sysfs_íåy
 
	grdev_îr‹s
 =

2743 
__ATTR
(
îr‹s
, 
S_IRUGO
|
S_IWUSR
, 
îr‹s_show
, 
îr‹s_°‹e
);

2745 
ssize_t


2746 
	$¶Ÿ_show
(
md_rdev
 *
rdev
, *
∑ge
)

2748 i‡(
rdev
->
øid_disk
 < 0)

2749  
	`•rötf
(
∑ge
, "none\n");

2751  
	`•rötf
(
∑ge
, "%d\n", 
rdev
->
øid_disk
);

2752 
	}
}

2754 
ssize_t


2755 
	$¶Ÿ_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

2757 *
e
;

2758 
îr
;

2759 
¶Ÿ
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

2760 i‡(
	`°∫cmp
(
buf
, "none", 4)==0)

2761 
¶Ÿ
 = -1;

2762 i‡(
e
==
buf
 || (*e && *e!= '\n'))

2763  -
EINVAL
;

2764 i‡(
rdev
->
mddev
->
≥rs
 && 
¶Ÿ
 == -1) {

2772 i‡(
rdev
->
øid_disk
 == -1)

2773  -
EEXIST
;

2775 i‡(
rdev
->
mddev
->
≥rs
->
hŸ_ªmove_disk
 =
NULL
)

2776  -
EINVAL
;

2777 
	`˛ór_bô
(
Blocked
, &
rdev
->
Êags
);

2778 
	`ªmove_™d_add_•¨es
(
rdev
->
mddev
,Ñdev);

2779 i‡(
rdev
->
øid_disk
 >= 0)

2780  -
EBUSY
;

2781 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
rdev
->
mddev
->
ªcovîy
);

2782 
	`md_wakeup_thªad
(
rdev
->
mddev
->
thªad
);

2783 } i‡(
rdev
->
mddev
->
≥rs
) {

2788 i‡(
rdev
->
øid_disk
 != -1)

2789  -
EBUSY
;

2791 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
rdev
->
mddev
->
ªcovîy
))

2792  -
EBUSY
;

2794 i‡(
rdev
->
mddev
->
≥rs
->
hŸ_add_disk
 =
NULL
)

2795  -
EINVAL
;

2797 i‡(
¶Ÿ
 >
rdev
->
mddev
->
øid_disks
 &&

2798 
¶Ÿ
 >
rdev
->
mddev
->
øid_disks
 +Ñdev->mddev->
dñè_disks
)

2799  -
ENOSPC
;

2801 
rdev
->
øid_disk
 = 
¶Ÿ
;

2802 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

2803 
rdev
->
ßved_øid_disk
 = 
¶Ÿ
;

2805 
rdev
->
ßved_øid_disk
 = -1;

2806 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

2807 
	`˛ór_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

2808 
îr
 = 
rdev
->
mddev
->
≥rs
->

2809 
	`hŸ_add_disk
(
rdev
->
mddev
,Ñdev);

2810 i‡(
îr
) {

2811 
rdev
->
øid_disk
 = -1;

2812  
îr
;

2814 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

2815 i‡(
	`sysfs_lök_rdev
(
rdev
->
mddev
,Ñdev))

2819 i‡(
¶Ÿ
 >
rdev
->
mddev
->
øid_disks
 &&

2820 
¶Ÿ
 >
rdev
->
mddev
->
øid_disks
 +Ñdev->mddev->
dñè_disks
)

2821  -
ENOSPC
;

2822 
rdev
->
øid_disk
 = 
¶Ÿ
;

2824 
	`˛ór_bô
(
Fau…y
, &
rdev
->
Êags
);

2825 
	`˛ór_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

2826 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

2827 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

2829  
Àn
;

2830 
	}
}

2833 
rdev_sysfs_íåy
 
	grdev_¶Ÿ
 =

2834 
__ATTR
(
¶Ÿ
, 
S_IRUGO
|
S_IWUSR
, 
¶Ÿ_show
, 
¶Ÿ_°‹e
);

2836 
ssize_t


2837 
	$off£t_show
(
md_rdev
 *
rdev
, *
∑ge
)

2839  
	`•rötf
(
∑ge
, "%Œu\n", ()
rdev
->
d©a_off£t
);

2840 
	}
}

2842 
ssize_t


2843 
	$off£t_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

2845 
off£t
;

2846 i‡(
	`k°πouŒ
(
buf
, 10, &
off£t
) < 0)

2847  -
EINVAL
;

2848 i‡(
rdev
->
mddev
->
≥rs
 &&Ñdev->
øid_disk
 >= 0)

2849  -
EBUSY
;

2850 i‡(
rdev
->
£˘‹s
 &&Ñdev->
mddev
->
exã∫Æ
)

2853  -
EBUSY
;

2854 
rdev
->
d©a_off£t
 = 
off£t
;

2855 
rdev
->
√w_d©a_off£t
 = 
off£t
;

2856  
Àn
;

2857 
	}
}

2859 
rdev_sysfs_íåy
 
	grdev_off£t
 =

2860 
__ATTR
(
off£t
, 
S_IRUGO
|
S_IWUSR
, 
off£t_show
, 
off£t_°‹e
);

2862 
ssize_t
 
	$√w_off£t_show
(
md_rdev
 *
rdev
, *
∑ge
)

2864  
	`•rötf
(
∑ge
, "%llu\n",

2865 ()
rdev
->
√w_d©a_off£t
);

2866 
	}
}

2868 
ssize_t
 
	$√w_off£t_°‹e
(
md_rdev
 *
rdev
,

2869 c⁄° *
buf
, 
size_t
 
Àn
)

2871 
√w_off£t
;

2872 
mddev
 *mddev = 
rdev
->mddev;

2874 i‡(
	`k°πouŒ
(
buf
, 10, &
√w_off£t
) < 0)

2875  -
EINVAL
;

2877 i‡(
mddev
->
sync_thªad
)

2878  -
EBUSY
;

2879 i‡(
√w_off£t
 =
rdev
->
d©a_off£t
)

2882 i‡(
√w_off£t
 > 
rdev
->
d©a_off£t
) {

2884 i‡(
√w_off£t
 - 
rdev
->
d©a_off£t


2885 + 
mddev
->
dev_£˘‹s
 > 
rdev
->
£˘‹s
)

2886  -
E2BIG
;

2893 i‡(
√w_off£t
 < 
rdev
->
d©a_off£t
 &&

2894 
mddev
->
ªsh≠e_backw¨ds
)

2895  -
EINVAL
;

2900 i‡(
√w_off£t
 > 
rdev
->
d©a_off£t
 &&

2901 !
mddev
->
ªsh≠e_backw¨ds
)

2902  -
EINVAL
;

2904 i‡(
mddev
->
≥rs
 && mddev->
≥rsi°ít
 &&

2905 !
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
]

2906 .
	`Ælow_√w_off£t
(
rdev
, 
√w_off£t
))

2907  -
E2BIG
;

2908 
rdev
->
√w_d©a_off£t
 = 
√w_off£t
;

2909 i‡(
√w_off£t
 > 
rdev
->
d©a_off£t
)

2910 
mddev
->
ªsh≠e_backw¨ds
 = 1;

2911 i‡(
√w_off£t
 < 
rdev
->
d©a_off£t
)

2912 
mddev
->
ªsh≠e_backw¨ds
 = 0;

2914  
Àn
;

2915 
	}
}

2916 
rdev_sysfs_íåy
 
	grdev_√w_off£t
 =

2917 
__ATTR
(
√w_off£t
, 
S_IRUGO
|
S_IWUSR
, 
√w_off£t_show
, 
√w_off£t_°‹e
);

2919 
ssize_t


2920 
	$rdev_size_show
(
md_rdev
 *
rdev
, *
∑ge
)

2922  
	`•rötf
(
∑ge
, "%Œu\n", ()
rdev
->
£˘‹s
 / 2);

2923 
	}
}

2925 
	$ovîœps
(
£˘‹_t
 
s1
, se˘‹_à
l1
, se˘‹_à
s2
, se˘‹_à
l2
)

2928 i‡(
s1
+
l1
 <
s2
)

2930 i‡(
s2
+
l2
 <
s1
)

2933 
	}
}

2935 
	$°ri˘_blocks_to_£˘‹s
(c⁄° *
buf
, 
£˘‹_t
 *
£˘‹s
)

2937 
blocks
;

2938 
£˘‹_t
 
√w
;

2940 i‡(
	`k°πouŒ
(
buf
, 10, &
blocks
) < 0)

2941  -
EINVAL
;

2943 i‡(
blocks
 & 1ULL << (8 * (blocks) - 1))

2944  -
EINVAL
;

2946 
√w
 = 
blocks
 * 2;

2947 i‡(
√w
 !
blocks
 * 2)

2948  -
EINVAL
;

2950 *
£˘‹s
 = 
√w
;

2952 
	}
}

2954 
ssize_t


2955 
	$rdev_size_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

2957 
mddev
 *
my_mddev
 = 
rdev
->mddev;

2958 
£˘‹_t
 
ﬁd£˘‹s
 = 
rdev
->
£˘‹s
;

2959 
£˘‹_t
 
£˘‹s
;

2961 i‡(
	`°ri˘_blocks_to_£˘‹s
(
buf
, &
£˘‹s
) < 0)

2962  -
EINVAL
;

2963 i‡(
rdev
->
d©a_off£t
 !rdev->
√w_d©a_off£t
)

2964  -
EINVAL
;

2965 i‡(
my_mddev
->
≥rs
 && 
rdev
->
øid_disk
 >= 0) {

2966 i‡(
my_mddev
->
≥rsi°ít
) {

2967 
£˘‹s
 = 
su≥r_ty≥s
[
my_mddev
->
maj‹_vîsi⁄
].

2968 
	`rdev_size_ch™ge
(
rdev
, 
£˘‹s
);

2969 i‡(!
£˘‹s
)

2970  -
EBUSY
;

2971 } i‡(!
£˘‹s
)

2972 
£˘‹s
 = (
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
) >> 9) -

2973 
rdev
->
d©a_off£t
;

2974 i‡(!
my_mddev
->
≥rs
->
ªsize
)

2976  -
EINVAL
;

2978 i‡(
£˘‹s
 < 
my_mddev
->
dev_£˘‹s
)

2979  -
EINVAL
;

2981 
rdev
->
£˘‹s
 = sectors;

2982 i‡(
£˘‹s
 > 
ﬁd£˘‹s
 && 
my_mddev
->
exã∫Æ
) {

2988 
mddev
 *mddev;

2989 
ovîœp
 = 0;

2990 
li°_hód
 *
tmp
;

2992 
	`mddev_u∆ock
(
my_mddev
);

2993 
	`f‹_óch_mddev
(
mddev
, 
tmp
) {

2994 
md_rdev
 *
rdev2
;

2996 
	`mddev_lock_noöå
(
mddev
);

2997 
	`rdev_f‹_óch
(
rdev2
, 
mddev
)

2998 i‡(
rdev
->
bdev
 =
rdev2
->bdev &&

2999 
rdev
 !
rdev2
 &&

3000 
	`ovîœps
(
rdev
->
d©a_off£t
,Ñdev->
£˘‹s
,

3001 
rdev2
->
d©a_off£t
,

3002 
rdev2
->
£˘‹s
)) {

3003 
ovîœp
 = 1;

3006 
	`mddev_u∆ock
(
mddev
);

3007 i‡(
ovîœp
) {

3008 
	`mddev_put
(
mddev
);

3012 
	`mddev_lock_noöå
(
my_mddev
);

3013 i‡(
ovîœp
) {

3020 
rdev
->
£˘‹s
 = 
ﬁd£˘‹s
;

3021  -
EBUSY
;

3024  
Àn
;

3025 
	}
}

3027 
rdev_sysfs_íåy
 
	grdev_size
 =

3028 
__ATTR
(
size
, 
S_IRUGO
|
S_IWUSR
, 
rdev_size_show
, 
rdev_size_°‹e
);

3031 
ssize_t
 
	$ªcovîy_°¨t_show
(
md_rdev
 *
rdev
, *
∑ge
)

3033 
ªcovîy_°¨t
 = 
rdev
->
ªcovîy_off£t
;

3035 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

3036 
ªcovîy_°¨t
 =
MaxSe˘‹
)

3037  
	`•rötf
(
∑ge
, "none\n");

3039  
	`•rötf
(
∑ge
, "%Œu\n", 
ªcovîy_°¨t
);

3040 
	}
}

3042 
ssize_t
 
	$ªcovîy_°¨t_°‹e
(
md_rdev
 *
rdev
, c⁄° *
buf
, 
size_t
 
Àn
)

3044 
ªcovîy_°¨t
;

3046 i‡(
	`cmd_m©ch
(
buf
, "none"))

3047 
ªcovîy_°¨t
 = 
MaxSe˘‹
;

3048 i‡(
	`k°πouŒ
(
buf
, 10, &
ªcovîy_°¨t
))

3049  -
EINVAL
;

3051 i‡(
rdev
->
mddev
->
≥rs
 &&

3052 
rdev
->
øid_disk
 >= 0)

3053  -
EBUSY
;

3055 
rdev
->
ªcovîy_off£t
 = 
ªcovîy_°¨t
;

3056 i‡(
ªcovîy_°¨t
 =
MaxSe˘‹
)

3057 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

3059 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

3060  
Àn
;

3061 
	}
}

3063 
rdev_sysfs_íåy
 
	grdev_ªcovîy_°¨t
 =

3064 
__ATTR
(
ªcovîy_°¨t
, 
S_IRUGO
|
S_IWUSR
, 
ªcovîy_°¨t_show
, 
ªcovîy_°¨t_°‹e
);

3067 
ssize_t


3068 
badblocks_show
(
badblocks
 *
bb
, *
∑ge
, 
u«ck
);

3069 
ssize_t


3070 
badblocks_°‹e
(
badblocks
 *
bb
, c⁄° *
∑ge
, 
size_t
 
Àn
, 
u«ck
);

3072 
ssize_t
 
	$bb_show
(
md_rdev
 *
rdev
, *
∑ge
)

3074  
	`badblocks_show
(&
rdev
->
badblocks
, 
∑ge
, 0);

3075 
	}
}

3076 
ssize_t
 
	$bb_°‹e
(
md_rdev
 *
rdev
, c⁄° *
∑ge
, 
size_t
 
Àn
)

3078 
rv
 = 
	`badblocks_°‹e
(&
rdev
->
badblocks
, 
∑ge
, 
Àn
, 0);

3080 i‡(
	`ã°_™d_˛ór_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
))

3081 
	`wake_up
(&
rdev
->
blocked_waô
);

3082  
rv
;

3083 
	}
}

3084 
rdev_sysfs_íåy
 
	grdev_bad_blocks
 =

3085 
__ATTR
(
bad_blocks
, 
S_IRUGO
|
S_IWUSR
, 
bb_show
, 
bb_°‹e
);

3088 
ssize_t
 
	$ubb_show
(
md_rdev
 *
rdev
, *
∑ge
)

3090  
	`badblocks_show
(&
rdev
->
badblocks
, 
∑ge
, 1);

3091 
	}
}

3092 
ssize_t
 
	$ubb_°‹e
(
md_rdev
 *
rdev
, c⁄° *
∑ge
, 
size_t
 
Àn
)

3094  
	`badblocks_°‹e
(&
rdev
->
badblocks
, 
∑ge
, 
Àn
, 1);

3095 
	}
}

3096 
rdev_sysfs_íåy
 
	grdev_u«ck_bad_blocks
 =

3097 
__ATTR
(
u«cknowÀdged_bad_blocks
, 
S_IRUGO
|
S_IWUSR
, 
ubb_show
, 
ubb_°‹e
);

3099 
©åibuã
 *
	grdev_deÁu…_©ås
[] = {

3100 &
rdev_°©e
.
©å
,

3101 &
rdev_îr‹s
.
©å
,

3102 &
rdev_¶Ÿ
.
©å
,

3103 &
rdev_off£t
.
©å
,

3104 &
rdev_√w_off£t
.
©å
,

3105 &
rdev_size
.
©å
,

3106 &
rdev_ªcovîy_°¨t
.
©å
,

3107 &
rdev_bad_blocks
.
©å
,

3108 &
rdev_u«ck_bad_blocks
.
©å
,

3109 
NULL
,

3111 
ssize_t


3112 
	$rdev_©å_show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
∑ge
)

3114 
rdev_sysfs_íåy
 *
íåy
 = 
	`c⁄èöî_of
(
©å
, rdev_sysfs_entry,áttr);

3115 
md_rdev
 *
rdev
 = 
	`c⁄èöî_of
(
kobj
, md_rdev, kobj);

3116 
mddev
 *mddev = 
rdev
->mddev;

3117 
ssize_t
 
rv
;

3119 i‡(!
íåy
->
show
)

3120  -
EIO
;

3122 
rv
 = 
mddev
 ? 
	`mddev_lock
(mddevË: -
EBUSY
;

3123 i‡(!
rv
) {

3124 i‡(
rdev
->
mddev
 =
NULL
)

3125 
rv
 = -
EBUSY
;

3127 
rv
 = 
íåy
->
	`show
(
rdev
, 
∑ge
);

3128 
	`mddev_u∆ock
(
mddev
);

3130  
rv
;

3131 
	}
}

3133 
ssize_t


3134 
	$rdev_©å_°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

3135 c⁄° *
∑ge
, 
size_t
 
Àngth
)

3137 
rdev_sysfs_íåy
 *
íåy
 = 
	`c⁄èöî_of
(
©å
, rdev_sysfs_entry,áttr);

3138 
md_rdev
 *
rdev
 = 
	`c⁄èöî_of
(
kobj
, md_rdev, kobj);

3139 
ssize_t
 
rv
;

3140 
mddev
 *mddev = 
rdev
->mddev;

3142 i‡(!
íåy
->
°‹e
)

3143  -
EIO
;

3144 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3145  -
EACCES
;

3146 
rv
 = 
mddev
 ? 
	`mddev_lock
(mddev): -
EBUSY
;

3147 i‡(!
rv
) {

3148 i‡(
rdev
->
mddev
 =
NULL
)

3149 
rv
 = -
EBUSY
;

3151 
rv
 = 
íåy
->
	`°‹e
(
rdev
, 
∑ge
, 
Àngth
);

3152 
	`mddev_u∆ock
(
mddev
);

3154  
rv
;

3155 
	}
}

3157 
	$rdev_‰ì
(
kobje˘
 *
ko
)

3159 
md_rdev
 *
rdev
 = 
	`c⁄èöî_of
(
ko
, md_rdev, 
kobj
);

3160 
	`k‰ì
(
rdev
);

3161 
	}
}

3162 c⁄° 
sysfs_›s
 
	grdev_sysfs_›s
 = {

3163 .
show
 = 
rdev_©å_show
,

3164 .
	g°‹e
 = 
rdev_©å_°‹e
,

3166 
kobj_ty≥
 
	grdev_kty≥
 = {

3167 .
ªÀa£
 = 
rdev_‰ì
,

3168 .
	gsysfs_›s
 = &
rdev_sysfs_›s
,

3169 .
	gdeÁu…_©ås
 = 
rdev_deÁu…_©ås
,

3172 
	$md_rdev_öô
(
md_rdev
 *
rdev
)

3174 
rdev
->
desc_ƒ
 = -1;

3175 
rdev
->
ßved_øid_disk
 = -1;

3176 
rdev
->
øid_disk
 = -1;

3177 
rdev
->
Êags
 = 0;

3178 
rdev
->
d©a_off£t
 = 0;

3179 
rdev
->
√w_d©a_off£t
 = 0;

3180 
rdev
->
sb_evíts
 = 0;

3181 
rdev
->
œ°_ªad_îr‹
.
tv_£c
 = 0;

3182 
rdev
->
œ°_ªad_îr‹
.
tv_n£c
 = 0;

3183 
rdev
->
sb_lﬂded
 = 0;

3184 
rdev
->
bb_∑ge
 = 
NULL
;

3185 
	`©omic_£t
(&
rdev
->
ƒ_≥ndög
, 0);

3186 
	`©omic_£t
(&
rdev
->
ªad_îr‹s
, 0);

3187 
	`©omic_£t
(&
rdev
->
c‹ª˘ed_îr‹s
, 0);

3189 
	`INIT_LIST_HEAD
(&
rdev
->
ßme_£t
);

3190 
	`öô_waôqueue_hód
(&
rdev
->
blocked_waô
);

3196 
rdev
->
badblocks
.
cou¡
 = 0;

3197 
rdev
->
badblocks
.
shi·
 = -1;

3198 
rdev
->
badblocks
.
∑ge
 = 
	`kmÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

3199 
	`£qlock_öô
(&
rdev
->
badblocks
.
lock
);

3200 i‡(
rdev
->
badblocks
.
∑ge
 =
NULL
)

3201  -
ENOMEM
;

3204 
	}
}

3205 
EXPORT_SYMBOL_GPL
(
md_rdev_öô
);

3216 
md_rdev
 *
	$md_imp‹t_devi˚
(
dev_t
 
√wdev
, 
su≥r_f‹m©
, 
su≥r_mö‹
)

3218 
b
[
BDEVNAME_SIZE
];

3219 
îr
;

3220 
md_rdev
 *
rdev
;

3221 
£˘‹_t
 
size
;

3223 
rdev
 = 
	`kzÆloc
((*rdev), 
GFP_KERNEL
);

3224 i‡(!
rdev
) {

3225 
	`¥ötk
(
KERN_ERR
 "md: couldÇotálloc mem forÇew device!\n");

3226  
	`ERR_PTR
(-
ENOMEM
);

3229 
îr
 = 
	`md_rdev_öô
(
rdev
);

3230 i‡(
îr
)

3231 
ab‹t_‰ì
;

3232 
îr
 = 
	`Æloc_disk_sb
(
rdev
);

3233 i‡(
îr
)

3234 
ab‹t_‰ì
;

3236 
îr
 = 
	`lock_rdev
(
rdev
, 
√wdev
, 
su≥r_f‹m©
 == -2);

3237 i‡(
îr
)

3238 
ab‹t_‰ì
;

3240 
	`kobje˘_öô
(&
rdev
->
kobj
, &
rdev_kty≥
);

3242 
size
 = 
	`i_size_ªad
(
rdev
->
bdev
->
bd_öode
Ë>> 
BLOCK_SIZE_BITS
;

3243 i‡(!
size
) {

3244 
	`¥ötk
(
KERN_WARNING


3246 
	`bdev«me
(
rdev
->
bdev
,
b
));

3247 
îr
 = -
EINVAL
;

3248 
ab‹t_‰ì
;

3251 i‡(
su≥r_f‹m©
 >= 0) {

3252 
îr
 = 
su≥r_ty≥s
[
su≥r_f‹m©
].

3253 
	`lﬂd_su≥r
(
rdev
, 
NULL
, 
su≥r_mö‹
);

3254 i‡(
îr
 =-
EINVAL
) {

3255 
	`¥ötk
(
KERN_WARNING


3258 
	`bdev«me
(
rdev
->
bdev
,
b
),

3259 
su≥r_f‹m©
, 
su≥r_mö‹
);

3260 
ab‹t_‰ì
;

3262 i‡(
îr
 < 0) {

3263 
	`¥ötk
(
KERN_WARNING


3265 
	`bdev«me
(
rdev
->
bdev
,
b
));

3266 
ab‹t_‰ì
;

3270  
rdev
;

3272 
ab‹t_‰ì
:

3273 i‡(
rdev
->
bdev
)

3274 
	`u∆ock_rdev
(
rdev
);

3275 
	`md_rdev_˛ór
(
rdev
);

3276 
	`k‰ì
(
rdev
);

3277  
	`ERR_PTR
(
îr
);

3278 
	}
}

3285 
	$™Æyze_sbs
(
mddev
 * mddev)

3287 
i
;

3288 
md_rdev
 *
rdev
, *
‰eshe°
, *
tmp
;

3289 
b
[
BDEVNAME_SIZE
];

3291 
‰eshe°
 = 
NULL
;

3292 
	`rdev_f‹_óch_ß„
(
rdev
, 
tmp
, 
mddev
)

3293 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].

3294 
	`lﬂd_su≥r
(
rdev
, 
‰eshe°
, 
mddev
->
mö‹_vîsi⁄
)) {

3296 
‰eshe°
 = 
rdev
;

3301 
	`¥ötk
–
KERN_ERR
 \

3304 
	`bdev«me
(
rdev
->
bdev
,
b
));

3305 
	`kick_rdev_‰om_¨øy
(
rdev
);

3309 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].

3310 
	`vÆid©e_su≥r
(
mddev
, 
‰eshe°
);

3312 
i
 = 0;

3313 
	`rdev_f‹_óch_ß„
(
rdev
, 
tmp
, 
mddev
) {

3314 i‡(
mddev
->
max_disks
 &&

3315 (
rdev
->
desc_ƒ
 >
mddev
->
max_disks
 ||

3316 
i
 > 
mddev
->
max_disks
)) {

3317 
	`¥ötk
(
KERN_WARNING


3319 
	`md«me
(
mddev
), 
	`bdev«me
(
rdev
->
bdev
, 
b
),

3320 
mddev
->
max_disks
);

3321 
	`kick_rdev_‰om_¨øy
(
rdev
);

3324 i‡(
rdev
 !
‰eshe°
)

3325 i‡(
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].

3326 
	`vÆid©e_su≥r
(
mddev
, 
rdev
)) {

3327 
	`¥ötk
(
KERN_WARNING
 "md: kickingÇon-fresh %s"

3329 
	`bdev«me
(
rdev
->
bdev
,
b
));

3330 
	`kick_rdev_‰om_¨øy
(
rdev
);

3333 i‡(
mddev
->
Àvñ
 =
LEVEL_MULTIPATH
) {

3334 
rdev
->
desc_ƒ
 = 
i
++;

3335 
rdev
->
øid_disk
 =Ñdev->
desc_ƒ
;

3336 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

3337 } i‡(
rdev
->
øid_disk
 >(
mddev
->
øid_disks
 - 
	`mö
(0, mddev->
dñè_disks
))) {

3338 
rdev
->
øid_disk
 = -1;

3339 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

3342 
	}
}

3354 
	$°ri˘_°πoul_sˇÀd
(c⁄° *
˝
, *
ªs
, 
sˇÀ
)

3356 
ªsu…
 = 0;

3357 
decimÆs
 = -1;

3358 
	`isdigô
(*
˝
Ë|| (*˝ ='.' && 
decimÆs
 < 0)) {

3359 i‡(*
˝
 == '.')

3360 
decimÆs
 = 0;

3361 i‡(
decimÆs
 < 
sˇÀ
) {

3362 
vÆue
;

3363 
vÆue
 = *
˝
 - '0';

3364 
ªsu…
 =Ñesu… * 10 + 
vÆue
;

3365 i‡(
decimÆs
 >= 0)

3366 
decimÆs
++;

3368 
˝
++;

3370 i‡(*
˝
 == '\n')

3371 
˝
++;

3372 i‡(*
˝
)

3373  -
EINVAL
;

3374 i‡(
decimÆs
 < 0)

3375 
decimÆs
 = 0;

3376 
decimÆs
 < 
sˇÀ
) {

3377 
ªsu…
 *= 10;

3378 
decimÆs
 ++;

3380 *
ªs
 = 
ªsu…
;

3382 
	}
}

3385 
md_ß„mode_timeout
(
d©a
);

3387 
ssize_t


3388 
	$ß„_dñay_show
(
mddev
 *mddev, *
∑ge
)

3390 
m£c
 = (
mddev
->
ß„mode_dñay
*1000)/
HZ
;

3391  
	`•rötf
(
∑ge
, "%d.%03d\n", 
m£c
/1000, msec%1000);

3392 
	}
}

3393 
ssize_t


3394 
	$ß„_dñay_°‹e
(
mddev
 *mddev, c⁄° *
cbuf
, 
size_t
 
Àn
)

3396 
m£c
;

3398 i‡(
	`°ri˘_°πoul_sˇÀd
(
cbuf
, &
m£c
, 3) < 0)

3399  -
EINVAL
;

3400 i‡(
m£c
 == 0)

3401 
mddev
->
ß„mode_dñay
 = 0;

3403 
ﬁd_dñay
 = 
mddev
->
ß„mode_dñay
;

3404 
mddev
->
ß„mode_dñay
 = (
m£c
*
HZ
)/1000;

3405 i‡(
mddev
->
ß„mode_dñay
 == 0)

3406 
mddev
->
ß„mode_dñay
 = 1;

3407 i‡(
mddev
->
ß„mode_dñay
 < 
ﬁd_dñay
 || old_delay == 0)

3408 
	`md_ß„mode_timeout
(()
mddev
);

3410  
Àn
;

3411 
	}
}

3412 
md_sysfs_íåy
 
	gmd_ß„_dñay
 =

3413 
__ATTR
(
ß„_mode_dñay
, 
S_IRUGO
|
S_IWUSR
,
ß„_dñay_show
, 
ß„_dñay_°‹e
);

3415 
ssize_t


3416 
	$Àvñ_show
(
mddev
 *mddev, *
∑ge
)

3418 
md_≥rs⁄Æôy
 *
p
 = 
mddev
->
≥rs
;

3419 i‡(
p
)

3420  
	`•rötf
(
∑ge
, "%s\n", 
p
->
«me
);

3421 i‡(
mddev
->
˛evñ
[0])

3422  
	`•rötf
(
∑ge
, "%s\n", 
mddev
->
˛evñ
);

3423 i‡(
mddev
->
Àvñ
 !
LEVEL_NONE
)

3424  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
Àvñ
);

3427 
	}
}

3429 
ssize_t


3430 
	$Àvñ_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3432 
˛evñ
[16];

3433 
ssize_t
 
rv
 = 
Àn
;

3434 
md_≥rs⁄Æôy
 *
≥rs
;

3435 
Àvñ
;

3436 *
¥iv
;

3437 
md_rdev
 *
rdev
;

3439 i‡(
mddev
->
≥rs
 =
NULL
) {

3440 i‡(
Àn
 == 0)

3442 i‡(
Àn
 >(
mddev
->
˛evñ
))

3443  -
ENOSPC
;

3444 
	`°∫˝y
(
mddev
->
˛evñ
, 
buf
, 
Àn
);

3445 i‡(
mddev
->
˛evñ
[
Àn
-1] == '\n')

3446 
Àn
--;

3447 
mddev
->
˛evñ
[
Àn
] = 0;

3448 
mddev
->
Àvñ
 = 
LEVEL_NONE
;

3449  
rv
;

3451 i‡(
mddev
->
ro
)

3452  -
EROFS
;

3460 i‡(
mddev
->
sync_thªad
 ||

3461 
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 ||

3462 
mddev
->
sysfs_a˘ive
)

3463  -
EBUSY
;

3465 i‡(!
mddev
->
≥rs
->
quõs˚
) {

3466 
	`¥ötk
(
KERN_WARNING
 "md: %s: %s doesÇot support onlineÖersonality change\n",

3467 
	`md«me
(
mddev
), mddev->
≥rs
->
«me
);

3468  -
EINVAL
;

3472 i‡(
Àn
 =0 ||Üí >(
˛evñ
))

3473  -
EINVAL
;

3474 
	`°∫˝y
(
˛evñ
, 
buf
, 
Àn
);

3475 i‡(
˛evñ
[
Àn
-1] == '\n')

3476 
Àn
--;

3477 
˛evñ
[
Àn
] = 0;

3478 i‡(
	`k°πﬁ
(
˛evñ
, 10, &
Àvñ
))

3479 
Àvñ
 = 
LEVEL_NONE
;

3481 i‡(
	`ªque°_moduÀ
("md-%s", 
˛evñ
) != 0)

3482 
	`ªque°_moduÀ
("md-Àvñ-%s", 
˛evñ
);

3483 
	`•ö_lock
(&
≥rs_lock
);

3484 
≥rs
 = 
	`föd_≥rs
(
Àvñ
, 
˛evñ
);

3485 i‡(!
≥rs
 || !
	`åy_moduÀ_gë
’îs->
ow√r
)) {

3486 
	`•ö_u∆ock
(&
≥rs_lock
);

3487 
	`¥ötk
(
KERN_WARNING
 "md:Öîs⁄Æôy %†nŸÜﬂded\n", 
˛evñ
);

3488  -
EINVAL
;

3490 
	`•ö_u∆ock
(&
≥rs_lock
);

3492 i‡(
≥rs
 =
mddev
->pers) {

3494 
	`moduÀ_put
(
≥rs
->
ow√r
);

3495  
rv
;

3497 i‡(!
≥rs
->
èkeovî
) {

3498 
	`moduÀ_put
(
≥rs
->
ow√r
);

3499 
	`¥ötk
(
KERN_WARNING
 "md: %s: %s doesÇot supportÖersonalityÅakeover\n",

3500 
	`md«me
(
mddev
), 
˛evñ
);

3501  -
EINVAL
;

3504 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

3505 
rdev
->
√w_øid_disk
 =Ñdev->
øid_disk
;

3510 
¥iv
 = 
≥rs
->
	`èkeovî
(
mddev
);

3511 i‡(
	`IS_ERR
(
¥iv
)) {

3512 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

3513 
mddev
->
√w_œyout
 = mddev->
œyout
;

3514 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

3515 
mddev
->
øid_disks
 -mddev->
dñè_disks
;

3516 
mddev
->
dñè_disks
 = 0;

3517 
mddev
->
ªsh≠e_backw¨ds
 = 0;

3518 
	`moduÀ_put
(
≥rs
->
ow√r
);

3519 
	`¥ötk
(
KERN_WARNING
 "md: %s: %s wouldÇotácceptárray\n",

3520 
	`md«me
(
mddev
), 
˛evñ
);

3521  
	`PTR_ERR
(
¥iv
);

3525 
	`mddev_su•íd
(
mddev
);

3526 
mddev
->
≥rs
->
	`°›
(mddev);

3528 i‡(
mddev
->
≥rs
->
sync_ªque°
 =
NULL
 &&

3529 
≥rs
->
sync_ªque°
 !
NULL
) {

3531 i‡(
	`sysfs_¸óã_group
(&
mddev
->
kobj
, &
md_ªdund™cy_group
))

3532 
	`¥ötk
(
KERN_WARNING


3534 
	`md«me
(
mddev
));

3535 
mddev
->
sysfs_a˘i⁄
 = 
	`sysfs_gë_dúít
(mddev->
kobj
.
sd
, "sync_action");

3537 i‡(
mddev
->
≥rs
->
sync_ªque°
 !
NULL
 &&

3538 
≥rs
->
sync_ªque°
 =
NULL
) {

3540 i‡(
mddev
->
to_ªmove
 =
NULL
)

3541 
mddev
->
to_ªmove
 = &
md_ªdund™cy_group
;

3544 i‡(
mddev
->
≥rs
->
sync_ªque°
 =
NULL
 &&

3545 
mddev
->
exã∫Æ
) {

3553 
mddev
->
ö_sync
 = 0;

3554 
mddev
->
ß„mode_dñay
 = 0;

3555 
mddev
->
ß„mode
 = 0;

3558 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

3559 i‡(
rdev
->
øid_disk
 < 0)

3561 i‡(
rdev
->
√w_øid_disk
 >
mddev
->
øid_disks
)

3562 
rdev
->
√w_øid_disk
 = -1;

3563 i‡(
rdev
->
√w_øid_disk
 =rdev->
øid_disk
)

3565 
	`sysfs_u∆ök_rdev
(
mddev
, 
rdev
);

3567 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

3568 i‡(
rdev
->
øid_disk
 < 0)

3570 i‡(
rdev
->
√w_øid_disk
 =rdev->
øid_disk
)

3572 
rdev
->
øid_disk
 =Ñdev->
√w_øid_disk
;

3573 i‡(
rdev
->
øid_disk
 < 0)

3574 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

3576 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

3577 
	`¥ötk
(
KERN_WARNING
 "md: cannotÑegisterÑd%d"

3579 
rdev
->
øid_disk
, 
	`md«me
(
mddev
));

3583 
	`moduÀ_put
(
mddev
->
≥rs
->
ow√r
);

3584 
mddev
->
≥rs
 =Öers;

3585 
mddev
->
¥iv©e
 = 
¥iv
;

3586 
	`°æ˝y
(
mddev
->
˛evñ
, 
≥rs
->
«me
, (mddev->clevel));

3587 
mddev
->
Àvñ
 = mddev->
√w_Àvñ
;

3588 
mddev
->
œyout
 = mddev->
√w_œyout
;

3589 
mddev
->
chunk_£˘‹s
 = mddev->
√w_chunk_£˘‹s
;

3590 
mddev
->
dñè_disks
 = 0;

3591 
mddev
->
ªsh≠e_backw¨ds
 = 0;

3592 
mddev
->
degøded
 = 0;

3593 i‡(
mddev
->
≥rs
->
sync_ªque°
 =
NULL
) {

3597 
mddev
->
ö_sync
 = 1;

3598 
	`dñ_timî_sync
(&
mddev
->
ß„mode_timî
);

3600 
	`blk_£t_°ackög_limôs
(&
mddev
->
queue
->
limôs
);

3601 
≥rs
->
	`run
(
mddev
);

3602 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

3603 
	`mddev_ªsume
(
mddev
);

3604 i‡(!
mddev
->
thªad
)

3605 
	`md_upd©e_sb
(
mddev
, 1);

3606 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "level");

3607 
	`md_√w_evít
(
mddev
);

3608  
rv
;

3609 
	}
}

3611 
md_sysfs_íåy
 
	gmd_Àvñ
 =

3612 
__ATTR
(
Àvñ
, 
S_IRUGO
|
S_IWUSR
, 
Àvñ_show
, 
Àvñ_°‹e
);

3615 
ssize_t


3616 
	$œyout_show
(
mddev
 *mddev, *
∑ge
)

3619 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 &&

3620 
mddev
->
œyout
 !mddev->
√w_œyout
)

3621  
	`•rötf
(
∑ge
, "%d (%d)\n",

3622 
mddev
->
√w_œyout
, mddev->
œyout
);

3623  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
œyout
);

3624 
	}
}

3626 
ssize_t


3627 
	$œyout_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3629 *
e
;

3630 
n
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

3632 i‡(!*
buf
 || (*
e
 && *e != '\n'))

3633  -
EINVAL
;

3635 i‡(
mddev
->
≥rs
) {

3636 
îr
;

3637 i‡(
mddev
->
≥rs
->
check_ªsh≠e
 =
NULL
)

3638  -
EBUSY
;

3639 i‡(
mddev
->
ro
)

3640  -
EROFS
;

3641 
mddev
->
√w_œyout
 = 
n
;

3642 
îr
 = 
mddev
->
≥rs
->
	`check_ªsh≠e
(mddev);

3643 i‡(
îr
) {

3644 
mddev
->
√w_œyout
 = mddev->
œyout
;

3645  
îr
;

3648 
mddev
->
√w_œyout
 = 
n
;

3649 i‡(
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
)

3650 
mddev
->
œyout
 = 
n
;

3652  
Àn
;

3653 
	}
}

3654 
md_sysfs_íåy
 
	gmd_œyout
 =

3655 
__ATTR
(
œyout
, 
S_IRUGO
|
S_IWUSR
, 
œyout_show
, 
œyout_°‹e
);

3658 
ssize_t


3659 
	$øid_disks_show
(
mddev
 *mddev, *
∑ge
)

3661 i‡(
mddev
->
øid_disks
 == 0)

3663 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 &&

3664 
mddev
->
dñè_disks
 != 0)

3665  
	`•rötf
(
∑ge
, "%d (%d)\n", 
mddev
->
øid_disks
,

3666 
mddev
->
øid_disks
 - mddev->
dñè_disks
);

3667  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
øid_disks
);

3668 
	}
}

3670 
upd©e_øid_disks
(
mddev
 *mddev, 
øid_disks
);

3672 
ssize_t


3673 
	$øid_disks_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3675 *
e
;

3676 
rv
 = 0;

3677 
n
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

3679 i‡(!*
buf
 || (*
e
 && *e != '\n'))

3680  -
EINVAL
;

3682 i‡(
mddev
->
≥rs
)

3683 
rv
 = 
	`upd©e_øid_disks
(
mddev
, 
n
);

3684 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
) {

3685 
md_rdev
 *
rdev
;

3686 
ﬁddisks
 = 
mddev
->
øid_disks
 - mddev->
dñè_disks
;

3688 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

3689 i‡(
ﬁddisks
 < 
n
 &&

3690 
rdev
->
d©a_off£t
 <Ñdev->
√w_d©a_off£t
)

3691  -
EINVAL
;

3692 i‡(
ﬁddisks
 > 
n
 &&

3693 
rdev
->
d©a_off£t
 >Ñdev->
√w_d©a_off£t
)

3694  -
EINVAL
;

3696 
mddev
->
dñè_disks
 = 
n
 - 
ﬁddisks
;

3697 
mddev
->
øid_disks
 = 
n
;

3698 
mddev
->
ªsh≠e_backw¨ds
 = (mddev->
dñè_disks
 < 0);

3700 
mddev
->
øid_disks
 = 
n
;

3701  
rv
 ?Ñv : 
Àn
;

3702 
	}
}

3703 
md_sysfs_íåy
 
	gmd_øid_disks
 =

3704 
__ATTR
(
øid_disks
, 
S_IRUGO
|
S_IWUSR
, 
øid_disks_show
, 
øid_disks_°‹e
);

3706 
ssize_t


3707 
	$chunk_size_show
(
mddev
 *mddev, *
∑ge
)

3709 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 &&

3710 
mddev
->
chunk_£˘‹s
 !mddev->
√w_chunk_£˘‹s
)

3711  
	`•rötf
(
∑ge
, "%d (%d)\n",

3712 
mddev
->
√w_chunk_£˘‹s
 << 9,

3713 
mddev
->
chunk_£˘‹s
 << 9);

3714  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
chunk_£˘‹s
 << 9);

3715 
	}
}

3717 
ssize_t


3718 
	$chunk_size_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3720 *
e
;

3721 
n
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

3723 i‡(!*
buf
 || (*
e
 && *e != '\n'))

3724  -
EINVAL
;

3726 i‡(
mddev
->
≥rs
) {

3727 
îr
;

3728 i‡(
mddev
->
≥rs
->
check_ªsh≠e
 =
NULL
)

3729  -
EBUSY
;

3730 i‡(
mddev
->
ro
)

3731  -
EROFS
;

3732 
mddev
->
√w_chunk_£˘‹s
 = 
n
 >> 9;

3733 
îr
 = 
mddev
->
≥rs
->
	`check_ªsh≠e
(mddev);

3734 i‡(
îr
) {

3735 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

3736  
îr
;

3739 
mddev
->
√w_chunk_£˘‹s
 = 
n
 >> 9;

3740 i‡(
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
)

3741 
mddev
->
chunk_£˘‹s
 = 
n
 >> 9;

3743  
Àn
;

3744 
	}
}

3745 
md_sysfs_íåy
 
	gmd_chunk_size
 =

3746 
__ATTR
(
chunk_size
, 
S_IRUGO
|
S_IWUSR
, 
chunk_size_show
, 
chunk_size_°‹e
);

3748 
ssize_t


3749 
	$ªsync_°¨t_show
(
mddev
 *mddev, *
∑ge
)

3751 i‡(
mddev
->
ªcovîy_˝
 =
MaxSe˘‹
)

3752  
	`•rötf
(
∑ge
, "none\n");

3753  
	`•rötf
(
∑ge
, "%Œu\n", ()
mddev
->
ªcovîy_˝
);

3754 
	}
}

3756 
ssize_t


3757 
	$ªsync_°¨t_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3759 *
e
;

3760 
n
 = 
	`sim∂e_°πouŒ
(
buf
, &
e
, 10);

3762 i‡(
mddev
->
≥rs
 && !
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &mddev->
ªcovîy
))

3763  -
EBUSY
;

3764 i‡(
	`cmd_m©ch
(
buf
, "none"))

3765 
n
 = 
MaxSe˘‹
;

3766 i‡(!*
buf
 || (*
e
 && *e != '\n'))

3767  -
EINVAL
;

3769 
mddev
->
ªcovîy_˝
 = 
n
;

3770 i‡(
mddev
->
≥rs
)

3771 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

3772  
Àn
;

3773 
	}
}

3774 
md_sysfs_íåy
 
	gmd_ªsync_°¨t
 =

3775 
__ATTR
(
ªsync_°¨t
, 
S_IRUGO
|
S_IWUSR
, 
ªsync_°¨t_show
, 
ªsync_°¨t_°‹e
);

3813 
	e¨øy_°©e
 { 
	m˛ór
, 
	möa˘ive
, 
	msu•íded
, 
	mªad⁄ly
, 
	mªad_auto
, 
	m˛ón
, 
	ma˘ive
,

3814 
	mwrôe_≥ndög
, 
	ma˘ive_idÀ
, 
	mbad_w‹d
};

3815 *
	g¨øy_°©es
[] = {

3817 "wrôe-≥ndög", "a˘ive-idÀ", 
NULL
 };

3819 
	$m©ch_w‹d
(c⁄° *
w‹d
, **
li°
)

3821 
n
;

3822 
n
=0; 
li°
[n];Ç++)

3823 i‡(
	`cmd_m©ch
(
w‹d
, 
li°
[
n
]))

3825  
n
;

3826 
	}
}

3828 
ssize_t


3829 
	$¨øy_°©e_show
(
mddev
 *mddev, *
∑ge
)

3831 
¨øy_°©e
 
°
 = 
öa˘ive
;

3833 i‡(
mddev
->
≥rs
)

3834 
mddev
->
ro
) {

3836 
°
 = 
ªad⁄ly
;

3839 
°
 = 
ªad_auto
;

3842 i‡(
mddev
->
ö_sync
)

3843 
°
 = 
˛ón
;

3844 i‡(
	`ã°_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
))

3845 
°
 = 
wrôe_≥ndög
;

3846 i‡(
mddev
->
ß„mode
)

3847 
°
 = 
a˘ive_idÀ
;

3849 
°
 = 
a˘ive
;

3852 i‡(
	`li°_em±y
(&
mddev
->
disks
) &&

3853 
mddev
->
øid_disks
 == 0 &&

3854 
mddev
->
dev_£˘‹s
 == 0)

3855 
°
 = 
˛ór
;

3857 
°
 = 
öa˘ive
;

3859  
	`•rötf
(
∑ge
, "%s\n", 
¨øy_°©es
[
°
]);

3860 
	}
}

3862 
do_md_°›
(
mddev
 * mddev, 
ro
, 
block_devi˚
 *
bdev
);

3863 
md_£t_ªad⁄ly
(
mddev
 * mddev, 
block_devi˚
 *
bdev
);

3864 
do_md_run
(
mddev
 * mddev);

3865 
ª°¨t_¨øy
(
mddev
 *mddev);

3867 
ssize_t


3868 
	$¨øy_°©e_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3870 
îr
 = -
EINVAL
;

3871 
¨øy_°©e
 
°
 = 
	`m©ch_w‹d
(
buf
, 
¨øy_°©es
);

3872 
°
) {

3873 
bad_w‹d
:

3875 
˛ór
:

3877 
îr
 = 
	`do_md_°›
(
mddev
, 0, 
NULL
);

3879 
öa˘ive
:

3881 i‡(
mddev
->
≥rs
)

3882 
îr
 = 
	`do_md_°›
(
mddev
, 2, 
NULL
);

3884 
îr
 = 0;

3886 
su•íded
:

3888 
ªad⁄ly
:

3889 i‡(
mddev
->
≥rs
)

3890 
îr
 = 
	`md_£t_ªad⁄ly
(
mddev
, 
NULL
);

3892 
mddev
->
ro
 = 1;

3893 
	`£t_disk_ro
(
mddev
->
gídisk
, 1);

3894 
îr
 = 
	`do_md_run
(
mddev
);

3897 
ªad_auto
:

3898 i‡(
mddev
->
≥rs
) {

3899 i‡(
mddev
->
ro
 == 0)

3900 
îr
 = 
	`md_£t_ªad⁄ly
(
mddev
, 
NULL
);

3901 i‡(
mddev
->
ro
 == 1)

3902 
îr
 = 
	`ª°¨t_¨øy
(
mddev
);

3903 i‡(
îr
 == 0) {

3904 
mddev
->
ro
 = 2;

3905 
	`£t_disk_ro
(
mddev
->
gídisk
, 0);

3908 
mddev
->
ro
 = 2;

3909 
îr
 = 
	`do_md_run
(
mddev
);

3912 
˛ón
:

3913 i‡(
mddev
->
≥rs
) {

3914 
	`ª°¨t_¨øy
(
mddev
);

3915 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

3916 i‡(
	`©omic_ªad
(&
mddev
->
wrôes_≥ndög
) == 0) {

3917 i‡(
mddev
->
ö_sync
 == 0) {

3918 
mddev
->
ö_sync
 = 1;

3919 i‡(
mddev
->
ß„mode
 == 1)

3920 
mddev
->
ß„mode
 = 0;

3921 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

3923 
îr
 = 0;

3925 
îr
 = -
EBUSY
;

3926 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

3928 
îr
 = -
EINVAL
;

3930 
a˘ive
:

3931 i‡(
mddev
->
≥rs
) {

3932 
	`ª°¨t_¨øy
(
mddev
);

3933 
	`˛ór_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

3934 
	`wake_up
(&
mddev
->
sb_waô
);

3935 
îr
 = 0;

3937 
mddev
->
ro
 = 0;

3938 
	`£t_disk_ro
(
mddev
->
gídisk
, 0);

3939 
îr
 = 
	`do_md_run
(
mddev
);

3942 
wrôe_≥ndög
:

3943 
a˘ive_idÀ
:

3947 i‡(
îr
)

3948  
îr
;

3950 i‡(
mddev
->
hﬁd_a˘ive
 =
UNTIL_IOCTL
)

3951 
mddev
->
hﬁd_a˘ive
 = 0;

3952 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

3953  
Àn
;

3955 
	}
}

3956 
md_sysfs_íåy
 
	gmd_¨øy_°©e
 =

3957 
__ATTR
(
¨øy_°©e
, 
S_IRUGO
|
S_IWUSR
, 
¨øy_°©e_show
, 
¨øy_°©e_°‹e
);

3959 
ssize_t


3960 
	$max_c‹ª˘ed_ªad_îr‹s_show
(
mddev
 *mddev, *
∑ge
) {

3961  
	`•rötf
(
∑ge
, "%d\n",

3962 
	`©omic_ªad
(&
mddev
->
max_c‹r_ªad_îr‹s
));

3963 
	}
}

3965 
ssize_t


3966 
	$max_c‹ª˘ed_ªad_îr‹s_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3968 *
e
;

3969 
n
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

3971 i‡(*
buf
 && (*
e
 == 0 || *e == '\n')) {

3972 
	`©omic_£t
(&
mddev
->
max_c‹r_ªad_îr‹s
, 
n
);

3973  
Àn
;

3975  -
EINVAL
;

3976 
	}
}

3978 
md_sysfs_íåy
 
	gmax_c‹r_ªad_îr‹s
 =

3979 
__ATTR
(
max_ªad_îr‹s
, 
S_IRUGO
|
S_IWUSR
, 
max_c‹ª˘ed_ªad_îr‹s_show
,

3980 
max_c‹ª˘ed_ªad_îr‹s_°‹e
);

3982 
ssize_t


3983 
	$nuŒ_show
(
mddev
 *mddev, *
∑ge
)

3985  -
EINVAL
;

3986 
	}
}

3988 
ssize_t


3989 
	$√w_dev_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

3998 *
e
;

3999 
maj‹
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

4000 
mö‹
;

4001 
dev_t
 
dev
;

4002 
md_rdev
 *
rdev
;

4003 
îr
;

4005 i‡(!*
buf
 || *
e
 != ':' || !e[1] ||É[1] == '\n')

4006  -
EINVAL
;

4007 
mö‹
 = 
	`sim∂e_°πoul
(
e
+1, &e, 10);

4008 i‡(*
e
 && *e != '\n')

4009  -
EINVAL
;

4010 
dev
 = 
	`MKDEV
(
maj‹
, 
mö‹
);

4011 i‡(
maj‹
 !
	`MAJOR
(
dev
) ||

4012 
mö‹
 !
	`MINOR
(
dev
))

4013  -
EOVERFLOW
;

4016 i‡(
mddev
->
≥rsi°ít
) {

4017 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, 
mddev
->
maj‹_vîsi⁄
,

4018 
mddev
->
mö‹_vîsi⁄
);

4019 i‡(!
	`IS_ERR
(
rdev
Ë&& !
	`li°_em±y
(&
mddev
->
disks
)) {

4020 
md_rdev
 *
rdev0


4021 
	`li°_íåy
(
mddev
->
disks
.
√xt
,

4022 
md_rdev
, 
ßme_£t
);

4023 
îr
 = 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
]

4024 .
	`lﬂd_su≥r
(
rdev
, 
rdev0
, 
mddev
->
mö‹_vîsi⁄
);

4025 i‡(
îr
 < 0)

4026 
out
;

4028 } i‡(
mddev
->
exã∫Æ
)

4029 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, -2, -1);

4031 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, -1, -1);

4033 i‡(
	`IS_ERR
(
rdev
))

4034  
	`PTR_ERR
(
rdev
);

4035 
îr
 = 
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
);

4036 
out
:

4037 i‡(
îr
)

4038 
	`exp‹t_rdev
(
rdev
);

4039  
îr
 ?Éº : 
Àn
;

4040 
	}
}

4042 
md_sysfs_íåy
 
	gmd_√w_devi˚
 =

4043 
__ATTR
(
√w_dev
, 
S_IWUSR
, 
nuŒ_show
, 
√w_dev_°‹e
);

4045 
ssize_t


4046 
	$bôm≠_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4048 *
íd
;

4049 
chunk
, 
íd_chunk
;

4051 i‡(!
mddev
->
bôm≠
)

4052 
out
;

4054 *
buf
) {

4055 
chunk
 = 
íd_chunk
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

4056 i‡(
buf
 =
íd
) ;

4057 i‡(*
íd
 == '-') {

4058 
buf
 = 
íd
 + 1;

4059 
íd_chunk
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

4060 i‡(
buf
 =
íd
) ;

4062 i‡(*
íd
 && !
	`is•a˚
(*end)) ;

4063 
	`bôm≠_dúty_bôs
(
mddev
->
bôm≠
, 
chunk
, 
íd_chunk
);

4064 
buf
 = 
	`skù_•a˚s
(
íd
);

4066 
	`bôm≠_u≈lug
(
mddev
->
bôm≠
);

4067 
out
:

4068  
Àn
;

4069 
	}
}

4071 
md_sysfs_íåy
 
	gmd_bôm≠
 =

4072 
__ATTR
(
bôm≠_£t_bôs
, 
S_IWUSR
, 
nuŒ_show
, 
bôm≠_°‹e
);

4074 
ssize_t


4075 
	$size_show
(
mddev
 *mddev, *
∑ge
)

4077  
	`•rötf
(
∑ge
, "%llu\n",

4078 ()
mddev
->
dev_£˘‹s
 / 2);

4079 
	}
}

4081 
upd©e_size
(
mddev
 *mddev, 
£˘‹_t
 
num_£˘‹s
);

4083 
ssize_t


4084 
	$size_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4090 
£˘‹_t
 
£˘‹s
;

4091 
îr
 = 
	`°ri˘_blocks_to_£˘‹s
(
buf
, &
£˘‹s
);

4093 i‡(
îr
 < 0)

4094  
îr
;

4095 i‡(
mddev
->
≥rs
) {

4096 
îr
 = 
	`upd©e_size
(
mddev
, 
£˘‹s
);

4097 
	`md_upd©e_sb
(
mddev
, 1);

4099 i‡(
mddev
->
dev_£˘‹s
 == 0 ||

4100 
mddev
->
dev_£˘‹s
 > 
£˘‹s
)

4101 
mddev
->
dev_£˘‹s
 = 
£˘‹s
;

4103 
îr
 = -
ENOSPC
;

4105  
îr
 ?Éº : 
Àn
;

4106 
	}
}

4108 
md_sysfs_íåy
 
	gmd_size
 =

4109 
__ATTR
(
comp⁄ít_size
, 
S_IRUGO
|
S_IWUSR
, 
size_show
, 
size_°‹e
);

4118 
ssize_t


4119 
	$mëad©a_show
(
mddev
 *mddev, *
∑ge
)

4121 i‡(
mddev
->
≥rsi°ít
)

4122  
	`•rötf
(
∑ge
, "%d.%d\n",

4123 
mddev
->
maj‹_vîsi⁄
, mddev->
mö‹_vîsi⁄
);

4124 i‡(
mddev
->
exã∫Æ
)

4125  
	`•rötf
(
∑ge
, "exã∫Æ:%s\n", 
mddev
->
mëad©a_ty≥
);

4127  
	`•rötf
(
∑ge
, "none\n");

4128 
	}
}

4130 
ssize_t


4131 
	$mëad©a_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4133 
maj‹
, 
mö‹
;

4134 *
e
;

4139 i‡(
mddev
->
exã∫Æ
 && 
	`°∫cmp
(
buf
, "external:", 9) == 0)

4141 i‡(!
	`li°_em±y
(&
mddev
->
disks
))

4142  -
EBUSY
;

4144 i‡(
	`cmd_m©ch
(
buf
, "none")) {

4145 
mddev
->
≥rsi°ít
 = 0;

4146 
mddev
->
exã∫Æ
 = 0;

4147 
mddev
->
maj‹_vîsi⁄
 = 0;

4148 
mddev
->
mö‹_vîsi⁄
 = 90;

4149  
Àn
;

4151 i‡(
	`°∫cmp
(
buf
, "external:", 9) == 0) {

4152 
size_t
 
«mñí
 = 
Àn
-9;

4153 i‡(
«mñí
 >(
mddev
->
mëad©a_ty≥
))

4154 
«mñí
 = (
mddev
->
mëad©a_ty≥
)-1;

4155 
	`°∫˝y
(
mddev
->
mëad©a_ty≥
, 
buf
+9, 
«mñí
);

4156 
mddev
->
mëad©a_ty≥
[
«mñí
] = 0;

4157 i‡(
«mñí
 && 
mddev
->
mëad©a_ty≥
[namelen-1] == '\n')

4158 
mddev
->
mëad©a_ty≥
[--
«mñí
] = 0;

4159 
mddev
->
≥rsi°ít
 = 0;

4160 
mddev
->
exã∫Æ
 = 1;

4161 
mddev
->
maj‹_vîsi⁄
 = 0;

4162 
mddev
->
mö‹_vîsi⁄
 = 90;

4163  
Àn
;

4165 
maj‹
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

4166 i‡(
e
==
buf
 || *e != '.')

4167  -
EINVAL
;

4168 
buf
 = 
e
+1;

4169 
mö‹
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

4170 i‡(
e
==
buf
 || (*e && *e != '\n') )

4171  -
EINVAL
;

4172 i‡(
maj‹
 >
	`ARRAY_SIZE
(
su≥r_ty≥s
Ë|| su≥r_ty≥s[maj‹].
«me
 =
NULL
)

4173  -
ENOENT
;

4174 
mddev
->
maj‹_vîsi⁄
 = 
maj‹
;

4175 
mddev
->
mö‹_vîsi⁄
 = 
mö‹
;

4176 
mddev
->
≥rsi°ít
 = 1;

4177 
mddev
->
exã∫Æ
 = 0;

4178  
Àn
;

4179 
	}
}

4181 
md_sysfs_íåy
 
	gmd_mëad©a
 =

4182 
__ATTR
(
mëad©a_vîsi⁄
, 
S_IRUGO
|
S_IWUSR
, 
mëad©a_show
, 
mëad©a_°‹e
);

4184 
ssize_t


4185 
	$a˘i⁄_show
(
mddev
 *mddev, *
∑ge
)

4187 *
ty≥
 = "idle";

4188 i‡(
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
))

4189 
ty≥
 = "frozen";

4190 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
) ||

4191 (!
mddev
->
ro
 && 
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &mddev->
ªcovîy
))) {

4192 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

4193 
ty≥
 = "reshape";

4194 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

4195 i‡(!
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

4196 
ty≥
 = "resync";

4197 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
))

4198 
ty≥
 = "check";

4200 
ty≥
 = "repair";

4201 } i‡(
	`ã°_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
))

4202 
ty≥
 = "recover";

4204  
	`•rötf
(
∑ge
, "%s\n", 
ty≥
);

4205 
	}
}

4207 
ssize_t


4208 
	$a˘i⁄_°‹e
(
mddev
 *mddev, c⁄° *
∑ge
, 
size_t
 
Àn
)

4210 i‡(!
mddev
->
≥rs
 || !mddev->≥rs->
sync_ªque°
)

4211  -
EINVAL
;

4213 i‡(
	`cmd_m©ch
(
∑ge
, "frozen"))

4214 
	`£t_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

4216 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

4218 i‡(
	`cmd_m©ch
(
∑ge
, "idle") || cmd_match(page, "frozen")) {

4219 i‡(
mddev
->
sync_thªad
) {

4220 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

4221 
	`md_ª≠_sync_thªad
(
mddev
);

4223 } i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
) ||

4224 
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
))

4225  -
EBUSY
;

4226 i‡(
	`cmd_m©ch
(
∑ge
, "resync"))

4227 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

4228 i‡(
	`cmd_m©ch
(
∑ge
, "recover")) {

4229 
	`£t_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

4230 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

4231 } i‡(
	`cmd_m©ch
(
∑ge
, "reshape")) {

4232 
îr
;

4233 i‡(
mddev
->
≥rs
->
°¨t_ªsh≠e
 =
NULL
)

4234  -
EINVAL
;

4235 
îr
 = 
mddev
->
≥rs
->
	`°¨t_ªsh≠e
(mddev);

4236 i‡(
îr
)

4237  
îr
;

4238 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "degraded");

4240 i‡(
	`cmd_m©ch
(
∑ge
, "check"))

4241 
	`£t_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

4242 i‡(!
	`cmd_m©ch
(
∑ge
, "repair"))

4243  -
EINVAL
;

4244 
	`£t_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
);

4245 
	`£t_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

4247 i‡(
mddev
->
ro
 == 2) {

4251 
mddev
->
ro
 = 0;

4252 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

4254 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

4255 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4256 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_a˘i⁄
);

4257  
Àn
;

4258 
	}
}

4260 
md_sysfs_íåy
 
	gmd_sˇn_mode
 =

4261 
__ATTR
(
sync_a˘i⁄
, 
S_IRUGO
|
S_IWUSR
, 
a˘i⁄_show
, 
a˘i⁄_°‹e
);

4263 
ssize_t


4264 
	$œ°_sync_a˘i⁄_show
(
mddev
 *mddev, *
∑ge
)

4266  
	`•rötf
(
∑ge
, "%s\n", 
mddev
->
œ°_sync_a˘i⁄
);

4267 
	}
}

4269 
md_sysfs_íåy
 
	gmd_œ°_sˇn_mode
 = 
__ATTR_RO
(
œ°_sync_a˘i⁄
);

4271 
ssize_t


4272 
	$mism©ch_˙t_show
(
mddev
 *mddev, *
∑ge
)

4274  
	`•rötf
(
∑ge
, "%llu\n",

4276 
	`©omic64_ªad
(&
mddev
->
ªsync_mism©ches
));

4277 
	}
}

4279 
md_sysfs_íåy
 
	gmd_mism©ches
 = 
__ATTR_RO
(
mism©ch_˙t
);

4281 
ssize_t


4282 
	$sync_mö_show
(
mddev
 *mddev, *
∑ge
)

4284  
	`•rötf
(
∑ge
, "%d (%s)\n", 
	`•ìd_mö
(
mddev
),

4285 
mddev
->
sync_•ìd_mö
 ? "local": "system");

4286 
	}
}

4288 
ssize_t


4289 
	$sync_mö_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4291 
mö
;

4292 *
e
;

4293 i‡(
	`°∫cmp
(
buf
, "system", 6)==0) {

4294 
mddev
->
sync_•ìd_mö
 = 0;

4295  
Àn
;

4297 
mö
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

4298 i‡(
buf
 =
e
 || (*ê&& *ê!'\n'Ë|| 
mö
 <= 0)

4299  -
EINVAL
;

4300 
mddev
->
sync_•ìd_mö
 = 
mö
;

4301  
Àn
;

4302 
	}
}

4304 
md_sysfs_íåy
 
	gmd_sync_mö
 =

4305 
__ATTR
(
sync_•ìd_mö
, 
S_IRUGO
|
S_IWUSR
, 
sync_mö_show
, 
sync_mö_°‹e
);

4307 
ssize_t


4308 
	$sync_max_show
(
mddev
 *mddev, *
∑ge
)

4310  
	`•rötf
(
∑ge
, "%d (%s)\n", 
	`•ìd_max
(
mddev
),

4311 
mddev
->
sync_•ìd_max
 ? "local": "system");

4312 
	}
}

4314 
ssize_t


4315 
	$sync_max_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4317 
max
;

4318 *
e
;

4319 i‡(
	`°∫cmp
(
buf
, "system", 6)==0) {

4320 
mddev
->
sync_•ìd_max
 = 0;

4321  
Àn
;

4323 
max
 = 
	`sim∂e_°πoul
(
buf
, &
e
, 10);

4324 i‡(
buf
 =
e
 || (*ê&& *ê!'\n'Ë|| 
max
 <= 0)

4325  -
EINVAL
;

4326 
mddev
->
sync_•ìd_max
 = 
max
;

4327  
Àn
;

4328 
	}
}

4330 
md_sysfs_íåy
 
	gmd_sync_max
 =

4331 
__ATTR
(
sync_•ìd_max
, 
S_IRUGO
|
S_IWUSR
, 
sync_max_show
, 
sync_max_°‹e
);

4333 
ssize_t


4334 
	$degøded_show
(
mddev
 *mddev, *
∑ge
)

4336  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
degøded
);

4337 
	}
}

4338 
md_sysfs_íåy
 
	gmd_degøded
 = 
__ATTR_RO
(
degøded
);

4340 
ssize_t


4341 
	$sync_f‹˚_∑øŒñ_show
(
mddev
 *mddev, *
∑ge
)

4343  
	`•rötf
(
∑ge
, "%d\n", 
mddev
->
∑øŒñ_ªsync
);

4344 
	}
}

4346 
ssize_t


4347 
	$sync_f‹˚_∑øŒñ_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4349 
n
;

4351 i‡(
	`k°πﬁ
(
buf
, 10, &
n
))

4352  -
EINVAL
;

4354 i‡(
n
 != 0 &&Ç != 1)

4355  -
EINVAL
;

4357 
mddev
->
∑øŒñ_ªsync
 = 
n
;

4359 i‡(
mddev
->
sync_thªad
)

4360 
	`wake_up
(&
ªsync_waô
);

4362  
Àn
;

4363 
	}
}

4366 
md_sysfs_íåy
 
	gmd_sync_f‹˚_∑øŒñ
 =

4367 
__ATTR
(
sync_f‹˚_∑øŒñ
, 
S_IRUGO
|
S_IWUSR
,

4368 
sync_f‹˚_∑øŒñ_show
, 
sync_f‹˚_∑øŒñ_°‹e
);

4370 
ssize_t


4371 
	$sync_•ìd_show
(
mddev
 *mddev, *
∑ge
)

4373 
ªsync
, 
dt
, 
db
;

4374 i‡(
mddev
->
cuº_ªsync
 == 0)

4375  
	`•rötf
(
∑ge
, "none\n");

4376 
ªsync
 = 
mddev
->
cuº_m¨k_˙t
 - 
	`©omic_ªad
(&mddev->
ªcovîy_a˘ive
);

4377 
dt
 = (
jiffõs
 - 
mddev
->
ªsync_m¨k
Ë/ 
HZ
;

4378 i‡(!
dt
) dt++;

4379 
db
 = 
ªsync
 - 
mddev
->
ªsync_m¨k_˙t
;

4380  
	`•rötf
(
∑ge
, "%lu\n", 
db
/
dt
/2);

4381 
	}
}

4383 
md_sysfs_íåy
 
	gmd_sync_•ìd
 = 
__ATTR_RO
(
sync_•ìd
);

4385 
ssize_t


4386 
	$sync_com∂ëed_show
(
mddev
 *mddev, *
∑ge
)

4388 
max_£˘‹s
, 
ªsync
;

4390 i‡(!
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

4391  
	`•rötf
(
∑ge
, "none\n");

4393 i‡(
mddev
->
cuº_ªsync
 == 1 ||

4394 
mddev
->
cuº_ªsync
 == 2)

4395  
	`•rötf
(
∑ge
, "delayed\n");

4397 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) ||

4398 
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

4399 
max_£˘‹s
 = 
mddev
->
ªsync_max_£˘‹s
;

4401 
max_£˘‹s
 = 
mddev
->
dev_£˘‹s
;

4403 
ªsync
 = 
mddev
->
cuº_ªsync_com∂ëed
;

4404  
	`•rötf
(
∑ge
, "%Œu / %Œu\n", 
ªsync
, 
max_£˘‹s
);

4405 
	}
}

4407 
md_sysfs_íåy
 
	gmd_sync_com∂ëed
 = 
__ATTR_RO
(
sync_com∂ëed
);

4409 
ssize_t


4410 
	$mö_sync_show
(
mddev
 *mddev, *
∑ge
)

4412  
	`•rötf
(
∑ge
, "%llu\n",

4413 ()
mddev
->
ªsync_mö
);

4414 
	}
}

4415 
ssize_t


4416 
	$mö_sync_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4418 
mö
;

4419 i‡(
	`k°πouŒ
(
buf
, 10, &
mö
))

4420  -
EINVAL
;

4421 i‡(
mö
 > 
mddev
->
ªsync_max
)

4422  -
EINVAL
;

4423 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

4424  -
EBUSY
;

4427 i‡(
mddev
->
chunk_£˘‹s
) {

4428 
£˘‹_t
 
ãmp
 = 
mö
;

4429 i‡(
	`£˘‹_div
(
ãmp
, 
mddev
->
chunk_£˘‹s
))

4430  -
EINVAL
;

4432 
mddev
->
ªsync_mö
 = 
mö
;

4434  
Àn
;

4435 
	}
}

4437 
md_sysfs_íåy
 
	gmd_mö_sync
 =

4438 
__ATTR
(
sync_mö
, 
S_IRUGO
|
S_IWUSR
, 
mö_sync_show
, 
mö_sync_°‹e
);

4440 
ssize_t


4441 
	$max_sync_show
(
mddev
 *mddev, *
∑ge
)

4443 i‡(
mddev
->
ªsync_max
 =
MaxSe˘‹
)

4444  
	`•rötf
(
∑ge
, "max\n");

4446  
	`•rötf
(
∑ge
, "%llu\n",

4447 ()
mddev
->
ªsync_max
);

4448 
	}
}

4449 
ssize_t


4450 
	$max_sync_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4452 i‡(
	`°∫cmp
(
buf
, "max", 3) == 0)

4453 
mddev
->
ªsync_max
 = 
MaxSe˘‹
;

4455 
max
;

4456 i‡(
	`k°πouŒ
(
buf
, 10, &
max
))

4457  -
EINVAL
;

4458 i‡(
max
 < 
mddev
->
ªsync_mö
)

4459  -
EINVAL
;

4460 i‡(
max
 < 
mddev
->
ªsync_max
 &&

4461 
mddev
->
ro
 == 0 &&

4462 
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

4463  -
EBUSY
;

4466 i‡(
mddev
->
chunk_£˘‹s
) {

4467 
£˘‹_t
 
ãmp
 = 
max
;

4468 i‡(
	`£˘‹_div
(
ãmp
, 
mddev
->
chunk_£˘‹s
))

4469  -
EINVAL
;

4471 
mddev
->
ªsync_max
 = 
max
;

4473 
	`wake_up
(&
mddev
->
ªcovîy_waô
);

4474  
Àn
;

4475 
	}
}

4477 
md_sysfs_íåy
 
	gmd_max_sync
 =

4478 
__ATTR
(
sync_max
, 
S_IRUGO
|
S_IWUSR
, 
max_sync_show
, 
max_sync_°‹e
);

4480 
ssize_t


4481 
	$su•íd_lo_show
(
mddev
 *mddev, *
∑ge
)

4483  
	`•rötf
(
∑ge
, "%Œu\n", ()
mddev
->
su•íd_lo
);

4484 
	}
}

4486 
ssize_t


4487 
	$su•íd_lo_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4489 *
e
;

4490 
√w
 = 
	`sim∂e_°πouŒ
(
buf
, &
e
, 10);

4491 
ﬁd
 = 
mddev
->
su•íd_lo
;

4493 i‡(
mddev
->
≥rs
 =
NULL
 ||

4494 
mddev
->
≥rs
->
quõs˚
 =
NULL
)

4495  -
EINVAL
;

4496 i‡(
buf
 =
e
 || (*e && *e != '\n'))

4497  -
EINVAL
;

4499 
mddev
->
su•íd_lo
 = 
√w
;

4500 i‡(
√w
 >
ﬁd
)

4502 
mddev
->
≥rs
->
	`quõs˚
(mddev, 2);

4505 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

4506 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

4508  
Àn
;

4509 
	}
}

4510 
md_sysfs_íåy
 
	gmd_su•íd_lo
 =

4511 
__ATTR
(
su•íd_lo
, 
S_IRUGO
|
S_IWUSR
, 
su•íd_lo_show
, 
su•íd_lo_°‹e
);

4514 
ssize_t


4515 
	$su•íd_hi_show
(
mddev
 *mddev, *
∑ge
)

4517  
	`•rötf
(
∑ge
, "%Œu\n", ()
mddev
->
su•íd_hi
);

4518 
	}
}

4520 
ssize_t


4521 
	$su•íd_hi_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4523 *
e
;

4524 
√w
 = 
	`sim∂e_°πouŒ
(
buf
, &
e
, 10);

4525 
ﬁd
 = 
mddev
->
su•íd_hi
;

4527 i‡(
mddev
->
≥rs
 =
NULL
 ||

4528 
mddev
->
≥rs
->
quõs˚
 =
NULL
)

4529  -
EINVAL
;

4530 i‡(
buf
 =
e
 || (*e && *e != '\n'))

4531  -
EINVAL
;

4533 
mddev
->
su•íd_hi
 = 
√w
;

4534 i‡(
√w
 <
ﬁd
)

4536 
mddev
->
≥rs
->
	`quõs˚
(mddev, 2);

4539 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

4540 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

4542  
Àn
;

4543 
	}
}

4544 
md_sysfs_íåy
 
	gmd_su•íd_hi
 =

4545 
__ATTR
(
su•íd_hi
, 
S_IRUGO
|
S_IWUSR
, 
su•íd_hi_show
, 
su•íd_hi_°‹e
);

4547 
ssize_t


4548 
	$ªsh≠e_posôi⁄_show
(
mddev
 *mddev, *
∑ge
)

4550 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
)

4551  
	`•rötf
(
∑ge
, "%llu\n",

4552 ()
mddev
->
ªsh≠e_posôi⁄
);

4553 
	`°r˝y
(
∑ge
, "none\n");

4555 
	}
}

4557 
ssize_t


4558 
	$ªsh≠e_posôi⁄_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4560 
md_rdev
 *
rdev
;

4561 *
e
;

4562 
√w
 = 
	`sim∂e_°πouŒ
(
buf
, &
e
, 10);

4563 i‡(
mddev
->
≥rs
)

4564  -
EBUSY
;

4565 i‡(
buf
 =
e
 || (*e && *e != '\n'))

4566  -
EINVAL
;

4567 
mddev
->
ªsh≠e_posôi⁄
 = 
√w
;

4568 
mddev
->
dñè_disks
 = 0;

4569 
mddev
->
ªsh≠e_backw¨ds
 = 0;

4570 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

4571 
mddev
->
√w_œyout
 = mddev->
œyout
;

4572 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

4573 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

4574 
rdev
->
√w_d©a_off£t
 =Ñdev->
d©a_off£t
;

4575  
Àn
;

4576 
	}
}

4578 
md_sysfs_íåy
 
	gmd_ªsh≠e_posôi⁄
 =

4579 
__ATTR
(
ªsh≠e_posôi⁄
, 
S_IRUGO
|
S_IWUSR
, 
ªsh≠e_posôi⁄_show
,

4580 
ªsh≠e_posôi⁄_°‹e
);

4582 
ssize_t


4583 
	$ªsh≠e_dúe˘i⁄_show
(
mddev
 *mddev, *
∑ge
)

4585  
	`•rötf
(
∑ge
, "%s\n",

4586 
mddev
->
ªsh≠e_backw¨ds
 ? "backwards" : "forwards");

4587 
	}
}

4589 
ssize_t


4590 
	$ªsh≠e_dúe˘i⁄_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4592 
backw¨ds
 = 0;

4593 i‡(
	`cmd_m©ch
(
buf
, "forwards"))

4594 
backw¨ds
 = 0;

4595 i‡(
	`cmd_m©ch
(
buf
, "backwards"))

4596 
backw¨ds
 = 1;

4598  -
EINVAL
;

4599 i‡(
mddev
->
ªsh≠e_backw¨ds
 =
backw¨ds
)

4600  
Àn
;

4603 i‡(
mddev
->
dñè_disks
)

4604  -
EBUSY
;

4606 i‡(
mddev
->
≥rsi°ít
 &&

4607 
mddev
->
maj‹_vîsi⁄
 == 0)

4608  -
EINVAL
;

4610 
mddev
->
ªsh≠e_backw¨ds
 = 
backw¨ds
;

4611  
Àn
;

4612 
	}
}

4614 
md_sysfs_íåy
 
	gmd_ªsh≠e_dúe˘i⁄
 =

4615 
__ATTR
(
ªsh≠e_dúe˘i⁄
, 
S_IRUGO
|
S_IWUSR
, 
ªsh≠e_dúe˘i⁄_show
,

4616 
ªsh≠e_dúe˘i⁄_°‹e
);

4618 
ssize_t


4619 
	$¨øy_size_show
(
mddev
 *mddev, *
∑ge
)

4621 i‡(
mddev
->
exã∫Æ_size
)

4622  
	`•rötf
(
∑ge
, "%llu\n",

4623 ()
mddev
->
¨øy_£˘‹s
/2);

4625  
	`•rötf
(
∑ge
, "default\n");

4626 
	}
}

4628 
ssize_t


4629 
	$¨øy_size_°‹e
(
mddev
 *mddev, c⁄° *
buf
, 
size_t
 
Àn
)

4631 
£˘‹_t
 
£˘‹s
;

4633 i‡(
	`°∫cmp
(
buf
, "default", 7) == 0) {

4634 i‡(
mddev
->
≥rs
)

4635 
£˘‹s
 = 
mddev
->
≥rs
->
	`size
(mddev, 0, 0);

4637 
£˘‹s
 = 
mddev
->
¨øy_£˘‹s
;

4639 
mddev
->
exã∫Æ_size
 = 0;

4641 i‡(
	`°ri˘_blocks_to_£˘‹s
(
buf
, &
£˘‹s
) < 0)

4642  -
EINVAL
;

4643 i‡(
mddev
->
≥rs
 && mddev->≥rs->
	`size
(mddev, 0, 0Ë< 
£˘‹s
)

4644  -
E2BIG
;

4646 
mddev
->
exã∫Æ_size
 = 1;

4649 
mddev
->
¨øy_£˘‹s
 = 
£˘‹s
;

4650 i‡(
mddev
->
≥rs
) {

4651 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

4652 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

4654  
Àn
;

4655 
	}
}

4657 
md_sysfs_íåy
 
	gmd_¨øy_size
 =

4658 
__ATTR
(
¨øy_size
, 
S_IRUGO
|
S_IWUSR
, 
¨øy_size_show
,

4659 
¨øy_size_°‹e
);

4661 
©åibuã
 *
	gmd_deÁu…_©ås
[] = {

4662 &
md_Àvñ
.
©å
,

4663 &
md_œyout
.
©å
,

4664 &
md_øid_disks
.
©å
,

4665 &
md_chunk_size
.
©å
,

4666 &
md_size
.
©å
,

4667 &
md_ªsync_°¨t
.
©å
,

4668 &
md_mëad©a
.
©å
,

4669 &
md_√w_devi˚
.
©å
,

4670 &
md_ß„_dñay
.
©å
,

4671 &
md_¨øy_°©e
.
©å
,

4672 &
md_ªsh≠e_posôi⁄
.
©å
,

4673 &
md_ªsh≠e_dúe˘i⁄
.
©å
,

4674 &
md_¨øy_size
.
©å
,

4675 &
max_c‹r_ªad_îr‹s
.
©å
,

4676 
NULL
,

4679 
©åibuã
 *
	gmd_ªdund™cy_©ås
[] = {

4680 &
md_sˇn_mode
.
©å
,

4681 &
md_œ°_sˇn_mode
.
©å
,

4682 &
md_mism©ches
.
©å
,

4683 &
md_sync_mö
.
©å
,

4684 &
md_sync_max
.
©å
,

4685 &
md_sync_•ìd
.
©å
,

4686 &
md_sync_f‹˚_∑øŒñ
.
©å
,

4687 &
md_sync_com∂ëed
.
©å
,

4688 &
md_mö_sync
.
©å
,

4689 &
md_max_sync
.
©å
,

4690 &
md_su•íd_lo
.
©å
,

4691 &
md_su•íd_hi
.
©å
,

4692 &
md_bôm≠
.
©å
,

4693 &
md_degøded
.
©å
,

4694 
NULL
,

4696 
©åibuã_group
 
	gmd_ªdund™cy_group
 = {

4697 .
«me
 = 
NULL
,

4698 .
	g©ås
 = 
md_ªdund™cy_©ås
,

4702 
ssize_t


4703 
	$md_©å_show
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
, *
∑ge
)

4705 
md_sysfs_íåy
 *
íåy
 = 
	`c⁄èöî_of
(
©å
, md_sysfs_entry,áttr);

4706 
mddev
 *mddev = 
	`c⁄èöî_of
(
kobj
, mddev, kobj);

4707 
ssize_t
 
rv
;

4709 i‡(!
íåy
->
show
)

4710  -
EIO
;

4711 
	`•ö_lock
(&
Æl_mddevs_lock
);

4712 i‡(
	`li°_em±y
(&
mddev
->
Æl_mddevs
)) {

4713 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4714  -
EBUSY
;

4716 
	`mddev_gë
(
mddev
);

4717 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4719 
rv
 = 
	`mddev_lock
(
mddev
);

4720 i‡(!
rv
) {

4721 
rv
 = 
íåy
->
	`show
(
mddev
, 
∑ge
);

4722 
	`mddev_u∆ock
(
mddev
);

4724 
	`mddev_put
(
mddev
);

4725  
rv
;

4726 
	}
}

4728 
ssize_t


4729 
	$md_©å_°‹e
(
kobje˘
 *
kobj
, 
©åibuã
 *
©å
,

4730 c⁄° *
∑ge
, 
size_t
 
Àngth
)

4732 
md_sysfs_íåy
 *
íåy
 = 
	`c⁄èöî_of
(
©å
, md_sysfs_entry,áttr);

4733 
mddev
 *mddev = 
	`c⁄èöî_of
(
kobj
, mddev, kobj);

4734 
ssize_t
 
rv
;

4736 i‡(!
íåy
->
°‹e
)

4737  -
EIO
;

4738 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

4739  -
EACCES
;

4740 
	`•ö_lock
(&
Æl_mddevs_lock
);

4741 i‡(
	`li°_em±y
(&
mddev
->
Æl_mddevs
)) {

4742 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4743  -
EBUSY
;

4745 
	`mddev_gë
(
mddev
);

4746 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4747 i‡(
íåy
->
°‹e
 =
√w_dev_°‹e
)

4748 
	`Êush_w‹kqueue
(
md_misc_wq
);

4749 
rv
 = 
	`mddev_lock
(
mddev
);

4750 i‡(!
rv
) {

4751 
rv
 = 
íåy
->
	`°‹e
(
mddev
, 
∑ge
, 
Àngth
);

4752 
	`mddev_u∆ock
(
mddev
);

4754 
	`mddev_put
(
mddev
);

4755  
rv
;

4756 
	}
}

4758 
	$md_‰ì
(
kobje˘
 *
ko
)

4760 
mddev
 *mddev = 
	`c⁄èöî_of
(
ko
, mddev, 
kobj
);

4762 i‡(
mddev
->
sysfs_°©e
)

4763 
	`sysfs_put
(
mddev
->
sysfs_°©e
);

4765 i‡(
mddev
->
gídisk
) {

4766 
	`dñ_gídisk
(
mddev
->
gídisk
);

4767 
	`put_disk
(
mddev
->
gídisk
);

4769 i‡(
mddev
->
queue
)

4770 
	`blk_˛ónup_queue
(
mddev
->
queue
);

4772 
	`k‰ì
(
mddev
);

4773 
	}
}

4775 c⁄° 
sysfs_›s
 
	gmd_sysfs_›s
 = {

4776 .
show
 = 
md_©å_show
,

4777 .
	g°‹e
 = 
md_©å_°‹e
,

4779 
kobj_ty≥
 
	gmd_kty≥
 = {

4780 .
ªÀa£
 = 
md_‰ì
,

4781 .
	gsysfs_›s
 = &
md_sysfs_›s
,

4782 .
	gdeÁu…_©ås
 = 
md_deÁu…_©ås
,

4785 
	gmdp_maj‹
 = 0;

4787 
	$mddev_dñayed_dñëe
(
w‹k_°ru˘
 *
ws
)

4789 
mddev
 *mddev = 
	`c⁄èöî_of
(
ws
, mddev, 
dñ_w‹k
);

4791 
	`sysfs_ªmove_group
(&
mddev
->
kobj
, &
md_bôm≠_group
);

4792 
	`kobje˘_dñ
(&
mddev
->
kobj
);

4793 
	`kobje˘_put
(&
mddev
->
kobj
);

4794 
	}
}

4796 
	$md_Æloc
(
dev_t
 
dev
, *
«me
)

4798 
	`DEFINE_MUTEX
(
disks_muãx
);

4799 
mddev
 *mddev = 
	`mddev_föd
(
dev
);

4800 
gídisk
 *
disk
;

4801 
∑πôi⁄ed
;

4802 
shi·
;

4803 
unô
;

4804 
îr‹
;

4806 i‡(!
mddev
)

4807  -
ENODEV
;

4809 
∑πôi⁄ed
 = (
	`MAJOR
(
mddev
->
unô
Ë!
MD_MAJOR
);

4810 
shi·
 = 
∑πôi⁄ed
 ? 
MdpMö‹Shi·
 : 0;

4811 
unô
 = 
	`MINOR
(
mddev
->unôË>> 
shi·
;

4816 
	`Êush_w‹kqueue
(
md_misc_wq
);

4818 
	`muãx_lock
(&
disks_muãx
);

4819 
îr‹
 = -
EEXIST
;

4820 i‡(
mddev
->
gídisk
)

4821 
ab‹t
;

4823 i‡(
«me
) {

4826 
mddev
 *
mddev2
;

4827 
	`•ö_lock
(&
Æl_mddevs_lock
);

4829 
	`li°_f‹_óch_íåy
(
mddev2
, &
Æl_mddevs
,áll_mddevs)

4830 i‡(
mddev2
->
gídisk
 &&

4831 
	`°rcmp
(
mddev2
->
gídisk
->
disk_«me
, 
«me
) == 0) {

4832 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4833 
ab‹t
;

4835 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

4838 
îr‹
 = -
ENOMEM
;

4839 
mddev
->
queue
 = 
	`blk_Æloc_queue
(
GFP_KERNEL
);

4840 i‡(!
mddev
->
queue
)

4841 
ab‹t
;

4842 
mddev
->
queue
->
queued©a
 = mddev;

4844 
	`blk_queue_make_ªque°
(
mddev
->
queue
, 
md_make_ªque°
);

4845 
	`blk_£t_°ackög_limôs
(&
mddev
->
queue
->
limôs
);

4847 
disk
 = 
	`Æloc_disk
(1 << 
shi·
);

4848 i‡(!
disk
) {

4849 
	`blk_˛ónup_queue
(
mddev
->
queue
);

4850 
mddev
->
queue
 = 
NULL
;

4851 
ab‹t
;

4853 
disk
->
maj‹
 = 
	`MAJOR
(
mddev
->
unô
);

4854 
disk
->
fú°_mö‹
 = 
unô
 << 
shi·
;

4855 i‡(
«me
)

4856 
	`°r˝y
(
disk
->
disk_«me
, 
«me
);

4857 i‡(
∑πôi⁄ed
)

4858 
	`•rötf
(
disk
->
disk_«me
, "md_d%d", 
unô
);

4860 
	`•rötf
(
disk
->
disk_«me
, "md%d", 
unô
);

4861 
disk
->
f›s
 = &
md_f›s
;

4862 
disk
->
¥iv©e_d©a
 = 
mddev
;

4863 
disk
->
queue
 = 
mddev
->queue;

4864 
	`blk_queue_Êush
(
mddev
->
queue
, 
REQ_FLUSH
 | 
REQ_FUA
);

4869 
disk
->
Êags
 |
GENHD_FL_EXT_DEVT
;

4870 
mddev
->
gídisk
 = 
disk
;

4874 
	`muãx_lock
(&
mddev
->
›í_muãx
);

4875 
	`add_disk
(
disk
);

4877 
îr‹
 = 
	`kobje˘_öô_™d_add
(&
mddev
->
kobj
, &
md_kty≥
,

4878 &
	`disk_to_dev
(
disk
)->
kobj
, "%s", "md");

4879 i‡(
îr‹
) {

4883 
	`¥ötk
(
KERN_WARNING
 "md: cannotÑegister %s/md -Çame in use\n",

4884 
disk
->
disk_«me
);

4885 
îr‹
 = 0;

4887 i‡(
mddev
->
kobj
.
sd
 &&

4888 
	`sysfs_¸óã_group
(&
mddev
->
kobj
, &
md_bôm≠_group
))

4889 
	`¥ötk
(
KERN_DEBUG
 "pointless warning\n");

4890 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

4891 
ab‹t
:

4892 
	`muãx_u∆ock
(&
disks_muãx
);

4893 i‡(!
îr‹
 && 
mddev
->
kobj
.
sd
) {

4894 
	`kobje˘_uevít
(&
mddev
->
kobj
, 
KOBJ_ADD
);

4895 
mddev
->
sysfs_°©e
 = 
	`sysfs_gë_dúít_ß„
(mddev->
kobj
.
sd
, "array_state");

4897 
	`mddev_put
(
mddev
);

4898  
îr‹
;

4899 
	}
}

4901 
kobje˘
 *
	$md_¥obe
(
dev_t
 
dev
, *
∑π
, *
d©a
)

4903 
	`md_Æloc
(
dev
, 
NULL
);

4904  
NULL
;

4905 
	}
}

4907 
	$add_«med_¨øy
(c⁄° *
vÆ
, 
kî√l_∑øm
 *
kp
)

4913 
Àn
 = 
	`°æí
(
vÆ
);

4914 
buf
[
DISK_NAME_LEN
];

4916 
Àn
 && 
vÆ
[len-1] == '\n')

4917 
Àn
--;

4918 i‡(
Àn
 >
DISK_NAME_LEN
)

4919  -
E2BIG
;

4920 
	`°æ˝y
(
buf
, 
vÆ
, 
Àn
+1);

4921 i‡(
	`°∫cmp
(
buf
, "md_", 3) != 0)

4922  -
EINVAL
;

4923  
	`md_Æloc
(0, 
buf
);

4924 
	}
}

4926 
	$md_ß„mode_timeout
(
d©a
)

4928 
mddev
 *mddev = (mddev *Ë
d©a
;

4930 i‡(!
	`©omic_ªad
(&
mddev
->
wrôes_≥ndög
)) {

4931 
mddev
->
ß„mode
 = 1;

4932 i‡(
mddev
->
exã∫Æ
)

4933 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

4935 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4936 
	}
}

4938 
	g°¨t_dúty_degøded
;

4940 
	$md_run
(
mddev
 *mddev)

4942 
îr
;

4943 
md_rdev
 *
rdev
;

4944 
md_≥rs⁄Æôy
 *
≥rs
;

4946 i‡(
	`li°_em±y
(&
mddev
->
disks
))

4948  -
EINVAL
;

4950 i‡(
mddev
->
≥rs
)

4951  -
EBUSY
;

4953 i‡(
mddev
->
sysfs_a˘ive
)

4954  -
EBUSY
;

4959 i‡(!
mddev
->
øid_disks
) {

4960 i‡(!
mddev
->
≥rsi°ít
)

4961  -
EINVAL
;

4962 
	`™Æyze_sbs
(
mddev
);

4965 i‡(
mddev
->
Àvñ
 !
LEVEL_NONE
)

4966 
	`ªque°_moduÀ
("md-Àvñ-%d", 
mddev
->
Àvñ
);

4967 i‡(
mddev
->
˛evñ
[0])

4968 
	`ªque°_moduÀ
("md-%s", 
mddev
->
˛evñ
);

4975 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

4976 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

4978 
	`sync_blockdev
(
rdev
->
bdev
);

4979 
	`övÆid©e_bdev
(
rdev
->
bdev
);

4985 i‡(
rdev
->
mëa_bdev
) {

4987 } i‡(
rdev
->
d©a_off£t
 <Ñdev->
sb_°¨t
) {

4988 i‡(
mddev
->
dev_£˘‹s
 &&

4989 
rdev
->
d©a_off£t
 + 
mddev
->
dev_£˘‹s


4990 > 
rdev
->
sb_°¨t
) {

4991 
	`¥ötk
("md: %s: data overlaps metadata\n",

4992 
	`md«me
(
mddev
));

4993  -
EINVAL
;

4996 i‡(
rdev
->
sb_°¨t
 +Ñdev->
sb_size
/512

4997 > 
rdev
->
d©a_off£t
) {

4998 
	`¥ötk
("md: %s: metadata overlaps data\n",

4999 
	`md«me
(
mddev
));

5000  -
EINVAL
;

5003 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

5006 i‡(
mddev
->
bio_£t
 =
NULL
)

5007 
mddev
->
bio_£t
 = 
	`bio£t_¸óã
(
BIO_POOL_SIZE
, 0);

5009 
	`•ö_lock
(&
≥rs_lock
);

5010 
≥rs
 = 
	`föd_≥rs
(
mddev
->
Àvñ
, mddev->
˛evñ
);

5011 i‡(!
≥rs
 || !
	`åy_moduÀ_gë
’îs->
ow√r
)) {

5012 
	`•ö_u∆ock
(&
≥rs_lock
);

5013 i‡(
mddev
->
Àvñ
 !
LEVEL_NONE
)

5014 
	`¥ötk
(
KERN_WARNING
 "md:Öersonality forÜevel %d isÇotÜoaded!\n",

5015 
mddev
->
Àvñ
);

5017 
	`¥ötk
(
KERN_WARNING
 "md:Öersonality forÜevel %s isÇotÜoaded!\n",

5018 
mddev
->
˛evñ
);

5019  -
EINVAL
;

5021 
mddev
->
≥rs
 =Öers;

5022 
	`•ö_u∆ock
(&
≥rs_lock
);

5023 i‡(
mddev
->
Àvñ
 !
≥rs
->level) {

5024 
mddev
->
Àvñ
 = 
≥rs
->level;

5025 
mddev
->
√w_Àvñ
 = 
≥rs
->
Àvñ
;

5027 
	`°æ˝y
(
mddev
->
˛evñ
, 
≥rs
->
«me
, (mddev->clevel));

5029 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
 &&

5030 
≥rs
->
°¨t_ªsh≠e
 =
NULL
) {

5032 
mddev
->
≥rs
 = 
NULL
;

5033 
	`moduÀ_put
(
≥rs
->
ow√r
);

5034  -
EINVAL
;

5037 i‡(
≥rs
->
sync_ªque°
) {

5041 
b
[
BDEVNAME_SIZE
], 
b2
[BDEVNAME_SIZE];

5042 
md_rdev
 *
rdev2
;

5043 
w¨√d
 = 0;

5045 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

5046 
	`rdev_f‹_óch
(
rdev2
, 
mddev
) {

5047 i‡(
rdev
 < 
rdev2
 &&

5048 
rdev
->
bdev
->
bd_c⁄èös
 ==

5049 
rdev2
->
bdev
->
bd_c⁄èös
) {

5050 
	`¥ötk
(
KERN_WARNING


5054 
	`md«me
(
mddev
),

5055 
	`bdev«me
(
rdev
->
bdev
,
b
),

5056 
	`bdev«me
(
rdev2
->
bdev
,
b2
));

5057 
w¨√d
 = 1;

5061 i‡(
w¨√d
)

5062 
	`¥ötk
(
KERN_WARNING


5067 
mddev
->
ªcovîy
 = 0;

5069 
mddev
->
ªsync_max_£˘‹s
 = mddev->
dev_£˘‹s
;

5071 
mddev
->
ok_°¨t_degøded
 = 
°¨t_dúty_degøded
;

5073 i‡(
°¨t_ªad⁄ly
 && 
mddev
->
ro
 == 0)

5074 
mddev
->
ro
 = 2;

5076 
îr
 = 
mddev
->
≥rs
->
	`run
(mddev);

5077 i‡(
îr
)

5078 
	`¥ötk
(
KERN_ERR
 "md:Öers->run() failed ...\n");

5079 i‡(
mddev
->
≥rs
->
	`size
(mddev, 0, 0Ë< mddev->
¨øy_£˘‹s
) {

5080 
	`WARN_ONCE
(!
mddev
->
exã∫Æ_size
, "%s: default sizeÅoo small,"

5081 " buà'exã∫Æ_size'ÇŸ i¿ef„˘?\n", 
__func__
);

5082 
	`¥ötk
(
KERN_ERR


5084 ()
mddev
->
¨øy_£˘‹s
 / 2,

5085 ()
mddev
->
≥rs
->
	`size
(mddev, 0, 0) / 2);

5086 
îr
 = -
EINVAL
;

5087 
mddev
->
≥rs
->
	`°›
(mddev);

5089 i‡(
îr
 =0 && 
mddev
->
≥rs
->
sync_ªque°
 &&

5090 (
mddev
->
bôm≠_öfo
.
fûe
 || mddev->bôm≠_öfo.
off£t
)) {

5091 
îr
 = 
	`bôm≠_¸óã
(
mddev
);

5092 i‡(
îr
) {

5093 
	`¥ötk
(
KERN_ERR
 "%s: failedÅo create bitmap (%d)\n",

5094 
	`md«me
(
mddev
), 
îr
);

5095 
mddev
->
≥rs
->
	`°›
(mddev);

5098 i‡(
îr
) {

5099 
	`moduÀ_put
(
mddev
->
≥rs
->
ow√r
);

5100 
mddev
->
≥rs
 = 
NULL
;

5101 
	`bôm≠_de°roy
(
mddev
);

5102  
îr
;

5104 i‡(
mddev
->
≥rs
->
sync_ªque°
) {

5105 i‡(
mddev
->
kobj
.
sd
 &&

5106 
	`sysfs_¸óã_group
(&
mddev
->
kobj
, &
md_ªdund™cy_group
))

5107 
	`¥ötk
(
KERN_WARNING


5109 
	`md«me
(
mddev
));

5110 
mddev
->
sysfs_a˘i⁄
 = 
	`sysfs_gë_dúít_ß„
(mddev->
kobj
.
sd
, "sync_action");

5111 } i‡(
mddev
->
ro
 == 2)

5112 
mddev
->
ro
 = 0;

5114 
	`©omic_£t
(&
mddev
->
wrôes_≥ndög
,0);

5115 
	`©omic_£t
(&
mddev
->
max_c‹r_ªad_îr‹s
,

5116 
MD_DEFAULT_MAX_CORRECTED_READ_ERRORS
);

5117 
mddev
->
ß„mode
 = 0;

5118 
mddev
->
ß„mode_timî
.
fun˘i⁄
 = 
md_ß„mode_timeout
;

5119 
mddev
->
ß„mode_timî
.
d©a
 = () mddev;

5120 
mddev
->
ß„mode_dñay
 = (200 * 
HZ
)/1000 +1;

5121 
mddev
->
ö_sync
 = 1;

5122 
	`smp_wmb
();

5123 
mddev
->
ªady
 = 1;

5124 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

5125 i‡(
rdev
->
øid_disk
 >= 0)

5126 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

5129 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

5131 i‡(
mddev
->
Êags
 & 
MD_UPDATE_SB_FLAGS
)

5132 
	`md_upd©e_sb
(
mddev
, 0);

5134 
	`md_√w_evít
(
mddev
);

5135 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

5136 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_a˘i⁄
);

5137 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "degraded");

5139 
	}
}

5140 
EXPORT_SYMBOL_GPL
(
md_run
);

5142 
	$do_md_run
(
mddev
 *mddev)

5144 
îr
;

5146 
îr
 = 
	`md_run
(
mddev
);

5147 i‡(
îr
)

5148 
out
;

5149 
îr
 = 
	`bôm≠_lﬂd
(
mddev
);

5150 i‡(
îr
) {

5151 
	`bôm≠_de°roy
(
mddev
);

5152 
out
;

5155 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5156 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

5158 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

5159 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

5160 
mddev
->
ch™ged
 = 1;

5161 
	`kobje˘_uevít
(&
	`disk_to_dev
(
mddev
->
gídisk
)->
kobj
, 
KOBJ_CHANGE
);

5162 
out
:

5163  
îr
;

5164 
	}
}

5166 
	$ª°¨t_¨øy
(
mddev
 *mddev)

5168 
gídisk
 *
disk
 = 
mddev
->gendisk;

5171 i‡(
	`li°_em±y
(&
mddev
->
disks
))

5172  -
ENXIO
;

5173 i‡(!
mddev
->
≥rs
)

5174  -
EINVAL
;

5175 i‡(!
mddev
->
ro
)

5176  -
EBUSY
;

5177 
mddev
->
ß„mode
 = 0;

5178 
mddev
->
ro
 = 0;

5179 
	`£t_disk_ro
(
disk
, 0);

5180 
	`¥ötk
(
KERN_INFO
 "md: %s switchedÅoÑead-write mode.\n",

5181 
	`md«me
(
mddev
));

5183 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

5184 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5185 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

5186 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

5188 
	}
}

5190 
	$md_˛ón
(
mddev
 *mddev)

5192 
mddev
->
¨øy_£˘‹s
 = 0;

5193 
mddev
->
exã∫Æ_size
 = 0;

5194 
mddev
->
dev_£˘‹s
 = 0;

5195 
mddev
->
øid_disks
 = 0;

5196 
mddev
->
ªcovîy_˝
 = 0;

5197 
mddev
->
ªsync_mö
 = 0;

5198 
mddev
->
ªsync_max
 = 
MaxSe˘‹
;

5199 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

5200 
mddev
->
exã∫Æ
 = 0;

5201 
mddev
->
≥rsi°ít
 = 0;

5202 
mddev
->
Àvñ
 = 
LEVEL_NONE
;

5203 
mddev
->
˛evñ
[0] = 0;

5204 
mddev
->
Êags
 = 0;

5205 
mddev
->
ro
 = 0;

5206 
mddev
->
mëad©a_ty≥
[0] = 0;

5207 
mddev
->
chunk_£˘‹s
 = 0;

5208 
mddev
->
˘ime
 = mddev->
utime
 = 0;

5209 
mddev
->
œyout
 = 0;

5210 
mddev
->
max_disks
 = 0;

5211 
mddev
->
evíts
 = 0;

5212 
mddev
->
ˇn_de¸ó£_evíts
 = 0;

5213 
mddev
->
dñè_disks
 = 0;

5214 
mddev
->
ªsh≠e_backw¨ds
 = 0;

5215 
mddev
->
√w_Àvñ
 = 
LEVEL_NONE
;

5216 
mddev
->
√w_œyout
 = 0;

5217 
mddev
->
√w_chunk_£˘‹s
 = 0;

5218 
mddev
->
cuº_ªsync
 = 0;

5219 
	`©omic64_£t
(&
mddev
->
ªsync_mism©ches
, 0);

5220 
mddev
->
su•íd_lo
 = mddev->
su•íd_hi
 = 0;

5221 
mddev
->
sync_•ìd_mö
 = mddev->
sync_•ìd_max
 = 0;

5222 
mddev
->
ªcovîy
 = 0;

5223 
mddev
->
ö_sync
 = 0;

5224 
mddev
->
ch™ged
 = 0;

5225 
mddev
->
degøded
 = 0;

5226 
mddev
->
ß„mode
 = 0;

5227 
mddev
->
mîge_check_√eded
 = 0;

5228 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

5229 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 = 0;

5230 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
 = 0;

5231 
mddev
->
bôm≠_öfo
.
chunksize
 = 0;

5232 
mddev
->
bôm≠_öfo
.
d´m⁄_¶ìp
 = 0;

5233 
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
 = 0;

5234 
	}
}

5236 
	$__md_°›_wrôes
(
mddev
 *mddev)

5238 
	`£t_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5239 i‡(
mddev
->
sync_thªad
) {

5240 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

5241 
	`md_ª≠_sync_thªad
(
mddev
);

5244 
	`dñ_timî_sync
(&
mddev
->
ß„mode_timî
);

5246 
	`bôm≠_Êush
(
mddev
);

5247 
	`md_su≥r_waô
(
mddev
);

5249 i‡(
mddev
->
ro
 == 0 &&

5250 (!
mddev
->
ö_sync
 || (mddev->
Êags
 & 
MD_UPDATE_SB_FLAGS
))) {

5252 
mddev
->
ö_sync
 = 1;

5253 
	`md_upd©e_sb
(
mddev
, 1);

5255 
	}
}

5257 
	$md_°›_wrôes
(
mddev
 *mddev)

5259 
	`mddev_lock_noöå
(
mddev
);

5260 
	`__md_°›_wrôes
(
mddev
);

5261 
	`mddev_u∆ock
(
mddev
);

5262 
	}
}

5263 
EXPORT_SYMBOL_GPL
(
md_°›_wrôes
);

5265 
	$__md_°›
(
mddev
 *mddev)

5267 
mddev
->
ªady
 = 0;

5268 
mddev
->
≥rs
->
	`°›
(mddev);

5269 i‡(
mddev
->
≥rs
->
sync_ªque°
 && mddev->
to_ªmove
 =
NULL
)

5270 
mddev
->
to_ªmove
 = &
md_ªdund™cy_group
;

5271 
	`moduÀ_put
(
mddev
->
≥rs
->
ow√r
);

5272 
mddev
->
≥rs
 = 
NULL
;

5273 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5274 
	}
}

5276 
	$md_°›
(
mddev
 *mddev)

5281 
	`__md_°›
(
mddev
);

5282 
	`bôm≠_de°roy
(
mddev
);

5283 i‡(
mddev
->
bio_£t
)

5284 
	`bio£t_‰ì
(
mddev
->
bio_£t
);

5285 
	}
}

5287 
EXPORT_SYMBOL_GPL
(
md_°›
);

5289 
	$md_£t_ªad⁄ly
(
mddev
 *mddev, 
block_devi˚
 *
bdev
)

5291 
îr
 = 0;

5292 
did_‰ìze
 = 0;

5294 i‡(!
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
)) {

5295 
did_‰ìze
 = 1;

5296 
	`£t_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5297 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5299 i‡(
mddev
->
sync_thªad
) {

5300 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

5303 
	`wake_up_¥o˚ss
(
mddev
->
sync_thªad
->
tsk
);

5305 
	`mddev_u∆ock
(
mddev
);

5306 
	`waô_evít
(
ªsync_waô
, 
mddev
->
sync_thªad
 =
NULL
);

5307 
	`mddev_lock_noöå
(
mddev
);

5309 
	`muãx_lock
(&
mddev
->
›í_muãx
);

5310 i‡(
	`©omic_ªad
(&
mddev
->
›íîs
Ë> !!
bdev
 ||

5311 
mddev
->
sync_thªad
 ||

5312 (
bdev
 && !
	`ã°_bô
(
MD_STILL_CLOSED
, &
mddev
->
Êags
))) {

5313 
	`¥ötk
("md: %†°û»ö u£.\n",
	`md«me
(
mddev
));

5314 i‡(
did_‰ìze
) {

5315 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5316 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5318 
îr
 = -
EBUSY
;

5319 
out
;

5321 i‡(
mddev
->
≥rs
) {

5322 
	`__md_°›_wrôes
(
mddev
);

5324 
îr
 = -
ENXIO
;

5325 i‡(
mddev
->
ro
==1)

5326 
out
;

5327 
mddev
->
ro
 = 1;

5328 
	`£t_disk_ro
(
mddev
->
gídisk
, 1);

5329 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5330 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

5331 
îr
 = 0;

5333 
out
:

5334 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

5335  
îr
;

5336 
	}
}

5342 
	$do_md_°›
(
mddev
 * mddev, 
mode
,

5343 
block_devi˚
 *
bdev
)

5345 
gídisk
 *
disk
 = 
mddev
->gendisk;

5346 
md_rdev
 *
rdev
;

5347 
did_‰ìze
 = 0;

5349 i‡(!
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
)) {

5350 
did_‰ìze
 = 1;

5351 
	`£t_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5352 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5354 i‡(
mddev
->
sync_thªad
) {

5355 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

5358 
	`wake_up_¥o˚ss
(
mddev
->
sync_thªad
->
tsk
);

5360 
	`mddev_u∆ock
(
mddev
);

5361 
	`waô_evít
(
ªsync_waô
, 
mddev
->
sync_thªad
 =
NULL
);

5362 
	`mddev_lock_noöå
(
mddev
);

5364 
	`muãx_lock
(&
mddev
->
›í_muãx
);

5365 i‡(
	`©omic_ªad
(&
mddev
->
›íîs
Ë> !!
bdev
 ||

5366 
mddev
->
sysfs_a˘ive
 ||

5367 
mddev
->
sync_thªad
 ||

5368 (
bdev
 && !
	`ã°_bô
(
MD_STILL_CLOSED
, &
mddev
->
Êags
))) {

5369 
	`¥ötk
("md: %†°û»ö u£.\n",
	`md«me
(
mddev
));

5370 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

5371 i‡(
did_‰ìze
) {

5372 
	`˛ór_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
);

5373 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5375  -
EBUSY
;

5377 i‡(
mddev
->
≥rs
) {

5378 i‡(
mddev
->
ro
)

5379 
	`£t_disk_ro
(
disk
, 0);

5381 
	`__md_°›_wrôes
(
mddev
);

5382 
	`__md_°›
(
mddev
);

5383 
mddev
->
queue
->
mîge_bvec_‚
 = 
NULL
;

5384 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
NULL
;

5387 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

5389 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

5390 i‡(
rdev
->
øid_disk
 >= 0)

5391 
	`sysfs_u∆ök_rdev
(
mddev
, 
rdev
);

5393 
	`£t_ˇ∑côy
(
disk
, 0);

5394 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

5395 
mddev
->
ch™ged
 = 1;

5396 
	`ªvÆid©e_disk
(
disk
);

5398 i‡(
mddev
->
ro
)

5399 
mddev
->
ro
 = 0;

5401 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

5405 i‡(
mode
 == 0) {

5406 
	`¥ötk
(
KERN_INFO
 "md: %†°›≥d.\n", 
	`md«me
(
mddev
));

5408 
	`bôm≠_de°roy
(
mddev
);

5409 i‡(
mddev
->
bôm≠_öfo
.
fûe
) {

5410 
	`Âut
(
mddev
->
bôm≠_öfo
.
fûe
);

5411 
mddev
->
bôm≠_öfo
.
fûe
 = 
NULL
;

5413 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

5415 
	`exp‹t_¨øy
(
mddev
);

5417 
	`md_˛ón
(
mddev
);

5418 
	`kobje˘_uevít
(&
	`disk_to_dev
(
mddev
->
gídisk
)->
kobj
, 
KOBJ_CHANGE
);

5419 i‡(
mddev
->
hﬁd_a˘ive
 =
UNTIL_STOP
)

5420 
mddev
->
hﬁd_a˘ive
 = 0;

5422 
	`blk_öãgrôy_uƒegi°î
(
disk
);

5423 
	`md_√w_evít
(
mddev
);

5424 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

5426 
	}
}

5428 #i‚de‡
MODULE


5429 
	$aut‹un_¨øy
(
mddev
 *mddev)

5431 
md_rdev
 *
rdev
;

5432 
îr
;

5434 i‡(
	`li°_em±y
(&
mddev
->
disks
))

5437 
	`¥ötk
(
KERN_INFO
 "md:Ñunning: ");

5439 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

5440 
b
[
BDEVNAME_SIZE
];

5441 
	`¥ötk
("<%s>", 
	`bdev«me
(
rdev
->
bdev
,
b
));

5443 
	`¥ötk
("\n");

5445 
îr
 = 
	`do_md_run
(
mddev
);

5446 i‡(
îr
) {

5447 
	`¥ötk
(
KERN_WARNING
 "md: do_md_run(Ëªtu∫ed %d\n", 
îr
);

5448 
	`do_md_°›
(
mddev
, 0, 
NULL
);

5450 
	}
}

5464 
	$aut‹un_devi˚s
(
∑π
)

5466 
md_rdev
 *
rdev0
, *
rdev
, *
tmp
;

5467 
mddev
 *mddev;

5468 
b
[
BDEVNAME_SIZE
];

5470 
	`¥ötk
(
KERN_INFO
 "md:áutorun ...\n");

5471 !
	`li°_em±y
(&
≥ndög_øid_disks
)) {

5472 
unô
;

5473 
dev_t
 
dev
;

5474 
	`LIST_HEAD
(
ˇndid©es
);

5475 
rdev0
 = 
	`li°_íåy
(
≥ndög_øid_disks
.
√xt
,

5476 
md_rdev
, 
ßme_£t
);

5478 
	`¥ötk
(
KERN_INFO
 "md: considering %s ...\n",

5479 
	`bdev«me
(
rdev0
->
bdev
,
b
));

5480 
	`INIT_LIST_HEAD
(&
ˇndid©es
);

5481 
	`rdev_f‹_óch_li°
(
rdev
, 
tmp
, &
≥ndög_øid_disks
)

5482 i‡(
	`su≥r_90_lﬂd
(
rdev
, 
rdev0
, 0) >= 0) {

5483 
	`¥ötk
(
KERN_INFO
 "md:ádding %s ...\n",

5484 
	`bdev«me
(
rdev
->
bdev
,
b
));

5485 
	`li°_move
(&
rdev
->
ßme_£t
, &
ˇndid©es
);

5492 i‡(
∑π
) {

5493 
dev
 = 
	`MKDEV
(
mdp_maj‹
,

5494 
rdev0
->
¥e„ºed_mö‹
 << 
MdpMö‹Shi·
);

5495 
unô
 = 
	`MINOR
(
dev
Ë>> 
MdpMö‹Shi·
;

5497 
dev
 = 
	`MKDEV
(
MD_MAJOR
, 
rdev0
->
¥e„ºed_mö‹
);

5498 
unô
 = 
	`MINOR
(
dev
);

5500 i‡(
rdev0
->
¥e„ºed_mö‹
 !
unô
) {

5501 
	`¥ötk
(
KERN_INFO
 "md: unitÇumber in %s is bad: %d\n",

5502 
	`bdev«me
(
rdev0
->
bdev
, 
b
),Ñdev0->
¥e„ºed_mö‹
);

5506 
	`md_¥obe
(
dev
, 
NULL
, NULL);

5507 
mddev
 = 
	`mddev_föd
(
dev
);

5508 i‡(!
mddev
 || !mddev->
gídisk
) {

5509 i‡(
mddev
)

5510 
	`mddev_put
(
mddev
);

5511 
	`¥ötk
(
KERN_ERR


5515 i‡(
	`mddev_lock
(
mddev
))

5516 
	`¥ötk
(
KERN_WARNING
 "md: %sÜocked, cannotÑun\n",

5517 
	`md«me
(
mddev
));

5518 i‡(
mddev
->
øid_disks
 || mddev->
maj‹_vîsi⁄


5519 || !
	`li°_em±y
(&
mddev
->
disks
)) {

5520 
	`¥ötk
(
KERN_WARNING


5522 
	`md«me
(
mddev
), 
	`bdev«me
(
rdev0
->
bdev
,
b
));

5523 
	`mddev_u∆ock
(
mddev
);

5525 
	`¥ötk
(
KERN_INFO
 "md: cª©ed %s\n", 
	`md«me
(
mddev
));

5526 
mddev
->
≥rsi°ít
 = 1;

5527 
	`rdev_f‹_óch_li°
(
rdev
, 
tmp
, &
ˇndid©es
) {

5528 
	`li°_dñ_öô
(&
rdev
->
ßme_£t
);

5529 i‡(
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
))

5530 
	`exp‹t_rdev
(
rdev
);

5532 
	`aut‹un_¨øy
(
mddev
);

5533 
	`mddev_u∆ock
(
mddev
);

5538 
	`rdev_f‹_óch_li°
(
rdev
, 
tmp
, &
ˇndid©es
) {

5539 
	`li°_dñ_öô
(&
rdev
->
ßme_£t
);

5540 
	`exp‹t_rdev
(
rdev
);

5542 
	`mddev_put
(
mddev
);

5544 
	`¥ötk
(
KERN_INFO
 "md: ...áutorun DONE.\n");

5545 
	}
}

5548 
	$gë_vîsi⁄
(
__u£r
 * 
¨g
)

5550 
mdu_vîsi⁄_t
 
vî
;

5552 
vî
.
maj‹
 = 
MD_MAJOR_VERSION
;

5553 
vî
.
mö‹
 = 
MD_MINOR_VERSION
;

5554 
vî
.
∑tchÀvñ
 = 
MD_PATCHLEVEL_VERSION
;

5556 i‡(
	`c›y_to_u£r
(
¨g
, &
vî
, (ver)))

5557  -
EFAULT
;

5560 
	}
}

5562 
	$gë_¨øy_öfo
(
mddev
 * mddev, 
__u£r
 * 
¨g
)

5564 
mdu_¨øy_öfo_t
 
öfo
;

5565 
ƒ
,
w‹kög
,
ösync
,
Áûed
,
•¨e
;

5566 
md_rdev
 *
rdev
;

5568 
ƒ
 = 
w‹kög
 = 
ösync
 = 
Áûed
 = 
•¨e
 = 0;

5569 
	`rcu_ªad_lock
();

5570 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
) {

5571 
ƒ
++;

5572 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

5573 
Áûed
++;

5575 
w‹kög
++;

5576 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

5577 
ösync
++;

5579 
•¨e
++;

5582 
	`rcu_ªad_u∆ock
();

5584 
öfo
.
maj‹_vîsi⁄
 = 
mddev
->major_version;

5585 
öfo
.
mö‹_vîsi⁄
 = 
mddev
->minor_version;

5586 
öfo
.
∑tch_vîsi⁄
 = 
MD_PATCHLEVEL_VERSION
;

5587 
öfo
.
˘ime
 = 
mddev
->ctime;

5588 
öfo
.
Àvñ
 = 
mddev
->level;

5589 
öfo
.
size
 = 
mddev
->
dev_£˘‹s
 / 2;

5590 i‡(
öfo
.
size
 !
mddev
->
dev_£˘‹s
 / 2)

5591 
öfo
.
size
 = -1;

5592 
öfo
.
ƒ_disks
 = 
ƒ
;

5593 
öfo
.
øid_disks
 = 
mddev
->raid_disks;

5594 
öfo
.
md_mö‹
 = 
mddev
->md_minor;

5595 
öfo
.
nŸ_≥rsi°ít
!
mddev
->
≥rsi°ít
;

5597 
öfo
.
utime
 = 
mddev
->utime;

5598 
öfo
.
°©e
 = 0;

5599 i‡(
mddev
->
ö_sync
)

5600 
öfo
.
°©e
 = (1<<
MD_SB_CLEAN
);

5601 i‡(
mddev
->
bôm≠
 && mddev->
bôm≠_öfo
.
off£t
)

5602 
öfo
.
°©e
 |(1<<
MD_SB_BITMAP_PRESENT
);

5603 
öfo
.
a˘ive_disks
 = 
ösync
;

5604 
öfo
.
w‹kög_disks
 = 
w‹kög
;

5605 
öfo
.
Áûed_disks
 = 
Áûed
;

5606 
öfo
.
•¨e_disks
 = 
•¨e
;

5608 
öfo
.
œyout
 = 
mddev
->layout;

5609 
öfo
.
chunk_size
 = 
mddev
->
chunk_£˘‹s
 << 9;

5611 i‡(
	`c›y_to_u£r
(
¨g
, &
öfo
, (info)))

5612  -
EFAULT
;

5615 
	}
}

5617 
	$gë_bôm≠_fûe
(
mddev
 * mddev, 
__u£r
 * 
¨g
)

5619 
mdu_bôm≠_fûe_t
 *
fûe
 = 
NULL
;

5620 *
±r
, *
buf
 = 
NULL
;

5621 
îr
 = -
ENOMEM
;

5623 
fûe
 = 
	`kmÆloc
((*fûe), 
GFP_NOIO
);

5625 i‡(!
fûe
)

5626 
out
;

5629 i‡(!
mddev
->
bôm≠
 || !mddev->bôm≠->
°‹age
.
fûe
) {

5630 
fûe
->
∑th«me
[0] = '\0';

5631 
c›y_out
;

5634 
buf
 = 
	`kmÆloc
((
fûe
->
∑th«me
), 
GFP_KERNEL
);

5635 i‡(!
buf
)

5636 
out
;

5638 
±r
 = 
	`d_∑th
(&
mddev
->
bôm≠
->
°‹age
.
fûe
->
f_∑th
,

5639 
buf
, (
fûe
->
∑th«me
));

5640 i‡(
	`IS_ERR
(
±r
))

5641 
out
;

5643 
	`°r˝y
(
fûe
->
∑th«me
, 
±r
);

5645 
c›y_out
:

5646 
îr
 = 0;

5647 i‡(
	`c›y_to_u£r
(
¨g
, 
fûe
, (*file)))

5648 
îr
 = -
EFAULT
;

5649 
out
:

5650 
	`k‰ì
(
buf
);

5651 
	`k‰ì
(
fûe
);

5652  
îr
;

5653 
	}
}

5655 
	$gë_disk_öfo
(
mddev
 * mddev, 
__u£r
 * 
¨g
)

5657 
mdu_disk_öfo_t
 
öfo
;

5658 
md_rdev
 *
rdev
;

5660 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
¨g
, (info)))

5661  -
EFAULT
;

5663 
	`rcu_ªad_lock
();

5664 
rdev
 = 
	`föd_rdev_ƒ_rcu
(
mddev
, 
öfo
.
numbî
);

5665 i‡(
rdev
) {

5666 
öfo
.
maj‹
 = 
	`MAJOR
(
rdev
->
bdev
->
bd_dev
);

5667 
öfo
.
mö‹
 = 
	`MINOR
(
rdev
->
bdev
->
bd_dev
);

5668 
öfo
.
øid_disk
 = 
rdev
->raid_disk;

5669 
öfo
.
°©e
 = 0;

5670 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

5671 
öfo
.
°©e
 |(1<<
MD_DISK_FAULTY
);

5672 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

5673 
öfo
.
°©e
 |(1<<
MD_DISK_ACTIVE
);

5674 
öfo
.
°©e
 |(1<<
MD_DISK_SYNC
);

5676 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
))

5677 
öfo
.
°©e
 |(1<<
MD_DISK_WRITEMOSTLY
);

5679 
öfo
.
maj‹
 = info.
mö‹
 = 0;

5680 
öfo
.
øid_disk
 = -1;

5681 
öfo
.
°©e
 = (1<<
MD_DISK_REMOVED
);

5683 
	`rcu_ªad_u∆ock
();

5685 i‡(
	`c›y_to_u£r
(
¨g
, &
öfo
, (info)))

5686  -
EFAULT
;

5689 
	}
}

5691 
	$add_√w_disk
(
mddev
 * mddev, 
mdu_disk_öfo_t
 *
öfo
)

5693 
b
[
BDEVNAME_SIZE
], 
b2
[BDEVNAME_SIZE];

5694 
md_rdev
 *
rdev
;

5695 
dev_t
 
dev
 = 
	`MKDEV
(
öfo
->
maj‹
,öfo->
mö‹
);

5697 i‡(
öfo
->
maj‹
 !
	`MAJOR
(
dev
Ë|| info->
mö‹
 !
	`MINOR
(dev))

5698  -
EOVERFLOW
;

5700 i‡(!
mddev
->
øid_disks
) {

5701 
îr
;

5703 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, 
mddev
->
maj‹_vîsi⁄
, mddev->
mö‹_vîsi⁄
);

5704 i‡(
	`IS_ERR
(
rdev
)) {

5705 
	`¥ötk
(
KERN_WARNING


5707 
	`PTR_ERR
(
rdev
));

5708  
	`PTR_ERR
(
rdev
);

5710 i‡(!
	`li°_em±y
(&
mddev
->
disks
)) {

5711 
md_rdev
 *
rdev0


5712 
	`li°_íåy
(
mddev
->
disks
.
√xt
,

5713 
md_rdev
, 
ßme_£t
);

5714 
îr
 = 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
]

5715 .
	`lﬂd_su≥r
(
rdev
, 
rdev0
, 
mddev
->
mö‹_vîsi⁄
);

5716 i‡(
îr
 < 0) {

5717 
	`¥ötk
(
KERN_WARNING


5719 
	`bdev«me
(
rdev
->
bdev
,
b
),

5720 
	`bdev«me
(
rdev0
->
bdev
,
b2
));

5721 
	`exp‹t_rdev
(
rdev
);

5722  -
EINVAL
;

5725 
îr
 = 
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
);

5726 i‡(
îr
)

5727 
	`exp‹t_rdev
(
rdev
);

5728  
îr
;

5736 i‡(
mddev
->
≥rs
) {

5737 
îr
;

5738 i‡(!
mddev
->
≥rs
->
hŸ_add_disk
) {

5739 
	`¥ötk
(
KERN_WARNING


5741 
	`md«me
(
mddev
));

5742  -
EINVAL
;

5744 i‡(
mddev
->
≥rsi°ít
)

5745 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, 
mddev
->
maj‹_vîsi⁄
,

5746 
mddev
->
mö‹_vîsi⁄
);

5748 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, -1, -1);

5749 i‡(
	`IS_ERR
(
rdev
)) {

5750 
	`¥ötk
(
KERN_WARNING


5752 
	`PTR_ERR
(
rdev
));

5753  
	`PTR_ERR
(
rdev
);

5756 i‡(!
mddev
->
≥rsi°ít
) {

5757 i‡(
öfo
->
°©e
 & (1<<
MD_DISK_SYNC
) &&

5758 
öfo
->
øid_disk
 < 
mddev
->
øid_disks
) {

5759 
rdev
->
øid_disk
 = 
öfo
->raid_disk;

5760 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

5761 
	`˛ór_bô
(
Bôm≠_sync
, &
rdev
->
Êags
);

5763 
rdev
->
øid_disk
 = -1;

5764 
rdev
->
ßved_øid_disk
 =Ñdev->
øid_disk
;

5766 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].

5767 
	`vÆid©e_su≥r
(
mddev
, 
rdev
);

5768 i‡((
öfo
->
°©e
 & (1<<
MD_DISK_SYNC
)) &&

5769 
rdev
->
øid_disk
 !
öfo
->raid_disk) {

5773 
	`exp‹t_rdev
(
rdev
);

5774  -
EINVAL
;

5777 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

5778 i‡(
öfo
->
°©e
 & (1<<
MD_DISK_WRITEMOSTLY
))

5779 
	`£t_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

5781 
	`˛ór_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

5783 
rdev
->
øid_disk
 = -1;

5784 
îr
 = 
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
);

5785 i‡(!
îr
 && !
mddev
->
≥rs
->
hŸ_ªmove_disk
) {

5790 
su≥r_ty≥s
[
mddev
->
maj‹_vîsi⁄
].

5791 
	`vÆid©e_su≥r
(
mddev
, 
rdev
);

5792 
îr
 = 
mddev
->
≥rs
->
	`hŸ_add_disk
(mddev, 
rdev
);

5793 i‡(
îr
)

5794 
	`unböd_rdev_‰om_¨øy
(
rdev
);

5796 i‡(
îr
)

5797 
	`exp‹t_rdev
(
rdev
);

5799 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

5801 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

5802 i‡(
mddev
->
degøded
)

5803 
	`£t_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

5804 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

5805 i‡(!
îr
)

5806 
	`md_√w_evít
(
mddev
);

5807 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5808  
îr
;

5814 i‡(
mddev
->
maj‹_vîsi⁄
 != 0) {

5815 
	`¥ötk
(
KERN_WARNING
 "%s: ADD_NEW_DISKÇot supported\n",

5816 
	`md«me
(
mddev
));

5817  -
EINVAL
;

5820 i‡(!(
öfo
->
°©e
 & (1<<
MD_DISK_FAULTY
))) {

5821 
îr
;

5822 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, -1, 0);

5823 i‡(
	`IS_ERR
(
rdev
)) {

5824 
	`¥ötk
(
KERN_WARNING


5826 
	`PTR_ERR
(
rdev
));

5827  
	`PTR_ERR
(
rdev
);

5829 
rdev
->
desc_ƒ
 = 
öfo
->
numbî
;

5830 i‡(
öfo
->
øid_disk
 < 
mddev
->
øid_disks
)

5831 
rdev
->
øid_disk
 = 
öfo
->raid_disk;

5833 
rdev
->
øid_disk
 = -1;

5835 i‡(
rdev
->
øid_disk
 < 
mddev
->
øid_disks
)

5836 i‡(
öfo
->
°©e
 & (1<<
MD_DISK_SYNC
))

5837 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

5839 i‡(
öfo
->
°©e
 & (1<<
MD_DISK_WRITEMOSTLY
))

5840 
	`£t_bô
(
WrôeMo°ly
, &
rdev
->
Êags
);

5842 i‡(!
mddev
->
≥rsi°ít
) {

5843 
	`¥ötk
(
KERN_INFO
 "md:Çonpersistent superblock ...\n");

5844 
rdev
->
sb_°¨t
 = 
	`i_size_ªad
‘dev->
bdev
->
bd_öode
) / 512;

5846 
rdev
->
sb_°¨t
 = 
	`ˇlc_dev_sboff£t
(rdev);

5847 
rdev
->
£˘‹s
 =Ñdev->
sb_°¨t
;

5849 
îr
 = 
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
);

5850 i‡(
îr
) {

5851 
	`exp‹t_rdev
(
rdev
);

5852  
îr
;

5857 
	}
}

5859 
	$hŸ_ªmove_disk
(
mddev
 * mddev, 
dev_t
 
dev
)

5861 
b
[
BDEVNAME_SIZE
];

5862 
md_rdev
 *
rdev
;

5864 
rdev
 = 
	`föd_rdev
(
mddev
, 
dev
);

5865 i‡(!
rdev
)

5866  -
ENXIO
;

5868 
	`˛ór_bô
(
Blocked
, &
rdev
->
Êags
);

5869 
	`ªmove_™d_add_•¨es
(
mddev
, 
rdev
);

5871 i‡(
rdev
->
øid_disk
 >= 0)

5872 
busy
;

5874 
	`kick_rdev_‰om_¨øy
(
rdev
);

5875 
	`md_upd©e_sb
(
mddev
, 1);

5876 
	`md_√w_evít
(
mddev
);

5879 
busy
:

5880 
	`¥ötk
(
KERN_WARNING
 "md: cannotÑemoveáctive disk %s from %s ...\n",

5881 
	`bdev«me
(
rdev
->
bdev
,
b
), 
	`md«me
(
mddev
));

5882  -
EBUSY
;

5883 
	}
}

5885 
	$hŸ_add_disk
(
mddev
 * mddev, 
dev_t
 
dev
)

5887 
b
[
BDEVNAME_SIZE
];

5888 
îr
;

5889 
md_rdev
 *
rdev
;

5891 i‡(!
mddev
->
≥rs
)

5892  -
ENODEV
;

5894 i‡(
mddev
->
maj‹_vîsi⁄
 != 0) {

5895 
	`¥ötk
(
KERN_WARNING
 "%s: HOT_ADD may only be used with"

5897 
	`md«me
(
mddev
));

5898  -
EINVAL
;

5900 i‡(!
mddev
->
≥rs
->
hŸ_add_disk
) {

5901 
	`¥ötk
(
KERN_WARNING


5903 
	`md«me
(
mddev
));

5904  -
EINVAL
;

5907 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
, -1, 0);

5908 i‡(
	`IS_ERR
(
rdev
)) {

5909 
	`¥ötk
(
KERN_WARNING


5911 
	`PTR_ERR
(
rdev
));

5912  -
EINVAL
;

5915 i‡(
mddev
->
≥rsi°ít
)

5916 
rdev
->
sb_°¨t
 = 
	`ˇlc_dev_sboff£t
(rdev);

5918 
rdev
->
sb_°¨t
 = 
	`i_size_ªad
‘dev->
bdev
->
bd_öode
) / 512;

5920 
rdev
->
£˘‹s
 =Ñdev->
sb_°¨t
;

5922 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

5923 
	`¥ötk
(
KERN_WARNING


5925 
	`bdev«me
(
rdev
->
bdev
,
b
), 
	`md«me
(
mddev
));

5926 
îr
 = -
EINVAL
;

5927 
ab‹t_exp‹t
;

5929 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

5930 
rdev
->
desc_ƒ
 = -1;

5931 
rdev
->
ßved_øid_disk
 = -1;

5932 
îr
 = 
	`böd_rdev_to_¨øy
(
rdev
, 
mddev
);

5933 i‡(
îr
)

5934 
ab‹t_exp‹t
;

5941 
rdev
->
øid_disk
 = -1;

5943 
	`md_upd©e_sb
(
mddev
, 1);

5949 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

5950 
	`md_wakeup_thªad
(
mddev
->
thªad
);

5951 
	`md_√w_evít
(
mddev
);

5954 
ab‹t_exp‹t
:

5955 
	`exp‹t_rdev
(
rdev
);

5956  
îr
;

5957 
	}
}

5959 
	$£t_bôm≠_fûe
(
mddev
 *mddev, 
fd
)

5961 
îr
 = 0;

5963 i‡(
mddev
->
≥rs
) {

5964 i‡(!
mddev
->
≥rs
->
quõs˚
 || !mddev->
thªad
)

5965  -
EBUSY
;

5966 i‡(
mddev
->
ªcovîy
 || mddev->
sync_thªad
)

5967  -
EBUSY
;

5972 i‡(
fd
 >= 0) {

5973 
öode
 *inode;

5974 i‡(
mddev
->
bôm≠
)

5975  -
EEXIST
;

5976 
mddev
->
bôm≠_öfo
.
fûe
 = 
	`fgë
(
fd
);

5978 i‡(
mddev
->
bôm≠_öfo
.
fûe
 =
NULL
) {

5979 
	`¥ötk
(
KERN_ERR
 "%s:Érror: failedÅo get bitmap file\n",

5980 
	`md«me
(
mddev
));

5981  -
EBADF
;

5984 
öode
 = 
mddev
->
bôm≠_öfo
.
fûe
->
f_m≠pög
->
ho°
;

5985 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

5986 
	`¥ötk
(
KERN_ERR
 "%s:Érror: bitmap file must beáÑegular file\n",

5987 
	`md«me
(
mddev
));

5988 
îr
 = -
EBADF
;

5989 } i‡(!(
mddev
->
bôm≠_öfo
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

5990 
	`¥ötk
(
KERN_ERR
 "%s:Érror: bitmap file must open for write\n",

5991 
	`md«me
(
mddev
));

5992 
îr
 = -
EBADF
;

5993 } i‡(
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) != 1) {

5994 
	`¥ötk
(
KERN_ERR
 "%s:Érror: bitmap file isálready in use\n",

5995 
	`md«me
(
mddev
));

5996 
îr
 = -
EBUSY
;

5998 i‡(
îr
) {

5999 
	`Âut
(
mddev
->
bôm≠_öfo
.
fûe
);

6000 
mddev
->
bôm≠_öfo
.
fûe
 = 
NULL
;

6001  
îr
;

6003 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

6004 } i‡(
mddev
->
bôm≠
 =
NULL
)

6005  -
ENOENT
;

6006 
îr
 = 0;

6007 i‡(
mddev
->
≥rs
) {

6008 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

6009 i‡(
fd
 >= 0) {

6010 
îr
 = 
	`bôm≠_¸óã
(
mddev
);

6011 i‡(!
îr
)

6012 
îr
 = 
	`bôm≠_lﬂd
(
mddev
);

6014 i‡(
fd
 < 0 || 
îr
) {

6015 
	`bôm≠_de°roy
(
mddev
);

6016 
fd
 = -1;

6018 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

6020 i‡(
fd
 < 0) {

6021 i‡(
mddev
->
bôm≠_öfo
.
fûe
)

6022 
	`Âut
(
mddev
->
bôm≠_öfo
.
fûe
);

6023 
mddev
->
bôm≠_öfo
.
fûe
 = 
NULL
;

6026  
îr
;

6027 
	}
}

6042 
	$£t_¨øy_öfo
(
mddev
 * mddev, 
mdu_¨øy_öfo_t
 *
öfo
)

6045 i‡(
öfo
->
øid_disks
 == 0) {

6047 i‡(
öfo
->
maj‹_vîsi⁄
 < 0 ||

6048 
öfo
->
maj‹_vîsi⁄
 >
	`ARRAY_SIZE
(
su≥r_ty≥s
) ||

6049 
su≥r_ty≥s
[
öfo
->
maj‹_vîsi⁄
].
«me
 =
NULL
) {

6051 
	`¥ötk
(
KERN_INFO


6053 
öfo
->
maj‹_vîsi⁄
);

6054  -
EINVAL
;

6056 
mddev
->
maj‹_vîsi⁄
 = 
öfo
->major_version;

6057 
mddev
->
mö‹_vîsi⁄
 = 
öfo
->minor_version;

6058 
mddev
->
∑tch_vîsi⁄
 = 
öfo
->patch_version;

6059 
mddev
->
≥rsi°ít
 = !
öfo
->
nŸ_≥rsi°ít
;

6063 
mddev
->
˘ime
 = 
	`gë_£c⁄ds
();

6066 
mddev
->
maj‹_vîsi⁄
 = 
MD_MAJOR_VERSION
;

6067 
mddev
->
mö‹_vîsi⁄
 = 
MD_MINOR_VERSION
;

6068 
mddev
->
∑tch_vîsi⁄
 = 
MD_PATCHLEVEL_VERSION
;

6069 
mddev
->
˘ime
 = 
	`gë_£c⁄ds
();

6071 
mddev
->
Àvñ
 = 
öfo
->level;

6072 
mddev
->
˛evñ
[0] = 0;

6073 
mddev
->
dev_£˘‹s
 = 2 * (
£˘‹_t
)
öfo
->
size
;

6074 
mddev
->
øid_disks
 = 
öfo
->raid_disks;

6078 i‡(
öfo
->
°©e
 & (1<<
MD_SB_CLEAN
))

6079 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

6081 
mddev
->
ªcovîy_˝
 = 0;

6082 
mddev
->
≥rsi°ít
 = ! 
öfo
->
nŸ_≥rsi°ít
;

6083 
mddev
->
exã∫Æ
 = 0;

6085 
mddev
->
œyout
 = 
öfo
->layout;

6086 
mddev
->
chunk_£˘‹s
 = 
öfo
->
chunk_size
 >> 9;

6088 
mddev
->
max_disks
 = 
MD_SB_DISKS
;

6090 i‡(
mddev
->
≥rsi°ít
)

6091 
mddev
->
Êags
 = 0;

6092 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

6094 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 = 
MD_SB_BYTES
 >> 9;

6095 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
 = 64*2 - (
MD_SB_BYTES
 >> 9);

6096 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

6098 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

6103 
	`gë_øndom_byãs
(
mddev
->
uuid
, 16);

6105 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

6106 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

6107 
mddev
->
√w_œyout
 = mddev->
œyout
;

6108 
mddev
->
dñè_disks
 = 0;

6109 
mddev
->
ªsh≠e_backw¨ds
 = 0;

6112 
	}
}

6114 
	$md_£t_¨øy_£˘‹s
(
mddev
 *mddev, 
£˘‹_t
 
¨øy_£˘‹s
)

6116 
	`WARN
(!
	`mddev_is_locked
(
mddev
), "%s: u∆ocked mddev!\n", 
__func__
);

6118 i‡(
mddev
->
exã∫Æ_size
)

6121 
mddev
->
¨øy_£˘‹s
 =árray_sectors;

6122 
	}
}

6123 
EXPORT_SYMBOL
(
md_£t_¨øy_£˘‹s
);

6125 
	$upd©e_size
(
mddev
 *mddev, 
£˘‹_t
 
num_£˘‹s
)

6127 
md_rdev
 *
rdev
;

6128 
rv
;

6129 
fô
 = (
num_£˘‹s
 == 0);

6131 i‡(
mddev
->
≥rs
->
ªsize
 =
NULL
)

6132  -
EINVAL
;

6142 i‡(
mddev
->
sync_thªad
)

6143  -
EBUSY
;

6144 i‡(
mddev
->
ro
)

6145  -
EROFS
;

6147 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

6148 
£˘‹_t
 
avaû
 = 
rdev
->
£˘‹s
;

6150 i‡(
fô
 && (
num_£˘‹s
 =0 ||Çum_£˘‹†> 
avaû
))

6151 
num_£˘‹s
 = 
avaû
;

6152 i‡(
avaû
 < 
num_£˘‹s
)

6153  -
ENOSPC
;

6155 
rv
 = 
mddev
->
≥rs
->
	`ªsize
(mddev, 
num_£˘‹s
);

6156 i‡(!
rv
)

6157 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

6158  
rv
;

6159 
	}
}

6161 
	$upd©e_øid_disks
(
mddev
 *mddev, 
øid_disks
)

6163 
rv
;

6164 
md_rdev
 *
rdev
;

6166 i‡(
mddev
->
≥rs
->
check_ªsh≠e
 =
NULL
)

6167  -
EINVAL
;

6168 i‡(
mddev
->
ro
)

6169  -
EROFS
;

6170 i‡(
øid_disks
 <= 0 ||

6171 (
mddev
->
max_disks
 && 
øid_disks
 >= mddev->max_disks))

6172  -
EINVAL
;

6173 i‡(
mddev
->
sync_thªad
 || mddev->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
)

6174  -
EBUSY
;

6176 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

6177 i‡(
mddev
->
øid_disks
 <Ñaid_disks &&

6178 
rdev
->
d©a_off£t
 <Ñdev->
√w_d©a_off£t
)

6179  -
EINVAL
;

6180 i‡(
mddev
->
øid_disks
 >Ñaid_disks &&

6181 
rdev
->
d©a_off£t
 >Ñdev->
√w_d©a_off£t
)

6182  -
EINVAL
;

6185 
mddev
->
dñè_disks
 = 
øid_disks
 - mddev->raid_disks;

6186 i‡(
mddev
->
dñè_disks
 < 0)

6187 
mddev
->
ªsh≠e_backw¨ds
 = 1;

6188 i‡(
mddev
->
dñè_disks
 > 0)

6189 
mddev
->
ªsh≠e_backw¨ds
 = 0;

6191 
rv
 = 
mddev
->
≥rs
->
	`check_ªsh≠e
(mddev);

6192 i‡(
rv
 < 0) {

6193 
mddev
->
dñè_disks
 = 0;

6194 
mddev
->
ªsh≠e_backw¨ds
 = 0;

6196  
rv
;

6197 
	}
}

6208 
	$upd©e_¨øy_öfo
(
mddev
 *mddev, 
mdu_¨øy_öfo_t
 *
öfo
)

6210 
rv
 = 0;

6211 
˙t
 = 0;

6212 
°©e
 = 0;

6215 i‡(
mddev
->
bôm≠
 && mddev->
bôm≠_öfo
.
off£t
)

6216 
°©e
 |(1 << 
MD_SB_BITMAP_PRESENT
);

6218 i‡(
mddev
->
maj‹_vîsi⁄
 !
öfo
->major_version ||

6219 
mddev
->
mö‹_vîsi⁄
 !
öfo
->minor_version ||

6221 
mddev
->
˘ime
 !
öfo
->ctime ||

6222 
mddev
->
Àvñ
 !
öfo
->level ||

6224 !
mddev
->
≥rsi°ít
 !
öfo
->
nŸ_≥rsi°ít
||

6225 
mddev
->
chunk_£˘‹s
 !
öfo
->
chunk_size
 >> 9 ||

6227 ((
°©e
^
öfo
->state) & 0xfffffe00)

6229  -
EINVAL
;

6231 i‡(
öfo
->
size
 >0 && 
mddev
->
dev_£˘‹s
 / 2 != info->size)

6232 
˙t
++;

6233 i‡(
mddev
->
øid_disks
 !
öfo
->raid_disks)

6234 
˙t
++;

6235 i‡(
mddev
->
œyout
 !
öfo
->layout)

6236 
˙t
++;

6237 i‡((
°©e
 ^ 
öfo
->°©eË& (1<<
MD_SB_BITMAP_PRESENT
))

6238 
˙t
++;

6239 i‡(
˙t
 == 0)

6241 i‡(
˙t
 > 1)

6242  -
EINVAL
;

6244 i‡(
mddev
->
œyout
 !
öfo
->layout) {

6249 i‡(
mddev
->
≥rs
->
check_ªsh≠e
 =
NULL
)

6250  -
EINVAL
;

6252 
mddev
->
√w_œyout
 = 
öfo
->
œyout
;

6253 
rv
 = 
mddev
->
≥rs
->
	`check_ªsh≠e
(mddev);

6254 i‡(
rv
)

6255 
mddev
->
√w_œyout
 = mddev->
œyout
;

6256  
rv
;

6259 i‡(
öfo
->
size
 >0 && 
mddev
->
dev_£˘‹s
 / 2 != info->size)

6260 
rv
 = 
	`upd©e_size
(
mddev
, (
£˘‹_t
)
öfo
->
size
 * 2);

6262 i‡(
mddev
->
øid_disks
 !
öfo
->raid_disks)

6263 
rv
 = 
	`upd©e_øid_disks
(
mddev
, 
öfo
->
øid_disks
);

6265 i‡((
°©e
 ^ 
öfo
->°©eË& (1<<
MD_SB_BITMAP_PRESENT
)) {

6266 i‡(
mddev
->
≥rs
->
quõs˚
 =
NULL
 || mddev->
thªad
 == NULL)

6267  -
EINVAL
;

6268 i‡(
mddev
->
ªcovîy
 || mddev->
sync_thªad
)

6269  -
EBUSY
;

6270 i‡(
öfo
->
°©e
 & (1<<
MD_SB_BITMAP_PRESENT
)) {

6272 i‡(
mddev
->
bôm≠
)

6273  -
EEXIST
;

6274 i‡(
mddev
->
bôm≠_öfo
.
deÁu…_off£t
 == 0)

6275  -
EINVAL
;

6276 
mddev
->
bôm≠_öfo
.
off£t
 =

6277 
mddev
->
bôm≠_öfo
.
deÁu…_off£t
;

6278 
mddev
->
bôm≠_öfo
.
•a˚
 =

6279 
mddev
->
bôm≠_öfo
.
deÁu…_•a˚
;

6280 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

6281 
rv
 = 
	`bôm≠_¸óã
(
mddev
);

6282 i‡(!
rv
)

6283 
rv
 = 
	`bôm≠_lﬂd
(
mddev
);

6284 i‡(
rv
)

6285 
	`bôm≠_de°roy
(
mddev
);

6286 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

6289 i‡(!
mddev
->
bôm≠
)

6290  -
ENOENT
;

6291 i‡(
mddev
->
bôm≠
->
°‹age
.
fûe
)

6292  -
EINVAL
;

6293 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

6294 
	`bôm≠_de°roy
(
mddev
);

6295 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

6296 
mddev
->
bôm≠_öfo
.
off£t
 = 0;

6299 
	`md_upd©e_sb
(
mddev
, 1);

6300  
rv
;

6301 
	}
}

6303 
	$£t_disk_Áu…y
(
mddev
 *mddev, 
dev_t
 
dev
)

6305 
md_rdev
 *
rdev
;

6306 
îr
 = 0;

6308 i‡(
mddev
->
≥rs
 =
NULL
)

6309  -
ENODEV
;

6311 
	`rcu_ªad_lock
();

6312 
rdev
 = 
	`föd_rdev_rcu
(
mddev
, 
dev
);

6313 i‡(!
rdev
)

6314 
îr
 = -
ENODEV
;

6316 
	`md_îr‹
(
mddev
, 
rdev
);

6317 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

6318 
îr
 = -
EBUSY
;

6320 
	`rcu_ªad_u∆ock
();

6321  
îr
;

6322 
	}
}

6330 
	$md_gëgeo
(
block_devi˚
 *
bdev
, 
hd_geomëry
 *
geo
)

6332 
mddev
 *mddev = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

6334 
geo
->
hóds
 = 2;

6335 
geo
->
£˘‹s
 = 4;

6336 
geo
->
cylödîs
 = 
mddev
->
¨øy_£˘‹s
 / 8;

6338 
	}
}

6340 
ölöe
 
boﬁ
 
	$md_io˘l_vÆid
(
cmd
)

6342 
cmd
) {

6343 
ADD_NEW_DISK
:

6344 
BLKROSET
:

6345 
GET_ARRAY_INFO
:

6346 
GET_BITMAP_FILE
:

6347 
GET_DISK_INFO
:

6348 
HOT_ADD_DISK
:

6349 
HOT_REMOVE_DISK
:

6350 
PRINT_RAID_DEBUG
:

6351 
RAID_AUTORUN
:

6352 
RAID_VERSION
:

6353 
RESTART_ARRAY_RW
:

6354 
RUN_ARRAY
:

6355 
SET_ARRAY_INFO
:

6356 
SET_BITMAP_FILE
:

6357 
SET_DISK_FAULTY
:

6358 
STOP_ARRAY
:

6359 
STOP_ARRAY_RO
:

6360  
åue
;

6362  
Ál£
;

6364 
	}
}

6366 
	$md_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

6367 
cmd
, 
¨g
)

6369 
îr
 = 0;

6370 
__u£r
 *
¨gp
 = (__u£∏*)
¨g
;

6371 
mddev
 *mddev = 
NULL
;

6372 
ro
;

6374 i‡(!
	`md_io˘l_vÆid
(
cmd
))

6375  -
ENOTTY
;

6377 
cmd
) {

6378 
RAID_VERSION
:

6379 
GET_ARRAY_INFO
:

6380 
GET_DISK_INFO
:

6383 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

6384  -
EACCES
;

6391 
cmd
) {

6392 
RAID_VERSION
:

6393 
îr
 = 
	`gë_vîsi⁄
(
¨gp
);

6394 
d⁄e
;

6396 
PRINT_RAID_DEBUG
:

6397 
îr
 = 0;

6398 
	`md_¥öt_devi˚s
();

6399 
d⁄e
;

6401 #i‚de‡
MODULE


6402 
RAID_AUTORUN
:

6403 
îr
 = 0;

6404 
	`auto°¨t_¨øys
(
¨g
);

6405 
d⁄e
;

6414 
mddev
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

6416 i‡(!
mddev
) {

6417 
	`BUG
();

6418 
ab‹t
;

6422 
cmd
) {

6423 
GET_ARRAY_INFO
:

6424 i‡(!
mddev
->
øid_disks
 && !mddev->
exã∫Æ
)

6425 
îr
 = -
ENODEV
;

6427 
îr
 = 
	`gë_¨øy_öfo
(
mddev
, 
¨gp
);

6428 
ab‹t
;

6430 
GET_DISK_INFO
:

6431 i‡(!
mddev
->
øid_disks
 && !mddev->
exã∫Æ
)

6432 
îr
 = -
ENODEV
;

6434 
îr
 = 
	`gë_disk_öfo
(
mddev
, 
¨gp
);

6435 
ab‹t
;

6437 
SET_DISK_FAULTY
:

6438 
îr
 = 
	`£t_disk_Áu…y
(
mddev
, 
	`√w_decode_dev
(
¨g
));

6439 
ab‹t
;

6442 i‡(
cmd
 =
ADD_NEW_DISK
)

6444 
	`Êush_w‹kqueue
(
md_misc_wq
);

6446 i‡(
cmd
 =
HOT_REMOVE_DISK
)

6448 
	`waô_evít_öãºu±ibÀ_timeout
(
mddev
->
sb_waô
,

6449 !
	`ã°_bô
(
MD_RECOVERY_NEEDED
,

6450 &
mddev
->
Êags
),

6451 
	`m£cs_to_jiffõs
(5000));

6452 i‡(
cmd
 =
STOP_ARRAY
 || cmd =
STOP_ARRAY_RO
) {

6456 
	`muãx_lock
(&
mddev
->
›í_muãx
);

6457 i‡(
	`©omic_ªad
(&
mddev
->
›íîs
) > 1) {

6458 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

6459 
îr
 = -
EBUSY
;

6460 
ab‹t
;

6462 
	`£t_bô
(
MD_STILL_CLOSED
, &
mddev
->
Êags
);

6463 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

6464 
	`sync_blockdev
(
bdev
);

6466 
îr
 = 
	`mddev_lock
(
mddev
);

6467 i‡(
îr
) {

6468 
	`¥ötk
(
KERN_INFO


6470 
îr
, 
cmd
);

6471 
ab‹t
;

6474 i‡(
cmd
 =
SET_ARRAY_INFO
) {

6475 
mdu_¨øy_öfo_t
 
öfo
;

6476 i‡(!
¨g
)

6477 
	`mem£t
(&
öfo
, 0, (info));

6478 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
¨gp
, (info))) {

6479 
îr
 = -
EFAULT
;

6480 
ab‹t_u∆ock
;

6482 i‡(
mddev
->
≥rs
) {

6483 
îr
 = 
	`upd©e_¨øy_öfo
(
mddev
, &
öfo
);

6484 i‡(
îr
) {

6485 
	`¥ötk
(
KERN_WARNING
 "md: couldn't update"

6486 "áºay info. %d\n", 
îr
);

6487 
ab‹t_u∆ock
;

6489 
d⁄e_u∆ock
;

6491 i‡(!
	`li°_em±y
(&
mddev
->
disks
)) {

6492 
	`¥ötk
(
KERN_WARNING


6494 
	`md«me
(
mddev
));

6495 
îr
 = -
EBUSY
;

6496 
ab‹t_u∆ock
;

6498 i‡(
mddev
->
øid_disks
) {

6499 
	`¥ötk
(
KERN_WARNING


6501 
	`md«me
(
mddev
));

6502 
îr
 = -
EBUSY
;

6503 
ab‹t_u∆ock
;

6505 
îr
 = 
	`£t_¨øy_öfo
(
mddev
, &
öfo
);

6506 i‡(
îr
) {

6507 
	`¥ötk
(
KERN_WARNING
 "md: couldn't set"

6508 "áºay info. %d\n", 
îr
);

6509 
ab‹t_u∆ock
;

6511 
d⁄e_u∆ock
;

6519 i‡((!
mddev
->
øid_disks
 && !mddev->
exã∫Æ
)

6520 && 
cmd
 !
ADD_NEW_DISK
 && cmd !
STOP_ARRAY


6521 && 
cmd
 !
RUN_ARRAY
 && cmd !
SET_BITMAP_FILE


6522 && 
cmd
 !
GET_BITMAP_FILE
) {

6523 
îr
 = -
ENODEV
;

6524 
ab‹t_u∆ock
;

6530 
cmd
) {

6531 
GET_BITMAP_FILE
:

6532 
îr
 = 
	`gë_bôm≠_fûe
(
mddev
, 
¨gp
);

6533 
d⁄e_u∆ock
;

6535 
RESTART_ARRAY_RW
:

6536 
îr
 = 
	`ª°¨t_¨øy
(
mddev
);

6537 
d⁄e_u∆ock
;

6539 
STOP_ARRAY
:

6540 
îr
 = 
	`do_md_°›
(
mddev
, 0, 
bdev
);

6541 
d⁄e_u∆ock
;

6543 
STOP_ARRAY_RO
:

6544 
îr
 = 
	`md_£t_ªad⁄ly
(
mddev
, 
bdev
);

6545 
d⁄e_u∆ock
;

6547 
HOT_REMOVE_DISK
:

6548 
îr
 = 
	`hŸ_ªmove_disk
(
mddev
, 
	`√w_decode_dev
(
¨g
));

6549 
d⁄e_u∆ock
;

6551 
ADD_NEW_DISK
:

6556 i‡(
mddev
->
≥rs
) {

6557 
mdu_disk_öfo_t
 
öfo
;

6558 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
¨gp
, (info)))

6559 
îr
 = -
EFAULT
;

6560 i‡(!(
öfo
.
°©e
 & (1<<
MD_DISK_SYNC
)))

6564 
îr
 = 
	`add_√w_disk
(
mddev
, &
öfo
);

6565 
d⁄e_u∆ock
;

6569 
BLKROSET
:

6570 i‡(
	`gë_u£r
(
ro
, (
__u£r
 *)(
¨g
))) {

6571 
îr
 = -
EFAULT
;

6572 
d⁄e_u∆ock
;

6574 
îr
 = -
EINVAL
;

6579 i‡(
ro
)

6580 
d⁄e_u∆ock
;

6583 i‡(
mddev
->
ro
 != 1)

6584 
d⁄e_u∆ock
;

6589 i‡(
mddev
->
≥rs
) {

6590 
îr
 = 
	`ª°¨t_¨øy
(
mddev
);

6591 i‡(
îr
 == 0) {

6592 
mddev
->
ro
 = 2;

6593 
	`£t_disk_ro
(
mddev
->
gídisk
, 0);

6596 
d⁄e_u∆ock
;

6606 i‡(
	`_IOC_TYPE
(
cmd
Ë=
MD_MAJOR
 && 
mddev
->
ro
 && mddev->
≥rs
) {

6607 i‡(
mddev
->
ro
 == 2) {

6608 
mddev
->
ro
 = 0;

6609 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

6610 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

6615 i‡(
	`ã°_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
)) {

6616 
	`mddev_u∆ock
(
mddev
);

6617 
	`waô_evít
(
mddev
->
sb_waô
,

6618 !
	`ã°_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
) &&

6619 !
	`ã°_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
));

6620 
	`mddev_lock_noöå
(
mddev
);

6623 
îr
 = -
EROFS
;

6624 
ab‹t_u∆ock
;

6628 
cmd
) {

6629 
ADD_NEW_DISK
:

6631 
mdu_disk_öfo_t
 
öfo
;

6632 i‡(
	`c›y_‰om_u£r
(&
öfo
, 
¨gp
, (info)))

6633 
îr
 = -
EFAULT
;

6635 
îr
 = 
	`add_√w_disk
(
mddev
, &
öfo
);

6636 
d⁄e_u∆ock
;

6639 
HOT_ADD_DISK
:

6640 
îr
 = 
	`hŸ_add_disk
(
mddev
, 
	`√w_decode_dev
(
¨g
));

6641 
d⁄e_u∆ock
;

6643 
RUN_ARRAY
:

6644 
îr
 = 
	`do_md_run
(
mddev
);

6645 
d⁄e_u∆ock
;

6647 
SET_BITMAP_FILE
:

6648 
îr
 = 
	`£t_bôm≠_fûe
(
mddev
, ()
¨g
);

6649 
d⁄e_u∆ock
;

6652 
îr
 = -
EINVAL
;

6653 
ab‹t_u∆ock
;

6656 
d⁄e_u∆ock
:

6657 
ab‹t_u∆ock
:

6658 i‡(
mddev
->
hﬁd_a˘ive
 =
UNTIL_IOCTL
 &&

6659 
îr
 !-
EINVAL
)

6660 
mddev
->
hﬁd_a˘ive
 = 0;

6661 
	`mddev_u∆ock
(
mddev
);

6663  
îr
;

6664 
d⁄e
:

6665 i‡(
îr
)

6666 
	`MD_BUG
();

6667 
ab‹t
:

6668  
îr
;

6669 
	}
}

6670 #ifde‡
CONFIG_COMPAT


6671 
	$md_com∑t_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

6672 
cmd
, 
¨g
)

6674 
cmd
) {

6675 
HOT_REMOVE_DISK
:

6676 
HOT_ADD_DISK
:

6677 
SET_DISK_FAULTY
:

6678 
SET_BITMAP_FILE
:

6682 
¨g
 = ()
	`com∑t_±r
(arg);

6686  
	`md_io˘l
(
bdev
, 
mode
, 
cmd
, 
¨g
);

6687 
	}
}

6690 
	$md_›í
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
)

6696 
mddev
 *mddev = 
	`mddev_föd
(
bdev
->
bd_dev
);

6697 
îr
;

6699 i‡(!
mddev
)

6700  -
ENODEV
;

6702 i‡(
mddev
->
gídisk
 !
bdev
->
bd_disk
) {

6706 
	`mddev_put
(
mddev
);

6708 
	`Êush_w‹kqueue
(
md_misc_wq
);

6710  -
ERESTARTSYS
;

6712 
	`BUG_ON
(
mddev
 !
bdev
->
bd_disk
->
¥iv©e_d©a
);

6714 i‡((
îr
 = 
	`muãx_lock_öãºu±ibÀ
(&
mddev
->
›í_muãx
)))

6715 
out
;

6717 
îr
 = 0;

6718 
	`©omic_öc
(&
mddev
->
›íîs
);

6719 
	`˛ór_bô
(
MD_STILL_CLOSED
, &
mddev
->
Êags
);

6720 
	`muãx_u∆ock
(&
mddev
->
›í_muãx
);

6722 
	`check_disk_ch™ge
(
bdev
);

6723 
out
:

6724  
îr
;

6725 
	}
}

6727 
	$md_ªÀa£
(
gídisk
 *
disk
, 
fmode_t
 
mode
)

6729 
mddev
 *mddev = 
disk
->
¥iv©e_d©a
;

6731 
	`BUG_ON
(!
mddev
);

6732 
	`©omic_dec
(&
mddev
->
›íîs
);

6733 
	`mddev_put
(
mddev
);

6734 
	}
}

6736 
	$md_medü_ch™ged
(
gídisk
 *
disk
)

6738 
mddev
 *mddev = 
disk
->
¥iv©e_d©a
;

6740  
mddev
->
ch™ged
;

6741 
	}
}

6743 
	$md_ªvÆid©e
(
gídisk
 *
disk
)

6745 
mddev
 *mddev = 
disk
->
¥iv©e_d©a
;

6747 
mddev
->
ch™ged
 = 0;

6749 
	}
}

6750 c⁄° 
block_devi˚_›î©i⁄s
 
	gmd_f›s
 =

6752 .
ow√r
 = 
THIS_MODULE
,

6753 .
	g›í
 = 
md_›í
,

6754 .
	gªÀa£
 = 
md_ªÀa£
,

6755 .
	gio˘l
 = 
md_io˘l
,

6756 #ifde‡
CONFIG_COMPAT


6757 .
	gcom∑t_io˘l
 = 
md_com∑t_io˘l
,

6759 .
	ggëgeo
 = 
md_gëgeo
,

6760 .
	gmedü_ch™ged
 = 
md_medü_ch™ged
,

6761 .
	gªvÆid©e_disk

md_ªvÆid©e
,

6764 
	$md_thªad
(* 
¨g
)

6766 
md_thªad
 *
thªad
 = 
¨g
;

6780 
	`Ælow_sig«l
(
SIGKILL
);

6781 !
	`kthªad_should_°›
()) {

6788 i‡(
	`sig«l_≥ndög
(
cuºít
))

6789 
	`Êush_sig«ls
(
cuºít
);

6791 
waô_evít_öãºu±ibÀ_timeout


6792 (
thªad
->
wqueue
,

6793 
	`ã°_bô
(
THREAD_WAKEUP
, &
thªad
->
Êags
)

6794 || 
	`kthªad_should_°›
(),

6795 
thªad
->
timeout
);

6797 
	`˛ór_bô
(
THREAD_WAKEUP
, &
thªad
->
Êags
);

6798 i‡(!
	`kthªad_should_°›
())

6799 
thªad
->
	`run
(thread);

6803 
	}
}

6805 
	$md_wakeup_thªad
(
md_thªad
 *
thªad
)

6807 i‡(
thªad
) {

6808 
	`¥_debug
("md: wakög u∞MDÅhªad %s.\n", 
thªad
->
tsk
->
comm
);

6809 
	`£t_bô
(
THREAD_WAKEUP
, &
thªad
->
Êags
);

6810 
	`wake_up
(&
thªad
->
wqueue
);

6812 
	}
}

6814 
md_thªad
 *
md_ªgi°î_thªad
((*
run
) (md_thread *),

6815 
mddev
 *mddev, c⁄° *
«me
)

6817 
md_thªad
 *
thªad
;

6819 
thªad
 = 
	`kzÆloc
((
md_thªad
), 
GFP_KERNEL
);

6820 i‡(!
thªad
)

6821  
NULL
;

6823 
	`öô_waôqueue_hód
(&
thªad
->
wqueue
);

6825 
thªad
->
run
 =Ñun;

6826 
thªad
->
mddev
 = mddev;

6827 
thªad
->
timeout
 = 
MAX_SCHEDULE_TIMEOUT
;

6828 
thªad
->
tsk
 = 
	`kthªad_run
(
md_thªad
,Åhread,

6830 
	`md«me
(
thªad
->
mddev
),

6831 
«me
);

6832 i‡(
	`IS_ERR
(
thªad
->
tsk
)) {

6833 
	`k‰ì
(
thªad
);

6834  
NULL
;

6836  
thªad
;

6837 
	}
}

6839 
	$md_uƒegi°î_thªad
(
md_thªad
 **
thªadp
)

6841 
md_thªad
 *
thªad
 = *
thªadp
;

6842 i‡(!
thªad
)

6844 
	`¥_debug
("öãºu±ög MD-thªadÖid %d\n", 
	`èsk_pid_ƒ
(
thªad
->
tsk
));

6848 
	`•ö_lock
(&
≥rs_lock
);

6849 *
thªadp
 = 
NULL
;

6850 
	`•ö_u∆ock
(&
≥rs_lock
);

6852 
	`kthªad_°›
(
thªad
->
tsk
);

6853 
	`k‰ì
(
thªad
);

6854 
	}
}

6856 
	$md_îr‹
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

6858 i‡(!
mddev
) {

6859 
	`MD_BUG
();

6863 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

6866 i‡(!
mddev
->
≥rs
 || !mddev->≥rs->
îr‹_h™dÀr
)

6868 
mddev
->
≥rs
->
	`îr‹_h™dÀr
(mddev,
rdev
);

6869 i‡(
mddev
->
degøded
)

6870 
	`£t_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

6871 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

6872 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

6873 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

6874 
	`md_wakeup_thªad
(
mddev
->
thªad
);

6875 i‡(
mddev
->
evít_w‹k
.
func
)

6876 
	`queue_w‹k
(
md_misc_wq
, &
mddev
->
evít_w‹k
);

6877 
	`md_√w_evít_ööå
(
mddev
);

6878 
	}
}

6882 
	$°©us_unu£d
(
£q_fûe
 *
£q
)

6884 
i
 = 0;

6885 
md_rdev
 *
rdev
;

6887 
	`£q_¥ötf
(
£q
, "unused devices: ");

6889 
	`li°_f‹_óch_íåy
(
rdev
, &
≥ndög_øid_disks
, 
ßme_£t
) {

6890 
b
[
BDEVNAME_SIZE
];

6891 
i
++;

6892 
	`£q_¥ötf
(
£q
, "%s ",

6893 
	`bdev«me
(
rdev
->
bdev
,
b
));

6895 i‡(!
i
)

6896 
	`£q_¥ötf
(
£q
, "<none>");

6898 
	`£q_¥ötf
(
£q
, "\n");

6899 
	}
}

6902 
	$°©us_ªsync
(
£q_fûe
 *
£q
, 
mddev
 * mddev)

6904 
£˘‹_t
 
max_£˘‹s
, 
ªsync
, 
ªs
;

6905 
dt
, 
db
;

6906 
£˘‹_t
 
π
;

6907 
sˇÀ
;

6908 
≥r_mûli
;

6910 i‡(
mddev
->
cuº_ªsync
 <= 3)

6911 
ªsync
 = 0;

6913 
ªsync
 = 
mddev
->
cuº_ªsync


6914 - 
	`©omic_ªad
(&
mddev
->
ªcovîy_a˘ive
);

6916 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) ||

6917 
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

6918 
max_£˘‹s
 = 
mddev
->
ªsync_max_£˘‹s
;

6920 
max_£˘‹s
 = 
mddev
->
dev_£˘‹s
;

6925 i‡(!
max_£˘‹s
) {

6926 
	`MD_BUG
();

6934 
sˇÀ
 = 10;

6935 i‡((
£˘‹_t
) > ()) {

6936  
max_£˘‹s
/2 > (1ULL<<(
sˇÀ
+32)))

6937 
sˇÀ
++;

6939 
ªs
 = (
ªsync
>>
sˇÀ
)*1000;

6940 
	`£˘‹_div
(
ªs
, (
u32
)((
max_£˘‹s
>>
sˇÀ
)+1));

6942 
≥r_mûli
 = 
ªs
;

6944 
i
, 
x
 = 
≥r_mûli
/50, 
y
 = 20-x;

6945 
	`£q_¥ötf
(
£q
, "[");

6946 
i
 = 0; i < 
x
; i++)

6947 
	`£q_¥ötf
(
£q
, "=");

6948 
	`£q_¥ötf
(
£q
, ">");

6949 
i
 = 0; i < 
y
; i++)

6950 
	`£q_¥ötf
(
£q
, ".");

6951 
	`£q_¥ötf
(
£q
, "] ");

6953 
	`£q_¥ötf
(
£q
, " %s =%3u.%u%% (%llu/%llu)",

6954 (
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
)?

6956 (
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
)?

6958 (
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) ?

6960 
≥r_mûli
/10,Öer_milli % 10,

6961 (Ë
ªsync
/2,

6962 (Ë
max_£˘‹s
/2);

6978 
dt
 = ((
jiffõs
 - 
mddev
->
ªsync_m¨k
Ë/ 
HZ
);

6979 i‡(!
dt
) dt++;

6980 
db
 = (
mddev
->
cuº_m¨k_˙t
 - 
	`©omic_ªad
(&mddev->
ªcovîy_a˘ive
))

6981 - 
mddev
->
ªsync_m¨k_˙t
;

6983 
π
 = 
max_£˘‹s
 - 
ªsync
;

6984 
	`£˘‹_div
(
π
, 
db
/32+1);

6985 
π
 *
dt
;

6986 
π
 >>= 5;

6988 
	`£q_¥ötf
(
£q
, " föish=%lu.%lumö", ()
π
 / 60,

6989 (()
π
 % 60)/6);

6991 
	`£q_¥ötf
(
£q
, " s≥ed=%ldK/£c", 
db
/2/
dt
);

6992 
	}
}

6994 *
	$md_£q_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

6996 
li°_hód
 *
tmp
;

6997 
loff_t
 
l
 = *
pos
;

6998 
mddev
 *mddev;

7000 i‡(
l
 >= 0x10000)

7001  
NULL
;

7002 i‡(!
l
--)

7006 
	`•ö_lock
(&
Æl_mddevs_lock
);

7007 
	`li°_f‹_óch
(
tmp
,&
Æl_mddevs
)

7008 i‡(!
l
--) {

7009 
mddev
 = 
	`li°_íåy
(
tmp
, mddev, 
Æl_mddevs
);

7010 
	`mddev_gë
(
mddev
);

7011 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

7012  
mddev
;

7014 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

7015 i‡(!
l
--)

7017  
NULL
;

7018 
	}
}

7020 *
	$md_£q_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

7022 
li°_hód
 *
tmp
;

7023 
mddev
 *
√xt_mddev
, *mddev = 
v
;

7025 ++*
pos
;

7026 i‡(
v
 == (*)2)

7027  
NULL
;

7029 
	`•ö_lock
(&
Æl_mddevs_lock
);

7030 i‡(
v
 == (*)1)

7031 
tmp
 = 
Æl_mddevs
.
√xt
;

7033 
tmp
 = 
mddev
->
Æl_mddevs
.
√xt
;

7034 i‡(
tmp
 !&
Æl_mddevs
)

7035 
√xt_mddev
 = 
	`mddev_gë
(
	`li°_íåy
(
tmp
,
mddev
,
Æl_mddevs
));

7037 
√xt_mddev
 = (*)2;

7038 *
pos
 = 0x10000;

7040 
	`•ö_u∆ock
(&
Æl_mddevs_lock
);

7042 i‡(
v
 != (*)1)

7043 
	`mddev_put
(
mddev
);

7044  
√xt_mddev
;

7046 
	}
}

7048 
	$md_£q_°›
(
£q_fûe
 *
£q
, *
v
)

7050 
mddev
 *mddev = 
v
;

7052 i‡(
mddev
 && 
v
 != (*)1 && v != (*)2)

7053 
	`mddev_put
(
mddev
);

7054 
	}
}

7056 
	$md_£q_show
(
£q_fûe
 *
£q
, *
v
)

7058 
mddev
 *mddev = 
v
;

7059 
£˘‹_t
 
£˘‹s
;

7060 
md_rdev
 *
rdev
;

7062 i‡(
v
 == (*)1) {

7063 
md_≥rs⁄Æôy
 *
≥rs
;

7064 
	`£q_¥ötf
(
£q
, "Personalities : ");

7065 
	`•ö_lock
(&
≥rs_lock
);

7066 
	`li°_f‹_óch_íåy
(
≥rs
, &
≥rs_li°
, 
li°
)

7067 
	`£q_¥ötf
(
£q
, "[%s] ", 
≥rs
->
«me
);

7069 
	`•ö_u∆ock
(&
≥rs_lock
);

7070 
	`£q_¥ötf
(
£q
, "\n");

7071 
£q
->
pﬁl_evít
 = 
	`©omic_ªad
(&
md_evít_cou¡
);

7074 i‡(
v
 == (*)2) {

7075 
	`°©us_unu£d
(
£q
);

7079 i‡(
	`mddev_lock
(
mddev
) < 0)

7080  -
EINTR
;

7082 i‡(
mddev
->
≥rs
 || mddev->
øid_disks
 || !
	`li°_em±y
(&mddev->
disks
)) {

7083 
	`£q_¥ötf
(
£q
, "%†: %ß˘ive", 
	`md«me
(
mddev
),

7084 
mddev
->
≥rs
 ? "" : "in");

7085 i‡(
mddev
->
≥rs
) {

7086 i‡(
mddev
->
ro
==1)

7087 
	`£q_¥ötf
(
£q
, " (read-only)");

7088 i‡(
mddev
->
ro
==2)

7089 
	`£q_¥ötf
(
£q
, " (auto-read-only)");

7090 
	`£q_¥ötf
(
£q
, " %s", 
mddev
->
≥rs
->
«me
);

7093 
£˘‹s
 = 0;

7094 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

7095 
b
[
BDEVNAME_SIZE
];

7096 
	`£q_¥ötf
(
£q
, " %s[%d]",

7097 
	`bdev«me
(
rdev
->
bdev
,
b
),Ñdev->
desc_ƒ
);

7098 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
))

7099 
	`£q_¥ötf
(
£q
, "(W)");

7100 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

7101 
	`£q_¥ötf
(
£q
, "(F)");

7104 i‡(
rdev
->
øid_disk
 < 0)

7105 
	`£q_¥ötf
(
£q
, "(S)");

7106 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
))

7107 
	`£q_¥ötf
(
£q
, "(R)");

7108 
£˘‹s
 +
rdev
->sectors;

7111 i‡(!
	`li°_em±y
(&
mddev
->
disks
)) {

7112 i‡(
mddev
->
≥rs
)

7113 
	`£q_¥ötf
(
£q
, "\n %llu blocks",

7115 
mddev
->
¨øy_£˘‹s
 / 2);

7117 
	`£q_¥ötf
(
£q
, "\n %llu blocks",

7118 ()
£˘‹s
 / 2);

7120 i‡(
mddev
->
≥rsi°ít
) {

7121 i‡(
mddev
->
maj‹_vîsi⁄
 != 0 ||

7122 
mddev
->
mö‹_vîsi⁄
 != 90) {

7123 
	`£q_¥ötf
(
£q
," super %d.%d",

7124 
mddev
->
maj‹_vîsi⁄
,

7125 
mddev
->
mö‹_vîsi⁄
);

7127 } i‡(
mddev
->
exã∫Æ
)

7128 
	`£q_¥ötf
(
£q
, " superÉxternal:%s",

7129 
mddev
->
mëad©a_ty≥
);

7131 
	`£q_¥ötf
(
£q
, " superÇon-persistent");

7133 i‡(
mddev
->
≥rs
) {

7134 
mddev
->
≥rs
->
	`°©us
(
£q
, mddev);

7135 
	`£q_¥ötf
(
£q
, "\n ");

7136 i‡(
mddev
->
≥rs
->
sync_ªque°
) {

7137 i‡(
mddev
->
cuº_ªsync
 > 2) {

7138 
	`°©us_ªsync
(
£q
, 
mddev
);

7139 
	`£q_¥ötf
(
£q
, "\n ");

7140 } i‡(
mddev
->
cuº_ªsync
 >= 1)

7141 
	`£q_¥ötf
(
£q
, "\tresync=DELAYED\n ");

7142 i‡(
mddev
->
ªcovîy_˝
 < 
MaxSe˘‹
)

7143 
	`£q_¥ötf
(
£q
, "\tresync=PENDING\n ");

7146 
	`£q_¥ötf
(
£q
, "\n ");

7148 
	`bôm≠_°©us
(
£q
, 
mddev
->
bôm≠
);

7150 
	`£q_¥ötf
(
£q
, "\n");

7152 
	`mddev_u∆ock
(
mddev
);

7155 
	}
}

7157 c⁄° 
£q_›î©i⁄s
 
	gmd_£q_›s
 = {

7158 .
°¨t
 = 
md_£q_°¨t
,

7159 .
	g√xt
 = 
md_£q_√xt
,

7160 .
	g°›
 = 
md_£q_°›
,

7161 .
	gshow
 = 
md_£q_show
,

7164 
	$md_£q_›í
(
öode
 *öode, 
fûe
 *file)

7166 
£q_fûe
 *
£q
;

7167 
îr‹
;

7169 
îr‹
 = 
	`£q_›í
(
fûe
, &
md_£q_›s
);

7170 i‡(
îr‹
)

7171  
îr‹
;

7173 
£q
 = 
fûe
->
¥iv©e_d©a
;

7174 
£q
->
pﬁl_evít
 = 
	`©omic_ªad
(&
md_evít_cou¡
);

7175  
îr‹
;

7176 
	}
}

7178 
	gmd_u∆ﬂdög
;

7179 
	$md°©_pﬁl
(
fûe
 *
fûp
, 
pﬁl_èbÀ
 *
waô
)

7181 
£q_fûe
 *
£q
 = 
fûp
->
¥iv©e_d©a
;

7182 
mask
;

7184 i‡(
md_u∆ﬂdög
)

7185  
POLLIN
|
POLLRDNORM
|
POLLERR
|
POLLPRI
;;

7186 
	`pﬁl_waô
(
fûp
, &
md_evít_waôîs
, 
waô
);

7189 
mask
 = 
POLLIN
 | 
POLLRDNORM
;

7191 i‡(
£q
->
pﬁl_evít
 !
	`©omic_ªad
(&
md_evít_cou¡
))

7192 
mask
 |
POLLERR
 | 
POLLPRI
;

7193  
mask
;

7194 
	}
}

7196 c⁄° 
fûe_›î©i⁄s
 
	gmd_£q_f›s
 = {

7197 .
ow√r
 = 
THIS_MODULE
,

7198 .
	g›í
 = 
md_£q_›í
,

7199 .
	gªad
 = 
£q_ªad
,

7200 .
	gŒ£ek
 = 
£q_l£ek
,

7201 .
	gªÀa£
 = 
£q_ªÀa£_¥iv©e
,

7202 .
	gpﬁl
 = 
md°©_pﬁl
,

7205 
	$ªgi°î_md_≥rs⁄Æôy
(
md_≥rs⁄Æôy
 *
p
)

7207 
	`•ö_lock
(&
≥rs_lock
);

7208 
	`li°_add_èû
(&
p
->
li°
, &
≥rs_li°
);

7209 
	`¥ötk
(
KERN_INFO
 "md: %†≥rs⁄ÆôyÑegi°îed f‹Üevñ %d\n", 
p
->
«me
,Ö->
Àvñ
);

7210 
	`•ö_u∆ock
(&
≥rs_lock
);

7212 
	}
}

7214 
	$uƒegi°î_md_≥rs⁄Æôy
(
md_≥rs⁄Æôy
 *
p
)

7216 
	`¥ötk
(
KERN_INFO
 "md: %†≥rs⁄Æôy uƒegi°îed\n", 
p
->
«me
);

7217 
	`•ö_lock
(&
≥rs_lock
);

7218 
	`li°_dñ_öô
(&
p
->
li°
);

7219 
	`•ö_u∆ock
(&
≥rs_lock
);

7221 
	}
}

7223 
	$is_mddev_idÀ
(
mddev
 *mddev, 
öô
)

7225 
md_rdev
 * 
rdev
;

7226 
idÀ
;

7227 
cuº_evíts
;

7229 
idÀ
 = 1;

7230 
	`rcu_ªad_lock
();

7231 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
) {

7232 
gídisk
 *
disk
 = 
rdev
->
bdev
->
bd_c⁄èös
->
bd_disk
;

7233 
cuº_evíts
 = ()
	`∑π_°©_ªad
(&
disk
->
∑π0
, 
£˘‹s
[0]) +

7234 ()
	`∑π_°©_ªad
(&
disk
->
∑π0
, 
£˘‹s
[1]) -

7235 
	`©omic_ªad
(&
disk
->
sync_io
);

7258 i‡(
öô
 || 
cuº_evíts
 - 
rdev
->
œ°_evíts
 > 64) {

7259 
rdev
->
œ°_evíts
 = 
cuº_evíts
;

7260 
idÀ
 = 0;

7263 
	`rcu_ªad_u∆ock
();

7264  
idÀ
;

7265 
	}
}

7267 
	$md_d⁄e_sync
(
mddev
 *mddev, 
blocks
, 
ok
)

7270 
	`©omic_sub
(
blocks
, &
mddev
->
ªcovîy_a˘ive
);

7271 
	`wake_up
(&
mddev
->
ªcovîy_waô
);

7272 i‡(!
ok
) {

7273 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

7274 
	`£t_bô
(
MD_RECOVERY_ERROR
, &
mddev
->
ªcovîy
);

7275 
	`md_wakeup_thªad
(
mddev
->
thªad
);

7278 
	}
}

7286 
	$md_wrôe_°¨t
(
mddev
 *mddev, 
bio
 *
bi
)

7288 
did_ch™ge
 = 0;

7289 i‡(
	`bio_d©a_dú
(
bi
Ë!
WRITE
)

7292 
	`BUG_ON
(
mddev
->
ro
 == 1);

7293 i‡(
mddev
->
ro
 == 2) {

7295 
mddev
->
ro
 = 0;

7296 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

7297 
	`md_wakeup_thªad
(
mddev
->
thªad
);

7298 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

7299 
did_ch™ge
 = 1;

7301 
	`©omic_öc
(&
mddev
->
wrôes_≥ndög
);

7302 i‡(
mddev
->
ß„mode
 == 1)

7303 
mddev
->
ß„mode
 = 0;

7304 i‡(
mddev
->
ö_sync
) {

7305 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

7306 i‡(
mddev
->
ö_sync
) {

7307 
mddev
->
ö_sync
 = 0;

7308 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

7309 
	`£t_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

7310 
	`md_wakeup_thªad
(
mddev
->
thªad
);

7311 
did_ch™ge
 = 1;

7313 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

7315 i‡(
did_ch™ge
)

7316 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

7317 
	`waô_evít
(
mddev
->
sb_waô
,

7318 !
	`ã°_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
));

7319 
	}
}

7321 
	$md_wrôe_íd
(
mddev
 *mddev)

7323 i‡(
	`©omic_dec_™d_ã°
(&
mddev
->
wrôes_≥ndög
)) {

7324 i‡(
mddev
->
ß„mode
 == 2)

7325 
	`md_wakeup_thªad
(
mddev
->
thªad
);

7326 i‡(
mddev
->
ß„mode_dñay
)

7327 
	`mod_timî
(&
mddev
->
ß„mode_timî
, 
jiffõs
 + mddev->
ß„mode_dñay
);

7329 
	}
}

7340 
	$md_Ælow_wrôe
(
mddev
 *mddev)

7342 i‡(!
mddev
->
≥rs
)

7344 i‡(
mddev
->
ro
)

7346 i‡(!
mddev
->
≥rs
->
sync_ªque°
)

7349 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

7350 i‡(
mddev
->
ö_sync
) {

7351 
mddev
->
ö_sync
 = 0;

7352 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

7353 
	`£t_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

7354 i‡(
mddev
->
ß„mode_dñay
 &&

7355 
mddev
->
ß„mode
 == 0)

7356 
mddev
->
ß„mode
 = 1;

7357 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

7358 
	`md_upd©e_sb
(
mddev
, 0);

7359 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

7361 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

7363 i‡(
	`ã°_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
))

7364  -
EAGAIN
;

7367 
	}
}

7368 
EXPORT_SYMBOL_GPL
(
md_Ælow_wrôe
);

7370 
	#SYNC_MARKS
 10

	)

7371 
	#SYNC_MARK_STEP
 (3*
HZ
)

	)

7372 
	#UPDATE_FREQUENCY
 (5*60*
HZ
)

	)

7373 
	$md_do_sync
(
md_thªad
 *
thªad
)

7375 
mddev
 *mddev = 
thªad
->mddev;

7376 
mddev
 *
mddev2
;

7377 
cuº•ìd
 = 0,

7378 
wödow
;

7379 
£˘‹_t
 
max_£˘‹s
,
j
, 
io_£˘‹s
, 
ªcovîy_d⁄e
;

7380 
m¨k
[
SYNC_MARKS
];

7381 
upd©e_time
;

7382 
£˘‹_t
 
m¨k_˙t
[
SYNC_MARKS
];

7383 
œ°_m¨k
,
m
;

7384 
li°_hód
 *
tmp
;

7385 
£˘‹_t
 
œ°_check
;

7386 
skù≥d
 = 0;

7387 
md_rdev
 *
rdev
;

7388 *
desc
, *
a˘i⁄
 = 
NULL
;

7389 
blk_∂ug
 
∂ug
;

7392 i‡(
	`ã°_bô
(
MD_RECOVERY_DONE
, &
mddev
->
ªcovîy
))

7394 i‡(
mddev
->
ro
) {

7395 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

7399 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

7400 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
)) {

7401 
desc
 = "data-check";

7402 
a˘i⁄
 = "check";

7403 } i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
)) {

7404 
desc
 = "requested-resync";

7405 
a˘i⁄
 = "repair";

7407 
desc
 = "resync";

7408 } i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

7409 
desc
 = "reshape";

7411 
desc
 = "recovery";

7413 
mddev
->
œ°_sync_a˘i⁄
 = 
a˘i⁄
 ?: 
desc
;

7432 
mddev
->
cuº_ªsync
 = 2;

7434 
åy_agaö
:

7435 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

7436 
skù
;

7437 
	`f‹_óch_mddev
(
mddev2
, 
tmp
) {

7438 i‡(
mddev2
 =
mddev
)

7440 i‡(!
mddev
->
∑øŒñ_ªsync


7441 && 
mddev2
->
cuº_ªsync


7442 && 
	`m©ch_mddev_unôs
(
mddev
, 
mddev2
)) {

7443 
	`DEFINE_WAIT
(
wq
);

7444 i‡(
mddev
 < 
mddev2
 && mddev->
cuº_ªsync
 == 2) {

7446 
mddev
->
cuº_ªsync
 = 1;

7447 
	`wake_up
(&
ªsync_waô
);

7449 i‡(
mddev
 > 
mddev2
 && mddev->
cuº_ªsync
 == 1)

7458 
	`¥ï¨e_to_waô
(&
ªsync_waô
, &
wq
, 
TASK_INTERRUPTIBLE
);

7459 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
) &&

7460 
mddev2
->
cuº_ªsync
 >
mddev
->curr_resync) {

7461 
	`¥ötk
(
KERN_INFO
 "md: delaying %s of %s"

7464 
desc
, 
	`md«me
(
mddev
), md«me(
mddev2
));

7465 
	`mddev_put
(
mddev2
);

7466 i‡(
	`sig«l_≥ndög
(
cuºít
))

7467 
	`Êush_sig«ls
(
cuºít
);

7468 
	`scheduÀ
();

7469 
	`föish_waô
(&
ªsync_waô
, &
wq
);

7470 
åy_agaö
;

7472 
	`föish_waô
(&
ªsync_waô
, &
wq
);

7475 } 
mddev
->
cuº_ªsync
 < 2);

7477 
j
 = 0;

7478 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

7482 
max_£˘‹s
 = 
mddev
->
ªsync_max_£˘‹s
;

7483 
	`©omic64_£t
(&
mddev
->
ªsync_mism©ches
, 0);

7485 i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

7486 
j
 = 
mddev
->
ªsync_mö
;

7487 i‡(!
mddev
->
bôm≠
)

7488 
j
 = 
mddev
->
ªcovîy_˝
;

7490 } i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

7491 
max_£˘‹s
 = 
mddev
->
ªsync_max_£˘‹s
;

7494 
max_£˘‹s
 = 
mddev
->
dev_£˘‹s
;

7495 
j
 = 
MaxSe˘‹
;

7496 
	`rcu_ªad_lock
();

7497 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
)

7498 i‡(
rdev
->
øid_disk
 >= 0 &&

7499 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

7500 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

7501 
rdev
->
ªcovîy_off£t
 < 
j
)

7502 
j
 = 
rdev
->
ªcovîy_off£t
;

7503 
	`rcu_ªad_u∆ock
();

7513 i‡(
mddev
->
bôm≠
) {

7514 
mddev
->
≥rs
->
	`quõs˚
(mddev, 1);

7515 
mddev
->
≥rs
->
	`quõs˚
(mddev, 0);

7519 
	`¥ötk
(
KERN_INFO
 "md: %†o‡RAIDáºay %s\n", 
desc
, 
	`md«me
(
mddev
));

7520 
	`¥ötk
(
KERN_INFO
 "md: minimum _guaranteed_ speed:"

7521 " %d KB/£c/disk.\n", 
	`•ìd_mö
(
mddev
));

7522 
	`¥ötk
(
KERN_INFO
 "md: using maximumávailable idle IO bandwidth "

7524 
	`•ìd_max
(
mddev
), 
desc
);

7526 
	`is_mddev_idÀ
(
mddev
, 1);

7528 
io_£˘‹s
 = 0;

7529 
m
 = 0; m < 
SYNC_MARKS
; m++) {

7530 
m¨k
[
m
] = 
jiffõs
;

7531 
m¨k_˙t
[
m
] = 
io_£˘‹s
;

7533 
œ°_m¨k
 = 0;

7534 
mddev
->
ªsync_m¨k
 = 
m¨k
[
œ°_m¨k
];

7535 
mddev
->
ªsync_m¨k_˙t
 = 
m¨k_˙t
[
œ°_m¨k
];

7540 
wödow
 = 32*(
PAGE_SIZE
/512);

7541 
	`¥ötk
(
KERN_INFO
 "md: using %dk window, overáÅotal of %lluk.\n",

7542 
wödow
/2, ()
max_£˘‹s
/2);

7544 
	`©omic_£t
(&
mddev
->
ªcovîy_a˘ive
, 0);

7545 
œ°_check
 = 0;

7547 i‡(
j
>2) {

7548 
	`¥ötk
(
KERN_INFO


7550 
desc
, 
	`md«me
(
mddev
));

7551 
mddev
->
cuº_ªsync
 = 
j
;

7553 
mddev
->
cuº_ªsync
 = 3;

7554 
mddev
->
cuº_ªsync_com∂ëed
 = 
j
;

7555 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

7556 
	`md_√w_evít
(
mddev
);

7557 
upd©e_time
 = 
jiffõs
;

7559 
	`blk_°¨t_∂ug
(&
∂ug
);

7560 
j
 < 
max_£˘‹s
) {

7561 
£˘‹_t
 
£˘‹s
;

7563 
skù≥d
 = 0;

7565 i‡(!
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
) &&

7566 ((
mddev
->
cuº_ªsync
 > mddev->
cuº_ªsync_com∂ëed
 &&

7567 (
mddev
->
cuº_ªsync
 - mddev->
cuº_ªsync_com∂ëed
)

7568 > (
max_£˘‹s
 >> 4)) ||

7569 
	`time_a·î_eq
(
jiffõs
, 
upd©e_time
 + 
UPDATE_FREQUENCY
) ||

7570 (
j
 - 
mddev
->
cuº_ªsync_com∂ëed
)*2

7571 >
mddev
->
ªsync_max
 - mddev->
cuº_ªsync_com∂ëed


7574 
	`waô_evít
(
mddev
->
ªcovîy_waô
,

7575 
	`©omic_ªad
(&
mddev
->
ªcovîy_a˘ive
) == 0);

7576 
mddev
->
cuº_ªsync_com∂ëed
 = 
j
;

7577 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) &&

7578 
j
 > 
mddev
->
ªcovîy_˝
)

7579 
mddev
->
ªcovîy_˝
 = 
j
;

7580 
upd©e_time
 = 
jiffõs
;

7581 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

7582 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

7585 
j
 >
mddev
->
ªsync_max
 &&

7586 !
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)) {

7591 
	`Êush_sig«ls
(
cuºít
);

7592 
	`waô_evít_öãºu±ibÀ
(
mddev
->
ªcovîy_waô
,

7593 
mddev
->
ªsync_max
 > 
j


7594 || 
	`ã°_bô
(
MD_RECOVERY_INTR
,

7595 &
mddev
->
ªcovîy
));

7598 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

7601 
£˘‹s
 = 
mddev
->
≥rs
->
	`sync_ªque°
(mddev, 
j
, &
skù≥d
,

7602 
cuº•ìd
 < 
	`•ìd_mö
(
mddev
));

7603 i‡(
£˘‹s
 == 0) {

7604 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

7608 i‡(!
skù≥d
) {

7609 
io_£˘‹s
 +
£˘‹s
;

7610 
	`©omic_add
(
£˘‹s
, &
mddev
->
ªcovîy_a˘ive
);

7613 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

7616 
j
 +
£˘‹s
;

7617 i‡(
j
 > 2)

7618 
mddev
->
cuº_ªsync
 = 
j
;

7619 
mddev
->
cuº_m¨k_˙t
 = 
io_£˘‹s
;

7620 i‡(
œ°_check
 == 0)

7624 
	`md_√w_evít
(
mddev
);

7626 i‡(
œ°_check
 + 
wödow
 > 
io_£˘‹s
 || 
j
 =
max_£˘‹s
)

7629 
œ°_check
 = 
io_£˘‹s
;

7630 
ª≥©
:

7631 i‡(
	`time_a·î_eq
(
jiffõs
, 
m¨k
[
œ°_m¨k
] + 
SYNC_MARK_STEP
 )) {

7633 
√xt
 = (
œ°_m¨k
+1Ë% 
SYNC_MARKS
;

7635 
mddev
->
ªsync_m¨k
 = 
m¨k
[
√xt
];

7636 
mddev
->
ªsync_m¨k_˙t
 = 
m¨k_˙t
[
√xt
];

7637 
m¨k
[
√xt
] = 
jiffõs
;

7638 
m¨k_˙t
[
√xt
] = 
io_£˘‹s
 - 
	`©omic_ªad
(&
mddev
->
ªcovîy_a˘ive
);

7639 
œ°_m¨k
 = 
√xt
;

7642 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

7653 
	`c⁄d_ªsched
();

7655 
ªcovîy_d⁄e
 = 
io_£˘‹s
 - 
	`©omic_ªad
(&
mddev
->
ªcovîy_a˘ive
);

7656 
cuº•ìd
 = (()(
ªcovîy_d⁄e
 - 
mddev
->
ªsync_m¨k_˙t
))/2

7657 /((
jiffõs
-
mddev
->
ªsync_m¨k
)/
HZ
 +1) +1;

7659 i‡(
cuº•ìd
 > 
	`•ìd_mö
(
mddev
)) {

7660 i‡((
cuº•ìd
 > 
	`•ìd_max
(
mddev
)) ||

7661 !
	`is_mddev_idÀ
(
mddev
, 0)) {

7662 
	`m¶ìp
(500);

7663 
ª≥©
;

7667 
	`¥ötk
(
KERN_INFO
 "md: %s: %†%s.\n",
	`md«me
(
mddev
), 
desc
,

7668 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)

7673 
	`blk_föish_∂ug
(&
∂ug
);

7674 
	`waô_evít
(
mddev
->
ªcovîy_waô
, !
	`©omic_ªad
(&mddev->
ªcovîy_a˘ive
));

7677 
mddev
->
≥rs
->
	`sync_ªque°
(mddev, 
max_£˘‹s
, &
skù≥d
, 1);

7679 i‡(!
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
) &&

7680 
mddev
->
cuº_ªsync
 > 2) {

7681 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

7682 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)) {

7683 i‡(
mddev
->
cuº_ªsync
 >mddev->
ªcovîy_˝
) {

7684 
	`¥ötk
(
KERN_INFO


7686 
desc
, 
	`md«me
(
mddev
));

7687 i‡(
	`ã°_bô
(
MD_RECOVERY_ERROR
,

7688 &
mddev
->
ªcovîy
))

7689 
mddev
->
ªcovîy_˝
 =

7690 
mddev
->
cuº_ªsync_com∂ëed
;

7692 
mddev
->
ªcovîy_˝
 =

7693 
mddev
->
cuº_ªsync
;

7696 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

7698 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

7699 
mddev
->
cuº_ªsync
 = 
MaxSe˘‹
;

7700 
	`rcu_ªad_lock
();

7701 
	`rdev_f‹_óch_rcu
(
rdev
, 
mddev
)

7702 i‡(
rdev
->
øid_disk
 >= 0 &&

7703 
mddev
->
dñè_disks
 >= 0 &&

7704 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

7705 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

7706 
rdev
->
ªcovîy_off£t
 < 
mddev
->
cuº_ªsync
)

7707 
rdev
->
ªcovîy_off£t
 = 
mddev
->
cuº_ªsync
;

7708 
	`rcu_ªad_u∆ock
();

7711 
skù
:

7712 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

7714 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)) {

7716 i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

7717 
mddev
->
ªsync_mö
 = 0;

7718 
mddev
->
ªsync_max
 = 
MaxSe˘‹
;

7719 } i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

7720 
mddev
->
ªsync_mö
 = mddev->
cuº_ªsync_com∂ëed
;

7721 
mddev
->
cuº_ªsync
 = 0;

7722 
	`wake_up
(&
ªsync_waô
);

7723 
	`£t_bô
(
MD_RECOVERY_DONE
, &
mddev
->
ªcovîy
);

7724 
	`md_wakeup_thªad
(
mddev
->
thªad
);

7726 
	}
}

7727 
EXPORT_SYMBOL_GPL
(
md_do_sync
);

7729 
	$ªmove_™d_add_•¨es
(
mddev
 *mddev,

7730 
md_rdev
 *
this
)

7732 
md_rdev
 *
rdev
;

7733 
•¨es
 = 0;

7734 
ªmoved
 = 0;

7736 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

7737 i‡((
this
 =
NULL
 || 
rdev
 ==Åhis) &&

7738 
rdev
->
øid_disk
 >= 0 &&

7739 !
	`ã°_bô
(
Blocked
, &
rdev
->
Êags
) &&

7740 (
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) ||

7741 ! 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) &&

7742 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)==0) {

7743 i‡(
mddev
->
≥rs
->
	`hŸ_ªmove_disk
(

7744 
mddev
, 
rdev
) == 0) {

7745 
	`sysfs_u∆ök_rdev
(
mddev
, 
rdev
);

7746 
rdev
->
øid_disk
 = -1;

7747 
ªmoved
++;

7750 i‡(
ªmoved
 && 
mddev
->
kobj
.
sd
)

7751 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "degraded");

7753 i‡(
this
)

7754 
no_add
;

7756 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

7757 i‡(
rdev
->
øid_disk
 >= 0 &&

7758 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

7759 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

7760 
•¨es
++;

7761 i‡(
rdev
->
øid_disk
 >= 0)

7763 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

7765 i‡(
mddev
->
ro
 &&

7766 ! (
rdev
->
ßved_øid_disk
 >= 0 &&

7767 !
	`ã°_bô
(
Bôm≠_sync
, &
rdev
->
Êags
)))

7770 i‡(
rdev
->
ßved_øid_disk
 < 0)

7771 
rdev
->
ªcovîy_off£t
 = 0;

7772 i‡(
mddev
->
≥rs
->

7773 
	`hŸ_add_disk
(
mddev
, 
rdev
) == 0) {

7774 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

7776 
•¨es
++;

7777 
	`md_√w_evít
(
mddev
);

7778 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

7781 
no_add
:

7782 i‡(
ªmoved
)

7783 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

7784  
•¨es
;

7785 
	}
}

7809 
	$md_check_ªcovîy
(
mddev
 *mddev)

7811 i‡(
mddev
->
su•íded
)

7814 i‡(
mddev
->
bôm≠
)

7815 
	`bôm≠_d´m⁄_w‹k
(
mddev
);

7817 i‡(
	`sig«l_≥ndög
(
cuºít
)) {

7818 i‡(
mddev
->
≥rs
->
sync_ªque°
 && !mddev->
exã∫Æ
) {

7819 
	`¥ötk
(
KERN_INFO
 "md: %s in immediate safe mode\n",

7820 
	`md«me
(
mddev
));

7821 
mddev
->
ß„mode
 = 2;

7823 
	`Êush_sig«ls
(
cuºít
);

7826 i‡(
mddev
->
ro
 && !
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &mddev->
ªcovîy
))

7829 (
mddev
->
Êags
 & 
MD_UPDATE_SB_FLAGS
 & ~ (1<<
MD_CHANGE_PENDING
)) ||

7830 
	`ã°_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
) ||

7831 
	`ã°_bô
(
MD_RECOVERY_DONE
, &
mddev
->
ªcovîy
) ||

7832 (
mddev
->
exã∫Æ
 =0 && mddev->
ß„mode
 == 1) ||

7833 (
mddev
->
ß„mode
 =2 && ! 
	`©omic_ªad
(&mddev->
wrôes_≥ndög
)

7834 && !
mddev
->
ö_sync
 && mddev->
ªcovîy_˝
 =
MaxSe˘‹
)

7838 i‡(
	`mddev_åylock
(
mddev
)) {

7839 
•¨es
 = 0;

7841 i‡(
mddev
->
ro
) {

7849 
	`ªmove_™d_add_•¨es
(
mddev
, 
NULL
);

7853 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

7854 
	`md_ª≠_sync_thªad
(
mddev
);

7855 
	`˛ór_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

7856 
u∆ock
;

7859 i‡(!
mddev
->
exã∫Æ
) {

7860 
did_ch™ge
 = 0;

7861 
	`•ö_lock_úq
(&
mddev
->
wrôe_lock
);

7862 i‡(
mddev
->
ß„mode
 &&

7863 !
	`©omic_ªad
(&
mddev
->
wrôes_≥ndög
) &&

7864 !
mddev
->
ö_sync
 &&

7865 
mddev
->
ªcovîy_˝
 =
MaxSe˘‹
) {

7866 
mddev
->
ö_sync
 = 1;

7867 
did_ch™ge
 = 1;

7868 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
mddev
->
Êags
);

7870 i‡(
mddev
->
ß„mode
 == 1)

7871 
mddev
->
ß„mode
 = 0;

7872 
	`•ö_u∆ock_úq
(&
mddev
->
wrôe_lock
);

7873 i‡(
did_ch™ge
)

7874 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_°©e
);

7877 i‡(
mddev
->
Êags
 & 
MD_UPDATE_SB_FLAGS
)

7878 
	`md_upd©e_sb
(
mddev
, 0);

7880 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
) &&

7881 !
	`ã°_bô
(
MD_RECOVERY_DONE
, &
mddev
->
ªcovîy
)) {

7883 
	`˛ór_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

7884 
u∆ock
;

7886 i‡(
mddev
->
sync_thªad
) {

7887 
	`md_ª≠_sync_thªad
(
mddev
);

7888 
u∆ock
;

7893 
mddev
->
cuº_ªsync_com∂ëed
 = 0;

7894 
	`£t_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

7898 
	`˛ór_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

7899 
	`˛ór_bô
(
MD_RECOVERY_DONE
, &
mddev
->
ªcovîy
);

7901 i‡(!
	`ã°_™d_˛ór_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
) ||

7902 
	`ã°_bô
(
MD_RECOVERY_FROZEN
, &
mddev
->
ªcovîy
))

7903 
u∆ock
;

7911 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
) {

7912 i‡(
mddev
->
≥rs
->
check_ªsh≠e
 =
NULL
 ||

7913 
mddev
->
≥rs
->
	`check_ªsh≠e
(mddev) != 0)

7915 
u∆ock
;

7916 
	`£t_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

7917 
	`˛ór_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

7918 } i‡((
•¨es
 = 
	`ªmove_™d_add_•¨es
(
mddev
, 
NULL
))) {

7919 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

7920 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

7921 
	`˛ór_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
);

7922 
	`£t_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

7923 } i‡(
mddev
->
ªcovîy_˝
 < 
MaxSe˘‹
) {

7924 
	`£t_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

7925 
	`˛ór_bô
(
MD_RECOVERY_RECOVER
, &
mddev
->
ªcovîy
);

7926 } i‡(!
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
))

7928 
u∆ock
;

7930 i‡(
mddev
->
≥rs
->
sync_ªque°
) {

7931 i‡(
•¨es
) {

7936 
	`bôm≠_wrôe_Æl
(
mddev
->
bôm≠
);

7938 
mddev
->
sync_thªad
 = 
	`md_ªgi°î_thªad
(
md_do_sync
,

7939 
mddev
,

7941 i‡(!
mddev
->
sync_thªad
) {

7942 
	`¥ötk
(
KERN_ERR
 "%s: couldÇot startÑesync"

7944 
	`md«me
(
mddev
));

7946 
	`˛ór_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

7947 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

7948 
	`˛ór_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

7949 
	`˛ór_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
);

7950 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

7952 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

7953 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_a˘i⁄
);

7954 
	`md_√w_evít
(
mddev
);

7956 
u∆ock
:

7957 
	`wake_up
(&
mddev
->
sb_waô
);

7959 i‡(!
mddev
->
sync_thªad
) {

7960 
	`˛ór_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

7961 i‡(
	`ã°_™d_˛ór_bô
(
MD_RECOVERY_RECOVER
,

7962 &
mddev
->
ªcovîy
))

7963 i‡(
mddev
->
sysfs_a˘i⁄
)

7964 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_a˘i⁄
);

7966 
	`mddev_u∆ock
(
mddev
);

7968 
	}
}

7970 
	$md_ª≠_sync_thªad
(
mddev
 *mddev)

7972 
md_rdev
 *
rdev
;

7975 
	`md_uƒegi°î_thªad
(&
mddev
->
sync_thªad
);

7976 
	`wake_up
(&
ªsync_waô
);

7977 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
) &&

7978 !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
)) {

7981 i‡(
mddev
->
≥rs
->
	`•¨e_a˘ive
(mddev)) {

7982 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
,

7984 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

7987 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
) &&

7988 
mddev
->
≥rs
->
föish_ªsh≠e
)

7989 
mddev
->
≥rs
->
	`föish_ªsh≠e
(mddev);

7994 i‡(!
mddev
->
degøded
)

7995 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

7996 
rdev
->
ßved_øid_disk
 = -1;

7998 
	`md_upd©e_sb
(
mddev
, 1);

7999 
	`˛ór_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

8000 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

8001 
	`˛ór_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

8002 
	`˛ór_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
);

8003 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

8005 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

8006 
	`sysfs_nŸify_dúít_ß„
(
mddev
->
sysfs_a˘i⁄
);

8007 
	`md_√w_evít
(
mddev
);

8008 i‡(
mddev
->
evít_w‹k
.
func
)

8009 
	`queue_w‹k
(
md_misc_wq
, &
mddev
->
evít_w‹k
);

8010 
	}
}

8012 
	$md_waô_f‹_blocked_rdev
(
md_rdev
 *
rdev
, 
mddev
 *mddev)

8014 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

8015 
	`waô_evít_timeout
(
rdev
->
blocked_waô
,

8016 !
	`ã°_bô
(
Blocked
, &
rdev
->
Êags
) &&

8017 !
	`ã°_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
),

8018 
	`m£cs_to_jiffõs
(5000));

8019 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

8020 
	}
}

8021 
EXPORT_SYMBOL
(
md_waô_f‹_blocked_rdev
);

8023 
	$md_föish_ªsh≠e
(
mddev
 *mddev)

8026 
md_rdev
 *
rdev
;

8028 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

8029 i‡(
rdev
->
d©a_off£t
 >Ñdev->
√w_d©a_off£t
)

8030 
rdev
->
£˘‹s
 +rdev->
d©a_off£t
 -Ñdev->
√w_d©a_off£t
;

8032 
rdev
->
£˘‹s
 -rdev->
√w_d©a_off£t
 -Ñdev->
d©a_off£t
;

8033 
rdev
->
d©a_off£t
 =Ñdev->
√w_d©a_off£t
;

8035 
	}
}

8036 
EXPORT_SYMBOL
(
md_föish_ªsh≠e
);

8064 
	$md_is_badblock
(
badblocks
 *
bb
, 
£˘‹_t
 
s
, 
£˘‹s
,

8065 
£˘‹_t
 *
fú°_bad
, *
bad_£˘‹s
)

8067 
hi
;

8068 
lo
;

8069 
u64
 *
p
 = 
bb
->
∑ge
;

8070 
rv
;

8071 
£˘‹_t
 
èrgë
 = 
s
 + 
£˘‹s
;

8072 
£q
;

8074 i‡(
bb
->
shi·
 > 0) {

8076 
s
 >>
bb
->
shi·
;

8077 
èrgë
 +(1<<
bb
->
shi·
) - 1;

8078 
èrgë
 >>
bb
->
shi·
;

8079 
£˘‹s
 = 
èrgë
 - 
s
;

8083 
ªåy
:

8084 
£q
 = 
	`ªad_£qbegö
(&
bb
->
lock
);

8085 
lo
 = 0;

8086 
rv
 = 0;

8087 
hi
 = 
bb
->
cou¡
;

8097 
hi
 - 
lo
 > 1) {

8098 
mid
 = (
lo
 + 
hi
) / 2;

8099 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
mid
]);

8100 i‡(
a
 < 
èrgë
)

8103 
lo
 = 
mid
;

8106 
hi
 = 
mid
;

8109 i‡(
hi
 > 
lo
) {

8113 
lo
 >= 0 &&

8114 
	`BB_OFFSET
(
p
[
lo
]Ë+ 
	`BB_LEN
’[lo]Ë> 
s
) {

8115 i‡(
	`BB_OFFSET
(
p
[
lo
]Ë< 
èrgë
) {

8119 i‡(
rv
 !-1 && 
	`BB_ACK
(
p
[
lo
]))

8120 
rv
 = 1;

8122 
rv
 = -1;

8123 *
fú°_bad
 = 
	`BB_OFFSET
(
p
[
lo
]);

8124 *
bad_£˘‹s
 = 
	`BB_LEN
(
p
[
lo
]);

8126 
lo
--;

8130 i‡(
	`ªad_£qªåy
(&
bb
->
lock
, 
£q
))

8131 
ªåy
;

8133  
rv
;

8134 
	}
}

8135 
EXPORT_SYMBOL_GPL
(
md_is_badblock
);

8144 
	$md_£t_badblocks
(
badblocks
 *
bb
, 
£˘‹_t
 
s
, 
£˘‹s
,

8145 
acknowÀdged
)

8147 
u64
 *
p
;

8148 
lo
, 
hi
;

8149 
rv
 = 1;

8150 
Êags
;

8152 i‡(
bb
->
shi·
 < 0)

8156 i‡(
bb
->
shi·
) {

8158 
£˘‹_t
 
√xt
 = 
s
 + 
£˘‹s
;

8159 
s
 >>
bb
->
shi·
;

8160 
√xt
 +(1<<
bb
->
shi·
) - 1;

8161 
√xt
 >>
bb
->
shi·
;

8162 
£˘‹s
 = 
√xt
 - 
s
;

8165 
	`wrôe_£qlock_úqßve
(&
bb
->
lock
, 
Êags
);

8167 
p
 = 
bb
->
∑ge
;

8168 
lo
 = 0;

8169 
hi
 = 
bb
->
cou¡
;

8171 
hi
 - 
lo
 > 1) {

8172 
mid
 = (
lo
 + 
hi
) / 2;

8173 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
mid
]);

8174 i‡(
a
 <
s
)

8175 
lo
 = 
mid
;

8177 
hi
 = 
mid
;

8179 i‡(
hi
 > 
lo
 && 
	`BB_OFFSET
(
p
[lo]Ë> 
s
)

8180 
hi
 = 
lo
;

8182 i‡(
hi
 > 
lo
) {

8186 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
lo
]);

8187 
£˘‹_t
 
e
 = 
a
 + 
	`BB_LEN
(
p
[
lo
]);

8188 
ack
 = 
	`BB_ACK
(
p
[
lo
]);

8189 i‡(
e
 >
s
) {

8191 i‡(
s
 =
a
 && s + 
£˘‹s
 >
e
)

8193 
ack
 = 
acknowÀdged
;

8195 
ack
 =áck && 
acknowÀdged
;

8197 i‡(
e
 < 
s
 + 
£˘‹s
)

8198 
e
 = 
s
 + 
£˘‹s
;

8199 i‡(
e
 - 
a
 <
BB_MAX_LEN
) {

8200 
p
[
lo
] = 
	`BB_MAKE
(
a
, 
e
-a, 
ack
);

8201 
s
 = 
e
;

8206 i‡(
	`BB_LEN
(
p
[
lo
]Ë!
BB_MAX_LEN
)

8207 
p
[
lo
] = 
	`BB_MAKE
(
a
, 
BB_MAX_LEN
, 
ack
);

8208 
s
 = 
a
 + 
BB_MAX_LEN
;

8210 
£˘‹s
 = 
e
 - 
s
;

8213 i‡(
£˘‹s
 && 
hi
 < 
bb
->
cou¡
) {

8216 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
hi
]);

8217 
£˘‹_t
 
e
 = 
a
 + 
	`BB_LEN
(
p
[
hi
]);

8218 
ack
 = 
	`BB_ACK
(
p
[
hi
]);

8219 i‡(
a
 <
s
 + 
£˘‹s
) {

8221 i‡(
e
 <
s
 + 
£˘‹s
) {

8223 
e
 = 
s
 + 
£˘‹s
;

8224 
ack
 = 
acknowÀdged
;

8226 
ack
 =áck && 
acknowÀdged
;

8228 
a
 = 
s
;

8229 i‡(
e
 - 
a
 <
BB_MAX_LEN
) {

8230 
p
[
hi
] = 
	`BB_MAKE
(
a
, 
e
-a, 
ack
);

8231 
s
 = 
e
;

8233 
p
[
hi
] = 
	`BB_MAKE
(
a
, 
BB_MAX_LEN
, 
ack
);

8234 
s
 = 
a
 + 
BB_MAX_LEN
;

8236 
£˘‹s
 = 
e
 - 
s
;

8237 
lo
 = 
hi
;

8238 
hi
++;

8241 i‡(
£˘‹s
 =0 && 
hi
 < 
bb
->
cou¡
) {

8244 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
hi
]);

8245 
lﬁí
 = 
	`BB_LEN
(
p
[
lo
]);

8246 
hûí
 = 
	`BB_LEN
(
p
[
hi
]);

8247 
√wÀn
 = 
lﬁí
 + 
hûí
 - (
s
 - 
a
);

8248 i‡(
s
 >
a
 && 
√wÀn
 < 
BB_MAX_LEN
) {

8250 
ack
 = 
	`BB_ACK
(
p
[
lo
]Ë&& BB_ACK’[
hi
]);

8251 
p
[
lo
] = 
	`BB_MAKE
(
	`BB_OFFSET
’[lo]), 
√wÀn
, 
ack
);

8252 
	`memmove
(
p
 + 
hi
,Ö + hi + 1,

8253 (
bb
->
cou¡
 - 
hi
 - 1) * 8);

8254 
bb
->
cou¡
--;

8257 
£˘‹s
) {

8260 i‡(
bb
->
cou¡
 >
MD_MAX_BADBLOCKS
) {

8262 
rv
 = 0;

8265 
this_£˘‹s
 = 
£˘‹s
;

8266 
	`memmove
(
p
 + 
hi
 + 1,Ö + hi,

8267 (
bb
->
cou¡
 - 
hi
) * 8);

8268 
bb
->
cou¡
++;

8270 i‡(
this_£˘‹s
 > 
BB_MAX_LEN
)

8271 
this_£˘‹s
 = 
BB_MAX_LEN
;

8272 
p
[
hi
] = 
	`BB_MAKE
(
s
, 
this_£˘‹s
, 
acknowÀdged
);

8273 
£˘‹s
 -
this_£˘‹s
;

8274 
s
 +
this_£˘‹s
;

8278 
bb
->
ch™ged
 = 1;

8279 i‡(!
acknowÀdged
)

8280 
bb
->
u«cked_exi°
 = 1;

8281 
	`wrôe_£qu∆ock_úqª°‹e
(&
bb
->
lock
, 
Êags
);

8283  
rv
;

8284 
	}
}

8286 
	$rdev_£t_badblocks
(
md_rdev
 *
rdev
, 
£˘‹_t
 
s
, 
£˘‹s
,

8287 
is_√w
)

8289 
rv
;

8290 i‡(
is_√w
)

8291 
s
 +
rdev
->
√w_d©a_off£t
;

8293 
s
 +
rdev
->
d©a_off£t
;

8294 
rv
 = 
	`md_£t_badblocks
(&
rdev
->
badblocks
,

8295 
s
, 
£˘‹s
, 0);

8296 i‡(
rv
) {

8298 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

8299 
	`£t_bô
(
MD_CHANGE_CLEAN
, &
rdev
->
mddev
->
Êags
);

8300 
	`md_wakeup_thªad
(
rdev
->
mddev
->
thªad
);

8302  
rv
;

8303 
	}
}

8304 
EXPORT_SYMBOL_GPL
(
rdev_£t_badblocks
);

8312 
	$md_˛ór_badblocks
(
badblocks
 *
bb
, 
£˘‹_t
 
s
, 
£˘‹s
)

8314 
u64
 *
p
;

8315 
lo
, 
hi
;

8316 
£˘‹_t
 
èrgë
 = 
s
 + 
£˘‹s
;

8317 
rv
 = 0;

8319 i‡(
bb
->
shi·
 > 0) {

8326 
s
 +(1<<
bb
->
shi·
) - 1;

8327 
s
 >>
bb
->
shi·
;

8328 
èrgë
 >>
bb
->
shi·
;

8329 
£˘‹s
 = 
èrgë
 - 
s
;

8332 
	`wrôe_£qlock_úq
(&
bb
->
lock
);

8334 
p
 = 
bb
->
∑ge
;

8335 
lo
 = 0;

8336 
hi
 = 
bb
->
cou¡
;

8338 
hi
 - 
lo
 > 1) {

8339 
mid
 = (
lo
 + 
hi
) / 2;

8340 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
mid
]);

8341 i‡(
a
 < 
èrgë
)

8342 
lo
 = 
mid
;

8344 
hi
 = 
mid
;

8346 i‡(
hi
 > 
lo
) {

8351 i‡(
	`BB_OFFSET
(
p
[
lo
]Ë+ 
	`BB_LEN
’[lo]Ë> 
èrgë
) {

8353 
ack
 = 
	`BB_ACK
(
p
[
lo
]);

8354 
£˘‹_t
 
a
 = 
	`BB_OFFSET
(
p
[
lo
]);

8355 
£˘‹_t
 
íd
 = 
a
 + 
	`BB_LEN
(
p
[
lo
]);

8357 i‡(
a
 < 
s
) {

8359 i‡(
bb
->
cou¡
 >
MD_MAX_BADBLOCKS
) {

8360 
rv
 = -
ENOSPC
;

8361 
out
;

8363 
	`memmove
(
p
+
lo
+1,Ö+lo, (
bb
->
cou¡
 -Üo) * 8);

8364 
bb
->
cou¡
++;

8365 
p
[
lo
] = 
	`BB_MAKE
(
a
, 
s
-a, 
ack
);

8366 
lo
++;

8368 
p
[
lo
] = 
	`BB_MAKE
(
èrgë
, 
íd
 -Å¨gë, 
ack
);

8370 
hi
 = 
lo
;

8371 
lo
--;

8373 
lo
 >= 0 &&

8374 
	`BB_OFFSET
(
p
[
lo
]Ë+ 
	`BB_LEN
’[lo]Ë> 
s
) {

8376 i‡(
	`BB_OFFSET
(
p
[
lo
]Ë< 
s
) {

8378 
ack
 = 
	`BB_ACK
(
p
[
lo
]);

8379 
£˘‹_t
 
°¨t
 = 
	`BB_OFFSET
(
p
[
lo
]);

8380 
p
[
lo
] = 
	`BB_MAKE
(
°¨t
, 
s
 - sèπ, 
ack
);

8384 
lo
--;

8389 i‡(
hi
 - 
lo
 > 1) {

8390 
	`memmove
(
p
+
lo
+1,Ö+
hi
, (
bb
->
cou¡
 - hi) * 8);

8391 
bb
->
cou¡
 -(
hi
 - 
lo
 - 1);

8395 
bb
->
ch™ged
 = 1;

8396 
out
:

8397 
	`wrôe_£qu∆ock_úq
(&
bb
->
lock
);

8398  
rv
;

8399 
	}
}

8401 
	$rdev_˛ór_badblocks
(
md_rdev
 *
rdev
, 
£˘‹_t
 
s
, 
£˘‹s
,

8402 
is_√w
)

8404 i‡(
is_√w
)

8405 
s
 +
rdev
->
√w_d©a_off£t
;

8407 
s
 +
rdev
->
d©a_off£t
;

8408  
	`md_˛ór_badblocks
(&
rdev
->
badblocks
,

8409 
s
, 
£˘‹s
);

8410 
	}
}

8411 
EXPORT_SYMBOL_GPL
(
rdev_˛ór_badblocks
);

8418 
	$md_ack_Æl_badblocks
(
badblocks
 *
bb
)

8420 i‡(
bb
->
∑ge
 =
NULL
 || bb->
ch™ged
)

8423 
	`wrôe_£qlock_úq
(&
bb
->
lock
);

8425 i‡(
bb
->
ch™ged
 =0 && bb->
u«cked_exi°
) {

8426 
u64
 *
p
 = 
bb
->
∑ge
;

8427 
i
;

8428 
i
 = 0; i < 
bb
->
cou¡
 ; i++) {

8429 i‡(!
	`BB_ACK
(
p
[
i
])) {

8430 
£˘‹_t
 
°¨t
 = 
	`BB_OFFSET
(
p
[
i
]);

8431 
Àn
 = 
	`BB_LEN
(
p
[
i
]);

8432 
p
[
i
] = 
	`BB_MAKE
(
°¨t
, 
Àn
, 1);

8435 
bb
->
u«cked_exi°
 = 0;

8437 
	`wrôe_£qu∆ock_úq
(&
bb
->
lock
);

8438 
	}
}

8439 
EXPORT_SYMBOL_GPL
(
md_ack_Æl_badblocks
);

8453 
ssize_t


8454 
	$badblocks_show
(
badblocks
 *
bb
, *
∑ge
, 
u«ck
)

8456 
size_t
 
Àn
;

8457 
i
;

8458 
u64
 *
p
 = 
bb
->
∑ge
;

8459 
£q
;

8461 i‡(
bb
->
shi·
 < 0)

8464 
ªåy
:

8465 
£q
 = 
	`ªad_£qbegö
(&
bb
->
lock
);

8467 
Àn
 = 0;

8468 
i
 = 0;

8470 
Àn
 < 
PAGE_SIZE
 && 
i
 < 
bb
->
cou¡
) {

8471 
£˘‹_t
 
s
 = 
	`BB_OFFSET
(
p
[
i
]);

8472 
Àngth
 = 
	`BB_LEN
(
p
[
i
]);

8473 
ack
 = 
	`BB_ACK
(
p
[
i
]);

8474 
i
++;

8476 i‡(
u«ck
 && 
ack
)

8479 
Àn
 +
	`¢¥ötf
(
∑ge
+Àn, 
PAGE_SIZE
-len, "%llu %u\n",

8480 ()
s
 << 
bb
->
shi·
,

8481 
Àngth
 << 
bb
->
shi·
);

8483 i‡(
u«ck
 && 
Àn
 == 0)

8484 
bb
->
u«cked_exi°
 = 0;

8486 i‡(
	`ªad_£qªåy
(&
bb
->
lock
, 
£q
))

8487 
ªåy
;

8489  
Àn
;

8490 
	}
}

8492 
	#DO_DEBUG
 1

	)

8494 
ssize_t


8495 
	$badblocks_°‹e
(
badblocks
 *
bb
, c⁄° *
∑ge
, 
size_t
 
Àn
, 
u«ck
)

8497 
£˘‹
;

8498 
Àngth
;

8499 
√wlöe
;

8500 #ifde‡
DO_DEBUG


8504 
˛ór
 = 0;

8505 i‡(
∑ge
[0] == '-') {

8506 
˛ór
 = 1;

8507 
∑ge
++;

8511 
	`ssˇnf
(
∑ge
, "%Œu %d%c", &
£˘‹
, &
Àngth
, &
√wlöe
)) {

8513 i‡(
√wlöe
 != '\n')

8514  -
EINVAL
;

8516 i‡(
Àngth
 <= 0)

8517  -
EINVAL
;

8520  -
EINVAL
;

8523 #ifde‡
DO_DEBUG


8524 i‡(
˛ór
) {

8525 
	`md_˛ór_badblocks
(
bb
, 
£˘‹
, 
Àngth
);

8526  
Àn
;

8529 i‡(
	`md_£t_badblocks
(
bb
, 
£˘‹
, 
Àngth
, !
u«ck
))

8530  
Àn
;

8532  -
ENOSPC
;

8533 
	}
}

8535 
	$md_nŸify_ªboŸ
(
nŸifõr_block
 *
this
,

8536 
code
, *
x
)

8538 
li°_hód
 *
tmp
;

8539 
mddev
 *mddev;

8540 
√ed_dñay
 = 0;

8542 
	`f‹_óch_mddev
(
mddev
, 
tmp
) {

8543 i‡(
	`mddev_åylock
(
mddev
)) {

8544 i‡(
mddev
->
≥rs
)

8545 
	`__md_°›_wrôes
(
mddev
);

8546 i‡(
mddev
->
≥rsi°ít
)

8547 
mddev
->
ß„mode
 = 2;

8548 
	`mddev_u∆ock
(
mddev
);

8550 
√ed_dñay
 = 1;

8558 i‡(
√ed_dñay
)

8559 
	`mdñay
(1000*1);

8561  
NOTIFY_DONE
;

8562 
	}
}

8564 
nŸifõr_block
 
	gmd_nŸifõr
 = {

8565 .
nŸifõr_ˇŒ
 = 
md_nŸify_ªboŸ
,

8566 .
	g√xt
 = 
NULL
,

8567 .
	g¥i‹ôy
 = 
INT_MAX
,

8570 
	$md_gíöô
()

8572 
	`¥_debug
("md: sizeof(mdp_su≥r_tË%d\n", ()(
mdp_su≥r_t
));

8574 
	`¥oc_¸óã
("md°©", 
S_IRUGO
, 
NULL
, &
md_£q_f›s
);

8575 
	}
}

8577 
__öô
 
	$md_öô
()

8579 
ªt
 = -
ENOMEM
;

8581 
md_wq
 = 
	`Æloc_w‹kqueue
("md", 
WQ_MEM_RECLAIM
, 0);

8582 i‡(!
md_wq
)

8583 
îr_wq
;

8585 
md_misc_wq
 = 
	`Æloc_w‹kqueue
("md_misc", 0, 0);

8586 i‡(!
md_misc_wq
)

8587 
îr_misc_wq
;

8589 i‡((
ªt
 = 
	`ªgi°î_blkdev
(
MD_MAJOR
, "md")) < 0)

8590 
îr_md
;

8592 i‡((
ªt
 = 
	`ªgi°î_blkdev
(0, "mdp")) < 0)

8593 
îr_mdp
;

8594 
mdp_maj‹
 = 
ªt
;

8596 
	`blk_ªgi°î_ªgi⁄
(
	`MKDEV
(
MD_MAJOR
, 0), 512, 
THIS_MODULE
,

8597 
md_¥obe
, 
NULL
, NULL);

8598 
	`blk_ªgi°î_ªgi⁄
(
	`MKDEV
(
mdp_maj‹
, 0), 1UL<<
MINORBITS
, 
THIS_MODULE
,

8599 
md_¥obe
, 
NULL
, NULL);

8601 
	`ªgi°î_ªboŸ_nŸifõr
(&
md_nŸifõr
);

8602 
øid_èbÀ_hódî
 = 
	`ªgi°î_sys˘l_èbÀ
(
øid_roŸ_èbÀ
);

8604 
	`md_gíöô
();

8607 
îr_mdp
:

8608 
	`uƒegi°î_blkdev
(
MD_MAJOR
, "md");

8609 
îr_md
:

8610 
	`de°roy_w‹kqueue
(
md_misc_wq
);

8611 
îr_misc_wq
:

8612 
	`de°roy_w‹kqueue
(
md_wq
);

8613 
îr_wq
:

8614  
ªt
;

8615 
	}
}

8617 #i‚de‡
MODULE


8624 
LIST_HEAD
(
Æl_dëe˘ed_devi˚s
);

8625 
	sdëe˘ed_devi˚s_node
 {

8626 
li°_hód
 
	mli°
;

8627 
dev_t
 
	mdev
;

8630 
	$md_autodëe˘_dev
(
dev_t
 
dev
)

8632 
dëe˘ed_devi˚s_node
 *
node_dëe˘ed_dev
;

8634 
node_dëe˘ed_dev
 = 
	`kzÆloc
((*node_dëe˘ed_dev), 
GFP_KERNEL
);

8635 i‡(
node_dëe˘ed_dev
) {

8636 
node_dëe˘ed_dev
->
dev
 = dev;

8637 
	`li°_add_èû
(&
node_dëe˘ed_dev
->
li°
, &
Æl_dëe˘ed_devi˚s
);

8639 
	`¥ötk
(
KERN_CRIT
 "md: md_autodetect_dev: kzalloc failed"

8640 ", skùpög dev(%d,%d)\n", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

8642 
	}
}

8645 
	$auto°¨t_¨øys
(
∑π
)

8647 
md_rdev
 *
rdev
;

8648 
dëe˘ed_devi˚s_node
 *
node_dëe˘ed_dev
;

8649 
dev_t
 
dev
;

8650 
i_sˇ¬ed
, 
i_∑s£d
;

8652 
i_sˇ¬ed
 = 0;

8653 
i_∑s£d
 = 0;

8655 
	`¥ötk
(
KERN_INFO
 "md: Autodetecting RAIDárrays.\n");

8657 !
	`li°_em±y
(&
Æl_dëe˘ed_devi˚s
Ë&& 
i_sˇ¬ed
 < 
INT_MAX
) {

8658 
i_sˇ¬ed
++;

8659 
node_dëe˘ed_dev
 = 
	`li°_íåy
(
Æl_dëe˘ed_devi˚s
.
√xt
,

8660 
dëe˘ed_devi˚s_node
, 
li°
);

8661 
	`li°_dñ
(&
node_dëe˘ed_dev
->
li°
);

8662 
dev
 = 
node_dëe˘ed_dev
->dev;

8663 
	`k‰ì
(
node_dëe˘ed_dev
);

8664 
rdev
 = 
	`md_imp‹t_devi˚
(
dev
,0, 90);

8665 i‡(
	`IS_ERR
(
rdev
))

8668 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

8669 
	`MD_BUG
();

8672 
	`£t_bô
(
AutoDëe˘ed
, &
rdev
->
Êags
);

8673 
	`li°_add
(&
rdev
->
ßme_£t
, &
≥ndög_øid_disks
);

8674 
i_∑s£d
++;

8677 
	`¥ötk
(
KERN_INFO
 "md: Scanned %dándádded %d devices.\n",

8678 
i_sˇ¬ed
, 
i_∑s£d
);

8680 
	`aut‹un_devi˚s
(
∑π
);

8681 
	}
}

8685 
__exô
 
	$md_exô
()

8687 
mddev
 *mddev;

8688 
li°_hód
 *
tmp
;

8689 
dñay
 = 1;

8691 
	`blk_uƒegi°î_ªgi⁄
(
	`MKDEV
(
MD_MAJOR
,0), 512);

8692 
	`blk_uƒegi°î_ªgi⁄
(
	`MKDEV
(
mdp_maj‹
,0), 1U << 
MINORBITS
);

8694 
	`uƒegi°î_blkdev
(
MD_MAJOR
,"md");

8695 
	`uƒegi°î_blkdev
(
mdp_maj‹
, "mdp");

8696 
	`uƒegi°î_ªboŸ_nŸifõr
(&
md_nŸifõr
);

8697 
	`uƒegi°î_sys˘l_èbÀ
(
øid_èbÀ_hódî
);

8702 
md_u∆ﬂdög
 = 1;

8703 
	`waôqueue_a˘ive
(&
md_evít_waôîs
)) {

8705 
	`wake_up
(&
md_evít_waôîs
);

8706 
	`m¶ìp
(
dñay
);

8707 
dñay
 += delay;

8709 
	`ªmove_¥oc_íåy
("md°©", 
NULL
);

8711 
	`f‹_óch_mddev
(
mddev
, 
tmp
) {

8712 
	`exp‹t_¨øy
(
mddev
);

8713 
mddev
->
hﬁd_a˘ive
 = 0;

8715 
	`de°roy_w‹kqueue
(
md_misc_wq
);

8716 
	`de°roy_w‹kqueue
(
md_wq
);

8717 
	}
}

8719 
subsys_öôˇŒ
(
md_öô
);

8720 
	$moduÀ_exô
(
md_exô
)

8722 
	$gë_ro
(*
buf„r
, 
kî√l_∑øm
 *
kp
)

8724  
	`•rötf
(
buf„r
, "%d", 
°¨t_ªad⁄ly
);

8725 
	}
}

8726 
	$£t_ro
(c⁄° *
vÆ
, 
kî√l_∑øm
 *
kp
)

8728 *
e
;

8729 
num
 = 
	`sim∂e_°πoul
(
vÆ
, &
e
, 10);

8730 i‡(*
vÆ
 && (*
e
 == '\0' || *e == '\n')) {

8731 
°¨t_ªad⁄ly
 = 
num
;

8734  -
EINVAL
;

8735 
	}
}

8737 
moduÀ_∑øm_ˇŒ
(
°¨t_ro
, 
£t_ro
, 
gë_ro
, 
NULL
, 
S_IRUSR
|
S_IWUSR
);

8738 
moduÀ_∑øm
(
°¨t_dúty_degøded
, , 
S_IRUGO
|
S_IWUSR
);

8740 
moduÀ_∑øm_ˇŒ
(
√w_¨øy
, 
add_«med_¨øy
, 
NULL
, NULL, 
S_IWUSR
);

8742 
EXPORT_SYMBOL
(
ªgi°î_md_≥rs⁄Æôy
);

8743 
EXPORT_SYMBOL
(
uƒegi°î_md_≥rs⁄Æôy
);

8744 
EXPORT_SYMBOL
(
md_îr‹
);

8745 
EXPORT_SYMBOL
(
md_d⁄e_sync
);

8746 
EXPORT_SYMBOL
(
md_wrôe_°¨t
);

8747 
EXPORT_SYMBOL
(
md_wrôe_íd
);

8748 
EXPORT_SYMBOL
(
md_ªgi°î_thªad
);

8749 
EXPORT_SYMBOL
(
md_uƒegi°î_thªad
);

8750 
EXPORT_SYMBOL
(
md_wakeup_thªad
);

8751 
EXPORT_SYMBOL
(
md_check_ªcovîy
);

8752 
EXPORT_SYMBOL
(
md_ª≠_sync_thªad
);

8753 
MODULE_LICENSE
("GPL");

8754 
MODULE_DESCRIPTION
("MD RAID framework");

8755 
MODULE_ALIAS
("md");

8756 
MODULE_ALIAS_BLOCKDEV_MAJOR
(
MD_MAJOR
);

	@md.h

15 #i‚de‡
_MD_MD_H


16 
	#_MD_MD_H


	)

18 
	~<löux/blkdev.h
>

19 
	~<löux/kobje˘.h
>

20 
	~<löux/li°.h
>

21 
	~<löux/mm.h
>

22 
	~<löux/muãx.h
>

23 
	~<löux/timî.h
>

24 
	~<löux/waô.h
>

25 
	~<löux/w‹kqueue.h
>

27 
	#MaxSe˘‹
 (~(
£˘‹_t
)0)

	)

34 
	#MD_MAX_BADBLOCKS
 (
PAGE_SIZE
/8)

	)

39 
	smd_rdev
 {

40 
li°_hód
 
	mßme_£t
;

42 
£˘‹_t
 
	m£˘‹s
;

43 
mddev
 *
	mmddev
;

44 
	mœ°_evíts
;

51 
block_devi˚
 *
	mmëa_bdev
;

52 
block_devi˚
 *
	mbdev
;

54 
∑ge
 *
	msb_∑ge
, *
	mbb_∑ge
;

55 
	msb_lﬂded
;

56 
__u64
 
	msb_evíts
;

57 
£˘‹_t
 
	md©a_off£t
;

58 
£˘‹_t
 
	m√w_d©a_off£t
;

59 
£˘‹_t
 
	msb_°¨t
;

60 
	msb_size
;

61 
	m¥e„ºed_mö‹
;

63 
kobje˘
 
	mkobj
;

76 
	mÊags
;

77 
waô_queue_hód_t
 
	mblocked_waô
;

79 
	mdesc_ƒ
;

80 
	møid_disk
;

81 
	m√w_øid_disk
;

84 
	mßved_øid_disk
;

88 
£˘‹_t
 
	mªcovîy_off£t
;

93 
©omic_t
 
	mƒ_≥ndög
;

97 
©omic_t
 
	mªad_îr‹s
;

100 
time•ec
 
	mœ°_ªad_îr‹
;

103 
©omic_t
 
	mc‹ª˘ed_îr‹s
;

107 
w‹k_°ru˘
 
	mdñ_w‹k
;

109 
kînfs_node
 *
	msysfs_°©e
;

112 
	sbadblocks
 {

113 
	mcou¡
;

114 
	mu«cked_exi°
;

118 
	mshi·
;

121 
u64
 *
	m∑ge
;

122 
	mch™ged
;

123 
£qlock_t
 
	mlock
;

125 
£˘‹_t
 
	m£˘‹
;

126 
£˘‹_t
 
	msize
;

127 } 
	mbadblocks
;

129 
	eÊag_bôs
 {

130 
	mFau…y
,

131 
	mIn_sync
,

132 
	mBôm≠_sync
,

135 
	mUnmîged
,

139 
	mWrôeMo°ly
,

140 
	mAutoDëe˘ed
,

141 
	mBlocked
,

145 
	mWrôeEº‹Sìn
,

148 
	mFau…Rec‹ded
,

154 
	mBlockedBadBlocks
,

164 
	mW™tRïœ˚mít
,

169 
	mRïœ˚mít
,

175 
	#BB_LEN_MASK
 (0x00000000000001FFULL)

	)

176 
	#BB_OFFSET_MASK
 (0x7FFFFFFFFFFFFE00ULL)

	)

177 
	#BB_ACK_MASK
 (0x8000000000000000ULL)

	)

178 
	#BB_MAX_LEN
 512

	)

179 
	#BB_OFFSET
(
x
Ë(((xË& 
BB_OFFSET_MASK
Ë>> 9)

	)

180 
	#BB_LEN
(
x
Ë(((xË& 
BB_LEN_MASK
Ë+ 1)

	)

181 
	#BB_ACK
(
x
Ë(!!((xË& 
BB_ACK_MASK
))

	)

182 
	#BB_MAKE
(
a
, 
l
, 
ack
Ë((◊)<<9Ë| (÷)-1Ë| ((
u64
)(!!◊ck)Ë<< 63))

	)

184 
md_is_badblock
(
badblocks
 *
bb
, 
£˘‹_t
 
s
, 
£˘‹s
,

185 
£˘‹_t
 *
fú°_bad
, *
bad_£˘‹s
);

186 
ölöe
 
	$is_badblock
(
md_rdev
 *
rdev
, 
£˘‹_t
 
s
, 
£˘‹s
,

187 
£˘‹_t
 *
fú°_bad
, *
bad_£˘‹s
)

189 i‡(
	`u∆ikñy
(
rdev
->
badblocks
.
cou¡
)) {

190 
rv
 = 
	`md_is_badblock
(&
rdev
->
badblocks
,Ñdev->
d©a_off£t
 + 
s
,

191 
£˘‹s
,

192 
fú°_bad
, 
bad_£˘‹s
);

193 i‡(
rv
)

194 *
fú°_bad
 -
rdev
->
d©a_off£t
;

195  
rv
;

198 
	}
}

199 
rdev_£t_badblocks
(
md_rdev
 *
rdev
, 
£˘‹_t
 
s
, 
£˘‹s
,

200 
is_√w
);

201 
rdev_˛ór_badblocks
(
md_rdev
 *
rdev
, 
£˘‹_t
 
s
, 
£˘‹s
,

202 
is_√w
);

203 
md_ack_Æl_badblocks
(
badblocks
 *
bb
);

205 
	smddev
 {

206 *
	m¥iv©e
;

207 
md_≥rs⁄Æôy
 *
	m≥rs
;

208 
dev_t
 
	munô
;

209 
	mmd_mö‹
;

210 
li°_hód
 
	mdisks
;

211 
	mÊags
;

212 
	#MD_CHANGE_DEVS
 0

	)

213 
	#MD_CHANGE_CLEAN
 1

	)

214 
	#MD_CHANGE_PENDING
 2

	)

215 
	#MD_UPDATE_SB_FLAGS
 (1 | 2 | 4Ë

	)

216 
	#MD_ARRAY_FIRST_USE
 3

	)

217 
	#MD_STILL_CLOSED
 4

	)

221 
	msu•íded
;

222 
©omic_t
 
	ma˘ive_io
;

223 
	mro
;

224 
	msysfs_a˘ive
;

228 
	mªady
;

230 
gídisk
 *
	mgídisk
;

232 
kobje˘
 
	mkobj
;

233 
	mhﬁd_a˘ive
;

234 
	#UNTIL_IOCTL
 1

	)

235 
	#UNTIL_STOP
 2

	)

238 
	mmaj‹_vîsi⁄
,

239 
	mmö‹_vîsi⁄
,

240 
	m∑tch_vîsi⁄
;

241 
	m≥rsi°ít
;

242 
	mexã∫Æ
;

244 
	mmëad©a_ty≥
[17];

245 
	mchunk_£˘‹s
;

246 
time_t
 
	m˘ime
, 
	mutime
;

247 
	mÀvñ
, 
	mœyout
;

248 
	m˛evñ
[16];

249 
	møid_disks
;

250 
	mmax_disks
;

251 
£˘‹_t
 
	mdev_£˘‹s
;

253 
£˘‹_t
 
	m¨øy_£˘‹s
;

254 
	mexã∫Æ_size
;

256 
__u64
 
	mevíts
;

262 
	mˇn_de¸ó£_evíts
;

264 
	muuid
[16];

271 
£˘‹_t
 
	mªsh≠e_posôi⁄
;

272 
	mdñè_disks
, 
	m√w_Àvñ
, 
	m√w_œyout
;

273 
	m√w_chunk_£˘‹s
;

274 
	mªsh≠e_backw¨ds
;

276 
md_thªad
 *
	mthªad
;

277 
md_thªad
 *
	msync_thªad
;

285 *
	mœ°_sync_a˘i⁄
;

286 
£˘‹_t
 
	mcuº_ªsync
;

293 
£˘‹_t
 
	mcuº_ªsync_com∂ëed
;

294 
	mªsync_m¨k
;

295 
£˘‹_t
 
	mªsync_m¨k_˙t
;

296 
£˘‹_t
 
	mcuº_m¨k_˙t
;

298 
£˘‹_t
 
	mªsync_max_£˘‹s
;

300 
©omic64_t
 
	mªsync_mism©ches
;

305 
£˘‹_t
 
	msu•íd_lo
;

306 
£˘‹_t
 
	msu•íd_hi
;

308 
	msync_•ìd_mö
;

309 
	msync_•ìd_max
;

312 
	m∑øŒñ_ªsync
;

314 
	mok_°¨t_degøded
;

329 
	#MD_RECOVERY_RUNNING
 0

	)

330 
	#MD_RECOVERY_SYNC
 1

	)

331 
	#MD_RECOVERY_RECOVER
 2

	)

332 
	#MD_RECOVERY_INTR
 3

	)

333 
	#MD_RECOVERY_DONE
 4

	)

334 
	#MD_RECOVERY_NEEDED
 5

	)

335 
	#MD_RECOVERY_REQUESTED
 6

	)

336 
	#MD_RECOVERY_CHECK
 7

	)

337 
	#MD_RECOVERY_RESHAPE
 8

	)

338 
	#MD_RECOVERY_FROZEN
 9

	)

339 
	#MD_RECOVERY_ERROR
 10

	)

341 
	mªcovîy
;

347 
	mªcovîy_dißbÀd
;

349 
	mö_sync
;

359 
muãx
 
	m›í_muãx
;

360 
muãx
 
	mªc⁄fig_muãx
;

361 
©omic_t
 
	ma˘ive
;

362 
©omic_t
 
	m›íîs
;

364 
	mch™ged
;

366 
	mdegøded
;

369 
	mmîge_check_√eded
;

374 
©omic_t
 
	mªcovîy_a˘ive
;

375 
waô_queue_hód_t
 
	mªcovîy_waô
;

376 
£˘‹_t
 
	mªcovîy_˝
;

377 
£˘‹_t
 
	mªsync_mö
;

379 
£˘‹_t
 
	mªsync_max
;

382 
kînfs_node
 *
	msysfs_°©e
;

385 
kînfs_node
 *
	msysfs_a˘i⁄
;

387 
w‹k_°ru˘
 
	mdñ_w‹k
;

389 
•ölock_t
 
	mwrôe_lock
;

390 
waô_queue_hód_t
 
	msb_waô
;

391 
©omic_t
 
	m≥ndög_wrôes
;

393 
	mß„mode
;

396 
	mß„mode_dñay
;

397 
timî_li°
 
	mß„mode_timî
;

398 
©omic_t
 
	mwrôes_≥ndög
;

399 
ªque°_queue
 *
	mqueue
;

401 
bôm≠
 *
	mbôm≠
;

403 
fûe
 *
	mfûe
;

404 
loff_t
 
	moff£t
;

410 
	m•a˚
;

411 
loff_t
 
	mdeÁu…_off£t
;

415 
	mdeÁu…_•a˚
;

417 
muãx
 
	mmuãx
;

418 
	mchunksize
;

419 
	md´m⁄_¶ìp
;

420 
	mmax_wrôe_behöd
;

421 
	mexã∫Æ
;

422 } 
	mbôm≠_öfo
;

424 
©omic_t
 
	mmax_c‹r_ªad_îr‹s
;

425 
li°_hód
 
	mÆl_mddevs
;

427 
©åibuã_group
 *
	mto_ªmove
;

429 
bio_£t
 *
	mbio_£t
;

435 
bio
 *
	mÊush_bio
;

436 
©omic_t
 
	mÊush_≥ndög
;

437 
w‹k_°ru˘
 
	mÊush_w‹k
;

438 
w‹k_°ru˘
 
	mevít_w‹k
;

439 (*
	msync_su≥r
)(
mddev
 *
	mmddev
, 
md_rdev
 *
	mrdev
);

443 
ölöe
 
	$rdev_dec_≥ndög
(
md_rdev
 *
rdev
, 
mddev
 *mddev)

445 
Áu…y
 = 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
);

446 i‡(
	`©omic_dec_™d_ã°
(&
rdev
->
ƒ_≥ndög
Ë&& 
Áu…y
)

447 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

448 
	}
}

450 
ölöe
 
	$md_sync_ac˘
(
block_devi˚
 *
bdev
, 
ƒ_£˘‹s
)

452 
	`©omic_add
(
ƒ_£˘‹s
, &
bdev
->
bd_c⁄èös
->
bd_disk
->
sync_io
);

453 
	}
}

455 
	smd_≥rs⁄Æôy


457 *
	m«me
;

458 
	mÀvñ
;

459 
li°_hód
 
	mli°
;

460 
moduÀ
 *
	mow√r
;

461 (*
	mmake_ªque°
)(
mddev
 *
	mmddev
, 
bio
 *
	mbio
);

462 (*
	mrun
)(
mddev
 *
	mmddev
);

463 (*
	m°›
)(
mddev
 *
	mmddev
);

464 (*
	m°©us
)(
£q_fûe
 *
	m£q
, 
mddev
 *
	mmddev
);

468 (*
	mîr‹_h™dÀr
)(
mddev
 *
	mmddev
, 
md_rdev
 *
	mrdev
);

469 (*
	mhŸ_add_disk
Ë(
mddev
 *
	mmddev
, 
md_rdev
 *
	mrdev
);

470 (*
	mhŸ_ªmove_disk
Ë(
mddev
 *
	mmddev
, 
md_rdev
 *
	mrdev
);

471 (*
	m•¨e_a˘ive
Ë(
mddev
 *
	mmddev
);

472 
£˘‹_t
 (*
sync_ªque°
)(
mddev
 *
	mmddev
, se˘‹_à
	m£˘‹_ƒ
, *
	mskù≥d
, 
	mgo_Á°î
);

473 (*
	mªsize
Ë(
mddev
 *
	mmddev
, 
£˘‹_t
 
	m£˘‹s
);

474 
£˘‹_t
 (*
size
Ë(
mddev
 *
	mmddev
, se˘‹_à
	m£˘‹s
, 
	møid_disks
);

475 (*
	mcheck_ªsh≠e
Ë(
mddev
 *
	mmddev
);

476 (*
	m°¨t_ªsh≠e
Ë(
mddev
 *
	mmddev
);

477 (*
	mföish_ªsh≠e
Ë(
mddev
 *
	mmddev
);

483 (*
	mquõs˚
Ë(
mddev
 *
	mmddev
, 
	m°©e
);

493 *(*
	mèkeovî
Ë(
mddev
 *
	mmddev
);

497 
	smd_sysfs_íåy
 {

498 
©åibuã
 
	m©å
;

499 
ssize_t
 (*
show
)(
	mmddev
 *, *);

500 
ssize_t
 (*
°‹e
)(
	mmddev
 *, c⁄° *, 
	msize_t
);

502 
©åibuã_group
 
md_bôm≠_group
;

504 
ölöe
 
kînfs_node
 *
	$sysfs_gë_dúít_ß„
(
kînfs_node
 *
sd
, *
«me
)

506 i‡(
sd
)

507  
	`sysfs_gë_dúít
(
sd
, 
«me
);

508  
sd
;

509 
	}
}

510 
ölöe
 
	$sysfs_nŸify_dúít_ß„
(
kînfs_node
 *
sd
)

512 i‡(
sd
)

513 
	`sysfs_nŸify_dúít
(
sd
);

514 
	}
}

516 
ölöe
 * 
	$md«me
 (
mddev
 * mddev)

518  
mddev
->
gídisk
 ? mddev->gídisk->
disk_«me
 : "mdX";

519 
	}
}

521 
ölöe
 
	$sysfs_lök_rdev
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

523 
nm
[20];

524 i‡(!
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
Ë&& 
mddev
->
kobj
.
sd
) {

525 
	`•rötf
(
nm
, "rd%d", 
rdev
->
øid_disk
);

526  
	`sysfs_¸óã_lök
(&
mddev
->
kobj
, &
rdev
->kobj, 
nm
);

529 
	}
}

531 
ölöe
 
	$sysfs_u∆ök_rdev
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

533 
nm
[20];

534 i‡(!
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
Ë&& 
mddev
->
kobj
.
sd
) {

535 
	`•rötf
(
nm
, "rd%d", 
rdev
->
øid_disk
);

536 
	`sysfs_ªmove_lök
(&
mddev
->
kobj
, 
nm
);

538 
	}
}

544 
	#rdev_f‹_óch_li°
(
rdev
, 
tmp
, 
hód
) \

545 
	`li°_f‹_óch_íåy_ß„
(
rdev
, 
tmp
, 
hód
, 
ßme_£t
)

	)

550 
	#rdev_f‹_óch
(
rdev
, 
mddev
) \

551 
	`li°_f‹_óch_íåy
(
rdev
, &((
mddev
)->
disks
), 
ßme_£t
)

	)

553 
	#rdev_f‹_óch_ß„
(
rdev
, 
tmp
, 
mddev
) \

554 
	`li°_f‹_óch_íåy_ß„
(
rdev
, 
tmp
, &((
mddev
)->
disks
), 
ßme_£t
)

	)

556 
	#rdev_f‹_óch_rcu
(
rdev
, 
mddev
) \

557 
	`li°_f‹_óch_íåy_rcu
(
rdev
, &((
mddev
)->
disks
), 
ßme_£t
)

	)

559 
	smd_thªad
 {

560 (*
	mrun
Ë(
md_thªad
 *
	mthªad
);

561 
mddev
 *
	mmddev
;

562 
waô_queue_hód_t
 
	mwqueue
;

563 
	mÊags
;

564 
èsk_°ru˘
 *
	mtsk
;

565 
	mtimeout
;

566 *
	m¥iv©e
;

569 
	#THREAD_WAKEUP
 0

	)

571 
ölöe
 
	$ß„_put_∑ge
(
∑ge
 *
p
)

573 i‡(
p
Ë
	`put_∑ge
(p);

574 
	}
}

576 
ªgi°î_md_≥rs⁄Æôy
(
md_≥rs⁄Æôy
 *
p
);

577 
uƒegi°î_md_≥rs⁄Æôy
(
md_≥rs⁄Æôy
 *
p
);

578 
md_thªad
 *
md_ªgi°î_thªad
(

579 (*
run
)(
md_thªad
 *
thªad
),

580 
mddev
 *mddev,

581 c⁄° *
«me
);

582 
	`md_uƒegi°î_thªad
(
md_thªad
 **
thªadp
);

583 
	`md_wakeup_thªad
(
md_thªad
 *
thªad
);

584 
	`md_check_ªcovîy
(
mddev
 *mddev);

585 
	`md_ª≠_sync_thªad
(
mddev
 *mddev);

586 
	`md_wrôe_°¨t
(
mddev
 *mddev, 
bio
 *
bi
);

587 
	`md_wrôe_íd
(
mddev
 *mddev);

588 
	`md_d⁄e_sync
(
mddev
 *mddev, 
blocks
, 
ok
);

589 
	`md_îr‹
(
mddev
 *mddev, 
md_rdev
 *
rdev
);

590 
	`md_föish_ªsh≠e
(
mddev
 *mddev);

592 
	`mddev_c⁄ge°ed
(
mddev
 *mddev, 
bôs
);

593 
	`md_Êush_ªque°
(
mddev
 *mddev, 
bio
 *bio);

594 
	`md_su≥r_wrôe
(
mddev
 *mddev, 
md_rdev
 *
rdev
,

595 
£˘‹_t
 
£˘‹
, 
size
, 
∑ge
 *page);

596 
	`md_su≥r_waô
(
mddev
 *mddev);

597 
	`sync_∑ge_io
(
md_rdev
 *
rdev
, 
£˘‹_t
 
£˘‹
, 
size
,

598 
∑ge
 *∑ge, 
rw
, 
boﬁ
 
mëad©a_›
);

599 
	`md_do_sync
(
md_thªad
 *
thªad
);

600 
	`md_√w_evít
(
mddev
 *mddev);

601 
	`md_Ælow_wrôe
(
mddev
 *mddev);

602 
	`md_waô_f‹_blocked_rdev
(
md_rdev
 *
rdev
, 
mddev
 *mddev);

603 
	`md_£t_¨øy_£˘‹s
(
mddev
 *mddev, 
£˘‹_t
 
¨øy_£˘‹s
);

604 
	`md_check_no_bôm≠
(
mddev
 *mddev);

605 
	`md_öãgrôy_ªgi°î
(
mddev
 *mddev);

606 
	`md_öãgrôy_add_rdev
(
md_rdev
 *
rdev
, 
mddev
 *mddev);

607 
	`°ri˘_°πoul_sˇÀd
(c⁄° *
˝
, *
ªs
, 
sˇÀ
);

609 
	`mddev_öô
(
mddev
 *mddev);

610 
	`md_run
(
mddev
 *mddev);

611 
	`md_°›
(
mddev
 *mddev);

612 
	`md_°›_wrôes
(
mddev
 *mddev);

613 
	`md_rdev_öô
(
md_rdev
 *
rdev
);

614 
	`md_rdev_˛ór
(
md_rdev
 *
rdev
);

616 
	`mddev_su•íd
(
mddev
 *mddev);

617 
	`mddev_ªsume
(
mddev
 *mddev);

618 
bio
 *
	`bio_˛⁄e_mddev
(biÿ*bio, 
gÂ_t
 
gÂ_mask
,

619 
mddev
 *mddev);

620 
bio
 *
	`bio_Æloc_mddev
(
gÂ_t
 
gÂ_mask
, 
ƒ_iovecs
,

621 
mddev
 *mddev);

623 
	`md_u≈lug
(
blk_∂ug_cb
 *
cb
, 
boﬁ
 
‰om_scheduÀ
);

624 
ölöe
 
	$mddev_check_∂ugged
(
mddev
 *mddev)

626  !!
	`blk_check_∂ugged
(
md_u≈lug
, 
mddev
,

627 (
blk_∂ug_cb
));

628 
	}
}

	@multipath.c

22 
	~<löux/blkdev.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/øid/md_u.h
>

25 
	~<löux/£q_fûe.h
>

26 
	~<löux/¶ab.h
>

27 
	~"md.h
"

28 
	~"mu…ù©h.h
"

30 
	#MAX_WORK_PER_DISK
 128

	)

32 
	#NR_RESERVED_BUFS
 32

	)

35 
	$mu…ù©h_m≠
 (
mpc⁄f
 *
c⁄f
)

37 
i
, 
disks
 = 
c⁄f
->
øid_disks
;

44 
	`rcu_ªad_lock
();

45 
i
 = 0; i < 
disks
; i++) {

46 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
mu…ù©hs
[
i
].rdev);

47 i‡(
rdev
 && 
	`ã°_bô
(
In_sync
, &rdev->
Êags
)) {

48 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

49 
	`rcu_ªad_u∆ock
();

50  
i
;

53 
	`rcu_ªad_u∆ock
();

55 
	`¥ötk
(
KERN_ERR
 "multipath_map():Ço more operational IOÖaths?\n");

57 
	}
}

59 
	$mu…ù©h_ªscheduÀ_ªåy
 (
mu…ù©h_bh
 *
mp_bh
)

61 
Êags
;

62 
mddev
 *mddev = 
mp_bh
->mddev;

63 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

65 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

66 
	`li°_add
(&
mp_bh
->
ªåy_li°
, &
c⁄f
->retry_list);

67 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

68 
	`md_wakeup_thªad
(
mddev
->
thªad
);

69 
	}
}

77 
	$mu…ù©h_íd_bh_io
 (
mu…ù©h_bh
 *
mp_bh
, 
îr
)

79 
bio
 *biÿ
mp_bh
->
ma°î_bio
;

80 
mpc⁄f
 *
c⁄f
 = 
mp_bh
->
mddev
->
¥iv©e
;

82 
	`bio_ídio
(
bio
, 
îr
);

83 
	`mempoﬁ_‰ì
(
mp_bh
, 
c⁄f
->
poﬁ
);

84 
	}
}

86 
	$mu…ù©h_íd_ªque°
(
bio
 *bio, 
îr‹
)

88 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

89 
mu…ù©h_bh
 *
mp_bh
 = 
bio
->
bi_¥iv©e
;

90 
mpc⁄f
 *
c⁄f
 = 
mp_bh
->
mddev
->
¥iv©e
;

91 
md_rdev
 *
rdev
 = 
c⁄f
->
mu…ù©hs
[
mp_bh
->
∑th
].rdev;

93 i‡(
u±od©e
)

94 
	`mu…ù©h_íd_bh_io
(
mp_bh
, 0);

95 i‡(!(
bio
->
bi_rw
 & 
REQ_RAHEAD
)) {

99 
b
[
BDEVNAME_SIZE
];

100 
	`md_îr‹
 (
mp_bh
->
mddev
, 
rdev
);

101 
	`¥ötk
(
KERN_ERR
 "multipath: %s:Ñescheduling sector %llu\n",

102 
	`bdev«me
(
rdev
->
bdev
,
b
),

103 ()
bio
->
bi_ôî
.
bi_£˘‹
);

104 
	`mu…ù©h_ªscheduÀ_ªåy
(
mp_bh
);

106 
	`mu…ù©h_íd_bh_io
(
mp_bh
, 
îr‹
);

107 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

108 
	}
}

110 
	$mu…ù©h_make_ªque°
(
mddev
 *mddev, 
bio
 * bio)

112 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

113 
mu…ù©h_bh
 * 
mp_bh
;

114 
mu…ù©h_öfo
 *
mu…ù©h
;

116 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_FLUSH
)) {

117 
	`md_Êush_ªque°
(
mddev
, 
bio
);

121 
mp_bh
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
poﬁ
, 
GFP_NOIO
);

123 
mp_bh
->
ma°î_bio
 = 
bio
;

124 
mp_bh
->
mddev
 = mddev;

126 
mp_bh
->
∑th
 = 
	`mu…ù©h_m≠
(
c⁄f
);

127 i‡(
mp_bh
->
∑th
 < 0) {

128 
	`bio_ídio
(
bio
, -
EIO
);

129 
	`mempoﬁ_‰ì
(
mp_bh
, 
c⁄f
->
poﬁ
);

132 
mu…ù©h
 = 
c⁄f
->
mu…ù©hs
 + 
mp_bh
->
∑th
;

134 
mp_bh
->
bio
 = *bio;

135 
mp_bh
->
bio
.
bi_ôî
.
bi_£˘‹
 +
mu…ù©h
->
rdev
->
d©a_off£t
;

136 
mp_bh
->
bio
.
bi_bdev
 = 
mu…ù©h
->
rdev
->
bdev
;

137 
mp_bh
->
bio
.
bi_rw
 |
REQ_FAILFAST_TRANSPORT
;

138 
mp_bh
->
bio
.
bi_íd_io
 = 
mu…ù©h_íd_ªque°
;

139 
mp_bh
->
bio
.
bi_¥iv©e
 = mp_bh;

140 
	`gíîic_make_ªque°
(&
mp_bh
->
bio
);

142 
	}
}

144 
	$mu…ù©h_°©us
 (
£q_fûe
 *
£q
, 
mddev
 *mddev)

146 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

147 
i
;

149 
	`£q_¥ötf
 (
£q
, " [%d/%d] [", 
c⁄f
->
øid_disks
,

150 
c⁄f
->
øid_disks
 - 
mddev
->
degøded
);

151 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++)

152 
	`£q_¥ötf
 (
£q
, "%s",

153 
c⁄f
->
mu…ù©hs
[
i
].
rdev
 &&

154 
	`ã°_bô
(
In_sync
, &
c⁄f
->
mu…ù©hs
[
i
].
rdev
->
Êags
) ? "U" : "_");

155 
	`£q_¥ötf
 (
£q
, "]");

156 
	}
}

158 
	$mu…ù©h_c⁄ge°ed
(*
d©a
, 
bôs
)

160 
mddev
 *mddev = 
d©a
;

161 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

162 
i
, 
ªt
 = 0;

164 i‡(
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
))

167 
	`rcu_ªad_lock
();

168 
i
 = 0; i < 
mddev
->
øid_disks
 ; i++) {

169 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
mu…ù©hs
[
i
].rdev);

170 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

171 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

173 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

180 
	`rcu_ªad_u∆ock
();

181  
ªt
;

182 
	}
}

187 
	$mu…ù©h_îr‹
 (
mddev
 *mddev, 
md_rdev
 *
rdev
)

189 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

190 
b
[
BDEVNAME_SIZE
];

192 i‡(
c⁄f
->
øid_disks
 - 
mddev
->
degøded
 <= 1) {

198 
	`¥ötk
(
KERN_ALERT


206 i‡(
	`ã°_™d_˛ór_bô
(
In_sync
, &
rdev
->
Êags
)) {

207 
Êags
;

208 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

209 
mddev
->
degøded
++;

210 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

212 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

213 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

214 
	`¥ötk
(
KERN_ALERT
 "multipath: IO failure on %s,"

218 
	`bdev«me
(
rdev
->
bdev
, 
b
),

219 
c⁄f
->
øid_disks
 - 
mddev
->
degøded
);

220 
	}
}

222 
	$¥öt_mu…ù©h_c⁄f
 (
mpc⁄f
 *
c⁄f
)

224 
i
;

225 
mu…ù©h_öfo
 *
tmp
;

227 
	`¥ötk
("MULTIPATH confÖrintout:\n");

228 i‡(!
c⁄f
) {

229 
	`¥ötk
("(conf==NULL)\n");

232 
	`¥ötk
(" --- wd:%dÑd:%d\n", 
c⁄f
->
øid_disks
 - c⁄f->
mddev
->
degøded
,

233 
c⁄f
->
øid_disks
);

235 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

236 
b
[
BDEVNAME_SIZE
];

237 
tmp
 = 
c⁄f
->
mu…ù©hs
 + 
i
;

238 i‡(
tmp
->
rdev
)

239 
	`¥ötk
(" disk%d, o:%d, dev:%s\n",

240 
i
,!
	`ã°_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
),

241 
	`bdev«me
(
tmp
->
rdev
->
bdev
,
b
));

243 
	}
}

246 
	$mu…ù©h_add_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

248 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

249 
ªque°_queue
 *
q
;

250 
îr
 = -
EEXIST
;

251 
∑th
;

252 
mu…ù©h_öfo
 *
p
;

253 
fú°
 = 0;

254 
œ°
 = 
mddev
->
øid_disks
 - 1;

256 i‡(
rdev
->
øid_disk
 >= 0)

257 
fú°
 = 
œ°
 = 
rdev
->
øid_disk
;

259 
	`¥öt_mu…ù©h_c⁄f
(
c⁄f
);

261 
∑th
 = 
fú°
;Ö©h <
œ°
;Öath++)

262 i‡((
p
=
c⁄f
->
mu…ù©hs
+
∑th
)->
rdev
 =
NULL
) {

263 
q
 = 
rdev
->
bdev
->
bd_disk
->
queue
;

264 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

265 
rdev
->
d©a_off£t
 << 9);

273 i‡(
q
->
mîge_bvec_‚
) {

274 
	`blk_queue_max_£gmíts
(
mddev
->
queue
, 1);

275 
	`blk_queue_£gmít_bound¨y
(
mddev
->
queue
,

276 
PAGE_CACHE_SIZE
 - 1);

279 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

280 
mddev
->
degøded
--;

281 
rdev
->
øid_disk
 = 
∑th
;

282 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

283 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

284 
	`rcu_assign_poöãr
(
p
->
rdev
,Ñdev);

285 
îr
 = 0;

286 
	`md_öãgrôy_add_rdev
(
rdev
, 
mddev
);

290 
	`¥öt_mu…ù©h_c⁄f
(
c⁄f
);

292  
îr
;

293 
	}
}

295 
	$mu…ù©h_ªmove_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

297 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

298 
îr
 = 0;

299 
numbî
 = 
rdev
->
øid_disk
;

300 
mu…ù©h_öfo
 *
p
 = 
c⁄f
->
mu…ù©hs
 + 
numbî
;

302 
	`¥öt_mu…ù©h_c⁄f
(
c⁄f
);

304 i‡(
rdev
 =
p
->rdev) {

305 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

306 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

307 
	`¥ötk
(
KERN_ERR
 "hot-remove-disk, slot %d is identified"

308 " buài†°û»›î©i⁄Æ!\n", 
numbî
);

309 
îr
 = -
EBUSY
;

310 
ab‹t
;

312 
p
->
rdev
 = 
NULL
;

313 
	`synchr⁄ize_rcu
();

314 i‡(
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

316 
îr
 = -
EBUSY
;

317 
p
->
rdev
 =Ñdev;

318 
ab‹t
;

320 
îr
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

322 
ab‹t
:

324 
	`¥öt_mu…ù©h_c⁄f
(
c⁄f
);

325  
îr
;

326 
	}
}

338 
	$mu…ù©hd
(
md_thªad
 *
thªad
)

340 
mddev
 *mddev = 
thªad
->mddev;

341 
mu…ù©h_bh
 *
mp_bh
;

342 
bio
 *bio;

343 
Êags
;

344 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

345 
li°_hód
 *
hód
 = &
c⁄f
->
ªåy_li°
;

347 
	`md_check_ªcovîy
(
mddev
);

349 
b
[
BDEVNAME_SIZE
];

350 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

351 i‡(
	`li°_em±y
(
hód
))

353 
mp_bh
 = 
	`li°_íåy
(
hód
->
¥ev
, 
mu…ù©h_bh
, 
ªåy_li°
);

354 
	`li°_dñ
(
hód
->
¥ev
);

355 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

357 
bio
 = &
mp_bh
->bio;

358 
bio
->
bi_ôî
.
bi_£˘‹
 = 
mp_bh
->
ma°î_bio
->bi_iter.bi_sector;

360 i‡((
mp_bh
->
∑th
 = 
	`mu…ù©h_m≠
 (
c⁄f
))<0) {

361 
	`¥ötk
(
KERN_ALERT
 "multipath: %s: unrecoverable IOÑead"

363 
	`bdev«me
(
bio
->
bi_bdev
,
b
),

364 ()
bio
->
bi_ôî
.
bi_£˘‹
);

365 
	`mu…ù©h_íd_bh_io
(
mp_bh
, -
EIO
);

367 
	`¥ötk
(
KERN_ERR
 "multipath: %s:Ñedirecting sector %llu"

369 
	`bdev«me
(
bio
->
bi_bdev
,
b
),

370 ()
bio
->
bi_ôî
.
bi_£˘‹
);

371 *
bio
 = *(
mp_bh
->
ma°î_bio
);

372 
bio
->
bi_ôî
.
bi_£˘‹
 +=

373 
c⁄f
->
mu…ù©hs
[
mp_bh
->
∑th
].
rdev
->
d©a_off£t
;

374 
bio
->
bi_bdev
 = 
c⁄f
->
mu…ù©hs
[
mp_bh
->
∑th
].
rdev
->
bdev
;

375 
bio
->
bi_rw
 |
REQ_FAILFAST_TRANSPORT
;

376 
bio
->
bi_íd_io
 = 
mu…ù©h_íd_ªque°
;

377 
bio
->
bi_¥iv©e
 = 
mp_bh
;

378 
	`gíîic_make_ªque°
(
bio
);

381 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

382 
	}
}

384 
£˘‹_t
 
	$mu…ù©h_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

386 
	`WARN_ONCE
(
£˘‹s
 || 
øid_disks
,

387 "%†d€†nŸ suµ‹àgíîi¯ªsh≠e\n", 
__func__
);

389  
mddev
->
dev_£˘‹s
;

390 
	}
}

392 
	$mu…ù©h_run
 (
mddev
 *mddev)

394 
mpc⁄f
 *
c⁄f
;

395 
disk_idx
;

396 
mu…ù©h_öfo
 *
disk
;

397 
md_rdev
 *
rdev
;

398 
w‹kög_disks
;

400 i‡(
	`md_check_no_bôm≠
(
mddev
))

401  -
EINVAL
;

403 i‡(
mddev
->
Àvñ
 !
LEVEL_MULTIPATH
) {

404 
	`¥ötk
("multipath: %s:ÑaidÜevelÇot setÅo multipath IO (%d)\n",

405 
	`md«me
(
mddev
), mddev->
Àvñ
);

406 
out
;

414 
c⁄f
 = 
	`kzÆloc
((
mpc⁄f
), 
GFP_KERNEL
);

415 
mddev
->
¥iv©e
 = 
c⁄f
;

416 i‡(!
c⁄f
) {

417 
	`¥ötk
(
KERN_ERR


419 
	`md«me
(
mddev
));

420 
out
;

423 
c⁄f
->
mu…ù©hs
 = 
	`kzÆloc
((
mu…ù©h_öfo
)*
mddev
->
øid_disks
,

424 
GFP_KERNEL
);

425 i‡(!
c⁄f
->
mu…ù©hs
) {

426 
	`¥ötk
(
KERN_ERR


428 
	`md«me
(
mddev
));

429 
out_‰ì_c⁄f
;

432 
w‹kög_disks
 = 0;

433 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

434 
disk_idx
 = 
rdev
->
øid_disk
;

435 i‡(
disk_idx
 < 0 ||

436 
disk_idx
 >
mddev
->
øid_disks
)

439 
disk
 = 
c⁄f
->
mu…ù©hs
 + 
disk_idx
;

440 
disk
->
rdev
 =Ñdev;

441 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

442 
rdev
->
d©a_off£t
 << 9);

447 i‡(
rdev
->
bdev
->
bd_disk
->
queue
->
mîge_bvec_‚
) {

448 
	`blk_queue_max_£gmíts
(
mddev
->
queue
, 1);

449 
	`blk_queue_£gmít_bound¨y
(
mddev
->
queue
,

450 
PAGE_CACHE_SIZE
 - 1);

453 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

454 
w‹kög_disks
++;

457 
c⁄f
->
øid_disks
 = 
mddev
->raid_disks;

458 
c⁄f
->
mddev
 = mddev;

459 
	`•ö_lock_öô
(&
c⁄f
->
devi˚_lock
);

460 
	`INIT_LIST_HEAD
(&
c⁄f
->
ªåy_li°
);

462 i‡(!
w‹kög_disks
) {

463 
	`¥ötk
(
KERN_ERR
 "multipath:Ço operational IOÖaths for %s\n",

464 
	`md«me
(
mddev
));

465 
out_‰ì_c⁄f
;

467 
mddev
->
degøded
 = 
c⁄f
->
øid_disks
 - 
w‹kög_disks
;

469 
c⁄f
->
poﬁ
 = 
	`mempoﬁ_¸óã_kmÆloc_poﬁ
(
NR_RESERVED_BUFS
,

470 (
mu…ù©h_bh
));

471 i‡(
c⁄f
->
poﬁ
 =
NULL
) {

472 
	`¥ötk
(
KERN_ERR


474 
	`md«me
(
mddev
));

475 
out_‰ì_c⁄f
;

479 
mddev
->
thªad
 = 
	`md_ªgi°î_thªad
(
mu…ù©hd
, mddev,

481 i‡(!
mddev
->
thªad
) {

482 
	`¥ötk
(
KERN_ERR
 "multipath: couldn'tállocateÅhread"

483 " f‹ %s\n", 
	`md«me
(
mddev
));

484 
out_‰ì_c⁄f
;

488 
	`¥ötk
(
KERN_INFO


490 
	`md«me
(
mddev
), 
c⁄f
->
øid_disks
 - mddev->
degøded
,

491 
mddev
->
øid_disks
);

495 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`mu…ù©h_size
(mddev, 0, 0));

497 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
mu…ù©h_c⁄ge°ed
;

498 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

500 i‡(
	`md_öãgrôy_ªgi°î
(
mddev
))

501 
out_‰ì_c⁄f
;

505 
out_‰ì_c⁄f
:

506 i‡(
c⁄f
->
poﬁ
)

507 
	`mempoﬁ_de°roy
(
c⁄f
->
poﬁ
);

508 
	`k‰ì
(
c⁄f
->
mu…ù©hs
);

509 
	`k‰ì
(
c⁄f
);

510 
mddev
->
¥iv©e
 = 
NULL
;

511 
out
:

512  -
EIO
;

513 
	}
}

516 
	$mu…ù©h_°›
 (
mddev
 *mddev)

518 
mpc⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

520 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

521 
	`blk_sync_queue
(
mddev
->
queue
);

522 
	`mempoﬁ_de°roy
(
c⁄f
->
poﬁ
);

523 
	`k‰ì
(
c⁄f
->
mu…ù©hs
);

524 
	`k‰ì
(
c⁄f
);

525 
mddev
->
¥iv©e
 = 
NULL
;

527 
	}
}

529 
md_≥rs⁄Æôy
 
	gmu…ù©h_≥rs⁄Æôy
 =

531 .
«me
 = "multipath",

532 .
	gÀvñ
 = 
LEVEL_MULTIPATH
,

533 .
	gow√r
 = 
THIS_MODULE
,

534 .
	gmake_ªque°
 = 
mu…ù©h_make_ªque°
,

535 .
	grun
 = 
mu…ù©h_run
,

536 .
	g°›
 = 
mu…ù©h_°›
,

537 .
	g°©us
 = 
mu…ù©h_°©us
,

538 .
	gîr‹_h™dÀr
 = 
mu…ù©h_îr‹
,

539 .
	ghŸ_add_disk
 = 
mu…ù©h_add_disk
,

540 .
	ghŸ_ªmove_disk

mu…ù©h_ªmove_disk
,

541 .
	gsize
 = 
mu…ù©h_size
,

544 
__öô
 
	$mu…ù©h_öô
 ()

546  
	`ªgi°î_md_≥rs⁄Æôy
 (&
mu…ù©h_≥rs⁄Æôy
);

547 
	}
}

549 
__exô
 
	$mu…ù©h_exô
 ()

551 
	`uƒegi°î_md_≥rs⁄Æôy
 (&
mu…ù©h_≥rs⁄Æôy
);

552 
	}
}

554 
moduÀ_öô
(
mu…ù©h_öô
);

555 
moduÀ_exô
(
mu…ù©h_exô
);

556 
MODULE_LICENSE
("GPL");

557 
MODULE_DESCRIPTION
("simple multi-pathÖersonality for MD");

558 
MODULE_ALIAS
("md-personality-7");

559 
MODULE_ALIAS
("md-multipath");

560 
MODULE_ALIAS
("md-level--4");

	@multipath.h

1 #i‚de‡
_MULTIPATH_H


2 
	#_MULTIPATH_H


	)

4 
	smu…ù©h_öfo
 {

5 
md_rdev
 *
	mrdev
;

8 
	smpc⁄f
 {

9 
mddev
 *
	mmddev
;

10 
mu…ù©h_öfo
 *
	mmu…ù©hs
;

11 
	møid_disks
;

12 
•ölock_t
 
	mdevi˚_lock
;

13 
li°_hód
 
	mªåy_li°
;

15 
mempoﬁ_t
 *
	mpoﬁ
;

24 
	smu…ù©h_bh
 {

25 
mddev
 *
	mmddev
;

26 
bio
 *
	mma°î_bio
;

27 
bio
 
	mbio
;

28 
	m∑th
;

29 
li°_hód
 
	mªåy_li°
;

	@multipath.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

24 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

25 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

26 { 0x7723Øab, 
__VMLINUX_SYMBOL_STR
(
md_ªgi°î_thªad
) },

27 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

28 { 0xa05c03df, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_kmÆloc
) },

29 { 0x6a037cf1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_k‰ì
) },

30 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

31 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

32 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

33 { 0x35d3fbad, 
__VMLINUX_SYMBOL_STR
(
md_check_no_bôm≠
) },

34 { 0x4101c3c9, 
__VMLINUX_SYMBOL_STR
(
md_Êush_ªque°
) },

35 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

36 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

37 { 0x21e3985c, 
__VMLINUX_SYMBOL_STR
(
md_check_ªcovîy
) },

38 { 0xc90c172a, 
__VMLINUX_SYMBOL_STR
(
md_wakeup_thªad
) },

39 { 0x2f6da7a9, 
__VMLINUX_SYMBOL_STR
(
md_îr‹
) },

40 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

41 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

42 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

43 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

44 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

45 { 0x8c0603d0, 
__VMLINUX_SYMBOL_STR
(
blk_sync_queue
) },

46 { 0x4c107f4a, 
__VMLINUX_SYMBOL_STR
(
md_uƒegi°î_thªad
) },

47 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

48 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

49 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

50 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

51 { 0x2c˚a702, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_add_rdev
) },

52 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

53 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

54 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

55 { 0x1óf„0a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_£gmít_bound¨y
) },

56 { 0x677d4˚4, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_£gmíts
) },

57 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

58 { 0x719b4945, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_ªgi°î
) },

59 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchr⁄ize_sched
) },

60 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

61 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

62 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

63 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

66 c⁄° 
	g__moduÀ_dïíds
[]

67 
__u£d


68 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

72 
MODULE_INFO
(
§cvîsi⁄
, "964FA72DE133A1C9BEFDF5D");

	@persistent-data/dm-array.c

7 
	~"dm-¨øy.h
"

8 
	~"dm-•a˚-m≠.h
"

9 
	~"dm-å™ß˘i⁄-m™agî.h
"

11 
	~<löux/exp‹t.h
>

12 
	~<löux/devi˚-m≠≥r.h
>

14 
	#DM_MSG_PREFIX
 "¨øy"

	)

23 
	s¨øy_block
 {

24 
__À32
 
	mcsum
;

25 
__À32
 
	mmax_íåõs
;

26 
__À32
 
	mƒ_íåõs
;

27 
__À32
 
	mvÆue_size
;

28 
__À64
 
	mblockƒ
;

29 } 
	g__∑cked
;

38 
	#CSUM_XOR
 595846735

	)

40 
	$¨øy_block_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

41 
dm_block
 *
b
,

42 
size_t
 
size_of_block
)

44 
¨øy_block
 *
bh_À
 = 
	`dm_block_d©a
(
b
);

46 
bh_À
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

47 
bh_À
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&bh_À->
max_íåõs
,

48 
size_of_block
 - (
__À32
),

49 
CSUM_XOR
));

50 
	}
}

52 
	$¨øy_block_check
(
dm_block_vÆid©‹
 *
v
,

53 
dm_block
 *
b
,

54 
size_t
 
size_of_block
)

56 
¨øy_block
 *
bh_À
 = 
	`dm_block_d©a
(
b
);

57 
__À32
 
csum_disk
;

59 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
bh_À
->
blockƒ
)) {

60 
	`DMERR_LIMIT
("array_block_check failed: blocknr %llu != wanted %llu",

61 (Ë
	`À64_to_˝u
(
bh_À
->
blockƒ
),

62 (Ë
	`dm_block_loˇti⁄
(
b
));

63  -
ENOTBLK
;

66 
csum_disk
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
bh_À
->
max_íåõs
,

67 
size_of_block
 - (
__À32
),

68 
CSUM_XOR
));

69 i‡(
csum_disk
 !
bh_À
->
csum
) {

70 
	`DMERR_LIMIT
("array_block_check failed: csum %u != wanted %u",

71 (Ë
	`À32_to_˝u
(
csum_disk
),

72 (Ë
	`À32_to_˝u
(
bh_À
->
csum
));

73  -
EILSEQ
;

77 
	}
}

79 
dm_block_vÆid©‹
 
	g¨øy_vÆid©‹
 = {

80 .
«me
 = "array",

81 .
	g¥ï¨e_f‹_wrôe
 = 
¨øy_block_¥ï¨e_f‹_wrôe
,

82 .
	gcheck
 = 
¨øy_block_check


96 *
	$ñemít_©
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
,

97 
ödex
)

99 *
íåy
 = (*Ë(
ab
 + 1);

101 
íåy
 +
ödex
 * 
öfo
->
vÆue_ty≥
.
size
;

103  
íåy
;

104 
	}
}

110 
⁄_íåõs
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
,

111 (*
‚
)(*, const *))

113 
i
, 
ƒ_íåõs
 = 
	`À32_to_˝u
(
ab
->nr_entries);

115 
i
 = 0; i < 
ƒ_íåõs
; i++)

116 
	`‚
(
öfo
->
vÆue_ty≥
.
c⁄ãxt
, 
	`ñemít_©
(öfo, 
ab
, 
i
));

117 
	}
}

122 
	$öc_ablock_íåõs
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
)

124 
dm_båì_vÆue_ty≥
 *
vt
 = &
öfo
->
vÆue_ty≥
;

126 i‡(
vt
->
öc
)

127 
	`⁄_íåõs
(
öfo
, 
ab
, 
vt
->
öc
);

128 
	}
}

133 
	$dec_ablock_íåõs
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
)

135 
dm_båì_vÆue_ty≥
 *
vt
 = &
öfo
->
vÆue_ty≥
;

137 i‡(
vt
->
dec
)

138 
	`⁄_íåõs
(
öfo
, 
ab
, 
vt
->
dec
);

139 
	}
}

144 
uöt32_t
 
	$ˇlc_max_íåõs
(
size_t
 
vÆue_size
, size_à
size_of_block
)

146  (
size_of_block
 - (
¨øy_block
)Ë/ 
vÆue_size
;

147 
	}
}

152 
	$Æloc_ablock
(
dm_¨øy_öfo
 *
öfo
, 
size_t
 
size_of_block
,

153 
uöt32_t
 
max_íåõs
,

154 
dm_block
 **
block
, 
¨øy_block
 **
ab
)

156 
r
;

158 
r
 = 
	`dm_tm_√w_block
(
öfo
->
båì_öfo
.
tm
, &
¨øy_vÆid©‹
, 
block
);

159 i‡(
r
)

160  
r
;

162 (*
ab
Ë
	`dm_block_d©a
(*
block
);

163 (*
ab
)->
max_íåõs
 = 
	`˝u_to_À32
(max_entries);

164 (*
ab
)->
ƒ_íåõs
 = 
	`˝u_to_À32
(0);

165 (*
ab
)->
vÆue_size
 = 
	`˝u_to_À32
(
öfo
->
vÆue_ty≥
.
size
);

168 
	}
}

175 
	$fûl_ablock
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
,

176 c⁄° *
vÆue
, 
√w_ƒ
)

178 
i
;

179 
uöt32_t
 
ƒ_íåõs
;

180 
dm_båì_vÆue_ty≥
 *
vt
 = &
öfo
->
vÆue_ty≥
;

182 
	`BUG_ON
(
√w_ƒ
 > 
	`À32_to_˝u
(
ab
->
max_íåõs
));

183 
	`BUG_ON
(
√w_ƒ
 < 
	`À32_to_˝u
(
ab
->
ƒ_íåõs
));

185 
ƒ_íåõs
 = 
	`À32_to_˝u
(
ab
->nr_entries);

186 
i
 = 
ƒ_íåõs
; i < 
√w_ƒ
; i++) {

187 i‡(
vt
->
öc
)

188 
vt
->
	`öc
(vt->
c⁄ãxt
, 
vÆue
);

189 
	`mem˝y
(
	`ñemít_©
(
öfo
, 
ab
, 
i
), 
vÆue
, 
vt
->
size
);

191 
ab
->
ƒ_íåõs
 = 
	`˝u_to_À32
(
√w_ƒ
);

192 
	}
}

199 
	$åim_ablock
(
dm_¨øy_öfo
 *
öfo
, 
¨øy_block
 *
ab
,

200 
√w_ƒ
)

202 
i
;

203 
uöt32_t
 
ƒ_íåõs
;

204 
dm_båì_vÆue_ty≥
 *
vt
 = &
öfo
->
vÆue_ty≥
;

206 
	`BUG_ON
(
√w_ƒ
 > 
	`À32_to_˝u
(
ab
->
max_íåõs
));

207 
	`BUG_ON
(
√w_ƒ
 > 
	`À32_to_˝u
(
ab
->
ƒ_íåõs
));

209 
ƒ_íåõs
 = 
	`À32_to_˝u
(
ab
->nr_entries);

210 
i
 = 
ƒ_íåõs
; i > 
√w_ƒ
; i--)

211 i‡(
vt
->
dec
)

212 
vt
->
	`dec
(vt->
c⁄ãxt
, 
	`ñemít_©
(
öfo
, 
ab
, 
i
 - 1));

213 
ab
->
ƒ_íåõs
 = 
	`˝u_to_À32
(
√w_ƒ
);

214 
	}
}

220 
	$gë_ablock
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
b
,

221 
dm_block
 **
block
, 
¨øy_block
 **
ab
)

223 
r
;

225 
r
 = 
	`dm_tm_ªad_lock
(
öfo
->
båì_öfo
.
tm
, 
b
, &
¨øy_vÆid©‹
, 
block
);

226 i‡(
r
)

227  
r
;

229 *
ab
 = 
	`dm_block_d©a
(*
block
);

231 
	}
}

236 
	$u∆ock_ablock
(
dm_¨øy_öfo
 *
öfo
, 
dm_block
 *
block
)

238  
	`dm_tm_u∆ock
(
öfo
->
båì_öfo
.
tm
, 
block
);

239 
	}
}

253 
	$lookup_ablock
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

254 
ödex
, 
dm_block
 **
block
,

255 
¨øy_block
 **
ab
)

257 
r
;

258 
uöt64_t
 
key
 = 
ödex
;

259 
__À64
 
block_À
;

261 
r
 = 
	`dm_båì_lookup
(&
öfo
->
båì_öfo
, 
roŸ
, &
key
, &
block_À
);

262 i‡(
r
)

263  
r
;

265  
	`gë_ablock
(
öfo
, 
	`À64_to_˝u
(
block_À
), 
block
, 
ab
);

266 
	}
}

271 
	$ö£π_ablock
(
dm_¨øy_öfo
 *
öfo
, 
uöt64_t
 
ödex
,

272 
dm_block
 *
block
, 
dm_block_t
 *
roŸ
)

274 
__À64
 
block_À
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
block
));

276 
	`__dm_bÀss_f‹_disk
(
block_À
);

277  
	`dm_båì_ö£π
(&
öfo
->
båì_öfo
, *
roŸ
, &
ödex
, &
block_À
,Ñoot);

278 
	}
}

285 
	$shadow_ablock
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 *
roŸ
,

286 
ödex
, 
dm_block
 **
block
,

287 
¨øy_block
 **
ab
)

289 
r
, 
öc
;

290 
uöt64_t
 
key
 = 
ödex
;

291 
dm_block_t
 
b
;

292 
__À64
 
block_À
;

297 
r
 = 
	`dm_båì_lookup
(&
öfo
->
båì_öfo
, *
roŸ
, &
key
, &
block_À
);

298 i‡(
r
)

299  
r
;

300 
b
 = 
	`À64_to_˝u
(
block_À
);

305 
r
 = 
	`dm_tm_shadow_block
(
öfo
->
båì_öfo
.
tm
, 
b
,

306 &
¨øy_vÆid©‹
, 
block
, &
öc
);

307 i‡(
r
)

308  
r
;

310 *
ab
 = 
	`dm_block_d©a
(*
block
);

311 i‡(
öc
)

312 
	`öc_ablock_íåõs
(
öfo
, *
ab
);

320 i‡(
	`dm_block_loˇti⁄
(*
block
Ë!
b
) {

327 
	`dm_tm_öc
(
öfo
->
båì_öfo
.
tm
, 
b
);

328 
r
 = 
	`ö£π_ablock
(
öfo
, 
ödex
, *
block
, 
roŸ
);

331  
r
;

332 
	}
}

337 
	$ö£π_√w_ablock
(
dm_¨øy_öfo
 *
öfo
, 
size_t
 
size_of_block
,

338 
uöt32_t
 
max_íåõs
,

339 
block_ödex
, 
uöt32_t
 
ƒ
,

340 c⁄° *
vÆue
, 
dm_block_t
 *
roŸ
)

342 
r
;

343 
dm_block
 *
block
;

344 
¨øy_block
 *
ab
;

346 
r
 = 
	`Æloc_ablock
(
öfo
, 
size_of_block
, 
max_íåõs
, &
block
, &
ab
);

347 i‡(
r
)

348  
r
;

350 
	`fûl_ablock
(
öfo
, 
ab
, 
vÆue
, 
ƒ
);

351 
r
 = 
	`ö£π_ablock
(
öfo
, 
block_ödex
, 
block
, 
roŸ
);

352 
	`u∆ock_ablock
(
öfo
, 
block
);

354  
r
;

355 
	}
}

357 
	$ö£π_fuŒ_ablocks
(
dm_¨øy_öfo
 *
öfo
, 
size_t
 
size_of_block
,

358 
begö_block
, 
íd_block
,

359 
max_íåõs
, c⁄° *
vÆue
,

360 
dm_block_t
 *
roŸ
)

362 
r
 = 0;

364 ; !
r
 && 
begö_block
 !
íd_block
; begin_block++)

365 
r
 = 
	`ö£π_√w_ablock
(
öfo
, 
size_of_block
, 
max_íåõs
, 
begö_block
, max_íåõs, 
vÆue
, 
roŸ
);

367  
r
;

368 
	}
}

375 
	sªsize
 {

379 
dm_¨øy_öfo
 *
	möfo
;

384 
dm_block_t
 
	mroŸ
;

390 
size_t
 
	msize_of_block
;

395 
	mmax_íåõs
;

402 
	mﬁd_ƒ_fuŒ_blocks
, 
	m√w_ƒ_fuŒ_blocks
;

408 
	mﬁd_ƒ_íåõs_ö_œ°_block
, 
	m√w_ƒ_íåõs_ö_œ°_block
;

413 c⁄° *
	mvÆue
;

423 
	$dr›_blocks
(
ªsize
 *ªsize, 
begö_ödex
,

424 
íd_ödex
)

426 
r
;

428 
begö_ödex
 !
íd_ödex
) {

429 
uöt64_t
 
key
 = 
begö_ödex
++;

430 
r
 = 
	`dm_båì_ªmove
(&
ªsize
->
öfo
->
båì_öfo
,Ñesize->
roŸ
,

431 &
key
, &
ªsize
->
roŸ
);

432 i‡(
r
)

433  
r
;

437 
	}
}

442 
	$tŸÆ_ƒ_blocks_√eded
(
ƒ_fuŒ_blocks
,

443 
ƒ_íåõs_ö_œ°_block
)

445  
ƒ_fuŒ_blocks
 + (
ƒ_íåõs_ö_œ°_block
 ? 1 : 0);

446 
	}
}

451 
	$shrök
(
ªsize
 *resize)

453 
r
;

454 
begö
, 
íd
;

455 
dm_block
 *
block
;

456 
¨øy_block
 *
ab
;

461 i‡(
ªsize
->
√w_ƒ_fuŒ_blocks
 <Ñesize->
ﬁd_ƒ_fuŒ_blocks
) {

462 
begö
 = 
	`tŸÆ_ƒ_blocks_√eded
(
ªsize
->
√w_ƒ_fuŒ_blocks
,

463 
ªsize
->
√w_ƒ_íåõs_ö_œ°_block
);

464 
íd
 = 
	`tŸÆ_ƒ_blocks_√eded
(
ªsize
->
ﬁd_ƒ_fuŒ_blocks
,

465 
ªsize
->
ﬁd_ƒ_íåõs_ö_œ°_block
);

467 
r
 = 
	`dr›_blocks
(
ªsize
, 
begö
, 
íd
);

468 i‡(
r
)

469  
r
;

475 i‡(
ªsize
->
√w_ƒ_íåõs_ö_œ°_block
) {

476 
r
 = 
	`shadow_ablock
(
ªsize
->
öfo
, &ªsize->
roŸ
,

477 
ªsize
->
√w_ƒ_fuŒ_blocks
, &
block
, &
ab
);

478 i‡(
r
)

479  
r
;

481 
	`åim_ablock
(
ªsize
->
öfo
, 
ab
,Ñesize->
√w_ƒ_íåõs_ö_œ°_block
);

482 
	`u∆ock_ablock
(
ªsize
->
öfo
, 
block
);

486 
	}
}

491 
	$grow_exãnd_èû_block
(
ªsize
 *ªsize, 
uöt32_t
 
√w_ƒ_íåõs
)

493 
r
;

494 
dm_block
 *
block
;

495 
¨øy_block
 *
ab
;

497 
r
 = 
	`shadow_ablock
(
ªsize
->
öfo
, &ªsize->
roŸ
,

498 
ªsize
->
ﬁd_ƒ_fuŒ_blocks
, &
block
, &
ab
);

499 i‡(
r
)

500  
r
;

502 
	`fûl_ablock
(
ªsize
->
öfo
, 
ab
,Ñesize->
vÆue
, 
√w_ƒ_íåõs
);

503 
	`u∆ock_ablock
(
ªsize
->
öfo
, 
block
);

505  
r
;

506 
	}
}

508 
	$grow_add_èû_block
(
ªsize
 *resize)

510  
	`ö£π_√w_ablock
(
ªsize
->
öfo
,Ñesize->
size_of_block
,

511 
ªsize
->
max_íåõs
,

512 
ªsize
->
√w_ƒ_fuŒ_blocks
,

513 
ªsize
->
√w_ƒ_íåõs_ö_œ°_block
,

514 
ªsize
->
vÆue
, &ªsize->
roŸ
);

515 
	}
}

517 
	$grow_√eds_m‹e_blocks
(
ªsize
 *resize)

519 
r
;

520 
ﬁd_ƒ_blocks
 = 
ªsize
->
ﬁd_ƒ_fuŒ_blocks
;

522 i‡(
ªsize
->
ﬁd_ƒ_íåõs_ö_œ°_block
 > 0) {

523 
ﬁd_ƒ_blocks
++;

525 
r
 = 
	`grow_exãnd_èû_block
(
ªsize
,Ñesize->
max_íåõs
);

526 i‡(
r
)

527  
r
;

530 
r
 = 
	`ö£π_fuŒ_ablocks
(
ªsize
->
öfo
,Ñesize->
size_of_block
,

531 
ﬁd_ƒ_blocks
,

532 
ªsize
->
√w_ƒ_fuŒ_blocks
,

533 
ªsize
->
max_íåõs
,Ñesize->
vÆue
,

534 &
ªsize
->
roŸ
);

535 i‡(
r
)

536  
r
;

538 i‡(
ªsize
->
√w_ƒ_íåõs_ö_œ°_block
)

539 
r
 = 
	`grow_add_èû_block
(
ªsize
);

541  
r
;

542 
	}
}

544 
	$grow
(
ªsize
 *resize)

546 i‡(
ªsize
->
√w_ƒ_fuŒ_blocks
 >Ñesize->
ﬁd_ƒ_fuŒ_blocks
)

547  
	`grow_√eds_m‹e_blocks
(
ªsize
);

549 i‡(
ªsize
->
ﬁd_ƒ_íåõs_ö_œ°_block
)

550  
	`grow_exãnd_èû_block
(
ªsize
,Ñesize->
√w_ƒ_íåõs_ö_œ°_block
);

553  
	`grow_add_èû_block
(
ªsize
);

554 
	}
}

562 
	$block_öc
(*
c⁄ãxt
, c⁄° *
vÆue
)

564 
__À64
 
block_À
;

565 
dm_¨øy_öfo
 *
öfo
 = 
c⁄ãxt
;

567 
	`mem˝y
(&
block_À
, 
vÆue
, (block_le));

568 
	`dm_tm_öc
(
öfo
->
båì_öfo
.
tm
, 
	`À64_to_˝u
(
block_À
));

569 
	}
}

571 
	$block_dec
(*
c⁄ãxt
, c⁄° *
vÆue
)

573 
r
;

574 
uöt64_t
 
b
;

575 
__À64
 
block_À
;

576 
uöt32_t
 
ªf_cou¡
;

577 
dm_block
 *
block
;

578 
¨øy_block
 *
ab
;

579 
dm_¨øy_öfo
 *
öfo
 = 
c⁄ãxt
;

581 
	`mem˝y
(&
block_À
, 
vÆue
, (block_le));

582 
b
 = 
	`À64_to_˝u
(
block_À
);

584 
r
 = 
	`dm_tm_ªf
(
öfo
->
båì_öfo
.
tm
, 
b
, &
ªf_cou¡
);

585 i‡(
r
) {

586 
	`DMERR_LIMIT
("couldn't getÑeference count for block %llu",

587 (Ë
b
);

591 i‡(
ªf_cou¡
 == 1) {

596 
r
 = 
	`gë_ablock
(
öfo
, 
b
, &
block
, &
ab
);

597 i‡(
r
) {

598 
	`DMERR_LIMIT
("couldn't getárray block %llu",

599 (Ë
b
);

603 
	`dec_ablock_íåõs
(
öfo
, 
ab
);

604 
	`u∆ock_ablock
(
öfo
, 
block
);

607 
	`dm_tm_dec
(
öfo
->
båì_öfo
.
tm
, 
b
);

608 
	}
}

610 
	$block_equÆ
(*
c⁄ãxt
, c⁄° *
vÆue1
, c⁄° *
vÆue2
)

612  !
	`memcmp
(
vÆue1
, 
vÆue2
, (
__À64
));

613 
	}
}

617 
	$dm_¨øy_öfo_öô
(
dm_¨øy_öfo
 *
öfo
,

618 
dm_å™ß˘i⁄_m™agî
 *
tm
,

619 
dm_båì_vÆue_ty≥
 *
vt
)

621 
dm_båì_vÆue_ty≥
 *
bvt
 = &
öfo
->
båì_öfo
.
vÆue_ty≥
;

623 
	`mem˝y
(&
öfo
->
vÆue_ty≥
, 
vt
, (info->value_type));

624 
öfo
->
båì_öfo
.
tm
 =Åm;

625 
öfo
->
båì_öfo
.
Àvñs
 = 1;

627 
bvt
->
c⁄ãxt
 = 
öfo
;

628 
bvt
->
size
 = (
__À64
);

629 
bvt
->
öc
 = 
block_öc
;

630 
bvt
->
dec
 = 
block_dec
;

631 
bvt
->
equÆ
 = 
block_equÆ
;

632 
	}
}

633 
EXPORT_SYMBOL_GPL
(
dm_¨øy_öfo_öô
);

635 
	$dm_¨øy_em±y
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 *
roŸ
)

637  
	`dm_båì_em±y
(&
öfo
->
båì_öfo
, 
roŸ
);

638 
	}
}

639 
EXPORT_SYMBOL_GPL
(
dm_¨øy_em±y
);

641 
	$¨øy_ªsize
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

642 
uöt32_t
 
ﬁd_size
, uöt32_à
√w_size
,

643 c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

645 
r
;

646 
ªsize
Ñesize;

648 i‡(
ﬁd_size
 =
√w_size
)

651 
ªsize
.
öfo
 = info;

652 
ªsize
.
roŸ
 =Ñoot;

653 
ªsize
.
size_of_block
 = 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
öfo
->
båì_öfo
.
tm
));

654 
ªsize
.
max_íåõs
 = 
	`ˇlc_max_íåõs
(
öfo
->
vÆue_ty≥
.
size
,

655 
ªsize
.
size_of_block
);

657 
ªsize
.
ﬁd_ƒ_fuŒ_blocks
 = 
ﬁd_size
 /Ñesize.
max_íåõs
;

658 
ªsize
.
ﬁd_ƒ_íåõs_ö_œ°_block
 = 
ﬁd_size
 %Ñesize.
max_íåõs
;

659 
ªsize
.
√w_ƒ_fuŒ_blocks
 = 
√w_size
 /Ñesize.
max_íåõs
;

660 
ªsize
.
√w_ƒ_íåõs_ö_œ°_block
 = 
√w_size
 %Ñesize.
max_íåõs
;

661 
ªsize
.
vÆue
 = value;

663 
r
 = ((
√w_size
 > 
ﬁd_size
Ë? 
grow
 : 
shrök
)(&
ªsize
);

664 i‡(
r
)

665  
r
;

667 *
√w_roŸ
 = 
ªsize
.
roŸ
;

669 
	}
}

671 
	$dm_¨øy_ªsize
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

672 
uöt32_t
 
ﬁd_size
, uöt32_à
√w_size
,

673 c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

674 
	$__dm_wrôãn_to_disk
(
vÆue
)

676 
r
 = 
	`¨øy_ªsize
(
öfo
, 
roŸ
, 
ﬁd_size
, 
√w_size
, 
vÆue
, 
√w_roŸ
);

677 
	`__dm_unbÀss_f‹_disk
(
vÆue
);

678  
r
;

679 
	}
}

680 
EXPORT_SYMBOL_GPL
(
dm_¨øy_ªsize
);

682 
	$dm_¨øy_dñ
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
)

684  
	`dm_båì_dñ
(&
öfo
->
båì_öfo
, 
roŸ
);

685 
	}
}

686 
EXPORT_SYMBOL_GPL
(
dm_¨øy_dñ
);

688 
	$dm_¨øy_gë_vÆue
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

689 
uöt32_t
 
ödex
, *
vÆue_À
)

691 
r
;

692 
dm_block
 *
block
;

693 
¨øy_block
 *
ab
;

694 
size_t
 
size_of_block
;

695 
íåy
, 
max_íåõs
;

697 
size_of_block
 = 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
öfo
->
båì_öfo
.
tm
));

698 
max_íåõs
 = 
	`ˇlc_max_íåõs
(
öfo
->
vÆue_ty≥
.
size
, 
size_of_block
);

700 
r
 = 
	`lookup_ablock
(
öfo
, 
roŸ
, 
ödex
 / 
max_íåõs
, &
block
, &
ab
);

701 i‡(
r
)

702  
r
;

704 
íåy
 = 
ödex
 % 
max_íåõs
;

705 i‡(
íåy
 >
	`À32_to_˝u
(
ab
->
ƒ_íåõs
))

706 
r
 = -
ENODATA
;

708 
	`mem˝y
(
vÆue_À
, 
	`ñemít_©
(
öfo
, 
ab
, 
íåy
),

709 
öfo
->
vÆue_ty≥
.
size
);

711 
	`u∆ock_ablock
(
öfo
, 
block
);

712  
r
;

713 
	}
}

714 
EXPORT_SYMBOL_GPL
(
dm_¨øy_gë_vÆue
);

716 
	$¨øy_£t_vÆue
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

717 
uöt32_t
 
ödex
, c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

719 
r
;

720 
dm_block
 *
block
;

721 
¨øy_block
 *
ab
;

722 
size_t
 
size_of_block
;

723 
max_íåõs
;

724 
íåy
;

725 *
ﬁd_vÆue
;

726 
dm_båì_vÆue_ty≥
 *
vt
 = &
öfo
->
vÆue_ty≥
;

728 
size_of_block
 = 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
öfo
->
båì_öfo
.
tm
));

729 
max_íåõs
 = 
	`ˇlc_max_íåõs
(
öfo
->
vÆue_ty≥
.
size
, 
size_of_block
);

731 
r
 = 
	`shadow_ablock
(
öfo
, &
roŸ
, 
ödex
 / 
max_íåõs
, &
block
, &
ab
);

732 i‡(
r
)

733  
r
;

734 *
√w_roŸ
 = 
roŸ
;

736 
íåy
 = 
ödex
 % 
max_íåõs
;

737 i‡(
íåy
 >
	`À32_to_˝u
(
ab
->
ƒ_íåõs
)) {

738 
r
 = -
ENODATA
;

739 
out
;

742 
ﬁd_vÆue
 = 
	`ñemít_©
(
öfo
, 
ab
, 
íåy
);

743 i‡(
vt
->
dec
 &&

744 (!
vt
->
equÆ
 || !vt->
	`equÆ
(vt->
c⁄ãxt
, 
ﬁd_vÆue
, 
vÆue
))) {

745 
vt
->
	`dec
(vt->
c⁄ãxt
, 
ﬁd_vÆue
);

746 i‡(
vt
->
öc
)

747 
vt
->
	`öc
(vt->
c⁄ãxt
, 
vÆue
);

750 
	`mem˝y
(
ﬁd_vÆue
, 
vÆue
, 
öfo
->
vÆue_ty≥
.
size
);

752 
out
:

753 
	`u∆ock_ablock
(
öfo
, 
block
);

754  
r
;

755 
	}
}

757 
	$dm_¨øy_£t_vÆue
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

758 
uöt32_t
 
ödex
, c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

759 
	$__dm_wrôãn_to_disk
(
vÆue
)

761 
r
;

763 
r
 = 
	`¨øy_£t_vÆue
(
öfo
, 
roŸ
, 
ödex
, 
vÆue
, 
√w_roŸ
);

764 
	`__dm_unbÀss_f‹_disk
(
vÆue
);

765  
r
;

766 
	}
}

767 
EXPORT_SYMBOL_GPL
(
dm_¨øy_£t_vÆue
);

769 
	swÆk_öfo
 {

770 
dm_¨øy_öfo
 *
	möfo
;

771 (*
	m‚
)(*
	mc⁄ãxt
, 
uöt64_t
 
	mkey
, *
	mÀaf
);

772 *
	mc⁄ãxt
;

775 
	$wÆk_ablock
(*
c⁄ãxt
, 
uöt64_t
 *
keys
, *
Àaf
)

777 
wÆk_öfo
 *
wi
 = 
c⁄ãxt
;

779 
r
;

780 
i
;

781 
__À64
 
block_À
;

782 
ƒ_íåõs
, 
max_íåõs
;

783 
dm_block
 *
block
;

784 
¨øy_block
 *
ab
;

786 
	`mem˝y
(&
block_À
, 
Àaf
, (block_le));

787 
r
 = 
	`gë_ablock
(
wi
->
öfo
, 
	`À64_to_˝u
(
block_À
), &
block
, &
ab
);

788 i‡(
r
)

789  
r
;

791 
max_íåõs
 = 
	`À32_to_˝u
(
ab
->max_entries);

792 
ƒ_íåõs
 = 
	`À32_to_˝u
(
ab
->nr_entries);

793 
i
 = 0; i < 
ƒ_íåõs
; i++) {

794 
r
 = 
wi
->
	`‚
(wi->
c⁄ãxt
, 
keys
[0] * 
max_íåõs
 + 
i
,

795 
	`ñemít_©
(
wi
->
öfo
, 
ab
, 
i
));

797 i‡(
r
)

801 
	`u∆ock_ablock
(
wi
->
öfo
, 
block
);

802  
r
;

803 
	}
}

805 
dm_¨øy_wÆk
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

806 (*
‚
)(*, 
uöt64_t
 
key
, *
Àaf
),

807 *
c⁄ãxt
)

809 
wÆk_öfo
 
wi
;

811 
wi
.
öfo
 = info;

812 
wi
.
‚
 = fn;

813 
wi
.
c⁄ãxt
 = context;

815  
	`dm_båì_wÆk
(&
öfo
->
båì_öfo
, 
roŸ
, 
wÆk_ablock
, &
wi
);

816 
	}
}

817 
EXPORT_SYMBOL_GPL
(
dm_¨øy_wÆk
);

	@persistent-data/dm-array.h

6 #i‚de‡
_LINUX_DM_ARRAY_H


7 
	#_LINUX_DM_ARRAY_H


	)

9 
	~"dm-båì.h
"

68 
	sdm_¨øy_öfo
 {

69 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

70 
dm_båì_vÆue_ty≥
 
	mvÆue_ty≥
;

71 
dm_båì_öfo
 
	mbåì_öfo
;

82 
dm_¨øy_öfo_öô
(
dm_¨øy_öfo
 *
öfo
,

83 
dm_å™ß˘i⁄_m™agî
 *
tm
,

84 
dm_båì_vÆue_ty≥
 *
vt
);

92 
dm_¨øy_em±y
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 *
roŸ
);

109 
	$dm_¨øy_ªsize
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

110 
uöt32_t
 
ﬁd_size
, uöt32_à
√w_size
,

111 c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

112 
	`__dm_wrôãn_to_disk
(
vÆue
);

118 
	`dm_¨øy_dñ
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
);

130 
	`dm_¨øy_gë_vÆue
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

131 
uöt32_t
 
ödex
, *
vÆue
);

148 
	$dm_¨øy_£t_vÆue
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

149 
uöt32_t
 
ödex
, c⁄° *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

150 
	`__dm_wrôãn_to_disk
(
vÆue
);

160 
	`dm_¨øy_wÆk
(
dm_¨øy_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

161 (*
‚
)(*
c⁄ãxt
, 
uöt64_t
 
key
, *
Àaf
),

162 *
c⁄ãxt
);

	@persistent-data/dm-bitset.c

7 
	~"dm-bô£t.h
"

8 
	~"dm-å™ß˘i⁄-m™agî.h
"

10 
	~<löux/exp‹t.h
>

11 
	~<löux/devi˚-m≠≥r.h
>

13 
	#DM_MSG_PREFIX
 "bô£t"

	)

14 
	#BITS_PER_ARRAY_ENTRY
 64

	)

18 
dm_båì_vÆue_ty≥
 
	gbô£t_bvt
 = {

19 .
c⁄ãxt
 = 
NULL
,

20 .
	gsize
 = (
__À64
),

21 .
	göc
 = 
NULL
,

22 .
	gdec
 = 
NULL
,

23 .
	gequÆ
 = 
NULL
,

28 
	$dm_disk_bô£t_öô
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

29 
dm_disk_bô£t
 *
öfo
)

31 
	`dm_¨øy_öfo_öô
(&
öfo
->
¨øy_öfo
, 
tm
, &
bô£t_bvt
);

32 
öfo
->
cuºít_ödex_£t
 = 
Ál£
;

33 
	}
}

34 
EXPORT_SYMBOL_GPL
(
dm_disk_bô£t_öô
);

36 
	$dm_bô£t_em±y
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 *
roŸ
)

38  
	`dm_¨øy_em±y
(&
öfo
->
¨øy_öfo
, 
roŸ
);

39 
	}
}

40 
EXPORT_SYMBOL_GPL
(
dm_bô£t_em±y
);

42 
	$dm_bô£t_ªsize
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

43 
uöt32_t
 
ﬁd_ƒ_íåõs
, uöt32_à
√w_ƒ_íåõs
,

44 
boﬁ
 
deÁu…_vÆue
, 
dm_block_t
 *
√w_roŸ
)

46 
uöt32_t
 
ﬁd_blocks
 = 
	`dm_div_up
(
ﬁd_ƒ_íåõs
, 
BITS_PER_ARRAY_ENTRY
);

47 
uöt32_t
 
√w_blocks
 = 
	`dm_div_up
(
√w_ƒ_íåõs
, 
BITS_PER_ARRAY_ENTRY
);

48 
__À64
 
vÆue
 = 
deÁu…_vÆue
 ? 
	`˝u_to_À64
(~0) : cpu_to_le64(0);

50 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

51  
	`dm_¨øy_ªsize
(&
öfo
->
¨øy_öfo
, 
roŸ
, 
ﬁd_blocks
, 
√w_blocks
,

52 &
vÆue
, 
√w_roŸ
);

53 
	}
}

54 
EXPORT_SYMBOL_GPL
(
dm_bô£t_ªsize
);

56 
	$dm_bô£t_dñ
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
)

58  
	`dm_¨øy_dñ
(&
öfo
->
¨øy_öfo
, 
roŸ
);

59 
	}
}

60 
EXPORT_SYMBOL_GPL
(
dm_bô£t_dñ
);

62 
	$dm_bô£t_Êush
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

63 
dm_block_t
 *
√w_roŸ
)

65 
r
;

66 
__À64
 
vÆue
;

68 i‡(!
öfo
->
cuºít_ödex_£t
 || !öfo->
dúty
)

71 
vÆue
 = 
	`˝u_to_À64
(
öfo
->
cuºít_bôs
);

73 
	`__dm_bÀss_f‹_disk
(&
vÆue
);

74 
r
 = 
	`dm_¨øy_£t_vÆue
(&
öfo
->
¨øy_öfo
, 
roŸ
, info->
cuºít_ödex
,

75 &
vÆue
, 
√w_roŸ
);

76 i‡(
r
)

77  
r
;

79 
öfo
->
cuºít_ödex_£t
 = 
Ál£
;

80 
öfo
->
dúty
 = 
Ál£
;

83 
	}
}

84 
EXPORT_SYMBOL_GPL
(
dm_bô£t_Êush
);

86 
	$ªad_bôs
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

87 
uöt32_t
 
¨øy_ödex
)

89 
r
;

90 
__À64
 
vÆue
;

92 
r
 = 
	`dm_¨øy_gë_vÆue
(&
öfo
->
¨øy_öfo
, 
roŸ
, 
¨øy_ödex
, &
vÆue
);

93 i‡(
r
)

94  
r
;

96 
öfo
->
cuºít_bôs
 = 
	`À64_to_˝u
(
vÆue
);

97 
öfo
->
cuºít_ödex_£t
 = 
åue
;

98 
öfo
->
cuºít_ödex
 = 
¨øy_ödex
;

99 
öfo
->
dúty
 = 
Ál£
;

102 
	}
}

104 
	$gë_¨øy_íåy
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

105 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
)

107 
r
;

108 
¨øy_ödex
 = 
ödex
 / 
BITS_PER_ARRAY_ENTRY
;

110 i‡(
öfo
->
cuºít_ödex_£t
) {

111 i‡(
öfo
->
cuºít_ödex
 =
¨øy_ödex
)

114 
r
 = 
	`dm_bô£t_Êush
(
öfo
, 
roŸ
, 
√w_roŸ
);

115 i‡(
r
)

116  
r
;

119  
	`ªad_bôs
(
öfo
, 
roŸ
, 
¨øy_ödex
);

120 
	}
}

122 
	$dm_bô£t_£t_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

123 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
)

125 
r
;

126 
b
 = 
ödex
 % 
BITS_PER_ARRAY_ENTRY
;

128 
r
 = 
	`gë_¨øy_íåy
(
öfo
, 
roŸ
, 
ödex
, 
√w_roŸ
);

129 i‡(
r
)

130  
r
;

132 
	`£t_bô
(
b
, (*Ë&
öfo
->
cuºít_bôs
);

133 
öfo
->
dúty
 = 
åue
;

136 
	}
}

137 
EXPORT_SYMBOL_GPL
(
dm_bô£t_£t_bô
);

139 
	$dm_bô£t_˛ór_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

140 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
)

142 
r
;

143 
b
 = 
ödex
 % 
BITS_PER_ARRAY_ENTRY
;

145 
r
 = 
	`gë_¨øy_íåy
(
öfo
, 
roŸ
, 
ödex
, 
√w_roŸ
);

146 i‡(
r
)

147  
r
;

149 
	`˛ór_bô
(
b
, (*Ë&
öfo
->
cuºít_bôs
);

150 
öfo
->
dúty
 = 
åue
;

153 
	}
}

154 
EXPORT_SYMBOL_GPL
(
dm_bô£t_˛ór_bô
);

156 
	$dm_bô£t_ã°_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

157 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
, 
boﬁ
 *
ªsu…
)

159 
r
;

160 
b
 = 
ödex
 % 
BITS_PER_ARRAY_ENTRY
;

162 
r
 = 
	`gë_¨øy_íåy
(
öfo
, 
roŸ
, 
ödex
, 
√w_roŸ
);

163 i‡(
r
)

164  
r
;

166 *
ªsu…
 = 
	`ã°_bô
(
b
, (*Ë&
öfo
->
cuºít_bôs
);

168 
	}
}

169 
EXPORT_SYMBOL_GPL
(
dm_bô£t_ã°_bô
);

	@persistent-data/dm-bitset.h

6 #i‚de‡
_LINUX_DM_BITSET_H


7 
	#_LINUX_DM_BITSET_H


	)

9 
	~"dm-¨øy.h
"

67 
	sdm_disk_bô£t
 {

68 
dm_¨øy_öfo
 
	m¨øy_öfo
;

70 
uöt32_t
 
	mcuºít_ödex
;

71 
uöt64_t
 
	mcuºít_bôs
;

73 
boﬁ
 
	mcuºít_ödex_£t
:1;

74 
boﬁ
 
	mdúty
:1;

84 
dm_disk_bô£t_öô
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

85 
dm_disk_bô£t
 *
öfo
);

93 
dm_bô£t_em±y
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 *
√w_roŸ
);

105 
dm_bô£t_ªsize
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
ﬁd_roŸ
,

106 
uöt32_t
 
ﬁd_ƒ_íåõs
, uöt32_à
√w_ƒ_íåõs
,

107 
boﬁ
 
deÁu…_vÆue
, 
dm_block_t
 *
√w_roŸ
);

112 
dm_bô£t_dñ
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
);

124 
dm_bô£t_£t_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

125 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
);

137 
dm_bô£t_˛ór_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

138 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
);

151 
dm_bô£t_ã°_bô
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

152 
uöt32_t
 
ödex
, 
dm_block_t
 *
√w_roŸ
, 
boﬁ
 *
ªsu…
);

161 
dm_bô£t_Êush
(
dm_disk_bô£t
 *
öfo
, 
dm_block_t
 
roŸ
,

162 
dm_block_t
 *
√w_roŸ
);

	@persistent-data/dm-block-manager.c

6 
	~"dm-block-m™agî.h
"

7 
	~"dm-≥rsi°ít-d©a-öã∫Æ.h
"

8 
	~"../dm-bufio.h
"

10 
	~<löux/¸c32c.h
>

11 
	~<löux/moduÀ.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/rw£m.h
>

14 
	~<löux/devi˚-m≠≥r.h
>

15 
	~<löux/°ackåa˚.h
>

17 
	#DM_MSG_PREFIX
 "block m™agî"

	)

32 
	#MAX_HOLDERS
 4

	)

33 
	#MAX_STACK
 10

	)

35 
	t°ack_íåõs
[
MAX_STACK
];

37 
	sblock_lock
 {

38 
•ölock_t
 
	mlock
;

39 
__s32
 
	mcou¡
;

40 
li°_hód
 
	mwaôîs
;

41 
èsk_°ru˘
 *
	mhﬁdîs
[
MAX_HOLDERS
];

43 #ifde‡
CONFIG_DM_DEBUG_BLOCK_STACK_TRACING


44 
°ack_åa˚
 
	måa˚s
[
MAX_HOLDERS
];

45 
°ack_íåõs
 
	míåõs
[
MAX_HOLDERS
];

49 
	swaôî
 {

50 
li°_hód
 
	mli°
;

51 
èsk_°ru˘
 *
	mèsk
;

52 
	mw™ts_wrôe
;

55 
	$__föd_hﬁdî
(
block_lock
 *
lock
,

56 
èsk_°ru˘
 *
èsk
)

58 
i
;

60 
i
 = 0; i < 
MAX_HOLDERS
; i++)

61 i‡(
lock
->
hﬁdîs
[
i
] =
èsk
)

64 
	`BUG_ON
(
i
 =
MAX_HOLDERS
);

65  
i
;

66 
	}
}

69 
	$__add_hﬁdî
(
block_lock
 *
lock
, 
èsk_°ru˘
 *
èsk
)

71 
h
 = 
	`__föd_hﬁdî
(
lock
, 
NULL
);

72 #ifde‡
CONFIG_DM_DEBUG_BLOCK_STACK_TRACING


73 
°ack_åa˚
 *
t
;

76 
	`gë_èsk_°ru˘
(
èsk
);

77 
lock
->
hﬁdîs
[
h
] = 
èsk
;

79 #ifde‡
CONFIG_DM_DEBUG_BLOCK_STACK_TRACING


80 
t
 = 
lock
->
åa˚s
 + 
h
;

81 
t
->
ƒ_íåõs
 = 0;

82 
t
->
max_íåõs
 = 
MAX_STACK
;

83 
t
->
íåõs
 = 
lock
->íåõs[
h
];

84 
t
->
skù
 = 2;

85 
	`ßve_°ack_åa˚
(
t
);

87 
	}
}

90 
	$__dñ_hﬁdî
(
block_lock
 *
lock
, 
èsk_°ru˘
 *
èsk
)

92 
h
 = 
	`__föd_hﬁdî
(
lock
, 
èsk
);

93 
lock
->
hﬁdîs
[
h
] = 
NULL
;

94 
	`put_èsk_°ru˘
(
èsk
);

95 
	}
}

97 
	$__check_hﬁdî
(
block_lock
 *
lock
)

99 
i
;

100 #ifde‡
CONFIG_DM_DEBUG_BLOCK_STACK_TRACING


101 
°ack_åa˚
 
t
;

102 
°ack_íåõs
 
íåõs
;

105 
i
 = 0; i < 
MAX_HOLDERS
; i++) {

106 i‡(
lock
->
hﬁdîs
[
i
] =
cuºít
) {

107 
	`DMERR
("recursiveÜock detected in metadata");

108 #ifde‡
CONFIG_DM_DEBUG_BLOCK_STACK_TRACING


109 
	`DMERR
("previously held here:");

110 
	`¥öt_°ack_åa˚
(
lock
->
åa˚s
 + 
i
, 4);

112 
	`DMERR
("subsequentácquisitionáttempted here:");

113 
t
.
ƒ_íåõs
 = 0;

114 
t
.
max_íåõs
 = 
MAX_STACK
;

115 
t
.
íåõs
 =Éntries;

116 
t
.
skù
 = 3;

117 
	`ßve_°ack_åa˚
(&
t
);

118 
	`¥öt_°ack_åa˚
(&
t
, 4);

120  -
EINVAL
;

125 
	}
}

127 
	$__waô
(
waôî
 *
w
)

130 
	`£t_èsk_°©e
(
cuºít
, 
TASK_UNINTERRUPTIBLE
);

132 i‡(!
w
->
èsk
)

135 
	`scheduÀ
();

138 
	`£t_èsk_°©e
(
cuºít
, 
TASK_RUNNING
);

139 
	}
}

141 
	$__wake_waôî
(
waôî
 *
w
)

143 
èsk_°ru˘
 *
èsk
;

145 
	`li°_dñ
(&
w
->
li°
);

146 
èsk
 = 
w
->task;

147 
	`smp_mb
();

148 
w
->
èsk
 = 
NULL
;

149 
	`wake_up_¥o˚ss
(
èsk
);

150 
	}
}

155 
	$__wake_m™y
(
block_lock
 *
lock
)

157 
waôî
 *
w
, *
tmp
;

159 
	`BUG_ON
(
lock
->
cou¡
 < 0);

160 
	`li°_f‹_óch_íåy_ß„
(
w
, 
tmp
, &
lock
->
waôîs
, 
li°
) {

161 i‡(
lock
->
cou¡
 >
MAX_HOLDERS
)

164 i‡(
w
->
w™ts_wrôe
) {

165 i‡(
lock
->
cou¡
 > 0)

168 
lock
->
cou¡
 = -1;

169 
	`__add_hﬁdî
(
lock
, 
w
->
èsk
);

170 
	`__wake_waôî
(
w
);

174 
lock
->
cou¡
++;

175 
	`__add_hﬁdî
(
lock
, 
w
->
èsk
);

176 
	`__wake_waôî
(
w
);

178 
	}
}

180 
	$bl_öô
(
block_lock
 *
lock
)

182 
i
;

184 
	`•ö_lock_öô
(&
lock
->lock);

185 
lock
->
cou¡
 = 0;

186 
	`INIT_LIST_HEAD
(&
lock
->
waôîs
);

187 
i
 = 0; i < 
MAX_HOLDERS
; i++)

188 
lock
->
hﬁdîs
[
i
] = 
NULL
;

189 
	}
}

191 
	$__avaûabÀ_f‹_ªad
(
block_lock
 *
lock
)

193  
lock
->
cou¡
 >= 0 &&

194 
lock
->
cou¡
 < 
MAX_HOLDERS
 &&

195 
	`li°_em±y
(&
lock
->
waôîs
);

196 
	}
}

198 
	$bl_down_ªad
(
block_lock
 *
lock
)

200 
r
;

201 
waôî
 
w
;

203 
	`•ö_lock
(&
lock
->lock);

204 
r
 = 
	`__check_hﬁdî
(
lock
);

205 i‡(
r
) {

206 
	`•ö_u∆ock
(&
lock
->lock);

207  
r
;

210 i‡(
	`__avaûabÀ_f‹_ªad
(
lock
)) {

211 
lock
->
cou¡
++;

212 
	`__add_hﬁdî
(
lock
, 
cuºít
);

213 
	`•ö_u∆ock
(&
lock
->lock);

217 
	`gë_èsk_°ru˘
(
cuºít
);

219 
w
.
èsk
 = 
cuºít
;

220 
w
.
w™ts_wrôe
 = 0;

221 
	`li°_add_èû
(&
w
.
li°
, &
lock
->
waôîs
);

222 
	`•ö_u∆ock
(&
lock
->lock);

224 
	`__waô
(&
w
);

225 
	`put_èsk_°ru˘
(
cuºít
);

227 
	}
}

229 
	$bl_down_ªad_n⁄block
(
block_lock
 *
lock
)

231 
r
;

233 
	`•ö_lock
(&
lock
->lock);

234 
r
 = 
	`__check_hﬁdî
(
lock
);

235 i‡(
r
)

236 
out
;

238 i‡(
	`__avaûabÀ_f‹_ªad
(
lock
)) {

239 
lock
->
cou¡
++;

240 
	`__add_hﬁdî
(
lock
, 
cuºít
);

241 
r
 = 0;

243 
r
 = -
EWOULDBLOCK
;

245 
out
:

246 
	`•ö_u∆ock
(&
lock
->lock);

247  
r
;

248 
	}
}

250 
	$bl_up_ªad
(
block_lock
 *
lock
)

252 
	`•ö_lock
(&
lock
->lock);

253 
	`BUG_ON
(
lock
->
cou¡
 <= 0);

254 
	`__dñ_hﬁdî
(
lock
, 
cuºít
);

255 --
lock
->
cou¡
;

256 i‡(!
	`li°_em±y
(&
lock
->
waôîs
))

257 
	`__wake_m™y
(
lock
);

258 
	`•ö_u∆ock
(&
lock
->lock);

259 
	}
}

261 
	$bl_down_wrôe
(
block_lock
 *
lock
)

263 
r
;

264 
waôî
 
w
;

266 
	`•ö_lock
(&
lock
->lock);

267 
r
 = 
	`__check_hﬁdî
(
lock
);

268 i‡(
r
) {

269 
	`•ö_u∆ock
(&
lock
->lock);

270  
r
;

273 i‡(
lock
->
cou¡
 =0 && 
	`li°_em±y
(&lock->
waôîs
)) {

274 
lock
->
cou¡
 = -1;

275 
	`__add_hﬁdî
(
lock
, 
cuºít
);

276 
	`•ö_u∆ock
(&
lock
->lock);

280 
	`gë_èsk_°ru˘
(
cuºít
);

281 
w
.
èsk
 = 
cuºít
;

282 
w
.
w™ts_wrôe
 = 1;

288 
	`li°_add
(&
w
.
li°
, &
lock
->
waôîs
);

289 
	`•ö_u∆ock
(&
lock
->lock);

291 
	`__waô
(&
w
);

292 
	`put_èsk_°ru˘
(
cuºít
);

295 
	}
}

297 
	$bl_up_wrôe
(
block_lock
 *
lock
)

299 
	`•ö_lock
(&
lock
->lock);

300 
	`__dñ_hﬁdî
(
lock
, 
cuºít
);

301 
lock
->
cou¡
 = 0;

302 i‡(!
	`li°_em±y
(&
lock
->
waôîs
))

303 
	`__wake_m™y
(
lock
);

304 
	`•ö_u∆ock
(&
lock
->lock);

305 
	}
}

307 
	$ªp‹t_ªcursive_bug
(
dm_block_t
 
b
, 
r
)

309 i‡(
r
 =-
EINVAL
)

310 
	`DMERR
("recursiveácquisition of block %lluÑequested.",

311 (Ë
b
);

312 
	}
}

323 
dm_buf„r
 *
	$to_buf„r
(
dm_block
 *
b
)

325  (
dm_buf„r
 *Ë
b
;

326 
	}
}

328 
dm_block_t
 
	$dm_block_loˇti⁄
(
dm_block
 *
b
)

330  
	`dm_bufio_gë_block_numbî
(
	`to_buf„r
(
b
));

331 
	}
}

332 
EXPORT_SYMBOL_GPL
(
dm_block_loˇti⁄
);

334 *
	$dm_block_d©a
(
dm_block
 *
b
)

336  
	`dm_bufio_gë_block_d©a
(
	`to_buf„r
(
b
));

337 
	}
}

338 
EXPORT_SYMBOL_GPL
(
dm_block_d©a
);

340 
	sbuf„r_aux
 {

341 
dm_block_vÆid©‹
 *
	mvÆid©‹
;

342 
block_lock
 
	mlock
;

343 
	mwrôe_locked
;

346 
	$dm_block_m™agî_Æloc_ˇŒback
(
dm_buf„r
 *
buf
)

348 
buf„r_aux
 *
aux
 = 
	`dm_bufio_gë_aux_d©a
(
buf
);

349 
aux
->
vÆid©‹
 = 
NULL
;

350 
	`bl_öô
(&
aux
->
lock
);

351 
	}
}

353 
	$dm_block_m™agî_wrôe_ˇŒback
(
dm_buf„r
 *
buf
)

355 
buf„r_aux
 *
aux
 = 
	`dm_bufio_gë_aux_d©a
(
buf
);

356 i‡(
aux
->
vÆid©‹
) {

357 
aux
->
vÆid©‹
->
	`¥ï¨e_f‹_wrôe
◊ux->vÆid©‹, (
dm_block
 *Ë
buf
,

358 
	`dm_bufio_gë_block_size
(
	`dm_bufio_gë_˛õ¡
(
buf
)));

360 
	}
}

365 
	sdm_block_m™agî
 {

366 
dm_bufio_˛õ¡
 *
	mbufio
;

367 
boﬁ
 
	mªad_⁄ly
:1;

370 
dm_block_m™agî
 *
	$dm_block_m™agî_¸óã
(
block_devi˚
 *
bdev
,

371 
block_size
,

372 
ˇche_size
,

373 
max_hñd_≥r_thªad
)

375 
r
;

376 
dm_block_m™agî
 *
bm
;

378 
bm
 = 
	`kmÆloc
((*bm), 
GFP_KERNEL
);

379 i‡(!
bm
) {

380 
r
 = -
ENOMEM
;

381 
bad
;

384 
bm
->
bufio
 = 
	`dm_bufio_˛õ¡_¸óã
(
bdev
, 
block_size
, 
max_hñd_≥r_thªad
,

385 (
buf„r_aux
),

386 
dm_block_m™agî_Æloc_ˇŒback
,

387 
dm_block_m™agî_wrôe_ˇŒback
);

388 i‡(
	`IS_ERR
(
bm
->
bufio
)) {

389 
r
 = 
	`PTR_ERR
(
bm
->
bufio
);

390 
	`k‰ì
(
bm
);

391 
bad
;

394 
bm
->
ªad_⁄ly
 = 
Ál£
;

396  
bm
;

398 
bad
:

399  
	`ERR_PTR
(
r
);

400 
	}
}

401 
EXPORT_SYMBOL_GPL
(
dm_block_m™agî_¸óã
);

403 
	$dm_block_m™agî_de°roy
(
dm_block_m™agî
 *
bm
)

405 
	`dm_bufio_˛õ¡_de°roy
(
bm
->
bufio
);

406 
	`k‰ì
(
bm
);

407 
	}
}

408 
EXPORT_SYMBOL_GPL
(
dm_block_m™agî_de°roy
);

410 
	$dm_bm_block_size
(
dm_block_m™agî
 *
bm
)

412  
	`dm_bufio_gë_block_size
(
bm
->
bufio
);

413 
	}
}

414 
EXPORT_SYMBOL_GPL
(
dm_bm_block_size
);

416 
dm_block_t
 
	$dm_bm_ƒ_blocks
(
dm_block_m™agî
 *
bm
)

418  
	`dm_bufio_gë_devi˚_size
(
bm
->
bufio
);

419 
	}
}

421 
	$dm_bm_vÆid©e_buf„r
(
dm_block_m™agî
 *
bm
,

422 
dm_buf„r
 *
buf
,

423 
buf„r_aux
 *
aux
,

424 
dm_block_vÆid©‹
 *
v
)

426 i‡(
	`u∆ikñy
(!
aux
->
vÆid©‹
)) {

427 
r
;

428 i‡(!
v
)

430 
r
 = 
v
->
	`check
(v, (
dm_block
 *Ë
buf
, 
	`dm_bufio_gë_block_size
(
bm
->
bufio
));

431 i‡(
	`u∆ikñy
(
r
)) {

432 
	`DMERR_LIMIT
("%†vÆid©‹ check faûed f‹ block %Œu", 
v
->
«me
,

433 (Ë
	`dm_bufio_gë_block_numbî
(
buf
));

434  
r
;

436 
aux
->
vÆid©‹
 = 
v
;

438 i‡(
	`u∆ikñy
(
aux
->
vÆid©‹
 !
v
)) {

439 
	`DMERR_LIMIT
("validator mismatch (old=%s vsÇew=%s) for block %llu",

440 
aux
->
vÆid©‹
->
«me
, 
v
 ? v->name : "NULL",

441 (Ë
	`dm_bufio_gë_block_numbî
(
buf
));

442  -
EINVAL
;

447 
	}
}

448 
	$dm_bm_ªad_lock
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
,

449 
dm_block_vÆid©‹
 *
v
,

450 
dm_block
 **
ªsu…
)

452 
buf„r_aux
 *
aux
;

453 *
p
;

454 
r
;

456 
p
 = 
	`dm_bufio_ªad
(
bm
->
bufio
, 
b
, (
dm_buf„r
 **Ë
ªsu…
);

457 i‡(
	`u∆ikñy
(
	`IS_ERR
(
p
)))

458  
	`PTR_ERR
(
p
);

460 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
	`to_buf„r
(*
ªsu…
));

461 
r
 = 
	`bl_down_ªad
(&
aux
->
lock
);

462 i‡(
	`u∆ikñy
(
r
)) {

463 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

464 
	`ªp‹t_ªcursive_bug
(
b
, 
r
);

465  
r
;

468 
aux
->
wrôe_locked
 = 0;

470 
r
 = 
	`dm_bm_vÆid©e_buf„r
(
bm
, 
	`to_buf„r
(*
ªsu…
), 
aux
, 
v
);

471 i‡(
	`u∆ikñy
(
r
)) {

472 
	`bl_up_ªad
(&
aux
->
lock
);

473 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

474  
r
;

478 
	}
}

479 
EXPORT_SYMBOL_GPL
(
dm_bm_ªad_lock
);

481 
	$dm_bm_wrôe_lock
(
dm_block_m™agî
 *
bm
,

482 
dm_block_t
 
b
, 
dm_block_vÆid©‹
 *
v
,

483 
dm_block
 **
ªsu…
)

485 
buf„r_aux
 *
aux
;

486 *
p
;

487 
r
;

489 i‡(
bm
->
ªad_⁄ly
)

490  -
EPERM
;

492 
p
 = 
	`dm_bufio_ªad
(
bm
->
bufio
, 
b
, (
dm_buf„r
 **Ë
ªsu…
);

493 i‡(
	`u∆ikñy
(
	`IS_ERR
(
p
)))

494  
	`PTR_ERR
(
p
);

496 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
	`to_buf„r
(*
ªsu…
));

497 
r
 = 
	`bl_down_wrôe
(&
aux
->
lock
);

498 i‡(
r
) {

499 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

500 
	`ªp‹t_ªcursive_bug
(
b
, 
r
);

501  
r
;

504 
aux
->
wrôe_locked
 = 1;

506 
r
 = 
	`dm_bm_vÆid©e_buf„r
(
bm
, 
	`to_buf„r
(*
ªsu…
), 
aux
, 
v
);

507 i‡(
	`u∆ikñy
(
r
)) {

508 
	`bl_up_wrôe
(&
aux
->
lock
);

509 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

510  
r
;

514 
	}
}

515 
EXPORT_SYMBOL_GPL
(
dm_bm_wrôe_lock
);

517 
	$dm_bm_ªad_åy_lock
(
dm_block_m™agî
 *
bm
,

518 
dm_block_t
 
b
, 
dm_block_vÆid©‹
 *
v
,

519 
dm_block
 **
ªsu…
)

521 
buf„r_aux
 *
aux
;

522 *
p
;

523 
r
;

525 
p
 = 
	`dm_bufio_gë
(
bm
->
bufio
, 
b
, (
dm_buf„r
 **Ë
ªsu…
);

526 i‡(
	`u∆ikñy
(
	`IS_ERR
(
p
)))

527  
	`PTR_ERR
(
p
);

528 i‡(
	`u∆ikñy
(!
p
))

529  -
EWOULDBLOCK
;

531 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
	`to_buf„r
(*
ªsu…
));

532 
r
 = 
	`bl_down_ªad_n⁄block
(&
aux
->
lock
);

533 i‡(
r
 < 0) {

534 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

535 
	`ªp‹t_ªcursive_bug
(
b
, 
r
);

536  
r
;

538 
aux
->
wrôe_locked
 = 0;

540 
r
 = 
	`dm_bm_vÆid©e_buf„r
(
bm
, 
	`to_buf„r
(*
ªsu…
), 
aux
, 
v
);

541 i‡(
	`u∆ikñy
(
r
)) {

542 
	`bl_up_ªad
(&
aux
->
lock
);

543 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

544  
r
;

548 
	}
}

550 
	$dm_bm_wrôe_lock_zîo
(
dm_block_m™agî
 *
bm
,

551 
dm_block_t
 
b
, 
dm_block_vÆid©‹
 *
v
,

552 
dm_block
 **
ªsu…
)

554 
r
;

555 
buf„r_aux
 *
aux
;

556 *
p
;

558 i‡(
bm
->
ªad_⁄ly
)

559  -
EPERM
;

561 
p
 = 
	`dm_bufio_√w
(
bm
->
bufio
, 
b
, (
dm_buf„r
 **Ë
ªsu…
);

562 i‡(
	`u∆ikñy
(
	`IS_ERR
(
p
)))

563  
	`PTR_ERR
(
p
);

565 
	`mem£t
(
p
, 0, 
	`dm_bm_block_size
(
bm
));

567 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
	`to_buf„r
(*
ªsu…
));

568 
r
 = 
	`bl_down_wrôe
(&
aux
->
lock
);

569 i‡(
r
) {

570 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(*
ªsu…
));

571  
r
;

574 
aux
->
wrôe_locked
 = 1;

575 
aux
->
vÆid©‹
 = 
v
;

578 
	}
}

579 
EXPORT_SYMBOL_GPL
(
dm_bm_wrôe_lock_zîo
);

581 
	$dm_bm_u∆ock
(
dm_block
 *
b
)

583 
buf„r_aux
 *
aux
;

584 
aux
 = 
	`dm_bufio_gë_aux_d©a
(
	`to_buf„r
(
b
));

586 i‡(
aux
->
wrôe_locked
) {

587 
	`dm_bufio_m¨k_buf„r_dúty
(
	`to_buf„r
(
b
));

588 
	`bl_up_wrôe
(&
aux
->
lock
);

590 
	`bl_up_ªad
(&
aux
->
lock
);

592 
	`dm_bufio_ªÀa£
(
	`to_buf„r
(
b
));

595 
	}
}

596 
EXPORT_SYMBOL_GPL
(
dm_bm_u∆ock
);

598 
	$dm_bm_Êush
(
dm_block_m™agî
 *
bm
)

600 i‡(
bm
->
ªad_⁄ly
)

601  -
EPERM
;

603  
	`dm_bufio_wrôe_dúty_buf„rs
(
bm
->
bufio
);

604 
	}
}

605 
EXPORT_SYMBOL_GPL
(
dm_bm_Êush
);

607 
	$dm_bm_¥e„tch
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
)

609 
	`dm_bufio_¥e„tch
(
bm
->
bufio
, 
b
, 1);

610 
	}
}

612 
	$dm_bm_£t_ªad_⁄ly
(
dm_block_m™agî
 *
bm
)

614 
bm
->
ªad_⁄ly
 = 
åue
;

615 
	}
}

616 
EXPORT_SYMBOL_GPL
(
dm_bm_£t_ªad_⁄ly
);

618 
	$dm_bm_£t_ªad_wrôe
(
dm_block_m™agî
 *
bm
)

620 
bm
->
ªad_⁄ly
 = 
Ál£
;

621 
	}
}

622 
EXPORT_SYMBOL_GPL
(
dm_bm_£t_ªad_wrôe
);

624 
u32
 
	$dm_bm_checksum
(c⁄° *
d©a
, 
size_t
 
Àn
, 
u32
 
öô_x‹
)

626  
	`¸c32c
(~(
u32
Ë0, 
d©a
, 
Àn
Ë^ 
öô_x‹
;

627 
	}
}

628 
EXPORT_SYMBOL_GPL
(
dm_bm_checksum
);

632 
MODULE_LICENSE
("GPL");

633 
MODULE_AUTHOR
("Joe Thornber <dm-devel@redhat.com>");

634 
MODULE_DESCRIPTION
("Immutable metadataÜibrary for dm");

	@persistent-data/dm-block-manager.h

7 #i‚de‡
_LINUX_DM_BLOCK_MANAGER_H


8 
	#_LINUX_DM_BLOCK_MANAGER_H


	)

10 
	~<löux/ty≥s.h
>

11 
	~<löux/blkdev.h
>

18 
uöt64_t
 
	tdm_block_t
;

19 
	gdm_block
;

21 
dm_block_t
 
dm_block_loˇti⁄
(
dm_block
 *
b
);

22 *
dm_block_d©a
(
dm_block
 *
b
);

33 
	gdm_block_m™agî
;

34 
dm_block_m™agî
 *
dm_block_m™agî_¸óã
(

35 
block_devi˚
 *
bdev
, 
block_size
,

36 
ˇche_size
, 
max_hñd_≥r_thªad
);

37 
dm_block_m™agî_de°roy
(
dm_block_m™agî
 *
bm
);

39 
dm_bm_block_size
(
dm_block_m™agî
 *
bm
);

40 
dm_block_t
 
dm_bm_ƒ_blocks
(
dm_block_m™agî
 *
bm
);

50 
	sdm_block_vÆid©‹
 {

51 c⁄° *
	m«me
;

52 (*
	m¥ï¨e_f‹_wrôe
)(
dm_block_vÆid©‹
 *
	mv
, 
dm_block
 *
	mb
, 
size_t
 
	mblock_size
);

57 (*
	mcheck
)(
dm_block_vÆid©‹
 *
	mv
, 
dm_block
 *
	mb
, 
size_t
 
	mblock_size
);

73 
dm_bm_ªad_lock
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
,

74 
dm_block_vÆid©‹
 *
v
,

75 
dm_block
 **
ªsu…
);

77 
dm_bm_wrôe_lock
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
,

78 
dm_block_vÆid©‹
 *
v
,

79 
dm_block
 **
ªsu…
);

85 
dm_bm_ªad_åy_lock
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
,

86 
dm_block_vÆid©‹
 *
v
,

87 
dm_block
 **
ªsu…
);

93 
dm_bm_wrôe_lock_zîo
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
,

94 
dm_block_vÆid©‹
 *
v
,

95 
dm_block
 **
ªsu…
);

97 
dm_bm_u∆ock
(
dm_block
 *
b
);

108 
dm_bm_Êush
(
dm_block_m™agî
 *
bm
);

113 
dm_bm_¥e„tch
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
b
);

126 
dm_bm_£t_ªad_⁄ly
(
dm_block_m™agî
 *
bm
);

127 
dm_bm_£t_ªad_wrôe
(
dm_block_m™agî
 *
bm
);

129 
u32
 
dm_bm_checksum
(c⁄° *
d©a
, 
size_t
 
Àn
, u32 
öô_x‹
);

	@persistent-data/dm-btree-internal.h

7 #i‚de‡
DM_BTREE_INTERNAL_H


8 
	#DM_BTREE_INTERNAL_H


	)

10 
	~"dm-båì.h
"

19 
	enode_Êags
 {

20 
	mINTERNAL_NODE
 = 1,

21 
	mLEAF_NODE
 = 1 << 1

28 
	snode_hódî
 {

29 
__À32
 
	mcsum
;

30 
__À32
 
	mÊags
;

31 
__À64
 
	mblockƒ
;

33 
__À32
 
	mƒ_íåõs
;

34 
__À32
 
	mmax_íåõs
;

35 
__À32
 
	mvÆue_size
;

36 
__À32
 
	m∑ddög
;

37 } 
	g__∑cked
;

39 
	sbåì_node
 {

40 
node_hódî
 
	mhódî
;

41 
__À64
 
	mkeys
[0];

42 } 
	g__∑cked
;

45 
öc_chûdªn
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
båì_node
 *
n
,

46 
dm_båì_vÆue_ty≥
 *
vt
);

48 
√w_block
(
dm_båì_öfo
 *
öfo
, 
dm_block
 **
ªsu…
);

49 
u∆ock_block
(
dm_båì_öfo
 *
öfo
, 
dm_block
 *
b
);

57 
	sro_•öe
 {

58 
dm_båì_öfo
 *
	möfo
;

60 
	mcou¡
;

61 
dm_block
 *
	mnodes
[2];

64 
öô_ro_•öe
(
ro_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
);

65 
exô_ro_•öe
(
ro_•öe
 *
s
);

66 
ro_°ï
(
ro_•öe
 *
s
, 
dm_block_t
 
√w_chûd
);

67 
ro_p›
(
ro_•öe
 *
s
);

68 
båì_node
 *
ro_node
(
ro_•öe
 *
s
);

70 
	sshadow_•öe
 {

71 
dm_båì_öfo
 *
	möfo
;

73 
	mcou¡
;

74 
dm_block
 *
	mnodes
[2];

76 
dm_block_t
 
	mroŸ
;

79 
öô_shadow_•öe
(
shadow_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
);

80 
exô_shadow_•öe
(
shadow_•öe
 *
s
);

82 
shadow_°ï
(
shadow_•öe
 *
s
, 
dm_block_t
 
b
,

83 
dm_båì_vÆue_ty≥
 *
vt
);

88 
dm_block
 *
shadow_cuºít
(
shadow_•öe
 *
s
);

93 
dm_block
 *
shadow_∑ª¡
(
shadow_•öe
 *
s
);

95 
shadow_has_∑ª¡
(
shadow_•öe
 *
s
);

97 
shadow_roŸ
(
shadow_•öe
 *
s
);

102 
ölöe
 
__À64
 *
	$key_±r
(
båì_node
 *
n
, 
uöt32_t
 
ödex
)

104  
n
->
keys
 + 
ödex
;

105 
	}
}

107 
ölöe
 *
	$vÆue_ba£
(
båì_node
 *
n
)

109  &
n
->
keys
[
	`À32_to_˝u
“->
hódî
.
max_íåõs
)];

110 
	}
}

112 
ölöe
 *
	$vÆue_±r
(
båì_node
 *
n
, 
uöt32_t
 
ödex
)

114 
uöt32_t
 
vÆue_size
 = 
	`À32_to_˝u
(
n
->
hódî
.value_size);

115  
	`vÆue_ba£
(
n
Ë+ (
vÆue_size
 * 
ödex
);

116 
	}
}

121 
ölöe
 
uöt64_t
 
	$vÆue64
(
båì_node
 *
n
, 
uöt32_t
 
ödex
)

123 
__À64
 *
vÆues_À
 = 
	`vÆue_ba£
(
n
);

125  
	`À64_to_˝u
(
vÆues_À
[
ödex
]);

126 
	}
}

131 
lowî_bound
(
båì_node
 *
n
, 
uöt64_t
 
key
);

133 
dm_block_vÆid©‹
 
båì_node_vÆid©‹
;

	@persistent-data/dm-btree-remove.c

7 
	~"dm-båì.h
"

8 
	~"dm-båì-öã∫Æ.h
"

9 
	~"dm-å™ß˘i⁄-m™agî.h
"

11 
	~<löux/exp‹t.h
>

56 
	$node_shi·
(
båì_node
 *
n
, 
shi·
)

58 
uöt32_t
 
ƒ_íåõs
 = 
	`À32_to_˝u
(
n
->
hódî
.nr_entries);

59 
uöt32_t
 
vÆue_size
 = 
	`À32_to_˝u
(
n
->
hódî
.value_size);

61 i‡(
shi·
 < 0) {

62 
shi·
 = -shift;

63 
	`BUG_ON
(
shi·
 > 
ƒ_íåõs
);

64 
	`BUG_ON
((*Ë
	`key_±r
(
n
, 
shi·
Ë>
	`vÆue_±r
(n, shift));

65 
	`memmove
(
	`key_±r
(
n
, 0),

66 
	`key_±r
(
n
, 
shi·
),

67 (
ƒ_íåõs
 - 
shi·
Ë* (
__À64
));

68 
	`memmove
(
	`vÆue_±r
(
n
, 0),

69 
	`vÆue_±r
(
n
, 
shi·
),

70 (
ƒ_íåõs
 - 
shi·
Ë* 
vÆue_size
);

72 
	`BUG_ON
(
ƒ_íåõs
 + 
shi·
 > 
	`À32_to_˝u
(
n
->
hódî
.
max_íåõs
));

73 
	`memmove
(
	`key_±r
(
n
, 
shi·
),

74 
	`key_±r
(
n
, 0),

75 
ƒ_íåõs
 * (
__À64
));

76 
	`memmove
(
	`vÆue_±r
(
n
, 
shi·
),

77 
	`vÆue_±r
(
n
, 0),

78 
ƒ_íåõs
 * 
vÆue_size
);

80 
	}
}

82 
	$node_c›y
(
båì_node
 *
À·
, båì_nodê*
right
, 
shi·
)

84 
uöt32_t
 
ƒ_À·
 = 
	`À32_to_˝u
(
À·
->
hódî
.
ƒ_íåõs
);

85 
uöt32_t
 
vÆue_size
 = 
	`À32_to_˝u
(
À·
->
hódî
.value_size);

86 
	`BUG_ON
(
vÆue_size
 !
	`À32_to_˝u
(
right
->
hódî
.value_size));

88 i‡(
shi·
 < 0) {

89 
shi·
 = -shift;

90 
	`BUG_ON
(
ƒ_À·
 + 
shi·
 > 
	`À32_to_˝u
(
À·
->
hódî
.
max_íåõs
));

91 
	`mem˝y
(
	`key_±r
(
À·
, 
ƒ_À·
),

92 
	`key_±r
(
right
, 0),

93 
shi·
 * (
__À64
));

94 
	`mem˝y
(
	`vÆue_±r
(
À·
, 
ƒ_À·
),

95 
	`vÆue_±r
(
right
, 0),

96 
shi·
 * 
vÆue_size
);

98 
	`BUG_ON
(
shi·
 > 
	`À32_to_˝u
(
right
->
hódî
.
max_íåõs
));

99 
	`mem˝y
(
	`key_±r
(
right
, 0),

100 
	`key_±r
(
À·
, 
ƒ_À·
 - 
shi·
),

101 
shi·
 * (
__À64
));

102 
	`mem˝y
(
	`vÆue_±r
(
right
, 0),

103 
	`vÆue_±r
(
À·
, 
ƒ_À·
 - 
shi·
),

104 
shi·
 * 
vÆue_size
);

106 
	}
}

111 
	$dñëe_©
(
båì_node
 *
n
, 
ödex
)

113 
ƒ_íåõs
 = 
	`À32_to_˝u
(
n
->
hódî
.nr_entries);

114 
ƒ_to_c›y
 = 
ƒ_íåõs
 - (
ödex
 + 1);

115 
uöt32_t
 
vÆue_size
 = 
	`À32_to_˝u
(
n
->
hódî
.value_size);

116 
	`BUG_ON
(
ödex
 >
ƒ_íåõs
);

118 i‡(
ƒ_to_c›y
) {

119 
	`memmove
(
	`key_±r
(
n
, 
ödex
),

120 
	`key_±r
(
n
, 
ödex
 + 1),

121 
ƒ_to_c›y
 * (
__À64
));

123 
	`memmove
(
	`vÆue_±r
(
n
, 
ödex
),

124 
	`vÆue_±r
(
n
, 
ödex
 + 1),

125 
ƒ_to_c›y
 * 
vÆue_size
);

128 
n
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(nr_entries - 1);

129 
	}
}

131 
	$mîge_thªshﬁd
(
båì_node
 *
n
)

133  
	`À32_to_˝u
(
n
->
hódî
.
max_íåõs
) / 3;

134 
	}
}

136 
	schûd
 {

137 
	mödex
;

138 
dm_block
 *
	mblock
;

139 
båì_node
 *
	mn
;

142 
	$öô_chûd
(
dm_båì_öfo
 *
öfo
, 
dm_båì_vÆue_ty≥
 *
vt
,

143 
båì_node
 *
∑ª¡
,

144 
ödex
, 
chûd
 *
ªsu…
)

146 
r
, 
öc
;

147 
dm_block_t
 
roŸ
;

149 
ªsu…
->
ödex
 = index;

150 
roŸ
 = 
	`vÆue64
(
∑ª¡
, 
ödex
);

152 
r
 = 
	`dm_tm_shadow_block
(
öfo
->
tm
, 
roŸ
, &
båì_node_vÆid©‹
,

153 &
ªsu…
->
block
, &
öc
);

154 i‡(
r
)

155  
r
;

157 
ªsu…
->
n
 = 
	`dm_block_d©a
‘esu…->
block
);

159 i‡(
öc
)

160 
	`öc_chûdªn
(
öfo
->
tm
, 
ªsu…
->
n
, 
vt
);

162 *((
__À64
 *Ë
	`vÆue_±r
(
∑ª¡
, 
ödex
)) =

163 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
ªsu…
->
block
));

166 
	}
}

168 
	$exô_chûd
(
dm_båì_öfo
 *
öfo
, 
chûd
 *
c
)

170  
	`dm_tm_u∆ock
(
öfo
->
tm
, 
c
->
block
);

171 
	}
}

173 
	$shi·
(
båì_node
 *
À·
, båì_nodê*
right
, 
cou¡
)

175 
uöt32_t
 
ƒ_À·
 = 
	`À32_to_˝u
(
À·
->
hódî
.
ƒ_íåõs
);

176 
uöt32_t
 
ƒ_right
 = 
	`À32_to_˝u
(
right
->
hódî
.
ƒ_íåõs
);

177 
uöt32_t
 
max_íåõs
 = 
	`À32_to_˝u
(
À·
->
hódî
.max_entries);

178 
uöt32_t
 
r_max_íåõs
 = 
	`À32_to_˝u
(
right
->
hódî
.
max_íåõs
);

180 
	`BUG_ON
(
max_íåõs
 !
r_max_íåõs
);

181 
	`BUG_ON
(
ƒ_À·
 - 
cou¡
 > 
max_íåõs
);

182 
	`BUG_ON
(
ƒ_right
 + 
cou¡
 > 
max_íåõs
);

184 i‡(!
cou¡
)

187 i‡(
cou¡
 > 0) {

188 
	`node_shi·
(
right
, 
cou¡
);

189 
	`node_c›y
(
À·
, 
right
, 
cou¡
);

191 
	`node_c›y
(
À·
, 
right
, 
cou¡
);

192 
	`node_shi·
(
right
, 
cou¡
);

195 
À·
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_À·
 - 
cou¡
);

196 
right
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_right
 + 
cou¡
);

197 
	}
}

199 
	$__ªbÆ™˚2
(
dm_båì_öfo
 *
öfo
, 
båì_node
 *
∑ª¡
,

200 
chûd
 *
l
, chûd *
r
)

202 
båì_node
 *
À·
 = 
l
->
n
;

203 
båì_node
 *
right
 = 
r
->
n
;

204 
uöt32_t
 
ƒ_À·
 = 
	`À32_to_˝u
(
À·
->
hódî
.
ƒ_íåõs
);

205 
uöt32_t
 
ƒ_right
 = 
	`À32_to_˝u
(
right
->
hódî
.
ƒ_íåõs
);

206 
thªshﬁd
 = 2 * 
	`mîge_thªshﬁd
(
À·
) + 1;

208 i‡(
ƒ_À·
 + 
ƒ_right
 < 
thªshﬁd
) {

212 
	`node_c›y
(
À·
, 
right
, -
ƒ_right
);

213 
À·
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_À·
 + 
ƒ_right
);

214 
	`dñëe_©
(
∑ª¡
, 
r
->
ödex
);

220 
	`dm_tm_dec
(
öfo
->
tm
, 
	`dm_block_loˇti⁄
(
r
->
block
));

225 
èrgë_À·
 = (
ƒ_À·
 + 
ƒ_right
) / 2;

226 
	`shi·
(
À·
, 
right
, 
ƒ_À·
 - 
èrgë_À·
);

227 *
	`key_±r
(
∑ª¡
, 
r
->
ödex
Ë
right
->
keys
[0];

229 
	}
}

231 
	$ªbÆ™˚2
(
shadow_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
,

232 
dm_båì_vÆue_ty≥
 *
vt
, 
À·_ödex
)

234 
r
;

235 
båì_node
 *
∑ª¡
;

236 
chûd
 
À·
, 
right
;

238 
∑ª¡
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

240 
r
 = 
	`öô_chûd
(
öfo
, 
vt
, 
∑ª¡
, 
À·_ödex
, &
À·
);

241 i‡(
r
)

242  
r
;

244 
r
 = 
	`öô_chûd
(
öfo
, 
vt
, 
∑ª¡
, 
À·_ödex
 + 1, &
right
);

245 i‡(
r
) {

246 
	`exô_chûd
(
öfo
, &
À·
);

247  
r
;

250 
	`__ªbÆ™˚2
(
öfo
, 
∑ª¡
, &
À·
, &
right
);

252 
r
 = 
	`exô_chûd
(
öfo
, &
À·
);

253 i‡(
r
) {

254 
	`exô_chûd
(
öfo
, &
right
);

255  
r
;

258  
	`exô_chûd
(
öfo
, &
right
);

259 
	}
}

266 
	$dñëe_˚¡î_node
(
dm_båì_öfo
 *
öfo
, 
båì_node
 *
∑ª¡
,

267 
chûd
 *
l
, chûd *
c
, chûd *
r
,

268 
båì_node
 *
À·
, båì_nodê*
˚¡î
, båì_nodê*
right
,

269 
uöt32_t
 
ƒ_À·
, uöt32_à
ƒ_˚¡î
, uöt32_à
ƒ_right
)

271 
uöt32_t
 
max_íåõs
 = 
	`À32_to_˝u
(
À·
->
hódî
.max_entries);

272 
shi·
 = 
	`mö
(
max_íåõs
 - 
ƒ_À·
, 
ƒ_˚¡î
);

274 
	`BUG_ON
(
ƒ_À·
 + 
shi·
 > 
max_íåõs
);

275 
	`node_c›y
(
À·
, 
˚¡î
, -
shi·
);

276 
À·
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_À·
 + 
shi·
);

278 i‡(
shi·
 !
ƒ_˚¡î
) {

279 
shi·
 = 
ƒ_˚¡î
 - shift;

280 
	`BUG_ON
((
ƒ_right
 + 
shi·
Ë> 
max_íåõs
);

281 
	`node_shi·
(
right
, 
shi·
);

282 
	`node_c›y
(
˚¡î
, 
right
, 
shi·
);

283 
right
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_right
 + 
shi·
);

285 *
	`key_±r
(
∑ª¡
, 
r
->
ödex
Ë
right
->
keys
[0];

287 
	`dñëe_©
(
∑ª¡
, 
c
->
ödex
);

288 
r
->
ödex
--;

290 
	`dm_tm_dec
(
öfo
->
tm
, 
	`dm_block_loˇti⁄
(
c
->
block
));

291 
	`__ªbÆ™˚2
(
öfo
, 
∑ª¡
, 
l
, 
r
);

292 
	}
}

297 
	$ªdi°ribuã3
(
dm_båì_öfo
 *
öfo
, 
båì_node
 *
∑ª¡
,

298 
chûd
 *
l
, chûd *
c
, chûd *
r
,

299 
båì_node
 *
À·
, båì_nodê*
˚¡î
, båì_nodê*
right
,

300 
uöt32_t
 
ƒ_À·
, uöt32_à
ƒ_˚¡î
, uöt32_à
ƒ_right
)

302 
s
;

303 
uöt32_t
 
max_íåõs
 = 
	`À32_to_˝u
(
À·
->
hódî
.max_entries);

304 
èrgë
 = (
ƒ_À·
 + 
ƒ_˚¡î
 + 
ƒ_right
) / 3;

305 
	`BUG_ON
(
èrgë
 > 
max_íåõs
);

307 i‡(
ƒ_À·
 < 
ƒ_right
) {

308 
s
 = 
ƒ_À·
 - 
èrgë
;

310 i‡(
s
 < 0 && 
ƒ_˚¡î
 < -s) {

312 
	`shi·
(
À·
, 
˚¡î
, 
ƒ_˚¡î
);

313 
s
 = 
ƒ_˚¡î
 - 
èrgë
;

314 
	`shi·
(
À·
, 
right
, 
s
);

315 
ƒ_right
 +
s
;

317 
	`shi·
(
À·
, 
˚¡î
, 
s
);

319 
	`shi·
(
˚¡î
, 
right
, 
èrgë
 - 
ƒ_right
);

322 
s
 = 
èrgë
 - 
ƒ_right
;

323 i‡(
s
 > 0 && 
ƒ_˚¡î
 < s) {

325 
	`shi·
(
˚¡î
, 
right
, 
ƒ_˚¡î
);

326 
s
 = 
èrgë
 - 
ƒ_˚¡î
;

327 
	`shi·
(
À·
, 
right
, 
s
);

328 
ƒ_À·
 -
s
;

330 
	`shi·
(
˚¡î
, 
right
, 
s
);

332 
	`shi·
(
À·
, 
˚¡î
, 
ƒ_À·
 - 
èrgë
);

335 *
	`key_±r
(
∑ª¡
, 
c
->
ödex
Ë
˚¡î
->
keys
[0];

336 *
	`key_±r
(
∑ª¡
, 
r
->
ödex
Ë
right
->
keys
[0];

337 
	}
}

339 
	$__ªbÆ™˚3
(
dm_båì_öfo
 *
öfo
, 
båì_node
 *
∑ª¡
,

340 
chûd
 *
l
, chûd *
c
, chûd *
r
)

342 
båì_node
 *
À·
 = 
l
->
n
;

343 
båì_node
 *
˚¡î
 = 
c
->
n
;

344 
båì_node
 *
right
 = 
r
->
n
;

346 
uöt32_t
 
ƒ_À·
 = 
	`À32_to_˝u
(
À·
->
hódî
.
ƒ_íåõs
);

347 
uöt32_t
 
ƒ_˚¡î
 = 
	`À32_to_˝u
(
˚¡î
->
hódî
.
ƒ_íåõs
);

348 
uöt32_t
 
ƒ_right
 = 
	`À32_to_˝u
(
right
->
hódî
.
ƒ_íåõs
);

350 
thªshﬁd
 = 
	`mîge_thªshﬁd
(
À·
) * 4 + 1;

352 
	`BUG_ON
(
À·
->
hódî
.
max_íåõs
 !
˚¡î
->header.max_entries);

353 
	`BUG_ON
(
˚¡î
->
hódî
.
max_íåõs
 !
right
->header.max_entries);

355 i‡((
ƒ_À·
 + 
ƒ_˚¡î
 + 
ƒ_right
Ë< 
thªshﬁd
)

356 
	`dñëe_˚¡î_node
(
öfo
, 
∑ª¡
, 
l
, 
c
, 
r
, 
À·
, 
˚¡î
, 
right
,

357 
ƒ_À·
, 
ƒ_˚¡î
, 
ƒ_right
);

359 
	`ªdi°ribuã3
(
öfo
, 
∑ª¡
, 
l
, 
c
, 
r
, 
À·
, 
˚¡î
, 
right
,

360 
ƒ_À·
, 
ƒ_˚¡î
, 
ƒ_right
);

361 
	}
}

363 
	$ªbÆ™˚3
(
shadow_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
,

364 
dm_båì_vÆue_ty≥
 *
vt
, 
À·_ödex
)

366 
r
;

367 
båì_node
 *
∑ª¡
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

368 
chûd
 
À·
, 
˚¡î
, 
right
;

373 
r
 = 
	`öô_chûd
(
öfo
, 
vt
, 
∑ª¡
, 
À·_ödex
, &
À·
);

374 i‡(
r
)

375  
r
;

377 
r
 = 
	`öô_chûd
(
öfo
, 
vt
, 
∑ª¡
, 
À·_ödex
 + 1, &
˚¡î
);

378 i‡(
r
) {

379 
	`exô_chûd
(
öfo
, &
À·
);

380  
r
;

383 
r
 = 
	`öô_chûd
(
öfo
, 
vt
, 
∑ª¡
, 
À·_ödex
 + 2, &
right
);

384 i‡(
r
) {

385 
	`exô_chûd
(
öfo
, &
À·
);

386 
	`exô_chûd
(
öfo
, &
˚¡î
);

387  
r
;

390 
	`__ªbÆ™˚3
(
öfo
, 
∑ª¡
, &
À·
, &
˚¡î
, &
right
);

392 
r
 = 
	`exô_chûd
(
öfo
, &
À·
);

393 i‡(
r
) {

394 
	`exô_chûd
(
öfo
, &
˚¡î
);

395 
	`exô_chûd
(
öfo
, &
right
);

396  
r
;

399 
r
 = 
	`exô_chûd
(
öfo
, &
˚¡î
);

400 i‡(
r
) {

401 
	`exô_chûd
(
öfo
, &
right
);

402  
r
;

405 
r
 = 
	`exô_chûd
(
öfo
, &
right
);

406 i‡(
r
)

407  
r
;

410 
	}
}

412 
	$gë_ƒ_íåõs
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

413 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
)

415 
r
;

416 
dm_block
 *
block
;

417 
båì_node
 *
n
;

419 
r
 = 
	`dm_tm_ªad_lock
(
tm
, 
b
, &
båì_node_vÆid©‹
, &
block
);

420 i‡(
r
)

421  
r
;

423 
n
 = 
	`dm_block_d©a
(
block
);

424 *
ªsu…
 = 
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
);

426  
	`dm_tm_u∆ock
(
tm
, 
block
);

427 
	}
}

429 
	$ªbÆ™˚_chûdªn
(
shadow_•öe
 *
s
,

430 
dm_båì_öfo
 *
öfo
,

431 
dm_båì_vÆue_ty≥
 *
vt
, 
uöt64_t
 
key
)

433 
i
, 
r
, 
has_À·_siblög
, 
has_right_siblög
;

434 
uöt32_t
 
chûd_íåõs
;

435 
båì_node
 *
n
;

437 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

439 i‡(
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
) == 1) {

440 
dm_block
 *
chûd
;

441 
dm_block_t
 
b
 = 
	`vÆue64
(
n
, 0);

443 
r
 = 
	`dm_tm_ªad_lock
(
öfo
->
tm
, 
b
, &
båì_node_vÆid©‹
, &
chûd
);

444 i‡(
r
)

445  
r
;

447 
	`mem˝y
(
n
, 
	`dm_block_d©a
(
chûd
),

448 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
öfo
->
tm
)));

449 
r
 = 
	`dm_tm_u∆ock
(
öfo
->
tm
, 
chûd
);

450 i‡(
r
)

451  
r
;

453 
	`dm_tm_dec
(
öfo
->
tm
, 
	`dm_block_loˇti⁄
(
chûd
));

457 
i
 = 
	`lowî_bound
(
n
, 
key
);

458 i‡(
i
 < 0)

459  -
ENODATA
;

461 
r
 = 
	`gë_ƒ_íåõs
(
öfo
->
tm
, 
	`vÆue64
(
n
, 
i
), &
chûd_íåõs
);

462 i‡(
r
)

463  
r
;

465 
has_À·_siblög
 = 
i
 > 0;

466 
has_right_siblög
 = 
i
 < (
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
) - 1);

468 i‡(!
has_À·_siblög
)

469 
r
 = 
	`ªbÆ™˚2
(
s
, 
öfo
, 
vt
, 
i
);

471 i‡(!
has_right_siblög
)

472 
r
 = 
	`ªbÆ™˚2
(
s
, 
öfo
, 
vt
, 
i
 - 1);

475 
r
 = 
	`ªbÆ™˚3
(
s
, 
öfo
, 
vt
, 
i
 - 1);

477  
r
;

478 
	}
}

480 
	$do_Àaf
(
båì_node
 *
n
, 
uöt64_t
 
key
, *
ödex
)

482 
i
 = 
	`lowî_bound
(
n
, 
key
);

484 i‡((
i
 < 0) ||

485 (
i
 >
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
)) ||

486 (
	`À64_to_˝u
(
n
->
keys
[
i
]Ë!
key
))

487  -
ENODATA
;

489 *
ödex
 = 
i
;

492 
	}
}

498 
	$ªmove_øw
(
shadow_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
,

499 
dm_båì_vÆue_ty≥
 *
vt
, 
dm_block_t
 
roŸ
,

500 
uöt64_t
 
key
, *
ödex
)

502 
i
 = *
ödex
, 
r
;

503 
båì_node
 *
n
;

506 
r
 = 
	`shadow_°ï
(
s
, 
roŸ
, 
vt
);

507 i‡(
r
 < 0)

515 i‡(
	`shadow_has_∑ª¡
(
s
)) {

516 
__À64
 
loˇti⁄
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
	`shadow_cuºít
(
s
)));

517 
	`mem˝y
(
	`vÆue_±r
(
	`dm_block_d©a
(
	`shadow_∑ª¡
(
s
)), 
i
),

518 &
loˇti⁄
, (
__À64
));

521 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

523 i‡(
	`À32_to_˝u
(
n
->
hódî
.
Êags
Ë& 
LEAF_NODE
)

524  
	`do_Àaf
(
n
, 
key
, 
ödex
);

526 
r
 = 
	`ªbÆ™˚_chûdªn
(
s
, 
öfo
, 
vt
, 
key
);

527 i‡(
r
)

530 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

531 i‡(
	`À32_to_˝u
(
n
->
hódî
.
Êags
Ë& 
LEAF_NODE
)

532  
	`do_Àaf
(
n
, 
key
, 
ödex
);

534 
i
 = 
	`lowî_bound
(
n
, 
key
);

541 
roŸ
 = 
	`vÆue64
(
n
, 
i
);

544  
r
;

545 
	}
}

547 
dm_båì_vÆue_ty≥
 
	gÀ64_ty≥
 = {

548 .
c⁄ãxt
 = 
NULL
,

549 .
	gsize
 = (
__À64
),

550 .
	göc
 = 
NULL
,

551 .
	gdec
 = 
NULL
,

552 .
	gequÆ
 = 
NULL


555 
	$dm_båì_ªmove
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

556 
uöt64_t
 *
keys
, 
dm_block_t
 *
√w_roŸ
)

558 
Àvñ
, 
œ°_Àvñ
 = 
öfo
->
Àvñs
 - 1;

559 
ödex
 = 0, 
r
 = 0;

560 
shadow_•öe
 
•öe
;

561 
båì_node
 *
n
;

563 
	`öô_shadow_•öe
(&
•öe
, 
öfo
);

564 
Àvñ
 = 0;Üevñ < 
öfo
->
Àvñs
;Üevel++) {

565 
r
 = 
	`ªmove_øw
(&
•öe
, 
öfo
,

566 (
Àvñ
 =
œ°_Àvñ
 ?

567 &
öfo
->
vÆue_ty≥
 : &
À64_ty≥
),

568 
roŸ
, 
keys
[
Àvñ
], (*)&
ödex
);

569 i‡(
r
 < 0)

572 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(&
•öe
));

573 i‡(
Àvñ
 !
œ°_Àvñ
) {

574 
roŸ
 = 
	`vÆue64
(
n
, 
ödex
);

578 
	`BUG_ON
(
ödex
 < 0 || index >
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
));

580 i‡(
öfo
->
vÆue_ty≥
.
dec
)

581 
öfo
->
vÆue_ty≥
.
	`dec
(öfo->vÆue_ty≥.
c⁄ãxt
,

582 
	`vÆue_±r
(
n
, 
ödex
));

584 
	`dñëe_©
(
n
, 
ödex
);

587 *
√w_roŸ
 = 
	`shadow_roŸ
(&
•öe
);

588 
	`exô_shadow_•öe
(&
•öe
);

590  
r
;

591 
	}
}

592 
EXPORT_SYMBOL_GPL
(
dm_båì_ªmove
);

	@persistent-data/dm-btree-spine.c

7 
	~"dm-båì-öã∫Æ.h
"

8 
	~"dm-å™ß˘i⁄-m™agî.h
"

10 
	~<löux/devi˚-m≠≥r.h
>

12 
	#DM_MSG_PREFIX
 "båì spöe"

	)

16 
	#BTREE_CSUM_XOR
 121107

	)

18 
node_check
(
dm_block_vÆid©‹
 *
v
,

19 
dm_block
 *
b
,

20 
size_t
 
block_size
);

22 
	$node_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

23 
dm_block
 *
b
,

24 
size_t
 
block_size
)

26 
båì_node
 *
n
 = 
	`dm_block_d©a
(
b
);

27 
node_hódî
 *
h
 = &
n
->
hódî
;

29 
h
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

30 
h
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&h->
Êags
,

31 
block_size
 - (
__À32
),

32 
BTREE_CSUM_XOR
));

34 
	`BUG_ON
(
	`node_check
(
v
, 
b
, 4096));

35 
	}
}

37 
	$node_check
(
dm_block_vÆid©‹
 *
v
,

38 
dm_block
 *
b
,

39 
size_t
 
block_size
)

41 
båì_node
 *
n
 = 
	`dm_block_d©a
(
b
);

42 
node_hódî
 *
h
 = &
n
->
hódî
;

43 
size_t
 
vÆue_size
;

44 
__À32
 
csum_disk
;

45 
uöt32_t
 
Êags
;

47 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
h
->
blockƒ
)) {

48 
	`DMERR_LIMIT
("node_check failed: blocknr %llu != wanted %llu",

49 
	`À64_to_˝u
(
h
->
blockƒ
), 
	`dm_block_loˇti⁄
(
b
));

50  -
ENOTBLK
;

53 
csum_disk
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
h
->
Êags
,

54 
block_size
 - (
__À32
),

55 
BTREE_CSUM_XOR
));

56 i‡(
csum_disk
 !
h
->
csum
) {

57 
	`DMERR_LIMIT
("node_check failed: csum %u != wanted %u",

58 
	`À32_to_˝u
(
csum_disk
),Üe32_to_˝u(
h
->
csum
));

59  -
EILSEQ
;

62 
vÆue_size
 = 
	`À32_to_˝u
(
h
->value_size);

64 i‡((
node_hódî
) +

65 ((
__À64
Ë+ 
vÆue_size
Ë* 
	`À32_to_˝u
(
h
->
max_íåõs
Ë> 
block_size
) {

66 
	`DMERR_LIMIT
("node_check failed: max_entriesÅooÜarge");

67  -
EILSEQ
;

70 i‡(
	`À32_to_˝u
(
h
->
ƒ_íåõs
Ë>Üe32_to_˝u(h->
max_íåõs
)) {

71 
	`DMERR_LIMIT
("node_check failed:Åoo manyÉntries");

72  -
EILSEQ
;

78 
Êags
 = 
	`À32_to_˝u
(
h
->flags);

79 i‡(!(
Êags
 & 
INTERNAL_NODE
Ë&& !(Êag†& 
LEAF_NODE
)) {

80 
	`DMERR_LIMIT
("node_check failed:Çode isÇeither INTERNAL or LEAF");

81  -
EILSEQ
;

85 
	}
}

87 
dm_block_vÆid©‹
 
	gbåì_node_vÆid©‹
 = {

88 .
«me
 = "btree_node",

89 .
	g¥ï¨e_f‹_wrôe
 = 
node_¥ï¨e_f‹_wrôe
,

90 .
	gcheck
 = 
node_check


95 
	$bn_ªad_lock
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
b
,

96 
dm_block
 **
ªsu…
)

98  
	`dm_tm_ªad_lock
(
öfo
->
tm
, 
b
, &
båì_node_vÆid©‹
, 
ªsu…
);

99 
	}
}

101 
	$bn_shadow
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
‹ig
,

102 
dm_båì_vÆue_ty≥
 *
vt
,

103 
dm_block
 **
ªsu…
)

105 
r
, 
öc
;

107 
r
 = 
	`dm_tm_shadow_block
(
öfo
->
tm
, 
‹ig
, &
båì_node_vÆid©‹
,

108 
ªsu…
, &
öc
);

109 i‡(!
r
 && 
öc
)

110 
	`öc_chûdªn
(
öfo
->
tm
, 
	`dm_block_d©a
(*
ªsu…
), 
vt
);

112  
r
;

113 
	}
}

115 
	$√w_block
(
dm_båì_öfo
 *
öfo
, 
dm_block
 **
ªsu…
)

117  
	`dm_tm_√w_block
(
öfo
->
tm
, &
båì_node_vÆid©‹
, 
ªsu…
);

118 
	}
}

120 
	$u∆ock_block
(
dm_båì_öfo
 *
öfo
, 
dm_block
 *
b
)

122  
	`dm_tm_u∆ock
(
öfo
->
tm
, 
b
);

123 
	}
}

127 
	$öô_ro_•öe
(
ro_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
)

129 
s
->
öfo
 = info;

130 
s
->
cou¡
 = 0;

131 
s
->
nodes
[0] = 
NULL
;

132 
s
->
nodes
[1] = 
NULL
;

133 
	}
}

135 
	$exô_ro_•öe
(
ro_•öe
 *
s
)

137 
r
 = 0, 
i
;

139 
i
 = 0; i < 
s
->
cou¡
; i++) {

140 
r2
 = 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[
i
]);

141 i‡(
r2
 < 0)

142 
r
 = 
r2
;

145  
r
;

146 
	}
}

148 
	$ro_°ï
(
ro_•öe
 *
s
, 
dm_block_t
 
√w_chûd
)

150 
r
;

152 i‡(
s
->
cou¡
 == 2) {

153 
r
 = 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[0]);

154 i‡(
r
 < 0)

155  
r
;

156 
s
->
nodes
[0] = s->nodes[1];

157 
s
->
cou¡
--;

160 
r
 = 
	`bn_ªad_lock
(
s
->
öfo
, 
√w_chûd
, s->
nodes
 + s->
cou¡
);

161 i‡(!
r
)

162 
s
->
cou¡
++;

164  
r
;

165 
	}
}

167 
	$ro_p›
(
ro_•öe
 *
s
)

169 
	`BUG_ON
(!
s
->
cou¡
);

170 --
s
->
cou¡
;

171 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[s->
cou¡
]);

172 
	}
}

174 
båì_node
 *
	$ro_node
(
ro_•öe
 *
s
)

176 
dm_block
 *
block
;

178 
	`BUG_ON
(!
s
->
cou¡
);

179 
block
 = 
s
->
nodes
[s->
cou¡
 - 1];

181  
	`dm_block_d©a
(
block
);

182 
	}
}

186 
	$öô_shadow_•öe
(
shadow_•öe
 *
s
, 
dm_båì_öfo
 *
öfo
)

188 
s
->
öfo
 = info;

189 
s
->
cou¡
 = 0;

190 
	}
}

192 
	$exô_shadow_•öe
(
shadow_•öe
 *
s
)

194 
r
 = 0, 
i
;

196 
i
 = 0; i < 
s
->
cou¡
; i++) {

197 
r2
 = 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[
i
]);

198 i‡(
r2
 < 0)

199 
r
 = 
r2
;

202  
r
;

203 
	}
}

205 
	$shadow_°ï
(
shadow_•öe
 *
s
, 
dm_block_t
 
b
,

206 
dm_båì_vÆue_ty≥
 *
vt
)

208 
r
;

210 i‡(
s
->
cou¡
 == 2) {

211 
r
 = 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[0]);

212 i‡(
r
 < 0)

213  
r
;

214 
s
->
nodes
[0] = s->nodes[1];

215 
s
->
cou¡
--;

218 
r
 = 
	`bn_shadow
(
s
->
öfo
, 
b
, 
vt
, s->
nodes
 + s->
cou¡
);

219 i‡(!
r
) {

220 i‡(!
s
->
cou¡
)

221 
s
->
roŸ
 = 
	`dm_block_loˇti⁄
(s->
nodes
[0]);

223 
s
->
cou¡
++;

226  
r
;

227 
	}
}

229 
dm_block
 *
	$shadow_cuºít
(
shadow_•öe
 *
s
)

231 
	`BUG_ON
(!
s
->
cou¡
);

233  
s
->
nodes
[s->
cou¡
 - 1];

234 
	}
}

236 
dm_block
 *
	$shadow_∑ª¡
(
shadow_•öe
 *
s
)

238 
	`BUG_ON
(
s
->
cou¡
 != 2);

240  
s
->
cou¡
 =2 ? s->
nodes
[0] : 
NULL
;

241 
	}
}

243 
	$shadow_has_∑ª¡
(
shadow_•öe
 *
s
)

245  
s
->
cou¡
 >= 2;

246 
	}
}

248 
	$shadow_roŸ
(
shadow_•öe
 *
s
)

250  
s
->
roŸ
;

251 
	}
}

	@persistent-data/dm-btree.c

7 
	~"dm-båì-öã∫Æ.h
"

8 
	~"dm-•a˚-m≠.h
"

9 
	~"dm-å™ß˘i⁄-m™agî.h
"

11 
	~<löux/exp‹t.h
>

12 
	~<löux/devi˚-m≠≥r.h
>

14 
	#DM_MSG_PREFIX
 "båì"

	)

19 
	$mem˝y_disk
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

20 
	$__dm_wrôãn_to_disk
(
§c
)

22 
	`mem˝y
(
de°
, 
§c
, 
Àn
);

23 
	`__dm_unbÀss_f‹_disk
(
§c
);

24 
	}
}

26 
	$¨øy_ö£π
(*
ba£
, 
size_t
 
ñt_size
, 
ƒ_ñts
,

27 
ödex
, *
ñt
)

28 
	$__dm_wrôãn_to_disk
(
ñt
)

30 i‡(
ödex
 < 
ƒ_ñts
)

31 
	`memmove
(
ba£
 + (
ñt_size
 * (
ödex
 + 1)),

32 
ba£
 + (
ñt_size
 * 
ödex
),

33 (
ƒ_ñts
 - 
ödex
Ë* 
ñt_size
);

35 
	`mem˝y_disk
(
ba£
 + (
ñt_size
 * 
ödex
), 
ñt
,Élt_size);

36 
	}
}

41 
	$b£¨ch
(
båì_node
 *
n
, 
uöt64_t
 
key
, 
w™t_hi
)

43 
lo
 = -1, 
hi
 = 
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
);

45 
hi
 - 
lo
 > 1) {

46 
mid
 = 
lo
 + ((
hi
 -Üo) / 2);

47 
uöt64_t
 
mid_key
 = 
	`À64_to_˝u
(
n
->
keys
[
mid
]);

49 i‡(
mid_key
 =
key
)

50  
mid
;

52 i‡(
mid_key
 < 
key
)

53 
lo
 = 
mid
;

55 
hi
 = 
mid
;

58  
w™t_hi
 ? 
hi
 : 
lo
;

59 
	}
}

61 
	$lowî_bound
(
båì_node
 *
n
, 
uöt64_t
 
key
)

63  
	`b£¨ch
(
n
, 
key
, 0);

64 
	}
}

66 
	$öc_chûdªn
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
båì_node
 *
n
,

67 
dm_båì_vÆue_ty≥
 *
vt
)

69 
i
;

70 
uöt32_t
 
ƒ_íåõs
 = 
	`À32_to_˝u
(
n
->
hódî
.nr_entries);

72 i‡(
	`À32_to_˝u
(
n
->
hódî
.
Êags
Ë& 
INTERNAL_NODE
)

73 
i
 = 0; i < 
ƒ_íåõs
; i++)

74 
	`dm_tm_öc
(
tm
, 
	`vÆue64
(
n
, 
i
));

75 i‡(
vt
->
öc
)

76 
i
 = 0; i < 
ƒ_íåõs
; i++)

77 
vt
->
	`öc
(vt->
c⁄ãxt
, 
	`vÆue_±r
(
n
, 
i
));

78 
	}
}

80 
	$ö£π_©
(
size_t
 
vÆue_size
, 
båì_node
 *
node
, 
ödex
,

81 
uöt64_t
 
key
, *
vÆue
)

82 
	$__dm_wrôãn_to_disk
(
vÆue
)

84 
uöt32_t
 
ƒ_íåõs
 = 
	`À32_to_˝u
(
node
->
hódî
.nr_entries);

85 
__À64
 
key_À
 = 
	`˝u_to_À64
(
key
);

87 i‡(
ödex
 > 
ƒ_íåõs
 ||

88 
ödex
 >
	`À32_to_˝u
(
node
->
hódî
.
max_íåõs
)) {

89 
	`DMERR
("too manyÉntries in btreeÇode for insert");

90 
	`__dm_unbÀss_f‹_disk
(
vÆue
);

91  -
ENOMEM
;

94 
	`__dm_bÀss_f‹_disk
(&
key_À
);

96 
	`¨øy_ö£π
(
node
->
keys
, (*node->keys), 
ƒ_íåõs
, 
ödex
, &
key_À
);

97 
	`¨øy_ö£π
(
	`vÆue_ba£
(
node
), 
vÆue_size
, 
ƒ_íåõs
, 
ödex
, 
vÆue
);

98 
node
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(nr_entries + 1);

101 
	}
}

109 
uöt32_t
 
	$ˇlc_max_íåõs
(
size_t
 
vÆue_size
, size_à
block_size
)

111 
uöt32_t
 
tŸÆ
, 
n
;

112 
size_t
 
ñt_size
 = (
uöt64_t
Ë+ 
vÆue_size
;

114 
block_size
 -(
node_hódî
);

115 
tŸÆ
 = 
block_size
 / 
ñt_size
;

116 
n
 = 
tŸÆ
 / 3;

118  3 * 
n
;

119 
	}
}

121 
	$dm_båì_em±y
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 *
roŸ
)

123 
r
;

124 
dm_block
 *
b
;

125 
båì_node
 *
n
;

126 
size_t
 
block_size
;

127 
uöt32_t
 
max_íåõs
;

129 
r
 = 
	`√w_block
(
öfo
, &
b
);

130 i‡(
r
 < 0)

131  
r
;

133 
block_size
 = 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
öfo
->
tm
));

134 
max_íåõs
 = 
	`ˇlc_max_íåõs
(
öfo
->
vÆue_ty≥
.
size
, 
block_size
);

136 
n
 = 
	`dm_block_d©a
(
b
);

137 
	`mem£t
(
n
, 0, 
block_size
);

138 
n
->
hódî
.
Êags
 = 
	`˝u_to_À32
(
LEAF_NODE
);

139 
n
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(0);

140 
n
->
hódî
.
max_íåõs
 = 
	`˝u_to_À32
(max_entries);

141 
n
->
hódî
.
vÆue_size
 = 
	`˝u_to_À32
(
öfo
->
vÆue_ty≥
.
size
);

143 *
roŸ
 = 
	`dm_block_loˇti⁄
(
b
);

144  
	`u∆ock_block
(
öfo
, 
b
);

145 
	}
}

146 
EXPORT_SYMBOL_GPL
(
dm_båì_em±y
);

154 
	#MAX_SPINE_DEPTH
 64

	)

155 
	s‰ame
 {

156 
dm_block
 *
	mb
;

157 
båì_node
 *
	mn
;

158 
	mÀvñ
;

159 
	mƒ_chûdªn
;

160 
	mcuºít_chûd
;

163 
	sdñ_°ack
 {

164 
dm_båì_öfo
 *
	möfo
;

165 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

166 
	mt›
;

167 
‰ame
 
	m•öe
[
MAX_SPINE_DEPTH
];

170 
	$t›_‰ame
(
dñ_°ack
 *
s
, 
‰ame
 **
f
)

172 i‡(
s
->
t›
 < 0) {

173 
	`DMERR
("btree deletion stackÉmpty");

174  -
EINVAL
;

177 *
f
 = 
s
->
•öe
 + s->
t›
;

180 
	}
}

182 
	$u≈ro˚s£d_‰ames
(
dñ_°ack
 *
s
)

184  
s
->
t›
 >= 0;

185 
	}
}

187 
	$¥e„tch_chûdªn
(
dñ_°ack
 *
s
, 
‰ame
 *
f
)

189 
i
;

190 
dm_block_m™agî
 *
bm
 = 
	`dm_tm_gë_bm
(
s
->
tm
);

192 
i
 = 0; i < 
f
->
ƒ_chûdªn
; i++)

193 
	`dm_bm_¥e„tch
(
bm
, 
	`vÆue64
(
f
->
n
, 
i
));

194 
	}
}

196 
boﬁ
 
	$is_öã∫Æ_Àvñ
(
dm_båì_öfo
 *
öfo
, 
‰ame
 *
f
)

198  
f
->
Àvñ
 < (
öfo
->
Àvñs
 - 1);

199 
	}
}

201 
	$push_‰ame
(
dñ_°ack
 *
s
, 
dm_block_t
 
b
, 
Àvñ
)

203 
r
;

204 
uöt32_t
 
ªf_cou¡
;

206 i‡(
s
->
t›
 >
MAX_SPINE_DEPTH
 - 1) {

207 
	`DMERR
("btree deletion stack out of memory");

208  -
ENOMEM
;

211 
r
 = 
	`dm_tm_ªf
(
s
->
tm
, 
b
, &
ªf_cou¡
);

212 i‡(
r
)

213  
r
;

215 i‡(
ªf_cou¡
 > 1)

220 
	`dm_tm_dec
(
s
->
tm
, 
b
);

223 
uöt32_t
 
Êags
;

224 
‰ame
 *
f
 = 
s
->
•öe
 + ++s->
t›
;

226 
r
 = 
	`dm_tm_ªad_lock
(
s
->
tm
, 
b
, &
båì_node_vÆid©‹
, &
f
->b);

227 i‡(
r
) {

228 
s
->
t›
--;

229  
r
;

232 
f
->
n
 = 
	`dm_block_d©a
(f->
b
);

233 
f
->
Àvñ
 =Üevel;

234 
f
->
ƒ_chûdªn
 = 
	`À32_to_˝u
(f->
n
->
hódî
.
ƒ_íåõs
);

235 
f
->
cuºít_chûd
 = 0;

237 
Êags
 = 
	`À32_to_˝u
(
f
->
n
->
hódî
.flags);

238 i‡(
Êags
 & 
INTERNAL_NODE
 || 
	`is_öã∫Æ_Àvñ
(
s
->
öfo
, 
f
))

239 
	`¥e„tch_chûdªn
(
s
, 
f
);

243 
	}
}

245 
	$p›_‰ame
(
dñ_°ack
 *
s
)

247 
‰ame
 *
f
 = 
s
->
•öe
 + s->
t›
--;

249 
	`dm_tm_dec
(
s
->
tm
, 
	`dm_block_loˇti⁄
(
f
->
b
));

250 
	`dm_tm_u∆ock
(
s
->
tm
, 
f
->
b
);

251 
	}
}

253 
	$dm_båì_dñ
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
)

255 
r
;

256 
dñ_°ack
 *
s
;

258 
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

259 i‡(!
s
)

260  -
ENOMEM
;

261 
s
->
öfo
 = info;

262 
s
->
tm
 = 
öfo
->tm;

263 
s
->
t›
 = -1;

265 
r
 = 
	`push_‰ame
(
s
, 
roŸ
, 0);

266 i‡(
r
)

267 
out
;

269 
	`u≈ro˚s£d_‰ames
(
s
)) {

270 
uöt32_t
 
Êags
;

271 
‰ame
 *
f
;

272 
dm_block_t
 
b
;

274 
r
 = 
	`t›_‰ame
(
s
, &
f
);

275 i‡(
r
)

276 
out
;

278 i‡(
f
->
cuºít_chûd
 >f->
ƒ_chûdªn
) {

279 
	`p›_‰ame
(
s
);

283 
Êags
 = 
	`À32_to_˝u
(
f
->
n
->
hódî
.flags);

284 i‡(
Êags
 & 
INTERNAL_NODE
) {

285 
b
 = 
	`vÆue64
(
f
->
n
, f->
cuºít_chûd
);

286 
f
->
cuºít_chûd
++;

287 
r
 = 
	`push_‰ame
(
s
, 
b
, 
f
->
Àvñ
);

288 i‡(
r
)

289 
out
;

291 } i‡(
	`is_öã∫Æ_Àvñ
(
öfo
, 
f
)) {

292 
b
 = 
	`vÆue64
(
f
->
n
, f->
cuºít_chûd
);

293 
f
->
cuºít_chûd
++;

294 
r
 = 
	`push_‰ame
(
s
, 
b
, 
f
->
Àvñ
 + 1);

295 i‡(
r
)

296 
out
;

299 i‡(
öfo
->
vÆue_ty≥
.
dec
) {

300 
i
;

302 
i
 = 0; i < 
f
->
ƒ_chûdªn
; i++)

303 
öfo
->
vÆue_ty≥
.
	`dec
(öfo->vÆue_ty≥.
c⁄ãxt
,

304 
	`vÆue_±r
(
f
->
n
, 
i
));

306 
	`p›_‰ame
(
s
);

310 
out
:

311 
	`k‰ì
(
s
);

312  
r
;

313 
	}
}

314 
EXPORT_SYMBOL_GPL
(
dm_båì_dñ
);

318 
båì_lookup_øw
(
ro_•öe
 *
s
, 
dm_block_t
 
block
, 
uöt64_t
 
key
,

319 (*
£¨ch_‚
)(
båì_node
 *, 
uöt64_t
),

320 
uöt64_t
 *
ªsu…_key
, *
v
, 
size_t
 
vÆue_size
)

322 
i
, 
r
;

323 
uöt32_t
 
Êags
, 
ƒ_íåõs
;

326 
r
 = 
	`ro_°ï
(
s
, 
block
);

327 i‡(
r
 < 0)

328  
r
;

330 
i
 = 
	`£¨ch_‚
(
	`ro_node
(
s
), 
key
);

332 
Êags
 = 
	`À32_to_˝u
(
	`ro_node
(
s
)->
hódî
.flags);

333 
ƒ_íåõs
 = 
	`À32_to_˝u
(
	`ro_node
(
s
)->
hódî
.nr_entries);

334 i‡(
i
 < 0 || i >
ƒ_íåõs
)

335  -
ENODATA
;

337 i‡(
Êags
 & 
INTERNAL_NODE
)

338 
block
 = 
	`vÆue64
(
	`ro_node
(
s
), 
i
);

340 } !(
Êags
 & 
LEAF_NODE
));

342 *
ªsu…_key
 = 
	`À64_to_˝u
(
	`ro_node
(
s
)->
keys
[
i
]);

343 
	`mem˝y
(
v
, 
	`vÆue_±r
(
	`ro_node
(
s
), 
i
), 
vÆue_size
);

346 
	}
}

348 
	$dm_båì_lookup
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

349 
uöt64_t
 *
keys
, *
vÆue_À
)

351 
Àvñ
, 
œ°_Àvñ
 = 
öfo
->
Àvñs
 - 1;

352 
r
 = -
ENODATA
;

353 
uöt64_t
 
rkey
;

354 
__À64
 
öã∫Æ_vÆue_À
;

355 
ro_•öe
 
•öe
;

357 
	`öô_ro_•öe
(&
•öe
, 
öfo
);

358 
Àvñ
 = 0;Üevñ < 
öfo
->
Àvñs
;Üevel++) {

359 
size_t
 
size
;

360 *
vÆue_p
;

362 i‡(
Àvñ
 =
œ°_Àvñ
) {

363 
vÆue_p
 = 
vÆue_À
;

364 
size
 = 
öfo
->
vÆue_ty≥
.size;

367 
vÆue_p
 = &
öã∫Æ_vÆue_À
;

368 
size
 = (
uöt64_t
);

371 
r
 = 
	`båì_lookup_øw
(&
•öe
, 
roŸ
, 
keys
[
Àvñ
],

372 
lowî_bound
, &
rkey
,

373 
vÆue_p
, 
size
);

375 i‡(!
r
) {

376 i‡(
rkey
 !
keys
[
Àvñ
]) {

377 
	`exô_ro_•öe
(&
•öe
);

378  -
ENODATA
;

381 
	`exô_ro_•öe
(&
•öe
);

382  
r
;

385 
roŸ
 = 
	`À64_to_˝u
(
öã∫Æ_vÆue_À
);

387 
	`exô_ro_•öe
(&
•öe
);

389  
r
;

390 
	}
}

391 
EXPORT_SYMBOL_GPL
(
dm_båì_lookup
);

423 
	$båì_•lô_siblög
(
shadow_•öe
 *
s
, 
dm_block_t
 
roŸ
,

424 
∑ª¡_ödex
, 
uöt64_t
 
key
)

426 
r
;

427 
size_t
 
size
;

428 
ƒ_À·
, 
ƒ_right
;

429 
dm_block
 *
À·
, *
right
, *
∑ª¡
;

430 
båì_node
 *
 
, *
∫
, *
≤
;

431 
__À64
 
loˇti⁄
;

433 
À·
 = 
	`shadow_cuºít
(
s
);

435 
r
 = 
	`√w_block
(
s
->
öfo
, &
right
);

436 i‡(
r
 < 0)

437  
r
;

439 
 
 = 
	`dm_block_d©a
(
À·
);

440 
∫
 = 
	`dm_block_d©a
(
right
);

442 
ƒ_À·
 = 
	`À32_to_˝u
(
 
->
hódî
.
ƒ_íåõs
) / 2;

443 
ƒ_right
 = 
	`À32_to_˝u
(
 
->
hódî
.
ƒ_íåõs
Ë- 
ƒ_À·
;

445 
 
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_À·
);

447 
∫
->
hódî
.
Êags
 = 
 
->header.flags;

448 
∫
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_right
);

449 
∫
->
hódî
.
max_íåõs
 = 
 
->header.max_entries;

450 
∫
->
hódî
.
vÆue_size
 = 
 
->header.value_size;

451 
	`mem˝y
(
∫
->
keys
, 
 
->key†+ 
ƒ_À·
, 
ƒ_right
 * (rn->keys[0]));

453 
size
 = 
	`À32_to_˝u
(
 
->
hódî
.
Êags
Ë& 
INTERNAL_NODE
 ?

454 (
uöt64_t
Ë: 
s
->
öfo
->
vÆue_ty≥
.
size
;

455 
	`mem˝y
(
	`vÆue_±r
(
∫
, 0), vÆue_±r(
 
, 
ƒ_À·
),

456 
size
 * 
ƒ_right
);

461 
∑ª¡
 = 
	`shadow_∑ª¡
(
s
);

463 
≤
 = 
	`dm_block_d©a
(
∑ª¡
);

464 
loˇti⁄
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
À·
));

465 
	`__dm_bÀss_f‹_disk
(&
loˇti⁄
);

466 
	`mem˝y_disk
(
	`vÆue_±r
(
≤
, 
∑ª¡_ödex
),

467 &
loˇti⁄
, (
__À64
));

469 
loˇti⁄
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
right
));

470 
	`__dm_bÀss_f‹_disk
(&
loˇti⁄
);

472 
r
 = 
	`ö£π_©
((
__À64
), 
≤
, 
∑ª¡_ödex
 + 1,

473 
	`À64_to_˝u
(
∫
->
keys
[0]), &
loˇti⁄
);

474 i‡(
r
)

475  
r
;

477 i‡(
key
 < 
	`À64_to_˝u
(
∫
->
keys
[0])) {

478 
	`u∆ock_block
(
s
->
öfo
, 
right
);

479 
s
->
nodes
[1] = 
À·
;

481 
	`u∆ock_block
(
s
->
öfo
, 
À·
);

482 
s
->
nodes
[1] = 
right
;

486 
	}
}

509 
	$båì_•lô_bíóth
(
shadow_•öe
 *
s
, 
uöt64_t
 
key
)

511 
r
;

512 
size_t
 
size
;

513 
ƒ_À·
, 
ƒ_right
;

514 
dm_block
 *
À·
, *
right
, *
√w_∑ª¡
;

515 
båì_node
 *
≤
, *
 
, *
∫
;

516 
__À64
 
vÆ
;

518 
√w_∑ª¡
 = 
	`shadow_cuºít
(
s
);

520 
r
 = 
	`√w_block
(
s
->
öfo
, &
À·
);

521 i‡(
r
 < 0)

522  
r
;

524 
r
 = 
	`√w_block
(
s
->
öfo
, &
right
);

525 i‡(
r
 < 0) {

527  
r
;

530 
≤
 = 
	`dm_block_d©a
(
√w_∑ª¡
);

531 
 
 = 
	`dm_block_d©a
(
À·
);

532 
∫
 = 
	`dm_block_d©a
(
right
);

534 
ƒ_À·
 = 
	`À32_to_˝u
(
≤
->
hódî
.
ƒ_íåõs
) / 2;

535 
ƒ_right
 = 
	`À32_to_˝u
(
≤
->
hódî
.
ƒ_íåõs
Ë- 
ƒ_À·
;

537 
 
->
hódî
.
Êags
 = 
≤
->header.flags;

538 
 
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_À·
);

539 
 
->
hódî
.
max_íåõs
 = 
≤
->header.max_entries;

540 
 
->
hódî
.
vÆue_size
 = 
≤
->header.value_size;

542 
∫
->
hódî
.
Êags
 = 
≤
->header.flags;

543 
∫
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(
ƒ_right
);

544 
∫
->
hódî
.
max_íåõs
 = 
≤
->header.max_entries;

545 
∫
->
hódî
.
vÆue_size
 = 
≤
->header.value_size;

547 
	`mem˝y
(
 
->
keys
, 
≤
->keys, 
ƒ_À·
 * (pn->keys[0]));

548 
	`mem˝y
(
∫
->
keys
, 
≤
->key†+ 
ƒ_À·
, 
ƒ_right
 * (pn->keys[0]));

550 
size
 = 
	`À32_to_˝u
(
≤
->
hódî
.
Êags
Ë& 
INTERNAL_NODE
 ?

551 (
__À64
Ë: 
s
->
öfo
->
vÆue_ty≥
.
size
;

552 
	`mem˝y
(
	`vÆue_±r
(
 
, 0), vÆue_±r(
≤
, 0), 
ƒ_À·
 * 
size
);

553 
	`mem˝y
(
	`vÆue_±r
(
∫
, 0), vÆue_±r(
≤
, 
ƒ_À·
),

554 
ƒ_right
 * 
size
);

557 
≤
->
hódî
.
Êags
 = 
	`˝u_to_À32
(
INTERNAL_NODE
);

558 
≤
->
hódî
.
ƒ_íåõs
 = 
	`˝u_to_À32
(2);

559 
≤
->
hódî
.
max_íåõs
 = 
	`˝u_to_À32
(

560 
	`ˇlc_max_íåõs
((
__À64
),

561 
	`dm_bm_block_size
(

562 
	`dm_tm_gë_bm
(
s
->
öfo
->
tm
))));

563 
≤
->
hódî
.
vÆue_size
 = 
	`˝u_to_À32
((
__À64
));

565 
vÆ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
À·
));

566 
	`__dm_bÀss_f‹_disk
(&
vÆ
);

567 
≤
->
keys
[0] = 
 
->keys[0];

568 
	`mem˝y_disk
(
	`vÆue_±r
(
≤
, 0), &
vÆ
, (
__À64
));

570 
vÆ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
right
));

571 
	`__dm_bÀss_f‹_disk
(&
vÆ
);

572 
≤
->
keys
[1] = 
∫
->keys[0];

573 
	`mem˝y_disk
(
	`vÆue_±r
(
≤
, 1), &
vÆ
, (
__À64
));

579 i‡(
s
->
nodes
[0] !
√w_∑ª¡
) {

580 
	`u∆ock_block
(
s
->
öfo
, s->
nodes
[0]);

581 
s
->
nodes
[0] = 
√w_∑ª¡
;

583 i‡(
key
 < 
	`À64_to_˝u
(
∫
->
keys
[0])) {

584 
	`u∆ock_block
(
s
->
öfo
, 
right
);

585 
s
->
nodes
[1] = 
À·
;

587 
	`u∆ock_block
(
s
->
öfo
, 
À·
);

588 
s
->
nodes
[1] = 
right
;

590 
s
->
cou¡
 = 2;

593 
	}
}

595 
	$båì_ö£π_øw
(
shadow_•öe
 *
s
, 
dm_block_t
 
roŸ
,

596 
dm_båì_vÆue_ty≥
 *
vt
,

597 
uöt64_t
 
key
, *
ödex
)

599 
r
, 
i
 = *
ödex
, 
t›
 = 1;

600 
båì_node
 *
node
;

603 
r
 = 
	`shadow_°ï
(
s
, 
roŸ
, 
vt
);

604 i‡(
r
 < 0)

605  
r
;

607 
node
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

614 i‡(
	`shadow_has_∑ª¡
(
s
Ë&& 
i
 >= 0) {

615 
__À64
 
loˇti⁄
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
	`shadow_cuºít
(
s
)));

617 
	`__dm_bÀss_f‹_disk
(&
loˇti⁄
);

618 
	`mem˝y_disk
(
	`vÆue_±r
(
	`dm_block_d©a
(
	`shadow_∑ª¡
(
s
)), 
i
),

619 &
loˇti⁄
, (
__À64
));

622 
node
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

624 i‡(
node
->
hódî
.
ƒ_íåõs
 =node->hódî.
max_íåõs
) {

625 i‡(
t›
)

626 
r
 = 
	`båì_•lô_bíóth
(
s
, 
key
);

628 
r
 = 
	`båì_•lô_siblög
(
s
, 
roŸ
, 
i
, 
key
);

630 i‡(
r
 < 0)

631  
r
;

634 
node
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(
s
));

636 
i
 = 
	`lowî_bound
(
node
, 
key
);

638 i‡(
	`À32_to_˝u
(
node
->
hódî
.
Êags
Ë& 
LEAF_NODE
)

641 i‡(
i
 < 0) {

643 
node
->
keys
[0] = 
	`˝u_to_À64
(
key
);

644 
i
 = 0;

647 
roŸ
 = 
	`vÆue64
(
node
, 
i
);

648 
t›
 = 0;

651 i‡(
i
 < 0 || 
	`À64_to_˝u
(
node
->
keys
[i]Ë!
key
)

652 
i
++;

654 *
ödex
 = 
i
;

656 
	}
}

658 
	$ö£π
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

659 
uöt64_t
 *
keys
, *
vÆue
, 
dm_block_t
 *
√w_roŸ
,

660 *
ö£πed
)

661 
	$__dm_wrôãn_to_disk
(
vÆue
)

663 
r
, 
√ed_ö£π
;

664 
Àvñ
, 
ödex
 = -1, 
œ°_Àvñ
 = 
öfo
->
Àvñs
 - 1;

665 
dm_block_t
 
block
 = 
roŸ
;

666 
shadow_•öe
 
•öe
;

667 
båì_node
 *
n
;

668 
dm_båì_vÆue_ty≥
 
À64_ty≥
;

670 
À64_ty≥
.
c⁄ãxt
 = 
NULL
;

671 
À64_ty≥
.
size
 = (
__À64
);

672 
À64_ty≥
.
öc
 = 
NULL
;

673 
À64_ty≥
.
dec
 = 
NULL
;

674 
À64_ty≥
.
equÆ
 = 
NULL
;

676 
	`öô_shadow_•öe
(&
•öe
, 
öfo
);

678 
Àvñ
 = 0;Üevñ < (
öfo
->
Àvñs
 - 1);Üevel++) {

679 
r
 = 
	`båì_ö£π_øw
(&
•öe
, 
block
, &
À64_ty≥
, 
keys
[
Àvñ
], &
ödex
);

680 i‡(
r
 < 0)

681 
bad
;

683 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(&
•öe
));

684 
√ed_ö£π
 = ((
ödex
 >
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
)) ||

685 (
	`À64_to_˝u
(
n
->
keys
[
ödex
]Ë!keys[
Àvñ
]));

687 i‡(
√ed_ö£π
) {

688 
dm_block_t
 
√w_åì
;

689 
__À64
 
√w_À
;

691 
r
 = 
	`dm_båì_em±y
(
öfo
, &
√w_åì
);

692 i‡(
r
 < 0)

693 
bad
;

695 
√w_À
 = 
	`˝u_to_À64
(
√w_åì
);

696 
	`__dm_bÀss_f‹_disk
(&
√w_À
);

698 
r
 = 
	`ö£π_©
((
uöt64_t
), 
n
, 
ödex
,

699 
keys
[
Àvñ
], &
√w_À
);

700 i‡(
r
)

701 
bad
;

704 i‡(
Àvñ
 < 
œ°_Àvñ
)

705 
block
 = 
	`vÆue64
(
n
, 
ödex
);

708 
r
 = 
	`båì_ö£π_øw
(&
•öe
, 
block
, &
öfo
->
vÆue_ty≥
,

709 
keys
[
Àvñ
], &
ödex
);

710 i‡(
r
 < 0)

711 
bad
;

713 
n
 = 
	`dm_block_d©a
(
	`shadow_cuºít
(&
•öe
));

714 
√ed_ö£π
 = ((
ödex
 >
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
)) ||

715 (
	`À64_to_˝u
(
n
->
keys
[
ödex
]Ë!keys[
Àvñ
]));

717 i‡(
√ed_ö£π
) {

718 i‡(
ö£πed
)

719 *
ö£πed
 = 1;

721 
r
 = 
	`ö£π_©
(
öfo
->
vÆue_ty≥
.
size
, 
n
, 
ödex
,

722 
keys
[
Àvñ
], 
vÆue
);

723 i‡(
r
)

724 
bad_unbÀs£d
;

726 i‡(
ö£πed
)

727 *
ö£πed
 = 0;

729 i‡(
öfo
->
vÆue_ty≥
.
dec
 &&

730 (!
öfo
->
vÆue_ty≥
.
equÆ
 ||

731 !
öfo
->
vÆue_ty≥
.
	`equÆ
(

732 
öfo
->
vÆue_ty≥
.
c⁄ãxt
,

733 
	`vÆue_±r
(
n
, 
ödex
),

734 
vÆue
))) {

735 
öfo
->
vÆue_ty≥
.
	`dec
(öfo->vÆue_ty≥.
c⁄ãxt
,

736 
	`vÆue_±r
(
n
, 
ödex
));

738 
	`mem˝y_disk
(
	`vÆue_±r
(
n
, 
ödex
),

739 
vÆue
, 
öfo
->
vÆue_ty≥
.
size
);

742 *
√w_roŸ
 = 
	`shadow_roŸ
(&
•öe
);

743 
	`exô_shadow_•öe
(&
•öe
);

747 
bad
:

748 
	`__dm_unbÀss_f‹_disk
(
vÆue
);

749 
bad_unbÀs£d
:

750 
	`exô_shadow_•öe
(&
•öe
);

751  
r
;

752 
	}
}

754 
	$dm_båì_ö£π
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

755 
uöt64_t
 *
keys
, *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

756 
	$__dm_wrôãn_to_disk
(
vÆue
)

758  
	`ö£π
(
öfo
, 
roŸ
, 
keys
, 
vÆue
, 
√w_roŸ
, 
NULL
);

759 
	}
}

760 
EXPORT_SYMBOL_GPL
(
dm_båì_ö£π
);

762 
	$dm_båì_ö£π_nŸify
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

763 
uöt64_t
 *
keys
, *
vÆue
, 
dm_block_t
 *
√w_roŸ
,

764 *
ö£πed
)

765 
	$__dm_wrôãn_to_disk
(
vÆue
)

767  
	`ö£π
(
öfo
, 
roŸ
, 
keys
, 
vÆue
, 
√w_roŸ
, 
ö£πed
);

768 
	}
}

769 
EXPORT_SYMBOL_GPL
(
dm_båì_ö£π_nŸify
);

773 
	$föd_key
(
ro_•öe
 *
s
, 
dm_block_t
 
block
, 
boﬁ
 
föd_highe°
,

774 
uöt64_t
 *
ªsu…_key
, 
dm_block_t
 *
√xt_block
)

776 
i
, 
r
;

777 
uöt32_t
 
Êags
;

780 
r
 = 
	`ro_°ï
(
s
, 
block
);

781 i‡(
r
 < 0)

782  
r
;

784 
Êags
 = 
	`À32_to_˝u
(
	`ro_node
(
s
)->
hódî
.flags);

785 
i
 = 
	`À32_to_˝u
(
	`ro_node
(
s
)->
hódî
.
ƒ_íåõs
);

786 i‡(!
i
)

787  -
ENODATA
;

789 
i
--;

791 i‡(
föd_highe°
)

792 *
ªsu…_key
 = 
	`À64_to_˝u
(
	`ro_node
(
s
)->
keys
[
i
]);

794 *
ªsu…_key
 = 
	`À64_to_˝u
(
	`ro_node
(
s
)->
keys
[0]);

796 i‡(
√xt_block
 || 
Êags
 & 
INTERNAL_NODE
)

797 
block
 = 
	`vÆue64
(
	`ro_node
(
s
), 
i
);

799 } 
Êags
 & 
INTERNAL_NODE
);

801 i‡(
√xt_block
)

802 *
√xt_block
 = 
block
;

804 
	}
}

806 
	$dm_båì_föd_key
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

807 
boﬁ
 
föd_highe°
, 
uöt64_t
 *
ªsu…_keys
)

809 
r
 = 0, 
cou¡
 = 0, 
Àvñ
;

810 
ro_•öe
 
•öe
;

812 
	`öô_ro_•öe
(&
•öe
, 
öfo
);

813 
Àvñ
 = 0;Üevñ < 
öfo
->
Àvñs
;Üevel++) {

814 
r
 = 
	`föd_key
(&
•öe
, 
roŸ
, 
föd_highe°
, 
ªsu…_keys
 + 
Àvñ
,

815 
Àvñ
 =
öfo
->
Àvñs
 - 1 ? 
NULL
 : &
roŸ
);

816 i‡(
r
 =-
ENODATA
) {

817 
r
 = 0;

820 } i‡(
r
)

823 
cou¡
++;

825 
	`exô_ro_•öe
(&
•öe
);

827  
r
 ?Ñ : 
cou¡
;

828 
	}
}

830 
	$dm_båì_föd_highe°_key
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

831 
uöt64_t
 *
ªsu…_keys
)

833  
	`dm_båì_föd_key
(
öfo
, 
roŸ
, 
åue
, 
ªsu…_keys
);

834 
	}
}

835 
EXPORT_SYMBOL_GPL
(
dm_båì_föd_highe°_key
);

837 
	$dm_båì_föd_lowe°_key
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

838 
uöt64_t
 *
ªsu…_keys
)

840  
	`dm_båì_föd_key
(
öfo
, 
roŸ
, 
Ál£
, 
ªsu…_keys
);

841 
	}
}

842 
EXPORT_SYMBOL_GPL
(
dm_båì_föd_lowe°_key
);

850 
wÆk_node
(
ro_•öe
 *
s
, 
dm_block_t
 
block
,

851 (*
‚
)(*
c⁄ãxt
, 
uöt64_t
 *
keys
, *
Àaf
),

852 *
c⁄ãxt
)

854 
r
;

855 
i
, 
ƒ
;

856 
båì_node
 *
n
;

857 
uöt64_t
 
keys
;

859 
r
 = 
	`ro_°ï
(
s
, 
block
);

860 
n
 = 
	`ro_node
(
s
);

862 
ƒ
 = 
	`À32_to_˝u
(
n
->
hódî
.
ƒ_íåõs
);

863 
i
 = 0; i < 
ƒ
; i++) {

864 i‡(
	`À32_to_˝u
(
n
->
hódî
.
Êags
Ë& 
INTERNAL_NODE
) {

865 
r
 = 
	`wÆk_node
(
s
, 
	`vÆue64
(
n
, 
i
), 
‚
, 
c⁄ãxt
);

866 i‡(
r
)

867 
out
;

869 
keys
 = 
	`À64_to_˝u
(*
	`key_±r
(
n
, 
i
));

870 
r
 = 
	`‚
(
c⁄ãxt
, &
keys
, 
	`vÆue_±r
(
n
, 
i
));

871 i‡(
r
)

872 
out
;

876 
out
:

877 
	`ro_p›
(
s
);

878  
r
;

879 
	}
}

881 
dm_båì_wÆk
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

882 (*
‚
)(*
c⁄ãxt
, 
uöt64_t
 *
keys
, *
Àaf
),

883 *
c⁄ãxt
)

885 
r
;

886 
ro_•öe
 
•öe
;

888 
	`BUG_ON
(
öfo
->
Àvñs
 > 1);

890 
	`öô_ro_•öe
(&
•öe
, 
öfo
);

891 
r
 = 
	`wÆk_node
(&
•öe
, 
roŸ
, 
‚
, 
c⁄ãxt
);

892 
	`exô_ro_•öe
(&
•öe
);

894  
r
;

895 
	}
}

896 
EXPORT_SYMBOL_GPL
(
dm_båì_wÆk
);

	@persistent-data/dm-btree.h

6 #i‚de‡
_LINUX_DM_BTREE_H


7 
	#_LINUX_DM_BTREE_H


	)

9 
	~"dm-block-m™agî.h
"

11 
	gdm_å™ß˘i⁄_m™agî
;

18 #ifde‡
__CHECKER__


19 
	#__dm_wrôãn_to_disk
(
x
Ë
	`__ªÀa£s
(x)

	)

20 
	#__dm_ªads_‰om_disk
(
x
Ë
	`__acquúes
(x)

	)

21 
	#__dm_bÀss_f‹_disk
(
x
Ë
	`__acquúe
(x)

	)

22 
	#__dm_unbÀss_f‹_disk
(
x
Ë
	`__ªÀa£
(x)

	)

24 
	#__dm_wrôãn_to_disk
(
x
)

	)

25 
	#__dm_ªads_‰om_disk
(
x
)

	)

26 
	#__dm_bÀss_f‹_disk
(
x
)

	)

27 
	#__dm_unbÀss_f‹_disk
(
x
)

	)

40 
	sdm_båì_vÆue_ty≥
 {

41 *
	mc⁄ãxt
;

46 
uöt32_t
 
	msize
;

61 (*
	möc
)(*
	mc⁄ãxt
, c⁄° *
	mvÆue
);

68 (*
	mdec
)(*
	mc⁄ãxt
, c⁄° *
	mvÆue
);

75 (*
	mequÆ
)(*
	mc⁄ãxt
, c⁄° *
	mvÆue1
, c⁄° *
	mvÆue2
);

81 
	sdm_båì_öfo
 {

82 
dm_å™ß˘i⁄_m™agî
 *
	mtm
;

87 
	mÀvñs
;

88 
dm_båì_vÆue_ty≥
 
	mvÆue_ty≥
;

94 
dm_båì_em±y
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 *
roŸ
);

100 
dm_båì_dñ
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
);

109 
dm_båì_lookup
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

110 
uöt64_t
 *
keys
, *
vÆue_À
);

115 
	$dm_båì_ö£π
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

116 
uöt64_t
 *
keys
, *
vÆue
, 
dm_block_t
 *
√w_roŸ
)

117 
	`__dm_wrôãn_to_disk
(
vÆue
);

124 
	$dm_båì_ö£π_nŸify
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

125 
uöt64_t
 *
keys
, *
vÆue
, 
dm_block_t
 *
√w_roŸ
,

126 *
ö£πed
)

127 
	`__dm_wrôãn_to_disk
(
vÆue
);

134 
	`dm_båì_ªmove
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

135 
uöt64_t
 *
keys
, 
dm_block_t
 *
√w_roŸ
);

142 
	`dm_båì_föd_lowe°_key
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

143 
uöt64_t
 *
ªsu…_keys
);

150 
	`dm_båì_föd_highe°_key
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

151 
uöt64_t
 *
ªsu…_keys
);

158 
	`dm_båì_wÆk
(
dm_båì_öfo
 *
öfo
, 
dm_block_t
 
roŸ
,

159 (*
‚
)(*
c⁄ãxt
, 
uöt64_t
 *
keys
, *
Àaf
),

160 *
c⁄ãxt
);

	@persistent-data/dm-persistent-data-internal.h

7 #i‚de‡
_DM_PERSISTENT_DATA_INTERNAL_H


8 
	#_DM_PERSISTENT_DATA_INTERNAL_H


	)

10 
	~"dm-block-m™agî.h
"

12 
ölöe
 
	$dm_hash_block
(
dm_block_t
 
b
, 
hash_mask
)

14 c⁄° 
BIG_PRIME
 = 4294967291UL;

16  (((Ë
b
Ë* 
BIG_PRIME
Ë& 
hash_mask
;

17 
	}
}

	@persistent-data/dm-persistent-data.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

13 
MODULE_INFO
(
öåì
, "Y");

15 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

16 
__u£d


17 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

18 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

19 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

20 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

21 { 0x74dcd98c, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_aux_d©a
) },

22 { 0x9c256008, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_devi˚_size
) },

23 { 0xafbda3f3, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_√w
) },

24 { 0xa82b2066, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_wrôe_dúty_buf„rs
) },

25 { 0x27000b29, 
__VMLINUX_SYMBOL_STR
(
¸c32c
) },

26 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

27 { 0x7c381a76, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_block_size
) },

28 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

29 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

30 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

31 { 0xb138d0bf, 
__VMLINUX_SYMBOL_STR
(
dm_øãlimô_°©e
) },

32 { 0xe6024e59, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªÀa£
) },

33 { 0x486e239f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_¸óã
) },

34 { 0xebcc64a4, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_block_d©a
) },

35 { 0xeˇ7949e, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_˛õ¡_de°roy
) },

36 { 0x6aba7f5e, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_block_numbî
) },

37 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

38 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

39 { 0xa202a8e5, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_‹dî_åa˚
) },

40 { 0x507dÁ5c, 
__VMLINUX_SYMBOL_STR
(
wake_up_¥o˚ss
) },

41 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

42 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

43 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

44 { 0xa1d2413a, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_ªad
) },

45 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

46 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

47 { 0xad0dc4f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_m¨k_buf„r_dúty
) },

48 { 0xcbb1b´2, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë
) },

49 { 0x386e3Ø9, 
__VMLINUX_SYMBOL_STR
(
__put_èsk_°ru˘
) },

50 { 0xa448e19f, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_¥e„tch
) },

51 { 0x6d3f57bd, 
__VMLINUX_SYMBOL_STR
(
dm_bufio_gë_˛õ¡
) },

52 { 0xb0e602eb, 
__VMLINUX_SYMBOL_STR
(
memmove
) },

55 c⁄° 
	g__moduÀ_dïíds
[]

56 
__u£d


57 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

61 
MODULE_INFO
(
§cvîsi⁄
, "176289007C8C55146BC749B");

	@persistent-data/dm-space-map-common.c

7 
	~"dm-•a˚-m≠-comm⁄.h
"

8 
	~"dm-å™ß˘i⁄-m™agî.h
"

10 
	~<löux/bô›s.h
>

11 
	~<löux/devi˚-m≠≥r.h
>

13 
	#DM_MSG_PREFIX
 "•a˚ m≠ comm⁄"

	)

20 
	#INDEX_CSUM_XOR
 160478

	)

22 
	$ödex_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

23 
dm_block
 *
b
,

24 
size_t
 
block_size
)

26 
disk_mëad©a_ödex
 *
mi_À
 = 
	`dm_block_d©a
(
b
);

28 
mi_À
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

29 
mi_À
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&mi_À->
∑ddög
,

30 
block_size
 - (
__À32
),

31 
INDEX_CSUM_XOR
));

32 
	}
}

34 
	$ödex_check
(
dm_block_vÆid©‹
 *
v
,

35 
dm_block
 *
b
,

36 
size_t
 
block_size
)

38 
disk_mëad©a_ödex
 *
mi_À
 = 
	`dm_block_d©a
(
b
);

39 
__À32
 
csum_disk
;

41 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
mi_À
->
blockƒ
)) {

42 
	`DMERR_LIMIT
("index_check failed: blocknr %llu != wanted %llu",

43 
	`À64_to_˝u
(
mi_À
->
blockƒ
), 
	`dm_block_loˇti⁄
(
b
));

44  -
ENOTBLK
;

47 
csum_disk
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
mi_À
->
∑ddög
,

48 
block_size
 - (
__À32
),

49 
INDEX_CSUM_XOR
));

50 i‡(
csum_disk
 !
mi_À
->
csum
) {

51 
	`DMERR_LIMIT
("index_check failed: csum %u != wanted %u",

52 
	`À32_to_˝u
(
csum_disk
),Üe32_to_˝u(
mi_À
->
csum
));

53  -
EILSEQ
;

57 
	}
}

59 
dm_block_vÆid©‹
 
	gödex_vÆid©‹
 = {

60 .
«me
 = "index",

61 .
	g¥ï¨e_f‹_wrôe
 = 
ödex_¥ï¨e_f‹_wrôe
,

62 .
	gcheck
 = 
ödex_check


70 
	#BITMAP_CSUM_XOR
 240779

	)

72 
	$bôm≠_¥ï¨e_f‹_wrôe
(
dm_block_vÆid©‹
 *
v
,

73 
dm_block
 *
b
,

74 
size_t
 
block_size
)

76 
disk_bôm≠_hódî
 *
disk_hódî
 = 
	`dm_block_d©a
(
b
);

78 
disk_hódî
->
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

79 
disk_hódî
->
csum
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&disk_hódî->
nŸ_u£d
,

80 
block_size
 - (
__À32
),

81 
BITMAP_CSUM_XOR
));

82 
	}
}

84 
	$bôm≠_check
(
dm_block_vÆid©‹
 *
v
,

85 
dm_block
 *
b
,

86 
size_t
 
block_size
)

88 
disk_bôm≠_hódî
 *
disk_hódî
 = 
	`dm_block_d©a
(
b
);

89 
__À32
 
csum_disk
;

91 i‡(
	`dm_block_loˇti⁄
(
b
Ë!
	`À64_to_˝u
(
disk_hódî
->
blockƒ
)) {

92 
	`DMERR_LIMIT
("bitmap check failed: blocknr %llu != wanted %llu",

93 
	`À64_to_˝u
(
disk_hódî
->
blockƒ
), 
	`dm_block_loˇti⁄
(
b
));

94  -
ENOTBLK
;

97 
csum_disk
 = 
	`˝u_to_À32
(
	`dm_bm_checksum
(&
disk_hódî
->
nŸ_u£d
,

98 
block_size
 - (
__À32
),

99 
BITMAP_CSUM_XOR
));

100 i‡(
csum_disk
 !
disk_hódî
->
csum
) {

101 
	`DMERR_LIMIT
("bitmap check failed: csum %u != wanted %u",

102 
	`À32_to_˝u
(
csum_disk
),Üe32_to_˝u(
disk_hódî
->
csum
));

103  -
EILSEQ
;

107 
	}
}

109 
dm_block_vÆid©‹
 
	gdm_sm_bôm≠_vÆid©‹
 = {

110 .
«me
 = "sm_bitmap",

111 .
	g¥ï¨e_f‹_wrôe
 = 
bôm≠_¥ï¨e_f‹_wrôe
,

112 .
	gcheck
 = 
bôm≠_check


117 
	#ENTRIES_PER_WORD
 32

	)

118 
	#ENTRIES_SHIFT
 5

	)

120 *
	$dm_bôm≠_d©a
(
dm_block
 *
b
)

122  
	`dm_block_d©a
(
b
Ë+ (
disk_bôm≠_hódî
);

123 
	}
}

125 
	#WORD_MASK_HIGH
 0xAAAAAAAAAAAAAAAAULL

	)

127 
	$bôm≠_w‹d_u£d
(*
addr
, 
b
)

129 
__À64
 *
w‹ds_À
 = 
addr
;

130 
__À64
 *
w_À
 = 
w‹ds_À
 + (
b
 >> 
ENTRIES_SHIFT
);

132 
uöt64_t
 
bôs
 = 
	`À64_to_˝u
(*
w_À
);

133 
uöt64_t
 
mask
 = (
bôs
 + 
WORD_MASK_HIGH
 + 1) & WORD_MASK_HIGH;

135  !(~
bôs
 & 
mask
);

136 
	}
}

138 
	$sm_lookup_bôm≠
(*
addr
, 
b
)

140 
__À64
 *
w‹ds_À
 = 
addr
;

141 
__À64
 *
w_À
 = 
w‹ds_À
 + (
b
 >> 
ENTRIES_SHIFT
);

142 
hi
, 
lo
;

144 
b
 = (b & (
ENTRIES_PER_WORD
 - 1)) << 1;

145 
hi
 = !!
	`ã°_bô_À
(
b
, (*Ë
w_À
);

146 
lo
 = !!
	`ã°_bô_À
(
b
 + 1, (*Ë
w_À
);

147  (
hi
 << 1Ë| 
lo
;

148 
	}
}

150 
	$sm_£t_bôm≠
(*
addr
, 
b
, 
vÆ
)

152 
__À64
 *
w‹ds_À
 = 
addr
;

153 
__À64
 *
w_À
 = 
w‹ds_À
 + (
b
 >> 
ENTRIES_SHIFT
);

155 
b
 = (b & (
ENTRIES_PER_WORD
 - 1)) << 1;

157 i‡(
vÆ
 & 2)

158 
	`__£t_bô_À
(
b
, (*Ë
w_À
);

160 
	`__˛ór_bô_À
(
b
, (*Ë
w_À
);

162 i‡(
vÆ
 & 1)

163 
	`__£t_bô_À
(
b
 + 1, (*Ë
w_À
);

165 
	`__˛ór_bô_À
(
b
 + 1, (*Ë
w_À
);

166 
	}
}

168 
	$sm_föd_‰ì
(*
addr
, 
begö
, 
íd
,

169 *
ªsu…
)

171 
begö
 < 
íd
) {

172 i‡(!(
begö
 & (
ENTRIES_PER_WORD
 - 1)) &&

173 
	`bôm≠_w‹d_u£d
(
addr
, 
begö
)) {

174 
begö
 +
ENTRIES_PER_WORD
;

178 i‡(!
	`sm_lookup_bôm≠
(
addr
, 
begö
)) {

179 *
ªsu…
 = 
begö
;

183 
begö
++;

186  -
ENOSPC
;

187 
	}
}

191 
	$sm_Œ_öô
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
)

193 
Œ
->
tm
 =Åm;

195 
Œ
->
bôm≠_öfo
.
tm
 =Åm;

196 
Œ
->
bôm≠_öfo
.
Àvñs
 = 1;

203 
Œ
->
bôm≠_öfo
.
vÆue_ty≥
.
size
 = (
disk_ödex_íåy
);

204 
Œ
->
bôm≠_öfo
.
vÆue_ty≥
.
öc
 = 
NULL
;

205 
Œ
->
bôm≠_öfo
.
vÆue_ty≥
.
dec
 = 
NULL
;

206 
Œ
->
bôm≠_öfo
.
vÆue_ty≥
.
equÆ
 = 
NULL
;

208 
Œ
->
ªf_cou¡_öfo
.
tm
 =Åm;

209 
Œ
->
ªf_cou¡_öfo
.
Àvñs
 = 1;

210 
Œ
->
ªf_cou¡_öfo
.
vÆue_ty≥
.
size
 = (
uöt32_t
);

211 
Œ
->
ªf_cou¡_öfo
.
vÆue_ty≥
.
öc
 = 
NULL
;

212 
Œ
->
ªf_cou¡_öfo
.
vÆue_ty≥
.
dec
 = 
NULL
;

213 
Œ
->
ªf_cou¡_öfo
.
vÆue_ty≥
.
equÆ
 = 
NULL
;

215 
Œ
->
block_size
 = 
	`dm_bm_block_size
(
	`dm_tm_gë_bm
(
tm
));

217 i‡(
Œ
->
block_size
 > (1 << 30)) {

218 
	`DMERR
("block sizeÅoo bigÅo hold bitmaps");

219  -
EINVAL
;

222 
Œ
->
íåõs_≥r_block
 = (Œ->
block_size
 - (
disk_bôm≠_hódî
)) *

223 
ENTRIES_PER_BYTE
;

224 
Œ
->
ƒ_blocks
 = 0;

225 
Œ
->
bôm≠_roŸ
 = 0;

226 
Œ
->
ªf_cou¡_roŸ
 = 0;

227 
Œ
->
bôm≠_ödex_ch™ged
 = 
Ál£
;

230 
	}
}

232 
	$sm_Œ_exãnd
(
Œ_disk
 *
Œ
, 
dm_block_t
 
exåa_blocks
)

234 
r
;

235 
dm_block_t
 
i
, 
ƒ_blocks
, 
ƒ_ödexes
;

236 
ﬁd_blocks
, 
blocks
;

238 
ƒ_blocks
 = 
Œ
->ƒ_block†+ 
exåa_blocks
;

239 
ﬁd_blocks
 = 
	`dm_£˘‹_div_up
(
Œ
->
ƒ_blocks
,Ül->
íåõs_≥r_block
);

240 
blocks
 = 
	`dm_£˘‹_div_up
(
ƒ_blocks
, 
Œ
->
íåõs_≥r_block
);

242 
ƒ_ödexes
 = 
	`dm_£˘‹_div_up
(
ƒ_blocks
, 
Œ
->
íåõs_≥r_block
);

243 i‡(
ƒ_ödexes
 > 
Œ
->
	`max_íåõs
(ll)) {

244 
	`DMERR
("space mapÅooÜarge");

245  -
EINVAL
;

251 
Œ
->
ƒ_blocks
 =Çr_blocks;

252 
i
 = 
ﬁd_blocks
; i < 
blocks
; i++) {

253 
dm_block
 *
b
;

254 
disk_ödex_íåy
 
idx
;

256 
r
 = 
	`dm_tm_√w_block
(
Œ
->
tm
, &
dm_sm_bôm≠_vÆid©‹
, &
b
);

257 i‡(
r
 < 0)

258  
r
;

260 
idx
.
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
b
));

262 
r
 = 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
b
);

263 i‡(
r
 < 0)

264  
r
;

266 
idx
.
ƒ_‰ì
 = 
	`˝u_to_À32
(
Œ
->
íåõs_≥r_block
);

267 
idx
.
n⁄e_‰ì_bef‹e
 = 0;

269 
r
 = 
Œ
->
	`ßve_õ
÷l, 
i
, &
idx
);

270 i‡(
r
 < 0)

271  
r
;

275 
	}
}

277 
	$sm_Œ_lookup_bôm≠
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
)

279 
r
;

280 
dm_block_t
 
ödex
 = 
b
;

281 
disk_ödex_íåy
 
õ_disk
;

282 
dm_block
 *
blk
;

284 
b
 = 
	`do_div
(
ödex
, 
Œ
->
íåõs_≥r_block
);

285 
r
 = 
Œ
->
	`lﬂd_õ
÷l, 
ödex
, &
õ_disk
);

286 i‡(
r
 < 0)

287  
r
;

289 
r
 = 
	`dm_tm_ªad_lock
(
Œ
->
tm
, 
	`À64_to_˝u
(
õ_disk
.
blockƒ
),

290 &
dm_sm_bôm≠_vÆid©‹
, &
blk
);

291 i‡(
r
 < 0)

292  
r
;

294 *
ªsu…
 = 
	`sm_lookup_bôm≠
(
	`dm_bôm≠_d©a
(
blk
), 
b
);

296  
	`dm_tm_u∆ock
(
Œ
->
tm
, 
blk
);

297 
	}
}

299 
	$sm_Œ_lookup_big_ªf_cou¡
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
,

300 
uöt32_t
 *
ªsu…
)

302 
__À32
 
À_rc
;

303 
r
;

305 
r
 = 
	`dm_båì_lookup
(&
Œ
->
ªf_cou¡_öfo
,Ül->
ªf_cou¡_roŸ
, &
b
, &
À_rc
);

306 i‡(
r
 < 0)

307  
r
;

309 *
ªsu…
 = 
	`À32_to_˝u
(
À_rc
);

311  
r
;

312 
	}
}

314 
	$sm_Œ_lookup
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
)

316 
r
 = 
	`sm_Œ_lookup_bôm≠
(
Œ
, 
b
, 
ªsu…
);

318 i‡(
r
)

319  
r
;

321 i‡(*
ªsu…
 != 3)

322  
r
;

324  
	`sm_Œ_lookup_big_ªf_cou¡
(
Œ
, 
b
, 
ªsu…
);

325 
	}
}

327 
	$sm_Œ_föd_‰ì_block
(
Œ_disk
 *
Œ
, 
dm_block_t
 
begö
,

328 
dm_block_t
 
íd
, dm_block_à*
ªsu…
)

330 
r
;

331 
disk_ödex_íåy
 
õ_disk
;

332 
dm_block_t
 
i
, 
ödex_begö
 = 
begö
;

333 
dm_block_t
 
ödex_íd
 = 
	`dm_£˘‹_div_up
(
íd
, 
Œ
->
íåõs_≥r_block
);

338 
begö
 = 
	`do_div
(
ödex_begö
, 
Œ
->
íåõs_≥r_block
);

339 
íd
 = 
	`do_div
”nd, 
Œ
->
íåõs_≥r_block
);

341 
i
 = 
ödex_begö
; i < 
ödex_íd
; i++, 
begö
 = 0) {

342 
dm_block
 *
blk
;

343 
posôi⁄
;

344 
uöt32_t
 
bô_íd
;

346 
r
 = 
Œ
->
	`lﬂd_õ
÷l, 
i
, &
õ_disk
);

347 i‡(
r
 < 0)

348  
r
;

350 i‡(
	`À32_to_˝u
(
õ_disk
.
ƒ_‰ì
) == 0)

353 
r
 = 
	`dm_tm_ªad_lock
(
Œ
->
tm
, 
	`À64_to_˝u
(
õ_disk
.
blockƒ
),

354 &
dm_sm_bôm≠_vÆid©‹
, &
blk
);

355 i‡(
r
 < 0)

356  
r
;

358 
bô_íd
 = (
i
 =
ödex_íd
 - 1Ë? 
íd
 : 
Œ
->
íåõs_≥r_block
;

360 
r
 = 
	`sm_föd_‰ì
(
	`dm_bôm≠_d©a
(
blk
),

361 
	`max_t
(, 
begö
, 
	`À32_to_˝u
(
õ_disk
.
n⁄e_‰ì_bef‹e
)),

362 
bô_íd
, &
posôi⁄
);

363 i‡(
r
 =-
ENOSPC
) {

368 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
blk
);

371 } i‡(
r
 < 0) {

372 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
blk
);

373  
r
;

376 
r
 = 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
blk
);

377 i‡(
r
 < 0)

378  
r
;

380 *
ªsu…
 = 
i
 * 
Œ
->
íåõs_≥r_block
 + (
dm_block_t
Ë
posôi⁄
;

384  -
ENOSPC
;

385 
	}
}

387 
sm_Œ_muèã
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
,

388 (*
muèt‹
)(*
c⁄ãxt
, 
uöt32_t
 
ﬁd
, uöt32_à*
√w
),

389 *
c⁄ãxt
, 
Æloˇti⁄_evít
 *
ev
)

391 
r
;

392 
uöt32_t
 
bô
, 
ﬁd
, 
ªf_cou¡
;

393 
dm_block
 *
nb
;

394 
dm_block_t
 
ödex
 = 
b
;

395 
disk_ödex_íåy
 
õ_disk
;

396 *
bm_À
;

397 
öc
;

399 
bô
 = 
	`do_div
(
ödex
, 
Œ
->
íåõs_≥r_block
);

400 
r
 = 
Œ
->
	`lﬂd_õ
÷l, 
ödex
, &
õ_disk
);

401 i‡(
r
 < 0)

402  
r
;

404 
r
 = 
	`dm_tm_shadow_block
(
Œ
->
tm
, 
	`À64_to_˝u
(
õ_disk
.
blockƒ
),

405 &
dm_sm_bôm≠_vÆid©‹
, &
nb
, &
öc
);

406 i‡(
r
 < 0) {

407 
	`DMERR
("dm_tm_shadow_block() failed");

408  
r
;

410 
õ_disk
.
blockƒ
 = 
	`˝u_to_À64
(
	`dm_block_loˇti⁄
(
nb
));

412 
bm_À
 = 
	`dm_bôm≠_d©a
(
nb
);

413 
ﬁd
 = 
	`sm_lookup_bôm≠
(
bm_À
, 
bô
);

415 i‡(
ﬁd
 > 2) {

416 
r
 = 
	`sm_Œ_lookup_big_ªf_cou¡
(
Œ
, 
b
, &
ﬁd
);

417 i‡(
r
 < 0) {

418 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
nb
);

419  
r
;

423 
r
 = 
	`muèt‹
(
c⁄ãxt
, 
ﬁd
, &
ªf_cou¡
);

424 i‡(
r
) {

425 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
nb
);

426  
r
;

429 i‡(
ªf_cou¡
 <= 2) {

430 
	`sm_£t_bôm≠
(
bm_À
, 
bô
, 
ªf_cou¡
);

432 
r
 = 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
nb
);

433 i‡(
r
 < 0)

434  
r
;

436 i‡(
ﬁd
 > 2) {

437 
r
 = 
	`dm_båì_ªmove
(&
Œ
->
ªf_cou¡_öfo
,

438 
Œ
->
ªf_cou¡_roŸ
,

439 &
b
, &
Œ
->
ªf_cou¡_roŸ
);

440 i‡(
r
)

441  
r
;

445 
__À32
 
À_rc
 = 
	`˝u_to_À32
(
ªf_cou¡
);

447 
	`sm_£t_bôm≠
(
bm_À
, 
bô
, 3);

448 
r
 = 
	`dm_tm_u∆ock
(
Œ
->
tm
, 
nb
);

449 i‡(
r
 < 0)

450  
r
;

452 
	`__dm_bÀss_f‹_disk
(&
À_rc
);

453 
r
 = 
	`dm_båì_ö£π
(&
Œ
->
ªf_cou¡_öfo
,Ül->
ªf_cou¡_roŸ
,

454 &
b
, &
À_rc
, &
Œ
->
ªf_cou¡_roŸ
);

455 i‡(
r
 < 0) {

456 
	`DMERR
("ref count insert failed");

457  
r
;

461 i‡(
ªf_cou¡
 && !
ﬁd
) {

462 *
ev
 = 
SM_ALLOC
;

463 
Œ
->
ƒ_Æloˇãd
++;

464 
	`À32_add_˝u
(&
õ_disk
.
ƒ_‰ì
, -1);

465 i‡(
	`À32_to_˝u
(
õ_disk
.
n⁄e_‰ì_bef‹e
Ë=
bô
)

466 
õ_disk
.
n⁄e_‰ì_bef‹e
 = 
	`˝u_to_À32
(
bô
 + 1);

468 } i‡(
ﬁd
 && !
ªf_cou¡
) {

469 *
ev
 = 
SM_FREE
;

470 
Œ
->
ƒ_Æloˇãd
--;

471 
	`À32_add_˝u
(&
õ_disk
.
ƒ_‰ì
, 1);

472 
õ_disk
.
n⁄e_‰ì_bef‹e
 = 
	`˝u_to_À32
(
	`mö
(
	`À32_to_˝u
(õ_disk.n⁄e_‰ì_bef‹e), 
bô
));

475  
Œ
->
	`ßve_õ
÷l, 
ödex
, &
õ_disk
);

476 
	}
}

478 
	$£t_ªf_cou¡
(*
c⁄ãxt
, 
uöt32_t
 
ﬁd
, uöt32_à*
√w
)

480 *
√w
 = *((
uöt32_t
 *Ë
c⁄ãxt
);

482 
	}
}

484 
	$sm_Œ_ö£π
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
,

485 
uöt32_t
 
ªf_cou¡
, 
Æloˇti⁄_evít
 *
ev
)

487  
	`sm_Œ_muèã
(
Œ
, 
b
, 
£t_ªf_cou¡
, &
ªf_cou¡
, 
ev
);

488 
	}
}

490 
	$öc_ªf_cou¡
(*
c⁄ãxt
, 
uöt32_t
 
ﬁd
, uöt32_à*
√w
)

492 *
√w
 = 
ﬁd
 + 1;

494 
	}
}

496 
	$sm_Œ_öc
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
Æloˇti⁄_evít
 *
ev
)

498  
	`sm_Œ_muèã
(
Œ
, 
b
, 
öc_ªf_cou¡
, 
NULL
, 
ev
);

499 
	}
}

501 
	$dec_ªf_cou¡
(*
c⁄ãxt
, 
uöt32_t
 
ﬁd
, uöt32_à*
√w
)

503 i‡(!
ﬁd
) {

504 
	`DMERR_LIMIT
("unableÅo decrementáÑeference count below 0");

505  -
EINVAL
;

508 *
√w
 = 
ﬁd
 - 1;

510 
	}
}

512 
	$sm_Œ_dec
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
Æloˇti⁄_evít
 *
ev
)

514  
	`sm_Œ_muèã
(
Œ
, 
b
, 
dec_ªf_cou¡
, 
NULL
, 
ev
);

515 
	}
}

517 
	$sm_Œ_commô
(
Œ_disk
 *
Œ
)

519 
r
 = 0;

521 i‡(
Œ
->
bôm≠_ödex_ch™ged
) {

522 
r
 = 
Œ
->
	`commô
(ll);

523 i‡(!
r
)

524 
Œ
->
bôm≠_ödex_ch™ged
 = 
Ál£
;

527  
r
;

528 
	}
}

532 
	$mëad©a_Œ_lﬂd_õ
(
Œ_disk
 *
Œ
, 
dm_block_t
 
ödex
,

533 
disk_ödex_íåy
 *
õ
)

535 
	`mem˝y
(
õ
, 
Œ
->
mi_À
.
ödex
 + index, (*ie));

537 
	}
}

539 
	$mëad©a_Œ_ßve_õ
(
Œ_disk
 *
Œ
, 
dm_block_t
 
ödex
,

540 
disk_ödex_íåy
 *
õ
)

542 
Œ
->
bôm≠_ödex_ch™ged
 = 
åue
;

543 
	`mem˝y
(
Œ
->
mi_À
.
ödex
 + index, 
õ
, (*ie));

545 
	}
}

547 
	$mëad©a_Œ_öô_ödex
(
Œ_disk
 *
Œ
)

549 
r
;

550 
dm_block
 *
b
;

552 
r
 = 
	`dm_tm_√w_block
(
Œ
->
tm
, &
ödex_vÆid©‹
, &
b
);

553 i‡(
r
 < 0)

554  
r
;

556 
	`mem˝y
(
	`dm_block_d©a
(
b
), &
Œ
->
mi_À
, (ll->mi_le));

557 
Œ
->
bôm≠_roŸ
 = 
	`dm_block_loˇti⁄
(
b
);

559  
	`dm_tm_u∆ock
(
Œ
->
tm
, 
b
);

560 
	}
}

562 
	$mëad©a_Œ_›í
(
Œ_disk
 *
Œ
)

564 
r
;

565 
dm_block
 *
block
;

567 
r
 = 
	`dm_tm_ªad_lock
(
Œ
->
tm
,Ül->
bôm≠_roŸ
,

568 &
ödex_vÆid©‹
, &
block
);

569 i‡(
r
)

570  
r
;

572 
	`mem˝y
(&
Œ
->
mi_À
, 
	`dm_block_d©a
(
block
), (ll->mi_le));

573  
	`dm_tm_u∆ock
(
Œ
->
tm
, 
block
);

574 
	}
}

576 
dm_block_t
 
	$mëad©a_Œ_max_íåõs
(
Œ_disk
 *
Œ
)

578  
MAX_METADATA_BITMAPS
;

579 
	}
}

581 
	$mëad©a_Œ_commô
(
Œ_disk
 *
Œ
)

583 
r
, 
öc
;

584 
dm_block
 *
b
;

586 
r
 = 
	`dm_tm_shadow_block
(
Œ
->
tm
,Ül->
bôm≠_roŸ
, &
ödex_vÆid©‹
, &
b
, &
öc
);

587 i‡(
r
)

588  
r
;

590 
	`mem˝y
(
	`dm_block_d©a
(
b
), &
Œ
->
mi_À
, (ll->mi_le));

591 
Œ
->
bôm≠_roŸ
 = 
	`dm_block_loˇti⁄
(
b
);

593  
	`dm_tm_u∆ock
(
Œ
->
tm
, 
b
);

594 
	}
}

596 
	$sm_Œ_√w_mëad©a
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
)

598 
r
;

600 
r
 = 
	`sm_Œ_öô
(
Œ
, 
tm
);

601 i‡(
r
 < 0)

602  
r
;

604 
Œ
->
lﬂd_õ
 = 
mëad©a_Œ_lﬂd_õ
;

605 
Œ
->
ßve_õ
 = 
mëad©a_Œ_ßve_õ
;

606 
Œ
->
öô_ödex
 = 
mëad©a_Œ_öô_ödex
;

607 
Œ
->
›í_ödex
 = 
mëad©a_Œ_›í
;

608 
Œ
->
max_íåõs
 = 
mëad©a_Œ_max_íåõs
;

609 
Œ
->
commô
 = 
mëad©a_Œ_commô
;

611 
Œ
->
ƒ_blocks
 = 0;

612 
Œ
->
ƒ_Æloˇãd
 = 0;

614 
r
 = 
Œ
->
	`öô_ödex
(ll);

615 i‡(
r
 < 0)

616  
r
;

618 
r
 = 
	`dm_båì_em±y
(&
Œ
->
ªf_cou¡_öfo
, &Œ->
ªf_cou¡_roŸ
);

619 i‡(
r
 < 0)

620  
r
;

623 
	}
}

625 
	$sm_Œ_›í_mëad©a
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
,

626 *
roŸ_À
, 
size_t
 
Àn
)

628 
r
;

629 
disk_sm_roŸ
 *
smr
 = 
roŸ_À
;

631 i‡(
Àn
 < (
disk_sm_roŸ
)) {

632 
	`DMERR
("sm_metadataÑootÅoo small");

633  -
ENOMEM
;

636 
r
 = 
	`sm_Œ_öô
(
Œ
, 
tm
);

637 i‡(
r
 < 0)

638  
r
;

640 
Œ
->
lﬂd_õ
 = 
mëad©a_Œ_lﬂd_õ
;

641 
Œ
->
ßve_õ
 = 
mëad©a_Œ_ßve_õ
;

642 
Œ
->
öô_ödex
 = 
mëad©a_Œ_öô_ödex
;

643 
Œ
->
›í_ödex
 = 
mëad©a_Œ_›í
;

644 
Œ
->
max_íåõs
 = 
mëad©a_Œ_max_íåõs
;

645 
Œ
->
commô
 = 
mëad©a_Œ_commô
;

647 
Œ
->
ƒ_blocks
 = 
	`À64_to_˝u
(
smr
->nr_blocks);

648 
Œ
->
ƒ_Æloˇãd
 = 
	`À64_to_˝u
(
smr
->nr_allocated);

649 
Œ
->
bôm≠_roŸ
 = 
	`À64_to_˝u
(
smr
->bitmap_root);

650 
Œ
->
ªf_cou¡_roŸ
 = 
	`À64_to_˝u
(
smr
->ref_count_root);

652  
Œ
->
	`›í_ödex
(ll);

653 
	}
}

657 
	$disk_Œ_lﬂd_õ
(
Œ_disk
 *
Œ
, 
dm_block_t
 
ödex
,

658 
disk_ödex_íåy
 *
õ
)

660  
	`dm_båì_lookup
(&
Œ
->
bôm≠_öfo
,Ül->
bôm≠_roŸ
, &
ödex
, 
õ
);

661 
	}
}

663 
	$disk_Œ_ßve_õ
(
Œ_disk
 *
Œ
, 
dm_block_t
 
ödex
,

664 
disk_ödex_íåy
 *
õ
)

666 
	`__dm_bÀss_f‹_disk
(
õ
);

667  
	`dm_båì_ö£π
(&
Œ
->
bôm≠_öfo
,Ül->
bôm≠_roŸ
,

668 &
ödex
, 
õ
, &
Œ
->
bôm≠_roŸ
);

669 
	}
}

671 
	$disk_Œ_öô_ödex
(
Œ_disk
 *
Œ
)

673  
	`dm_båì_em±y
(&
Œ
->
bôm≠_öfo
, &Œ->
bôm≠_roŸ
);

674 
	}
}

676 
	$disk_Œ_›í
(
Œ_disk
 *
Œ
)

680 
	}
}

682 
dm_block_t
 
	$disk_Œ_max_íåõs
(
Œ_disk
 *
Œ
)

685 
	}
}

687 
	$disk_Œ_commô
(
Œ_disk
 *
Œ
)

690 
	}
}

692 
	$sm_Œ_√w_disk
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
)

694 
r
;

696 
r
 = 
	`sm_Œ_öô
(
Œ
, 
tm
);

697 i‡(
r
 < 0)

698  
r
;

700 
Œ
->
lﬂd_õ
 = 
disk_Œ_lﬂd_õ
;

701 
Œ
->
ßve_õ
 = 
disk_Œ_ßve_õ
;

702 
Œ
->
öô_ödex
 = 
disk_Œ_öô_ödex
;

703 
Œ
->
›í_ödex
 = 
disk_Œ_›í
;

704 
Œ
->
max_íåõs
 = 
disk_Œ_max_íåõs
;

705 
Œ
->
commô
 = 
disk_Œ_commô
;

707 
Œ
->
ƒ_blocks
 = 0;

708 
Œ
->
ƒ_Æloˇãd
 = 0;

710 
r
 = 
Œ
->
	`öô_ödex
(ll);

711 i‡(
r
 < 0)

712  
r
;

714 
r
 = 
	`dm_båì_em±y
(&
Œ
->
ªf_cou¡_öfo
, &Œ->
ªf_cou¡_roŸ
);

715 i‡(
r
 < 0)

716  
r
;

719 
	}
}

721 
	$sm_Œ_›í_disk
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
,

722 *
roŸ_À
, 
size_t
 
Àn
)

724 
r
;

725 
disk_sm_roŸ
 *
smr
 = 
roŸ_À
;

727 i‡(
Àn
 < (
disk_sm_roŸ
)) {

728 
	`DMERR
("sm_metadataÑootÅoo small");

729  -
ENOMEM
;

732 
r
 = 
	`sm_Œ_öô
(
Œ
, 
tm
);

733 i‡(
r
 < 0)

734  
r
;

736 
Œ
->
lﬂd_õ
 = 
disk_Œ_lﬂd_õ
;

737 
Œ
->
ßve_õ
 = 
disk_Œ_ßve_õ
;

738 
Œ
->
öô_ödex
 = 
disk_Œ_öô_ödex
;

739 
Œ
->
›í_ödex
 = 
disk_Œ_›í
;

740 
Œ
->
max_íåõs
 = 
disk_Œ_max_íåõs
;

741 
Œ
->
commô
 = 
disk_Œ_commô
;

743 
Œ
->
ƒ_blocks
 = 
	`À64_to_˝u
(
smr
->nr_blocks);

744 
Œ
->
ƒ_Æloˇãd
 = 
	`À64_to_˝u
(
smr
->nr_allocated);

745 
Œ
->
bôm≠_roŸ
 = 
	`À64_to_˝u
(
smr
->bitmap_root);

746 
Œ
->
ªf_cou¡_roŸ
 = 
	`À64_to_˝u
(
smr
->ref_count_root);

748  
Œ
->
	`›í_ödex
(ll);

749 
	}
}

	@persistent-data/dm-space-map-common.h

7 #i‚de‡
DM_SPACE_MAP_COMMON_H


8 
	#DM_SPACE_MAP_COMMON_H


	)

10 
	~"dm-båì.h
"

32 
	sdisk_ödex_íåy
 {

33 
__À64
 
	mblockƒ
;

34 
__À32
 
	mƒ_‰ì
;

35 
__À32
 
	mn⁄e_‰ì_bef‹e
;

36 } 
	g__∑cked
;

39 
	#MAX_METADATA_BITMAPS
 255

	)

40 
	sdisk_mëad©a_ödex
 {

41 
__À32
 
	mcsum
;

42 
__À32
 
	m∑ddög
;

43 
__À64
 
	mblockƒ
;

45 
disk_ödex_íåy
 
	mödex
[
MAX_METADATA_BITMAPS
];

46 } 
	g__∑cked
;

48 
	gŒ_disk
;

50 (*
	tlﬂd_õ_‚
)(
	tŒ_disk
 *
	tŒ
, 
	tdm_block_t
 
	tödex
, 
	tdisk_ödex_íåy
 *
	tªsu…
);

51 (*
	tßve_õ_‚
)(
	tŒ_disk
 *
	tŒ
, 
	tdm_block_t
 
	tödex
, 
	tdisk_ödex_íåy
 *
	tõ
);

52 (*
	töô_ödex_‚
)(
	tŒ_disk
 *
	tŒ
);

53 (*
	t›í_ödex_‚
)(
	tŒ_disk
 *
	tŒ
);

54 
	$dm_block_t
 (*
	tmax_ödex_íåõs_‚
)(
	tŒ_disk
 *
	tŒ
);

55 (*
	tcommô_‚
)(
	tŒ_disk
 *
	tŒ
);

57 
	sŒ_disk
 {

58 
dm_å™ß˘i⁄_m™agî
 *
tm
;

59 
dm_båì_öfo
 
bôm≠_öfo
;

60 
dm_båì_öfo
 
ªf_cou¡_öfo
;

62 
uöt32_t
 
block_size
;

63 
uöt32_t
 
íåõs_≥r_block
;

64 
dm_block_t
 
ƒ_blocks
;

65 
dm_block_t
 
ƒ_Æloˇãd
;

70 
dm_block_t
 
bôm≠_roŸ
;

72 
dm_block_t
 
ªf_cou¡_roŸ
;

74 
disk_mëad©a_ödex
 
mi_À
;

75 
lﬂd_õ_‚
 
lﬂd_õ
;

76 
ßve_õ_‚
 
ßve_õ
;

77 
öô_ödex_‚
 
öô_ödex
;

78 
›í_ödex_‚
 
›í_ödex
;

79 
max_ödex_íåõs_‚
 
max_íåõs
;

80 
commô_‚
 
commô
;

81 
boﬁ
 
bôm≠_ödex_ch™ged
:1;

84 
	sdisk_sm_roŸ
 {

85 
__À64
 
ƒ_blocks
;

86 
__À64
 
ƒ_Æloˇãd
;

87 
__À64
 
bôm≠_roŸ
;

88 
__À64
 
ªf_cou¡_roŸ
;

89 } 
__∑cked
;

91 
	#ENTRIES_PER_BYTE
 4

	)

93 
	sdisk_bôm≠_hódî
 {

94 
__À32
 
csum
;

95 
__À32
 
nŸ_u£d
;

96 
__À64
 
blockƒ
;

97 } 
__∑cked
;

99 
	eÆloˇti⁄_evít
 {

100 
SM_NONE
,

101 
SM_ALLOC
,

102 
SM_FREE
,

107 
	`sm_Œ_exãnd
(
Œ_disk
 *
Œ
, 
dm_block_t
 
exåa_blocks
);

108 
	`sm_Œ_lookup_bôm≠
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
);

109 
	`sm_Œ_lookup
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
);

110 
	`sm_Œ_föd_‰ì_block
(
Œ_disk
 *
Œ
, 
dm_block_t
 
begö
,

111 
dm_block_t
 
íd
, dm_block_à*
ªsu…
);

112 
	`sm_Œ_ö£π
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
uöt32_t
 
ªf_cou¡
, 
Æloˇti⁄_evít
 *
ev
);

113 
	`sm_Œ_öc
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
Æloˇti⁄_evít
 *
ev
);

114 
	`sm_Œ_dec
(
Œ_disk
 *
Œ
, 
dm_block_t
 
b
, 
Æloˇti⁄_evít
 *
ev
);

115 
	`sm_Œ_commô
(
Œ_disk
 *
Œ
);

117 
	`sm_Œ_√w_mëad©a
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
);

118 
	`sm_Œ_›í_mëad©a
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
,

119 *
roŸ_À
, 
size_t
 
Àn
);

121 
	`sm_Œ_√w_disk
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
);

122 
	`sm_Œ_›í_disk
(
Œ_disk
 *
Œ
, 
dm_å™ß˘i⁄_m™agî
 *
tm
,

123 *
roŸ_À
, 
size_t
 
Àn
);

	@persistent-data/dm-space-map-disk.c

7 
	~"dm-•a˚-m≠-comm⁄.h
"

8 
	~"dm-•a˚-m≠-disk.h
"

9 
	~"dm-•a˚-m≠.h
"

10 
	~"dm-å™ß˘i⁄-m™agî.h
"

12 
	~<löux/li°.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/exp‹t.h
>

15 
	~<löux/devi˚-m≠≥r.h
>

17 
	#DM_MSG_PREFIX
 "•a˚ m≠ disk"

	)

24 
	ssm_disk
 {

25 
dm_•a˚_m≠
 
	msm
;

27 
Œ_disk
 
	mŒ
;

28 
Œ_disk
 
	mﬁd_Œ
;

30 
dm_block_t
 
	mbegö
;

31 
dm_block_t
 
	mƒ_Æloˇãd_this_å™ß˘i⁄
;

34 
	$sm_disk_de°roy
(
dm_•a˚_m≠
 *
sm
)

36 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

38 
	`k‰ì
(
smd
);

39 
	}
}

41 
	$sm_disk_exãnd
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
)

43 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

45  
	`sm_Œ_exãnd
(&
smd
->
Œ
, 
exåa_blocks
);

46 
	}
}

48 
	$sm_disk_gë_ƒ_blocks
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

50 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

51 *
cou¡
 = 
smd
->
ﬁd_Œ
.
ƒ_blocks
;

54 
	}
}

56 
	$sm_disk_gë_ƒ_‰ì
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

58 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

59 *
cou¡
 = (
smd
->
ﬁd_Œ
.
ƒ_blocks
 - smd->ﬁd_Œ.
ƒ_Æloˇãd
Ë- smd->
ƒ_Æloˇãd_this_å™ß˘i⁄
;

62 
	}
}

64 
	$sm_disk_gë_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

65 
uöt32_t
 *
ªsu…
)

67 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

68  
	`sm_Œ_lookup
(&
smd
->
Œ
, 
b
, 
ªsu…
);

69 
	}
}

71 
	$sm_disk_cou¡_is_m‹e_th™_⁄e
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

72 *
ªsu…
)

74 
r
;

75 
uöt32_t
 
cou¡
;

77 
r
 = 
	`sm_disk_gë_cou¡
(
sm
, 
b
, &
cou¡
);

78 i‡(
r
)

79  
r
;

81  
cou¡
 > 1;

82 
	}
}

84 
	$sm_disk_£t_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

85 
uöt32_t
 
cou¡
)

87 
r
;

88 
uöt32_t
 
ﬁd_cou¡
;

89 
Æloˇti⁄_evít
 
ev
;

90 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

92 
r
 = 
	`sm_Œ_ö£π
(&
smd
->
Œ
, 
b
, 
cou¡
, &
ev
);

93 i‡(!
r
) {

94 
ev
) {

95 
SM_NONE
:

98 
SM_ALLOC
:

103 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
++;

106 
SM_FREE
:

111 
r
 = 
	`sm_Œ_lookup
(&
smd
->
ﬁd_Œ
, 
b
, &
ﬁd_cou¡
);

112 i‡(
r
)

113  
r
;

115 i‡(!
ﬁd_cou¡
)

116 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
--;

121  
r
;

122 
	}
}

124 
	$sm_disk_öc_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

126 
r
;

127 
Æloˇti⁄_evít
 
ev
;

128 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

130 
r
 = 
	`sm_Œ_öc
(&
smd
->
Œ
, 
b
, &
ev
);

131 i‡(!
r
 && (
ev
 =
SM_ALLOC
))

136 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
++;

138  
r
;

139 
	}
}

141 
	$sm_disk_dec_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

143 
Æloˇti⁄_evít
 
ev
;

144 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

146  
	`sm_Œ_dec
(&
smd
->
Œ
, 
b
, &
ev
);

147 
	}
}

149 
	$sm_disk_√w_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
)

151 
r
;

152 
Æloˇti⁄_evít
 
ev
;

153 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

156 
r
 = 
	`sm_Œ_föd_‰ì_block
(&
smd
->
ﬁd_Œ
, smd->
begö
, smd->ﬁd_Œ.
ƒ_blocks
, 
b
);

157 i‡(
r
)

158  
r
;

160 
smd
->
begö
 = *
b
 + 1;

161 
r
 = 
	`sm_Œ_öc
(&
smd
->
Œ
, *
b
, &
ev
);

162 i‡(!
r
) {

163 
	`BUG_ON
(
ev
 !
SM_ALLOC
);

164 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
++;

167  
r
;

168 
	}
}

170 
	$sm_disk_commô
(
dm_•a˚_m≠
 *
sm
)

172 
r
;

173 
dm_block_t
 
ƒ_‰ì
;

174 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

176 
r
 = 
	`sm_disk_gë_ƒ_‰ì
(
sm
, &
ƒ_‰ì
);

177 i‡(
r
)

178  
r
;

180 
r
 = 
	`sm_Œ_commô
(&
smd
->
Œ
);

181 i‡(
r
)

182  
r
;

184 
	`mem˝y
(&
smd
->
ﬁd_Œ
, &smd->
Œ
, (smd->old_ll));

185 
smd
->
begö
 = 0;

186 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
 = 0;

188 
r
 = 
	`sm_disk_gë_ƒ_‰ì
(
sm
, &
ƒ_‰ì
);

189 i‡(
r
)

190  
r
;

193 
	}
}

195 
	$sm_disk_roŸ_size
(
dm_•a˚_m≠
 *
sm
, 
size_t
 *
ªsu…
)

197 *
ªsu…
 = (
disk_sm_roŸ
);

200 
	}
}

202 
	$sm_disk_c›y_roŸ
(
dm_•a˚_m≠
 *
sm
, *
whîe_À
, 
size_t
 
max
)

204 
sm_disk
 *
smd
 = 
	`c⁄èöî_of
(
sm
, sm_disk, sm);

205 
disk_sm_roŸ
 
roŸ_À
;

207 
roŸ_À
.
ƒ_blocks
 = 
	`˝u_to_À64
(
smd
->
Œ
.nr_blocks);

208 
roŸ_À
.
ƒ_Æloˇãd
 = 
	`˝u_to_À64
(
smd
->
Œ
.nr_allocated);

209 
roŸ_À
.
bôm≠_roŸ
 = 
	`˝u_to_À64
(
smd
->
Œ
.bitmap_root);

210 
roŸ_À
.
ªf_cou¡_roŸ
 = 
	`˝u_to_À64
(
smd
->
Œ
.ref_count_root);

212 i‡(
max
 < (
roŸ_À
))

213  -
ENOSPC
;

215 
	`mem˝y
(
whîe_À
, &
roŸ_À
, (root_le));

218 
	}
}

222 
dm_•a˚_m≠
 
	g›s
 = {

223 .
de°roy
 = 
sm_disk_de°roy
,

224 .
	gexãnd
 = 
sm_disk_exãnd
,

225 .
	ggë_ƒ_blocks
 = 
sm_disk_gë_ƒ_blocks
,

226 .
	ggë_ƒ_‰ì
 = 
sm_disk_gë_ƒ_‰ì
,

227 .
	ggë_cou¡
 = 
sm_disk_gë_cou¡
,

228 .
	gcou¡_is_m‹e_th™_⁄e
 = 
sm_disk_cou¡_is_m‹e_th™_⁄e
,

229 .
	g£t_cou¡
 = 
sm_disk_£t_cou¡
,

230 .
	göc_block
 = 
sm_disk_öc_block
,

231 .
	gdec_block
 = 
sm_disk_dec_block
,

232 .
	g√w_block
 = 
sm_disk_√w_block
,

233 .
	gcommô
 = 
sm_disk_commô
,

234 .
	groŸ_size
 = 
sm_disk_roŸ_size
,

235 .
	gc›y_roŸ
 = 
sm_disk_c›y_roŸ
,

236 .
	gªgi°î_thªshﬁd_ˇŒback
 = 
NULL


239 
dm_•a˚_m≠
 *
	$dm_sm_disk_¸óã
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

240 
dm_block_t
 
ƒ_blocks
)

242 
r
;

243 
sm_disk
 *
smd
;

245 
smd
 = 
	`kmÆloc
((*smd), 
GFP_KERNEL
);

246 i‡(!
smd
)

247  
	`ERR_PTR
(-
ENOMEM
);

249 
smd
->
begö
 = 0;

250 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
 = 0;

251 
	`mem˝y
(&
smd
->
sm
, &
›s
, (smd->sm));

253 
r
 = 
	`sm_Œ_√w_disk
(&
smd
->
Œ
, 
tm
);

254 i‡(
r
)

255 
bad
;

257 
r
 = 
	`sm_Œ_exãnd
(&
smd
->
Œ
, 
ƒ_blocks
);

258 i‡(
r
)

259 
bad
;

261 
r
 = 
	`sm_disk_commô
(&
smd
->
sm
);

262 i‡(
r
)

263 
bad
;

265  &
smd
->
sm
;

267 
bad
:

268 
	`k‰ì
(
smd
);

269  
	`ERR_PTR
(
r
);

270 
	}
}

271 
EXPORT_SYMBOL_GPL
(
dm_sm_disk_¸óã
);

273 
dm_•a˚_m≠
 *
	$dm_sm_disk_›í
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

274 *
roŸ_À
, 
size_t
 
Àn
)

276 
r
;

277 
sm_disk
 *
smd
;

279 
smd
 = 
	`kmÆloc
((*smd), 
GFP_KERNEL
);

280 i‡(!
smd
)

281  
	`ERR_PTR
(-
ENOMEM
);

283 
smd
->
begö
 = 0;

284 
smd
->
ƒ_Æloˇãd_this_å™ß˘i⁄
 = 0;

285 
	`mem˝y
(&
smd
->
sm
, &
›s
, (smd->sm));

287 
r
 = 
	`sm_Œ_›í_disk
(&
smd
->
Œ
, 
tm
, 
roŸ_À
, 
Àn
);

288 i‡(
r
)

289 
bad
;

291 
r
 = 
	`sm_disk_commô
(&
smd
->
sm
);

292 i‡(
r
)

293 
bad
;

295  &
smd
->
sm
;

297 
bad
:

298 
	`k‰ì
(
smd
);

299  
	`ERR_PTR
(
r
);

300 
	}
}

301 
EXPORT_SYMBOL_GPL
(
dm_sm_disk_›í
);

	@persistent-data/dm-space-map-disk.h

7 #i‚de‡
_LINUX_DM_SPACE_MAP_DISK_H


8 
	#_LINUX_DM_SPACE_MAP_DISK_H


	)

10 
	~"dm-block-m™agî.h
"

12 
	gdm_•a˚_m≠
;

13 
	gdm_å™ß˘i⁄_m™agî
;

19 
dm_•a˚_m≠
 *
dm_sm_disk_¸óã
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

20 
dm_block_t
 
ƒ_blocks
);

22 
dm_•a˚_m≠
 *
dm_sm_disk_›í
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

23 *
roŸ
, 
size_t
 
Àn
);

	@persistent-data/dm-space-map-metadata.c

7 
	~"dm-•a˚-m≠.h
"

8 
	~"dm-•a˚-m≠-comm⁄.h
"

9 
	~"dm-•a˚-m≠-mëad©a.h
"

11 
	~<löux/li°.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/devi˚-m≠≥r.h
>

15 
	#DM_MSG_PREFIX
 "•a˚ m≠ mëad©a"

	)

22 
	sthªshﬁd
 {

23 
boﬁ
 
	mthªshﬁd_£t
;

24 
boﬁ
 
	mvÆue_£t
;

25 
dm_block_t
 
	mthªshﬁd
;

26 
dm_block_t
 
	mcuºít_vÆue
;

27 
dm_sm_thªshﬁd_‚
 
	m‚
;

28 *
	mc⁄ãxt
;

31 
	$thªshﬁd_öô
(
thªshﬁd
 *
t
)

33 
t
->
thªshﬁd_£t
 = 
Ál£
;

34 
t
->
vÆue_£t
 = 
Ál£
;

35 
	}
}

37 
	$£t_thªshﬁd
(
thªshﬁd
 *
t
, 
dm_block_t
 
vÆue
,

38 
dm_sm_thªshﬁd_‚
 
‚
, *
c⁄ãxt
)

40 
t
->
thªshﬁd_£t
 = 
åue
;

41 
t
->
thªshﬁd
 = 
vÆue
;

42 
t
->
‚
 = fn;

43 
t
->
c⁄ãxt
 = context;

44 
	}
}

46 
boﬁ
 
	$bñow_thªshﬁd
(
thªshﬁd
 *
t
, 
dm_block_t
 
vÆue
)

48  
t
->
thªshﬁd_£t
 && 
vÆue
 <t->
thªshﬁd
;

49 
	}
}

51 
boﬁ
 
	$thªshﬁd_Æªady_åiggîed
(
thªshﬁd
 *
t
)

53  
t
->
vÆue_£t
 && 
	`bñow_thªshﬁd
—,Å->
cuºít_vÆue
);

54 
	}
}

56 
	$check_thªshﬁd
(
thªshﬁd
 *
t
, 
dm_block_t
 
vÆue
)

58 i‡(
	`bñow_thªshﬁd
(
t
, 
vÆue
) &&

59 !
	`thªshﬁd_Æªady_åiggîed
(
t
))

60 
t
->
	`‚
—->
c⁄ãxt
);

62 
t
->
vÆue_£t
 = 
åue
;

63 
t
->
cuºít_vÆue
 = 
vÆue
;

64 
	}
}

82 
	#MAX_RECURSIVE_ALLOCATIONS
 1024

	)

84 
	eblock_›_ty≥
 {

85 
	mBOP_INC
,

86 
	mBOP_DEC


89 
	sblock_›
 {

90 
block_›_ty≥
 
	mty≥
;

91 
dm_block_t
 
	mblock
;

94 
	sb›_rög_buf„r
 {

95 
	mbegö
;

96 
	míd
;

97 
block_›
 
	mb›s
[
MAX_RECURSIVE_ALLOCATIONS
 + 1];

100 
	$brb_öô
(
b›_rög_buf„r
 *
brb
)

102 
brb
->
begö
 = 0;

103 
brb
->
íd
 = 0;

104 
	}
}

106 
boﬁ
 
	$brb_em±y
(
b›_rög_buf„r
 *
brb
)

108  
brb
->
begö
 =brb->
íd
;

109 
	}
}

111 
	$brb_√xt
(
b›_rög_buf„r
 *
brb
, 
ﬁd
)

113 
r
 = 
ﬁd
 + 1;

114  (
r
 >((
brb
->
b›s
) / (*brb->bops))) ? 0 :Ñ;

115 
	}
}

117 
	$brb_push
(
b›_rög_buf„r
 *
brb
,

118 
block_›_ty≥
 
ty≥
, 
dm_block_t
 
b
)

120 
block_›
 *
b›
;

121 
√xt
 = 
	`brb_√xt
(
brb
, brb->
íd
);

127 i‡(
√xt
 =
brb
->
begö
)

128  -
ENOMEM
;

130 
b›
 = 
brb
->
b›s
 + brb->
íd
;

131 
b›
->
ty≥
 =Åype;

132 
b›
->
block
 = 
b
;

134 
brb
->
íd
 = 
√xt
;

137 
	}
}

139 
	$brb_p›
(
b›_rög_buf„r
 *
brb
, 
block_›
 *
ªsu…
)

141 
block_›
 *
b›
;

143 i‡(
	`brb_em±y
(
brb
))

144  -
ENODATA
;

146 
b›
 = 
brb
->
b›s
 + brb->
begö
;

147 
ªsu…
->
ty≥
 = 
b›
->type;

148 
ªsu…
->
block
 = 
b›
->block;

150 
brb
->
begö
 = 
	`brb_√xt
(brb, brb->begin);

153 
	}
}

157 
	ssm_mëad©a
 {

158 
dm_•a˚_m≠
 
	msm
;

160 
Œ_disk
 
	mŒ
;

161 
Œ_disk
 
	mﬁd_Œ
;

163 
dm_block_t
 
	mbegö
;

165 
	mªcursi⁄_cou¡
;

166 
	mÆloˇãd_this_å™ß˘i⁄
;

167 
b›_rög_buf„r
 
	muncommôãd
;

169 
thªshﬁd
 
	mthªshﬁd
;

172 
	$add_b›
(
sm_mëad©a
 *
smm
, 
block_›_ty≥
 
ty≥
, 
dm_block_t
 
b
)

174 
r
 = 
	`brb_push
(&
smm
->
uncommôãd
, 
ty≥
, 
b
);

176 i‡(
r
) {

177 
	`DMERR
("too manyÑecursiveállocations");

178  -
ENOMEM
;

182 
	}
}

184 
	$commô_b›
(
sm_mëad©a
 *
smm
, 
block_›
 *
›
)

186 
r
 = 0;

187 
Æloˇti⁄_evít
 
ev
;

189 
›
->
ty≥
) {

190 
BOP_INC
:

191 
r
 = 
	`sm_Œ_öc
(&
smm
->
Œ
, 
›
->
block
, &
ev
);

194 
BOP_DEC
:

195 
r
 = 
	`sm_Œ_dec
(&
smm
->
Œ
, 
›
->
block
, &
ev
);

199  
r
;

200 
	}
}

202 
	$ö
(
sm_mëad©a
 *
smm
)

204 
smm
->
ªcursi⁄_cou¡
++;

205 
	}
}

207 
	$out
(
sm_mëad©a
 *
smm
)

209 
r
 = 0;

214 i‡(!
smm
->
ªcursi⁄_cou¡
) {

215 
	`DMERR
("lostÅrack ofÑecursion depth");

216  -
ENOMEM
;

219 i‡(
smm
->
ªcursi⁄_cou¡
 == 1) {

220 !
	`brb_em±y
(&
smm
->
uncommôãd
)) {

221 
block_›
 
b›
;

223 
r
 = 
	`brb_p›
(&
smm
->
uncommôãd
, &
b›
);

224 i‡(
r
) {

225 
	`DMERR
("bug in bopÑing buffer");

229 
r
 = 
	`commô_b›
(
smm
, &
b›
);

230 i‡(
r
)

235 
smm
->
ªcursi⁄_cou¡
--;

237  
r
;

238 
	}
}

245 
	$comböe_îr‹s
(
r1
, 
r2
)

247  
r1
 ?Ñ1 : 
r2
;

248 
	}
}

250 
	$ªcursög
(
sm_mëad©a
 *
smm
)

252  
smm
->
ªcursi⁄_cou¡
;

253 
	}
}

255 
	$sm_mëad©a_de°roy
(
dm_•a˚_m≠
 *
sm
)

257 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

259 
	`k‰ì
(
smm
);

260 
	}
}

262 
	$sm_mëad©a_gë_ƒ_blocks
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

264 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

266 *
cou¡
 = 
smm
->
Œ
.
ƒ_blocks
;

269 
	}
}

271 
	$sm_mëad©a_gë_ƒ_‰ì
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

273 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

275 *
cou¡
 = 
smm
->
ﬁd_Œ
.
ƒ_blocks
 - smm->ﬁd_Œ.
ƒ_Æloˇãd
 -

276 
smm
->
Æloˇãd_this_å™ß˘i⁄
;

279 
	}
}

281 
	$sm_mëad©a_gë_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

282 
uöt32_t
 *
ªsu…
)

284 
r
;

285 
i
;

286 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

287 
adju°mít
 = 0;

293 
i
 = 
smm
->
uncommôãd
.
begö
;

294 
i
 !
smm
->
uncommôãd
.
íd
;

295 
i
 = 
	`brb_√xt
(&
smm
->
uncommôãd
, i)) {

296 
block_›
 *
›
 = 
smm
->
uncommôãd
.
b›s
 + 
i
;

298 i‡(
›
->
block
 !
b
)

301 
›
->
ty≥
) {

302 
BOP_INC
:

303 
adju°mít
++;

306 
BOP_DEC
:

307 
adju°mít
--;

312 
r
 = 
	`sm_Œ_lookup
(&
smm
->
Œ
, 
b
, 
ªsu…
);

313 i‡(
r
)

314  
r
;

316 *
ªsu…
 +
adju°mít
;

319 
	}
}

321 
	$sm_mëad©a_cou¡_is_m‹e_th™_⁄e
(
dm_•a˚_m≠
 *
sm
,

322 
dm_block_t
 
b
, *
ªsu…
)

324 
r
, 
adju°mít
 = 0;

325 
i
;

326 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

327 
uöt32_t
 
rc
;

333 
i
 = 
smm
->
uncommôãd
.
begö
;

334 
i
 !
smm
->
uncommôãd
.
íd
;

335 
i
 = 
	`brb_√xt
(&
smm
->
uncommôãd
, i)) {

337 
block_›
 *
›
 = 
smm
->
uncommôãd
.
b›s
 + 
i
;

339 i‡(
›
->
block
 !
b
)

342 
›
->
ty≥
) {

343 
BOP_INC
:

344 
adju°mít
++;

347 
BOP_DEC
:

348 
adju°mít
--;

353 i‡(
adju°mít
 > 1) {

354 *
ªsu…
 = 1;

358 
r
 = 
	`sm_Œ_lookup_bôm≠
(&
smm
->
Œ
, 
b
, &
rc
);

359 i‡(
r
)

360  
r
;

362 i‡(
rc
 == 3)

366 *
ªsu…
 = 1;

368 *
ªsu…
 = 
rc
 + 
adju°mít
 > 1;

371 
	}
}

373 
	$sm_mëad©a_£t_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

374 
uöt32_t
 
cou¡
)

376 
r
, 
r2
;

377 
Æloˇti⁄_evít
 
ev
;

378 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

380 i‡(
smm
->
ªcursi⁄_cou¡
) {

381 
	`DMERR
("cannotÑecurse set_count()");

382  -
EINVAL
;

385 
	`ö
(
smm
);

386 
r
 = 
	`sm_Œ_ö£π
(&
smm
->
Œ
, 
b
, 
cou¡
, &
ev
);

387 
r2
 = 
	`out
(
smm
);

389  
	`comböe_îr‹s
(
r
, 
r2
);

390 
	}
}

392 
	$sm_mëad©a_öc_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

394 
r
, 
r2
 = 0;

395 
Æloˇti⁄_evít
 
ev
;

396 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

398 i‡(
	`ªcursög
(
smm
))

399 
r
 = 
	`add_b›
(
smm
, 
BOP_INC
, 
b
);

401 
	`ö
(
smm
);

402 
r
 = 
	`sm_Œ_öc
(&
smm
->
Œ
, 
b
, &
ev
);

403 
r2
 = 
	`out
(
smm
);

406  
	`comböe_îr‹s
(
r
, 
r2
);

407 
	}
}

409 
	$sm_mëad©a_dec_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

411 
r
, 
r2
 = 0;

412 
Æloˇti⁄_evít
 
ev
;

413 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

415 i‡(
	`ªcursög
(
smm
))

416 
r
 = 
	`add_b›
(
smm
, 
BOP_DEC
, 
b
);

418 
	`ö
(
smm
);

419 
r
 = 
	`sm_Œ_dec
(&
smm
->
Œ
, 
b
, &
ev
);

420 
r2
 = 
	`out
(
smm
);

423  
	`comböe_îr‹s
(
r
, 
r2
);

424 
	}
}

426 
	$sm_mëad©a_√w_block_
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
)

428 
r
, 
r2
 = 0;

429 
Æloˇti⁄_evít
 
ev
;

430 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

432 
r
 = 
	`sm_Œ_föd_‰ì_block
(&
smm
->
ﬁd_Œ
, smm->
begö
, smm->ﬁd_Œ.
ƒ_blocks
, 
b
);

433 i‡(
r
)

434  
r
;

436 
smm
->
begö
 = *
b
 + 1;

438 i‡(
	`ªcursög
(
smm
))

439 
r
 = 
	`add_b›
(
smm
, 
BOP_INC
, *
b
);

441 
	`ö
(
smm
);

442 
r
 = 
	`sm_Œ_öc
(&
smm
->
Œ
, *
b
, &
ev
);

443 
r2
 = 
	`out
(
smm
);

446 i‡(!
r
)

447 
smm
->
Æloˇãd_this_å™ß˘i⁄
++;

449  
	`comböe_îr‹s
(
r
, 
r2
);

450 
	}
}

452 
	$sm_mëad©a_√w_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
)

454 
dm_block_t
 
cou¡
;

455 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

457 
r
 = 
	`sm_mëad©a_√w_block_
(
sm
, 
b
);

458 i‡(
r
) {

459 
	`DMERR_LIMIT
("unableÅoállocateÇew metadata block");

460  
r
;

463 
r
 = 
	`sm_mëad©a_gë_ƒ_‰ì
(
sm
, &
cou¡
);

464 i‡(
r
) {

465 
	`DMERR_LIMIT
("couldn't get free block count");

466  
r
;

469 
	`check_thªshﬁd
(&
smm
->
thªshﬁd
, 
cou¡
);

471  
r
;

472 
	}
}

474 
	$sm_mëad©a_commô
(
dm_•a˚_m≠
 *
sm
)

476 
r
;

477 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

479 
r
 = 
	`sm_Œ_commô
(&
smm
->
Œ
);

480 i‡(
r
)

481  
r
;

483 
	`mem˝y
(&
smm
->
ﬁd_Œ
, &smm->
Œ
, (smm->old_ll));

484 
smm
->
begö
 = 0;

485 
smm
->
Æloˇãd_this_å™ß˘i⁄
 = 0;

488 
	}
}

490 
	$sm_mëad©a_ªgi°î_thªshﬁd_ˇŒback
(
dm_•a˚_m≠
 *
sm
,

491 
dm_block_t
 
thªshﬁd
,

492 
dm_sm_thªshﬁd_‚
 
‚
,

493 *
c⁄ãxt
)

495 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

497 
	`£t_thªshﬁd
(&
smm
->
thªshﬁd
,Åhªshﬁd, 
‚
, 
c⁄ãxt
);

500 
	}
}

502 
	$sm_mëad©a_roŸ_size
(
dm_•a˚_m≠
 *
sm
, 
size_t
 *
ªsu…
)

504 *
ªsu…
 = (
disk_sm_roŸ
);

507 
	}
}

509 
	$sm_mëad©a_c›y_roŸ
(
dm_•a˚_m≠
 *
sm
, *
whîe_À
, 
size_t
 
max
)

511 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

512 
disk_sm_roŸ
 
roŸ_À
;

514 
roŸ_À
.
ƒ_blocks
 = 
	`˝u_to_À64
(
smm
->
Œ
.nr_blocks);

515 
roŸ_À
.
ƒ_Æloˇãd
 = 
	`˝u_to_À64
(
smm
->
Œ
.nr_allocated);

516 
roŸ_À
.
bôm≠_roŸ
 = 
	`˝u_to_À64
(
smm
->
Œ
.bitmap_root);

517 
roŸ_À
.
ªf_cou¡_roŸ
 = 
	`˝u_to_À64
(
smm
->
Œ
.ref_count_root);

519 i‡(
max
 < (
roŸ_À
))

520  -
ENOSPC
;

522 
	`mem˝y
(
whîe_À
, &
roŸ_À
, (root_le));

525 
	}
}

527 
sm_mëad©a_exãnd
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
);

529 
dm_•a˚_m≠
 
	g›s
 = {

530 .
de°roy
 = 
sm_mëad©a_de°roy
,

531 .
	gexãnd
 = 
sm_mëad©a_exãnd
,

532 .
	ggë_ƒ_blocks
 = 
sm_mëad©a_gë_ƒ_blocks
,

533 .
	ggë_ƒ_‰ì
 = 
sm_mëad©a_gë_ƒ_‰ì
,

534 .
	ggë_cou¡
 = 
sm_mëad©a_gë_cou¡
,

535 .
	gcou¡_is_m‹e_th™_⁄e
 = 
sm_mëad©a_cou¡_is_m‹e_th™_⁄e
,

536 .
	g£t_cou¡
 = 
sm_mëad©a_£t_cou¡
,

537 .
	göc_block
 = 
sm_mëad©a_öc_block
,

538 .
	gdec_block
 = 
sm_mëad©a_dec_block
,

539 .
	g√w_block
 = 
sm_mëad©a_√w_block
,

540 .
	gcommô
 = 
sm_mëad©a_commô
,

541 .
	groŸ_size
 = 
sm_mëad©a_roŸ_size
,

542 .
	gc›y_roŸ
 = 
sm_mëad©a_c›y_roŸ
,

543 .
	gªgi°î_thªshﬁd_ˇŒback
 = 
sm_mëad©a_ªgi°î_thªshﬁd_ˇŒback


552 
	$sm_boŸ°øp_de°roy
(
dm_•a˚_m≠
 *
sm
)

554 
	}
}

556 
	$sm_boŸ°øp_exãnd
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
)

558 
	`DMERR
("bootstrap doesn't supportÉxtend");

560  -
EINVAL
;

561 
	}
}

563 
	$sm_boŸ°øp_gë_ƒ_blocks
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

565 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

567  
smm
->
Œ
.
ƒ_blocks
;

568 
	}
}

570 
	$sm_boŸ°øp_gë_ƒ_‰ì
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

572 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

574 *
cou¡
 = 
smm
->
Œ
.
ƒ_blocks
 - smm->
begö
;

577 
	}
}

579 
	$sm_boŸ°øp_gë_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

580 
uöt32_t
 *
ªsu…
)

582 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

584  
b
 < 
smm
->
begö
 ? 1 : 0;

585 
	}
}

587 
	$sm_boŸ°øp_cou¡_is_m‹e_th™_⁄e
(
dm_•a˚_m≠
 *
sm
,

588 
dm_block_t
 
b
, *
ªsu…
)

590 *
ªsu…
 = 0;

593 
	}
}

595 
	$sm_boŸ°øp_£t_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

596 
uöt32_t
 
cou¡
)

598 
	`DMERR
("bootstrap doesn't support set_count");

600  -
EINVAL
;

601 
	}
}

603 
	$sm_boŸ°øp_√w_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
)

605 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

610 i‡(
smm
->
begö
 =smm->
Œ
.
ƒ_blocks
)

611  -
ENOSPC
;

613 *
b
 = 
smm
->
begö
++;

616 
	}
}

618 
	$sm_boŸ°øp_öc_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

620 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

622  
	`add_b›
(
smm
, 
BOP_INC
, 
b
);

623 
	}
}

625 
	$sm_boŸ°øp_dec_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

627 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

629  
	`add_b›
(
smm
, 
BOP_DEC
, 
b
);

630 
	}
}

632 
	$sm_boŸ°øp_commô
(
dm_•a˚_m≠
 *
sm
)

635 
	}
}

637 
	$sm_boŸ°øp_roŸ_size
(
dm_•a˚_m≠
 *
sm
, 
size_t
 *
ªsu…
)

639 
	`DMERR
("bootstrap doesn't supportÑoot_size");

641  -
EINVAL
;

642 
	}
}

644 
	$sm_boŸ°øp_c›y_roŸ
(
dm_•a˚_m≠
 *
sm
, *
whîe
,

645 
size_t
 
max
)

647 
	`DMERR
("bootstrap doesn't support copy_root");

649  -
EINVAL
;

650 
	}
}

652 
dm_•a˚_m≠
 
	gboŸ°øp_›s
 = {

653 .
de°roy
 = 
sm_boŸ°øp_de°roy
,

654 .
	gexãnd
 = 
sm_boŸ°øp_exãnd
,

655 .
	ggë_ƒ_blocks
 = 
sm_boŸ°øp_gë_ƒ_blocks
,

656 .
	ggë_ƒ_‰ì
 = 
sm_boŸ°øp_gë_ƒ_‰ì
,

657 .
	ggë_cou¡
 = 
sm_boŸ°øp_gë_cou¡
,

658 .
	gcou¡_is_m‹e_th™_⁄e
 = 
sm_boŸ°øp_cou¡_is_m‹e_th™_⁄e
,

659 .
	g£t_cou¡
 = 
sm_boŸ°øp_£t_cou¡
,

660 .
	göc_block
 = 
sm_boŸ°øp_öc_block
,

661 .
	gdec_block
 = 
sm_boŸ°øp_dec_block
,

662 .
	g√w_block
 = 
sm_boŸ°øp_√w_block
,

663 .
	gcommô
 = 
sm_boŸ°øp_commô
,

664 .
	groŸ_size
 = 
sm_boŸ°øp_roŸ_size
,

665 .
	gc›y_roŸ
 = 
sm_boŸ°øp_c›y_roŸ
,

666 .
	gªgi°î_thªshﬁd_ˇŒback
 = 
NULL


671 
	$sm_mëad©a_exãnd
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
)

673 
r
, 
i
;

674 
Æloˇti⁄_evít
 
ev
;

675 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

676 
dm_block_t
 
ﬁd_Àn
 = 
smm
->
Œ
.
ƒ_blocks
;

681 
smm
->
begö
 = 
ﬁd_Àn
;

682 
	`mem˝y
(
sm
, &
boŸ°øp_›s
, (*sm));

687 
r
 = 
	`sm_Œ_exãnd
(&
smm
->
Œ
, 
exåa_blocks
);

688 i‡(
r
)

689 
out
;

696 
i
 = 
ﬁd_Àn
; !
r
 && i < 
smm
->
begö
; i++) {

697 
r
 = 
	`sm_Œ_öc
(&
smm
->
Œ
, 
i
, &
ev
);

698 i‡(
r
)

699 
out
;

701 
ﬁd_Àn
 = 
smm
->
begö
;

703 
r
 = 
	`sm_Œ_commô
(&
smm
->
Œ
);

704 i‡(
r
)

705 
out
;

707 } 
ﬁd_Àn
 !
smm
->
begö
);

709 
out
:

713 
	`mem˝y
(
sm
, &
›s
, (*sm));

714  
r
;

715 
	}
}

719 
dm_•a˚_m≠
 *
	$dm_sm_mëad©a_öô
()

721 
sm_mëad©a
 *
smm
;

723 
smm
 = 
	`kmÆloc
((*smm), 
GFP_KERNEL
);

724 i‡(!
smm
)

725  
	`ERR_PTR
(-
ENOMEM
);

727 
	`mem˝y
(&
smm
->
sm
, &
›s
, (smm->sm));

729  &
smm
->
sm
;

730 
	}
}

732 
	$dm_sm_mëad©a_¸óã
(
dm_•a˚_m≠
 *
sm
,

733 
dm_å™ß˘i⁄_m™agî
 *
tm
,

734 
dm_block_t
 
ƒ_blocks
,

735 
dm_block_t
 
su≥rblock
)

737 
r
;

738 
dm_block_t
 
i
;

739 
Æloˇti⁄_evít
 
ev
;

740 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

742 
smm
->
begö
 = 
su≥rblock
 + 1;

743 
smm
->
ªcursi⁄_cou¡
 = 0;

744 
smm
->
Æloˇãd_this_å™ß˘i⁄
 = 0;

745 
	`brb_öô
(&
smm
->
uncommôãd
);

746 
	`thªshﬁd_öô
(&
smm
->
thªshﬁd
);

748 
	`mem˝y
(&
smm
->
sm
, &
boŸ°øp_›s
, (smm->sm));

750 
r
 = 
	`sm_Œ_√w_mëad©a
(&
smm
->
Œ
, 
tm
);

751 i‡(
r
)

752  
r
;

754 i‡(
ƒ_blocks
 > 
DM_SM_METADATA_MAX_BLOCKS
)

755 
ƒ_blocks
 = 
DM_SM_METADATA_MAX_BLOCKS
;

756 
r
 = 
	`sm_Œ_exãnd
(&
smm
->
Œ
, 
ƒ_blocks
);

757 i‡(
r
)

758  
r
;

760 
	`mem˝y
(&
smm
->
sm
, &
›s
, (smm->sm));

766 
i
 = 
su≥rblock
; !
r
 && i < 
smm
->
begö
; i++)

767 
r
 = 
	`sm_Œ_öc
(&
smm
->
Œ
, 
i
, &
ev
);

769 i‡(
r
)

770  
r
;

772  
	`sm_mëad©a_commô
(
sm
);

773 
	}
}

775 
	$dm_sm_mëad©a_›í
(
dm_•a˚_m≠
 *
sm
,

776 
dm_å™ß˘i⁄_m™agî
 *
tm
,

777 *
roŸ_À
, 
size_t
 
Àn
)

779 
r
;

780 
sm_mëad©a
 *
smm
 = 
	`c⁄èöî_of
(
sm
, sm_metadata, sm);

782 
r
 = 
	`sm_Œ_›í_mëad©a
(&
smm
->
Œ
, 
tm
, 
roŸ_À
, 
Àn
);

783 i‡(
r
)

784  
r
;

786 
smm
->
begö
 = 0;

787 
smm
->
ªcursi⁄_cou¡
 = 0;

788 
smm
->
Æloˇãd_this_å™ß˘i⁄
 = 0;

789 
	`brb_öô
(&
smm
->
uncommôãd
);

790 
	`thªshﬁd_öô
(&
smm
->
thªshﬁd
);

792 
	`mem˝y
(&
smm
->
ﬁd_Œ
, &smm->
Œ
, (smm->old_ll));

794 
	}
}

	@persistent-data/dm-space-map-metadata.h

7 #i‚de‡
DM_SPACE_MAP_METADATA_H


8 
	#DM_SPACE_MAP_METADATA_H


	)

10 
	~"dm-å™ß˘i⁄-m™agî.h
"

12 
	#DM_SM_METADATA_BLOCK_SIZE
 (4096 >> 
SECTOR_SHIFT
)

	)

20 
	#DM_SM_METADATA_MAX_BLOCKS
 (255 * ((1 << 14Ë- 64))

	)

21 
	#DM_SM_METADATA_MAX_SECTORS
 (
DM_SM_METADATA_MAX_BLOCKS
 * 
DM_SM_METADATA_BLOCK_SIZE
)

	)

27 
dm_•a˚_m≠
 *
dm_sm_mëad©a_öô
();

32 
dm_sm_mëad©a_¸óã
(
dm_•a˚_m≠
 *
sm
,

33 
dm_å™ß˘i⁄_m™agî
 *
tm
,

34 
dm_block_t
 
ƒ_blocks
,

35 
dm_block_t
 
su≥rblock
);

40 
dm_sm_mëad©a_›í
(
dm_•a˚_m≠
 *
sm
,

41 
dm_å™ß˘i⁄_m™agî
 *
tm
,

42 *
roŸ_À
, 
size_t
 
Àn
);

	@persistent-data/dm-space-map.h

7 #i‚de‡
_LINUX_DM_SPACE_MAP_H


8 
	#_LINUX_DM_SPACE_MAP_H


	)

10 
	~"dm-block-m™agî.h
"

12 (*
	tdm_sm_thªshﬁd_‚
)(*
	tc⁄ãxt
);

18 
	sdm_•a˚_m≠
 {

19 (*
de°roy
)(
dm_•a˚_m≠
 *
sm
);

24 (*
exãnd
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
);

30 (*
gë_ƒ_blocks
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
);

40 (*
gë_ƒ_‰ì
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
);

42 (*
gë_cou¡
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
, 
uöt32_t
 *
ªsu…
);

43 (*
cou¡_is_m‹e_th™_⁄e
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

44 *
ªsu…
);

45 (*
£t_cou¡
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
, 
uöt32_t
 
cou¡
);

47 (*
commô
)(
dm_•a˚_m≠
 *
sm
);

49 (*
öc_block
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
);

50 (*
dec_block
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
);

55 (*
√w_block
)(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
);

62 (*
roŸ_size
)(
dm_•a˚_m≠
 *
sm
, 
size_t
 *
ªsu…
);

63 (*
c›y_roŸ
)(
dm_•a˚_m≠
 *
sm
, *
c›y_to_hîe_À
, 
size_t
 
Àn
);

69 (*
ªgi°î_thªshﬁd_ˇŒback
)(
dm_•a˚_m≠
 *
sm
,

70 
dm_block_t
 
thªshﬁd
,

71 
dm_sm_thªshﬁd_‚
 
‚
,

72 *
c⁄ãxt
);

77 
ölöe
 
	$dm_sm_de°roy
(
dm_•a˚_m≠
 *
sm
)

79 
sm
->
	`de°roy
(sm);

80 
	}
}

82 
ölöe
 
	$dm_sm_exãnd
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
exåa_blocks
)

84  
sm
->
	`exãnd
(sm, 
exåa_blocks
);

85 
	}
}

87 
ölöe
 
	$dm_sm_gë_ƒ_blocks
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

89  
sm
->
	`gë_ƒ_blocks
(sm, 
cou¡
);

90 
	}
}

92 
ölöe
 
	$dm_sm_gë_ƒ_‰ì
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
cou¡
)

94  
sm
->
	`gë_ƒ_‰ì
(sm, 
cou¡
);

95 
	}
}

97 
ölöe
 
	$dm_sm_gë_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

98 
uöt32_t
 *
ªsu…
)

100  
sm
->
	`gë_cou¡
(sm, 
b
, 
ªsu…
);

101 
	}
}

103 
ölöe
 
	$dm_sm_cou¡_is_m‹e_th™_⁄e
(
dm_•a˚_m≠
 *
sm
,

104 
dm_block_t
 
b
, *
ªsu…
)

106  
sm
->
	`cou¡_is_m‹e_th™_⁄e
(sm, 
b
, 
ªsu…
);

107 
	}
}

109 
ölöe
 
	$dm_sm_£t_cou¡
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
,

110 
uöt32_t
 
cou¡
)

112  
sm
->
	`£t_cou¡
(sm, 
b
, 
cou¡
);

113 
	}
}

115 
ölöe
 
	$dm_sm_commô
(
dm_•a˚_m≠
 *
sm
)

117  
sm
->
	`commô
(sm);

118 
	}
}

120 
ölöe
 
	$dm_sm_öc_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

122  
sm
->
	`öc_block
(sm, 
b
);

123 
	}
}

125 
ölöe
 
	$dm_sm_dec_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 
b
)

127  
sm
->
	`dec_block
(sm, 
b
);

128 
	}
}

130 
ölöe
 
	$dm_sm_√w_block
(
dm_•a˚_m≠
 *
sm
, 
dm_block_t
 *
b
)

132  
sm
->
	`√w_block
(sm, 
b
);

133 
	}
}

135 
ölöe
 
	$dm_sm_roŸ_size
(
dm_•a˚_m≠
 *
sm
, 
size_t
 *
ªsu…
)

137  
sm
->
	`roŸ_size
(sm, 
ªsu…
);

138 
	}
}

140 
ölöe
 
	$dm_sm_c›y_roŸ
(
dm_•a˚_m≠
 *
sm
, *
c›y_to_hîe_À
, 
size_t
 
Àn
)

142  
sm
->
	`c›y_roŸ
(sm, 
c›y_to_hîe_À
, 
Àn
);

143 
	}
}

145 
ölöe
 
	$dm_sm_ªgi°î_thªshﬁd_ˇŒback
(
dm_•a˚_m≠
 *
sm
,

146 
dm_block_t
 
thªshﬁd
,

147 
dm_sm_thªshﬁd_‚
 
‚
,

148 *
c⁄ãxt
)

150 i‡(
sm
->
ªgi°î_thªshﬁd_ˇŒback
)

151  
sm
->
	`ªgi°î_thªshﬁd_ˇŒback
(sm, 
thªshﬁd
, 
‚
, 
c⁄ãxt
);

153  -
EINVAL
;

154 
	}
}

	@persistent-data/dm-transaction-manager.c

6 
	~"dm-å™ß˘i⁄-m™agî.h
"

7 
	~"dm-•a˚-m≠.h
"

8 
	~"dm-•a˚-m≠-disk.h
"

9 
	~"dm-•a˚-m≠-mëad©a.h
"

10 
	~"dm-≥rsi°ít-d©a-öã∫Æ.h
"

12 
	~<löux/exp‹t.h
>

13 
	~<löux/¶ab.h
>

14 
	~<löux/devi˚-m≠≥r.h
>

16 
	#DM_MSG_PREFIX
 "å™ß˘i⁄ m™agî"

	)

20 
	sshadow_öfo
 {

21 
hli°_node
 
	mhli°
;

22 
dm_block_t
 
	mwhîe
;

28 
	#DM_HASH_SIZE
 256

	)

29 
	#DM_HASH_MASK
 (
DM_HASH_SIZE
 - 1)

	)

31 
	sdm_å™ß˘i⁄_m™agî
 {

32 
	mis_˛⁄e
;

33 
dm_å™ß˘i⁄_m™agî
 *
	mªÆ
;

35 
dm_block_m™agî
 *
	mbm
;

36 
dm_•a˚_m≠
 *
	msm
;

38 
•ölock_t
 
	mlock
;

39 
hli°_hód
 
	mbuckës
[
DM_HASH_SIZE
];

44 
	$is_shadow
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
)

46 
r
 = 0;

47 
buckë
 = 
	`dm_hash_block
(
b
, 
DM_HASH_MASK
);

48 
shadow_öfo
 *
si
;

50 
	`•ö_lock
(&
tm
->
lock
);

51 
	`hli°_f‹_óch_íåy
(
si
, 
tm
->
buckës
 + 
buckë
, 
hli°
)

52 i‡(
si
->
whîe
 =
b
) {

53 
r
 = 1;

56 
	`•ö_u∆ock
(&
tm
->
lock
);

58  
r
;

59 
	}
}

65 
	$ö£π_shadow
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
)

67 
buckë
;

68 
shadow_öfo
 *
si
;

70 
si
 = 
	`kmÆloc
((*si), 
GFP_NOIO
);

71 i‡(
si
) {

72 
si
->
whîe
 = 
b
;

73 
buckë
 = 
	`dm_hash_block
(
b
, 
DM_HASH_MASK
);

74 
	`•ö_lock
(&
tm
->
lock
);

75 
	`hli°_add_hód
(&
si
->
hli°
, 
tm
->
buckës
 + 
buckë
);

76 
	`•ö_u∆ock
(&
tm
->
lock
);

78 
	}
}

80 
	$wùe_shadow_èbÀ
(
dm_å™ß˘i⁄_m™agî
 *
tm
)

82 
shadow_öfo
 *
si
;

83 
hli°_node
 *
tmp
;

84 
hli°_hód
 *
buckë
;

85 
i
;

87 
	`•ö_lock
(&
tm
->
lock
);

88 
i
 = 0; i < 
DM_HASH_SIZE
; i++) {

89 
buckë
 = 
tm
->
buckës
 + 
i
;

90 
	`hli°_f‹_óch_íåy_ß„
(
si
, 
tmp
, 
buckë
, 
hli°
)

91 
	`k‰ì
(
si
);

93 
	`INIT_HLIST_HEAD
(
buckë
);

96 
	`•ö_u∆ock
(&
tm
->
lock
);

97 
	}
}

101 
dm_å™ß˘i⁄_m™agî
 *
	$dm_tm_¸óã
(
dm_block_m™agî
 *
bm
,

102 
dm_•a˚_m≠
 *
sm
)

104 
i
;

105 
dm_å™ß˘i⁄_m™agî
 *
tm
;

107 
tm
 = 
	`kmÆloc
((*tm), 
GFP_KERNEL
);

108 i‡(!
tm
)

109  
	`ERR_PTR
(-
ENOMEM
);

111 
tm
->
is_˛⁄e
 = 0;

112 
tm
->
ªÆ
 = 
NULL
;

113 
tm
->
bm
 = bm;

114 
tm
->
sm
 = sm;

116 
	`•ö_lock_öô
(&
tm
->
lock
);

117 
i
 = 0; i < 
DM_HASH_SIZE
; i++)

118 
	`INIT_HLIST_HEAD
(
tm
->
buckës
 + 
i
);

120  
tm
;

121 
	}
}

123 
dm_å™ß˘i⁄_m™agî
 *
	$dm_tm_¸óã_n⁄_blockög_˛⁄e
(
dm_å™ß˘i⁄_m™agî
 *
ªÆ
)

125 
dm_å™ß˘i⁄_m™agî
 *
tm
;

127 
tm
 = 
	`kmÆloc
((*tm), 
GFP_KERNEL
);

128 i‡(
tm
) {

129 
tm
->
is_˛⁄e
 = 1;

130 
tm
->
ªÆ
 =Ñeal;

133  
tm
;

134 
	}
}

135 
EXPORT_SYMBOL_GPL
(
dm_tm_¸óã_n⁄_blockög_˛⁄e
);

137 
	$dm_tm_de°roy
(
dm_å™ß˘i⁄_m™agî
 *
tm
)

139 i‡(!
tm
->
is_˛⁄e
)

140 
	`wùe_shadow_èbÀ
(
tm
);

142 
	`k‰ì
(
tm
);

143 
	}
}

144 
EXPORT_SYMBOL_GPL
(
dm_tm_de°roy
);

146 
	$dm_tm_¥e_commô
(
dm_å™ß˘i⁄_m™agî
 *
tm
)

148 
r
;

150 i‡(
tm
->
is_˛⁄e
)

151  -
EWOULDBLOCK
;

153 
r
 = 
	`dm_sm_commô
(
tm
->
sm
);

154 i‡(
r
 < 0)

155  
r
;

157  
	`dm_bm_Êush
(
tm
->
bm
);

158 
	}
}

159 
EXPORT_SYMBOL_GPL
(
dm_tm_¥e_commô
);

161 
	$dm_tm_commô
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block
 *
roŸ
)

163 i‡(
tm
->
is_˛⁄e
)

164  -
EWOULDBLOCK
;

166 
	`wùe_shadow_èbÀ
(
tm
);

167 
	`dm_bm_u∆ock
(
roŸ
);

169  
	`dm_bm_Êush
(
tm
->
bm
);

170 
	}
}

171 
EXPORT_SYMBOL_GPL
(
dm_tm_commô
);

173 
	$dm_tm_√w_block
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

174 
dm_block_vÆid©‹
 *
v
,

175 
dm_block
 **
ªsu…
)

177 
r
;

178 
dm_block_t
 
√w_block
;

180 i‡(
tm
->
is_˛⁄e
)

181  -
EWOULDBLOCK
;

183 
r
 = 
	`dm_sm_√w_block
(
tm
->
sm
, &
√w_block
);

184 i‡(
r
 < 0)

185  
r
;

187 
r
 = 
	`dm_bm_wrôe_lock_zîo
(
tm
->
bm
, 
√w_block
, 
v
, 
ªsu…
);

188 i‡(
r
 < 0) {

189 
	`dm_sm_dec_block
(
tm
->
sm
, 
√w_block
);

190  
r
;

197 
	`ö£π_shadow
(
tm
, 
√w_block
);

200 
	}
}

202 
	$__shadow_block
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
‹ig
,

203 
dm_block_vÆid©‹
 *
v
,

204 
dm_block
 **
ªsu…
)

206 
r
;

207 
dm_block_t
 
√w
;

208 
dm_block
 *
‹ig_block
;

210 
r
 = 
	`dm_sm_√w_block
(
tm
->
sm
, &
√w
);

211 i‡(
r
 < 0)

212  
r
;

214 
r
 = 
	`dm_sm_dec_block
(
tm
->
sm
, 
‹ig
);

215 i‡(
r
 < 0)

216  
r
;

218 
r
 = 
	`dm_bm_ªad_lock
(
tm
->
bm
, 
‹ig
, 
v
, &
‹ig_block
);

219 i‡(
r
 < 0)

220  
r
;

229 
r
 = 
	`dm_bm_wrôe_lock_zîo
(
tm
->
bm
, 
√w
, 
v
, 
ªsu…
);

230 i‡(
r
) {

231 
	`dm_bm_u∆ock
(
‹ig_block
);

232  
r
;

235 
	`mem˝y
(
	`dm_block_d©a
(*
ªsu…
), dm_block_d©a(
‹ig_block
),

236 
	`dm_bm_block_size
(
tm
->
bm
));

238 
	`dm_bm_u∆ock
(
‹ig_block
);

239  
r
;

240 
	}
}

242 
	$dm_tm_shadow_block
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
‹ig
,

243 
dm_block_vÆid©‹
 *
v
, 
dm_block
 **
ªsu…
,

244 *
öc_chûdªn
)

246 
r
;

248 i‡(
tm
->
is_˛⁄e
)

249  -
EWOULDBLOCK
;

251 
r
 = 
	`dm_sm_cou¡_is_m‹e_th™_⁄e
(
tm
->
sm
, 
‹ig
, 
öc_chûdªn
);

252 i‡(
r
 < 0)

253  
r
;

255 i‡(
	`is_shadow
(
tm
, 
‹ig
Ë&& !*
öc_chûdªn
)

256  
	`dm_bm_wrôe_lock
(
tm
->
bm
, 
‹ig
, 
v
, 
ªsu…
);

258 
r
 = 
	`__shadow_block
(
tm
, 
‹ig
, 
v
, 
ªsu…
);

259 i‡(
r
 < 0)

260  
r
;

261 
	`ö£π_shadow
(
tm
, 
	`dm_block_loˇti⁄
(*
ªsu…
));

263  
r
;

264 
	}
}

265 
EXPORT_SYMBOL_GPL
(
dm_tm_shadow_block
);

267 
	$dm_tm_ªad_lock
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
,

268 
dm_block_vÆid©‹
 *
v
,

269 
dm_block
 **
blk
)

271 i‡(
tm
->
is_˛⁄e
)

272  
	`dm_bm_ªad_åy_lock
(
tm
->
ªÆ
->
bm
, 
b
, 
v
, 
blk
);

274  
	`dm_bm_ªad_lock
(
tm
->
bm
, 
b
, 
v
, 
blk
);

275 
	}
}

276 
EXPORT_SYMBOL_GPL
(
dm_tm_ªad_lock
);

278 
	$dm_tm_u∆ock
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block
 *
b
)

280  
	`dm_bm_u∆ock
(
b
);

281 
	}
}

282 
EXPORT_SYMBOL_GPL
(
dm_tm_u∆ock
);

284 
	$dm_tm_öc
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
)

289 
	`BUG_ON
(
tm
->
is_˛⁄e
);

291 
	`dm_sm_öc_block
(
tm
->
sm
, 
b
);

292 
	}
}

293 
EXPORT_SYMBOL_GPL
(
dm_tm_öc
);

295 
	$dm_tm_dec
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
)

300 
	`BUG_ON
(
tm
->
is_˛⁄e
);

302 
	`dm_sm_dec_block
(
tm
->
sm
, 
b
);

303 
	}
}

304 
EXPORT_SYMBOL_GPL
(
dm_tm_dec
);

306 
	$dm_tm_ªf
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
,

307 
uöt32_t
 *
ªsu…
)

309 i‡(
tm
->
is_˛⁄e
)

310  -
EWOULDBLOCK
;

312  
	`dm_sm_gë_cou¡
(
tm
->
sm
, 
b
, 
ªsu…
);

313 
	}
}

315 
dm_block_m™agî
 *
	$dm_tm_gë_bm
(
dm_å™ß˘i⁄_m™agî
 *
tm
)

317  
tm
->
bm
;

318 
	}
}

322 
	$dm_tm_¸óã_öã∫Æ
(
dm_block_m™agî
 *
bm
,

323 
dm_block_t
 
sb_loˇti⁄
,

324 
dm_å™ß˘i⁄_m™agî
 **
tm
,

325 
dm_•a˚_m≠
 **
sm
,

326 
¸óã
,

327 *
sm_roŸ
, 
size_t
 
sm_Àn
)

329 
r
;

331 *
sm
 = 
	`dm_sm_mëad©a_öô
();

332 i‡(
	`IS_ERR
(*
sm
))

333  
	`PTR_ERR
(*
sm
);

335 *
tm
 = 
	`dm_tm_¸óã
(
bm
, *
sm
);

336 i‡(
	`IS_ERR
(*
tm
)) {

337 
	`dm_sm_de°roy
(*
sm
);

338  
	`PTR_ERR
(*
tm
);

341 i‡(
¸óã
) {

342 
r
 = 
	`dm_sm_mëad©a_¸óã
(*
sm
, *
tm
, 
	`dm_bm_ƒ_blocks
(
bm
),

343 
sb_loˇti⁄
);

344 i‡(
r
) {

345 
	`DMERR
("couldn't create metadata space map");

346 
bad
;

350 
r
 = 
	`dm_sm_mëad©a_›í
(*
sm
, *
tm
, 
sm_roŸ
, 
sm_Àn
);

351 i‡(
r
) {

352 
	`DMERR
("couldn't open metadata space map");

353 
bad
;

359 
bad
:

360 
	`dm_tm_de°roy
(*
tm
);

361 
	`dm_sm_de°roy
(*
sm
);

362  
r
;

363 
	}
}

365 
	$dm_tm_¸óã_wôh_sm
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
sb_loˇti⁄
,

366 
dm_å™ß˘i⁄_m™agî
 **
tm
,

367 
dm_•a˚_m≠
 **
sm
)

369  
	`dm_tm_¸óã_öã∫Æ
(
bm
, 
sb_loˇti⁄
, 
tm
, 
sm
, 1, 
NULL
, 0);

370 
	}
}

371 
EXPORT_SYMBOL_GPL
(
dm_tm_¸óã_wôh_sm
);

373 
	$dm_tm_›í_wôh_sm
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
sb_loˇti⁄
,

374 *
sm_roŸ
, 
size_t
 
roŸ_Àn
,

375 
dm_å™ß˘i⁄_m™agî
 **
tm
,

376 
dm_•a˚_m≠
 **
sm
)

378  
	`dm_tm_¸óã_öã∫Æ
(
bm
, 
sb_loˇti⁄
, 
tm
, 
sm
, 0, 
sm_roŸ
, 
roŸ_Àn
);

379 
	}
}

380 
EXPORT_SYMBOL_GPL
(
dm_tm_›í_wôh_sm
);

	@persistent-data/dm-transaction-manager.h

7 #i‚de‡
_LINUX_DM_TRANSACTION_MANAGER_H


8 
	#_LINUX_DM_TRANSACTION_MANAGER_H


	)

10 
	~"dm-block-m™agî.h
"

12 
	gdm_å™ß˘i⁄_m™agî
;

13 
	gdm_•a˚_m≠
;

24 
dm_tm_de°roy
(
dm_å™ß˘i⁄_m™agî
 *
tm
);

36 
dm_å™ß˘i⁄_m™agî
 *
dm_tm_¸óã_n⁄_blockög_˛⁄e
(dm_å™ß˘i⁄_m™agî *
ªÆ
);

50 
dm_tm_¥e_commô
(
dm_å™ß˘i⁄_m™agî
 *
tm
);

51 
dm_tm_commô
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block
 *
su≥rblock
);

65 
dm_tm_√w_block
(
dm_å™ß˘i⁄_m™agî
 *
tm
,

66 
dm_block_vÆid©‹
 *
v
,

67 
dm_block
 **
ªsu…
);

85 
dm_tm_shadow_block
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
‹ig
,

86 
dm_block_vÆid©‹
 *
v
,

87 
dm_block
 **
ªsu…
, *
öc_chûdªn
);

93 
dm_tm_ªad_lock
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
,

94 
dm_block_vÆid©‹
 *
v
,

95 
dm_block
 **
ªsu…
);

97 
dm_tm_u∆ock
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block
 *
b
);

102 
dm_tm_öc
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
);

104 
dm_tm_dec
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
);

106 
dm_tm_ªf
(
dm_å™ß˘i⁄_m™agî
 *
tm
, 
dm_block_t
 
b
,

107 
uöt32_t
 *
ªsu…
);

109 
dm_block_m™agî
 *
dm_tm_gë_bm
(
dm_å™ß˘i⁄_m™agî
 *
tm
);

121 
dm_tm_¸óã_wôh_sm
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
sb_loˇti⁄
,

122 
dm_å™ß˘i⁄_m™agî
 **
tm
,

123 
dm_•a˚_m≠
 **
sm
);

125 
dm_tm_›í_wôh_sm
(
dm_block_m™agî
 *
bm
, 
dm_block_t
 
sb_loˇti⁄
,

126 *
sm_roŸ
, 
size_t
 
roŸ_Àn
,

127 
dm_å™ß˘i⁄_m™agî
 **
tm
,

128 
dm_•a˚_m≠
 **
sm
);

	@raid0.c

21 
	~<löux/blkdev.h
>

22 
	~<löux/£q_fûe.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/¶ab.h
>

25 
	~"md.h
"

26 
	~"øid0.h
"

27 
	~"øid5.h
"

29 
	$øid0_c⁄ge°ed
(*
d©a
, 
bôs
)

31 
mddev
 *mddev = 
d©a
;

32 
r0c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

33 
md_rdev
 **
devli°
 = 
c⁄f
->devlist;

34 
øid_disks
 = 
c⁄f
->
°rù_z⁄e
[0].
nb_dev
;

35 
i
, 
ªt
 = 0;

37 i‡(
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
))

40 
i
 = 0; i < 
øid_disks
 && !
ªt
 ; i++) {

41 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
devli°
[
i
]->
bdev
);

43 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

45  
ªt
;

46 
	}
}

51 
	$dump_z⁄es
(
mddev
 *mddev)

53 
j
, 
k
;

54 
£˘‹_t
 
z⁄e_size
 = 0;

55 
£˘‹_t
 
z⁄e_°¨t
 = 0;

56 
b
[
BDEVNAME_SIZE
];

57 
r0c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

58 
øid_disks
 = 
c⁄f
->
°rù_z⁄e
[0].
nb_dev
;

59 
	`¥ötk
(
KERN_INFO
 "md: RAID0 configuration for %s - %d zone%s\n",

60 
	`md«me
(
mddev
),

61 
c⁄f
->
ƒ_°rù_z⁄es
, conf->nr_strip_zones==1?"":"s");

62 
j
 = 0; j < 
c⁄f
->
ƒ_°rù_z⁄es
; j++) {

63 
	`¥ötk
(
KERN_INFO
 "md: z⁄e%d=[", 
j
);

64 
k
 = 0; k < 
c⁄f
->
°rù_z⁄e
[
j
].
nb_dev
; k++)

65 
	`¥ötk
(
KERN_CONT
 "%s%s", 
k
?"/":"",

66 
	`bdev«me
(
c⁄f
->
devli°
[
j
*
øid_disks


67 + 
k
]->
bdev
, 
b
));

68 
	`¥ötk
(
KERN_CONT
 "]\n");

70 
z⁄e_size
 = 
c⁄f
->
°rù_z⁄e
[
j
].
z⁄e_íd
 - 
z⁄e_°¨t
;

71 
	`¥ötk
(
KERN_INFO
 " zone-offset=%10lluKB, "

73 ()
z⁄e_°¨t
>>1,

74 ()
c⁄f
->
°rù_z⁄e
[
j
].
dev_°¨t
>>1,

75 ()
z⁄e_size
>>1);

76 
z⁄e_°¨t
 = 
c⁄f
->
°rù_z⁄e
[
j
].
z⁄e_íd
;

78 
	`¥ötk
(
KERN_INFO
 "\n");

79 
	}
}

81 
	$¸óã_°rù_z⁄es
(
mddev
 *mddev, 
r0c⁄f
 **
¥iv©e_c⁄f
)

83 
i
, 
c
, 
îr
;

84 
£˘‹_t
 
cuº_z⁄e_íd
, 
£˘‹s
;

85 
md_rdev
 *
smÆÀ°
, *
rdev1
, *
rdev2
, *
rdev
, **
dev
;

86 
°rù_z⁄e
 *
z⁄e
;

87 
˙t
;

88 
b
[
BDEVNAME_SIZE
];

89 
b2
[
BDEVNAME_SIZE
];

90 
r0c⁄f
 *
c⁄f
 = 
	`kzÆloc
((*c⁄f), 
GFP_KERNEL
);

91 
boﬁ
 
disˇrd_suµ‹ãd
 = 
Ál£
;

93 i‡(!
c⁄f
)

94  -
ENOMEM
;

95 
	`rdev_f‹_óch
(
rdev1
, 
mddev
) {

96 
	`¥_debug
("md/raid0:%s:Üookingát %s\n",

97 
	`md«me
(
mddev
),

98 
	`bdev«me
(
rdev1
->
bdev
, 
b
));

99 
c
 = 0;

102 
£˘‹s
 = 
rdev1
->sectors;

103 
	`£˘‹_div
(
£˘‹s
, 
mddev
->
chunk_£˘‹s
);

104 
rdev1
->
£˘‹s
 = se˘‹†* 
mddev
->
chunk_£˘‹s
;

106 
	`rdev_f‹_óch
(
rdev2
, 
mddev
) {

107 
	`¥_debug
("md/raid0:%s: comparing %s(%llu)"

109 
	`md«me
(
mddev
),

110 
	`bdev«me
(
rdev1
->
bdev
,
b
),

111 ()
rdev1
->
£˘‹s
,

112 
	`bdev«me
(
rdev2
->
bdev
,
b2
),

113 ()
rdev2
->
£˘‹s
);

114 i‡(
rdev2
 =
rdev1
) {

115 
	`¥_debug
("md/raid0:%s: END\n",

116 
	`md«me
(
mddev
));

119 i‡(
rdev2
->
£˘‹s
 =
rdev1
->sectors) {

124 
	`¥_debug
("md/raid0:%s: EQUAL\n",

125 
	`md«me
(
mddev
));

126 
c
 = 1;

129 
	`¥_debug
("md/raid0:%s: NOT EQUAL\n",

130 
	`md«me
(
mddev
));

132 i‡(!
c
) {

133 
	`¥_debug
("md/raid0:%s: ==> UNIQUE\n",

134 
	`md«me
(
mddev
));

135 
c⁄f
->
ƒ_°rù_z⁄es
++;

136 
	`¥_debug
("md/raid0:%s: %d zones\n",

137 
	`md«me
(
mddev
), 
c⁄f
->
ƒ_°rù_z⁄es
);

140 
	`¥_debug
("md/raid0:%s: FINAL %d zones\n",

141 
	`md«me
(
mddev
), 
c⁄f
->
ƒ_°rù_z⁄es
);

142 
îr
 = -
ENOMEM
;

143 
c⁄f
->
°rù_z⁄e
 = 
	`kzÆloc
((strip_zone)*

144 
c⁄f
->
ƒ_°rù_z⁄es
, 
GFP_KERNEL
);

145 i‡(!
c⁄f
->
°rù_z⁄e
)

146 
ab‹t
;

147 
c⁄f
->
devli°
 = 
	`kzÆloc
((
md_rdev
*)*

148 
c⁄f
->
ƒ_°rù_z⁄es
*
mddev
->
øid_disks
,

149 
GFP_KERNEL
);

150 i‡(!
c⁄f
->
devli°
)

151 
ab‹t
;

156 
z⁄e
 = &
c⁄f
->
°rù_z⁄e
[0];

157 
˙t
 = 0;

158 
smÆÀ°
 = 
NULL
;

159 
dev
 = 
c⁄f
->
devli°
;

160 
îr
 = -
EINVAL
;

161 
	`rdev_f‹_óch
(
rdev1
, 
mddev
) {

162 
j
 = 
rdev1
->
øid_disk
;

164 i‡(
mddev
->
Àvñ
 == 10) {

166 
j
 /= 2;

167 
rdev1
->
√w_øid_disk
 = 
j
;

170 i‡(
mddev
->
Àvñ
 == 1) {

174 
j
 = 0;

175 
rdev1
->
√w_øid_disk
 = 
j
;

178 i‡(
j
 < 0) {

179 
	`¥ötk
(
KERN_ERR


181 
	`md«me
(
mddev
));

182 
ab‹t
;

184 i‡(
j
 >
mddev
->
øid_disks
) {

185 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: bad diskÇumber %d - "

186 "ab‹tög!\n", 
	`md«me
(
mddev
), 
j
);

187 
ab‹t
;

189 i‡(
dev
[
j
]) {

190 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: multiple devices for %d - "

191 "ab‹tög!\n", 
	`md«me
(
mddev
), 
j
);

192 
ab‹t
;

194 
dev
[
j
] = 
rdev1
;

196 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev1
->
bdev
,

197 
rdev1
->
d©a_off£t
 << 9);

199 i‡(
rdev1
->
bdev
->
bd_disk
->
queue
->
mîge_bvec_‚
)

200 
c⁄f
->
has_mîge_bvec
 = 1;

202 i‡(!
smÆÀ°
 || (
rdev1
->
£˘‹s
 < smallest->sectors))

203 
smÆÀ°
 = 
rdev1
;

204 
˙t
++;

206 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev1
->
bdev
)))

207 
disˇrd_suµ‹ãd
 = 
åue
;

209 i‡(
˙t
 !
mddev
->
øid_disks
) {

210 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s:Åoo few disks (%d of %d) - "

211 "ab‹tög!\n", 
	`md«me
(
mddev
), 
˙t
, mddev->
øid_disks
);

212 
ab‹t
;

214 
z⁄e
->
nb_dev
 = 
˙t
;

215 
z⁄e
->
z⁄e_íd
 = 
smÆÀ°
->
£˘‹s
 * 
˙t
;

217 
cuº_z⁄e_íd
 = 
z⁄e
->
z⁄e_íd
;

220 
i
 = 1; i < 
c⁄f
->
ƒ_°rù_z⁄es
; i++)

222 
j
;

224 
z⁄e
 = 
c⁄f
->
°rù_z⁄e
 + 
i
;

225 
dev
 = 
c⁄f
->
devli°
 + 
i
 * 
mddev
->
øid_disks
;

227 
	`¥_debug
("md/øid0:%s: z⁄ê%d\n", 
	`md«me
(
mddev
), 
i
);

228 
z⁄e
->
dev_°¨t
 = 
smÆÀ°
->
£˘‹s
;

229 
smÆÀ°
 = 
NULL
;

230 
c
 = 0;

232 
j
=0; j<
˙t
; j++) {

233 
rdev
 = 
c⁄f
->
devli°
[
j
];

234 i‡(
rdev
->
£˘‹s
 <
z⁄e
->
dev_°¨t
) {

235 
	`¥_debug
("md/raid0:%s: checking %s ...Çope\n",

236 
	`md«me
(
mddev
),

237 
	`bdev«me
(
rdev
->
bdev
, 
b
));

240 
	`¥_debug
("md/raid0:%s: checking %s ..."

242 
	`md«me
(
mddev
),

243 
	`bdev«me
(
rdev
->
bdev
, 
b
), 
c
);

244 
dev
[
c
] = 
rdev
;

245 
c
++;

246 i‡(!
smÆÀ°
 || 
rdev
->
£˘‹s
 < smallest->sectors) {

247 
smÆÀ°
 = 
rdev
;

248 
	`¥_debug
("md/raid0:%s: (%llu) is smallest!.\n",

249 
	`md«me
(
mddev
),

250 ()
rdev
->
£˘‹s
);

254 
z⁄e
->
nb_dev
 = 
c
;

255 
£˘‹s
 = (
smÆÀ°
->£˘‹†- 
z⁄e
->
dev_°¨t
Ë* 
c
;

256 
	`¥_debug
("md/raid0:%s: zone->nb_dev: %d, sectors: %llu\n",

257 
	`md«me
(
mddev
),

258 
z⁄e
->
nb_dev
, ()
£˘‹s
);

260 
cuº_z⁄e_íd
 +
£˘‹s
;

261 
z⁄e
->
z⁄e_íd
 = 
cuº_z⁄e_íd
;

263 
	`¥_debug
("md/raid0:%s: current zone start: %llu\n",

264 
	`md«me
(
mddev
),

265 ()
smÆÀ°
->
£˘‹s
);

267 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
øid0_c⁄ge°ed
;

268 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

274 i‡((
mddev
->
chunk_£˘‹s
 << 9Ë% 
	`queue_logiˇl_block_size
(mddev->
queue
)) {

275 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: chunk_size of %dÇot valid\n",

276 
	`md«me
(
mddev
),

277 
mddev
->
chunk_£˘‹s
 << 9);

278 
ab‹t
;

281 
	`blk_queue_io_mö
(
mddev
->
queue
, mddev->
chunk_£˘‹s
 << 9);

282 
	`blk_queue_io_›t
(
mddev
->
queue
,

283 (
mddev
->
chunk_£˘‹s
 << 9Ë* mddev->
øid_disks
);

285 i‡(!
disˇrd_suµ‹ãd
)

286 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

288 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

290 
	`¥_debug
("md/øid0:%s: d⁄e.\n", 
	`md«me
(
mddev
));

291 *
¥iv©e_c⁄f
 = 
c⁄f
;

294 
ab‹t
:

295 
	`k‰ì
(
c⁄f
->
°rù_z⁄e
);

296 
	`k‰ì
(
c⁄f
->
devli°
);

297 
	`k‰ì
(
c⁄f
);

298 *
¥iv©e_c⁄f
 = 
	`ERR_PTR
(
îr
);

299  
îr
;

300 
	}
}

305 
°rù_z⁄e
 *
	$föd_z⁄e
(
r0c⁄f
 *
c⁄f
,

306 
£˘‹_t
 *
£˘‹p
)

308 
i
;

309 
°rù_z⁄e
 *
z
 = 
c⁄f
->strip_zone;

310 
£˘‹_t
 
£˘‹
 = *
£˘‹p
;

312 
i
 = 0; i < 
c⁄f
->
ƒ_°rù_z⁄es
; i++)

313 i‡(
£˘‹
 < 
z
[
i
].
z⁄e_íd
) {

314 i‡(
i
)

315 *
£˘‹p
 = 
£˘‹
 - 
z
[
i
-1].
z⁄e_íd
;

316  
z
 + 
i
;

318 
	`BUG
();

319 
	}
}

325 
md_rdev
 *
	$m≠_£˘‹
(
mddev
 *mddev, 
°rù_z⁄e
 *
z⁄e
,

326 
£˘‹_t
 
£˘‹
, se˘‹_à*
£˘‹_off£t
)

328 
£˘_ö_chunk
;

329 
£˘‹_t
 
chunk
;

330 
r0c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

331 
øid_disks
 = 
c⁄f
->
°rù_z⁄e
[0].
nb_dev
;

332 
chunk_£˘s
 = 
mddev
->
chunk_£˘‹s
;

334 i‡(
	`is_powî_of_2
(
chunk_£˘s
)) {

335 
chunk£˘_bôs
 = 
	`ffz
(~
chunk_£˘s
);

337 
£˘_ö_chunk
 = 
£˘‹
 & (
chunk_£˘s
 - 1);

338 
£˘‹
 >>
chunk£˘_bôs
;

340 
chunk
 = *
£˘‹_off£t
;

342 
	`£˘‹_div
(
chunk
, 
z⁄e
->
nb_dev
 << 
chunk£˘_bôs
);

344 
£˘_ö_chunk
 = 
	`£˘‹_div
(
£˘‹
, 
chunk_£˘s
);

345 
chunk
 = *
£˘‹_off£t
;

346 
	`£˘‹_div
(
chunk
, 
chunk_£˘s
 * 
z⁄e
->
nb_dev
);

353 *
£˘‹_off£t
 = (
chunk
 * 
chunk_£˘s
Ë+ 
£˘_ö_chunk
;

354  
c⁄f
->
devli°
[(
z⁄e
 - c⁄f->
°rù_z⁄e
)*
øid_disks


355 + 
	`£˘‹_div
(
£˘‹
, 
z⁄e
->
nb_dev
)];

356 
	}
}

366 
	$øid0_mîgóbÀ_bvec
(
ªque°_queue
 *
q
,

367 
bvec_mîge_d©a
 *
bvm
,

368 
bio_vec
 *
biovec
)

370 
mddev
 *mddev = 
q
->
queued©a
;

371 
r0c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

372 
£˘‹_t
 
£˘‹
 = 
bvm
->
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bvm->
bi_bdev
);

373 
£˘‹_t
 
£˘‹_off£t
 = 
£˘‹
;

374 
max
;

375 
chunk_£˘‹s
 = 
mddev
->chunk_sectors;

376 
bio_£˘‹s
 = 
bvm
->
bi_size
 >> 9;

377 
°rù_z⁄e
 *
z⁄e
;

378 
md_rdev
 *
rdev
;

379 
ªque°_queue
 *
subq
;

381 i‡(
	`is_powî_of_2
(
chunk_£˘‹s
))

382 
max
 = (
chunk_£˘‹s
 - ((
£˘‹
 & (chunk_sectors-1))

383 + 
bio_£˘‹s
)) << 9;

385 
max
 = (
chunk_£˘‹s
 - (
	`£˘‹_div
(
£˘‹
, chunk_sectors)

386 + 
bio_£˘‹s
)) << 9;

387 i‡(
max
 < 0)

388 
max
 = 0;

389 i‡(
max
 <
biovec
->
bv_Àn
 && 
bio_£˘‹s
 == 0)

390  
biovec
->
bv_Àn
;

391 i‡(
max
 < 
biovec
->
bv_Àn
)

393  
max
;

394 i‡(!
c⁄f
->
has_mîge_bvec
)

395  
max
;

398 
£˘‹
 = 
£˘‹_off£t
;

399 
z⁄e
 = 
	`föd_z⁄e
(
mddev
->
¥iv©e
, &
£˘‹_off£t
);

400 
rdev
 = 
	`m≠_£˘‹
(
mddev
, 
z⁄e
, 
£˘‹
, &
£˘‹_off£t
);

401 
subq
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

402 i‡(
subq
->
mîge_bvec_‚
) {

403 
bvm
->
bi_bdev
 = 
rdev
->
bdev
;

404 
bvm
->
bi_£˘‹
 = 
£˘‹_off£t
 + 
z⁄e
->
dev_°¨t
 +

405 
rdev
->
d©a_off£t
;

406  
	`mö
(
max
, 
subq
->
	`mîge_bvec_‚
(subq, 
bvm
, 
biovec
));

408  
max
;

409 
	}
}

411 
£˘‹_t
 
	$øid0_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

413 
£˘‹_t
 
¨øy_£˘‹s
 = 0;

414 
md_rdev
 *
rdev
;

416 
	`WARN_ONCE
(
£˘‹s
 || 
øid_disks
,

417 "%†d€†nŸ suµ‹àgíîi¯ªsh≠e\n", 
__func__
);

419 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

420 
¨øy_£˘‹s
 +(
rdev
->
£˘‹s
 &

421 ~(
£˘‹_t
)(
mddev
->
chunk_£˘‹s
-1));

423  
¨øy_£˘‹s
;

424 
	}
}

426 
øid0_°›
(
mddev
 *mddev);

428 
	$øid0_run
(
mddev
 *mddev)

430 
r0c⁄f
 *
c⁄f
;

431 
ªt
;

433 i‡(
mddev
->
chunk_£˘‹s
 == 0) {

434 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: chunk size must be set.\n",

435 
	`md«me
(
mddev
));

436  -
EINVAL
;

438 i‡(
	`md_check_no_bôm≠
(
mddev
))

439  -
EINVAL
;

440 
	`blk_queue_max_hw_£˘‹s
(
mddev
->
queue
, mddev->
chunk_£˘‹s
);

441 
	`blk_queue_max_wrôe_ßme_£˘‹s
(
mddev
->
queue
, mddev->
chunk_£˘‹s
);

442 
	`blk_queue_max_disˇrd_£˘‹s
(
mddev
->
queue
, mddev->
chunk_£˘‹s
);

445 i‡(
mddev
->
¥iv©e
 =
NULL
) {

446 
ªt
 = 
	`¸óã_°rù_z⁄es
(
mddev
, &
c⁄f
);

447 i‡(
ªt
 < 0)

448  
ªt
;

449 
mddev
->
¥iv©e
 = 
c⁄f
;

451 
c⁄f
 = 
mddev
->
¥iv©e
;

454 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`øid0_size
(mddev, 0, 0));

456 
	`¥ötk
(
KERN_INFO
 "md/raid0:%s: md_size is %llu sectors.\n",

457 
	`md«me
(
mddev
),

458 ()
mddev
->
¨øy_£˘‹s
);

469 
°rùe
 = 
mddev
->
øid_disks
 *

470 (
mddev
->
chunk_£˘‹s
 << 9Ë/ 
PAGE_SIZE
;

471 i‡(
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 < 2* 
°rùe
)

472 
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 = 2* 
°rùe
;

475 
	`blk_queue_mîge_bvec
(
mddev
->
queue
, 
øid0_mîgóbÀ_bvec
);

476 
	`dump_z⁄es
(
mddev
);

478 
ªt
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

479 i‡(
ªt
)

480 
	`øid0_°›
(
mddev
);

482  
ªt
;

483 
	}
}

485 
	$øid0_°›
(
mddev
 *mddev)

487 
r0c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

489 
	`blk_sync_queue
(
mddev
->
queue
);

490 
	`k‰ì
(
c⁄f
->
°rù_z⁄e
);

491 
	`k‰ì
(
c⁄f
->
devli°
);

492 
	`k‰ì
(
c⁄f
);

493 
mddev
->
¥iv©e
 = 
NULL
;

495 
	}
}

500 
ölöe
 
	$is_io_ö_chunk_bound¨y
(
mddev
 *mddev,

501 
chunk_£˘s
, 
bio
 *bio)

503 i‡(
	`likñy
(
	`is_powî_of_2
(
chunk_£˘s
))) {

504  
chunk_£˘s
 >=

505 ((
bio
->
bi_ôî
.
bi_£˘‹
 & (
chunk_£˘s
-1))

506 + 
	`bio_£˘‹s
(
bio
));

508 
£˘‹_t
 
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

509  
chunk_£˘s
 >(
	`£˘‹_div
(
£˘‹
, chunk_sects)

510 + 
	`bio_£˘‹s
(
bio
));

512 
	}
}

514 
	$øid0_make_ªque°
(
mddev
 *mddev, 
bio
 *bio)

516 
°rù_z⁄e
 *
z⁄e
;

517 
md_rdev
 *
tmp_dev
;

518 
bio
 *
•lô
;

520 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_FLUSH
)) {

521 
	`md_Êush_ªque°
(
mddev
, 
bio
);

526 
£˘‹_t
 
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

527 
chunk_£˘s
 = 
mddev
->
chunk_£˘‹s
;

529 
£˘‹s
 = 
chunk_£˘s
 -

530 (
	`likñy
(
	`is_powî_of_2
(
chunk_£˘s
))

531 ? (
£˘‹
 & (
chunk_£˘s
-1))

532 : 
	`£˘‹_div
(
£˘‹
, 
chunk_£˘s
));

534 i‡(
£˘‹s
 < 
	`bio_£˘‹s
(
bio
)) {

535 
•lô
 = 
	`bio_•lô
(
bio
, 
£˘‹s
, 
GFP_NOIO
, 
fs_bio_£t
);

536 
	`bio_chaö
(
•lô
, 
bio
);

538 
•lô
 = 
bio
;

541 
z⁄e
 = 
	`föd_z⁄e
(
mddev
->
¥iv©e
, &
£˘‹
);

542 
tmp_dev
 = 
	`m≠_£˘‹
(
mddev
, 
z⁄e
, 
£˘‹
, &sector);

543 
•lô
->
bi_bdev
 = 
tmp_dev
->
bdev
;

544 
•lô
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 + 
z⁄e
->
dev_°¨t
 +

545 
tmp_dev
->
d©a_off£t
;

547 i‡(
	`u∆ikñy
((
•lô
->
bi_rw
 & 
REQ_DISCARD
) &&

548 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
•lô
->
bi_bdev
)))) {

550 
	`bio_ídio
(
•lô
, 0);

552 
	`gíîic_make_ªque°
(
•lô
);

553 } 
•lô
 !
bio
);

554 
	}
}

556 
	$øid0_°©us
(
£q_fûe
 *
£q
, 
mddev
 *mddev)

558 
	`£q_¥ötf
(
£q
, " %dk chunks", 
mddev
->
chunk_£˘‹s
 / 2);

560 
	}
}

562 *
	$øid0_èkeovî_øid45
(
mddev
 *mddev)

564 
md_rdev
 *
rdev
;

565 
r0c⁄f
 *
¥iv_c⁄f
;

567 i‡(
mddev
->
degøded
 != 1) {

568 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s:Ñaid5 must be degraded! Degraded disks: %d\n",

569 
	`md«me
(
mddev
),

570 
mddev
->
degøded
);

571  
	`ERR_PTR
(-
EINVAL
);

574 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

576 i‡(
rdev
->
øid_disk
 =
mddev
->
øid_disks
-1) {

577 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s:Ñaid5 must have missingÖarity disk!\n",

578 
	`md«me
(
mddev
));

579  
	`ERR_PTR
(-
EINVAL
);

581 
rdev
->
£˘‹s
 = 
mddev
->
dev_£˘‹s
;

585 
mddev
->
√w_Àvñ
 = 0;

586 
mddev
->
√w_œyout
 = 0;

587 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

588 
mddev
->
øid_disks
--;

589 
mddev
->
dñè_disks
 = -1;

591 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

593 
	`¸óã_°rù_z⁄es
(
mddev
, &
¥iv_c⁄f
);

594  
¥iv_c⁄f
;

595 
	}
}

597 *
	$øid0_èkeovî_øid10
(
mddev
 *mddev)

599 
r0c⁄f
 *
¥iv_c⁄f
;

607 i‡(
mddev
->
œyout
 != ((1 << 8) + 2)) {

608 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s:: Raid0 cannotÅakoverÜayout: 0x%x\n",

609 
	`md«me
(
mddev
),

610 
mddev
->
œyout
);

611  
	`ERR_PTR
(-
EINVAL
);

613 i‡(
mddev
->
øid_disks
 & 1) {

614 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: Raid0 cannotÅakover Raid10 with odd diskÇumber.\n",

615 
	`md«me
(
mddev
));

616  
	`ERR_PTR
(-
EINVAL
);

618 i‡(
mddev
->
degøded
 !(mddev->
øid_disks
>>1)) {

619 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: All mirrors must beálready degraded!\n",

620 
	`md«me
(
mddev
));

621  
	`ERR_PTR
(-
EINVAL
);

625 
mddev
->
√w_Àvñ
 = 0;

626 
mddev
->
√w_œyout
 = 0;

627 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

628 
mddev
->
dñè_disks
 = - mddev->
øid_disks
 / 2;

629 
mddev
->
øid_disks
 +mddev->
dñè_disks
;

630 
mddev
->
degøded
 = 0;

632 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

634 
	`¸óã_°rù_z⁄es
(
mddev
, &
¥iv_c⁄f
);

635  
¥iv_c⁄f
;

636 
	}
}

638 *
	$øid0_èkeovî_øid1
(
mddev
 *mddev)

640 
r0c⁄f
 *
¥iv_c⁄f
;

641 
chunk£˘
;

646 i‡((
mddev
->
øid_disks
 - 1Ë!mddev->
degøded
) {

647 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: (N - 1) mirrors drives must beálready faulty!\n",

648 
	`md«me
(
mddev
));

649  
	`ERR_PTR
(-
EINVAL
);

656 
chunk£˘
 = 64 * 2;

659 
chunk£˘
 && (
mddev
->
¨øy_£˘‹s
 & (chunksect - 1)))

660 
chunk£˘
 >>= 1;

662 i‡((
chunk£˘
 << 9Ë< 
PAGE_SIZE
)

664  
	`ERR_PTR
(-
EINVAL
);

667 
mddev
->
√w_Àvñ
 = 0;

668 
mddev
->
√w_œyout
 = 0;

669 
mddev
->
√w_chunk_£˘‹s
 = 
chunk£˘
;

670 
mddev
->
chunk_£˘‹s
 = 
chunk£˘
;

671 
mddev
->
dñè_disks
 = 1 - mddev->
øid_disks
;

672 
mddev
->
øid_disks
 = 1;

674 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

676 
	`¸óã_°rù_z⁄es
(
mddev
, &
¥iv_c⁄f
);

677  
¥iv_c⁄f
;

678 
	}
}

680 *
	$øid0_èkeovî
(
mddev
 *mddev)

689 i‡(
mddev
->
bôm≠
) {

690 
	`¥ötk
(
KERN_ERR
 "md/raid0: %s: cannotÅakeoverárray with bitmap\n",

691 
	`md«me
(
mddev
));

692  
	`ERR_PTR
(-
EBUSY
);

694 i‡(
mddev
->
Àvñ
 == 4)

695  
	`øid0_èkeovî_øid45
(
mddev
);

697 i‡(
mddev
->
Àvñ
 == 5) {

698 i‡(
mddev
->
œyout
 =
ALGORITHM_PARITY_N
)

699  
	`øid0_èkeovî_øid45
(
mddev
);

701 
	`¥ötk
(
KERN_ERR
 "md/raid0:%s: Raid can onlyÅakeover Raid5 withÜayout: %d\n",

702 
	`md«me
(
mddev
), 
ALGORITHM_PARITY_N
);

705 i‡(
mddev
->
Àvñ
 == 10)

706  
	`øid0_èkeovî_øid10
(
mddev
);

708 i‡(
mddev
->
Àvñ
 == 1)

709  
	`øid0_èkeovî_øid1
(
mddev
);

711 
	`¥ötk
(
KERN_ERR
 "Takeover fromÑaid%iÅoÑaid0Çot supported\n",

712 
mddev
->
Àvñ
);

714  
	`ERR_PTR
(-
EINVAL
);

715 
	}
}

717 
	$øid0_quõs˚
(
mddev
 *mddev, 
°©e
)

719 
	}
}

721 
md_≥rs⁄Æôy
 
	gøid0_≥rs⁄Æôy
=

723 .
«me
 = "raid0",

724 .
	gÀvñ
 = 0,

725 .
	gow√r
 = 
THIS_MODULE
,

726 .
	gmake_ªque°
 = 
øid0_make_ªque°
,

727 .
	grun
 = 
øid0_run
,

728 .
	g°›
 = 
øid0_°›
,

729 .
	g°©us
 = 
øid0_°©us
,

730 .
	gsize
 = 
øid0_size
,

731 .
	gèkeovî
 = 
øid0_èkeovî
,

732 .
	gquõs˚
 = 
øid0_quõs˚
,

735 
__öô
 
	$øid0_öô
 ()

737  
	`ªgi°î_md_≥rs⁄Æôy
 (&
øid0_≥rs⁄Æôy
);

738 
	}
}

740 
	$øid0_exô
 ()

742 
	`uƒegi°î_md_≥rs⁄Æôy
 (&
øid0_≥rs⁄Æôy
);

743 
	}
}

745 
moduÀ_öô
(
øid0_öô
);

746 
moduÀ_exô
(
øid0_exô
);

747 
MODULE_LICENSE
("GPL");

748 
MODULE_DESCRIPTION
("RAID0 (striping)Öersonality for MD");

749 
MODULE_ALIAS
("md-personality-2");

750 
MODULE_ALIAS
("md-raid0");

751 
MODULE_ALIAS
("md-level-0");

	@raid0.h

1 #i‚de‡
_RAID0_H


2 
	#_RAID0_H


	)

4 
	s°rù_z⁄e
 {

5 
£˘‹_t
 
	mz⁄e_íd
;

6 
£˘‹_t
 
	mdev_°¨t
;

7 
	mnb_dev
;

10 
	sr0c⁄f
 {

11 
°rù_z⁄e
 *
	m°rù_z⁄e
;

12 
md_rdev
 **
	mdevli°
;

14 
	mƒ_°rù_z⁄es
;

15 
	mhas_mîge_bvec
;

	@raid0.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

24 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

25 { 0x719b4945, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_ªgi°î
) },

26 { 0xc1eb978a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_mîge_bvec
) },

27 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

28 { 0x33506218, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_disˇrd_£˘‹s
) },

29 { 0x3cb8db59, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_wrôe_ßme_£˘‹s
) },

30 { 0xdb27ab26, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_hw_£˘‹s
) },

31 { 0x35d3fbad, 
__VMLINUX_SYMBOL_STR
(
md_check_no_bôm≠
) },

32 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

33 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

34 { 0x9e4f2af3, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_›t
) },

35 { 0x1a79d6e1, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_mö
) },

36 { 0xf087137d, 
__VMLINUX_SYMBOL_STR
(
__dy«mic_¥_debug
) },

37 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

38 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

39 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

40 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

41 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

42 { 0x4101c3c9, 
__VMLINUX_SYMBOL_STR
(
md_Êush_ªque°
) },

43 { 0xfb254830, 
__VMLINUX_SYMBOL_STR
(
bio_chaö
) },

44 { 0xeb594c85, 
__VMLINUX_SYMBOL_STR
(
bio_•lô
) },

45 { 0x153e70d9, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

46 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

47 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

48 { 0x8c0603d0, 
__VMLINUX_SYMBOL_STR
(
blk_sync_queue
) },

49 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

50 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

51 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

52 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

55 c⁄° 
	g__moduÀ_dïíds
[]

56 
__u£d


57 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

61 
MODULE_INFO
(
§cvîsi⁄
, "B7503E35D08A4172EEC9D0C");

	@raid1.c

34 
	~<löux/¶ab.h
>

35 
	~<löux/dñay.h
>

36 
	~<löux/blkdev.h
>

37 
	~<löux/moduÀ.h
>

38 
	~<löux/£q_fûe.h
>

39 
	~<löux/øãlimô.h
>

40 
	~"md.h
"

41 
	~"øid1.h
"

42 
	~"bôm≠.h
"

47 
	#NR_RAID1_BIOS
 256

	)

54 
	#IO_BLOCKED
 ((
bio
 *)1)

	)

59 
	#IO_MADE_GOOD
 ((
bio
 *)2)

	)

61 
	#BIO_SPECIAL
(
bio
Ë(()biÿ<2)

	)

67 
	gmax_queued_ªque°s
 = 1024;

69 
Ælow_b¨rõr
(
r1c⁄f
 *
c⁄f
, 
£˘‹_t
 
°¨t_√xt_wödow
,

70 
£˘‹_t
 
bi_£˘‹
);

71 
lowî_b¨rõr
(
r1c⁄f
 *
c⁄f
);

73 * 
	$r1bio_poﬁ_Æloc
(
gÂ_t
 
gÂ_Êags
, *
d©a
)

75 
poﬁ_öfo
 *
pi
 = 
d©a
;

76 
size
 = 
	`off£tof
(
r1bio
, 
bios
[
pi
->
øid_disks
]);

79  
	`kzÆloc
(
size
, 
gÂ_Êags
);

80 
	}
}

82 
	$r1bio_poﬁ_‰ì
(*
r1_bio
, *
d©a
)

84 
	`k‰ì
(
r1_bio
);

85 
	}
}

87 
	#RESYNC_BLOCK_SIZE
 (64*1024)

	)

88 
	#RESYNC_DEPTH
 32

	)

89 
	#RESYNC_SECTORS
 (
RESYNC_BLOCK_SIZE
 >> 9)

	)

90 
	#RESYNC_PAGES
 ((
RESYNC_BLOCK_SIZE
 + 
PAGE_SIZE
-1Ë/ PAGE_SIZE)

	)

91 
	#RESYNC_WINDOW
 (
RESYNC_BLOCK_SIZE
 * 
RESYNC_DEPTH
)

	)

92 
	#RESYNC_WINDOW_SECTORS
 (
RESYNC_WINDOW
 >> 9)

	)

93 
	#NEXT_NORMALIO_DISTANCE
 (3 * 
RESYNC_WINDOW_SECTORS
)

	)

95 * 
	$r1buf_poﬁ_Æloc
(
gÂ_t
 
gÂ_Êags
, *
d©a
)

97 
poﬁ_öfo
 *
pi
 = 
d©a
;

98 
r1bio
 *
r1_bio
;

99 
bio
 *bio;

100 
√ed_∑ges
;

101 
i
, 
j
;

103 
r1_bio
 = 
	`r1bio_poﬁ_Æloc
(
gÂ_Êags
, 
pi
);

104 i‡(!
r1_bio
)

105  
NULL
;

110 
j
 = 
pi
->
øid_disks
 ; j-- ; ) {

111 
bio
 = 
	`bio_kmÆloc
(
gÂ_Êags
, 
RESYNC_PAGES
);

112 i‡(!
bio
)

113 
out_‰ì_bio
;

114 
r1_bio
->
bios
[
j
] = 
bio
;

122 i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
pi
->
mddev
->
ªcovîy
))

123 
√ed_∑ges
 = 
pi
->
øid_disks
;

125 
√ed_∑ges
 = 1;

126 
j
 = 0; j < 
√ed_∑ges
; j++) {

127 
bio
 = 
r1_bio
->
bios
[
j
];

128 
bio
->
bi_v˙t
 = 
RESYNC_PAGES
;

130 i‡(
	`bio_Æloc_∑ges
(
bio
, 
gÂ_Êags
))

131 
out_‰ì_∑ges
;

134 i‡(!
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
pi
->
mddev
->
ªcovîy
)) {

135 
i
=0; i<
RESYNC_PAGES
 ; i++)

136 
j
=1; j<
pi
->
øid_disks
; j++)

137 
r1_bio
->
bios
[
j
]->
bi_io_vec
[
i
].
bv_∑ge
 =

138 
r1_bio
->
bios
[0]->
bi_io_vec
[
i
].
bv_∑ge
;

141 
r1_bio
->
ma°î_bio
 = 
NULL
;

143  
r1_bio
;

145 
out_‰ì_∑ges
:

146 --
j
 >= 0) {

147 
bio_vec
 *
bv
;

149 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
r1_bio
->
bios
[
j
], 
i
)

150 
	`__‰ì_∑ge
(
bv
->
bv_∑ge
);

153 
out_‰ì_bio
:

154 ++
j
 < 
pi
->
øid_disks
)

155 
	`bio_put
(
r1_bio
->
bios
[
j
]);

156 
	`r1bio_poﬁ_‰ì
(
r1_bio
, 
d©a
);

157  
NULL
;

158 
	}
}

160 
	$r1buf_poﬁ_‰ì
(*
__r1_bio
, *
d©a
)

162 
poﬁ_öfo
 *
pi
 = 
d©a
;

163 
i
,
j
;

164 
r1bio
 *r1biÿ
__r1_bio
;

166 
i
 = 0; i < 
RESYNC_PAGES
; i++)

167 
j
 = 
pi
->
øid_disks
; j-- ;) {

168 i‡(
j
 == 0 ||

169 
r1bio
->
bios
[
j
]->
bi_io_vec
[
i
].
bv_∑ge
 !=

170 
r1bio
->
bios
[0]->
bi_io_vec
[
i
].
bv_∑ge
)

171 
	`ß„_put_∑ge
(
r1bio
->
bios
[
j
]->
bi_io_vec
[
i
].
bv_∑ge
);

173 
i
=0 ; i < 
pi
->
øid_disks
; i++)

174 
	`bio_put
(
r1bio
->
bios
[
i
]);

176 
	`r1bio_poﬁ_‰ì
(
r1bio
, 
d©a
);

177 
	}
}

179 
	$put_Æl_bios
(
r1c⁄f
 *
c⁄f
, 
r1bio
 *
r1_bio
)

181 
i
;

183 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

184 
bio
 **biÿ
r1_bio
->
bios
 + 
i
;

185 i‡(!
	`BIO_SPECIAL
(*
bio
))

186 
	`bio_put
(*
bio
);

187 *
bio
 = 
NULL
;

189 
	}
}

191 
	$‰ì_r1bio
(
r1bio
 *
r1_bio
)

193 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

195 
	`put_Æl_bios
(
c⁄f
, 
r1_bio
);

196 
	`mempoﬁ_‰ì
(
r1_bio
, 
c⁄f
->
r1bio_poﬁ
);

197 
	}
}

199 
	$put_buf
(
r1bio
 *
r1_bio
)

201 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

202 
i
;

204 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

205 
bio
 *biÿ
r1_bio
->
bios
[
i
];

206 i‡(
bio
->
bi_íd_io
)

207 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
i
].
rdev
, 
r1_bio
->
mddev
);

210 
	`mempoﬁ_‰ì
(
r1_bio
, 
c⁄f
->
r1buf_poﬁ
);

212 
	`lowî_b¨rõr
(
c⁄f
);

213 
	}
}

215 
	$ªscheduÀ_ªåy
(
r1bio
 *
r1_bio
)

217 
Êags
;

218 
mddev
 *mddev = 
r1_bio
->mddev;

219 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

221 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

222 
	`li°_add
(&
r1_bio
->
ªåy_li°
, &
c⁄f
->retry_list);

223 
c⁄f
->
ƒ_queued
 ++;

224 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

226 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

227 
	`md_wakeup_thªad
(
mddev
->
thªad
);

228 
	}
}

235 
	$ˇŒ_bio_ídio
(
r1bio
 *
r1_bio
)

237 
bio
 *biÿ
r1_bio
->
ma°î_bio
;

238 
d⁄e
;

239 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

240 
£˘‹_t
 
°¨t_√xt_wödow
 = 
r1_bio
->start_next_window;

241 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

243 i‡(
bio
->
bi_phys_£gmíts
) {

244 
Êags
;

245 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

246 
bio
->
bi_phys_£gmíts
--;

247 
d⁄e
 = (
bio
->
bi_phys_£gmíts
 == 0);

248 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

253 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

255 
d⁄e
 = 1;

257 i‡(!
	`ã°_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
))

258 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

259 i‡(
d⁄e
) {

260 
	`bio_ídio
(
bio
, 0);

265 
	`Ælow_b¨rõr
(
c⁄f
, 
°¨t_√xt_wödow
, 
bi_£˘‹
);

267 
	}
}

269 
	$øid_íd_bio_io
(
r1bio
 *
r1_bio
)

271 
bio
 *biÿ
r1_bio
->
ma°î_bio
;

274 i‡(!
	`ã°_™d_£t_bô
(
R1BIO_Rëu∫ed
, &
r1_bio
->
°©e
)) {

275 
	`¥_debug
("raid1: syncÉnd %s on sectors %llu-%llu\n",

276 (
	`bio_d©a_dú
(
bio
Ë=
WRITE
) ? "write" : "read",

277 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

278 (Ë
	`bio_íd_£˘‹
(
bio
) - 1);

280 
	`ˇŒ_bio_ídio
(
r1_bio
);

282 
	`‰ì_r1bio
(
r1_bio
);

283 
	}
}

288 
ölöe
 
	$upd©e_hód_pos
(
disk
, 
r1bio
 *
r1_bio
)

290 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

292 
c⁄f
->
múr‹s
[
disk
].
hód_posôi⁄
 =

293 
r1_bio
->
£˘‹
 + (r1_bio->
£˘‹s
);

294 
	}
}

299 
	$föd_bio_disk
(
r1bio
 *
r1_bio
, 
bio
 *bio)

301 
múr‹
;

302 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

303 
øid_disks
 = 
c⁄f
->raid_disks;

305 
múr‹
 = 0; múr‹ < 
øid_disks
 * 2; mirror++)

306 i‡(
r1_bio
->
bios
[
múr‹
] =
bio
)

309 
	`BUG_ON
(
múr‹
 =
øid_disks
 * 2);

310 
	`upd©e_hód_pos
(
múr‹
, 
r1_bio
);

312  
múr‹
;

313 
	}
}

315 
	$øid1_íd_ªad_ªque°
(
bio
 *bio, 
îr‹
)

317 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

318 
r1bio
 *
r1_bio
 = 
bio
->
bi_¥iv©e
;

319 
múr‹
;

320 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

322 
múr‹
 = 
r1_bio
->
ªad_disk
;

326 
	`upd©e_hód_pos
(
múr‹
, 
r1_bio
);

328 i‡(
u±od©e
)

329 
	`£t_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
);

335 
Êags
;

336 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

337 i‡(
r1_bio
->
mddev
->
degøded
 =
c⁄f
->
øid_disks
 ||

338 (
r1_bio
->
mddev
->
degøded
 =
c⁄f
->
øid_disks
-1 &&

339 !
	`ã°_bô
(
Fau…y
, &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
)))

340 
u±od©e
 = 1;

341 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

344 i‡(
u±od©e
) {

345 
	`øid_íd_bio_io
(
r1_bio
);

346 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
múr‹
].
rdev
, c⁄f->
mddev
);

351 
b
[
BDEVNAME_SIZE
];

352 
	`¥ötk_øãlimôed
(

353 
KERN_ERR
 "md/raid1:%s: %s: "

355 
	`md«me
(
c⁄f
->
mddev
),

356 
	`bdev«me
(
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
bdev
,

357 
b
),

358 ()
r1_bio
->
£˘‹
);

359 
	`£t_bô
(
R1BIO_RódEº‹
, &
r1_bio
->
°©e
);

360 
	`ªscheduÀ_ªåy
(
r1_bio
);

363 
	}
}

365 
	$˛o£_wrôe
(
r1bio
 *
r1_bio
)

368 i‡(
	`ã°_bô
(
R1BIO_BehödIO
, &
r1_bio
->
°©e
)) {

370 
i
 = 
r1_bio
->
behöd_∑ge_cou¡
;

371 
i
--)

372 
	`ß„_put_∑ge
(
r1_bio
->
behöd_bvecs
[
i
].
bv_∑ge
);

373 
	`k‰ì
(
r1_bio
->
behöd_bvecs
);

374 
r1_bio
->
behöd_bvecs
 = 
NULL
;

377 
	`bôm≠_ídwrôe
(
r1_bio
->
mddev
->
bôm≠
,Ñ1_bio->
£˘‹
,

378 
r1_bio
->
£˘‹s
,

379 !
	`ã°_bô
(
R1BIO_Degøded
, &
r1_bio
->
°©e
),

380 
	`ã°_bô
(
R1BIO_BehödIO
, &
r1_bio
->
°©e
));

381 
	`md_wrôe_íd
(
r1_bio
->
mddev
);

382 
	}
}

384 
	$r1_bio_wrôe_d⁄e
(
r1bio
 *
r1_bio
)

386 i‡(!
	`©omic_dec_™d_ã°
(&
r1_bio
->
ªmaöög
))

389 i‡(
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

390 
	`ªscheduÀ_ªåy
(
r1_bio
);

392 
	`˛o£_wrôe
(
r1_bio
);

393 i‡(
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
))

394 
	`ªscheduÀ_ªåy
(
r1_bio
);

396 
	`øid_íd_bio_io
(
r1_bio
);

398 
	}
}

400 
	$øid1_íd_wrôe_ªque°
(
bio
 *bio, 
îr‹
)

402 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

403 
r1bio
 *
r1_bio
 = 
bio
->
bi_¥iv©e
;

404 
múr‹
, 
behöd
 = 
	`ã°_bô
(
R1BIO_BehödIO
, &
r1_bio
->
°©e
);

405 
r1c⁄f
 *
c⁄f
 = 
r1_bio
->
mddev
->
¥iv©e
;

406 
bio
 *
to_put
 = 
NULL
;

408 
múr‹
 = 
	`föd_bio_disk
(
r1_bio
, 
bio
);

413 i‡(!
u±od©e
) {

414 
	`£t_bô
(
WrôeEº‹Sìn
,

415 &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
);

416 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
,

417 &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
))

418 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &

419 
c⁄f
->
mddev
->
ªcovîy
);

421 
	`£t_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
);

433 
£˘‹_t
 
fú°_bad
;

434 
bad_£˘‹s
;

436 
r1_bio
->
bios
[
múr‹
] = 
NULL
;

437 
to_put
 = 
bio
;

446 i‡(
	`ã°_bô
(
In_sync
, &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
) &&

447 !
	`ã°_bô
(
Fau…y
, &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
))

448 
	`£t_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
);

451 i‡(
	`is_badblock
(
c⁄f
->
múr‹s
[
múr‹
].
rdev
,

452 
r1_bio
->
£˘‹
,Ñ1_bio->
£˘‹s
,

453 &
fú°_bad
, &
bad_£˘‹s
)) {

454 
r1_bio
->
bios
[
múr‹
] = 
IO_MADE_GOOD
;

455 
	`£t_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
);

459 i‡(
behöd
) {

460 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
))

461 
	`©omic_dec
(&
r1_bio
->
behöd_ªmaöög
);

470 i‡(
	`©omic_ªad
(&
r1_bio
->
behöd_ªmaöög
Ë>◊tomic_ªad(&r1_bio->
ªmaöög
)-1) &&

471 
	`ã°_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
)) {

473 i‡(!
	`ã°_™d_£t_bô
(
R1BIO_Rëu∫ed
, &
r1_bio
->
°©e
)) {

474 
bio
 *
mbio
 = 
r1_bio
->
ma°î_bio
;

475 
	`¥_debug
("raid1: behindÉnd write sectors"

477 (Ë
mbio
->
bi_ôî
.
bi_£˘‹
,

478 (Ë
	`bio_íd_£˘‹
(
mbio
) - 1);

479 
	`ˇŒ_bio_ídio
(
r1_bio
);

483 i‡(
r1_bio
->
bios
[
múr‹
] =
NULL
)

484 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
múr‹
].
rdev
,

485 
c⁄f
->
mddev
);

491 
	`r1_bio_wrôe_d⁄e
(
r1_bio
);

493 i‡(
to_put
)

494 
	`bio_put
(
to_put
);

495 
	}
}

512 
	$ªad_bÆ™˚
(
r1c⁄f
 *
c⁄f
, 
r1bio
 *
r1_bio
, *
max_£˘‹s
)

514 c⁄° 
£˘‹_t
 
this_£˘‹
 = 
r1_bio
->
£˘‹
;

515 
£˘‹s
;

516 
be°_good_£˘‹s
;

517 
be°_disk
, 
be°_di°_disk
, 
be°_≥ndög_disk
;

518 
has_n⁄rŸ_disk
;

519 
disk
;

520 
£˘‹_t
 
be°_di°
;

521 
mö_≥ndög
;

522 
md_rdev
 *
rdev
;

523 
choo£_fú°
;

524 
choo£_√xt_idÀ
;

526 
	`rcu_ªad_lock
();

532 
ªåy
:

533 
£˘‹s
 = 
r1_bio
->sectors;

534 
be°_disk
 = -1;

535 
be°_di°_disk
 = -1;

536 
be°_di°
 = 
MaxSe˘‹
;

537 
be°_≥ndög_disk
 = -1;

538 
mö_≥ndög
 = 
UINT_MAX
;

539 
be°_good_£˘‹s
 = 0;

540 
has_n⁄rŸ_disk
 = 0;

541 
choo£_√xt_idÀ
 = 0;

543 i‡(
c⁄f
->
mddev
->
ªcovîy_˝
 < 
MaxSe˘‹
 &&

544 (
this_£˘‹
 + 
£˘‹s
 >
c⁄f
->
√xt_ªsync
))

545 
choo£_fú°
 = 1;

547 
choo£_fú°
 = 0;

549 
disk
 = 0 ; disk < 
c⁄f
->
øid_disks
 * 2 ; disk++) {

550 
£˘‹_t
 
di°
;

551 
£˘‹_t
 
fú°_bad
;

552 
bad_£˘‹s
;

553 
≥ndög
;

554 
boﬁ
 
n⁄rŸ
;

556 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
disk
].rdev);

557 i‡(
r1_bio
->
bios
[
disk
] =
IO_BLOCKED


558 || 
rdev
 =
NULL


559 || 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
)

560 || 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

562 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

563 
rdev
->
ªcovîy_off£t
 < 
this_£˘‹
 + 
£˘‹s
)

565 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
)) {

568 i‡(
be°_disk
 < 0) {

569 i‡(
	`is_badblock
(
rdev
, 
this_£˘‹
, 
£˘‹s
,

570 &
fú°_bad
, &
bad_£˘‹s
)) {

571 i‡(
fú°_bad
 < 
this_£˘‹
)

574 
be°_good_£˘‹s
 = 
fú°_bad
 - 
this_£˘‹
;

576 
be°_good_£˘‹s
 = 
£˘‹s
;

577 
be°_disk
 = 
disk
;

584 i‡(
	`is_badblock
(
rdev
, 
this_£˘‹
, 
£˘‹s
,

585 &
fú°_bad
, &
bad_£˘‹s
)) {

586 i‡(
be°_di°
 < 
MaxSe˘‹
)

589 i‡(
fú°_bad
 <
this_£˘‹
) {

594 
bad_£˘‹s
 -(
this_£˘‹
 - 
fú°_bad
);

595 i‡(
choo£_fú°
 && 
£˘‹s
 > 
bad_£˘‹s
)

596 
£˘‹s
 = 
bad_£˘‹s
;

597 i‡(
be°_good_£˘‹s
 > 
£˘‹s
)

598 
be°_good_£˘‹s
 = 
£˘‹s
;

601 
£˘‹_t
 
good_£˘‹s
 = 
fú°_bad
 - 
this_£˘‹
;

602 i‡(
good_£˘‹s
 > 
be°_good_£˘‹s
) {

603 
be°_good_£˘‹s
 = 
good_£˘‹s
;

604 
be°_disk
 = 
disk
;

606 i‡(
choo£_fú°
)

611 
be°_good_£˘‹s
 = 
£˘‹s
;

613 
n⁄rŸ
 = 
	`blk_queue_n⁄rŸ
(
	`bdev_gë_queue
(
rdev
->
bdev
));

614 
has_n⁄rŸ_disk
 |
n⁄rŸ
;

615 
≥ndög
 = 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
);

616 
di°
 = 
	`abs
(
this_£˘‹
 - 
c⁄f
->
múr‹s
[
disk
].
hód_posôi⁄
);

617 i‡(
choo£_fú°
) {

618 
be°_disk
 = 
disk
;

622 i‡(
c⁄f
->
múr‹s
[
disk
].
√xt_£q_£˘
 =
this_£˘‹


623 || 
di°
 == 0) {

624 
›t_iosize
 = 
	`bdev_io_›t
(
rdev
->
bdev
) >> 9;

625 
øid1_öfo
 *
múr‹
 = &
c⁄f
->
múr‹s
[
disk
];

627 
be°_disk
 = 
disk
;

641 i‡(
n⁄rŸ
 && 
›t_iosize
 > 0 &&

642 
múr‹
->
£q_°¨t
 !
MaxSe˘‹
 &&

643 
múr‹
->
√xt_£q_£˘
 > 
›t_iosize
 &&

644 
múr‹
->
√xt_£q_£˘
 - 
›t_iosize
 >=

645 
múr‹
->
£q_°¨t
) {

646 
choo£_√xt_idÀ
 = 1;

652 i‡(
≥ndög
 == 0) {

653 
be°_disk
 = 
disk
;

657 i‡(
choo£_√xt_idÀ
)

660 i‡(
mö_≥ndög
 > 
≥ndög
) {

661 
mö_≥ndög
 = 
≥ndög
;

662 
be°_≥ndög_disk
 = 
disk
;

665 i‡(
di°
 < 
be°_di°
) {

666 
be°_di°
 = 
di°
;

667 
be°_di°_disk
 = 
disk
;

677 i‡(
be°_disk
 == -1) {

678 i‡(
has_n⁄rŸ_disk
)

679 
be°_disk
 = 
be°_≥ndög_disk
;

681 
be°_disk
 = 
be°_di°_disk
;

684 i‡(
be°_disk
 >= 0) {

685 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
be°_disk
].rdev);

686 i‡(!
rdev
)

687 
ªåy
;

688 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

689 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

693 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

694 
ªåy
;

696 
£˘‹s
 = 
be°_good_£˘‹s
;

698 i‡(
c⁄f
->
múr‹s
[
be°_disk
].
√xt_£q_£˘
 !
this_£˘‹
)

699 
c⁄f
->
múr‹s
[
be°_disk
].
£q_°¨t
 = 
this_£˘‹
;

701 
c⁄f
->
múr‹s
[
be°_disk
].
√xt_£q_£˘
 = 
this_£˘‹
 + 
£˘‹s
;

703 
	`rcu_ªad_u∆ock
();

704 *
max_£˘‹s
 = 
£˘‹s
;

706  
be°_disk
;

707 
	}
}

709 
	$øid1_mîgóbÀ_bvec
(
ªque°_queue
 *
q
,

710 
bvec_mîge_d©a
 *
bvm
,

711 
bio_vec
 *
biovec
)

713 
mddev
 *mddev = 
q
->
queued©a
;

714 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

715 
£˘‹_t
 
£˘‹
 = 
bvm
->
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bvm->
bi_bdev
);

716 
max
 = 
biovec
->
bv_Àn
;

718 i‡(
mddev
->
mîge_check_√eded
) {

719 
disk
;

720 
	`rcu_ªad_lock
();

721 
disk
 = 0; disk < 
c⁄f
->
øid_disks
 * 2; disk++) {

722 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(

723 
c⁄f
->
múr‹s
[
disk
].
rdev
);

724 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

725 
ªque°_queue
 *
q
 =

726 
	`bdev_gë_queue
(
rdev
->
bdev
);

727 i‡(
q
->
mîge_bvec_‚
) {

728 
bvm
->
bi_£˘‹
 = 
£˘‹
 +

729 
rdev
->
d©a_off£t
;

730 
bvm
->
bi_bdev
 = 
rdev
->
bdev
;

731 
max
 = 
	`mö
(max, 
q
->
	`mîge_bvec_‚
(

732 
q
, 
bvm
, 
biovec
));

736 
	`rcu_ªad_u∆ock
();

738  
max
;

740 
	}
}

742 
	$md_øid1_c⁄ge°ed
(
mddev
 *mddev, 
bôs
)

744 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

745 
i
, 
ªt
 = 0;

747 i‡((
bôs
 & (1 << 
BDI_async_c⁄ge°ed
)) &&

748 
c⁄f
->
≥ndög_cou¡
 >
max_queued_ªque°s
)

751 
	`rcu_ªad_lock
();

752 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

753 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

754 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

755 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

757 
	`BUG_ON
(!
q
);

762 i‡((
bôs
 & (1<<
BDI_async_c⁄ge°ed
)) || 1)

763 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

765 
ªt
 &
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

768 
	`rcu_ªad_u∆ock
();

769  
ªt
;

770 
	}
}

771 
EXPORT_SYMBOL_GPL
(
md_øid1_c⁄ge°ed
);

773 
	$øid1_c⁄ge°ed
(*
d©a
, 
bôs
)

775 
mddev
 *mddev = 
d©a
;

777  
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
) ||

778 
	`md_øid1_c⁄ge°ed
(
mddev
, 
bôs
);

779 
	}
}

781 
	$Êush_≥ndög_wrôes
(
r1c⁄f
 *
c⁄f
)

786 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

788 i‡(
c⁄f
->
≥ndög_bio_li°
.
hód
) {

789 
bio
 *bio;

790 
bio
 = 
	`bio_li°_gë
(&
c⁄f
->
≥ndög_bio_li°
);

791 
c⁄f
->
≥ndög_cou¡
 = 0;

792 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

795 
	`bôm≠_u≈lug
(
c⁄f
->
mddev
->
bôm≠
);

796 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

798 
bio
) {

799 
bio
 *
√xt
 = bio->
bi_√xt
;

800 
bio
->
bi_√xt
 = 
NULL
;

801 i‡(
	`u∆ikñy
((
bio
->
bi_rw
 & 
REQ_DISCARD
) &&

802 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
bio
->
bi_bdev
))))

804 
	`bio_ídio
(
bio
, 0);

806 
	`gíîic_make_ªque°
(
bio
);

807 
bio
 = 
√xt
;

810 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

811 
	}
}

834 
	$øi£_b¨rõr
(
r1c⁄f
 *
c⁄f
)

836 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

839 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
, !c⁄f->
ƒ_waôög
,

840 
c⁄f
->
ªsync_lock
);

843 
c⁄f
->
b¨rõr
++;

853 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
,

854 !
c⁄f
->
¨øy_‰ozí
 &&

855 
c⁄f
->
b¨rõr
 < 
RESYNC_DEPTH
 &&

856 (
c⁄f
->
°¨t_√xt_wödow
 >=

857 
c⁄f
->
√xt_ªsync
 + 
RESYNC_SECTORS
),

858 
c⁄f
->
ªsync_lock
);

860 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

861 
	}
}

863 
	$lowî_b¨rõr
(
r1c⁄f
 *
c⁄f
)

865 
Êags
;

866 
	`BUG_ON
(
c⁄f
->
b¨rõr
 <= 0);

867 
	`•ö_lock_úqßve
(&
c⁄f
->
ªsync_lock
, 
Êags
);

868 
c⁄f
->
b¨rõr
--;

869 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
ªsync_lock
, 
Êags
);

870 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

871 
	}
}

873 
boﬁ
 
	$√ed_to_waô_f‹_sync
(
r1c⁄f
 *
c⁄f
, 
bio
 *bio)

875 
boﬁ
 
waô
 = 
Ál£
;

877 i‡(
c⁄f
->
¨øy_‰ozí
 || !
bio
)

878 
waô
 = 
åue
;

879 i‡(
c⁄f
->
b¨rõr
 && 
	`bio_d©a_dú
(
bio
Ë=
WRITE
) {

880 i‡(
c⁄f
->
√xt_ªsync
 < 
RESYNC_WINDOW_SECTORS
)

881 
waô
 = 
åue
;

882 i‡((
c⁄f
->
√xt_ªsync
 - 
RESYNC_WINDOW_SECTORS


883 >
	`bio_íd_£˘‹
(
bio
)) ||

884 (
c⁄f
->
√xt_ªsync
 + 
NEXT_NORMALIO_DISTANCE


885 <
bio
->
bi_ôî
.
bi_£˘‹
))

886 
waô
 = 
Ál£
;

888 
waô
 = 
åue
;

891  
waô
;

892 
	}
}

894 
£˘‹_t
 
	$waô_b¨rõr
(
r1c⁄f
 *
c⁄f
, 
bio
 *bio)

896 
£˘‹_t
 
£˘‹
 = 0;

898 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

899 i‡(
	`√ed_to_waô_f‹_sync
(
c⁄f
, 
bio
)) {

900 
c⁄f
->
ƒ_waôög
++;

910 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
,

911 !
c⁄f
->
¨øy_‰ozí
 &&

912 (!
c⁄f
->
b¨rõr
 ||

913 ((
c⁄f
->
°¨t_√xt_wödow
 <

914 
c⁄f
->
√xt_ªsync
 + 
RESYNC_SECTORS
) &&

915 
cuºít
->
bio_li°
 &&

916 !
	`bio_li°_em±y
(
cuºít
->
bio_li°
))),

917 
c⁄f
->
ªsync_lock
);

918 
c⁄f
->
ƒ_waôög
--;

921 i‡(
bio
 && 
	`bio_d©a_dú
(bioË=
WRITE
) {

922 i‡(
c⁄f
->
√xt_ªsync
 + 
NEXT_NORMALIO_DISTANCE


923 <
bio
->
bi_ôî
.
bi_£˘‹
) {

924 i‡(
c⁄f
->
°¨t_√xt_wödow
 =
MaxSe˘‹
)

925 
c⁄f
->
°¨t_√xt_wödow
 =

926 
c⁄f
->
√xt_ªsync
 +

927 
NEXT_NORMALIO_DISTANCE
;

929 i‡((
c⁄f
->
°¨t_√xt_wödow
 + 
NEXT_NORMALIO_DISTANCE
)

930 <
bio
->
bi_ôî
.
bi_£˘‹
)

931 
c⁄f
->
√xt_wödow_ªque°s
++;

933 
c⁄f
->
cuºít_wödow_ªque°s
++;

934 
£˘‹
 = 
c⁄f
->
°¨t_√xt_wödow
;

938 
c⁄f
->
ƒ_≥ndög
++;

939 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

940  
£˘‹
;

941 
	}
}

943 
	$Ælow_b¨rõr
(
r1c⁄f
 *
c⁄f
, 
£˘‹_t
 
°¨t_√xt_wödow
,

944 
£˘‹_t
 
bi_£˘‹
)

946 
Êags
;

948 
	`•ö_lock_úqßve
(&
c⁄f
->
ªsync_lock
, 
Êags
);

949 
c⁄f
->
ƒ_≥ndög
--;

950 i‡(
°¨t_√xt_wödow
) {

951 i‡(
°¨t_√xt_wödow
 =
c⁄f
->start_next_window) {

952 i‡(
c⁄f
->
°¨t_√xt_wödow
 + 
NEXT_NORMALIO_DISTANCE


953 <
bi_£˘‹
)

954 
c⁄f
->
√xt_wödow_ªque°s
--;

956 
c⁄f
->
cuºít_wödow_ªque°s
--;

958 
c⁄f
->
cuºít_wödow_ªque°s
--;

960 i‡(!
c⁄f
->
cuºít_wödow_ªque°s
) {

961 i‡(
c⁄f
->
√xt_wödow_ªque°s
) {

962 
c⁄f
->
cuºít_wödow_ªque°s
 =

963 
c⁄f
->
√xt_wödow_ªque°s
;

964 
c⁄f
->
√xt_wödow_ªque°s
 = 0;

965 
c⁄f
->
°¨t_√xt_wödow
 +=

966 
NEXT_NORMALIO_DISTANCE
;

968 
c⁄f
->
°¨t_√xt_wödow
 = 
MaxSe˘‹
;

971 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
ªsync_lock
, 
Êags
);

972 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

973 
	}
}

975 
	$‰ìze_¨øy
(
r1c⁄f
 *
c⁄f
, 
exåa
)

988 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

989 
c⁄f
->
¨øy_‰ozí
 = 1;

990 
	`waô_evít_lock_úq_cmd
(
c⁄f
->
waô_b¨rõr
,

991 
c⁄f
->
ƒ_≥ndög
 =c⁄f->
ƒ_queued
+
exåa
,

992 
c⁄f
->
ªsync_lock
,

993 
	`Êush_≥ndög_wrôes
(
c⁄f
));

994 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

995 
	}
}

996 
	$un‰ìze_¨øy
(
r1c⁄f
 *
c⁄f
)

999 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

1000 
c⁄f
->
¨øy_‰ozí
 = 0;

1001 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1002 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

1003 
	}
}

1008 
	$Æloc_behöd_∑ges
(
bio
 *bio, 
r1bio
 *
r1_bio
)

1010 
i
;

1011 
bio_vec
 *
bvec
;

1012 
bio_vec
 *
bvecs
 = 
	`kzÆloc
(
bio
->
bi_v˙t
 * (bio_vec),

1013 
GFP_NOIO
);

1014 i‡(
	`u∆ikñy
(!
bvecs
))

1017 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
i
) {

1018 
bvecs
[
i
] = *
bvec
;

1019 
bvecs
[
i
].
bv_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOIO
);

1020 i‡(
	`u∆ikñy
(!
bvecs
[
i
].
bv_∑ge
))

1021 
do_sync_io
;

1022 
	`mem˝y
(
	`km≠
(
bvecs
[
i
].
bv_∑ge
Ë+ 
bvec
->
bv_off£t
,

1023 
	`km≠
(
bvec
->
bv_∑ge
Ë+ bvec->
bv_off£t
, bvec->
bv_Àn
);

1024 
	`kunm≠
(
bvecs
[
i
].
bv_∑ge
);

1025 
	`kunm≠
(
bvec
->
bv_∑ge
);

1027 
r1_bio
->
behöd_bvecs
 = 
bvecs
;

1028 
r1_bio
->
behöd_∑ge_cou¡
 = 
bio
->
bi_v˙t
;

1029 
	`£t_bô
(
R1BIO_BehödIO
, &
r1_bio
->
°©e
);

1032 
do_sync_io
:

1033 
i
 = 0; i < 
bio
->
bi_v˙t
; i++)

1034 i‡(
bvecs
[
i
].
bv_∑ge
)

1035 
	`put_∑ge
(
bvecs
[
i
].
bv_∑ge
);

1036 
	`k‰ì
(
bvecs
);

1037 
	`¥_debug
("%dB behindálloc failed, doing sync I/O\n",

1038 
bio
->
bi_ôî
.
bi_size
);

1039 
	}
}

1041 
	søid1_∂ug_cb
 {

1042 
blk_∂ug_cb
 
	mcb
;

1043 
bio_li°
 
	m≥ndög
;

1044 
	m≥ndög_˙t
;

1047 
	$øid1_u≈lug
(
blk_∂ug_cb
 *
cb
, 
boﬁ
 
‰om_scheduÀ
)

1049 
øid1_∂ug_cb
 *
∂ug
 = 
	`c⁄èöî_of
(
cb
, raid1_plug_cb,

1050 
cb
);

1051 
mddev
 *mddev = 
∂ug
->
cb
.
d©a
;

1052 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1053 
bio
 *bio;

1055 i‡(
‰om_scheduÀ
 || 
cuºít
->
bio_li°
) {

1056 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1057 
	`bio_li°_mîge
(&
c⁄f
->
≥ndög_bio_li°
, &
∂ug
->
≥ndög
);

1058 
c⁄f
->
≥ndög_cou¡
 +
∂ug
->
≥ndög_˙t
;

1059 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1060 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1061 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1062 
	`k‰ì
(
∂ug
);

1067 
bio
 = 
	`bio_li°_gë
(&
∂ug
->
≥ndög
);

1068 
	`bôm≠_u≈lug
(
mddev
->
bôm≠
);

1069 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1071 
bio
) {

1072 
bio
 *
√xt
 = bio->
bi_√xt
;

1073 
bio
->
bi_√xt
 = 
NULL
;

1074 i‡(
	`u∆ikñy
((
bio
->
bi_rw
 & 
REQ_DISCARD
) &&

1075 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
bio
->
bi_bdev
))))

1077 
	`bio_ídio
(
bio
, 0);

1079 
	`gíîic_make_ªque°
(
bio
);

1080 
bio
 = 
√xt
;

1082 
	`k‰ì
(
∂ug
);

1083 
	}
}

1085 
	$make_ªque°
(
mddev
 *mddev, 
bio
 * bio)

1087 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1088 
øid1_öfo
 *
múr‹
;

1089 
r1bio
 *
r1_bio
;

1090 
bio
 *
ªad_bio
;

1091 
i
, 
disks
;

1092 
bôm≠
 *bitmap;

1093 
Êags
;

1094 c⁄° 
rw
 = 
	`bio_d©a_dú
(
bio
);

1095 c⁄° 
do_sync
 = (
bio
->
bi_rw
 & 
REQ_SYNC
);

1096 c⁄° 
do_Êush_fua
 = (
bio
->
bi_rw
 & (
REQ_FLUSH
 | 
REQ_FUA
));

1097 c⁄° 
do_disˇrd
 = (
bio
->
bi_rw


1098 & (
REQ_DISCARD
 | 
REQ_SECURE
));

1099 c⁄° 
do_ßme
 = (
bio
->
bi_rw
 & 
REQ_WRITE_SAME
);

1100 
md_rdev
 *
blocked_rdev
;

1101 
blk_∂ug_cb
 *
cb
;

1102 
øid1_∂ug_cb
 *
∂ug
 = 
NULL
;

1103 
fú°_˛⁄e
;

1104 
£˘‹s_h™dÀd
;

1105 
max_£˘‹s
;

1106 
£˘‹_t
 
°¨t_√xt_wödow
;

1114 
	`md_wrôe_°¨t
(
mddev
, 
bio
);

1116 i‡(
	`bio_d©a_dú
(
bio
Ë=
WRITE
 &&

1117 
	`bio_íd_£˘‹
(
bio
Ë> 
mddev
->
su•íd_lo
 &&

1118 
bio
->
bi_ôî
.
bi_£˘‹
 < 
mddev
->
su•íd_hi
) {

1123 
	`DEFINE_WAIT
(
w
);

1125 
	`Êush_sig«ls
(
cuºít
);

1126 
	`¥ï¨e_to_waô
(&
c⁄f
->
waô_b¨rõr
,

1127 &
w
, 
TASK_INTERRUPTIBLE
);

1128 i‡(
	`bio_íd_£˘‹
(
bio
Ë<
mddev
->
su•íd_lo
 ||

1129 
bio
->
bi_ôî
.
bi_£˘‹
 >
mddev
->
su•íd_hi
)

1131 
	`scheduÀ
();

1133 
	`föish_waô
(&
c⁄f
->
waô_b¨rõr
, &
w
);

1136 
°¨t_√xt_wödow
 = 
	`waô_b¨rõr
(
c⁄f
, 
bio
);

1138 
bôm≠
 = 
mddev
->bitmap;

1145 
r1_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r1bio_poﬁ
, 
GFP_NOIO
);

1147 
r1_bio
->
ma°î_bio
 = 
bio
;

1148 
r1_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

1149 
r1_bio
->
°©e
 = 0;

1150 
r1_bio
->
mddev
 = mddev;

1151 
r1_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

1160 
bio
->
bi_phys_£gmíts
 = 0;

1161 
	`˛ór_bô
(
BIO_SEG_VALID
, &
bio
->
bi_Êags
);

1163 i‡(
rw
 =
READ
) {

1167 
rdisk
;

1169 
ªad_agaö
:

1170 
rdisk
 = 
	`ªad_bÆ™˚
(
c⁄f
, 
r1_bio
, &
max_£˘‹s
);

1172 i‡(
rdisk
 < 0) {

1174 
	`øid_íd_bio_io
(
r1_bio
);

1177 
múr‹
 = 
c⁄f
->
múr‹s
 + 
rdisk
;

1179 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
múr‹
->
rdev
->
Êags
) &&

1180 
bôm≠
) {

1185 
	`waô_evít
(
bôm≠
->
behöd_waô
,

1186 
	`©omic_ªad
(&
bôm≠
->
behöd_wrôes
) == 0);

1188 
r1_bio
->
ªad_disk
 = 
rdisk
;

1190 
ªad_bio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

1191 
	`bio_åim
(
ªad_bio
, 
r1_bio
->
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
,

1192 
max_£˘‹s
);

1194 
r1_bio
->
bios
[
rdisk
] = 
ªad_bio
;

1196 
ªad_bio
->
bi_ôî
.
bi_£˘‹
 = 
r1_bio
->
£˘‹
 +

1197 
múr‹
->
rdev
->
d©a_off£t
;

1198 
ªad_bio
->
bi_bdev
 = 
múr‹
->
rdev
->
bdev
;

1199 
ªad_bio
->
bi_íd_io
 = 
øid1_íd_ªad_ªque°
;

1200 
ªad_bio
->
bi_rw
 = 
READ
 | 
do_sync
;

1201 
ªad_bio
->
bi_¥iv©e
 = 
r1_bio
;

1203 i‡(
max_£˘‹s
 < 
r1_bio
->
£˘‹s
) {

1208 
£˘‹s_h™dÀd
 = (
r1_bio
->
£˘‹
 + 
max_£˘‹s


1209 - 
bio
->
bi_ôî
.
bi_£˘‹
);

1210 
r1_bio
->
£˘‹s
 = 
max_£˘‹s
;

1211 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1212 i‡(
bio
->
bi_phys_£gmíts
 == 0)

1213 
bio
->
bi_phys_£gmíts
 = 2;

1215 
bio
->
bi_phys_£gmíts
++;

1216 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1222 
	`ªscheduÀ_ªåy
(
r1_bio
);

1224 
r1_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r1bio_poﬁ
, 
GFP_NOIO
);

1226 
r1_bio
->
ma°î_bio
 = 
bio
;

1227 
r1_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
bio
Ë- 
£˘‹s_h™dÀd
;

1228 
r1_bio
->
°©e
 = 0;

1229 
r1_bio
->
mddev
 = mddev;

1230 
r1_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
 +

1231 
£˘‹s_h™dÀd
;

1232 
ªad_agaö
;

1234 
	`gíîic_make_ªque°
(
ªad_bio
);

1241 i‡(
c⁄f
->
≥ndög_cou¡
 >
max_queued_ªque°s
) {

1242 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1243 
	`waô_evít
(
c⁄f
->
waô_b¨rõr
,

1244 
c⁄f
->
≥ndög_cou¡
 < 
max_queued_ªque°s
);

1257 
disks
 = 
c⁄f
->
øid_disks
 * 2;

1258 
ªåy_wrôe
:

1259 
r1_bio
->
°¨t_√xt_wödow
 = start_next_window;

1260 
blocked_rdev
 = 
NULL
;

1261 
	`rcu_ªad_lock
();

1262 
max_£˘‹s
 = 
r1_bio
->
£˘‹s
;

1263 
i
 = 0; i < 
disks
; i++) {

1264 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

1265 i‡(
rdev
 && 
	`u∆ikñy
(
	`ã°_bô
(
Blocked
, &rdev->
Êags
))) {

1266 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

1267 
blocked_rdev
 = 
rdev
;

1270 
r1_bio
->
bios
[
i
] = 
NULL
;

1271 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)

1272 || 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
)) {

1273 i‡(
i
 < 
c⁄f
->
øid_disks
)

1274 
	`£t_bô
(
R1BIO_Degøded
, &
r1_bio
->
°©e
);

1278 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

1279 i‡(
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
)) {

1280 
£˘‹_t
 
fú°_bad
;

1281 
bad_£˘‹s
;

1282 
is_bad
;

1284 
is_bad
 = 
	`is_badblock
(
rdev
, 
r1_bio
->
£˘‹
,

1285 
max_£˘‹s
,

1286 &
fú°_bad
, &
bad_£˘‹s
);

1287 i‡(
is_bad
 < 0) {

1290 
	`£t_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

1291 
blocked_rdev
 = 
rdev
;

1294 i‡(
is_bad
 && 
fú°_bad
 <
r1_bio
->
£˘‹
) {

1296 
bad_£˘‹s
 -(
r1_bio
->
£˘‹
 - 
fú°_bad
);

1297 i‡(
bad_£˘‹s
 < 
max_£˘‹s
)

1301 
max_£˘‹s
 = 
bad_£˘‹s
;

1302 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

1315 i‡(
is_bad
) {

1316 
good_£˘‹s
 = 
fú°_bad
 - 
r1_bio
->
£˘‹
;

1317 i‡(
good_£˘‹s
 < 
max_£˘‹s
)

1318 
max_£˘‹s
 = 
good_£˘‹s
;

1321 
r1_bio
->
bios
[
i
] = 
bio
;

1323 
	`rcu_ªad_u∆ock
();

1325 i‡(
	`u∆ikñy
(
blocked_rdev
)) {

1327 
j
;

1328 
£˘‹_t
 
ﬁd
 = 
°¨t_√xt_wödow
;

1330 
j
 = 0; j < 
i
; j++)

1331 i‡(
r1_bio
->
bios
[
j
])

1332 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
j
].
rdev
, 
mddev
);

1333 
r1_bio
->
°©e
 = 0;

1334 
	`Ælow_b¨rõr
(
c⁄f
, 
°¨t_√xt_wödow
, 
bio
->
bi_ôî
.
bi_£˘‹
);

1335 
	`md_waô_f‹_blocked_rdev
(
blocked_rdev
, 
mddev
);

1336 
°¨t_√xt_wödow
 = 
	`waô_b¨rõr
(
c⁄f
, 
bio
);

1341 i‡(
bio
->
bi_phys_£gmíts
 && 
ﬁd
 &&

1342 
ﬁd
 !
°¨t_√xt_wödow
)

1344 
	`waô_evít
(
c⁄f
->
waô_b¨rõr
,

1345 
bio
->
bi_phys_£gmíts
 == 1);

1346 
ªåy_wrôe
;

1349 i‡(
max_£˘‹s
 < 
r1_bio
->
£˘‹s
) {

1353 
r1_bio
->
£˘‹s
 = 
max_£˘‹s
;

1354 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1355 i‡(
bio
->
bi_phys_£gmíts
 == 0)

1356 
bio
->
bi_phys_£gmíts
 = 2;

1358 
bio
->
bi_phys_£gmíts
++;

1359 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1361 
£˘‹s_h™dÀd
 = 
r1_bio
->
£˘‹
 + 
max_£˘‹s
 - 
bio
->
bi_ôî
.
bi_£˘‹
;

1363 
	`©omic_£t
(&
r1_bio
->
ªmaöög
, 1);

1364 
	`©omic_£t
(&
r1_bio
->
behöd_ªmaöög
, 0);

1366 
fú°_˛⁄e
 = 1;

1367 
i
 = 0; i < 
disks
; i++) {

1368 
bio
 *
mbio
;

1369 i‡(!
r1_bio
->
bios
[
i
])

1372 
mbio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

1373 
	`bio_åim
(
mbio
, 
r1_bio
->
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
, 
max_£˘‹s
);

1375 i‡(
fú°_˛⁄e
) {

1380 i‡(
bôm≠
 &&

1381 (
	`©omic_ªad
(&
bôm≠
->
behöd_wrôes
)

1382 < 
mddev
->
bôm≠_öfo
.
max_wrôe_behöd
) &&

1383 !
	`waôqueue_a˘ive
(&
bôm≠
->
behöd_waô
))

1384 
	`Æloc_behöd_∑ges
(
mbio
, 
r1_bio
);

1386 
	`bôm≠_°¨twrôe
(
bôm≠
, 
r1_bio
->
£˘‹
,

1387 
r1_bio
->
£˘‹s
,

1388 
	`ã°_bô
(
R1BIO_BehödIO
,

1389 &
r1_bio
->
°©e
));

1390 
fú°_˛⁄e
 = 0;

1392 i‡(
r1_bio
->
behöd_bvecs
) {

1393 
bio_vec
 *
bvec
;

1394 
j
;

1399 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
mbio
, 
j
)

1400 
bvec
->
bv_∑ge
 = 
r1_bio
->
behöd_bvecs
[
j
].bv_page;

1401 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
c⁄f
->
múr‹s
[
i
].
rdev
->
Êags
))

1402 
	`©omic_öc
(&
r1_bio
->
behöd_ªmaöög
);

1405 
r1_bio
->
bios
[
i
] = 
mbio
;

1407 
mbio
->
bi_ôî
.
bi_£˘‹
 = (
r1_bio
->
£˘‹
 +

1408 
c⁄f
->
múr‹s
[
i
].
rdev
->
d©a_off£t
);

1409 
mbio
->
bi_bdev
 = 
c⁄f
->
múr‹s
[
i
].
rdev
->
bdev
;

1410 
mbio
->
bi_íd_io
 = 
øid1_íd_wrôe_ªque°
;

1411 
mbio
->
bi_rw
 =

1412 
WRITE
 | 
do_Êush_fua
 | 
do_sync
 | 
do_disˇrd
 | 
do_ßme
;

1413 
mbio
->
bi_¥iv©e
 = 
r1_bio
;

1415 
	`©omic_öc
(&
r1_bio
->
ªmaöög
);

1417 
cb
 = 
	`blk_check_∂ugged
(
øid1_u≈lug
, 
mddev
, (*
∂ug
));

1418 i‡(
cb
)

1419 
∂ug
 = 
	`c⁄èöî_of
(
cb
, 
øid1_∂ug_cb
, cb);

1421 
∂ug
 = 
NULL
;

1422 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1423 i‡(
∂ug
) {

1424 
	`bio_li°_add
(&
∂ug
->
≥ndög
, 
mbio
);

1425 
∂ug
->
≥ndög_˙t
++;

1427 
	`bio_li°_add
(&
c⁄f
->
≥ndög_bio_li°
, 
mbio
);

1428 
c⁄f
->
≥ndög_cou¡
++;

1430 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1431 i‡(!
∂ug
)

1432 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1437 i‡(
£˘‹s_h™dÀd
 < 
	`bio_£˘‹s
(
bio
)) {

1438 
	`r1_bio_wrôe_d⁄e
(
r1_bio
);

1442 
r1_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r1bio_poﬁ
, 
GFP_NOIO
);

1443 
r1_bio
->
ma°î_bio
 = 
bio
;

1444 
r1_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
bio
Ë- 
£˘‹s_h™dÀd
;

1445 
r1_bio
->
°©e
 = 0;

1446 
r1_bio
->
mddev
 = mddev;

1447 
r1_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s_h™dÀd
;

1448 
ªåy_wrôe
;

1451 
	`r1_bio_wrôe_d⁄e
(
r1_bio
);

1454 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1455 
	}
}

1457 
	$°©us
(
£q_fûe
 *
£q
, 
mddev
 *mddev)

1459 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1460 
i
;

1462 
	`£q_¥ötf
(
£q
, " [%d/%d] [", 
c⁄f
->
øid_disks
,

1463 
c⁄f
->
øid_disks
 - 
mddev
->
degøded
);

1464 
	`rcu_ªad_lock
();

1465 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

1466 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

1467 
	`£q_¥ötf
(
£q
, "%s",

1468 
rdev
 && 
	`ã°_bô
(
In_sync
, &rdev->
Êags
) ? "U" : "_");

1470 
	`rcu_ªad_u∆ock
();

1471 
	`£q_¥ötf
(
£q
, "]");

1472 
	}
}

1475 
	$îr‹
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1477 
b
[
BDEVNAME_SIZE
];

1478 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1486 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

1487 && (
c⁄f
->
øid_disks
 - 
mddev
->
degøded
) == 1) {

1494 
c⁄f
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled;

1497 
	`£t_bô
(
Blocked
, &
rdev
->
Êags
);

1498 i‡(
	`ã°_™d_˛ór_bô
(
In_sync
, &
rdev
->
Êags
)) {

1499 
Êags
;

1500 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1501 
mddev
->
degøded
++;

1502 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1503 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1505 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1509 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

1510 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

1511 
	`¥ötk
(
KERN_ALERT


1514 
	`md«me
(
mddev
), 
	`bdev«me
(
rdev
->
bdev
, 
b
),

1515 
	`md«me
(
mddev
), 
c⁄f
->
øid_disks
 - mddev->
degøded
);

1516 
	}
}

1518 
	$¥öt_c⁄f
(
r1c⁄f
 *
c⁄f
)

1520 
i
;

1522 
	`¥ötk
(
KERN_DEBUG
 "RAID1 confÖrintout:\n");

1523 i‡(!
c⁄f
) {

1524 
	`¥ötk
(
KERN_DEBUG
 "(!conf)\n");

1527 
	`¥ötk
(
KERN_DEBUG
 " --- wd:%dÑd:%d\n", 
c⁄f
->
øid_disks
 - c⁄f->
mddev
->
degøded
,

1528 
c⁄f
->
øid_disks
);

1530 
	`rcu_ªad_lock
();

1531 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

1532 
b
[
BDEVNAME_SIZE
];

1533 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

1534 i‡(
rdev
)

1535 
	`¥ötk
(
KERN_DEBUG
 " disk %d, wo:%d, o:%d, dev:%s\n",

1536 
i
, !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
),

1537 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
),

1538 
	`bdev«me
(
rdev
->
bdev
,
b
));

1540 
	`rcu_ªad_u∆ock
();

1541 
	}
}

1543 
	$˛o£_sync
(
r1c⁄f
 *
c⁄f
)

1545 
	`waô_b¨rõr
(
c⁄f
, 
NULL
);

1546 
	`Ælow_b¨rõr
(
c⁄f
, 0, 0);

1548 
	`mempoﬁ_de°roy
(
c⁄f
->
r1buf_poﬁ
);

1549 
c⁄f
->
r1buf_poﬁ
 = 
NULL
;

1551 
c⁄f
->
√xt_ªsync
 = 0;

1552 
c⁄f
->
°¨t_√xt_wödow
 = 
MaxSe˘‹
;

1553 
	}
}

1555 
	$øid1_•¨e_a˘ive
(
mddev
 *mddev)

1557 
i
;

1558 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1559 
cou¡
 = 0;

1560 
Êags
;

1567 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

1568 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
i
].rdev;

1569 
md_rdev
 *
ª∂
 = 
c⁄f
->
múr‹s
[c⁄f->
øid_disks
 + 
i
].
rdev
;

1570 i‡(
ª∂


1571 && 
ª∂
->
ªcovîy_off£t
 =
MaxSe˘‹


1572 && !
	`ã°_bô
(
Fau…y
, &
ª∂
->
Êags
)

1573 && !
	`ã°_™d_£t_bô
(
In_sync
, &
ª∂
->
Êags
)) {

1575 i‡(!
rdev
 ||

1576 !
	`ã°_™d_˛ór_bô
(
In_sync
, &
rdev
->
Êags
))

1577 
cou¡
++;

1578 i‡(
rdev
) {

1583 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1584 
	`sysfs_nŸify_dúít_ß„
(

1585 
rdev
->
sysfs_°©e
);

1588 i‡(
rdev


1589 && 
rdev
->
ªcovîy_off£t
 =
MaxSe˘‹


1590 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)

1591 && !
	`ã°_™d_£t_bô
(
In_sync
, &
rdev
->
Êags
)) {

1592 
cou¡
++;

1593 
	`sysfs_nŸify_dúít_ß„
(
rdev
->
sysfs_°©e
);

1596 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1597 
mddev
->
degøded
 -
cou¡
;

1598 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1600 
	`¥öt_c⁄f
(
c⁄f
);

1601  
cou¡
;

1602 
	}
}

1605 
	$øid1_add_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1607 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1608 
îr
 = -
EEXIST
;

1609 
múr‹
 = 0;

1610 
øid1_öfo
 *
p
;

1611 
fú°
 = 0;

1612 
œ°
 = 
c⁄f
->
øid_disks
 - 1;

1613 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

1615 i‡(
mddev
->
ªcovîy_dißbÀd
 =
c⁄f
->recovery_disabled)

1616  -
EBUSY
;

1618 i‡(
rdev
->
øid_disk
 >= 0)

1619 
fú°
 = 
œ°
 = 
rdev
->
øid_disk
;

1621 i‡(
q
->
mîge_bvec_‚
) {

1622 
	`£t_bô
(
Unmîged
, &
rdev
->
Êags
);

1623 
mddev
->
mîge_check_√eded
 = 1;

1626 
múr‹
 = 
fú°
; múr‹ <
œ°
; mirror++) {

1627 
p
 = 
c⁄f
->
múr‹s
+
múr‹
;

1628 i‡(!
p
->
rdev
) {

1630 i‡(
mddev
->
gídisk
)

1631 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

1632 
rdev
->
d©a_off£t
 << 9);

1634 
p
->
hód_posôi⁄
 = 0;

1635 
rdev
->
øid_disk
 = 
múr‹
;

1636 
îr
 = 0;

1640 i‡(
rdev
->
ßved_øid_disk
 < 0)

1641 
c⁄f
->
fuŒsync
 = 1;

1642 
	`rcu_assign_poöãr
(
p
->
rdev
,Ñdev);

1645 i‡(
	`ã°_bô
(
W™tRïœ˚mít
, &
p
->
rdev
->
Êags
) &&

1646 
p
[
c⁄f
->
øid_disks
].
rdev
 =
NULL
) {

1648 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1649 
	`£t_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

1650 
rdev
->
øid_disk
 = 
múr‹
;

1651 
îr
 = 0;

1652 
c⁄f
->
fuŒsync
 = 1;

1653 
	`rcu_assign_poöãr
(
p
[
c⁄f
->
øid_disks
].
rdev
,Ñdev);

1657 i‡(
îr
 =0 && 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
)) {

1665 
	`synchr⁄ize_sched
();

1666 
	`‰ìze_¨øy
(
c⁄f
, 0);

1667 
	`un‰ìze_¨øy
(
c⁄f
);

1668 
	`˛ór_bô
(
Unmîged
, &
rdev
->
Êags
);

1670 
	`md_öãgrôy_add_rdev
(
rdev
, 
mddev
);

1671 i‡(
mddev
->
queue
 && 
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)))

1672 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

1673 
	`¥öt_c⁄f
(
c⁄f
);

1674  
îr
;

1675 
	}
}

1677 
	$øid1_ªmove_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1679 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1680 
îr
 = 0;

1681 
numbî
 = 
rdev
->
øid_disk
;

1682 
øid1_öfo
 *
p
 = 
c⁄f
->
múr‹s
 + 
numbî
;

1684 i‡(
rdev
 !
p
->rdev)

1685 
p
 = 
c⁄f
->
múr‹s
 + c⁄f->
øid_disks
 + 
numbî
;

1687 
	`¥öt_c⁄f
(
c⁄f
);

1688 i‡(
rdev
 =
p
->rdev) {

1689 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

1690 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

1691 
îr
 = -
EBUSY
;

1692 
ab‹t
;

1697 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

1698 
mddev
->
ªcovîy_dißbÀd
 !
c⁄f
->recovery_disabled &&

1699 
mddev
->
degøded
 < 
c⁄f
->
øid_disks
) {

1700 
îr
 = -
EBUSY
;

1701 
ab‹t
;

1703 
p
->
rdev
 = 
NULL
;

1704 
	`synchr⁄ize_rcu
();

1705 i‡(
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

1707 
îr
 = -
EBUSY
;

1708 
p
->
rdev
 =Ñdev;

1709 
ab‹t
;

1710 } i‡(
c⁄f
->
múr‹s
[c⁄f->
øid_disks
 + 
numbî
].
rdev
) {

1715 
md_rdev
 *
ª∂
 =

1716 
c⁄f
->
múr‹s
[c⁄f->
øid_disks
 + 
numbî
].
rdev
;

1717 
	`‰ìze_¨øy
(
c⁄f
, 0);

1718 
	`˛ór_bô
(
Rïœ˚mít
, &
ª∂
->
Êags
);

1719 
p
->
rdev
 = 
ª∂
;

1720 
c⁄f
->
múr‹s
[c⁄f->
øid_disks
 + 
numbî
].
rdev
 = 
NULL
;

1721 
	`un‰ìze_¨øy
(
c⁄f
);

1722 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

1724 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

1725 
îr
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

1727 
ab‹t
:

1729 
	`¥öt_c⁄f
(
c⁄f
);

1730  
îr
;

1731 
	}
}

1734 
	$íd_sync_ªad
(
bio
 *bio, 
îr‹
)

1736 
r1bio
 *
r1_bio
 = 
bio
->
bi_¥iv©e
;

1738 
	`upd©e_hód_pos
(
r1_bio
->
ªad_disk
,Ñ1_bio);

1745 i‡(
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
))

1746 
	`£t_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
);

1748 i‡(
	`©omic_dec_™d_ã°
(&
r1_bio
->
ªmaöög
))

1749 
	`ªscheduÀ_ªåy
(
r1_bio
);

1750 
	}
}

1752 
	$íd_sync_wrôe
(
bio
 *bio, 
îr‹
)

1754 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

1755 
r1bio
 *
r1_bio
 = 
bio
->
bi_¥iv©e
;

1756 
mddev
 *mddev = 
r1_bio
->mddev;

1757 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1758 
múr‹
=0;

1759 
£˘‹_t
 
fú°_bad
;

1760 
bad_£˘‹s
;

1762 
múr‹
 = 
	`föd_bio_disk
(
r1_bio
, 
bio
);

1764 i‡(!
u±od©e
) {

1765 
£˘‹_t
 
sync_blocks
 = 0;

1766 
£˘‹_t
 
s
 = 
r1_bio
->
£˘‹
;

1767 
£˘‹s_to_go
 = 
r1_bio
->
£˘‹s
;

1770 
	`bôm≠_íd_sync
(
mddev
->
bôm≠
, 
s
,

1771 &
sync_blocks
, 1);

1772 
s
 +
sync_blocks
;

1773 
£˘‹s_to_go
 -
sync_blocks
;

1774 } 
£˘‹s_to_go
 > 0);

1775 
	`£t_bô
(
WrôeEº‹Sìn
,

1776 &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
);

1777 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
,

1778 &
c⁄f
->
múr‹s
[
múr‹
].
rdev
->
Êags
))

1779 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &

1780 
mddev
->
ªcovîy
);

1781 
	`£t_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
);

1782 } i‡(
	`is_badblock
(
c⁄f
->
múr‹s
[
múr‹
].
rdev
,

1783 
r1_bio
->
£˘‹
,

1784 
r1_bio
->
£˘‹s
,

1785 &
fú°_bad
, &
bad_£˘‹s
) &&

1786 !
	`is_badblock
(
c⁄f
->
múr‹s
[
r1_bio
->
ªad_disk
].
rdev
,

1787 
r1_bio
->
£˘‹
,

1788 
r1_bio
->
£˘‹s
,

1789 &
fú°_bad
, &
bad_£˘‹s
)

1791 
	`£t_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
);

1793 i‡(
	`©omic_dec_™d_ã°
(&
r1_bio
->
ªmaöög
)) {

1794 
s
 = 
r1_bio
->
£˘‹s
;

1795 i‡(
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
) ||

1796 
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

1797 
	`ªscheduÀ_ªåy
(
r1_bio
);

1799 
	`put_buf
(
r1_bio
);

1800 
	`md_d⁄e_sync
(
mddev
, 
s
, 
u±od©e
);

1803 
	}
}

1805 
	$r1_sync_∑ge_io
(
md_rdev
 *
rdev
, 
£˘‹_t
 
£˘‹
,

1806 
£˘‹s
, 
∑ge
 *∑ge, 
rw
)

1808 i‡(
	`sync_∑ge_io
(
rdev
, 
£˘‹
, 
£˘‹s
 << 9, 
∑ge
, 
rw
, 
Ál£
))

1811 i‡(
rw
 =
WRITE
) {

1812 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

1813 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
,

1814 &
rdev
->
Êags
))

1815 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &

1816 
rdev
->
mddev
->
ªcovîy
);

1819 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
£˘‹
, 
£˘‹s
, 0))

1820 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

1822 
	}
}

1824 
	$fix_sync_ªad_îr‹
(
r1bio
 *
r1_bio
)

1837 
mddev
 *mddev = 
r1_bio
->mddev;

1838 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1839 
bio
 *biÿ
r1_bio
->
bios
[r1_bio->
ªad_disk
];

1840 
£˘‹_t
 
£˘
 = 
r1_bio
->
£˘‹
;

1841 
£˘‹s
 = 
r1_bio
->sectors;

1842 
idx
 = 0;

1844 
£˘‹s
) {

1845 
s
 = 
£˘‹s
;

1846 
d
 = 
r1_bio
->
ªad_disk
;

1847 
suc˚ss
 = 0;

1848 
md_rdev
 *
rdev
;

1849 
°¨t
;

1851 i‡(
s
 > (
PAGE_SIZE
>>9))

1852 
s
 = 
PAGE_SIZE
 >> 9;

1854 i‡(
r1_bio
->
bios
[
d
]->
bi_íd_io
 =
íd_sync_ªad
) {

1859 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1860 i‡(
	`sync_∑ge_io
(
rdev
, 
£˘
, 
s
<<9,

1861 
bio
->
bi_io_vec
[
idx
].
bv_∑ge
,

1862 
READ
, 
Ál£
)) {

1863 
suc˚ss
 = 1;

1867 
d
++;

1868 i‡(
d
 =
c⁄f
->
øid_disks
 * 2)

1869 
d
 = 0;

1870 } !
suc˚ss
 && 
d
 !
r1_bio
->
ªad_disk
);

1872 i‡(!
suc˚ss
) {

1873 
b
[
BDEVNAME_SIZE
];

1874 
ab‹t
 = 0;

1880 
	`¥ötk
(
KERN_ALERT
 "md/raid1:%s: %s: unrecoverable I/OÑeadÉrror"

1882 
	`md«me
(
mddev
),

1883 
	`bdev«me
(
bio
->
bi_bdev
, 
b
),

1884 ()
r1_bio
->
£˘‹
);

1885 
d
 = 0; d < 
c⁄f
->
øid_disks
 * 2; d++) {

1886 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1887 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

1889 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
£˘
, 
s
, 0))

1890 
ab‹t
 = 1;

1892 i‡(
ab‹t
) {

1893 
c⁄f
->
ªcovîy_dißbÀd
 =

1894 
mddev
->
ªcovîy_dißbÀd
;

1895 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

1896 
	`md_d⁄e_sync
(
mddev
, 
r1_bio
->
£˘‹s
, 0);

1897 
	`put_buf
(
r1_bio
);

1901 
£˘‹s
 -
s
;

1902 
£˘
 +
s
;

1903 
idx
++;

1907 
°¨t
 = 
d
;

1909 
d
 !
r1_bio
->
ªad_disk
) {

1910 i‡(
d
 == 0)

1911 
d
 = 
c⁄f
->
øid_disks
 * 2;

1912 
d
--;

1913 i‡(
r1_bio
->
bios
[
d
]->
bi_íd_io
 !
íd_sync_ªad
)

1915 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1916 i‡(
	`r1_sync_∑ge_io
(
rdev
, 
£˘
, 
s
,

1917 
bio
->
bi_io_vec
[
idx
].
bv_∑ge
,

1918 
WRITE
) == 0) {

1919 
r1_bio
->
bios
[
d
]->
bi_íd_io
 = 
NULL
;

1920 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

1923 
d
 = 
°¨t
;

1924 
d
 !
r1_bio
->
ªad_disk
) {

1925 i‡(
d
 == 0)

1926 
d
 = 
c⁄f
->
øid_disks
 * 2;

1927 
d
--;

1928 i‡(
r1_bio
->
bios
[
d
]->
bi_íd_io
 !
íd_sync_ªad
)

1930 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1931 i‡(
	`r1_sync_∑ge_io
(
rdev
, 
£˘
, 
s
,

1932 
bio
->
bi_io_vec
[
idx
].
bv_∑ge
,

1933 
READ
) != 0)

1934 
	`©omic_add
(
s
, &
rdev
->
c‹ª˘ed_îr‹s
);

1936 
£˘‹s
 -
s
;

1937 
£˘
 +
s
;

1938 
idx
 ++;

1940 
	`£t_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
);

1941 
	`£t_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

1943 
	}
}

1945 
	$¥o˚ss_checks
(
r1bio
 *
r1_bio
)

1954 
mddev
 *mddev = 
r1_bio
->mddev;

1955 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1956 
¥im¨y
;

1957 
i
;

1958 
v˙t
;

1961 
v˙t
 = (
r1_bio
->
£˘‹s
 + 
PAGE_SIZE
 / 512 - 1Ë>> (
PAGE_SHIFT
 - 9);

1962 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

1963 
j
;

1964 
size
;

1965 
u±od©e
;

1966 
bio
 *
b
 = 
r1_bio
->
bios
[
i
];

1967 i‡(
b
->
bi_íd_io
 !
íd_sync_ªad
)

1970 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
b
->
bi_Êags
);

1971 
	`bio_ª£t
(
b
);

1972 i‡(!
u±od©e
)

1973 
	`˛ór_bô
(
BIO_UPTODATE
, &
b
->
bi_Êags
);

1974 
b
->
bi_v˙t
 = 
v˙t
;

1975 
b
->
bi_ôî
.
bi_size
 = 
r1_bio
->
£˘‹s
 << 9;

1976 
b
->
bi_ôî
.
bi_£˘‹
 = 
r1_bio
->
£˘‹
 +

1977 
c⁄f
->
múr‹s
[
i
].
rdev
->
d©a_off£t
;

1978 
b
->
bi_bdev
 = 
c⁄f
->
múr‹s
[
i
].
rdev
->
bdev
;

1979 
b
->
bi_íd_io
 = 
íd_sync_ªad
;

1980 
b
->
bi_¥iv©e
 = 
r1_bio
;

1982 
size
 = 
b
->
bi_ôî
.
bi_size
;

1983 
j
 = 0; j < 
v˙t
 ; j++) {

1984 
bio_vec
 *
bi
;

1985 
bi
 = &
b
->
bi_io_vec
[
j
];

1986 
bi
->
bv_off£t
 = 0;

1987 i‡(
size
 > 
PAGE_SIZE
)

1988 
bi
->
bv_Àn
 = 
PAGE_SIZE
;

1990 
bi
->
bv_Àn
 = 
size
;

1991 
size
 -
PAGE_SIZE
;

1994 
¥im¨y
 = 0;Örim¨y < 
c⁄f
->
øid_disks
 * 2;Örimary++)

1995 i‡(
r1_bio
->
bios
[
¥im¨y
]->
bi_íd_io
 =
íd_sync_ªad
 &&

1996 
	`ã°_bô
(
BIO_UPTODATE
, &
r1_bio
->
bios
[
¥im¨y
]->
bi_Êags
)) {

1997 
r1_bio
->
bios
[
¥im¨y
]->
bi_íd_io
 = 
NULL
;

1998 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
¥im¨y
].
rdev
, 
mddev
);

2001 
r1_bio
->
ªad_disk
 = 
¥im¨y
;

2002 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

2003 
j
;

2004 
bio
 *
pbio
 = 
r1_bio
->
bios
[
¥im¨y
];

2005 
bio
 *
sbio
 = 
r1_bio
->
bios
[
i
];

2006 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
sbio
->
bi_Êags
);

2008 i‡(
sbio
->
bi_íd_io
 !
íd_sync_ªad
)

2011 
	`£t_bô
(
BIO_UPTODATE
, &
sbio
->
bi_Êags
);

2013 i‡(
u±od©e
) {

2014 
j
 = 
v˙t
; j-- ; ) {

2015 
∑ge
 *
p
, *
s
;

2016 
p
 = 
pbio
->
bi_io_vec
[
j
].
bv_∑ge
;

2017 
s
 = 
sbio
->
bi_io_vec
[
j
].
bv_∑ge
;

2018 i‡(
	`memcmp
(
	`∑ge_addªss
(
p
),

2019 
	`∑ge_addªss
(
s
),

2020 
sbio
->
bi_io_vec
[
j
].
bv_Àn
))

2024 
j
 = 0;

2025 i‡(
j
 >= 0)

2026 
	`©omic64_add
(
r1_bio
->
£˘‹s
, &
mddev
->
ªsync_mism©ches
);

2027 i‡(
j
 < 0 || (
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
)

2028 && 
u±od©e
)) {

2030 
sbio
->
bi_íd_io
 = 
NULL
;

2031 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
i
].
rdev
, 
mddev
);

2035 
	`bio_c›y_d©a
(
sbio
, 
pbio
);

2038 
	}
}

2040 
	$sync_ªque°_wrôe
(
mddev
 *mddev, 
r1bio
 *
r1_bio
)

2042 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2043 
i
;

2044 
disks
 = 
c⁄f
->
øid_disks
 * 2;

2045 
bio
 *bio, *
wbio
;

2047 
bio
 = 
r1_bio
->
bios
[r1_bio->
ªad_disk
];

2049 i‡(!
	`ã°_bô
(
R1BIO_U±od©e
, &
r1_bio
->
°©e
))

2051 i‡(!
	`fix_sync_ªad_îr‹
(
r1_bio
))

2054 i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

2055 i‡(
	`¥o˚ss_checks
(
r1_bio
) < 0)

2060 
	`©omic_£t
(&
r1_bio
->
ªmaöög
, 1);

2061 
i
 = 0; i < 
disks
 ; i++) {

2062 
wbio
 = 
r1_bio
->
bios
[
i
];

2063 i‡(
wbio
->
bi_íd_io
 =
NULL
 ||

2064 (
wbio
->
bi_íd_io
 =
íd_sync_ªad
 &&

2065 (
i
 =
r1_bio
->
ªad_disk
 ||

2066 !
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
))))

2069 
wbio
->
bi_rw
 = 
WRITE
;

2070 
wbio
->
bi_íd_io
 = 
íd_sync_wrôe
;

2071 
	`©omic_öc
(&
r1_bio
->
ªmaöög
);

2072 
	`md_sync_ac˘
(
c⁄f
->
múr‹s
[
i
].
rdev
->
bdev
, 
	`bio_£˘‹s
(
wbio
));

2074 
	`gíîic_make_ªque°
(
wbio
);

2077 i‡(
	`©omic_dec_™d_ã°
(&
r1_bio
->
ªmaöög
)) {

2079 
s
 = 
r1_bio
->
£˘‹s
;

2080 i‡(
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
) ||

2081 
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

2082 
	`ªscheduÀ_ªåy
(
r1_bio
);

2084 
	`put_buf
(
r1_bio
);

2085 
	`md_d⁄e_sync
(
mddev
, 
s
, 1);

2088 
	}
}

2098 
	$fix_ªad_îr‹
(
r1c⁄f
 *
c⁄f
, 
ªad_disk
,

2099 
£˘‹_t
 
£˘
, 
£˘‹s
)

2101 
mddev
 *mddev = 
c⁄f
->mddev;

2102 
£˘‹s
) {

2103 
s
 = 
£˘‹s
;

2104 
d
 = 
ªad_disk
;

2105 
suc˚ss
 = 0;

2106 
°¨t
;

2107 
md_rdev
 *
rdev
;

2109 i‡(
s
 > (
PAGE_SIZE
>>9))

2110 
s
 = 
PAGE_SIZE
 >> 9;

2118 
£˘‹_t
 
fú°_bad
;

2119 
bad_£˘‹s
;

2121 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

2122 i‡(
rdev
 &&

2123 (
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

2124 (!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

2125 
rdev
->
ªcovîy_off£t
 >
£˘
 + 
s
)) &&

2126 
	`is_badblock
(
rdev
, 
£˘
, 
s
,

2127 &
fú°_bad
, &
bad_£˘‹s
) == 0 &&

2128 
	`sync_∑ge_io
(
rdev
, 
£˘
, 
s
<<9,

2129 
c⁄f
->
tmµage
, 
READ
, 
Ál£
))

2130 
suc˚ss
 = 1;

2132 
d
++;

2133 i‡(
d
 =
c⁄f
->
øid_disks
 * 2)

2134 
d
 = 0;

2136 } !
suc˚ss
 && 
d
 !
ªad_disk
);

2138 i‡(!
suc˚ss
) {

2140 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
ªad_disk
].rdev;

2141 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
£˘
, 
s
, 0))

2142 
	`md_îr‹
(
mddev
, 
rdev
);

2146 
°¨t
 = 
d
;

2147 
d
 !
ªad_disk
) {

2148 i‡(
d
==0)

2149 
d
 = 
c⁄f
->
øid_disks
 * 2;

2150 
d
--;

2151 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

2152 i‡(
rdev
 &&

2153 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

2154 
	`r1_sync_∑ge_io
(
rdev
, 
£˘
, 
s
,

2155 
c⁄f
->
tmµage
, 
WRITE
);

2157 
d
 = 
°¨t
;

2158 
d
 !
ªad_disk
) {

2159 
b
[
BDEVNAME_SIZE
];

2160 i‡(
d
==0)

2161 
d
 = 
c⁄f
->
øid_disks
 * 2;

2162 
d
--;

2163 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

2164 i‡(
rdev
 &&

2165 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

2166 i‡(
	`r1_sync_∑ge_io
(
rdev
, 
£˘
, 
s
,

2167 
c⁄f
->
tmµage
, 
READ
)) {

2168 
	`©omic_add
(
s
, &
rdev
->
c‹ª˘ed_îr‹s
);

2169 
	`¥ötk
(
KERN_INFO


2172 
	`md«me
(
mddev
), 
s
,

2173 ()(
£˘
 +

2174 
rdev
->
d©a_off£t
),

2175 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2179 
£˘‹s
 -
s
;

2180 
£˘
 +
s
;

2182 
	}
}

2184 
	$«ºow_wrôe_îr‹
(
r1bio
 *
r1_bio
, 
i
)

2186 
mddev
 *mddev = 
r1_bio
->mddev;

2187 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2188 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
i
].rdev;

2201 
block_£˘‹s
;

2202 
£˘‹_t
 
£˘‹
;

2203 
£˘‹s
;

2204 
£˘_to_wrôe
 = 
r1_bio
->
£˘‹s
;

2205 
ok
 = 1;

2207 i‡(
rdev
->
badblocks
.
shi·
 < 0)

2210 
block_£˘‹s
 = 1 << 
rdev
->
badblocks
.
shi·
;

2211 
£˘‹
 = 
r1_bio
->sector;

2212 
£˘‹s
 = ((
£˘‹
 + 
block_£˘‹s
)

2213 & ~(
£˘‹_t
)(
block_£˘‹s
 - 1))

2214 - 
£˘‹
;

2216 
£˘_to_wrôe
) {

2217 
bio
 *
wbio
;

2218 i‡(
£˘‹s
 > 
£˘_to_wrôe
)

2219 
£˘‹s
 = 
£˘_to_wrôe
;

2222 i‡(
	`ã°_bô
(
R1BIO_BehödIO
, &
r1_bio
->
°©e
)) {

2223 
v˙t
 = 
r1_bio
->
behöd_∑ge_cou¡
;

2224 
bio_vec
 *
vec
 = 
r1_bio
->
behöd_bvecs
;

2226 !
vec
->
bv_∑ge
) {

2227 
vec
++;

2228 
v˙t
--;

2231 
wbio
 = 
	`bio_Æloc_mddev
(
GFP_NOIO
, 
v˙t
, 
mddev
);

2232 
	`mem˝y
(
wbio
->
bi_io_vec
, 
vec
, 
v˙t
 * (
bio_vec
));

2234 
wbio
->
bi_v˙t
 = 
v˙t
;

2236 
wbio
 = 
	`bio_˛⁄e_mddev
(
r1_bio
->
ma°î_bio
, 
GFP_NOIO
, 
mddev
);

2239 
wbio
->
bi_rw
 = 
WRITE
;

2240 
wbio
->
bi_ôî
.
bi_£˘‹
 = 
r1_bio
->
£˘‹
;

2241 
wbio
->
bi_ôî
.
bi_size
 = 
r1_bio
->
£˘‹s
 << 9;

2243 
	`bio_åim
(
wbio
, 
£˘‹
 - 
r1_bio
->£˘‹, 
£˘‹s
);

2244 
wbio
->
bi_ôî
.
bi_£˘‹
 +
rdev
->
d©a_off£t
;

2245 
wbio
->
bi_bdev
 = 
rdev
->
bdev
;

2246 i‡(
	`submô_bio_waô
(
WRITE
, 
wbio
) == 0)

2248 
ok
 = 
	`rdev_£t_badblocks
(
rdev
, 
£˘‹
,

2249 
£˘‹s
, 0)

2250 && 
ok
;

2252 
	`bio_put
(
wbio
);

2253 
£˘_to_wrôe
 -
£˘‹s
;

2254 
£˘‹
 +
£˘‹s
;

2255 
£˘‹s
 = 
block_£˘‹s
;

2257  
ok
;

2258 
	}
}

2260 
	$h™dÀ_sync_wrôe_föished
(
r1c⁄f
 *
c⁄f
, 
r1bio
 *
r1_bio
)

2262 
m
;

2263 
s
 = 
r1_bio
->
£˘‹s
;

2264 
m
 = 0; m < 
c⁄f
->
øid_disks
 * 2 ; m++) {

2265 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
m
].rdev;

2266 
bio
 *biÿ
r1_bio
->
bios
[
m
];

2267 i‡(
bio
->
bi_íd_io
 =
NULL
)

2269 i‡(
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
) &&

2270 
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
)) {

2271 
	`rdev_˛ór_badblocks
(
rdev
, 
r1_bio
->
£˘‹
, 
s
, 0);

2273 i‡(!
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
) &&

2274 
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
)) {

2275 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
r1_bio
->
£˘‹
, 
s
, 0))

2276 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2279 
	`put_buf
(
r1_bio
);

2280 
	`md_d⁄e_sync
(
c⁄f
->
mddev
, 
s
, 1);

2281 
	}
}

2283 
	$h™dÀ_wrôe_föished
(
r1c⁄f
 *
c⁄f
, 
r1bio
 *
r1_bio
)

2285 
m
;

2286 
m
 = 0; m < 
c⁄f
->
øid_disks
 * 2 ; m++)

2287 i‡(
r1_bio
->
bios
[
m
] =
IO_MADE_GOOD
) {

2288 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
m
].rdev;

2289 
	`rdev_˛ór_badblocks
(
rdev
,

2290 
r1_bio
->
£˘‹
,

2291 
r1_bio
->
£˘‹s
, 0);

2292 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2293 } i‡(
r1_bio
->
bios
[
m
] !
NULL
) {

2298 i‡(!
	`«ºow_wrôe_îr‹
(
r1_bio
, 
m
)) {

2299 
	`md_îr‹
(
c⁄f
->
mddev
,

2300 
c⁄f
->
múr‹s
[
m
].
rdev
);

2302 
	`£t_bô
(
R1BIO_Degøded
, &
r1_bio
->
°©e
);

2304 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
m
].
rdev
,

2305 
c⁄f
->
mddev
);

2307 i‡(
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

2308 
	`˛o£_wrôe
(
r1_bio
);

2309 
	`øid_íd_bio_io
(
r1_bio
);

2310 
	}
}

2312 
	$h™dÀ_ªad_îr‹
(
r1c⁄f
 *
c⁄f
, 
r1bio
 *
r1_bio
)

2314 
disk
;

2315 
max_£˘‹s
;

2316 
mddev
 *mddev = 
c⁄f
->mddev;

2317 
bio
 *bio;

2318 
b
[
BDEVNAME_SIZE
];

2319 
md_rdev
 *
rdev
;

2321 
	`˛ór_bô
(
R1BIO_RódEº‹
, &
r1_bio
->
°©e
);

2330 i‡(
mddev
->
ro
 == 0) {

2331 
	`‰ìze_¨øy
(
c⁄f
, 1);

2332 
	`fix_ªad_îr‹
(
c⁄f
, 
r1_bio
->
ªad_disk
,

2333 
r1_bio
->
£˘‹
,Ñ1_bio->
£˘‹s
);

2334 
	`un‰ìze_¨øy
(
c⁄f
);

2336 
	`md_îr‹
(
mddev
, 
c⁄f
->
múr‹s
[
r1_bio
->
ªad_disk
].
rdev
);

2337 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
r1_bio
->
ªad_disk
].
rdev
, c⁄f->
mddev
);

2339 
bio
 = 
r1_bio
->
bios
[r1_bio->
ªad_disk
];

2340 
	`bdev«me
(
bio
->
bi_bdev
, 
b
);

2341 
ªad_m‹e
:

2342 
disk
 = 
	`ªad_bÆ™˚
(
c⁄f
, 
r1_bio
, &
max_£˘‹s
);

2343 i‡(
disk
 == -1) {

2344 
	`¥ötk
(
KERN_ALERT
 "md/raid1:%s: %s: unrecoverable I/O"

2346 
	`md«me
(
mddev
), 
b
, ()
r1_bio
->
£˘‹
);

2347 
	`øid_íd_bio_io
(
r1_bio
);

2349 c⁄° 
do_sync


2350 
r1_bio
->
ma°î_bio
->
bi_rw
 & 
REQ_SYNC
;

2351 i‡(
bio
) {

2352 
r1_bio
->
bios
[r1_bio->
ªad_disk
] =

2353 
mddev
->
ro
 ? 
IO_BLOCKED
 : 
NULL
;

2354 
	`bio_put
(
bio
);

2356 
r1_bio
->
ªad_disk
 = 
disk
;

2357 
bio
 = 
	`bio_˛⁄e_mddev
(
r1_bio
->
ma°î_bio
, 
GFP_NOIO
, 
mddev
);

2358 
	`bio_åim
(
bio
, 
r1_bio
->
£˘‹
 - bio->
bi_ôî
.
bi_£˘‹
,

2359 
max_£˘‹s
);

2360 
r1_bio
->
bios
[r1_bio->
ªad_disk
] = 
bio
;

2361 
rdev
 = 
c⁄f
->
múr‹s
[
disk
].rdev;

2362 
	`¥ötk_øãlimôed
(
KERN_ERR


2365 
	`md«me
(
mddev
),

2366 ()
r1_bio
->
£˘‹
,

2367 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2368 
bio
->
bi_ôî
.
bi_£˘‹
 = 
r1_bio
->
£˘‹
 + 
rdev
->
d©a_off£t
;

2369 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

2370 
bio
->
bi_íd_io
 = 
øid1_íd_ªad_ªque°
;

2371 
bio
->
bi_rw
 = 
READ
 | 
do_sync
;

2372 
bio
->
bi_¥iv©e
 = 
r1_bio
;

2373 i‡(
max_£˘‹s
 < 
r1_bio
->
£˘‹s
) {

2375 
bio
 *
mbio
 = 
r1_bio
->
ma°î_bio
;

2376 
£˘‹s_h™dÀd
 = (
r1_bio
->
£˘‹
 + 
max_£˘‹s


2377 - 
mbio
->
bi_ôî
.
bi_£˘‹
);

2378 
r1_bio
->
£˘‹s
 = 
max_£˘‹s
;

2379 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

2380 i‡(
mbio
->
bi_phys_£gmíts
 == 0)

2381 
mbio
->
bi_phys_£gmíts
 = 2;

2383 
mbio
->
bi_phys_£gmíts
++;

2384 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

2385 
	`gíîic_make_ªque°
(
bio
);

2386 
bio
 = 
NULL
;

2388 
r1_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r1bio_poﬁ
, 
GFP_NOIO
);

2390 
r1_bio
->
ma°î_bio
 = 
mbio
;

2391 
r1_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
mbio
Ë- 
£˘‹s_h™dÀd
;

2392 
r1_bio
->
°©e
 = 0;

2393 
	`£t_bô
(
R1BIO_RódEº‹
, &
r1_bio
->
°©e
);

2394 
r1_bio
->
mddev
 = mddev;

2395 
r1_bio
->
£˘‹
 = 
mbio
->
bi_ôî
.
bi_£˘‹
 +

2396 
£˘‹s_h™dÀd
;

2398 
ªad_m‹e
;

2400 
	`gíîic_make_ªque°
(
bio
);

2402 
	}
}

2404 
	$øid1d
(
md_thªad
 *
thªad
)

2406 
mddev
 *mddev = 
thªad
->mddev;

2407 
r1bio
 *
r1_bio
;

2408 
Êags
;

2409 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2410 
li°_hód
 *
hód
 = &
c⁄f
->
ªåy_li°
;

2411 
blk_∂ug
 
∂ug
;

2413 
	`md_check_ªcovîy
(
mddev
);

2415 
	`blk_°¨t_∂ug
(&
∂ug
);

2418 
	`Êush_≥ndög_wrôes
(
c⁄f
);

2420 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2421 i‡(
	`li°_em±y
(
hód
)) {

2422 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2425 
r1_bio
 = 
	`li°_íåy
(
hód
->
¥ev
, 
r1bio
, 
ªåy_li°
);

2426 
	`li°_dñ
(
hód
->
¥ev
);

2427 
c⁄f
->
ƒ_queued
--;

2428 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2430 
mddev
 = 
r1_bio
->mddev;

2431 
c⁄f
 = 
mddev
->
¥iv©e
;

2432 i‡(
	`ã°_bô
(
R1BIO_IsSync
, &
r1_bio
->
°©e
)) {

2433 i‡(
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
) ||

2434 
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

2435 
	`h™dÀ_sync_wrôe_föished
(
c⁄f
, 
r1_bio
);

2437 
	`sync_ªque°_wrôe
(
mddev
, 
r1_bio
);

2438 } i‡(
	`ã°_bô
(
R1BIO_MadeGood
, &
r1_bio
->
°©e
) ||

2439 
	`ã°_bô
(
R1BIO_WrôeEº‹
, &
r1_bio
->
°©e
))

2440 
	`h™dÀ_wrôe_föished
(
c⁄f
, 
r1_bio
);

2441 i‡(
	`ã°_bô
(
R1BIO_RódEº‹
, &
r1_bio
->
°©e
))

2442 
	`h™dÀ_ªad_îr‹
(
c⁄f
, 
r1_bio
);

2447 
	`gíîic_make_ªque°
(
r1_bio
->
bios
[r1_bio->
ªad_disk
]);

2449 
	`c⁄d_ªsched
();

2450 i‡(
mddev
->
Êags
 & ~(1<<
MD_CHANGE_PENDING
))

2451 
	`md_check_ªcovîy
(
mddev
);

2453 
	`blk_föish_∂ug
(&
∂ug
);

2454 
	}
}

2457 
	$öô_ªsync
(
r1c⁄f
 *
c⁄f
)

2459 
buffs
;

2461 
buffs
 = 
RESYNC_WINDOW
 / 
RESYNC_BLOCK_SIZE
;

2462 
	`BUG_ON
(
c⁄f
->
r1buf_poﬁ
);

2463 
c⁄f
->
r1buf_poﬁ
 = 
	`mempoﬁ_¸óã
(
buffs
, 
r1buf_poﬁ_Æloc
, 
r1buf_poﬁ_‰ì
,

2464 
c⁄f
->
poﬁöfo
);

2465 i‡(!
c⁄f
->
r1buf_poﬁ
)

2466  -
ENOMEM
;

2467 
c⁄f
->
√xt_ªsync
 = 0;

2469 
	}
}

2481 
£˘‹_t
 
	$sync_ªque°
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹_ƒ
, *
skù≥d
, 
go_Á°î
)

2483 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2484 
r1bio
 *
r1_bio
;

2485 
bio
 *bio;

2486 
£˘‹_t
 
max_£˘‹
, 
ƒ_£˘‹s
;

2487 
disk
 = -1;

2488 
i
;

2489 
w⁄ly
 = -1;

2490 
wrôe_èrgës
 = 0, 
ªad_èrgës
 = 0;

2491 
£˘‹_t
 
sync_blocks
;

2492 
°ûl_degøded
 = 0;

2493 
good_£˘‹s
 = 
RESYNC_SECTORS
;

2494 
mö_bad
 = 0;

2496 i‡(!
c⁄f
->
r1buf_poﬁ
)

2497 i‡(
	`öô_ªsync
(
c⁄f
))

2500 
max_£˘‹
 = 
mddev
->
dev_£˘‹s
;

2501 i‡(
£˘‹_ƒ
 >
max_£˘‹
) {

2507 i‡(
mddev
->
cuº_ªsync
 < 
max_£˘‹
)

2508 
	`bôm≠_íd_sync
(
mddev
->
bôm≠
, mddev->
cuº_ªsync
,

2509 &
sync_blocks
, 1);

2511 
c⁄f
->
fuŒsync
 = 0;

2513 
	`bôm≠_˛o£_sync
(
mddev
->
bôm≠
);

2514 
	`˛o£_sync
(
c⁄f
);

2518 i‡(
mddev
->
bôm≠
 =
NULL
 &&

2519 
mddev
->
ªcovîy_˝
 =
MaxSe˘‹
 &&

2520 !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
) &&

2521 
c⁄f
->
fuŒsync
 == 0) {

2522 *
skù≥d
 = 1;

2523  
max_£˘‹
 - 
£˘‹_ƒ
;

2528 i‡(!
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
, &
sync_blocks
, 1) &&

2529 !
c⁄f
->
fuŒsync
 && !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
)) {

2531 *
skù≥d
 = 1;

2532  
sync_blocks
;

2539 i‡(!
go_Á°î
 && 
c⁄f
->
ƒ_waôög
)

2540 
	`m¶ìp_öãºu±ibÀ
(1000);

2542 
	`bôm≠_c⁄d_íd_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
);

2543 
r1_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r1buf_poﬁ
, 
GFP_NOIO
);

2544 
	`øi£_b¨rõr
(
c⁄f
);

2546 
c⁄f
->
√xt_ªsync
 = 
£˘‹_ƒ
;

2548 
	`rcu_ªad_lock
();

2558 
r1_bio
->
mddev
 = mddev;

2559 
r1_bio
->
£˘‹
 = 
£˘‹_ƒ
;

2560 
r1_bio
->
°©e
 = 0;

2561 
	`£t_bô
(
R1BIO_IsSync
, &
r1_bio
->
°©e
);

2563 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

2564 
md_rdev
 *
rdev
;

2565 
bio
 = 
r1_bio
->
bios
[
i
];

2566 
	`bio_ª£t
(
bio
);

2568 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

2569 i‡(
rdev
 =
NULL
 ||

2570 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

2571 i‡(
i
 < 
c⁄f
->
øid_disks
)

2572 
°ûl_degøded
 = 1;

2573 } i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

2574 
bio
->
bi_rw
 = 
WRITE
;

2575 
bio
->
bi_íd_io
 = 
íd_sync_wrôe
;

2576 
wrôe_èrgës
 ++;

2579 
£˘‹_t
 
fú°_bad
 = 
MaxSe˘‹
;

2580 
bad_£˘‹s
;

2582 i‡(
	`is_badblock
(
rdev
, 
£˘‹_ƒ
, 
good_£˘‹s
,

2583 &
fú°_bad
, &
bad_£˘‹s
)) {

2584 i‡(
fú°_bad
 > 
£˘‹_ƒ
)

2585 
good_£˘‹s
 = 
fú°_bad
 - 
£˘‹_ƒ
;

2587 
bad_£˘‹s
 -(
£˘‹_ƒ
 - 
fú°_bad
);

2588 i‡(
mö_bad
 == 0 ||

2589 
mö_bad
 > 
bad_£˘‹s
)

2590 
mö_bad
 = 
bad_£˘‹s
;

2593 i‡(
£˘‹_ƒ
 < 
fú°_bad
) {

2594 i‡(
	`ã°_bô
(
WrôeMo°ly
, &
rdev
->
Êags
)) {

2595 i‡(
w⁄ly
 < 0)

2596 
w⁄ly
 = 
i
;

2598 i‡(
disk
 < 0)

2599 
disk
 = 
i
;

2601 
bio
->
bi_rw
 = 
READ
;

2602 
bio
->
bi_íd_io
 = 
íd_sync_ªad
;

2603 
ªad_èrgës
++;

2604 } i‡(!
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
) &&

2605 
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) &&

2606 !
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
)) {

2613 
bio
->
bi_rw
 = 
WRITE
;

2614 
bio
->
bi_íd_io
 = 
íd_sync_wrôe
;

2615 
wrôe_èrgës
++;

2618 i‡(
bio
->
bi_íd_io
) {

2619 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

2620 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹_ƒ
 + 
rdev
->
d©a_off£t
;

2621 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

2622 
bio
->
bi_¥iv©e
 = 
r1_bio
;

2625 
	`rcu_ªad_u∆ock
();

2626 i‡(
disk
 < 0)

2627 
disk
 = 
w⁄ly
;

2628 
r1_bio
->
ªad_disk
 = 
disk
;

2630 i‡(
ªad_èrgës
 =0 && 
mö_bad
 > 0) {

2634 
ok
 = 1;

2635 
i
 = 0 ; i < 
c⁄f
->
øid_disks
 * 2 ; i++)

2636 i‡(
r1_bio
->
bios
[
i
]->
bi_íd_io
 =
íd_sync_wrôe
) {

2637 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
i
].rdev;

2638 
ok
 = 
	`rdev_£t_badblocks
(
rdev
, 
£˘‹_ƒ
,

2639 
mö_bad
, 0

2640 Ë&& 
ok
;

2642 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

2643 *
skù≥d
 = 1;

2644 
	`put_buf
(
r1_bio
);

2646 i‡(!
ok
) {

2652 
c⁄f
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled;

2653 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

2656  
mö_bad
;

2659 i‡(
mö_bad
 > 0 && mö_bad < 
good_£˘‹s
) {

2662 
good_£˘‹s
 = 
mö_bad
;

2665 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
Ë&& 
ªad_èrgës
 > 0)

2667 
wrôe_èrgës
 +
ªad_èrgës
-1;

2669 i‡(
wrôe_èrgës
 =0 || 
ªad_èrgës
 == 0) {

2673 
£˘‹_t
 
rv
;

2674 i‡(
mö_bad
 > 0)

2675 
max_£˘‹
 = 
£˘‹_ƒ
 + 
mö_bad
;

2676 
rv
 = 
max_£˘‹
 - 
£˘‹_ƒ
;

2677 *
skù≥d
 = 1;

2678 
	`put_buf
(
r1_bio
);

2679  
rv
;

2682 i‡(
max_£˘‹
 > 
mddev
->
ªsync_max
)

2683 
max_£˘‹
 = 
mddev
->
ªsync_max
;

2684 i‡(
max_£˘‹
 > 
£˘‹_ƒ
 + 
good_£˘‹s
)

2685 
max_£˘‹
 = 
£˘‹_ƒ
 + 
good_£˘‹s
;

2686 
ƒ_£˘‹s
 = 0;

2687 
sync_blocks
 = 0;

2689 
∑ge
 *page;

2690 
Àn
 = 
PAGE_SIZE
;

2691 i‡(
£˘‹_ƒ
 + (
Àn
>>9Ë> 
max_£˘‹
)

2692 
Àn
 = (
max_£˘‹
 - 
£˘‹_ƒ
) << 9;

2693 i‡(
Àn
 == 0)

2695 i‡(
sync_blocks
 == 0) {

2696 i‡(!
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
,

2697 &
sync_blocks
, 
°ûl_degøded
) &&

2698 !
c⁄f
->
fuŒsync
 &&

2699 !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
))

2701 
	`BUG_ON
(
sync_blocks
 < (
PAGE_SIZE
>>9));

2702 i‡((
Àn
 >> 9Ë> 
sync_blocks
)

2703 
Àn
 = 
sync_blocks
<<9;

2706 
i
 = 0 ; i < 
c⁄f
->
øid_disks
 * 2; i++) {

2707 
bio
 = 
r1_bio
->
bios
[
i
];

2708 i‡(
bio
->
bi_íd_io
) {

2709 
∑ge
 = 
bio
->
bi_io_vec
[bio->
bi_v˙t
].
bv_∑ge
;

2710 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àn
, 0) == 0) {

2712 
bio
->
bi_io_vec
[bio->
bi_v˙t
].
bv_∑ge
 = 
∑ge
;

2713 
i
 > 0) {

2714 
i
--;

2715 
bio
 = 
r1_bio
->
bios
[
i
];

2716 i‡(
bio
->
bi_íd_io
==
NULL
)

2719 
bio
->
bi_v˙t
--;

2720 
bio
->
bi_ôî
.
bi_size
 -
Àn
;

2721 
bio
->
bi_Êags
 &~(1<< 
BIO_SEG_VALID
);

2723 
bio_fuŒ
;

2727 
ƒ_£˘‹s
 +
Àn
>>9;

2728 
£˘‹_ƒ
 +
Àn
>>9;

2729 
sync_blocks
 -(
Àn
>>9);

2730 } 
r1_bio
->
bios
[
disk
]->
bi_v˙t
 < 
RESYNC_PAGES
);

2731 
bio_fuŒ
:

2732 
r1_bio
->
£˘‹s
 = 
ƒ_£˘‹s
;

2737 i‡(
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
)) {

2738 
	`©omic_£t
(&
r1_bio
->
ªmaöög
, 
ªad_èrgës
);

2739 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2 && 
ªad_èrgës
; i++) {

2740 
bio
 = 
r1_bio
->
bios
[
i
];

2741 i‡(
bio
->
bi_íd_io
 =
íd_sync_ªad
) {

2742 
ªad_èrgës
--;

2743 
	`md_sync_ac˘
(
bio
->
bi_bdev
, 
ƒ_£˘‹s
);

2744 
	`gíîic_make_ªque°
(
bio
);

2748 
	`©omic_£t
(&
r1_bio
->
ªmaöög
, 1);

2749 
bio
 = 
r1_bio
->
bios
[r1_bio->
ªad_disk
];

2750 
	`md_sync_ac˘
(
bio
->
bi_bdev
, 
ƒ_£˘‹s
);

2751 
	`gíîic_make_ªque°
(
bio
);

2754  
ƒ_£˘‹s
;

2755 
	}
}

2757 
£˘‹_t
 
	$øid1_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

2759 i‡(
£˘‹s
)

2760  
£˘‹s
;

2762  
mddev
->
dev_£˘‹s
;

2763 
	}
}

2765 
r1c⁄f
 *
	$£tup_c⁄f
(
mddev
 *mddev)

2767 
r1c⁄f
 *
c⁄f
;

2768 
i
;

2769 
øid1_öfo
 *
disk
;

2770 
md_rdev
 *
rdev
;

2771 
îr
 = -
ENOMEM
;

2773 
c⁄f
 = 
	`kzÆloc
((
r1c⁄f
), 
GFP_KERNEL
);

2774 i‡(!
c⁄f
)

2775 
ab‹t
;

2777 
c⁄f
->
múr‹s
 = 
	`kzÆloc
((
øid1_öfo
)

2778 * 
mddev
->
øid_disks
 * 2,

2779 
GFP_KERNEL
);

2780 i‡(!
c⁄f
->
múr‹s
)

2781 
ab‹t
;

2783 
c⁄f
->
tmµage
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

2784 i‡(!
c⁄f
->
tmµage
)

2785 
ab‹t
;

2787 
c⁄f
->
poﬁöfo
 = 
	`kzÆloc
((*c⁄f->poﬁöfo), 
GFP_KERNEL
);

2788 i‡(!
c⁄f
->
poﬁöfo
)

2789 
ab‹t
;

2790 
c⁄f
->
poﬁöfo
->
øid_disks
 = 
mddev
->raid_disks * 2;

2791 
c⁄f
->
r1bio_poﬁ
 = 
	`mempoﬁ_¸óã
(
NR_RAID1_BIOS
, 
r1bio_poﬁ_Æloc
,

2792 
r1bio_poﬁ_‰ì
,

2793 
c⁄f
->
poﬁöfo
);

2794 i‡(!
c⁄f
->
r1bio_poﬁ
)

2795 
ab‹t
;

2797 
c⁄f
->
poﬁöfo
->
mddev
 = mddev;

2799 
îr
 = -
EINVAL
;

2800 
	`•ö_lock_öô
(&
c⁄f
->
devi˚_lock
);

2801 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2802 
ªque°_queue
 *
q
;

2803 
disk_idx
 = 
rdev
->
øid_disk
;

2804 i‡(
disk_idx
 >
mddev
->
øid_disks


2805 || 
disk_idx
 < 0)

2807 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
))

2808 
disk
 = 
c⁄f
->
múr‹s
 + 
mddev
->
øid_disks
 + 
disk_idx
;

2810 
disk
 = 
c⁄f
->
múr‹s
 + 
disk_idx
;

2812 i‡(
disk
->
rdev
)

2813 
ab‹t
;

2814 
disk
->
rdev
 =Ñdev;

2815 
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

2816 i‡(
q
->
mîge_bvec_‚
)

2817 
mddev
->
mîge_check_√eded
 = 1;

2819 
disk
->
hód_posôi⁄
 = 0;

2820 
disk
->
£q_°¨t
 = 
MaxSe˘‹
;

2822 
c⁄f
->
øid_disks
 = 
mddev
->raid_disks;

2823 
c⁄f
->
mddev
 = mddev;

2824 
	`INIT_LIST_HEAD
(&
c⁄f
->
ªåy_li°
);

2826 
	`•ö_lock_öô
(&
c⁄f
->
ªsync_lock
);

2827 
	`öô_waôqueue_hód
(&
c⁄f
->
waô_b¨rõr
);

2829 
	`bio_li°_öô
(&
c⁄f
->
≥ndög_bio_li°
);

2830 
c⁄f
->
≥ndög_cou¡
 = 0;

2831 
c⁄f
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled - 1;

2833 
c⁄f
->
°¨t_√xt_wödow
 = 
MaxSe˘‹
;

2834 
c⁄f
->
cuºít_wödow_ªque°s
 = c⁄f->
√xt_wödow_ªque°s
 = 0;

2836 
îr
 = -
EIO
;

2837 
i
 = 0; i < 
c⁄f
->
øid_disks
 * 2; i++) {

2839 
disk
 = 
c⁄f
->
múr‹s
 + 
i
;

2841 i‡(
i
 < 
c⁄f
->
øid_disks
 &&

2842 
disk
[
c⁄f
->
øid_disks
].
rdev
) {

2844 i‡(!
disk
->
rdev
) {

2848 
disk
->
rdev
 =

2849 
disk
[
c⁄f
->
øid_disks
].
rdev
;

2850 
disk
[
c⁄f
->
øid_disks
].
rdev
 = 
NULL
;

2851 } i‡(!
	`ã°_bô
(
In_sync
, &
disk
->
rdev
->
Êags
))

2853 
ab‹t
;

2856 i‡(!
disk
->
rdev
 ||

2857 !
	`ã°_bô
(
In_sync
, &
disk
->
rdev
->
Êags
)) {

2858 
disk
->
hód_posôi⁄
 = 0;

2859 i‡(
disk
->
rdev
 &&

2860 (
disk
->
rdev
->
ßved_øid_disk
 < 0))

2861 
c⁄f
->
fuŒsync
 = 1;

2865 
îr
 = -
ENOMEM
;

2866 
c⁄f
->
thªad
 = 
	`md_ªgi°î_thªad
(
øid1d
, 
mddev
, "raid1");

2867 i‡(!
c⁄f
->
thªad
) {

2868 
	`¥ötk
(
KERN_ERR


2870 
	`md«me
(
mddev
));

2871 
ab‹t
;

2874  
c⁄f
;

2876 
ab‹t
:

2877 i‡(
c⁄f
) {

2878 i‡(
c⁄f
->
r1bio_poﬁ
)

2879 
	`mempoﬁ_de°roy
(
c⁄f
->
r1bio_poﬁ
);

2880 
	`k‰ì
(
c⁄f
->
múr‹s
);

2881 
	`ß„_put_∑ge
(
c⁄f
->
tmµage
);

2882 
	`k‰ì
(
c⁄f
->
poﬁöfo
);

2883 
	`k‰ì
(
c⁄f
);

2885  
	`ERR_PTR
(
îr
);

2886 
	}
}

2888 
°›
(
mddev
 *mddev);

2889 
	$run
(
mddev
 *mddev)

2891 
r1c⁄f
 *
c⁄f
;

2892 
i
;

2893 
md_rdev
 *
rdev
;

2894 
ªt
;

2895 
boﬁ
 
disˇrd_suµ‹ãd
 = 
Ál£
;

2897 i‡(
mddev
->
Àvñ
 != 1) {

2898 
	`¥ötk
(
KERN_ERR
 "md/raid1:%s:ÑaidÜevelÇot setÅo mirroring (%d)\n",

2899 
	`md«me
(
mddev
), mddev->
Àvñ
);

2900  -
EIO
;

2902 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
) {

2903 
	`¥ötk
(
KERN_ERR
 "md/raid1:%s:Ñeshape_position set butÇot supported\n",

2904 
	`md«me
(
mddev
));

2905  -
EIO
;

2912 i‡(
mddev
->
¥iv©e
 =
NULL
)

2913 
c⁄f
 = 
	`£tup_c⁄f
(
mddev
);

2915 
c⁄f
 = 
mddev
->
¥iv©e
;

2917 i‡(
	`IS_ERR
(
c⁄f
))

2918  
	`PTR_ERR
(
c⁄f
);

2920 i‡(
mddev
->
queue
)

2921 
	`blk_queue_max_wrôe_ßme_£˘‹s
(
mddev
->
queue
, 0);

2923 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

2924 i‡(!
mddev
->
gídisk
)

2926 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

2927 
rdev
->
d©a_off£t
 << 9);

2928 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)))

2929 
disˇrd_suµ‹ãd
 = 
åue
;

2932 
mddev
->
degøded
 = 0;

2933 
i
=0; i < 
c⁄f
->
øid_disks
; i++)

2934 i‡(
c⁄f
->
múr‹s
[
i
].
rdev
 =
NULL
 ||

2935 !
	`ã°_bô
(
In_sync
, &
c⁄f
->
múr‹s
[
i
].
rdev
->
Êags
) ||

2936 
	`ã°_bô
(
Fau…y
, &
c⁄f
->
múr‹s
[
i
].
rdev
->
Êags
))

2937 
mddev
->
degøded
++;

2939 i‡(
c⁄f
->
øid_disks
 - 
mddev
->
degøded
 == 1)

2940 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

2942 i‡(
mddev
->
ªcovîy_˝
 !
MaxSe˘‹
)

2943 
	`¥ötk
(
KERN_NOTICE
 "md/raid1:%s:Çot clean"

2945 
	`md«me
(
mddev
));

2946 
	`¥ötk
(
KERN_INFO


2948 
	`md«me
(
mddev
), mddev->
øid_disks
 - mddev->
degøded
,

2949 
mddev
->
øid_disks
);

2954 
mddev
->
thªad
 = 
c⁄f
->thread;

2955 
c⁄f
->
thªad
 = 
NULL
;

2956 
mddev
->
¥iv©e
 = 
c⁄f
;

2958 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`øid1_size
(mddev, 0, 0));

2960 i‡(
mddev
->
queue
) {

2961 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
øid1_c⁄ge°ed
;

2962 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

2963 
	`blk_queue_mîge_bvec
(
mddev
->
queue
, 
øid1_mîgóbÀ_bvec
);

2965 i‡(
disˇrd_suµ‹ãd
)

2966 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
,

2967 
mddev
->
queue
);

2969 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
,

2970 
mddev
->
queue
);

2973 
ªt
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

2974 i‡(
ªt
)

2975 
	`°›
(
mddev
);

2976  
ªt
;

2977 
	}
}

2979 
	$°›
(
mddev
 *mddev)

2981 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2982 
bôm≠
 *bôm≠ = 
mddev
->bitmap;

2985 i‡(
bôm≠
 && 
	`©omic_ªad
(&bôm≠->
behöd_wrôes
) > 0) {

2986 
	`¥ötk
(
KERN_INFO
 "md/raid1:%s: behind writes inÖrogress - waitingÅo stop.\n",

2987 
	`md«me
(
mddev
));

2989 
	`waô_evít
(
bôm≠
->
behöd_waô
,

2990 
	`©omic_ªad
(&
bôm≠
->
behöd_wrôes
) == 0);

2993 
	`‰ìze_¨øy
(
c⁄f
, 0);

2994 
	`un‰ìze_¨øy
(
c⁄f
);

2996 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

2997 i‡(
c⁄f
->
r1bio_poﬁ
)

2998 
	`mempoﬁ_de°roy
(
c⁄f
->
r1bio_poﬁ
);

2999 
	`k‰ì
(
c⁄f
->
múr‹s
);

3000 
	`ß„_put_∑ge
(
c⁄f
->
tmµage
);

3001 
	`k‰ì
(
c⁄f
->
poﬁöfo
);

3002 
	`k‰ì
(
c⁄f
);

3003 
mddev
->
¥iv©e
 = 
NULL
;

3005 
	}
}

3007 
	$øid1_ªsize
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
)

3016 
£˘‹_t
 
√wsize
 = 
	`øid1_size
(
mddev
, 
£˘‹s
, 0);

3017 i‡(
mddev
->
exã∫Æ_size
 &&

3018 
mddev
->
¨øy_£˘‹s
 > 
√wsize
)

3019  -
EINVAL
;

3020 i‡(
mddev
->
bôm≠
) {

3021 
ªt
 = 
	`bôm≠_ªsize
(
mddev
->
bôm≠
, 
√wsize
, 0, 0);

3022 i‡(
ªt
)

3023  
ªt
;

3025 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
√wsize
);

3026 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

3027 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

3028 i‡(
£˘‹s
 > 
mddev
->
dev_£˘‹s
 &&

3029 
mddev
->
ªcovîy_˝
 > mddev->
dev_£˘‹s
) {

3030 
mddev
->
ªcovîy_˝
 = mddev->
dev_£˘‹s
;

3031 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

3033 
mddev
->
dev_£˘‹s
 = 
£˘‹s
;

3034 
mddev
->
ªsync_max_£˘‹s
 = 
£˘‹s
;

3036 
	}
}

3038 
	$øid1_ªsh≠e
(
mddev
 *mddev)

3051 
mempoﬁ_t
 *
√wpoﬁ
, *
ﬁdpoﬁ
;

3052 
poﬁ_öfo
 *
√wpoﬁöfo
;

3053 
øid1_öfo
 *
√wmúr‹s
;

3054 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3055 
˙t
, 
øid_disks
;

3056 
Êags
;

3057 
d
, 
d2
, 
îr
;

3060 i‡(
mddev
->
chunk_£˘‹s
 !mddev->
√w_chunk_£˘‹s
 ||

3061 
mddev
->
œyout
 !mddev->
√w_œyout
 ||

3062 
mddev
->
Àvñ
 !mddev->
√w_Àvñ
) {

3063 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

3064 
mddev
->
√w_œyout
 = mddev->
œyout
;

3065 
mddev
->
√w_Àvñ
 = mddev->
Àvñ
;

3066  -
EINVAL
;

3069 
îr
 = 
	`md_Ælow_wrôe
(
mddev
);

3070 i‡(
îr
)

3071  
îr
;

3073 
øid_disks
 = 
mddev
->øid_disk†+ mddev->
dñè_disks
;

3075 i‡(
øid_disks
 < 
c⁄f
->raid_disks) {

3076 
˙t
=0;

3077 
d
0; d < 
c⁄f
->
øid_disks
; d++)

3078 i‡(
c⁄f
->
múr‹s
[
d
].
rdev
)

3079 
˙t
++;

3080 i‡(
˙t
 > 
øid_disks
)

3081  -
EBUSY
;

3084 
√wpoﬁöfo
 = 
	`kmÆloc
((*√wpoﬁöfo), 
GFP_KERNEL
);

3085 i‡(!
√wpoﬁöfo
)

3086  -
ENOMEM
;

3087 
√wpoﬁöfo
->
mddev
 = mddev;

3088 
√wpoﬁöfo
->
øid_disks
 =Ñaid_disks * 2;

3090 
√wpoﬁ
 = 
	`mempoﬁ_¸óã
(
NR_RAID1_BIOS
, 
r1bio_poﬁ_Æloc
,

3091 
r1bio_poﬁ_‰ì
, 
√wpoﬁöfo
);

3092 i‡(!
√wpoﬁ
) {

3093 
	`k‰ì
(
√wpoﬁöfo
);

3094  -
ENOMEM
;

3096 
√wmúr‹s
 = 
	`kzÆloc
((
øid1_öfo
Ë* 
øid_disks
 * 2,

3097 
GFP_KERNEL
);

3098 i‡(!
√wmúr‹s
) {

3099 
	`k‰ì
(
√wpoﬁöfo
);

3100 
	`mempoﬁ_de°roy
(
√wpoﬁ
);

3101  -
ENOMEM
;

3104 
	`‰ìze_¨øy
(
c⁄f
, 0);

3107 
ﬁdpoﬁ
 = 
c⁄f
->
r1bio_poﬁ
;

3108 
c⁄f
->
r1bio_poﬁ
 = 
√wpoﬁ
;

3110 
d
 = 
d2
 = 0; d < 
c⁄f
->
øid_disks
; d++) {

3111 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

3112 i‡(
rdev
 &&Ñdev->
øid_disk
 !
d2
) {

3113 
	`sysfs_u∆ök_rdev
(
mddev
, 
rdev
);

3114 
rdev
->
øid_disk
 = 
d2
;

3115 
	`sysfs_u∆ök_rdev
(
mddev
, 
rdev
);

3116 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

3117 
	`¥ötk
(
KERN_WARNING


3119 
	`md«me
(
mddev
), 
rdev
->
øid_disk
);

3121 i‡(
rdev
)

3122 
√wmúr‹s
[
d2
++].
rdev
 =Ñdev;

3124 
	`k‰ì
(
c⁄f
->
múr‹s
);

3125 
c⁄f
->
múr‹s
 = 
√wmúr‹s
;

3126 
	`k‰ì
(
c⁄f
->
poﬁöfo
);

3127 
c⁄f
->
poﬁöfo
 = 
√wpoﬁöfo
;

3129 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

3130 
mddev
->
degøded
 +(
øid_disks
 - 
c⁄f
->raid_disks);

3131 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

3132 
c⁄f
->
øid_disks
 = 
mddev
->raid_disks =Ñaid_disks;

3133 
mddev
->
dñè_disks
 = 0;

3135 
	`un‰ìze_¨øy
(
c⁄f
);

3137 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

3138 
	`md_wakeup_thªad
(
mddev
->
thªad
);

3140 
	`mempoﬁ_de°roy
(
ﬁdpoﬁ
);

3142 
	}
}

3144 
	$øid1_quõs˚
(
mddev
 *mddev, 
°©e
)

3146 
r1c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3148 
°©e
) {

3150 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

3153 
	`‰ìze_¨øy
(
c⁄f
, 0);

3156 
	`un‰ìze_¨øy
(
c⁄f
);

3159 
	}
}

3161 *
	$øid1_èkeovî
(
mddev
 *mddev)

3166 i‡(
mddev
->
Àvñ
 =5 && mddev->
øid_disks
 == 2) {

3167 
r1c⁄f
 *
c⁄f
;

3168 
mddev
->
√w_Àvñ
 = 1;

3169 
mddev
->
√w_œyout
 = 0;

3170 
mddev
->
√w_chunk_£˘‹s
 = 0;

3171 
c⁄f
 = 
	`£tup_c⁄f
(
mddev
);

3172 i‡(!
	`IS_ERR
(
c⁄f
))

3174 
c⁄f
->
¨øy_‰ozí
 = 1;

3175  
c⁄f
;

3177  
	`ERR_PTR
(-
EINVAL
);

3178 
	}
}

3180 
md_≥rs⁄Æôy
 
	gøid1_≥rs⁄Æôy
 =

3182 .
«me
 = "raid1",

3183 .
	gÀvñ
 = 1,

3184 .
	gow√r
 = 
THIS_MODULE
,

3185 .
	gmake_ªque°
 = 
make_ªque°
,

3186 .
	grun
 = 
run
,

3187 .
	g°›
 = 
°›
,

3188 .
	g°©us
 = 
°©us
,

3189 .
	gîr‹_h™dÀr
 = 
îr‹
,

3190 .
	ghŸ_add_disk
 = 
øid1_add_disk
,

3191 .
	ghŸ_ªmove_disk

øid1_ªmove_disk
,

3192 .
	g•¨e_a˘ive
 = 
øid1_•¨e_a˘ive
,

3193 .
	gsync_ªque°
 = 
sync_ªque°
,

3194 .
	gªsize
 = 
øid1_ªsize
,

3195 .
	gsize
 = 
øid1_size
,

3196 .
	gcheck_ªsh≠e
 = 
øid1_ªsh≠e
,

3197 .
	gquõs˚
 = 
øid1_quõs˚
,

3198 .
	gèkeovî
 = 
øid1_èkeovî
,

3201 
__öô
 
	$øid_öô
()

3203  
	`ªgi°î_md_≥rs⁄Æôy
(&
øid1_≥rs⁄Æôy
);

3204 
	}
}

3206 
	$øid_exô
()

3208 
	`uƒegi°î_md_≥rs⁄Æôy
(&
øid1_≥rs⁄Æôy
);

3209 
	}
}

3211 
moduÀ_öô
(
øid_öô
);

3212 
moduÀ_exô
(
øid_exô
);

3213 
MODULE_LICENSE
("GPL");

3214 
MODULE_DESCRIPTION
("RAID1 (mirroring)Öersonality for MD");

3215 
MODULE_ALIAS
("md-personality-3");

3216 
MODULE_ALIAS
("md-raid1");

3217 
MODULE_ALIAS
("md-level-1");

3219 
moduÀ_∑øm
(
max_queued_ªque°s
, , 
S_IRUGO
|
S_IWUSR
);

	@raid1.h

1 #i‚de‡
_RAID1_H


2 
	#_RAID1_H


	)

4 
	søid1_öfo
 {

5 
md_rdev
 *
	mrdev
;

6 
£˘‹_t
 
	mhód_posôi⁄
;

11 
£˘‹_t
 
	m√xt_£q_£˘
;

12 
£˘‹_t
 
	m£q_°¨t
;

26 
	spoﬁ_öfo
 {

27 
mddev
 *
	mmddev
;

28 
	møid_disks
;

31 
	sr1c⁄f
 {

32 
mddev
 *
	mmddev
;

33 
øid1_öfo
 *
	mmúr‹s
;

36 
	møid_disks
;

42 
£˘‹_t
 
	m√xt_ªsync
;

53 
£˘‹_t
 
	m°¨t_√xt_wödow
;

54 
	mcuºít_wödow_ªque°s
;

55 
	m√xt_wödow_ªque°s
;

57 
•ölock_t
 
	mdevi˚_lock
;

63 
li°_hód
 
	mªåy_li°
;

66 
bio_li°
 
	m≥ndög_bio_li°
;

67 
	m≥ndög_cou¡
;

75 
waô_queue_hód_t
 
	mwaô_b¨rõr
;

76 
•ölock_t
 
	mªsync_lock
;

77 
	mƒ_≥ndög
;

78 
	mƒ_waôög
;

79 
	mƒ_queued
;

80 
	mb¨rõr
;

81 
	m¨øy_‰ozí
;

86 
	mfuŒsync
;

91 
	mªcovîy_dißbÀd
;

97 
poﬁ_öfo
 *
	mpoﬁöfo
;

98 
mempoﬁ_t
 *
	mr1bio_poﬁ
;

99 
mempoﬁ_t
 *
	mr1buf_poﬁ
;

104 
∑ge
 *
	mtmµage
;

110 
md_thªad
 *
	mthªad
;

120 
	sr1bio
 {

121 
©omic_t
 
	mªmaöög
;

124 
©omic_t
 
	mbehöd_ªmaöög
;

127 
£˘‹_t
 
	m£˘‹
;

128 
£˘‹_t
 
	m°¨t_√xt_wödow
;

129 
	m£˘‹s
;

130 
	m°©e
;

131 
mddev
 *
	mmddev
;

135 
bio
 *
	mma°î_bio
;

139 
	mªad_disk
;

141 
li°_hód
 
	mªåy_li°
;

143 
bio_vec
 *
	mbehöd_bvecs
;

144 
	mbehöd_∑ge_cou¡
;

149 
bio
 *
	mbios
[0];

154 
	#R1BIO_U±od©e
 0

	)

155 
	#R1BIO_IsSync
 1

	)

156 
	#R1BIO_Degøded
 2

	)

157 
	#R1BIO_BehödIO
 3

	)

161 
	#R1BIO_RódEº‹
 4

	)

169 
	#R1BIO_Rëu∫ed
 6

	)

173 
	#R1BIO_MadeGood
 7

	)

174 
	#R1BIO_WrôeEº‹
 8

	)

176 
md_øid1_c⁄ge°ed
(
mddev
 *mddev, 
bôs
);

	@raid1.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xc1eb978a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_mîge_bvec
) },

24 { 0x543b4234, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

25 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

26 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

27 { 0x7b56f141, 
__VMLINUX_SYMBOL_STR
(
submô_bio_waô
) },

28 { 0x3d69f5a0, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

29 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

30 { 0xc24e2400, 
__VMLINUX_SYMBOL_STR
(
rdev_£t_badblocks
) },

31 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

32 { 0xb6b46a7c, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_öt
) },

33 { 0x412fc7c2, 
__VMLINUX_SYMBOL_STR
(
md_is_badblock
) },

34 { 0xb78f29de, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_mddev
) },

35 { 0xc8b57c27, 
__VMLINUX_SYMBOL_STR
(
aut‹emove_wake_fun˘i⁄
) },

36 { 0x6c3e048, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_mddev
) },

37 { 0x21e3985c, 
__VMLINUX_SYMBOL_STR
(
md_check_ªcovîy
) },

38 { 0x2a62f6ó, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_íd
) },

39 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

40 { 0xf087137d, 
__VMLINUX_SYMBOL_STR
(
__dy«mic_¥_debug
) },

41 { 0x28624bc7, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ídwrôe
) },

42 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

43 { 0x8c6766ba, 
__VMLINUX_SYMBOL_STR
(
bôm≠_u≈lug
) },

44 { 0x2Á06db6, 
__VMLINUX_SYMBOL_STR
(
bio_åim
) },

45 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

46 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

47 { 0x5c750c00, 
__VMLINUX_SYMBOL_STR
(
ªvÆid©e_disk
) },

48 { 0xìff458e, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ªsize
) },

49 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

50 { 0xc3639d5e, 
__VMLINUX_SYMBOL_STR
(
bio_ª£t
) },

51 { 0x78b3a75f, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨t_sync
) },

52 { 0xd27b25dd, 
__VMLINUX_SYMBOL_STR
(
blk_check_∂ugged
) },

53 { 0x7723Øab, 
__VMLINUX_SYMBOL_STR
(
md_ªgi°î_thªad
) },

54 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

55 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

56 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

57 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

58 { 0xd14e5bc6, 
__VMLINUX_SYMBOL_STR
(
bio_add_∑ge
) },

59 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

60 { 0xb2ìc3d, 
__VMLINUX_SYMBOL_STR
(
bôm≠_˛o£_sync
) },

61 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

62 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchr⁄ize_sched
) },

63 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

64 { 0x27edb51, 
__VMLINUX_SYMBOL_STR
(
sysfs_ªmove_lök
) },

65 { 0x669183e6, 
__VMLINUX_SYMBOL_STR
(
md_waô_f‹_blocked_rdev
) },

66 { 0x2c˚a702, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_add_rdev
) },

67 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

68 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

69 { 0xfc5b7524, 
__VMLINUX_SYMBOL_STR
(
md_d⁄e_sync
) },

70 { 0x73d8cb6e, 
__VMLINUX_SYMBOL_STR
(
Êush_sig«ls
) },

71 { 0x210fd9b, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_lök
) },

72 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

73 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

74 { 0x48dc4149, 
__VMLINUX_SYMBOL_STR
(
__‰ì_∑ges
) },

75 { 0x4af67747, 
__VMLINUX_SYMBOL_STR
(
bôm≠_c⁄d_íd_sync
) },

76 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

77 { 0xc16fc560, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_°¨t
) },

78 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

79 { 0xd98d7985, 
__VMLINUX_SYMBOL_STR
(
rdev_˛ór_badblocks
) },

80 { 0x4b0f0127, 
__VMLINUX_SYMBOL_STR
(
md_Ælow_wrôe
) },

81 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

82 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

83 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

84 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

85 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

86 { 0xc90c172a, 
__VMLINUX_SYMBOL_STR
(
md_wakeup_thªad
) },

87 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

88 { 0xcc5005„, 
__VMLINUX_SYMBOL_STR
(
m¶ìp_öãºu±ibÀ
) },

89 { 0x7d788265, 
__VMLINUX_SYMBOL_STR
(
kînfs_nŸify
) },

90 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

91 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

92 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

93 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

94 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

95 { 0x5ab10213, 
__VMLINUX_SYMBOL_STR
(
sync_∑ge_io
) },

96 { 0x4c107f4a, 
__VMLINUX_SYMBOL_STR
(
md_uƒegi°î_thªad
) },

97 { 0x7db˚81d, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_∑ges
) },

98 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

99 { 0x2db8046c, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨twrôe
) },

100 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

101 { 0x5c8b5˚8, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô
) },

102 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

103 { 0x2f6da7a9, 
__VMLINUX_SYMBOL_STR
(
md_îr‹
) },

104 { 0x88c6f˚5, 
__VMLINUX_SYMBOL_STR
(
put_∑ge
) },

105 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

106 { 0x53219ì8, 
__VMLINUX_SYMBOL_STR
(
bio_c›y_d©a
) },

107 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

108 { 0x3cb8db59, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_wrôe_ßme_£˘‹s
) },

109 { 0x719b4945, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_ªgi°î
) },

110 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

111 { 0xa73a„00, 
__VMLINUX_SYMBOL_STR
(
bôm≠_íd_sync
) },

114 c⁄° 
	g__moduÀ_dïíds
[]

115 
__u£d


116 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

120 
MODULE_INFO
(
§cvîsi⁄
, "CC013552B21CCC59204B6F6");

	@raid10.c

21 
	~<löux/¶ab.h
>

22 
	~<löux/dñay.h
>

23 
	~<löux/blkdev.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<löux/£q_fûe.h
>

26 
	~<löux/øãlimô.h
>

27 
	~<löux/kthªad.h
>

28 
	~"md.h
"

29 
	~"øid10.h
"

30 
	~"øid0.h
"

31 
	~"bôm≠.h
"

76 
	#NR_RAID10_BIOS
 256

	)

83 
	#IO_BLOCKED
 ((
bio
 *)1)

	)

88 
	#IO_MADE_GOOD
 ((
bio
 *)2)

	)

90 
	#BIO_SPECIAL
(
bio
Ë(()biÿ<2)

	)

96 
	gmax_queued_ªque°s
 = 1024;

98 
Ælow_b¨rõr
(
r10c⁄f
 *
c⁄f
);

99 
lowî_b¨rõr
(
r10c⁄f
 *
c⁄f
);

100 
_íough
(
r10c⁄f
 *
c⁄f
, 
¥evious
, 
ign‹e
);

101 
£˘‹_t
 
ªsh≠e_ªque°
(
mddev
 *mddev, se˘‹_à
£˘‹_ƒ
,

102 *
skù≥d
);

103 
ªsh≠e_ªque°_wrôe
(
mddev
 *mddev, 
r10bio
 *
r10_bio
);

104 
íd_ªsh≠e_wrôe
(
bio
 *bio, 
îr‹
);

105 
íd_ªsh≠e
(
r10c⁄f
 *
c⁄f
);

107 * 
	$r10bio_poﬁ_Æloc
(
gÂ_t
 
gÂ_Êags
, *
d©a
)

109 
r10c⁄f
 *
c⁄f
 = 
d©a
;

110 
size
 = 
	`off£tof
(
r10bio
, 
devs
[
c⁄f
->
c›õs
]);

114  
	`kzÆloc
(
size
, 
gÂ_Êags
);

115 
	}
}

117 
	$r10bio_poﬁ_‰ì
(*
r10_bio
, *
d©a
)

119 
	`k‰ì
(
r10_bio
);

120 
	}
}

123 
	#RESYNC_BLOCK_SIZE
 (64*1024)

	)

124 
	#RESYNC_PAGES
 ((
RESYNC_BLOCK_SIZE
 + 
PAGE_SIZE
-1Ë/ PAGE_SIZE)

	)

126 
	#RESYNC_WINDOW
 (1024*1024)

	)

128 
	#RESYNC_DEPTH
 (32*1024*1024/
RESYNC_BLOCK_SIZE
)

	)

137 * 
	$r10buf_poﬁ_Æloc
(
gÂ_t
 
gÂ_Êags
, *
d©a
)

139 
r10c⁄f
 *
c⁄f
 = 
d©a
;

140 
∑ge
 *page;

141 
r10bio
 *
r10_bio
;

142 
bio
 *bio;

143 
i
, 
j
;

144 
«Œoc
;

146 
r10_bio
 = 
	`r10bio_poﬁ_Æloc
(
gÂ_Êags
, 
c⁄f
);

147 i‡(!
r10_bio
)

148  
NULL
;

150 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
c⁄f
->
mddev
->
ªcovîy
) ||

151 
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
c⁄f
->
mddev
->
ªcovîy
))

152 
«Œoc
 = 
c⁄f
->
c›õs
;

154 
«Œoc
 = 2;

159 
j
 = 
«Œoc
 ; j-- ; ) {

160 
bio
 = 
	`bio_kmÆloc
(
gÂ_Êags
, 
RESYNC_PAGES
);

161 i‡(!
bio
)

162 
out_‰ì_bio
;

163 
r10_bio
->
devs
[
j
].
bio
 = bio;

164 i‡(!
c⁄f
->
have_ª∂a˚mít
)

166 
bio
 = 
	`bio_kmÆloc
(
gÂ_Êags
, 
RESYNC_PAGES
);

167 i‡(!
bio
)

168 
out_‰ì_bio
;

169 
r10_bio
->
devs
[
j
].
ª∂_bio
 = 
bio
;

175 
j
 = 0 ; j < 
«Œoc
; j++) {

176 
bio
 *
rbio
 = 
r10_bio
->
devs
[
j
].
ª∂_bio
;

177 
bio
 = 
r10_bio
->
devs
[
j
].bio;

178 
i
 = 0; i < 
RESYNC_PAGES
; i++) {

179 i‡(
j
 > 0 && !
	`ã°_bô
(
MD_RECOVERY_SYNC
,

180 &
c⁄f
->
mddev
->
ªcovîy
)) {

183 
bio
 *
rbio
 = 
r10_bio
->
devs
[0].bio;

184 
∑ge
 = 
rbio
->
bi_io_vec
[
i
].
bv_∑ge
;

185 
	`gë_∑ge
(
∑ge
);

187 
∑ge
 = 
	`Æloc_∑ge
(
gÂ_Êags
);

188 i‡(
	`u∆ikñy
(!
∑ge
))

189 
out_‰ì_∑ges
;

191 
bio
->
bi_io_vec
[
i
].
bv_∑ge
 = 
∑ge
;

192 i‡(
rbio
)

193 
rbio
->
bi_io_vec
[
i
].
bv_∑ge
 = 
∑ge
;

197  
r10_bio
;

199 
out_‰ì_∑ges
:

200  ; 
i
 > 0 ; i--)

201 
	`ß„_put_∑ge
(
bio
->
bi_io_vec
[
i
-1].
bv_∑ge
);

202 
j
--)

203 
i
 = 0; i < 
RESYNC_PAGES
 ; i++)

204 
	`ß„_put_∑ge
(
r10_bio
->
devs
[
j
].
bio
->
bi_io_vec
[
i
].
bv_∑ge
);

205 
j
 = 0;

206 
out_‰ì_bio
:

207  ; 
j
 < 
«Œoc
; j++) {

208 i‡(
r10_bio
->
devs
[
j
].
bio
)

209 
	`bio_put
(
r10_bio
->
devs
[
j
].
bio
);

210 i‡(
r10_bio
->
devs
[
j
].
ª∂_bio
)

211 
	`bio_put
(
r10_bio
->
devs
[
j
].
ª∂_bio
);

213 
	`r10bio_poﬁ_‰ì
(
r10_bio
, 
c⁄f
);

214  
NULL
;

215 
	}
}

217 
	$r10buf_poﬁ_‰ì
(*
__r10_bio
, *
d©a
)

219 
i
;

220 
r10c⁄f
 *
c⁄f
 = 
d©a
;

221 
r10bio
 *r10biÿ
__r10_bio
;

222 
j
;

224 
j
=0; j < 
c⁄f
->
c›õs
; j++) {

225 
bio
 *biÿ
r10bio
->
devs
[
j
].bio;

226 i‡(
bio
) {

227 
i
 = 0; i < 
RESYNC_PAGES
; i++) {

228 
	`ß„_put_∑ge
(
bio
->
bi_io_vec
[
i
].
bv_∑ge
);

229 
bio
->
bi_io_vec
[
i
].
bv_∑ge
 = 
NULL
;

231 
	`bio_put
(
bio
);

233 
bio
 = 
r10bio
->
devs
[
j
].
ª∂_bio
;

234 i‡(
bio
)

235 
	`bio_put
(
bio
);

237 
	`r10bio_poﬁ_‰ì
(
r10bio
, 
c⁄f
);

238 
	}
}

240 
	$put_Æl_bios
(
r10c⁄f
 *
c⁄f
, 
r10bio
 *
r10_bio
)

242 
i
;

244 
i
 = 0; i < 
c⁄f
->
c›õs
; i++) {

245 
bio
 **biÿ& 
r10_bio
->
devs
[
i
].bio;

246 i‡(!
	`BIO_SPECIAL
(*
bio
))

247 
	`bio_put
(*
bio
);

248 *
bio
 = 
NULL
;

249 
bio
 = &
r10_bio
->
devs
[
i
].
ª∂_bio
;

250 i‡(
r10_bio
->
ªad_¶Ÿ
 < 0 && !
	`BIO_SPECIAL
(*
bio
))

251 
	`bio_put
(*
bio
);

252 *
bio
 = 
NULL
;

254 
	}
}

256 
	$‰ì_r10bio
(
r10bio
 *
r10_bio
)

258 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

260 
	`put_Æl_bios
(
c⁄f
, 
r10_bio
);

261 
	`mempoﬁ_‰ì
(
r10_bio
, 
c⁄f
->
r10bio_poﬁ
);

262 
	}
}

264 
	$put_buf
(
r10bio
 *
r10_bio
)

266 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

268 
	`mempoﬁ_‰ì
(
r10_bio
, 
c⁄f
->
r10buf_poﬁ
);

270 
	`lowî_b¨rõr
(
c⁄f
);

271 
	}
}

273 
	$ªscheduÀ_ªåy
(
r10bio
 *
r10_bio
)

275 
Êags
;

276 
mddev
 *mddev = 
r10_bio
->mddev;

277 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

279 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

280 
	`li°_add
(&
r10_bio
->
ªåy_li°
, &
c⁄f
->retry_list);

281 
c⁄f
->
ƒ_queued
 ++;

282 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

285 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

287 
	`md_wakeup_thªad
(
mddev
->
thªad
);

288 
	}
}

295 
	$øid_íd_bio_io
(
r10bio
 *
r10_bio
)

297 
bio
 *biÿ
r10_bio
->
ma°î_bio
;

298 
d⁄e
;

299 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

301 i‡(
bio
->
bi_phys_£gmíts
) {

302 
Êags
;

303 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

304 
bio
->
bi_phys_£gmíts
--;

305 
d⁄e
 = (
bio
->
bi_phys_£gmíts
 == 0);

306 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

308 
d⁄e
 = 1;

309 i‡(!
	`ã°_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
))

310 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

311 i‡(
d⁄e
) {

312 
	`bio_ídio
(
bio
, 0);

317 
	`Ælow_b¨rõr
(
c⁄f
);

319 
	`‰ì_r10bio
(
r10_bio
);

320 
	}
}

325 
ölöe
 
	$upd©e_hód_pos
(
¶Ÿ
, 
r10bio
 *
r10_bio
)

327 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

329 
c⁄f
->
múr‹s
[
r10_bio
->
devs
[
¶Ÿ
].
devnum
].
hód_posôi⁄
 =

330 
r10_bio
->
devs
[
¶Ÿ
].
addr
 + (r10_bio->
£˘‹s
);

331 
	}
}

336 
	$föd_bio_disk
(
r10c⁄f
 *
c⁄f
, 
r10bio
 *
r10_bio
,

337 
bio
 *bio, *
¶Ÿp
, *
ª∂p
)

339 
¶Ÿ
;

340 
ª∂
 = 0;

342 
¶Ÿ
 = 0; slŸ < 
c⁄f
->
c›õs
; slot++) {

343 i‡(
r10_bio
->
devs
[
¶Ÿ
].
bio
 == bio)

345 i‡(
r10_bio
->
devs
[
¶Ÿ
].
ª∂_bio
 =
bio
) {

346 
ª∂
 = 1;

351 
	`BUG_ON
(
¶Ÿ
 =
c⁄f
->
c›õs
);

352 
	`upd©e_hód_pos
(
¶Ÿ
, 
r10_bio
);

354 i‡(
¶Ÿp
)

355 *
¶Ÿp
 = 
¶Ÿ
;

356 i‡(
ª∂p
)

357 *
ª∂p
 = 
ª∂
;

358  
r10_bio
->
devs
[
¶Ÿ
].
devnum
;

359 
	}
}

361 
	$øid10_íd_ªad_ªque°
(
bio
 *bio, 
îr‹
)

363 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

364 
r10bio
 *
r10_bio
 = 
bio
->
bi_¥iv©e
;

365 
¶Ÿ
, 
dev
;

366 
md_rdev
 *
rdev
;

367 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

370 
¶Ÿ
 = 
r10_bio
->
ªad_¶Ÿ
;

371 
dev
 = 
r10_bio
->
devs
[
¶Ÿ
].
devnum
;

372 
rdev
 = 
r10_bio
->
devs
[
¶Ÿ
].rdev;

376 
	`upd©e_hód_pos
(
¶Ÿ
, 
r10_bio
);

378 i‡(
u±od©e
) {

388 
	`£t_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
);

395 i‡(!
	`_íough
(
c⁄f
, 
	`ã°_bô
(
R10BIO_Pªvious
, &
r10_bio
->
°©e
),

396 
rdev
->
øid_disk
))

397 
u±od©e
 = 1;

399 i‡(
u±od©e
) {

400 
	`øid_íd_bio_io
(
r10_bio
);

401 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

406 
b
[
BDEVNAME_SIZE
];

407 
	`¥ötk_øãlimôed
(
KERN_ERR


409 
	`md«me
(
c⁄f
->
mddev
),

410 
	`bdev«me
(
rdev
->
bdev
, 
b
),

411 ()
r10_bio
->
£˘‹
);

412 
	`£t_bô
(
R10BIO_RódEº‹
, &
r10_bio
->
°©e
);

413 
	`ªscheduÀ_ªåy
(
r10_bio
);

415 
	}
}

417 
	$˛o£_wrôe
(
r10bio
 *
r10_bio
)

420 
	`bôm≠_ídwrôe
(
r10_bio
->
mddev
->
bôm≠
,Ñ10_bio->
£˘‹
,

421 
r10_bio
->
£˘‹s
,

422 !
	`ã°_bô
(
R10BIO_Degøded
, &
r10_bio
->
°©e
),

424 
	`md_wrôe_íd
(
r10_bio
->
mddev
);

425 
	}
}

427 
	$⁄e_wrôe_d⁄e
(
r10bio
 *
r10_bio
)

429 i‡(
	`©omic_dec_™d_ã°
(&
r10_bio
->
ªmaöög
)) {

430 i‡(
	`ã°_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
))

431 
	`ªscheduÀ_ªåy
(
r10_bio
);

433 
	`˛o£_wrôe
(
r10_bio
);

434 i‡(
	`ã°_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
))

435 
	`ªscheduÀ_ªåy
(
r10_bio
);

437 
	`øid_íd_bio_io
(
r10_bio
);

440 
	}
}

442 
	$øid10_íd_wrôe_ªque°
(
bio
 *bio, 
îr‹
)

444 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

445 
r10bio
 *
r10_bio
 = 
bio
->
bi_¥iv©e
;

446 
dev
;

447 
dec_rdev
 = 1;

448 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

449 
¶Ÿ
, 
ª∂
;

450 
md_rdev
 *
rdev
 = 
NULL
;

452 
dev
 = 
	`föd_bio_disk
(
c⁄f
, 
r10_bio
, 
bio
, &
¶Ÿ
, &
ª∂
);

454 i‡(
ª∂
)

455 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].
ª∂a˚mít
;

456 i‡(!
rdev
) {

457 
	`smp_rmb
();

458 
ª∂
 = 0;

459 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].rdev;

464 i‡(!
u±od©e
) {

465 i‡(
ª∂
)

469 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

471 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

472 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
))

473 
	`£t_bô
(
MD_RECOVERY_NEEDED
,

474 &
rdev
->
mddev
->
ªcovîy
);

475 
	`£t_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
);

476 
dec_rdev
 = 0;

488 
£˘‹_t
 
fú°_bad
;

489 
bad_£˘‹s
;

499 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

500 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

501 
	`£t_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
);

504 i‡(
	`is_badblock
(
rdev
,

505 
r10_bio
->
devs
[
¶Ÿ
].
addr
,

506 
r10_bio
->
£˘‹s
,

507 &
fú°_bad
, &
bad_£˘‹s
)) {

508 
	`bio_put
(
bio
);

509 i‡(
ª∂
)

510 
r10_bio
->
devs
[
¶Ÿ
].
ª∂_bio
 = 
IO_MADE_GOOD
;

512 
r10_bio
->
devs
[
¶Ÿ
].
bio
 = 
IO_MADE_GOOD
;

513 
dec_rdev
 = 0;

514 
	`£t_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
);

523 
	`⁄e_wrôe_d⁄e
(
r10_bio
);

524 i‡(
dec_rdev
)

525 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

526 
	}
}

553 
	$__øid10_föd_phys
(
geom
 *
geo
, 
r10bio
 *r10bio)

555 
n
,
f
;

556 
£˘‹_t
 
£˘‹
;

557 
£˘‹_t
 
chunk
;

558 
£˘‹_t
 
°rùe
;

559 
dev
;

560 
¶Ÿ
 = 0;

561 
œ°_Ár_£t_°¨t
, 
œ°_Ár_£t_size
;

563 
œ°_Ár_£t_°¨t
 = (
geo
->
øid_disks
 / geo->
Ár_£t_size
) - 1;

564 
œ°_Ár_£t_°¨t
 *
geo
->
Ár_£t_size
;

566 
œ°_Ár_£t_size
 = 
geo
->
Ár_£t_size
;

567 
œ°_Ár_£t_size
 +(
geo
->
øid_disks
 % geo->
Ár_£t_size
);

570 
chunk
 = 
r10bio
->
£˘‹
 >> 
geo
->
chunk_shi·
;

571 
£˘‹
 = 
r10bio
->£˘‹ & 
geo
->
chunk_mask
;

573 
chunk
 *
geo
->
√¨_c›õs
;

574 
°rùe
 = 
chunk
;

575 
dev
 = 
	`£˘‹_div
(
°rùe
, 
geo
->
øid_disks
);

576 i‡(
geo
->
Ár_off£t
)

577 
°rùe
 *
geo
->
Ár_c›õs
;

579 
£˘‹
 +
°rùe
 << 
geo
->
chunk_shi·
;

582 
n
 = 0;Ç < 
geo
->
√¨_c›õs
;Ç++) {

583 
d
 = 
dev
;

584 
£t
;

585 
£˘‹_t
 
s
 = 
£˘‹
;

586 
r10bio
->
devs
[
¶Ÿ
].
devnum
 = 
d
;

587 
r10bio
->
devs
[
¶Ÿ
].
addr
 = 
s
;

588 
¶Ÿ
++;

590 
f
 = 1; f < 
geo
->
Ár_c›õs
; f++) {

591 
£t
 = 
d
 / 
geo
->
Ár_£t_size
;

592 
d
 +
geo
->
√¨_c›õs
;

594 i‡((
geo
->
øid_disks
 % geo->
Ár_£t_size
) &&

595 (
d
 > 
œ°_Ár_£t_°¨t
)) {

596 
d
 -
œ°_Ár_£t_°¨t
;

597 
d
 %
œ°_Ár_£t_size
;

598 
d
 +
œ°_Ár_£t_°¨t
;

600 
d
 %
geo
->
Ár_£t_size
;

601 
d
 +
geo
->
Ár_£t_size
 * 
£t
;

603 
s
 +
geo
->
°ride
;

604 
r10bio
->
devs
[
¶Ÿ
].
devnum
 = 
d
;

605 
r10bio
->
devs
[
¶Ÿ
].
addr
 = 
s
;

606 
¶Ÿ
++;

608 
dev
++;

609 i‡(
dev
 >
geo
->
øid_disks
) {

610 
dev
 = 0;

611 
£˘‹
 +(
geo
->
chunk_mask
 + 1);

614 
	}
}

616 
	$øid10_föd_phys
(
r10c⁄f
 *
c⁄f
, 
r10bio
 *r10bio)

618 
geom
 *
geo
 = &
c⁄f
->geo;

620 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
 &&

621 ((
r10bio
->
£˘‹
 >
c⁄f
->
ªsh≠e_¥ogªss
) !=

622 
c⁄f
->
mddev
->
ªsh≠e_backw¨ds
)) {

623 
	`£t_bô
(
R10BIO_Pªvious
, &
r10bio
->
°©e
);

624 
geo
 = &
c⁄f
->
¥ev
;

626 
	`˛ór_bô
(
R10BIO_Pªvious
, &
r10bio
->
°©e
);

628 
	`__øid10_föd_phys
(
geo
, 
r10bio
);

629 
	}
}

631 
£˘‹_t
 
	$øid10_föd_vút
(
r10c⁄f
 *
c⁄f
, 
£˘‹_t
 
£˘‹
, 
dev
)

633 
£˘‹_t
 
off£t
, 
chunk
, 
vchunk
;

637 
geom
 *
geo
 = &
c⁄f
->geo;

638 
Ár_£t_°¨t
 = (
dev
 / 
geo
->
Ár_£t_size
) * geo->far_set_size;

639 
Ár_£t_size
 = 
geo
->far_set_size;

640 
œ°_Ár_£t_°¨t
;

642 i‡(
geo
->
øid_disks
 % geo->
Ár_£t_size
) {

643 
œ°_Ár_£t_°¨t
 = (
geo
->
øid_disks
 / geo->
Ár_£t_size
) - 1;

644 
œ°_Ár_£t_°¨t
 *
geo
->
Ár_£t_size
;

646 i‡(
dev
 >
œ°_Ár_£t_°¨t
) {

647 
Ár_£t_size
 = 
geo
->far_set_size;

648 
Ár_£t_size
 +(
geo
->
øid_disks
 % geo->far_set_size);

649 
Ár_£t_°¨t
 = 
œ°_Ár_£t_°¨t
;

653 
off£t
 = 
£˘‹
 & 
geo
->
chunk_mask
;

654 i‡(
geo
->
Ár_off£t
) {

655 
fc
;

656 
chunk
 = 
£˘‹
 >> 
geo
->
chunk_shi·
;

657 
fc
 = 
	`£˘‹_div
(
chunk
, 
geo
->
Ár_c›õs
);

658 
dev
 -
fc
 * 
geo
->
√¨_c›õs
;

659 i‡(
dev
 < 
Ár_£t_°¨t
)

660 
dev
 +
Ár_£t_size
;

662 
£˘‹
 >
geo
->
°ride
) {

663 
£˘‹
 -
geo
->
°ride
;

664 i‡(
dev
 < (
geo
->
√¨_c›õs
 + 
Ár_£t_°¨t
))

665 
dev
 +
Ár_£t_size
 - 
geo
->
√¨_c›õs
;

667 
dev
 -
geo
->
√¨_c›õs
;

669 
chunk
 = 
£˘‹
 >> 
geo
->
chunk_shi·
;

671 
vchunk
 = 
chunk
 * 
geo
->
øid_disks
 + 
dev
;

672 
	`£˘‹_div
(
vchunk
, 
geo
->
√¨_c›õs
);

673  (
vchunk
 << 
geo
->
chunk_shi·
Ë+ 
off£t
;

674 
	}
}

686 
	$øid10_mîgóbÀ_bvec
(
ªque°_queue
 *
q
,

687 
bvec_mîge_d©a
 *
bvm
,

688 
bio_vec
 *
biovec
)

690 
mddev
 *mddev = 
q
->
queued©a
;

691 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

692 
£˘‹_t
 
£˘‹
 = 
bvm
->
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bvm->
bi_bdev
);

693 
max
;

694 
chunk_£˘‹s
;

695 
bio_£˘‹s
 = 
bvm
->
bi_size
 >> 9;

696 
geom
 *
geo
 = &
c⁄f
->geo;

698 
chunk_£˘‹s
 = (
c⁄f
->
geo
.
chunk_mask
 & c⁄f->
¥ev
.chunk_mask) + 1;

699 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
 &&

700 ((
£˘‹
 >
c⁄f
->
ªsh≠e_¥ogªss
) !=

701 
c⁄f
->
mddev
->
ªsh≠e_backw¨ds
))

702 
geo
 = &
c⁄f
->
¥ev
;

704 i‡(
geo
->
√¨_c›õs
 < geo->
øid_disks
) {

705 
max
 = (
chunk_£˘‹s
 - ((
£˘‹
 & (chunk_sectors - 1))

706 + 
bio_£˘‹s
)) << 9;

707 i‡(
max
 < 0)

709 
max
 = 0;

710 i‡(
max
 <
biovec
->
bv_Àn
 && 
bio_£˘‹s
 == 0)

711  
biovec
->
bv_Àn
;

713 
max
 = 
biovec
->
bv_Àn
;

715 i‡(
mddev
->
mîge_check_√eded
) {

717 
r10bio
 
r10_bio
;

718 
r10dev
 
devs
[
c⁄f
->
c›õs
];

719 } 
⁄_°ack
;

720 
r10bio
 *
r10_bio
 = &
⁄_°ack
.r10_bio;

721 
s
;

722 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

724 i‡(
max
 <
biovec
->
bv_Àn
 && 
bio_£˘‹s
 == 0)

725  
biovec
->
bv_Àn
;

728 
r10_bio
->
£˘‹
 = sector;

729 
	`øid10_föd_phys
(
c⁄f
, 
r10_bio
);

730 
	`rcu_ªad_lock
();

731 
s
 = 0; s < 
c⁄f
->
c›õs
; s++) {

732 
disk
 = 
r10_bio
->
devs
[
s
].
devnum
;

733 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(

734 
c⁄f
->
múr‹s
[
disk
].
rdev
);

735 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

736 
ªque°_queue
 *
q
 =

737 
	`bdev_gë_queue
(
rdev
->
bdev
);

738 i‡(
q
->
mîge_bvec_‚
) {

739 
bvm
->
bi_£˘‹
 = 
r10_bio
->
devs
[
s
].
addr


740 + 
rdev
->
d©a_off£t
;

741 
bvm
->
bi_bdev
 = 
rdev
->
bdev
;

742 
max
 = 
	`mö
(max, 
q
->
	`mîge_bvec_‚
(

743 
q
, 
bvm
, 
biovec
));

746 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
disk
].
ª∂a˚mít
);

747 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

748 
ªque°_queue
 *
q
 =

749 
	`bdev_gë_queue
(
rdev
->
bdev
);

750 i‡(
q
->
mîge_bvec_‚
) {

751 
bvm
->
bi_£˘‹
 = 
r10_bio
->
devs
[
s
].
addr


752 + 
rdev
->
d©a_off£t
;

753 
bvm
->
bi_bdev
 = 
rdev
->
bdev
;

754 
max
 = 
	`mö
(max, 
q
->
	`mîge_bvec_‚
(

755 
q
, 
bvm
, 
biovec
));

759 
	`rcu_ªad_u∆ock
();

761  
max
;

762 
	}
}

783 
md_rdev
 *
	$ªad_bÆ™˚
(
r10c⁄f
 *
c⁄f
,

784 
r10bio
 *
r10_bio
,

785 *
max_£˘‹s
)

787 c⁄° 
£˘‹_t
 
this_£˘‹
 = 
r10_bio
->
£˘‹
;

788 
disk
, 
¶Ÿ
;

789 
£˘‹s
 = 
r10_bio
->sectors;

790 
be°_good_£˘‹s
;

791 
£˘‹_t
 
√w_di°™˚
, 
be°_di°
;

792 
md_rdev
 *
be°_rdev
, *
rdev
 = 
NULL
;

793 
do_bÆ™˚
;

794 
be°_¶Ÿ
;

795 
geom
 *
geo
 = &
c⁄f
->geo;

797 
	`øid10_föd_phys
(
c⁄f
, 
r10_bio
);

798 
	`rcu_ªad_lock
();

799 
ªåy
:

800 
£˘‹s
 = 
r10_bio
->sectors;

801 
be°_¶Ÿ
 = -1;

802 
be°_rdev
 = 
NULL
;

803 
be°_di°
 = 
MaxSe˘‹
;

804 
be°_good_£˘‹s
 = 0;

805 
do_bÆ™˚
 = 1;

812 i‡(
c⁄f
->
mddev
->
ªcovîy_˝
 < 
MaxSe˘‹


813 && (
this_£˘‹
 + 
£˘‹s
 >
c⁄f
->
√xt_ªsync
))

814 
do_bÆ™˚
 = 0;

816 
¶Ÿ
 = 0; slŸ < 
c⁄f
->
c›õs
 ; slot++) {

817 
£˘‹_t
 
fú°_bad
;

818 
bad_£˘‹s
;

819 
£˘‹_t
 
dev_£˘‹
;

821 i‡(
r10_bio
->
devs
[
¶Ÿ
].
bio
 =
IO_BLOCKED
)

823 
disk
 = 
r10_bio
->
devs
[
¶Ÿ
].
devnum
;

824 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
disk
].
ª∂a˚mít
);

825 i‡(
rdev
 =
NULL
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
) ||

826 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
) ||

827 
r10_bio
->
devs
[
¶Ÿ
].
addr
 + 
£˘‹s
 > 
rdev
->
ªcovîy_off£t
)

828 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
disk
].rdev);

829 i‡(
rdev
 =
NULL
 ||

830 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) ||

831 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
))

833 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

834 
r10_bio
->
devs
[
¶Ÿ
].
addr
 + 
£˘‹s
 > 
rdev
->
ªcovîy_off£t
)

837 
dev_£˘‹
 = 
r10_bio
->
devs
[
¶Ÿ
].
addr
;

838 i‡(
	`is_badblock
(
rdev
, 
dev_£˘‹
, 
£˘‹s
,

839 &
fú°_bad
, &
bad_£˘‹s
)) {

840 i‡(
be°_di°
 < 
MaxSe˘‹
)

843 i‡(
fú°_bad
 <
dev_£˘‹
) {

848 
bad_£˘‹s
 -(
dev_£˘‹
 - 
fú°_bad
);

849 i‡(!
do_bÆ™˚
 && 
£˘‹s
 > 
bad_£˘‹s
)

850 
£˘‹s
 = 
bad_£˘‹s
;

851 i‡(
be°_good_£˘‹s
 > 
£˘‹s
)

852 
be°_good_£˘‹s
 = 
£˘‹s
;

854 
£˘‹_t
 
good_£˘‹s
 =

855 
fú°_bad
 - 
dev_£˘‹
;

856 i‡(
good_£˘‹s
 > 
be°_good_£˘‹s
) {

857 
be°_good_£˘‹s
 = 
good_£˘‹s
;

858 
be°_¶Ÿ
 = 
¶Ÿ
;

859 
be°_rdev
 = 
rdev
;

861 i‡(!
do_bÆ™˚
)

867 
be°_good_£˘‹s
 = 
£˘‹s
;

869 i‡(!
do_bÆ™˚
)

876 i‡(
geo
->
√¨_c›õs
 > 1 && !
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
))

880 i‡(
geo
->
Ár_c›õs
 > 1)

881 
√w_di°™˚
 = 
r10_bio
->
devs
[
¶Ÿ
].
addr
;

883 
√w_di°™˚
 = 
	`abs
(
r10_bio
->
devs
[
¶Ÿ
].
addr
 -

884 
c⁄f
->
múr‹s
[
disk
].
hód_posôi⁄
);

885 i‡(
√w_di°™˚
 < 
be°_di°
) {

886 
be°_di°
 = 
√w_di°™˚
;

887 
be°_¶Ÿ
 = 
¶Ÿ
;

888 
be°_rdev
 = 
rdev
;

891 i‡(
¶Ÿ
 >
c⁄f
->
c›õs
) {

892 
¶Ÿ
 = 
be°_¶Ÿ
;

893 
rdev
 = 
be°_rdev
;

896 i‡(
¶Ÿ
 >= 0) {

897 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

898 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

902 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

903 
ªåy
;

905 
r10_bio
->
ªad_¶Ÿ
 = 
¶Ÿ
;

907 
rdev
 = 
NULL
;

908 
	`rcu_ªad_u∆ock
();

909 *
max_£˘‹s
 = 
be°_good_£˘‹s
;

911  
rdev
;

912 
	}
}

914 
	$md_øid10_c⁄ge°ed
(
mddev
 *mddev, 
bôs
)

916 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

917 
i
, 
ªt
 = 0;

919 i‡((
bôs
 & (1 << 
BDI_async_c⁄ge°ed
)) &&

920 
c⁄f
->
≥ndög_cou¡
 >
max_queued_ªque°s
)

923 
	`rcu_ªad_lock
();

924 
i
 = 0;

925 (
i
 < 
c⁄f
->
geo
.
øid_disks
 || i < c⁄f->
¥ev
.raid_disks)

926 && 
ªt
 == 0;

927 
i
++) {

928 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

929 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)) {

930 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

932 
ªt
 |
	`bdi_c⁄ge°ed
(&
q
->
backög_dev_öfo
, 
bôs
);

935 
	`rcu_ªad_u∆ock
();

936  
ªt
;

937 
	}
}

938 
EXPORT_SYMBOL_GPL
(
md_øid10_c⁄ge°ed
);

940 
	$øid10_c⁄ge°ed
(*
d©a
, 
bôs
)

942 
mddev
 *mddev = 
d©a
;

944  
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
) ||

945 
	`md_øid10_c⁄ge°ed
(
mddev
, 
bôs
);

946 
	}
}

948 
	$Êush_≥ndög_wrôes
(
r10c⁄f
 *
c⁄f
)

953 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

955 i‡(
c⁄f
->
≥ndög_bio_li°
.
hód
) {

956 
bio
 *bio;

957 
bio
 = 
	`bio_li°_gë
(&
c⁄f
->
≥ndög_bio_li°
);

958 
c⁄f
->
≥ndög_cou¡
 = 0;

959 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

962 
	`bôm≠_u≈lug
(
c⁄f
->
mddev
->
bôm≠
);

963 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

965 
bio
) {

966 
bio
 *
√xt
 = bio->
bi_√xt
;

967 
bio
->
bi_√xt
 = 
NULL
;

968 i‡(
	`u∆ikñy
((
bio
->
bi_rw
 & 
REQ_DISCARD
) &&

969 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
bio
->
bi_bdev
))))

971 
	`bio_ídio
(
bio
, 0);

973 
	`gíîic_make_ªque°
(
bio
);

974 
bio
 = 
√xt
;

977 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

978 
	}
}

1002 
	$øi£_b¨rõr
(
r10c⁄f
 *
c⁄f
, 
f‹˚
)

1004 
	`BUG_ON
(
f‹˚
 && !
c⁄f
->
b¨rõr
);

1005 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

1008 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
, 
f‹˚
 || !c⁄f->
ƒ_waôög
,

1009 
c⁄f
->
ªsync_lock
);

1012 
c⁄f
->
b¨rõr
++;

1015 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
,

1016 !
c⁄f
->
ƒ_≥ndög
 && c⁄f->
b¨rõr
 < 
RESYNC_DEPTH
,

1017 
c⁄f
->
ªsync_lock
);

1019 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

1020 
	}
}

1022 
	$lowî_b¨rõr
(
r10c⁄f
 *
c⁄f
)

1024 
Êags
;

1025 
	`•ö_lock_úqßve
(&
c⁄f
->
ªsync_lock
, 
Êags
);

1026 
c⁄f
->
b¨rõr
--;

1027 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
ªsync_lock
, 
Êags
);

1028 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1029 
	}
}

1031 
	$waô_b¨rõr
(
r10c⁄f
 *
c⁄f
)

1033 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

1034 i‡(
c⁄f
->
b¨rõr
) {

1035 
c⁄f
->
ƒ_waôög
++;

1045 
	`waô_evít_lock_úq
(
c⁄f
->
waô_b¨rõr
,

1046 !
c⁄f
->
b¨rõr
 ||

1047 (
c⁄f
->
ƒ_≥ndög
 &&

1048 
cuºít
->
bio_li°
 &&

1049 !
	`bio_li°_em±y
(
cuºít
->
bio_li°
)),

1050 
c⁄f
->
ªsync_lock
);

1051 
c⁄f
->
ƒ_waôög
--;

1053 
c⁄f
->
ƒ_≥ndög
++;

1054 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

1055 
	}
}

1057 
	$Ælow_b¨rõr
(
r10c⁄f
 *
c⁄f
)

1059 
Êags
;

1060 
	`•ö_lock_úqßve
(&
c⁄f
->
ªsync_lock
, 
Êags
);

1061 
c⁄f
->
ƒ_≥ndög
--;

1062 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
ªsync_lock
, 
Êags
);

1063 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1064 
	}
}

1066 
	$‰ìze_¨øy
(
r10c⁄f
 *
c⁄f
, 
exåa
)

1080 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

1081 
c⁄f
->
b¨rõr
++;

1082 
c⁄f
->
ƒ_waôög
++;

1083 
	`waô_evít_lock_úq_cmd
(
c⁄f
->
waô_b¨rõr
,

1084 
c⁄f
->
ƒ_≥ndög
 =c⁄f->
ƒ_queued
+
exåa
,

1085 
c⁄f
->
ªsync_lock
,

1086 
	`Êush_≥ndög_wrôes
(
c⁄f
));

1088 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

1089 
	}
}

1091 
	$un‰ìze_¨øy
(
r10c⁄f
 *
c⁄f
)

1094 
	`•ö_lock_úq
(&
c⁄f
->
ªsync_lock
);

1095 
c⁄f
->
b¨rõr
--;

1096 
c⁄f
->
ƒ_waôög
--;

1097 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1098 
	`•ö_u∆ock_úq
(&
c⁄f
->
ªsync_lock
);

1099 
	}
}

1101 
£˘‹_t
 
	$choo£_d©a_off£t
(
r10bio
 *
r10_bio
,

1102 
md_rdev
 *
rdev
)

1104 i‡(!
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
rdev
->
mddev
->
ªcovîy
) ||

1105 
	`ã°_bô
(
R10BIO_Pªvious
, &
r10_bio
->
°©e
))

1106  
rdev
->
d©a_off£t
;

1108  
rdev
->
√w_d©a_off£t
;

1109 
	}
}

1111 
	søid10_∂ug_cb
 {

1112 
blk_∂ug_cb
 
	mcb
;

1113 
bio_li°
 
	m≥ndög
;

1114 
	m≥ndög_˙t
;

1117 
	$øid10_u≈lug
(
blk_∂ug_cb
 *
cb
, 
boﬁ
 
‰om_scheduÀ
)

1119 
øid10_∂ug_cb
 *
∂ug
 = 
	`c⁄èöî_of
(
cb
, raid10_plug_cb,

1120 
cb
);

1121 
mddev
 *mddev = 
∂ug
->
cb
.
d©a
;

1122 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1123 
bio
 *bio;

1125 i‡(
‰om_scheduÀ
 || 
cuºít
->
bio_li°
) {

1126 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1127 
	`bio_li°_mîge
(&
c⁄f
->
≥ndög_bio_li°
, &
∂ug
->
≥ndög
);

1128 
c⁄f
->
≥ndög_cou¡
 +
∂ug
->
≥ndög_˙t
;

1129 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1130 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1131 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1132 
	`k‰ì
(
∂ug
);

1137 
bio
 = 
	`bio_li°_gë
(&
∂ug
->
≥ndög
);

1138 
	`bôm≠_u≈lug
(
mddev
->
bôm≠
);

1139 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1141 
bio
) {

1142 
bio
 *
√xt
 = bio->
bi_√xt
;

1143 
bio
->
bi_√xt
 = 
NULL
;

1144 i‡(
	`u∆ikñy
((
bio
->
bi_rw
 & 
REQ_DISCARD
) &&

1145 !
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
bio
->
bi_bdev
))))

1147 
	`bio_ídio
(
bio
, 0);

1149 
	`gíîic_make_ªque°
(
bio
);

1150 
bio
 = 
√xt
;

1152 
	`k‰ì
(
∂ug
);

1153 
	}
}

1155 
	$__make_ªque°
(
mddev
 *mddev, 
bio
 *bio)

1157 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1158 
r10bio
 *
r10_bio
;

1159 
bio
 *
ªad_bio
;

1160 
i
;

1161 c⁄° 
rw
 = 
	`bio_d©a_dú
(
bio
);

1162 c⁄° 
do_sync
 = (
bio
->
bi_rw
 & 
REQ_SYNC
);

1163 c⁄° 
do_fua
 = (
bio
->
bi_rw
 & 
REQ_FUA
);

1164 c⁄° 
do_disˇrd
 = (
bio
->
bi_rw


1165 & (
REQ_DISCARD
 | 
REQ_SECURE
));

1166 c⁄° 
do_ßme
 = (
bio
->
bi_rw
 & 
REQ_WRITE_SAME
);

1167 
Êags
;

1168 
md_rdev
 *
blocked_rdev
;

1169 
blk_∂ug_cb
 *
cb
;

1170 
øid10_∂ug_cb
 *
∂ug
 = 
NULL
;

1171 
£˘‹s_h™dÀd
;

1172 
max_£˘‹s
;

1173 
£˘‹s
;

1180 
	`waô_b¨rõr
(
c⁄f
);

1182 
£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

1183 
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
) &&

1184 
bio
->
bi_ôî
.
bi_£˘‹
 < 
c⁄f
->
ªsh≠e_¥ogªss
 &&

1185 
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s
 > 
c⁄f
->
ªsh≠e_¥ogªss
) {

1189 
	`Ælow_b¨rõr
(
c⁄f
);

1190 
	`waô_evít
(
c⁄f
->
waô_b¨rõr
,

1191 
c⁄f
->
ªsh≠e_¥ogªss
 <
bio
->
bi_ôî
.
bi_£˘‹
 ||

1192 
c⁄f
->
ªsh≠e_¥ogªss
 >
bio
->
bi_ôî
.
bi_£˘‹
 +

1193 
£˘‹s
);

1194 
	`waô_b¨rõr
(
c⁄f
);

1196 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
) &&

1197 
	`bio_d©a_dú
(
bio
Ë=
WRITE
 &&

1198 (
mddev
->
ªsh≠e_backw¨ds


1199 ? (
bio
->
bi_ôî
.
bi_£˘‹
 < 
c⁄f
->
ªsh≠e_ß„
 &&

1200 
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s
 > 
c⁄f
->
ªsh≠e_¥ogªss
)

1201 : (
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s
 > 
c⁄f
->
ªsh≠e_ß„
 &&

1202 
bio
->
bi_ôî
.
bi_£˘‹
 < 
c⁄f
->
ªsh≠e_¥ogªss
))) {

1204 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

1205 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

1206 
	`£t_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
);

1207 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1208 
	`waô_evít
(
mddev
->
sb_waô
,

1209 !
	`ã°_bô
(
MD_CHANGE_PENDING
, &
mddev
->
Êags
));

1211 
c⁄f
->
ªsh≠e_ß„
 = 
mddev
->
ªsh≠e_posôi⁄
;

1214 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10bio_poﬁ
, 
GFP_NOIO
);

1216 
r10_bio
->
ma°î_bio
 = 
bio
;

1217 
r10_bio
->
£˘‹s
 = sectors;

1219 
r10_bio
->
mddev
 = mddev;

1220 
r10_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
;

1221 
r10_bio
->
°©e
 = 0;

1230 
bio
->
bi_phys_£gmíts
 = 0;

1231 
	`˛ór_bô
(
BIO_SEG_VALID
, &
bio
->
bi_Êags
);

1233 i‡(
rw
 =
READ
) {

1237 
md_rdev
 *
rdev
;

1238 
¶Ÿ
;

1240 
ªad_agaö
:

1241 
rdev
 = 
	`ªad_bÆ™˚
(
c⁄f
, 
r10_bio
, &
max_£˘‹s
);

1242 i‡(!
rdev
) {

1243 
	`øid_íd_bio_io
(
r10_bio
);

1246 
¶Ÿ
 = 
r10_bio
->
ªad_¶Ÿ
;

1248 
ªad_bio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

1249 
	`bio_åim
(
ªad_bio
, 
r10_bio
->
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
,

1250 
max_£˘‹s
);

1252 
r10_bio
->
devs
[
¶Ÿ
].
bio
 = 
ªad_bio
;

1253 
r10_bio
->
devs
[
¶Ÿ
].
rdev
 =Ñdev;

1255 
ªad_bio
->
bi_ôî
.
bi_£˘‹
 = 
r10_bio
->
devs
[
¶Ÿ
].
addr
 +

1256 
	`choo£_d©a_off£t
(
r10_bio
, 
rdev
);

1257 
ªad_bio
->
bi_bdev
 = 
rdev
->
bdev
;

1258 
ªad_bio
->
bi_íd_io
 = 
øid10_íd_ªad_ªque°
;

1259 
ªad_bio
->
bi_rw
 = 
READ
 | 
do_sync
;

1260 
ªad_bio
->
bi_¥iv©e
 = 
r10_bio
;

1262 i‡(
max_£˘‹s
 < 
r10_bio
->
£˘‹s
) {

1266 
£˘‹s_h™dÀd
 = (
r10_bio
->
£˘‹
 + 
max_£˘‹s


1267 - 
bio
->
bi_ôî
.
bi_£˘‹
);

1268 
r10_bio
->
£˘‹s
 = 
max_£˘‹s
;

1269 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1270 i‡(
bio
->
bi_phys_£gmíts
 == 0)

1271 
bio
->
bi_phys_£gmíts
 = 2;

1273 
bio
->
bi_phys_£gmíts
++;

1274 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1280 
	`ªscheduÀ_ªåy
(
r10_bio
);

1282 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10bio_poﬁ
, 
GFP_NOIO
);

1284 
r10_bio
->
ma°î_bio
 = 
bio
;

1285 
r10_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
bio
Ë- 
£˘‹s_h™dÀd
;

1286 
r10_bio
->
°©e
 = 0;

1287 
r10_bio
->
mddev
 = mddev;

1288 
r10_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
 +

1289 
£˘‹s_h™dÀd
;

1290 
ªad_agaö
;

1292 
	`gíîic_make_ªque°
(
ªad_bio
);

1299 i‡(
c⁄f
->
≥ndög_cou¡
 >
max_queued_ªque°s
) {

1300 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1301 
	`waô_evít
(
c⁄f
->
waô_b¨rõr
,

1302 
c⁄f
->
≥ndög_cou¡
 < 
max_queued_ªque°s
);

1316 
r10_bio
->
ªad_¶Ÿ
 = -1;

1317 
	`øid10_föd_phys
(
c⁄f
, 
r10_bio
);

1318 
ªåy_wrôe
:

1319 
blocked_rdev
 = 
NULL
;

1320 
	`rcu_ªad_lock
();

1321 
max_£˘‹s
 = 
r10_bio
->
£˘‹s
;

1323 
i
 = 0; i < 
c⁄f
->
c›õs
; i++) {

1324 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

1325 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
d
].rdev);

1326 
md_rdev
 *
ºdev
 = 
	`rcu_dîe„ªn˚
(

1327 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
);

1328 i‡(
rdev
 =
ºdev
)

1329 
ºdev
 = 
NULL
;

1330 i‡(
rdev
 && 
	`u∆ikñy
(
	`ã°_bô
(
Blocked
, &rdev->
Êags
))) {

1331 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

1332 
blocked_rdev
 = 
rdev
;

1335 i‡(
ºdev
 && 
	`u∆ikñy
(
	`ã°_bô
(
Blocked
, &ºdev->
Êags
))) {

1336 
	`©omic_öc
(&
ºdev
->
ƒ_≥ndög
);

1337 
blocked_rdev
 = 
ºdev
;

1340 i‡(
rdev
 && (
	`ã°_bô
(
Fau…y
, &rdev->
Êags
)

1341 || 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
)))

1342 
rdev
 = 
NULL
;

1343 i‡(
ºdev
 && (
	`ã°_bô
(
Fau…y
, &ºdev->
Êags
)

1344 || 
	`ã°_bô
(
Unmîged
, &
ºdev
->
Êags
)))

1345 
ºdev
 = 
NULL
;

1347 
r10_bio
->
devs
[
i
].
bio
 = 
NULL
;

1348 
r10_bio
->
devs
[
i
].
ª∂_bio
 = 
NULL
;

1350 i‡(!
rdev
 && !
ºdev
) {

1351 
	`£t_bô
(
R10BIO_Degøded
, &
r10_bio
->
°©e
);

1354 i‡(
rdev
 && 
	`ã°_bô
(
WrôeEº‹Sìn
, &rdev->
Êags
)) {

1355 
£˘‹_t
 
fú°_bad
;

1356 
£˘‹_t
 
dev_£˘‹
 = 
r10_bio
->
devs
[
i
].
addr
;

1357 
bad_£˘‹s
;

1358 
is_bad
;

1360 
is_bad
 = 
	`is_badblock
(
rdev
, 
dev_£˘‹
,

1361 
max_£˘‹s
,

1362 &
fú°_bad
, &
bad_£˘‹s
);

1363 i‡(
is_bad
 < 0) {

1367 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

1368 
	`£t_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

1369 
blocked_rdev
 = 
rdev
;

1372 i‡(
is_bad
 && 
fú°_bad
 <
dev_£˘‹
) {

1374 
bad_£˘‹s
 -(
dev_£˘‹
 - 
fú°_bad
);

1375 i‡(
bad_£˘‹s
 < 
max_£˘‹s
)

1379 
max_£˘‹s
 = 
bad_£˘‹s
;

1390 i‡(
is_bad
) {

1391 
good_£˘‹s
 = 
fú°_bad
 - 
dev_£˘‹
;

1392 i‡(
good_£˘‹s
 < 
max_£˘‹s
)

1393 
max_£˘‹s
 = 
good_£˘‹s
;

1396 i‡(
rdev
) {

1397 
r10_bio
->
devs
[
i
].
bio
 = bio;

1398 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

1400 i‡(
ºdev
) {

1401 
r10_bio
->
devs
[
i
].
ª∂_bio
 = 
bio
;

1402 
	`©omic_öc
(&
ºdev
->
ƒ_≥ndög
);

1405 
	`rcu_ªad_u∆ock
();

1407 i‡(
	`u∆ikñy
(
blocked_rdev
)) {

1409 
j
;

1410 
d
;

1412 
j
 = 0; j < 
i
; j++) {

1413 i‡(
r10_bio
->
devs
[
j
].
bio
) {

1414 
d
 = 
r10_bio
->
devs
[
j
].
devnum
;

1415 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
d
].
rdev
, 
mddev
);

1417 i‡(
r10_bio
->
devs
[
j
].
ª∂_bio
) {

1418 
md_rdev
 *
rdev
;

1419 
d
 = 
r10_bio
->
devs
[
j
].
devnum
;

1420 
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

1421 i‡(!
rdev
) {

1423 
	`smp_mb
();

1424 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1426 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

1429 
	`Ælow_b¨rõr
(
c⁄f
);

1430 
	`md_waô_f‹_blocked_rdev
(
blocked_rdev
, 
mddev
);

1431 
	`waô_b¨rõr
(
c⁄f
);

1432 
ªåy_wrôe
;

1435 i‡(
max_£˘‹s
 < 
r10_bio
->
£˘‹s
) {

1439 
r10_bio
->
£˘‹s
 = 
max_£˘‹s
;

1440 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

1441 i‡(
bio
->
bi_phys_£gmíts
 == 0)

1442 
bio
->
bi_phys_£gmíts
 = 2;

1444 
bio
->
bi_phys_£gmíts
++;

1445 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

1447 
£˘‹s_h™dÀd
 = 
r10_bio
->
£˘‹
 + 
max_£˘‹s
 -

1448 
bio
->
bi_ôî
.
bi_£˘‹
;

1450 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 1);

1451 
	`bôm≠_°¨twrôe
(
mddev
->
bôm≠
, 
r10_bio
->
£˘‹
,Ñ10_bio->
£˘‹s
, 0);

1453 
i
 = 0; i < 
c⁄f
->
c›õs
; i++) {

1454 
bio
 *
mbio
;

1455 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

1456 i‡(
r10_bio
->
devs
[
i
].
bio
) {

1457 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1458 
mbio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

1459 
	`bio_åim
(
mbio
, 
r10_bio
->
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
,

1460 
max_£˘‹s
);

1461 
r10_bio
->
devs
[
i
].
bio
 = 
mbio
;

1463 
mbio
->
bi_ôî
.
bi_£˘‹
 = (
r10_bio
->
devs
[
i
].
addr
+

1464 
	`choo£_d©a_off£t
(
r10_bio
,

1465 
rdev
));

1466 
mbio
->
bi_bdev
 = 
rdev
->
bdev
;

1467 
mbio
->
bi_íd_io
 = 
øid10_íd_wrôe_ªque°
;

1468 
mbio
->
bi_rw
 =

1469 
WRITE
 | 
do_sync
 | 
do_fua
 | 
do_disˇrd
 | 
do_ßme
;

1470 
mbio
->
bi_¥iv©e
 = 
r10_bio
;

1472 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

1474 
cb
 = 
	`blk_check_∂ugged
(
øid10_u≈lug
, 
mddev
,

1475 (*
∂ug
));

1476 i‡(
cb
)

1477 
∂ug
 = 
	`c⁄èöî_of
(
cb
, 
øid10_∂ug_cb
,

1478 
cb
);

1480 
∂ug
 = 
NULL
;

1481 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1482 i‡(
∂ug
) {

1483 
	`bio_li°_add
(&
∂ug
->
≥ndög
, 
mbio
);

1484 
∂ug
->
≥ndög_˙t
++;

1486 
	`bio_li°_add
(&
c⁄f
->
≥ndög_bio_li°
, 
mbio
);

1487 
c⁄f
->
≥ndög_cou¡
++;

1489 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1490 i‡(!
∂ug
)

1491 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1494 i‡(
r10_bio
->
devs
[
i
].
ª∂_bio
) {

1495 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

1496 i‡(
rdev
 =
NULL
) {

1498 
	`smp_mb
();

1499 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

1501 
mbio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

1502 
	`bio_åim
(
mbio
, 
r10_bio
->
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
,

1503 
max_£˘‹s
);

1504 
r10_bio
->
devs
[
i
].
ª∂_bio
 = 
mbio
;

1506 
mbio
->
bi_ôî
.
bi_£˘‹
 = (
r10_bio
->
devs
[
i
].
addr
 +

1507 
	`choo£_d©a_off£t
(

1508 
r10_bio
, 
rdev
));

1509 
mbio
->
bi_bdev
 = 
rdev
->
bdev
;

1510 
mbio
->
bi_íd_io
 = 
øid10_íd_wrôe_ªque°
;

1511 
mbio
->
bi_rw
 =

1512 
WRITE
 | 
do_sync
 | 
do_fua
 | 
do_disˇrd
 | 
do_ßme
;

1513 
mbio
->
bi_¥iv©e
 = 
r10_bio
;

1515 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

1516 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1517 
	`bio_li°_add
(&
c⁄f
->
≥ndög_bio_li°
, 
mbio
);

1518 
c⁄f
->
≥ndög_cou¡
++;

1519 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1520 i‡(!
	`mddev_check_∂ugged
(
mddev
))

1521 
	`md_wakeup_thªad
(
mddev
->
thªad
);

1529 i‡(
£˘‹s_h™dÀd
 < 
	`bio_£˘‹s
(
bio
)) {

1530 
	`⁄e_wrôe_d⁄e
(
r10_bio
);

1534 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10bio_poﬁ
, 
GFP_NOIO
);

1536 
r10_bio
->
ma°î_bio
 = 
bio
;

1537 
r10_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
bio
Ë- 
£˘‹s_h™dÀd
;

1539 
r10_bio
->
mddev
 = mddev;

1540 
r10_bio
->
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s_h™dÀd
;

1541 
r10_bio
->
°©e
 = 0;

1542 
ªåy_wrôe
;

1544 
	`⁄e_wrôe_d⁄e
(
r10_bio
);

1545 
	}
}

1547 
	$make_ªque°
(
mddev
 *mddev, 
bio
 *bio)

1549 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1550 
£˘‹_t
 
chunk_mask
 = (
c⁄f
->
geo
.chunk_mask & c⁄f->
¥ev
.chunk_mask);

1551 
chunk_£˘s
 = 
chunk_mask
 + 1;

1553 
bio
 *
•lô
;

1555 i‡(
	`u∆ikñy
(
bio
->
bi_rw
 & 
REQ_FLUSH
)) {

1556 
	`md_Êush_ªque°
(
mddev
, 
bio
);

1560 
	`md_wrôe_°¨t
(
mddev
, 
bio
);

1569 i‡(
	`u∆ikñy
((
bio
->
bi_ôî
.
bi_£˘‹
 & 
chunk_mask
) +

1570 
	`bio_£˘‹s
(
bio
Ë> 
chunk_£˘s


1571 && (
c⁄f
->
geo
.
√¨_c›õs
 < c⁄f->geo.
øid_disks


1572 || 
c⁄f
->
¥ev
.
√¨_c›õs
 <

1573 
c⁄f
->
¥ev
.
øid_disks
))) {

1574 
•lô
 = 
	`bio_•lô
(
bio
, 
chunk_£˘s
 -

1575 (
bio
->
bi_ôî
.
bi_£˘‹
 &

1576 (
chunk_£˘s
 - 1)),

1577 
GFP_NOIO
, 
fs_bio_£t
);

1578 
	`bio_chaö
(
•lô
, 
bio
);

1580 
•lô
 = 
bio
;

1583 
	`__make_ªque°
(
mddev
, 
•lô
);

1584 } 
•lô
 !
bio
);

1587 
	`wake_up
(&
c⁄f
->
waô_b¨rõr
);

1588 
	}
}

1590 
	$°©us
(
£q_fûe
 *
£q
, 
mddev
 *mddev)

1592 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1593 
i
;

1595 i‡(
c⁄f
->
geo
.
√¨_c›õs
 < c⁄f->geo.
øid_disks
)

1596 
	`£q_¥ötf
(
£q
, " %dK chunks", 
mddev
->
chunk_£˘‹s
 / 2);

1597 i‡(
c⁄f
->
geo
.
√¨_c›õs
 > 1)

1598 
	`£q_¥ötf
(
£q
, " %dÇór-c›õs", 
c⁄f
->
geo
.
√¨_c›õs
);

1599 i‡(
c⁄f
->
geo
.
Ár_c›õs
 > 1) {

1600 i‡(
c⁄f
->
geo
.
Ár_off£t
)

1601 
	`£q_¥ötf
(
£q
, " %d off£t-c›õs", 
c⁄f
->
geo
.
Ár_c›õs
);

1603 
	`£q_¥ötf
(
£q
, " %d f¨-c›õs", 
c⁄f
->
geo
.
Ár_c›õs
);

1605 
	`£q_¥ötf
(
£q
, " [%d/%d] [", 
c⁄f
->
geo
.
øid_disks
,

1606 
c⁄f
->
geo
.
øid_disks
 - 
mddev
->
degøded
);

1607 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++)

1608 
	`£q_¥ötf
(
£q
, "%s",

1609 
c⁄f
->
múr‹s
[
i
].
rdev
 &&

1610 
	`ã°_bô
(
In_sync
, &
c⁄f
->
múr‹s
[
i
].
rdev
->
Êags
) ? "U" : "_");

1611 
	`£q_¥ötf
(
£q
, "]");

1612 
	}
}

1619 
	$_íough
(
r10c⁄f
 *
c⁄f
, 
¥evious
, 
ign‹e
)

1621 
fú°
 = 0;

1622 
has_íough
 = 0;

1623 
disks
, 
nc›õs
;

1624 i‡(
¥evious
) {

1625 
disks
 = 
c⁄f
->
¥ev
.
øid_disks
;

1626 
nc›õs
 = 
c⁄f
->
¥ev
.
√¨_c›õs
;

1628 
disks
 = 
c⁄f
->
geo
.
øid_disks
;

1629 
nc›õs
 = 
c⁄f
->
geo
.
√¨_c›õs
;

1632 
	`rcu_ªad_lock
();

1634 
n
 = 
c⁄f
->
c›õs
;

1635 
˙t
 = 0;

1636 
this
 = 
fú°
;

1637 
n
--) {

1638 
md_rdev
 *
rdev
;

1639 i‡(
this
 !
ign‹e
 &&

1640 (
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
this
].rdev)) &&

1641 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

1642 
˙t
++;

1643 
this
 = (this+1Ë% 
disks
;

1645 i‡(
˙t
 == 0)

1646 
out
;

1647 
fú°
 = (fú° + 
nc›õs
Ë% 
disks
;

1648 } 
fú°
 != 0);

1649 
has_íough
 = 1;

1650 
out
:

1651 
	`rcu_ªad_u∆ock
();

1652  
has_íough
;

1653 
	}
}

1655 
	$íough
(
r10c⁄f
 *
c⁄f
, 
ign‹e
)

1662  
	`_íough
(
c⁄f
, 0, 
ign‹e
) &&

1663 
	`_íough
(
c⁄f
, 1, 
ign‹e
);

1664 
	}
}

1666 
	$îr‹
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1668 
b
[
BDEVNAME_SIZE
];

1669 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1670 
Êags
;

1678 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1679 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

1680 && !
	`íough
(
c⁄f
, 
rdev
->
øid_disk
)) {

1684 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1687 i‡(
	`ã°_™d_˛ór_bô
(
In_sync
, &
rdev
->
Êags
))

1688 
mddev
->
degøded
++;

1692 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

1693 
	`£t_bô
(
Blocked
, &
rdev
->
Êags
);

1694 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

1695 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

1696 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1697 
	`¥ötk
(
KERN_ALERT


1700 
	`md«me
(
mddev
), 
	`bdev«me
(
rdev
->
bdev
, 
b
),

1701 
	`md«me
(
mddev
), 
c⁄f
->
geo
.
øid_disks
 - mddev->
degøded
);

1702 
	}
}

1704 
	$¥öt_c⁄f
(
r10c⁄f
 *
c⁄f
)

1706 
i
;

1707 
øid10_öfo
 *
tmp
;

1709 
	`¥ötk
(
KERN_DEBUG
 "RAID10 confÖrintout:\n");

1710 i‡(!
c⁄f
) {

1711 
	`¥ötk
(
KERN_DEBUG
 "(!conf)\n");

1714 
	`¥ötk
(
KERN_DEBUG
 " --- wd:%dÑd:%d\n", 
c⁄f
->
geo
.
øid_disks
 - c⁄f->
mddev
->
degøded
,

1715 
c⁄f
->
geo
.
øid_disks
);

1717 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++) {

1718 
b
[
BDEVNAME_SIZE
];

1719 
tmp
 = 
c⁄f
->
múr‹s
 + 
i
;

1720 i‡(
tmp
->
rdev
)

1721 
	`¥ötk
(
KERN_DEBUG
 " disk %d, wo:%d, o:%d, dev:%s\n",

1722 
i
, !
	`ã°_bô
(
In_sync
, &
tmp
->
rdev
->
Êags
),

1723 !
	`ã°_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
),

1724 
	`bdev«me
(
tmp
->
rdev
->
bdev
,
b
));

1726 
	}
}

1728 
	$˛o£_sync
(
r10c⁄f
 *
c⁄f
)

1730 
	`waô_b¨rõr
(
c⁄f
);

1731 
	`Ælow_b¨rõr
(
c⁄f
);

1733 
	`mempoﬁ_de°roy
(
c⁄f
->
r10buf_poﬁ
);

1734 
c⁄f
->
r10buf_poﬁ
 = 
NULL
;

1735 
	}
}

1737 
	$øid10_•¨e_a˘ive
(
mddev
 *mddev)

1739 
i
;

1740 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1741 
øid10_öfo
 *
tmp
;

1742 
cou¡
 = 0;

1743 
Êags
;

1749 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++) {

1750 
tmp
 = 
c⁄f
->
múr‹s
 + 
i
;

1751 i‡(
tmp
->
ª∂a˚mít


1752 && 
tmp
->
ª∂a˚mít
->
ªcovîy_off£t
 =
MaxSe˘‹


1753 && !
	`ã°_bô
(
Fau…y
, &
tmp
->
ª∂a˚mít
->
Êags
)

1754 && !
	`ã°_™d_£t_bô
(
In_sync
, &
tmp
->
ª∂a˚mít
->
Êags
)) {

1756 i‡(!
tmp
->
rdev


1757 || !
	`ã°_™d_˛ór_bô
(
In_sync
, &
tmp
->
rdev
->
Êags
))

1758 
cou¡
++;

1759 i‡(
tmp
->
rdev
) {

1764 
	`£t_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
);

1765 
	`sysfs_nŸify_dúít_ß„
(

1766 
tmp
->
rdev
->
sysfs_°©e
);

1768 
	`sysfs_nŸify_dúít_ß„
(
tmp
->
ª∂a˚mít
->
sysfs_°©e
);

1769 } i‡(
tmp
->
rdev


1770 && 
tmp
->
rdev
->
ªcovîy_off£t
 =
MaxSe˘‹


1771 && !
	`ã°_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
)

1772 && !
	`ã°_™d_£t_bô
(
In_sync
, &
tmp
->
rdev
->
Êags
)) {

1773 
cou¡
++;

1774 
	`sysfs_nŸify_dúít_ß„
(
tmp
->
rdev
->
sysfs_°©e
);

1777 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1778 
mddev
->
degøded
 -
cou¡
;

1779 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

1781 
	`¥öt_c⁄f
(
c⁄f
);

1782  
cou¡
;

1783 
	}
}

1786 
	$øid10_add_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1788 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1789 
îr
 = -
EEXIST
;

1790 
múr‹
;

1791 
fú°
 = 0;

1792 
œ°
 = 
c⁄f
->
geo
.
øid_disks
 - 1;

1793 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

1795 i‡(
mddev
->
ªcovîy_˝
 < 
MaxSe˘‹
)

1799  -
EBUSY
;

1800 i‡(
rdev
->
ßved_øid_disk
 < 0 && !
	`_íough
(
c⁄f
, 1, -1))

1801  -
EINVAL
;

1803 i‡(
rdev
->
øid_disk
 >= 0)

1804 
fú°
 = 
œ°
 = 
rdev
->
øid_disk
;

1806 i‡(
q
->
mîge_bvec_‚
) {

1807 
	`£t_bô
(
Unmîged
, &
rdev
->
Êags
);

1808 
mddev
->
mîge_check_√eded
 = 1;

1811 i‡(
rdev
->
ßved_øid_disk
 >
fú°
 &&

1812 
c⁄f
->
múr‹s
[
rdev
->
ßved_øid_disk
].rdev =
NULL
)

1813 
múr‹
 = 
rdev
->
ßved_øid_disk
;

1815 
múr‹
 = 
fú°
;

1816  ; 
múr‹
 <
œ°
 ; mirror++) {

1817 
øid10_öfo
 *
p
 = &
c⁄f
->
múr‹s
[
múr‹
];

1818 i‡(
p
->
ªcovîy_dißbÀd
 =
mddev
->recovery_disabled)

1820 i‡(
p
->
rdev
) {

1821 i‡(!
	`ã°_bô
(
W™tRïœ˚mít
, &
p
->
rdev
->
Êags
) ||

1822 
p
->
ª∂a˚mít
 !
NULL
)

1824 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

1825 
	`£t_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

1826 
rdev
->
øid_disk
 = 
múr‹
;

1827 
îr
 = 0;

1828 i‡(
mddev
->
gídisk
)

1829 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

1830 
rdev
->
d©a_off£t
 << 9);

1831 
c⁄f
->
fuŒsync
 = 1;

1832 
	`rcu_assign_poöãr
(
p
->
ª∂a˚mít
, 
rdev
);

1836 i‡(
mddev
->
gídisk
)

1837 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

1838 
rdev
->
d©a_off£t
 << 9);

1840 
p
->
hód_posôi⁄
 = 0;

1841 
p
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled - 1;

1842 
rdev
->
øid_disk
 = 
múr‹
;

1843 
îr
 = 0;

1844 i‡(
rdev
->
ßved_øid_disk
 !
múr‹
)

1845 
c⁄f
->
fuŒsync
 = 1;

1846 
	`rcu_assign_poöãr
(
p
->
rdev
,Ñdev);

1849 i‡(
îr
 =0 && 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
)) {

1857 
	`synchr⁄ize_sched
();

1858 
	`‰ìze_¨øy
(
c⁄f
, 0);

1859 
	`un‰ìze_¨øy
(
c⁄f
);

1860 
	`˛ór_bô
(
Unmîged
, &
rdev
->
Êags
);

1862 
	`md_öãgrôy_add_rdev
(
rdev
, 
mddev
);

1863 i‡(
mddev
->
queue
 && 
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)))

1864 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
mddev
->
queue
);

1866 
	`¥öt_c⁄f
(
c⁄f
);

1867  
îr
;

1868 
	}
}

1870 
	$øid10_ªmove_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

1872 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

1873 
îr
 = 0;

1874 
numbî
 = 
rdev
->
øid_disk
;

1875 
md_rdev
 **
rdevp
;

1876 
øid10_öfo
 *
p
 = 
c⁄f
->
múr‹s
 + 
numbî
;

1878 
	`¥öt_c⁄f
(
c⁄f
);

1879 i‡(
rdev
 =
p
->rdev)

1880 
rdevp
 = &
p
->
rdev
;

1881 i‡(
rdev
 =
p
->
ª∂a˚mít
)

1882 
rdevp
 = &
p
->
ª∂a˚mít
;

1886 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

1887 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

1888 
îr
 = -
EBUSY
;

1889 
ab‹t
;

1894 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

1895 
mddev
->
ªcovîy_dißbÀd
 !
p
->recovery_disabled &&

1896 (!
p
->
ª∂a˚mít
 ||Ö->ª∂a˚míà=
rdev
) &&

1897 
numbî
 < 
c⁄f
->
geo
.
øid_disks
 &&

1898 
	`íough
(
c⁄f
, -1)) {

1899 
îr
 = -
EBUSY
;

1900 
ab‹t
;

1902 *
rdevp
 = 
NULL
;

1903 
	`synchr⁄ize_rcu
();

1904 i‡(
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

1906 
îr
 = -
EBUSY
;

1907 *
rdevp
 = 
rdev
;

1908 
ab‹t
;

1909 } i‡(
p
->
ª∂a˚mít
) {

1911 
p
->
rdev
 =Ö->
ª∂a˚mít
;

1912 
	`˛ór_bô
(
Rïœ˚mít
, &
p
->
ª∂a˚mít
->
Êags
);

1913 
	`smp_mb
();

1916 
p
->
ª∂a˚mít
 = 
NULL
;

1917 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

1922 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

1924 
îr
 = 
	`md_öãgrôy_ªgi°î
(
mddev
);

1926 
ab‹t
:

1928 
	`¥öt_c⁄f
(
c⁄f
);

1929  
îr
;

1930 
	}
}

1933 
	$íd_sync_ªad
(
bio
 *bio, 
îr‹
)

1935 
r10bio
 *
r10_bio
 = 
bio
->
bi_¥iv©e
;

1936 
r10c⁄f
 *
c⁄f
 = 
r10_bio
->
mddev
->
¥iv©e
;

1937 
d
;

1939 i‡(
bio
 =
r10_bio
->
ma°î_bio
) {

1941 
d
 = 
r10_bio
->
ªad_¶Ÿ
;

1943 
d
 = 
	`föd_bio_disk
(
c⁄f
, 
r10_bio
, 
bio
, 
NULL
, NULL);

1945 i‡(
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
))

1946 
	`£t_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
);

1951 
	`©omic_add
(
r10_bio
->
£˘‹s
,

1952 &
c⁄f
->
múr‹s
[
d
].
rdev
->
c‹ª˘ed_îr‹s
);

1957 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
d
].
rdev
, c⁄f->
mddev
);

1958 i‡(
	`ã°_bô
(
R10BIO_IsRecovî
, &
r10_bio
->
°©e
) ||

1959 
	`©omic_dec_™d_ã°
(&
r10_bio
->
ªmaöög
)) {

1963 
	`ªscheduÀ_ªåy
(
r10_bio
);

1965 
	}
}

1967 
	$íd_sync_ªque°
(
r10bio
 *
r10_bio
)

1969 
mddev
 *mddev = 
r10_bio
->mddev;

1971 
	`©omic_dec_™d_ã°
(&
r10_bio
->
ªmaöög
)) {

1972 i‡(
r10_bio
->
ma°î_bio
 =
NULL
) {

1974 
£˘‹_t
 
s
 = 
r10_bio
->
£˘‹s
;

1975 i‡(
	`ã°_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
) ||

1976 
	`ã°_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
))

1977 
	`ªscheduÀ_ªåy
(
r10_bio
);

1979 
	`put_buf
(
r10_bio
);

1980 
	`md_d⁄e_sync
(
mddev
, 
s
, 1);

1983 
r10bio
 *
r10_bio2
 = (r10biÿ*)
r10_bio
->
ma°î_bio
;

1984 i‡(
	`ã°_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
) ||

1985 
	`ã°_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
))

1986 
	`ªscheduÀ_ªåy
(
r10_bio
);

1988 
	`put_buf
(
r10_bio
);

1989 
r10_bio
 = 
r10_bio2
;

1992 
	}
}

1994 
	$íd_sync_wrôe
(
bio
 *bio, 
îr‹
)

1996 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

1997 
r10bio
 *
r10_bio
 = 
bio
->
bi_¥iv©e
;

1998 
mddev
 *mddev = 
r10_bio
->mddev;

1999 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2000 
d
;

2001 
£˘‹_t
 
fú°_bad
;

2002 
bad_£˘‹s
;

2003 
¶Ÿ
;

2004 
ª∂
;

2005 
md_rdev
 *
rdev
 = 
NULL
;

2007 
d
 = 
	`föd_bio_disk
(
c⁄f
, 
r10_bio
, 
bio
, &
¶Ÿ
, &
ª∂
);

2008 i‡(
ª∂
)

2009 
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

2011 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

2013 i‡(!
u±od©e
) {

2014 i‡(
ª∂
)

2015 
	`md_îr‹
(
mddev
, 
rdev
);

2017 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2018 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
))

2019 
	`£t_bô
(
MD_RECOVERY_NEEDED
,

2020 &
rdev
->
mddev
->
ªcovîy
);

2021 
	`£t_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
);

2023 } i‡(
	`is_badblock
(
rdev
,

2024 
r10_bio
->
devs
[
¶Ÿ
].
addr
,

2025 
r10_bio
->
£˘‹s
,

2026 &
fú°_bad
, &
bad_£˘‹s
))

2027 
	`£t_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
);

2029 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

2031 
	`íd_sync_ªque°
(
r10_bio
);

2032 
	}
}

2050 
	$sync_ªque°_wrôe
(
mddev
 *mddev, 
r10bio
 *
r10_bio
)

2052 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2053 
i
, 
fú°
;

2054 
bio
 *
tbio
, *
fbio
;

2055 
v˙t
;

2057 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 1);

2060 
i
=0; i<
c⁄f
->
c›õs
; i++)

2061 i‡(
	`ã°_bô
(
BIO_UPTODATE
, &
r10_bio
->
devs
[
i
].
bio
->
bi_Êags
))

2064 i‡(
i
 =
c⁄f
->
c›õs
)

2065 
d⁄e
;

2067 
fú°
 = 
i
;

2068 
fbio
 = 
r10_bio
->
devs
[
i
].
bio
;

2070 
v˙t
 = (
r10_bio
->
£˘‹s
 + (
PAGE_SIZE
 >> 9Ë- 1Ë>> (
PAGE_SHIFT
 - 9);

2072 
i
=0 ; i < 
c⁄f
->
c›õs
 ; i++) {

2073 
j
, 
d
;

2075 
tbio
 = 
r10_bio
->
devs
[
i
].
bio
;

2077 i‡(
tbio
->
bi_íd_io
 !
íd_sync_ªad
)

2079 i‡(
i
 =
fú°
)

2081 i‡(
	`ã°_bô
(
BIO_UPTODATE
, &
r10_bio
->
devs
[
i
].
bio
->
bi_Êags
)) {

2086 
£˘‹s
 = 
r10_bio
->sectors;

2087 
j
 = 0; j < 
v˙t
; j++) {

2088 
Àn
 = 
PAGE_SIZE
;

2089 i‡(
£˘‹s
 < (
Àn
 / 512))

2090 
Àn
 = 
£˘‹s
 * 512;

2091 i‡(
	`memcmp
(
	`∑ge_addªss
(
fbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2092 
	`∑ge_addªss
(
tbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2093 
Àn
))

2095 
£˘‹s
 -
Àn
/512;

2097 i‡(
j
 =
v˙t
)

2099 
	`©omic64_add
(
r10_bio
->
£˘‹s
, &
mddev
->
ªsync_mism©ches
);

2100 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
))

2109 
	`bio_ª£t
(
tbio
);

2111 
tbio
->
bi_v˙t
 = 
v˙t
;

2112 
tbio
->
bi_ôî
.
bi_size
 = 
r10_bio
->
£˘‹s
 << 9;

2113 
tbio
->
bi_rw
 = 
WRITE
;

2114 
tbio
->
bi_¥iv©e
 = 
r10_bio
;

2115 
tbio
->
bi_ôî
.
bi_£˘‹
 = 
r10_bio
->
devs
[
i
].
addr
;

2117 
j
=0; j < 
v˙t
 ; j++) {

2118 
tbio
->
bi_io_vec
[
j
].
bv_off£t
 = 0;

2119 
tbio
->
bi_io_vec
[
j
].
bv_Àn
 = 
PAGE_SIZE
;

2121 
	`mem˝y
(
	`∑ge_addªss
(
tbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2122 
	`∑ge_addªss
(
fbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2123 
PAGE_SIZE
);

2125 
tbio
->
bi_íd_io
 = 
íd_sync_wrôe
;

2127 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

2128 
	`©omic_öc
(&
c⁄f
->
múr‹s
[
d
].
rdev
->
ƒ_≥ndög
);

2129 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

2130 
	`md_sync_ac˘
(
c⁄f
->
múr‹s
[
d
].
rdev
->
bdev
, 
	`bio_£˘‹s
(
tbio
));

2132 
tbio
->
bi_ôî
.
bi_£˘‹
 +
c⁄f
->
múr‹s
[
d
].
rdev
->
d©a_off£t
;

2133 
tbio
->
bi_bdev
 = 
c⁄f
->
múr‹s
[
d
].
rdev
->
bdev
;

2134 
	`gíîic_make_ªque°
(
tbio
);

2140 
i
 = 0; i < 
c⁄f
->
c›õs
; i++) {

2141 
j
, 
d
;

2143 
tbio
 = 
r10_bio
->
devs
[
i
].
ª∂_bio
;

2144 i‡(!
tbio
 || !tbio->
bi_íd_io
)

2146 i‡(
r10_bio
->
devs
[
i
].
bio
->
bi_íd_io
 !
íd_sync_wrôe


2147 && 
r10_bio
->
devs
[
i
].
bio
 !
fbio
)

2148 
j
 = 0; j < 
v˙t
; j++)

2149 
	`mem˝y
(
	`∑ge_addªss
(
tbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2150 
	`∑ge_addªss
(
fbio
->
bi_io_vec
[
j
].
bv_∑ge
),

2151 
PAGE_SIZE
);

2152 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

2153 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

2154 
	`md_sync_ac˘
(
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
bdev
,

2155 
	`bio_£˘‹s
(
tbio
));

2156 
	`gíîic_make_ªque°
(
tbio
);

2159 
d⁄e
:

2160 i‡(
	`©omic_dec_™d_ã°
(&
r10_bio
->
ªmaöög
)) {

2161 
	`md_d⁄e_sync
(
mddev
, 
r10_bio
->
£˘‹s
, 1);

2162 
	`put_buf
(
r10_bio
);

2164 
	}
}

2176 
	$fix_ªcovîy_ªad_îr‹
(
r10bio
 *
r10_bio
)

2185 
mddev
 *mddev = 
r10_bio
->mddev;

2186 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2187 
bio
 *biÿ
r10_bio
->
devs
[0].bio;

2188 
£˘‹_t
 
£˘
 = 0;

2189 
£˘‹s
 = 
r10_bio
->sectors;

2190 
idx
 = 0;

2191 
dr
 = 
r10_bio
->
devs
[0].
devnum
;

2192 
dw
 = 
r10_bio
->
devs
[1].
devnum
;

2194 
£˘‹s
) {

2195 
s
 = 
£˘‹s
;

2196 
md_rdev
 *
rdev
;

2197 
£˘‹_t
 
addr
;

2198 
ok
;

2200 i‡(
s
 > (
PAGE_SIZE
>>9))

2201 
s
 = 
PAGE_SIZE
 >> 9;

2203 
rdev
 = 
c⁄f
->
múr‹s
[
dr
].rdev;

2204 
addr
 = 
r10_bio
->
devs
[0].add∏+ 
£˘
,

2205 
ok
 = 
	`sync_∑ge_io
(
rdev
,

2206 
addr
,

2207 
s
 << 9,

2208 
bio
->
bi_io_vec
[
idx
].
bv_∑ge
,

2209 
READ
, 
Ál£
);

2210 i‡(
ok
) {

2211 
rdev
 = 
c⁄f
->
múr‹s
[
dw
].rdev;

2212 
addr
 = 
r10_bio
->
devs
[1].add∏+ 
£˘
;

2213 
ok
 = 
	`sync_∑ge_io
(
rdev
,

2214 
addr
,

2215 
s
 << 9,

2216 
bio
->
bi_io_vec
[
idx
].
bv_∑ge
,

2217 
WRITE
, 
Ál£
);

2218 i‡(!
ok
) {

2219 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2220 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
,

2221 &
rdev
->
Êags
))

2222 
	`£t_bô
(
MD_RECOVERY_NEEDED
,

2223 &
rdev
->
mddev
->
ªcovîy
);

2226 i‡(!
ok
) {

2231 
	`rdev_£t_badblocks
(
rdev
, 
addr
, 
s
, 0);

2233 i‡(
rdev
 !
c⁄f
->
múr‹s
[
dw
].rdev) {

2235 
md_rdev
 *
rdev2
 = 
c⁄f
->
múr‹s
[
dw
].
rdev
;

2236 
addr
 = 
r10_bio
->
devs
[1].add∏+ 
£˘
;

2237 
ok
 = 
	`rdev_£t_badblocks
(
rdev2
, 
addr
, 
s
, 0);

2238 i‡(!
ok
) {

2240 
	`¥ötk
(
KERN_NOTICE


2243 
	`md«me
(
mddev
));

2245 
c⁄f
->
múr‹s
[
dw
].
ªcovîy_dißbÀd


2246 
mddev
->
ªcovîy_dißbÀd
;

2247 
	`£t_bô
(
MD_RECOVERY_INTR
,

2248 &
mddev
->
ªcovîy
);

2254 
£˘‹s
 -
s
;

2255 
£˘
 +
s
;

2256 
idx
++;

2258 
	}
}

2260 
	$ªcovîy_ªque°_wrôe
(
mddev
 *mddev, 
r10bio
 *
r10_bio
)

2262 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2263 
d
;

2264 
bio
 *
wbio
, *
wbio2
;

2266 i‡(!
	`ã°_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
)) {

2267 
	`fix_ªcovîy_ªad_îr‹
(
r10_bio
);

2268 
	`íd_sync_ªque°
(
r10_bio
);

2276 
d
 = 
r10_bio
->
devs
[1].
devnum
;

2277 
wbio
 = 
r10_bio
->
devs
[1].
bio
;

2278 
wbio2
 = 
r10_bio
->
devs
[1].
ª∂_bio
;

2283 i‡(
wbio2
 && !wbio2->
bi_íd_io
)

2284 
wbio2
 = 
NULL
;

2285 i‡(
wbio
->
bi_íd_io
) {

2286 
	`©omic_öc
(&
c⁄f
->
múr‹s
[
d
].
rdev
->
ƒ_≥ndög
);

2287 
	`md_sync_ac˘
(
c⁄f
->
múr‹s
[
d
].
rdev
->
bdev
, 
	`bio_£˘‹s
(
wbio
));

2288 
	`gíîic_make_ªque°
(
wbio
);

2290 i‡(
wbio2
) {

2291 
	`©omic_öc
(&
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
ƒ_≥ndög
);

2292 
	`md_sync_ac˘
(
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
bdev
,

2293 
	`bio_£˘‹s
(
wbio2
));

2294 
	`gíîic_make_ªque°
(
wbio2
);

2296 
	}
}

2305 
	$check_deˇy_ªad_îr‹s
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

2307 
time•ec
 
cur_time_m⁄
;

2308 
hours_sö˚_œ°
;

2309 
ªad_îr‹s
 = 
	`©omic_ªad
(&
rdev
->read_errors);

2311 
	`ktime_gë_ts
(&
cur_time_m⁄
);

2313 i‡(
rdev
->
œ°_ªad_îr‹
.
tv_£c
 == 0 &&

2314 
rdev
->
œ°_ªad_îr‹
.
tv_n£c
 == 0) {

2316 
rdev
->
œ°_ªad_îr‹
 = 
cur_time_m⁄
;

2320 
hours_sö˚_œ°
 = (
cur_time_m⁄
.
tv_£c
 -

2321 
rdev
->
œ°_ªad_îr‹
.
tv_£c
) / 3600;

2323 
rdev
->
œ°_ªad_îr‹
 = 
cur_time_m⁄
;

2330 i‡(
hours_sö˚_œ°
 >8 * (
ªad_îr‹s
))

2331 
	`©omic_£t
(&
rdev
->
ªad_îr‹s
, 0);

2333 
	`©omic_£t
(&
rdev
->
ªad_îr‹s
,Ñód_îr‹†>> 
hours_sö˚_œ°
);

2334 
	}
}

2336 
	$r10_sync_∑ge_io
(
md_rdev
 *
rdev
, 
£˘‹_t
 
£˘‹
,

2337 
£˘‹s
, 
∑ge
 *∑ge, 
rw
)

2339 
£˘‹_t
 
fú°_bad
;

2340 
bad_£˘‹s
;

2342 i‡(
	`is_badblock
(
rdev
, 
£˘‹
, 
£˘‹s
, &
fú°_bad
, &
bad_£˘‹s
)

2343 && (
rw
 =
READ
 || 
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
)))

2345 i‡(
	`sync_∑ge_io
(
rdev
, 
£˘‹
, 
£˘‹s
 << 9, 
∑ge
, 
rw
, 
Ál£
))

2348 i‡(
rw
 =
WRITE
) {

2349 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2350 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
))

2351 
	`£t_bô
(
MD_RECOVERY_NEEDED
,

2352 &
rdev
->
mddev
->
ªcovîy
);

2355 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
£˘‹
, 
£˘‹s
, 0))

2356 
	`md_îr‹
(
rdev
->
mddev
,Ñdev);

2358 
	}
}

2368 
	$fix_ªad_îr‹
(
r10c⁄f
 *
c⁄f
, 
mddev
 *mddev, 
r10bio
 *
r10_bio
)

2370 
£˘
 = 0;

2371 
£˘‹s
 = 
r10_bio
->sectors;

2372 
md_rdev
*
rdev
;

2373 
max_ªad_îr‹s
 = 
	`©omic_ªad
(&
mddev
->
max_c‹r_ªad_îr‹s
);

2374 
d
 = 
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
devnum
;

2379 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

2381 i‡(
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

2386 
	`check_deˇy_ªad_îr‹s
(
mddev
, 
rdev
);

2387 
	`©omic_öc
(&
rdev
->
ªad_îr‹s
);

2388 i‡(
	`©omic_ªad
(&
rdev
->
ªad_îr‹s
Ë> 
max_ªad_îr‹s
) {

2389 
b
[
BDEVNAME_SIZE
];

2390 
	`bdev«me
(
rdev
->
bdev
, 
b
);

2392 
	`¥ötk
(
KERN_NOTICE


2395 
	`md«me
(
mddev
), 
b
,

2396 
	`©omic_ªad
(&
rdev
->
ªad_îr‹s
), 
max_ªad_îr‹s
);

2397 
	`¥ötk
(
KERN_NOTICE


2399 
	`md«me
(
mddev
), 
b
);

2400 
	`md_îr‹
(
mddev
, 
c⁄f
->
múr‹s
[
d
].
rdev
);

2401 
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
bio
 = 
IO_BLOCKED
;

2405 
£˘‹s
) {

2406 
s
 = 
£˘‹s
;

2407 
¶
 = 
r10_bio
->
ªad_¶Ÿ
;

2408 
suc˚ss
 = 0;

2409 
°¨t
;

2411 i‡(
s
 > (
PAGE_SIZE
>>9))

2412 
s
 = 
PAGE_SIZE
 >> 9;

2414 
	`rcu_ªad_lock
();

2416 
£˘‹_t
 
fú°_bad
;

2417 
bad_£˘‹s
;

2419 
d
 = 
r10_bio
->
devs
[
¶
].
devnum
;

2420 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
d
].rdev);

2421 i‡(
rdev
 &&

2422 !
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
) &&

2423 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) &&

2424 
	`is_badblock
(
rdev
, 
r10_bio
->
devs
[
¶
].
addr
 + 
£˘
, 
s
,

2425 &
fú°_bad
, &
bad_£˘‹s
) == 0) {

2426 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

2427 
	`rcu_ªad_u∆ock
();

2428 
suc˚ss
 = 
	`sync_∑ge_io
(
rdev
,

2429 
r10_bio
->
devs
[
¶
].
addr
 +

2430 
£˘
,

2431 
s
<<9,

2432 
c⁄f
->
tmµage
, 
READ
, 
Ál£
);

2433 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

2434 
	`rcu_ªad_lock
();

2435 i‡(
suc˚ss
)

2438 
¶
++;

2439 i‡(
¶
 =
c⁄f
->
c›õs
)

2440 
¶
 = 0;

2441 } !
suc˚ss
 && 
¶
 !
r10_bio
->
ªad_¶Ÿ
);

2442 
	`rcu_ªad_u∆ock
();

2444 i‡(!
suc˚ss
) {

2449 
dn
 = 
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
devnum
;

2450 
rdev
 = 
c⁄f
->
múr‹s
[
dn
].rdev;

2452 i‡(!
	`rdev_£t_badblocks
(

2453 
rdev
,

2454 
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
addr


2455 + 
£˘
,

2456 
s
, 0)) {

2457 
	`md_îr‹
(
mddev
, 
rdev
);

2458 
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
bio


2459 
IO_BLOCKED
;

2464 
°¨t
 = 
¶
;

2466 
	`rcu_ªad_lock
();

2467 
¶
 !
r10_bio
->
ªad_¶Ÿ
) {

2468 
b
[
BDEVNAME_SIZE
];

2470 i‡(
¶
==0)

2471 
¶
 = 
c⁄f
->
c›õs
;

2472 
¶
--;

2473 
d
 = 
r10_bio
->
devs
[
¶
].
devnum
;

2474 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
d
].rdev);

2475 i‡(!
rdev
 ||

2476 
	`ã°_bô
(
Unmîged
, &
rdev
->
Êags
) ||

2477 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

2480 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

2481 
	`rcu_ªad_u∆ock
();

2482 i‡(
	`r10_sync_∑ge_io
(
rdev
,

2483 
r10_bio
->
devs
[
¶
].
addr
 +

2484 
£˘
,

2485 
s
, 
c⁄f
->
tmµage
, 
WRITE
)

2488 
	`¥ötk
(
KERN_NOTICE


2492 
	`md«me
(
mddev
), 
s
,

2494 
£˘
 +

2495 
	`choo£_d©a_off£t
(
r10_bio
,

2496 
rdev
)),

2497 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2498 
	`¥ötk
(
KERN_NOTICE
 "md/raid10:%s: %s: failing "

2500 
	`md«me
(
mddev
),

2501 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2503 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

2504 
	`rcu_ªad_lock
();

2506 
¶
 = 
°¨t
;

2507 
¶
 !
r10_bio
->
ªad_¶Ÿ
) {

2508 
b
[
BDEVNAME_SIZE
];

2510 i‡(
¶
==0)

2511 
¶
 = 
c⁄f
->
c›õs
;

2512 
¶
--;

2513 
d
 = 
r10_bio
->
devs
[
¶
].
devnum
;

2514 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
d
].rdev);

2515 i‡(!
rdev
 ||

2516 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

2519 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

2520 
	`rcu_ªad_u∆ock
();

2521 
	`r10_sync_∑ge_io
(
rdev
,

2522 
r10_bio
->
devs
[
¶
].
addr
 +

2523 
£˘
,

2524 
s
, 
c⁄f
->
tmµage
,

2525 
READ
)) {

2528 
	`¥ötk
(
KERN_NOTICE


2532 
	`md«me
(
mddev
), 
s
,

2534 
£˘
 +

2535 
	`choo£_d©a_off£t
(
r10_bio
, 
rdev
)),

2536 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2537 
	`¥ötk
(
KERN_NOTICE
 "md/raid10:%s: %s: failing "

2539 
	`md«me
(
mddev
),

2540 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2543 
	`¥ötk
(
KERN_INFO


2546 
	`md«me
(
mddev
), 
s
,

2548 
£˘
 +

2549 
	`choo£_d©a_off£t
(
r10_bio
, 
rdev
)),

2550 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2551 
	`©omic_add
(
s
, &
rdev
->
c‹ª˘ed_îr‹s
);

2554 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

2555 
	`rcu_ªad_lock
();

2557 
	`rcu_ªad_u∆ock
();

2559 
£˘‹s
 -
s
;

2560 
£˘
 +
s
;

2562 
	}
}

2564 
	$«ºow_wrôe_îr‹
(
r10bio
 *
r10_bio
, 
i
)

2566 
bio
 *biÿ
r10_bio
->
ma°î_bio
;

2567 
mddev
 *mddev = 
r10_bio
->mddev;

2568 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2569 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
r10_bio
->
devs
[
i
].
devnum
].rdev;

2581 
block_£˘‹s
;

2582 
£˘‹_t
 
£˘‹
;

2583 
£˘‹s
;

2584 
£˘_to_wrôe
 = 
r10_bio
->
£˘‹s
;

2585 
ok
 = 1;

2587 i‡(
rdev
->
badblocks
.
shi·
 < 0)

2590 
block_£˘‹s
 = 1 << 
rdev
->
badblocks
.
shi·
;

2591 
£˘‹
 = 
r10_bio
->sector;

2592 
£˘‹s
 = ((
r10_bio
->
£˘‹
 + 
block_£˘‹s
)

2593 & ~(
£˘‹_t
)(
block_£˘‹s
 - 1))

2594 - 
£˘‹
;

2596 
£˘_to_wrôe
) {

2597 
bio
 *
wbio
;

2598 i‡(
£˘‹s
 > 
£˘_to_wrôe
)

2599 
£˘‹s
 = 
£˘_to_wrôe
;

2601 
wbio
 = 
	`bio_˛⁄e_mddev
(
bio
, 
GFP_NOIO
, 
mddev
);

2602 
	`bio_åim
(
wbio
, 
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
, 
£˘‹s
);

2603 
wbio
->
bi_ôî
.
bi_£˘‹
 = (
r10_bio
->
devs
[
i
].
addr
+

2604 
	`choo£_d©a_off£t
(
r10_bio
, 
rdev
) +

2605 (
£˘‹
 - 
r10_bio
->sector));

2606 
wbio
->
bi_bdev
 = 
rdev
->
bdev
;

2607 i‡(
	`submô_bio_waô
(
WRITE
, 
wbio
) == 0)

2609 
ok
 = 
	`rdev_£t_badblocks
(
rdev
, 
£˘‹
,

2610 
£˘‹s
, 0)

2611 && 
ok
;

2613 
	`bio_put
(
wbio
);

2614 
£˘_to_wrôe
 -
£˘‹s
;

2615 
£˘‹
 +
£˘‹s
;

2616 
£˘‹s
 = 
block_£˘‹s
;

2618  
ok
;

2619 
	}
}

2621 
	$h™dÀ_ªad_îr‹
(
mddev
 *mddev, 
r10bio
 *
r10_bio
)

2623 
¶Ÿ
 = 
r10_bio
->
ªad_¶Ÿ
;

2624 
bio
 *bio;

2625 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2626 
md_rdev
 *
rdev
 = 
r10_bio
->
devs
[
¶Ÿ
].rdev;

2627 
b
[
BDEVNAME_SIZE
];

2628 
do_sync
;

2629 
max_£˘‹s
;

2639 
bio
 = 
r10_bio
->
devs
[
¶Ÿ
].bio;

2640 
	`bdev«me
(
bio
->
bi_bdev
, 
b
);

2641 
	`bio_put
(
bio
);

2642 
r10_bio
->
devs
[
¶Ÿ
].
bio
 = 
NULL
;

2644 i‡(
mddev
->
ro
 == 0) {

2645 
	`‰ìze_¨øy
(
c⁄f
, 1);

2646 
	`fix_ªad_îr‹
(
c⁄f
, 
mddev
, 
r10_bio
);

2647 
	`un‰ìze_¨øy
(
c⁄f
);

2649 
r10_bio
->
devs
[
¶Ÿ
].
bio
 = 
IO_BLOCKED
;

2651 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

2653 
ªad_m‹e
:

2654 
rdev
 = 
	`ªad_bÆ™˚
(
c⁄f
, 
r10_bio
, &
max_£˘‹s
);

2655 i‡(
rdev
 =
NULL
) {

2656 
	`¥ötk
(
KERN_ALERT
 "md/raid10:%s: %s: unrecoverable I/O"

2658 
	`md«me
(
mddev
), 
b
,

2659 ()
r10_bio
->
£˘‹
);

2660 
	`øid_íd_bio_io
(
r10_bio
);

2664 
do_sync
 = (
r10_bio
->
ma°î_bio
->
bi_rw
 & 
REQ_SYNC
);

2665 
¶Ÿ
 = 
r10_bio
->
ªad_¶Ÿ
;

2666 
	`¥ötk_øãlimôed
(

2667 
KERN_ERR


2670 
	`md«me
(
mddev
),

2671 
	`bdev«me
(
rdev
->
bdev
, 
b
),

2672 ()
r10_bio
->
£˘‹
);

2673 
bio
 = 
	`bio_˛⁄e_mddev
(
r10_bio
->
ma°î_bio
,

2674 
GFP_NOIO
, 
mddev
);

2675 
	`bio_åim
(
bio
, 
r10_bio
->
£˘‹
 - bio->
bi_ôî
.
bi_£˘‹
, 
max_£˘‹s
);

2676 
r10_bio
->
devs
[
¶Ÿ
].
bio
 = bio;

2677 
r10_bio
->
devs
[
¶Ÿ
].
rdev
 =Ñdev;

2678 
bio
->
bi_ôî
.
bi_£˘‹
 = 
r10_bio
->
devs
[
¶Ÿ
].
addr


2679 + 
	`choo£_d©a_off£t
(
r10_bio
, 
rdev
);

2680 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

2681 
bio
->
bi_rw
 = 
READ
 | 
do_sync
;

2682 
bio
->
bi_¥iv©e
 = 
r10_bio
;

2683 
bio
->
bi_íd_io
 = 
øid10_íd_ªad_ªque°
;

2684 i‡(
max_£˘‹s
 < 
r10_bio
->
£˘‹s
) {

2686 
bio
 *
mbio
 = 
r10_bio
->
ma°î_bio
;

2687 
£˘‹s_h™dÀd
 =

2688 
r10_bio
->
£˘‹
 + 
max_£˘‹s


2689 - 
mbio
->
bi_ôî
.
bi_£˘‹
;

2690 
r10_bio
->
£˘‹s
 = 
max_£˘‹s
;

2691 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

2692 i‡(
mbio
->
bi_phys_£gmíts
 == 0)

2693 
mbio
->
bi_phys_£gmíts
 = 2;

2695 
mbio
->
bi_phys_£gmíts
++;

2696 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

2697 
	`gíîic_make_ªque°
(
bio
);

2699 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10bio_poﬁ
,

2700 
GFP_NOIO
);

2701 
r10_bio
->
ma°î_bio
 = 
mbio
;

2702 
r10_bio
->
£˘‹s
 = 
	`bio_£˘‹s
(
mbio
Ë- 
£˘‹s_h™dÀd
;

2703 
r10_bio
->
°©e
 = 0;

2704 
	`£t_bô
(
R10BIO_RódEº‹
,

2705 &
r10_bio
->
°©e
);

2706 
r10_bio
->
mddev
 = mddev;

2707 
r10_bio
->
£˘‹
 = 
mbio
->
bi_ôî
.
bi_£˘‹


2708 + 
£˘‹s_h™dÀd
;

2710 
ªad_m‹e
;

2712 
	`gíîic_make_ªque°
(
bio
);

2713 
	}
}

2715 
	$h™dÀ_wrôe_com∂ëed
(
r10c⁄f
 *
c⁄f
, 
r10bio
 *
r10_bio
)

2723 
m
;

2724 
md_rdev
 *
rdev
;

2726 i‡(
	`ã°_bô
(
R10BIO_IsSync
, &
r10_bio
->
°©e
) ||

2727 
	`ã°_bô
(
R10BIO_IsRecovî
, &
r10_bio
->
°©e
)) {

2728 
m
 = 0; m < 
c⁄f
->
c›õs
; m++) {

2729 
dev
 = 
r10_bio
->
devs
[
m
].
devnum
;

2730 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].rdev;

2731 i‡(
r10_bio
->
devs
[
m
].
bio
 =
NULL
)

2733 i‡(
	`ã°_bô
(
BIO_UPTODATE
,

2734 &
r10_bio
->
devs
[
m
].
bio
->
bi_Êags
)) {

2735 
	`rdev_˛ór_badblocks
(

2736 
rdev
,

2737 
r10_bio
->
devs
[
m
].
addr
,

2738 
r10_bio
->
£˘‹s
, 0);

2740 i‡(!
	`rdev_£t_badblocks
(

2741 
rdev
,

2742 
r10_bio
->
devs
[
m
].
addr
,

2743 
r10_bio
->
£˘‹s
, 0))

2744 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2746 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].
ª∂a˚mít
;

2747 i‡(
r10_bio
->
devs
[
m
].
ª∂_bio
 =
NULL
)

2749 i‡(
	`ã°_bô
(
BIO_UPTODATE
,

2750 &
r10_bio
->
devs
[
m
].
ª∂_bio
->
bi_Êags
)) {

2751 
	`rdev_˛ór_badblocks
(

2752 
rdev
,

2753 
r10_bio
->
devs
[
m
].
addr
,

2754 
r10_bio
->
£˘‹s
, 0);

2756 i‡(!
	`rdev_£t_badblocks
(

2757 
rdev
,

2758 
r10_bio
->
devs
[
m
].
addr
,

2759 
r10_bio
->
£˘‹s
, 0))

2760 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2763 
	`put_buf
(
r10_bio
);

2765 
m
 = 0; m < 
c⁄f
->
c›õs
; m++) {

2766 
dev
 = 
r10_bio
->
devs
[
m
].
devnum
;

2767 
bio
 *biÿ
r10_bio
->
devs
[
m
].bio;

2768 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].rdev;

2769 i‡(
bio
 =
IO_MADE_GOOD
) {

2770 
	`rdev_˛ór_badblocks
(

2771 
rdev
,

2772 
r10_bio
->
devs
[
m
].
addr
,

2773 
r10_bio
->
£˘‹s
, 0);

2774 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2775 } i‡(
bio
 !
NULL
 &&

2776 !
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
)) {

2777 i‡(!
	`«ºow_wrôe_îr‹
(
r10_bio
, 
m
)) {

2778 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2779 
	`£t_bô
(
R10BIO_Degøded
,

2780 &
r10_bio
->
°©e
);

2782 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2784 
bio
 = 
r10_bio
->
devs
[
m
].
ª∂_bio
;

2785 
rdev
 = 
c⁄f
->
múr‹s
[
dev
].
ª∂a˚mít
;

2786 i‡(
rdev
 && 
bio
 =
IO_MADE_GOOD
) {

2787 
	`rdev_˛ór_badblocks
(

2788 
rdev
,

2789 
r10_bio
->
devs
[
m
].
addr
,

2790 
r10_bio
->
£˘‹s
, 0);

2791 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2794 i‡(
	`ã°_bô
(
R10BIO_WrôeEº‹
,

2795 &
r10_bio
->
°©e
))

2796 
	`˛o£_wrôe
(
r10_bio
);

2797 
	`øid_íd_bio_io
(
r10_bio
);

2799 
	}
}

2801 
	$øid10d
(
md_thªad
 *
thªad
)

2803 
mddev
 *mddev = 
thªad
->mddev;

2804 
r10bio
 *
r10_bio
;

2805 
Êags
;

2806 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2807 
li°_hód
 *
hód
 = &
c⁄f
->
ªåy_li°
;

2808 
blk_∂ug
 
∂ug
;

2810 
	`md_check_ªcovîy
(
mddev
);

2812 
	`blk_°¨t_∂ug
(&
∂ug
);

2815 
	`Êush_≥ndög_wrôes
(
c⁄f
);

2817 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2818 i‡(
	`li°_em±y
(
hód
)) {

2819 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2822 
r10_bio
 = 
	`li°_íåy
(
hód
->
¥ev
, 
r10bio
, 
ªåy_li°
);

2823 
	`li°_dñ
(
hód
->
¥ev
);

2824 
c⁄f
->
ƒ_queued
--;

2825 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2827 
mddev
 = 
r10_bio
->mddev;

2828 
c⁄f
 = 
mddev
->
¥iv©e
;

2829 i‡(
	`ã°_bô
(
R10BIO_MadeGood
, &
r10_bio
->
°©e
) ||

2830 
	`ã°_bô
(
R10BIO_WrôeEº‹
, &
r10_bio
->
°©e
))

2831 
	`h™dÀ_wrôe_com∂ëed
(
c⁄f
, 
r10_bio
);

2832 i‡(
	`ã°_bô
(
R10BIO_IsResh≠e
, &
r10_bio
->
°©e
))

2833 
	`ªsh≠e_ªque°_wrôe
(
mddev
, 
r10_bio
);

2834 i‡(
	`ã°_bô
(
R10BIO_IsSync
, &
r10_bio
->
°©e
))

2835 
	`sync_ªque°_wrôe
(
mddev
, 
r10_bio
);

2836 i‡(
	`ã°_bô
(
R10BIO_IsRecovî
, &
r10_bio
->
°©e
))

2837 
	`ªcovîy_ªque°_wrôe
(
mddev
, 
r10_bio
);

2838 i‡(
	`ã°_bô
(
R10BIO_RódEº‹
, &
r10_bio
->
°©e
))

2839 
	`h™dÀ_ªad_îr‹
(
mddev
, 
r10_bio
);

2844 
¶Ÿ
 = 
r10_bio
->
ªad_¶Ÿ
;

2845 
	`gíîic_make_ªque°
(
r10_bio
->
devs
[
¶Ÿ
].
bio
);

2848 
	`c⁄d_ªsched
();

2849 i‡(
mddev
->
Êags
 & ~(1<<
MD_CHANGE_PENDING
))

2850 
	`md_check_ªcovîy
(
mddev
);

2852 
	`blk_föish_∂ug
(&
∂ug
);

2853 
	}
}

2856 
	$öô_ªsync
(
r10c⁄f
 *
c⁄f
)

2858 
buffs
;

2859 
i
;

2861 
buffs
 = 
RESYNC_WINDOW
 / 
RESYNC_BLOCK_SIZE
;

2862 
	`BUG_ON
(
c⁄f
->
r10buf_poﬁ
);

2863 
c⁄f
->
have_ª∂a˚mít
 = 0;

2864 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++)

2865 i‡(
c⁄f
->
múr‹s
[
i
].
ª∂a˚mít
)

2866 
c⁄f
->
have_ª∂a˚mít
 = 1;

2867 
c⁄f
->
r10buf_poﬁ
 = 
	`mempoﬁ_¸óã
(
buffs
, 
r10buf_poﬁ_Æloc
, 
r10buf_poﬁ_‰ì
, conf);

2868 i‡(!
c⁄f
->
r10buf_poﬁ
)

2869  -
ENOMEM
;

2870 
c⁄f
->
√xt_ªsync
 = 0;

2872 
	}
}

2906 
£˘‹_t
 
	$sync_ªque°
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹_ƒ
,

2907 *
skù≥d
, 
go_Á°î
)

2909 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2910 
r10bio
 *
r10_bio
;

2911 
bio
 *
biﬁi°
 = 
NULL
, *bio;

2912 
£˘‹_t
 
max_£˘‹
, 
ƒ_£˘‹s
;

2913 
i
;

2914 
max_sync
;

2915 
£˘‹_t
 
sync_blocks
;

2916 
£˘‹_t
 
£˘‹s_skù≥d
 = 0;

2917 
chunks_skù≥d
 = 0;

2918 
£˘‹_t
 
chunk_mask
 = 
c⁄f
->
geo
.chunk_mask;

2920 i‡(!
c⁄f
->
r10buf_poﬁ
)

2921 i‡(
	`öô_ªsync
(
c⁄f
))

2928 i‡(
mddev
->
bôm≠
 =
NULL
 &&

2929 
mddev
->
ªcovîy_˝
 =
MaxSe˘‹
 &&

2930 
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
 &&

2931 !
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) &&

2932 !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
) &&

2933 !
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
) &&

2934 
c⁄f
->
fuŒsync
 == 0) {

2935 *
skù≥d
 = 1;

2936  
mddev
->
dev_£˘‹s
 - 
£˘‹_ƒ
;

2939 
skù≥d
:

2940 
max_£˘‹
 = 
mddev
->
dev_£˘‹s
;

2941 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
) ||

2942 
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

2943 
max_£˘‹
 = 
mddev
->
ªsync_max_£˘‹s
;

2944 i‡(
£˘‹_ƒ
 >
max_£˘‹
) {

2954 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
)) {

2955 
	`íd_ªsh≠e
(
c⁄f
);

2956 
	`˛o£_sync
(
c⁄f
);

2960 i‡(
mddev
->
cuº_ªsync
 < 
max_£˘‹
) {

2961 i‡(
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
))

2962 
	`bôm≠_íd_sync
(
mddev
->
bôm≠
, mddev->
cuº_ªsync
,

2963 &
sync_blocks
, 1);

2964 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++) {

2965 
£˘‹_t
 
£˘
 =

2966 
	`øid10_föd_vút
(
c⁄f
, 
mddev
->
cuº_ªsync
, 
i
);

2967 
	`bôm≠_íd_sync
(
mddev
->
bôm≠
, 
£˘
,

2968 &
sync_blocks
, 1);

2972 i‡((!
mddev
->
bôm≠
 || 
c⁄f
->
fuŒsync
)

2973 && 
c⁄f
->
have_ª∂a˚mít


2974 && 
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

2978 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++)

2979 i‡(
c⁄f
->
múr‹s
[
i
].
ª∂a˚mít
)

2980 
c⁄f
->
múr‹s
[
i
].
ª∂a˚mít


2981 ->
ªcovîy_off£t


2982 
MaxSe˘‹
;

2984 
c⁄f
->
fuŒsync
 = 0;

2986 
	`bôm≠_˛o£_sync
(
mddev
->
bôm≠
);

2987 
	`˛o£_sync
(
c⁄f
);

2988 *
skù≥d
 = 1;

2989  
£˘‹s_skù≥d
;

2992 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

2993  
	`ªsh≠e_ªque°
(
mddev
, 
£˘‹_ƒ
, 
skù≥d
);

2995 i‡(
chunks_skù≥d
 >
c⁄f
->
geo
.
øid_disks
) {

2999 *
skù≥d
 = 1;

3000  (
max_£˘‹
 - 
£˘‹_ƒ
Ë+ 
£˘‹s_skù≥d
;

3003 i‡(
max_£˘‹
 > 
mddev
->
ªsync_max
)

3004 
max_£˘‹
 = 
mddev
->
ªsync_max
;

3009 i‡(
c⁄f
->
geo
.
√¨_c›õs
 < c⁄f->geo.
øid_disks
 &&

3010 
max_£˘‹
 > (
£˘‹_ƒ
 | 
chunk_mask
))

3011 
max_£˘‹
 = (
£˘‹_ƒ
 | 
chunk_mask
) + 1;

3016 i‡(!
go_Á°î
 && 
c⁄f
->
ƒ_waôög
)

3017 
	`m¶ìp_öãºu±ibÀ
(1000);

3034 
max_sync
 = 
RESYNC_PAGES
 << (
PAGE_SHIFT
-9);

3035 i‡(!
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

3037 
j
;

3038 
r10_bio
 = 
NULL
;

3040 
i
 = 0 ; i < 
c⁄f
->
geo
.
øid_disks
; i++) {

3041 
°ûl_degøded
;

3042 
r10bio
 *
rb2
;

3043 
£˘‹_t
 
£˘
;

3044 
mu°_sync
;

3045 
™y_w‹kög
;

3046 
øid10_öfo
 *
múr‹
 = &
c⁄f
->
múr‹s
[
i
];

3048 i‡((
múr‹
->
rdev
 =
NULL
 ||

3049 
	`ã°_bô
(
In_sync
, &
múr‹
->
rdev
->
Êags
))

3051 (
múr‹
->
ª∂a˚mít
 =
NULL
 ||

3052 
	`ã°_bô
(
Fau…y
,

3053 &
múr‹
->
ª∂a˚mít
->
Êags
)))

3056 
°ûl_degøded
 = 0;

3058 
rb2
 = 
r10_bio
;

3059 
£˘
 = 
	`øid10_föd_vút
(
c⁄f
, 
£˘‹_ƒ
, 
i
);

3060 i‡(
£˘
 >
mddev
->
ªsync_max_£˘‹s
) {

3070 
mu°_sync
 = 
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘
,

3071 &
sync_blocks
, 1);

3072 i‡(
sync_blocks
 < 
max_sync
)

3073 
max_sync
 = 
sync_blocks
;

3074 i‡(!
mu°_sync
 &&

3075 
múr‹
->
ª∂a˚mít
 =
NULL
 &&

3076 !
c⁄f
->
fuŒsync
) {

3080 
chunks_skù≥d
 = -1;

3084 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10buf_poﬁ
, 
GFP_NOIO
);

3085 
r10_bio
->
°©e
 = 0;

3086 
	`øi£_b¨rõr
(
c⁄f
, 
rb2
 !
NULL
);

3087 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 0);

3089 
r10_bio
->
ma°î_bio
 = (
bio
*)
rb2
;

3090 i‡(
rb2
)

3091 
	`©omic_öc
(&
rb2
->
ªmaöög
);

3092 
r10_bio
->
mddev
 = mddev;

3093 
	`£t_bô
(
R10BIO_IsRecovî
, &
r10_bio
->
°©e
);

3094 
r10_bio
->
£˘‹
 = 
£˘
;

3096 
	`øid10_föd_phys
(
c⁄f
, 
r10_bio
);

3101 
j
 = 0; j < 
c⁄f
->
geo
.
øid_disks
; j++)

3102 i‡(
c⁄f
->
múr‹s
[
j
].
rdev
 =
NULL
 ||

3103 
	`ã°_bô
(
Fau…y
, &
c⁄f
->
múr‹s
[
j
].
rdev
->
Êags
)) {

3104 
°ûl_degøded
 = 1;

3108 
mu°_sync
 = 
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘
,

3109 &
sync_blocks
, 
°ûl_degøded
);

3111 
™y_w‹kög
 = 0;

3112 
j
=0; j<
c⁄f
->
c›õs
;j++) {

3113 
k
;

3114 
d
 = 
r10_bio
->
devs
[
j
].
devnum
;

3115 
£˘‹_t
 
‰om_addr
, 
to_addr
;

3116 
md_rdev
 *
rdev
;

3117 
£˘‹_t
 
£˘‹
, 
fú°_bad
;

3118 
bad_£˘‹s
;

3119 i‡(!
c⁄f
->
múr‹s
[
d
].
rdev
 ||

3120 !
	`ã°_bô
(
In_sync
, &
c⁄f
->
múr‹s
[
d
].
rdev
->
Êags
))

3123 
™y_w‹kög
 = 1;

3124 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

3125 
£˘‹
 = 
r10_bio
->
devs
[
j
].
addr
;

3127 i‡(
	`is_badblock
(
rdev
, 
£˘‹
, 
max_sync
,

3128 &
fú°_bad
, &
bad_£˘‹s
)) {

3129 i‡(
fú°_bad
 > 
£˘‹
)

3130 
max_sync
 = 
fú°_bad
 - 
£˘‹
;

3132 
bad_£˘‹s
 -(
£˘‹


3133 - 
fú°_bad
);

3134 i‡(
max_sync
 > 
bad_£˘‹s
)

3135 
max_sync
 = 
bad_£˘‹s
;

3139 
bio
 = 
r10_bio
->
devs
[0].bio;

3140 
	`bio_ª£t
(
bio
);

3141 
bio
->
bi_√xt
 = 
biﬁi°
;

3142 
biﬁi°
 = 
bio
;

3143 
bio
->
bi_¥iv©e
 = 
r10_bio
;

3144 
bio
->
bi_íd_io
 = 
íd_sync_ªad
;

3145 
bio
->
bi_rw
 = 
READ
;

3146 
‰om_addr
 = 
r10_bio
->
devs
[
j
].
addr
;

3147 
bio
->
bi_ôî
.
bi_£˘‹
 = 
‰om_addr
 +

3148 
rdev
->
d©a_off£t
;

3149 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

3150 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

3153 
k
=0; k<
c⁄f
->
c›õs
; k++)

3154 i‡(
r10_bio
->
devs
[
k
].
devnum
 =
i
)

3156 
	`BUG_ON
(
k
 =
c⁄f
->
c›õs
);

3157 
to_addr
 = 
r10_bio
->
devs
[
k
].
addr
;

3158 
r10_bio
->
devs
[0].
devnum
 = 
d
;

3159 
r10_bio
->
devs
[0].
addr
 = 
‰om_addr
;

3160 
r10_bio
->
devs
[1].
devnum
 = 
i
;

3161 
r10_bio
->
devs
[1].
addr
 = 
to_addr
;

3163 
rdev
 = 
múr‹
->rdev;

3164 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

3165 
bio
 = 
r10_bio
->
devs
[1].bio;

3166 
	`bio_ª£t
(
bio
);

3167 
bio
->
bi_√xt
 = 
biﬁi°
;

3168 
biﬁi°
 = 
bio
;

3169 
bio
->
bi_¥iv©e
 = 
r10_bio
;

3170 
bio
->
bi_íd_io
 = 
íd_sync_wrôe
;

3171 
bio
->
bi_rw
 = 
WRITE
;

3172 
bio
->
bi_ôî
.
bi_£˘‹
 = 
to_addr


3173 + 
rdev
->
d©a_off£t
;

3174 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

3175 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

3177 
r10_bio
->
devs
[1].
bio
->
bi_íd_io
 = 
NULL
;

3180 
bio
 = 
r10_bio
->
devs
[1].
ª∂_bio
;

3181 i‡(
bio
)

3182 
bio
->
bi_íd_io
 = 
NULL
;

3183 
rdev
 = 
múr‹
->
ª∂a˚mít
;

3192 i‡(
rdev
 =
NULL
 || 
bio
 == NULL ||

3193 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

3195 
	`bio_ª£t
(
bio
);

3196 
bio
->
bi_√xt
 = 
biﬁi°
;

3197 
biﬁi°
 = 
bio
;

3198 
bio
->
bi_¥iv©e
 = 
r10_bio
;

3199 
bio
->
bi_íd_io
 = 
íd_sync_wrôe
;

3200 
bio
->
bi_rw
 = 
WRITE
;

3201 
bio
->
bi_ôî
.
bi_£˘‹
 = 
to_addr
 +

3202 
rdev
->
d©a_off£t
;

3203 
bio
->
bi_bdev
 = 
rdev
->
bdev
;

3204 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

3207 i‡(
j
 =
c⁄f
->
c›õs
) {

3210 i‡(
™y_w‹kög
) {

3214 
k
;

3215 
k
 = 0; k < 
c⁄f
->
c›õs
; k++)

3216 i‡(
r10_bio
->
devs
[
k
].
devnum
 =
i
)

3218 i‡(!
	`ã°_bô
(
In_sync
,

3219 &
múr‹
->
rdev
->
Êags
)

3220 && !
	`rdev_£t_badblocks
(

3221 
múr‹
->
rdev
,

3222 
r10_bio
->
devs
[
k
].
addr
,

3223 
max_sync
, 0))

3224 
™y_w‹kög
 = 0;

3225 i‡(
múr‹
->
ª∂a˚mít
 &&

3226 !
	`rdev_£t_badblocks
(

3227 
múr‹
->
ª∂a˚mít
,

3228 
r10_bio
->
devs
[
k
].
addr
,

3229 
max_sync
, 0))

3230 
™y_w‹kög
 = 0;

3232 i‡(!
™y_w‹kög
) {

3233 i‡(!
	`ã°_™d_£t_bô
(
MD_RECOVERY_INTR
,

3234 &
mddev
->
ªcovîy
))

3235 
	`¥ötk
(
KERN_INFO
 "md/raid10:%s: insufficient "

3237 
	`md«me
(
mddev
));

3238 
múr‹
->
ªcovîy_dißbÀd


3239 
mddev
->
ªcovîy_dißbÀd
;

3241 
	`put_buf
(
r10_bio
);

3242 i‡(
rb2
)

3243 
	`©omic_dec
(&
rb2
->
ªmaöög
);

3244 
r10_bio
 = 
rb2
;

3248 i‡(
biﬁi°
 =
NULL
) {

3249 
r10_bio
) {

3250 
r10bio
 *
rb2
 = 
r10_bio
;

3251 
r10_bio
 = (
r10bio
*Ë
rb2
->
ma°î_bio
;

3252 
rb2
->
ma°î_bio
 = 
NULL
;

3253 
	`put_buf
(
rb2
);

3255 
giveup
;

3259 
cou¡
 = 0;

3261 
	`bôm≠_c⁄d_íd_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
);

3263 i‡(!
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
,

3264 &
sync_blocks
, 
mddev
->
degøded
) &&

3265 !
c⁄f
->
fuŒsync
 && !
	`ã°_bô
(
MD_RECOVERY_REQUESTED
,

3266 &
mddev
->
ªcovîy
)) {

3268 *
skù≥d
 = 1;

3269  
sync_blocks
 + 
£˘‹s_skù≥d
;

3271 i‡(
sync_blocks
 < 
max_sync
)

3272 
max_sync
 = 
sync_blocks
;

3273 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10buf_poﬁ
, 
GFP_NOIO
);

3274 
r10_bio
->
°©e
 = 0;

3276 
r10_bio
->
mddev
 = mddev;

3277 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 0);

3278 
	`øi£_b¨rõr
(
c⁄f
, 0);

3279 
c⁄f
->
√xt_ªsync
 = 
£˘‹_ƒ
;

3281 
r10_bio
->
ma°î_bio
 = 
NULL
;

3282 
r10_bio
->
£˘‹
 = 
£˘‹_ƒ
;

3283 
	`£t_bô
(
R10BIO_IsSync
, &
r10_bio
->
°©e
);

3284 
	`øid10_föd_phys
(
c⁄f
, 
r10_bio
);

3285 
r10_bio
->
£˘‹s
 = (
£˘‹_ƒ
 | 
chunk_mask
) - sector_nr + 1;

3287 
i
 = 0; i < 
c⁄f
->
c›õs
; i++) {

3288 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

3289 
£˘‹_t
 
fú°_bad
, 
£˘‹
;

3290 
bad_£˘‹s
;

3292 i‡(
r10_bio
->
devs
[
i
].
ª∂_bio
)

3293 
r10_bio
->
devs
[
i
].
ª∂_bio
->
bi_íd_io
 = 
NULL
;

3295 
bio
 = 
r10_bio
->
devs
[
i
].bio;

3296 
	`bio_ª£t
(
bio
);

3297 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

3298 i‡(
c⁄f
->
múr‹s
[
d
].
rdev
 =
NULL
 ||

3299 
	`ã°_bô
(
Fau…y
, &
c⁄f
->
múr‹s
[
d
].
rdev
->
Êags
))

3301 
£˘‹
 = 
r10_bio
->
devs
[
i
].
addr
;

3302 i‡(
	`is_badblock
(
c⁄f
->
múr‹s
[
d
].
rdev
,

3303 
£˘‹
, 
max_sync
,

3304 &
fú°_bad
, &
bad_£˘‹s
)) {

3305 i‡(
fú°_bad
 > 
£˘‹
)

3306 
max_sync
 = 
fú°_bad
 - 
£˘‹
;

3308 
bad_£˘‹s
 -(
£˘‹
 - 
fú°_bad
);

3309 i‡(
max_sync
 > 
bad_£˘‹s
)

3310 
max_sync
 = 
bad_£˘‹s
;

3314 
	`©omic_öc
(&
c⁄f
->
múr‹s
[
d
].
rdev
->
ƒ_≥ndög
);

3315 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

3316 
bio
->
bi_√xt
 = 
biﬁi°
;

3317 
biﬁi°
 = 
bio
;

3318 
bio
->
bi_¥iv©e
 = 
r10_bio
;

3319 
bio
->
bi_íd_io
 = 
íd_sync_ªad
;

3320 
bio
->
bi_rw
 = 
READ
;

3321 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 +

3322 
c⁄f
->
múr‹s
[
d
].
rdev
->
d©a_off£t
;

3323 
bio
->
bi_bdev
 = 
c⁄f
->
múr‹s
[
d
].
rdev
->
bdev
;

3324 
cou¡
++;

3326 i‡(
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
 =
NULL
 ||

3327 
	`ã°_bô
(
Fau…y
,

3328 &
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
Êags
))

3332 
bio
 = 
r10_bio
->
devs
[
i
].
ª∂_bio
;

3333 
	`bio_ª£t
(
bio
);

3334 
	`˛ór_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

3336 
£˘‹
 = 
r10_bio
->
devs
[
i
].
addr
;

3337 
	`©omic_öc
(&
c⁄f
->
múr‹s
[
d
].
rdev
->
ƒ_≥ndög
);

3338 
bio
->
bi_√xt
 = 
biﬁi°
;

3339 
biﬁi°
 = 
bio
;

3340 
bio
->
bi_¥iv©e
 = 
r10_bio
;

3341 
bio
->
bi_íd_io
 = 
íd_sync_wrôe
;

3342 
bio
->
bi_rw
 = 
WRITE
;

3343 
bio
->
bi_ôî
.
bi_£˘‹
 = 
£˘‹
 +

3344 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
d©a_off£t
;

3345 
bio
->
bi_bdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
->
bdev
;

3346 
cou¡
++;

3349 i‡(
cou¡
 < 2) {

3350 
i
=0; i<
c⁄f
->
c›õs
; i++) {

3351 
d
 = 
r10_bio
->
devs
[
i
].
devnum
;

3352 i‡(
r10_bio
->
devs
[
i
].
bio
->
bi_íd_io
)

3353 
	`rdev_dec_≥ndög
(
c⁄f
->
múr‹s
[
d
].
rdev
,

3354 
mddev
);

3355 i‡(
r10_bio
->
devs
[
i
].
ª∂_bio
 &&

3356 
r10_bio
->
devs
[
i
].
ª∂_bio
->
bi_íd_io
)

3357 
	`rdev_dec_≥ndög
(

3358 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
,

3359 
mddev
);

3361 
	`put_buf
(
r10_bio
);

3362 
biﬁi°
 = 
NULL
;

3363 
giveup
;

3367 
ƒ_£˘‹s
 = 0;

3368 i‡(
£˘‹_ƒ
 + 
max_sync
 < 
max_£˘‹
)

3369 
max_£˘‹
 = 
£˘‹_ƒ
 + 
max_sync
;

3371 
∑ge
 *page;

3372 
Àn
 = 
PAGE_SIZE
;

3373 i‡(
£˘‹_ƒ
 + (
Àn
>>9Ë> 
max_£˘‹
)

3374 
Àn
 = (
max_£˘‹
 - 
£˘‹_ƒ
) << 9;

3375 i‡(
Àn
 == 0)

3377 
bio

biﬁi°
 ; biÿ; bio=bio->
bi_√xt
) {

3378 
bio
 *
bio2
;

3379 
∑ge
 = 
bio
->
bi_io_vec
[bio->
bi_v˙t
].
bv_∑ge
;

3380 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àn
, 0))

3384 
bio
->
bi_io_vec
[bio->
bi_v˙t
].
bv_∑ge
 = 
∑ge
;

3385 
bio2
 = 
biﬁi°
;

3386 
bio2
 && bio2 !
bio
;

3387 
bio2
 = bio2->
bi_√xt
) {

3389 
bio2
->
bi_v˙t
--;

3390 
bio2
->
bi_ôî
.
bi_size
 -
Àn
;

3391 
bio2
->
bi_Êags
 &~(1<< 
BIO_SEG_VALID
);

3393 
bio_fuŒ
;

3395 
ƒ_£˘‹s
 +
Àn
>>9;

3396 
£˘‹_ƒ
 +
Àn
>>9;

3397 } 
biﬁi°
->
bi_v˙t
 < 
RESYNC_PAGES
);

3398 
bio_fuŒ
:

3399 
r10_bio
->
£˘‹s
 = 
ƒ_£˘‹s
;

3401 
biﬁi°
) {

3402 
bio
 = 
biﬁi°
;

3403 
biﬁi°
 = biﬁi°->
bi_√xt
;

3405 
bio
->
bi_√xt
 = 
NULL
;

3406 
r10_bio
 = 
bio
->
bi_¥iv©e
;

3407 
r10_bio
->
£˘‹s
 = 
ƒ_£˘‹s
;

3409 i‡(
bio
->
bi_íd_io
 =
íd_sync_ªad
) {

3410 
	`md_sync_ac˘
(
bio
->
bi_bdev
, 
ƒ_£˘‹s
);

3411 
	`£t_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

3412 
	`gíîic_make_ªque°
(
bio
);

3416 i‡(
£˘‹s_skù≥d
)

3420 
	`md_d⁄e_sync
(
mddev
, 
£˘‹s_skù≥d
, 1);

3422  
£˘‹s_skù≥d
 + 
ƒ_£˘‹s
;

3423 
giveup
:

3428 i‡(
£˘‹_ƒ
 + 
max_sync
 < 
max_£˘‹
)

3429 
max_£˘‹
 = 
£˘‹_ƒ
 + 
max_sync
;

3431 
£˘‹s_skù≥d
 +(
max_£˘‹
 - 
£˘‹_ƒ
);

3432 
chunks_skù≥d
 ++;

3433 
£˘‹_ƒ
 = 
max_£˘‹
;

3434 
skù≥d
;

3435 
	}
}

3437 
£˘‹_t


3438 
	$øid10_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

3440 
£˘‹_t
 
size
;

3441 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3443 i‡(!
øid_disks
)

3444 
øid_disks
 = 
	`mö
(
c⁄f
->
geo
.raid_disks,

3445 
c⁄f
->
¥ev
.
øid_disks
);

3446 i‡(!
£˘‹s
)

3447 
£˘‹s
 = 
c⁄f
->
dev_£˘‹s
;

3449 
size
 = 
£˘‹s
 >> 
c⁄f
->
geo
.
chunk_shi·
;

3450 
	`£˘‹_div
(
size
, 
c⁄f
->
geo
.
Ár_c›õs
);

3451 
size
 = sizê* 
øid_disks
;

3452 
	`£˘‹_div
(
size
, 
c⁄f
->
geo
.
√¨_c›õs
);

3454  
size
 << 
c⁄f
->
geo
.
chunk_shi·
;

3455 
	}
}

3457 
	$ˇlc_£˘‹s
(
r10c⁄f
 *
c⁄f
, 
£˘‹_t
 
size
)

3464 
size
 = sizê>> 
c⁄f
->
geo
.
chunk_shi·
;

3465 
	`£˘‹_div
(
size
, 
c⁄f
->
geo
.
Ár_c›õs
);

3466 
size
 = sizê* 
c⁄f
->
geo
.
øid_disks
;

3467 
	`£˘‹_div
(
size
, 
c⁄f
->
geo
.
√¨_c›õs
);

3470 
size
 = sizê* 
c⁄f
->
c›õs
;

3475 
size
 = 
	`DIV_ROUND_UP_SECTOR_T
(size, 
c⁄f
->
geo
.
øid_disks
);

3477 
c⁄f
->
dev_£˘‹s
 = 
size
 << c⁄f->
geo
.
chunk_shi·
;

3479 i‡(
c⁄f
->
geo
.
Ár_off£t
)

3480 
c⁄f
->
geo
.
°ride
 = 1 << c⁄f->geo.
chunk_shi·
;

3482 
	`£˘‹_div
(
size
, 
c⁄f
->
geo
.
Ár_c›õs
);

3483 
c⁄f
->
geo
.
°ride
 = 
size
 << c⁄f->geo.
chunk_shi·
;

3485 
	}
}

3487 
	egeo_ty≥
 {
	mgeo_√w
, 
	mgeo_ﬁd
, 
	mgeo_°¨t
};

3488 
	$£tup_geo
(
geom
 *
geo
, 
mddev
 *mddev, 
geo_ty≥
 
√w
)

3490 
nc
, 
fc
, 
fo
;

3491 
œyout
, 
chunk
, 
disks
;

3492 
√w
) {

3493 
geo_ﬁd
:

3494 
œyout
 = 
mddev
->layout;

3495 
chunk
 = 
mddev
->
chunk_£˘‹s
;

3496 
disks
 = 
mddev
->
øid_disks
 - mddev->
dñè_disks
;

3498 
geo_√w
:

3499 
œyout
 = 
mddev
->
√w_œyout
;

3500 
chunk
 = 
mddev
->
√w_chunk_£˘‹s
;

3501 
disks
 = 
mddev
->
øid_disks
;

3504 
geo_°¨t
:

3506 
œyout
 = 
mddev
->
√w_œyout
;

3507 
chunk
 = 
mddev
->
√w_chunk_£˘‹s
;

3508 
disks
 = 
mddev
->
øid_disks
 + mddev->
dñè_disks
;

3511 i‡(
œyout
 >> 18)

3513 i‡(
chunk
 < (
PAGE_SIZE
 >> 9) ||

3514 !
	`is_powî_of_2
(
chunk
))

3516 
nc
 = 
œyout
 & 255;

3517 
fc
 = (
œyout
 >> 8) & 255;

3518 
fo
 = 
œyout
 & (1<<16);

3519 
geo
->
øid_disks
 = 
disks
;

3520 
geo
->
√¨_c›õs
 = 
nc
;

3521 
geo
->
Ár_c›õs
 = 
fc
;

3522 
geo
->
Ár_off£t
 = 
fo
;

3523 
geo
->
Ár_£t_size
 = (
œyout
 & (1<<17)Ë? 
disks
 / 
fc
 : disks;

3524 
geo
->
chunk_mask
 = 
chunk
 - 1;

3525 
geo
->
chunk_shi·
 = 
	`ffz
(~
chunk
);

3526  
nc
*
fc
;

3527 
	}
}

3529 
r10c⁄f
 *
	$£tup_c⁄f
(
mddev
 *mddev)

3531 
r10c⁄f
 *
c⁄f
 = 
NULL
;

3532 
îr
 = -
EINVAL
;

3533 
geom
 
geo
;

3534 
c›õs
;

3536 
c›õs
 = 
	`£tup_geo
(&
geo
, 
mddev
, 
geo_√w
);

3538 i‡(
c›õs
 == -2) {

3539 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s: chunk size must be "

3541 
	`md«me
(
mddev
), 
PAGE_SIZE
);

3542 
out
;

3545 i‡(
c›õs
 < 2 || c›õ†> 
mddev
->
øid_disks
) {

3546 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s: unsupportedÑaid10Üayout: 0x%8x\n",

3547 
	`md«me
(
mddev
), mddev->
√w_œyout
);

3548 
out
;

3551 
îr
 = -
ENOMEM
;

3552 
c⁄f
 = 
	`kzÆloc
((
r10c⁄f
), 
GFP_KERNEL
);

3553 i‡(!
c⁄f
)

3554 
out
;

3557 
c⁄f
->
múr‹s
 = 
	`kzÆloc
((
øid10_öfo
)*(
mddev
->
øid_disks
 +

3558 
	`max
(0,-
mddev
->
dñè_disks
)),

3559 
GFP_KERNEL
);

3560 i‡(!
c⁄f
->
múr‹s
)

3561 
out
;

3563 
c⁄f
->
tmµage
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

3564 i‡(!
c⁄f
->
tmµage
)

3565 
out
;

3567 
c⁄f
->
geo
 = geo;

3568 
c⁄f
->
c›õs
 = copies;

3569 
c⁄f
->
r10bio_poﬁ
 = 
	`mempoﬁ_¸óã
(
NR_RAID10_BIOS
, 
r10bio_poﬁ_Æloc
,

3570 
r10bio_poﬁ_‰ì
, 
c⁄f
);

3571 i‡(!
c⁄f
->
r10bio_poﬁ
)

3572 
out
;

3574 
	`ˇlc_£˘‹s
(
c⁄f
, 
mddev
->
dev_£˘‹s
);

3575 i‡(
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
) {

3576 
c⁄f
->
¥ev
 = c⁄f->
geo
;

3577 
c⁄f
->
ªsh≠e_¥ogªss
 = 
MaxSe˘‹
;

3579 i‡(
	`£tup_geo
(&
c⁄f
->
¥ev
, 
mddev
, 
geo_ﬁd
Ë!c⁄f->
c›õs
) {

3580 
îr
 = -
EINVAL
;

3581 
out
;

3583 
c⁄f
->
ªsh≠e_¥ogªss
 = 
mddev
->
ªsh≠e_posôi⁄
;

3584 i‡(
c⁄f
->
¥ev
.
Ár_off£t
)

3585 
c⁄f
->
¥ev
.
°ride
 = 1 << c⁄f->¥ev.
chunk_shi·
;

3588 
c⁄f
->
¥ev
.
°ride
 = c⁄f->
dev_£˘‹s
;

3590 
	`•ö_lock_öô
(&
c⁄f
->
devi˚_lock
);

3591 
	`INIT_LIST_HEAD
(&
c⁄f
->
ªåy_li°
);

3593 
	`•ö_lock_öô
(&
c⁄f
->
ªsync_lock
);

3594 
	`öô_waôqueue_hód
(&
c⁄f
->
waô_b¨rõr
);

3596 
c⁄f
->
thªad
 = 
	`md_ªgi°î_thªad
(
øid10d
, 
mddev
, "raid10");

3597 i‡(!
c⁄f
->
thªad
)

3598 
out
;

3600 
c⁄f
->
mddev
 = mddev;

3601  
c⁄f
;

3603 
out
:

3604 i‡(
îr
 =-
ENOMEM
)

3605 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s: couldn'tállocate memory.\n",

3606 
	`md«me
(
mddev
));

3607 i‡(
c⁄f
) {

3608 i‡(
c⁄f
->
r10bio_poﬁ
)

3609 
	`mempoﬁ_de°roy
(
c⁄f
->
r10bio_poﬁ
);

3610 
	`k‰ì
(
c⁄f
->
múr‹s
);

3611 
	`ß„_put_∑ge
(
c⁄f
->
tmµage
);

3612 
	`k‰ì
(
c⁄f
);

3614  
	`ERR_PTR
(
îr
);

3615 
	}
}

3617 
	$run
(
mddev
 *mddev)

3619 
r10c⁄f
 *
c⁄f
;

3620 
i
, 
disk_idx
, 
chunk_size
;

3621 
øid10_öfo
 *
disk
;

3622 
md_rdev
 *
rdev
;

3623 
£˘‹_t
 
size
;

3624 
£˘‹_t
 
mö_off£t_diff
 = 0;

3625 
fú°
 = 1;

3626 
boﬁ
 
disˇrd_suµ‹ãd
 = 
Ál£
;

3628 i‡(
mddev
->
¥iv©e
 =
NULL
) {

3629 
c⁄f
 = 
	`£tup_c⁄f
(
mddev
);

3630 i‡(
	`IS_ERR
(
c⁄f
))

3631  
	`PTR_ERR
(
c⁄f
);

3632 
mddev
->
¥iv©e
 = 
c⁄f
;

3634 
c⁄f
 = 
mddev
->
¥iv©e
;

3635 i‡(!
c⁄f
)

3636 
out
;

3638 
mddev
->
thªad
 = 
c⁄f
->thread;

3639 
c⁄f
->
thªad
 = 
NULL
;

3641 
chunk_size
 = 
mddev
->
chunk_£˘‹s
 << 9;

3642 i‡(
mddev
->
queue
) {

3643 
	`blk_queue_max_disˇrd_£˘‹s
(
mddev
->
queue
,

3644 
mddev
->
chunk_£˘‹s
);

3645 
	`blk_queue_max_wrôe_ßme_£˘‹s
(
mddev
->
queue
, 0);

3646 
	`blk_queue_io_mö
(
mddev
->
queue
, 
chunk_size
);

3647 i‡(
c⁄f
->
geo
.
øid_disks
 % c⁄f->geo.
√¨_c›õs
)

3648 
	`blk_queue_io_›t
(
mddev
->
queue
, 
chunk_size
 * 
c⁄f
->
geo
.
øid_disks
);

3650 
	`blk_queue_io_›t
(
mddev
->
queue
, 
chunk_size
 *

3651 (
c⁄f
->
geo
.
øid_disks
 / c⁄f->geo.
√¨_c›õs
));

3654 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

3655 
diff
;

3656 
ªque°_queue
 *
q
;

3658 
disk_idx
 = 
rdev
->
øid_disk
;

3659 i‡(
disk_idx
 < 0)

3661 i‡(
disk_idx
 >
c⁄f
->
geo
.
øid_disks
 &&

3662 
disk_idx
 >
c⁄f
->
¥ev
.
øid_disks
)

3664 
disk
 = 
c⁄f
->
múr‹s
 + 
disk_idx
;

3666 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
)) {

3667 i‡(
disk
->
ª∂a˚mít
)

3668 
out_‰ì_c⁄f
;

3669 
disk
->
ª∂a˚mít
 = 
rdev
;

3671 i‡(
disk
->
rdev
)

3672 
out_‰ì_c⁄f
;

3673 
disk
->
rdev
 =Ñdev;

3675 
q
 = 
	`bdev_gë_queue
(
rdev
->
bdev
);

3676 i‡(
q
->
mîge_bvec_‚
)

3677 
mddev
->
mîge_check_√eded
 = 1;

3678 
diff
 = (
rdev
->
√w_d©a_off£t
 -Ñdev->
d©a_off£t
);

3679 i‡(!
mddev
->
ªsh≠e_backw¨ds
)

3680 
diff
 = -diff;

3681 i‡(
diff
 < 0)

3682 
diff
 = 0;

3683 i‡(
fú°
 || 
diff
 < 
mö_off£t_diff
)

3684 
mö_off£t_diff
 = 
diff
;

3686 i‡(
mddev
->
gídisk
)

3687 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

3688 
rdev
->
d©a_off£t
 << 9);

3690 
disk
->
hód_posôi⁄
 = 0;

3692 i‡(
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)))

3693 
disˇrd_suµ‹ãd
 = 
åue
;

3696 i‡(
mddev
->
queue
) {

3697 i‡(
disˇrd_suµ‹ãd
)

3698 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
,

3699 
mddev
->
queue
);

3701 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
,

3702 
mddev
->
queue
);

3705 i‡(!
	`íough
(
c⁄f
, -1)) {

3706 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s:ÇotÉnough operational mirrors.\n",

3707 
	`md«me
(
mddev
));

3708 
out_‰ì_c⁄f
;

3711 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

3713 i‡(
c⁄f
->
geo
.
Ár_c›õs
 != 1 &&

3714 
c⁄f
->
geo
.
Ár_off£t
 == 0)

3715 
out_‰ì_c⁄f
;

3716 i‡(
c⁄f
->
¥ev
.
Ár_c›õs
 != 1 &&

3717 
c⁄f
->
¥ev
.
Ár_off£t
 == 0)

3718 
out_‰ì_c⁄f
;

3721 
mddev
->
degøded
 = 0;

3722 
i
 = 0;

3723 
i
 < 
c⁄f
->
geo
.
øid_disks


3724 || 
i
 < 
c⁄f
->
¥ev
.
øid_disks
;

3725 
i
++) {

3727 
disk
 = 
c⁄f
->
múr‹s
 + 
i
;

3729 i‡(!
disk
->
rdev
 && disk->
ª∂a˚mít
) {

3731 
disk
->
rdev
 = disk->
ª∂a˚mít
;

3732 
disk
->
ª∂a˚mít
 = 
NULL
;

3733 
	`˛ór_bô
(
Rïœ˚mít
, &
disk
->
rdev
->
Êags
);

3736 i‡(!
disk
->
rdev
 ||

3737 !
	`ã°_bô
(
In_sync
, &
disk
->
rdev
->
Êags
)) {

3738 
disk
->
hód_posôi⁄
 = 0;

3739 
mddev
->
degøded
++;

3740 i‡(
disk
->
rdev
 &&

3741 
disk
->
rdev
->
ßved_øid_disk
 < 0)

3742 
c⁄f
->
fuŒsync
 = 1;

3744 
disk
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled - 1;

3747 i‡(
mddev
->
ªcovîy_˝
 !
MaxSe˘‹
)

3748 
	`¥ötk
(
KERN_NOTICE
 "md/raid10:%s:Çot clean"

3750 
	`md«me
(
mddev
));

3751 
	`¥ötk
(
KERN_INFO


3753 
	`md«me
(
mddev
), 
c⁄f
->
geo
.
øid_disks
 - mddev->
degøded
,

3754 
c⁄f
->
geo
.
øid_disks
);

3758 
mddev
->
dev_£˘‹s
 = 
c⁄f
->dev_sectors;

3759 
size
 = 
	`øid10_size
(
mddev
, 0, 0);

3760 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
size
);

3761 
mddev
->
ªsync_max_£˘‹s
 = 
size
;

3763 i‡(
mddev
->
queue
) {

3764 
°rùe
 = 
c⁄f
->
geo
.
øid_disks
 *

3765 ((
mddev
->
chunk_£˘‹s
 << 9Ë/ 
PAGE_SIZE
);

3766 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
øid10_c⁄ge°ed
;

3767 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

3773 
°rùe
 /
c⁄f
->
geo
.
√¨_c›õs
;

3774 i‡(
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 < 2 * 
°rùe
)

3775 
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 = 2 * 
°rùe
;

3776 
	`blk_queue_mîge_bvec
(
mddev
->
queue
, 
øid10_mîgóbÀ_bvec
);

3780 i‡(
	`md_öãgrôy_ªgi°î
(
mddev
))

3781 
out_‰ì_c⁄f
;

3783 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

3784 
bef‹e_Àngth
, 
a·î_Àngth
;

3786 
bef‹e_Àngth
 = ((1 << 
c⁄f
->
¥ev
.
chunk_shi·
) *

3787 
c⁄f
->
¥ev
.
Ár_c›õs
);

3788 
a·î_Àngth
 = ((1 << 
c⁄f
->
geo
.
chunk_shi·
) *

3789 
c⁄f
->
geo
.
Ár_c›õs
);

3791 i‡(
	`max
(
bef‹e_Àngth
, 
a·î_Àngth
Ë> 
mö_off£t_diff
) {

3793 
	`¥ötk
("md/raid10: offset differenceÇotÉnoughÅo continueÑeshape\n");

3794 
out_‰ì_c⁄f
;

3796 
c⁄f
->
off£t_diff
 = 
mö_off£t_diff
;

3798 
c⁄f
->
ªsh≠e_ß„
 = c⁄f->
ªsh≠e_¥ogªss
;

3799 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

3800 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

3801 
	`£t_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

3802 
	`£t_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

3803 
mddev
->
sync_thªad
 = 
	`md_ªgi°î_thªad
(
md_do_sync
, mddev,

3809 
out_‰ì_c⁄f
:

3810 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

3811 i‡(
c⁄f
->
r10bio_poﬁ
)

3812 
	`mempoﬁ_de°roy
(
c⁄f
->
r10bio_poﬁ
);

3813 
	`ß„_put_∑ge
(
c⁄f
->
tmµage
);

3814 
	`k‰ì
(
c⁄f
->
múr‹s
);

3815 
	`k‰ì
(
c⁄f
);

3816 
mddev
->
¥iv©e
 = 
NULL
;

3817 
out
:

3818  -
EIO
;

3819 
	}
}

3821 
	$°›
(
mddev
 *mddev)

3823 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3825 
	`øi£_b¨rõr
(
c⁄f
, 0);

3826 
	`lowî_b¨rõr
(
c⁄f
);

3828 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

3829 i‡(
mddev
->
queue
)

3831 
	`blk_sync_queue
(
mddev
->
queue
);

3833 i‡(
c⁄f
->
r10bio_poﬁ
)

3834 
	`mempoﬁ_de°roy
(
c⁄f
->
r10bio_poﬁ
);

3835 
	`ß„_put_∑ge
(
c⁄f
->
tmµage
);

3836 
	`k‰ì
(
c⁄f
->
múr‹s
);

3837 
	`k‰ì
(
c⁄f
);

3838 
mddev
->
¥iv©e
 = 
NULL
;

3840 
	}
}

3842 
	$øid10_quõs˚
(
mddev
 *mddev, 
°©e
)

3844 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3846 
°©e
) {

3848 
	`øi£_b¨rõr
(
c⁄f
, 0);

3851 
	`lowî_b¨rõr
(
c⁄f
);

3854 
	}
}

3856 
	$øid10_ªsize
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
)

3870 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3871 
£˘‹_t
 
ﬁdsize
, 
size
;

3873 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
)

3874  -
EBUSY
;

3876 i‡(
c⁄f
->
geo
.
Ár_c›õs
 > 1 && !c⁄f->geo.
Ár_off£t
)

3877  -
EINVAL
;

3879 
ﬁdsize
 = 
	`øid10_size
(
mddev
, 0, 0);

3880 
size
 = 
	`øid10_size
(
mddev
, 
£˘‹s
, 0);

3881 i‡(
mddev
->
exã∫Æ_size
 &&

3882 
mddev
->
¨øy_£˘‹s
 > 
size
)

3883  -
EINVAL
;

3884 i‡(
mddev
->
bôm≠
) {

3885 
ªt
 = 
	`bôm≠_ªsize
(
mddev
->
bôm≠
, 
size
, 0, 0);

3886 i‡(
ªt
)

3887  
ªt
;

3889 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
size
);

3890 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

3891 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

3892 i‡(
£˘‹s
 > 
mddev
->
dev_£˘‹s
 &&

3893 
mddev
->
ªcovîy_˝
 > 
ﬁdsize
) {

3894 
mddev
->
ªcovîy_˝
 = 
ﬁdsize
;

3895 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

3897 
	`ˇlc_£˘‹s
(
c⁄f
, 
£˘‹s
);

3898 
mddev
->
dev_£˘‹s
 = 
c⁄f
->dev_sectors;

3899 
mddev
->
ªsync_max_£˘‹s
 = 
size
;

3901 
	}
}

3903 *
	$øid10_èkeovî_øid0
(
mddev
 *mddev)

3905 
md_rdev
 *
rdev
;

3906 
r10c⁄f
 *
c⁄f
;

3908 i‡(
mddev
->
degøded
 > 0) {

3909 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s: Error: degradedÑaid0!\n",

3910 
	`md«me
(
mddev
));

3911  
	`ERR_PTR
(-
EINVAL
);

3915 
mddev
->
√w_Àvñ
 = 10;

3917 
mddev
->
√w_œyout
 = (1<<8) + 2;

3918 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

3919 
mddev
->
dñè_disks
 = mddev->
øid_disks
;

3920 
mddev
->
øid_disks
 *= 2;

3922 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

3924 
c⁄f
 = 
	`£tup_c⁄f
(
mddev
);

3925 i‡(!
	`IS_ERR
(
c⁄f
)) {

3926 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

3927 i‡(
rdev
->
øid_disk
 >= 0)

3928 
rdev
->
√w_øid_disk
 =Ñdev->
øid_disk
 * 2;

3929 
c⁄f
->
b¨rõr
 = 1;

3932  
c⁄f
;

3933 
	}
}

3935 *
	$øid10_èkeovî
(
mddev
 *mddev)

3937 
r0c⁄f
 *
øid0_c⁄f
;

3942 i‡(
mddev
->
Àvñ
 == 0) {

3944 
øid0_c⁄f
 = 
mddev
->
¥iv©e
;

3945 i‡(
øid0_c⁄f
->
ƒ_°rù_z⁄es
 > 1) {

3946 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s: cannotÅakeoverÑaid 0"

3948 
	`md«me
(
mddev
));

3949  
	`ERR_PTR
(-
EINVAL
);

3951  
	`øid10_èkeovî_øid0
(
mddev
);

3953  
	`ERR_PTR
(-
EINVAL
);

3954 
	}
}

3956 
	$øid10_check_ªsh≠e
(
mddev
 *mddev)

3972 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

3973 
geom
 
geo
;

3975 i‡(
c⁄f
->
geo
.
Ár_c›õs
 !1 && !c⁄f->geo.
Ár_off£t
)

3976  -
EINVAL
;

3978 i‡(
	`£tup_geo
(&
geo
, 
mddev
, 
geo_°¨t
Ë!
c⁄f
->
c›õs
)

3980  -
EINVAL
;

3981 i‡(
geo
.
Ár_c›õs
 > 1 && !geo.
Ár_off£t
)

3983  -
EINVAL
;

3985 i‡(
mddev
->
¨øy_£˘‹s
 & 
geo
.
chunk_mask
)

3987  -
EINVAL
;

3989 i‡(!
	`íough
(
c⁄f
, -1))

3990  -
EINVAL
;

3992 
	`k‰ì
(
c⁄f
->
múr‹s_√w
);

3993 
c⁄f
->
múr‹s_√w
 = 
NULL
;

3994 i‡(
mddev
->
dñè_disks
 > 0) {

3996 
c⁄f
->
múr‹s_√w
 = 
	`kzÆloc
(

3997 (
øid10_öfo
)

3998 *(
mddev
->
øid_disks
 +

3999 
mddev
->
dñè_disks
),

4000 
GFP_KERNEL
);

4001 i‡(!
c⁄f
->
múr‹s_√w
)

4002  -
ENOMEM
;

4005 
	}
}

4020 
	$ˇlc_degøded
(
r10c⁄f
 *
c⁄f
)

4022 
degøded
, 
degøded2
;

4023 
i
;

4025 
	`rcu_ªad_lock
();

4026 
degøded
 = 0;

4028 
i
 = 0; i < 
c⁄f
->
¥ev
.
øid_disks
; i++) {

4029 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

4030 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

4031 
degøded
++;

4032 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

4037 
degøded
++;

4039 
	`rcu_ªad_u∆ock
();

4040 i‡(
c⁄f
->
geo
.
øid_disks
 =c⁄f->
¥ev
.raid_disks)

4041  
degøded
;

4042 
	`rcu_ªad_lock
();

4043 
degøded2
 = 0;

4044 
i
 = 0; i < 
c⁄f
->
geo
.
øid_disks
; i++) {

4045 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
múr‹s
[
i
].rdev);

4046 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

4047 
degøded2
++;

4048 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

4054 i‡(
c⁄f
->
geo
.
øid_disks
 <c⁄f->
¥ev
.raid_disks)

4055 
degøded2
++;

4058 
	`rcu_ªad_u∆ock
();

4059 i‡(
degøded2
 > 
degøded
)

4060  
degøded2
;

4061  
degøded
;

4062 
	}
}

4064 
	$øid10_°¨t_ªsh≠e
(
mddev
 *mddev)

4076 
bef‹e_Àngth
, 
a·î_Àngth
;

4077 
£˘‹_t
 
mö_off£t_diff
 = 0;

4078 
fú°
 = 1;

4079 
geom
 
√w
;

4080 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4081 
md_rdev
 *
rdev
;

4082 
•¨es
 = 0;

4083 
ªt
;

4085 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

4086  -
EBUSY
;

4088 i‡(
	`£tup_geo
(&
√w
, 
mddev
, 
geo_°¨t
Ë!
c⁄f
->
c›õs
)

4089  -
EINVAL
;

4091 
bef‹e_Àngth
 = ((1 << 
c⁄f
->
¥ev
.
chunk_shi·
) *

4092 
c⁄f
->
¥ev
.
Ár_c›õs
);

4093 
a·î_Àngth
 = ((1 << 
c⁄f
->
geo
.
chunk_shi·
) *

4094 
c⁄f
->
geo
.
Ár_c›õs
);

4096 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

4097 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

4098 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

4099 
•¨es
++;

4100 i‡(
rdev
->
øid_disk
 >= 0) {

4101 
diff
 = (
rdev
->
√w_d©a_off£t


4102 - 
rdev
->
d©a_off£t
);

4103 i‡(!
mddev
->
ªsh≠e_backw¨ds
)

4104 
diff
 = -diff;

4105 i‡(
diff
 < 0)

4106 
diff
 = 0;

4107 i‡(
fú°
 || 
diff
 < 
mö_off£t_diff
)

4108 
mö_off£t_diff
 = 
diff
;

4112 i‡(
	`max
(
bef‹e_Àngth
, 
a·î_Àngth
Ë> 
mö_off£t_diff
)

4113  -
EINVAL
;

4115 i‡(
•¨es
 < 
mddev
->
dñè_disks
)

4116  -
EINVAL
;

4118 
c⁄f
->
off£t_diff
 = 
mö_off£t_diff
;

4119 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4120 i‡(
c⁄f
->
múr‹s_√w
) {

4121 
	`mem˝y
(
c⁄f
->
múr‹s_√w
, c⁄f->
múr‹s
,

4122 (
øid10_öfo
)*
c⁄f
->
¥ev
.
øid_disks
);

4123 
	`smp_mb
();

4124 
	`k‰ì
(
c⁄f
->
múr‹s_ﬁd
);

4125 
c⁄f
->
múr‹s_ﬁd
 = c⁄f->
múr‹s
;

4126 
c⁄f
->
múr‹s
 = c⁄f->
múr‹s_√w
;

4127 
c⁄f
->
múr‹s_√w
 = 
NULL
;

4129 
	`£tup_geo
(&
c⁄f
->
geo
, 
mddev
, 
geo_°¨t
);

4130 
	`smp_mb
();

4131 i‡(
mddev
->
ªsh≠e_backw¨ds
) {

4132 
£˘‹_t
 
size
 = 
	`øid10_size
(
mddev
, 0, 0);

4133 i‡(
size
 < 
mddev
->
¨øy_£˘‹s
) {

4134 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4135 
	`¥ötk
(
KERN_ERR
 "md/raid10:%s:árray size must beÑeduce beforeÇumber of disks\n",

4136 
	`md«me
(
mddev
));

4137  -
EINVAL
;

4139 
mddev
->
ªsync_max_£˘‹s
 = 
size
;

4140 
c⁄f
->
ªsh≠e_¥ogªss
 = 
size
;

4142 
c⁄f
->
ªsh≠e_¥ogªss
 = 0;

4143 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4145 i‡(
mddev
->
dñè_disks
 && mddev->
bôm≠
) {

4146 
ªt
 = 
	`bôm≠_ªsize
(
mddev
->
bôm≠
,

4147 
	`øid10_size
(
mddev
, 0,

4148 
c⁄f
->
geo
.
øid_disks
),

4150 i‡(
ªt
)

4151 
ab‹t
;

4153 i‡(
mddev
->
dñè_disks
 > 0) {

4154 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

4155 i‡(
rdev
->
øid_disk
 < 0 &&

4156 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

4157 i‡(
	`øid10_add_disk
(
mddev
, 
rdev
) == 0) {

4158 i‡(
rdev
->
øid_disk
 >=

4159 
c⁄f
->
¥ev
.
øid_disks
)

4160 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

4162 
rdev
->
ªcovîy_off£t
 = 0;

4164 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

4167 } i‡(
rdev
->
øid_disk
 >
c⁄f
->
¥ev
.
øid_disks


4168 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

4170 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

4177 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4178 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

4179 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4180 
mddev
->
øid_disks
 = 
c⁄f
->
geo
.raid_disks;

4181 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4182 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

4184 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

4185 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

4186 
	`£t_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

4187 
	`£t_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

4189 
mddev
->
sync_thªad
 = 
	`md_ªgi°î_thªad
(
md_do_sync
, mddev,

4191 i‡(!
mddev
->
sync_thªad
) {

4192 
ªt
 = -
EAGAIN
;

4193 
ab‹t
;

4195 
c⁄f
->
ªsh≠e_checkpoöt
 = 
jiffõs
;

4196 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

4197 
	`md_√w_evít
(
mddev
);

4200 
ab‹t
:

4201 
mddev
->
ªcovîy
 = 0;

4202 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4203 
c⁄f
->
geo
 = c⁄f->
¥ev
;

4204 
mddev
->
øid_disks
 = 
c⁄f
->
geo
.raid_disks;

4205 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

4206 
rdev
->
√w_d©a_off£t
 =Ñdev->
d©a_off£t
;

4207 
	`smp_wmb
();

4208 
c⁄f
->
ªsh≠e_¥ogªss
 = 
MaxSe˘‹
;

4209 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

4210 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4211  
ªt
;

4212 
	}
}

4220 
£˘‹_t
 
	$œ°_dev_addªss
(
£˘‹_t
 
s
, 
geom
 *
geo
)

4222 
s
 = (†| 
geo
->
chunk_mask
) + 1;

4223 
s
 >>
geo
->
chunk_shi·
;

4224 
s
 *
geo
->
√¨_c›õs
;

4225 
s
 = 
	`DIV_ROUND_UP_SECTOR_T
(s, 
geo
->
øid_disks
);

4226 
s
 *
geo
->
Ár_c›õs
;

4227 
s
 <<
geo
->
chunk_shi·
;

4228  
s
;

4229 
	}
}

4235 
£˘‹_t
 
	$fú°_dev_addªss
(
£˘‹_t
 
s
, 
geom
 *
geo
)

4237 
s
 >>
geo
->
chunk_shi·
;

4238 
s
 *
geo
->
√¨_c›õs
;

4239 
	`£˘‹_div
(
s
, 
geo
->
øid_disks
);

4240 
s
 *
geo
->
Ár_c›õs
;

4241 
s
 <<
geo
->
chunk_shi·
;

4242  
s
;

4243 
	}
}

4245 
£˘‹_t
 
	$ªsh≠e_ªque°
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹_ƒ
,

4246 *
skù≥d
)

4285 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4286 
r10bio
 *
r10_bio
;

4287 
£˘‹_t
 
√xt
, 
ß„
, 
œ°
;

4288 
max_£˘‹s
;

4289 
ƒ_£˘‹s
;

4290 
s
;

4291 
md_rdev
 *
rdev
;

4292 
√ed_Êush
 = 0;

4293 
bio
 *
bli°
;

4294 
bio
 *bio, *
ªad_bio
;

4295 
£˘‹s_d⁄e
 = 0;

4297 i‡(
£˘‹_ƒ
 == 0) {

4299 i‡(
mddev
->
ªsh≠e_backw¨ds
 &&

4300 
c⁄f
->
ªsh≠e_¥ogªss
 < 
	`øid10_size
(
mddev
, 0, 0)) {

4301 
£˘‹_ƒ
 = (
	`øid10_size
(
mddev
, 0, 0)

4302 - 
c⁄f
->
ªsh≠e_¥ogªss
);

4303 } i‡(!
mddev
->
ªsh≠e_backw¨ds
 &&

4304 
c⁄f
->
ªsh≠e_¥ogªss
 > 0)

4305 
£˘‹_ƒ
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4306 i‡(
£˘‹_ƒ
) {

4307 
mddev
->
cuº_ªsync_com∂ëed
 = 
£˘‹_ƒ
;

4308 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

4309 *
skù≥d
 = 1;

4310  
£˘‹_ƒ
;

4318 i‡(
mddev
->
ªsh≠e_backw¨ds
) {

4322 
√xt
 = 
	`fú°_dev_addªss
(
c⁄f
->
ªsh≠e_¥ogªss
 - 1,

4323 &
c⁄f
->
geo
);

4328 
ß„
 = 
	`œ°_dev_addªss
(
c⁄f
->
ªsh≠e_ß„
 - 1,

4329 &
c⁄f
->
¥ev
);

4331 i‡(
√xt
 + 
c⁄f
->
off£t_diff
 < 
ß„
)

4332 
√ed_Êush
 = 1;

4334 
œ°
 = 
c⁄f
->
ªsh≠e_¥ogªss
 - 1;

4335 
£˘‹_ƒ
 = 
œ°
 & ~(
£˘‹_t
)(
c⁄f
->
geo
.
chunk_mask


4336 & 
c⁄f
->
¥ev
.
chunk_mask
);

4337 i‡(
£˘‹_ƒ
 + 
RESYNC_BLOCK_SIZE
/512 < 
œ°
)

4338 
£˘‹_ƒ
 = 
œ°
 + 1 - 
RESYNC_BLOCK_SIZE
/512;

4343 
√xt
 = 
	`œ°_dev_addªss
(
c⁄f
->
ªsh≠e_¥ogªss
, &c⁄f->
geo
);

4348 
ß„
 = 
	`fú°_dev_addªss
(
c⁄f
->
ªsh≠e_ß„
, &c⁄f->
¥ev
);

4353 i‡(
√xt
 > 
ß„
 + 
c⁄f
->
off£t_diff
)

4354 
√ed_Êush
 = 1;

4356 
£˘‹_ƒ
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4357 
œ°
 = 
£˘‹_ƒ
 | (
c⁄f
->
geo
.
chunk_mask


4358 & 
c⁄f
->
¥ev
.
chunk_mask
);

4360 i‡(
£˘‹_ƒ
 + 
RESYNC_BLOCK_SIZE
/512 <
œ°
)

4361 
œ°
 = 
£˘‹_ƒ
 + 
RESYNC_BLOCK_SIZE
/512 - 1;

4364 i‡(
√ed_Êush
 ||

4365 
	`time_a·î
(
jiffõs
, 
c⁄f
->
ªsh≠e_checkpoöt
 + 10*
HZ
)) {

4367 
	`waô_b¨rõr
(
c⁄f
);

4368 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4369 i‡(
mddev
->
ªsh≠e_backw¨ds
)

4370 
mddev
->
cuº_ªsync_com∂ëed
 = 
	`øid10_size
(mddev, 0, 0)

4371 - 
c⁄f
->
ªsh≠e_¥ogªss
;

4373 
mddev
->
cuº_ªsync_com∂ëed
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4374 
c⁄f
->
ªsh≠e_checkpoöt
 = 
jiffõs
;

4375 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

4376 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4377 
	`waô_evít
(
mddev
->
sb_waô
, mddev->
Êags
 == 0 ||

4378 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
));

4379 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)) {

4380 
	`Ælow_b¨rõr
(
c⁄f
);

4381  
£˘‹s_d⁄e
;

4383 
c⁄f
->
ªsh≠e_ß„
 = 
mddev
->
ªsh≠e_posôi⁄
;

4384 
	`Ælow_b¨rõr
(
c⁄f
);

4387 
ªad_m‹e
:

4389 
r10_bio
 = 
	`mempoﬁ_Æloc
(
c⁄f
->
r10buf_poﬁ
, 
GFP_NOIO
);

4390 
r10_bio
->
°©e
 = 0;

4391 
	`øi£_b¨rõr
(
c⁄f
, 
£˘‹s_d⁄e
 != 0);

4392 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 0);

4393 
r10_bio
->
mddev
 = mddev;

4394 
r10_bio
->
£˘‹
 = 
£˘‹_ƒ
;

4395 
	`£t_bô
(
R10BIO_IsResh≠e
, &
r10_bio
->
°©e
);

4396 
r10_bio
->
£˘‹s
 = 
œ°
 - 
£˘‹_ƒ
 + 1;

4397 
rdev
 = 
	`ªad_bÆ™˚
(
c⁄f
, 
r10_bio
, &
max_£˘‹s
);

4398 
	`BUG_ON
(!
	`ã°_bô
(
R10BIO_Pªvious
, &
r10_bio
->
°©e
));

4400 i‡(!
rdev
) {

4405 
	`mempoﬁ_‰ì
(
r10_bio
, 
c⁄f
->
r10buf_poﬁ
);

4406 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

4407  
£˘‹s_d⁄e
;

4410 
ªad_bio
 = 
	`bio_Æloc_mddev
(
GFP_KERNEL
, 
RESYNC_PAGES
, 
mddev
);

4412 
ªad_bio
->
bi_bdev
 = 
rdev
->
bdev
;

4413 
ªad_bio
->
bi_ôî
.
bi_£˘‹
 = (
r10_bio
->
devs
[r10_bio->
ªad_¶Ÿ
].
addr


4414 + 
rdev
->
d©a_off£t
);

4415 
ªad_bio
->
bi_¥iv©e
 = 
r10_bio
;

4416 
ªad_bio
->
bi_íd_io
 = 
íd_sync_ªad
;

4417 
ªad_bio
->
bi_rw
 = 
READ
;

4418 
ªad_bio
->
bi_Êags
 &(~0UL << 
BIO_RESET_BITS
);

4419 
ªad_bio
->
bi_Êags
 |1 << 
BIO_UPTODATE
;

4420 
ªad_bio
->
bi_v˙t
 = 0;

4421 
ªad_bio
->
bi_ôî
.
bi_size
 = 0;

4422 
r10_bio
->
ma°î_bio
 = 
ªad_bio
;

4423 
r10_bio
->
ªad_¶Ÿ
 =Ñ10_bio->
devs
[r10_bio->ªad_¶Ÿ].
devnum
;

4426 
	`__øid10_föd_phys
(&
c⁄f
->
geo
, 
r10_bio
);

4428 
bli°
 = 
ªad_bio
;

4429 
ªad_bio
->
bi_√xt
 = 
NULL
;

4431 
s
 = 0; s < 
c⁄f
->
c›õs
*2; s++) {

4432 
bio
 *
b
;

4433 
d
 = 
r10_bio
->
devs
[
s
/2].
devnum
;

4434 
md_rdev
 *
rdev2
;

4435 i‡(
s
&1) {

4436 
rdev2
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

4437 
b
 = 
r10_bio
->
devs
[
s
/2].
ª∂_bio
;

4439 
rdev2
 = 
c⁄f
->
múr‹s
[
d
].
rdev
;

4440 
b
 = 
r10_bio
->
devs
[
s
/2].
bio
;

4442 i‡(!
rdev2
 || 
	`ã°_bô
(
Fau…y
, &rdev2->
Êags
))

4445 
	`bio_ª£t
(
b
);

4446 
b
->
bi_bdev
 = 
rdev2
->
bdev
;

4447 
b
->
bi_ôî
.
bi_£˘‹
 = 
r10_bio
->
devs
[
s
/2].
addr
 +

4448 
rdev2
->
√w_d©a_off£t
;

4449 
b
->
bi_¥iv©e
 = 
r10_bio
;

4450 
b
->
bi_íd_io
 = 
íd_ªsh≠e_wrôe
;

4451 
b
->
bi_rw
 = 
WRITE
;

4452 
b
->
bi_√xt
 = 
bli°
;

4453 
bli°
 = 
b
;

4458 
ƒ_£˘‹s
 = 0;

4459 
s
 = 0 ; s < 
max_£˘‹s
; s +
PAGE_SIZE
 >> 9) {

4460 
∑ge
 *∑gê
r10_bio
->
devs
[0].
bio
->
bi_io_vec
[
s
/(
PAGE_SIZE
>>9)].
bv_∑ge
;

4461 
Àn
 = (
max_£˘‹s
 - 
s
) << 9;

4462 i‡(
Àn
 > 
PAGE_SIZE
)

4463 
Àn
 = 
PAGE_SIZE
;

4464 
bio
 = 
bli°
; biÿ; biÿbio->
bi_√xt
) {

4465 
bio
 *
bio2
;

4466 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àn
, 0))

4470 
bio2
 = 
bli°
;

4471 
bio2
 && bio2 !
bio
;

4472 
bio2
 = bio2->
bi_√xt
) {

4474 
bio2
->
bi_v˙t
--;

4475 
bio2
->
bi_ôî
.
bi_size
 -
Àn
;

4476 
bio2
->
bi_Êags
 &~(1<<
BIO_SEG_VALID
);

4478 
bio_fuŒ
;

4480 
£˘‹_ƒ
 +
Àn
 >> 9;

4481 
ƒ_£˘‹s
 +
Àn
 >> 9;

4483 
bio_fuŒ
:

4484 
r10_bio
->
£˘‹s
 = 
ƒ_£˘‹s
;

4487 
	`md_sync_ac˘
(
ªad_bio
->
bi_bdev
, 
r10_bio
->
£˘‹s
);

4488 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

4489 
ªad_bio
->
bi_√xt
 = 
NULL
;

4490 
	`gíîic_make_ªque°
(
ªad_bio
);

4491 
£˘‹_ƒ
 +
ƒ_£˘‹s
;

4492 
£˘‹s_d⁄e
 +
ƒ_£˘‹s
;

4493 i‡(
£˘‹_ƒ
 <
œ°
)

4494 
ªad_m‹e
;

4499 i‡(
mddev
->
ªsh≠e_backw¨ds
)

4500 
c⁄f
->
ªsh≠e_¥ogªss
 -
£˘‹s_d⁄e
;

4502 
c⁄f
->
ªsh≠e_¥ogªss
 +
£˘‹s_d⁄e
;

4504  
£˘‹s_d⁄e
;

4505 
	}
}

4507 
íd_ªsh≠e_ªque°
(
r10bio
 *
r10_bio
);

4508 
h™dÀ_ªsh≠e_ªad_îr‹
(
mddev
 *mddev,

4509 
r10bio
 *
r10_bio
);

4510 
	$ªsh≠e_ªque°_wrôe
(
mddev
 *mddev, 
r10bio
 *
r10_bio
)

4517 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4518 
s
;

4520 i‡(!
	`ã°_bô
(
R10BIO_U±od©e
, &
r10_bio
->
°©e
))

4521 i‡(
	`h™dÀ_ªsh≠e_ªad_îr‹
(
mddev
, 
r10_bio
) < 0) {

4523 
	`md_d⁄e_sync
(
mddev
, 
r10_bio
->
£˘‹s
, 0);

4530 
	`©omic_£t
(&
r10_bio
->
ªmaöög
, 1);

4531 
s
 = 0; s < 
c⁄f
->
c›õs
*2; s++) {

4532 
bio
 *
b
;

4533 
d
 = 
r10_bio
->
devs
[
s
/2].
devnum
;

4534 
md_rdev
 *
rdev
;

4535 i‡(
s
&1) {

4536 
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

4537 
b
 = 
r10_bio
->
devs
[
s
/2].
ª∂_bio
;

4539 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

4540 
b
 = 
r10_bio
->
devs
[
s
/2].
bio
;

4542 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

4544 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

4545 
	`md_sync_ac˘
(
b
->
bi_bdev
, 
r10_bio
->
£˘‹s
);

4546 
	`©omic_öc
(&
r10_bio
->
ªmaöög
);

4547 
b
->
bi_√xt
 = 
NULL
;

4548 
	`gíîic_make_ªque°
(
b
);

4550 
	`íd_ªsh≠e_ªque°
(
r10_bio
);

4551 
	}
}

4553 
	$íd_ªsh≠e
(
r10c⁄f
 *
c⁄f
)

4555 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
c⁄f
->
mddev
->
ªcovîy
))

4558 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4559 
c⁄f
->
¥ev
 = c⁄f->
geo
;

4560 
	`md_föish_ªsh≠e
(
c⁄f
->
mddev
);

4561 
	`smp_wmb
();

4562 
c⁄f
->
ªsh≠e_¥ogªss
 = 
MaxSe˘‹
;

4563 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4568 i‡(
c⁄f
->
mddev
->
queue
) {

4569 
°rùe
 = 
c⁄f
->
geo
.
øid_disks
 *

4570 ((
c⁄f
->
mddev
->
chunk_£˘‹s
 << 9Ë/ 
PAGE_SIZE
);

4571 
°rùe
 /
c⁄f
->
geo
.
√¨_c›õs
;

4572 i‡(
c⁄f
->
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 < 2 * 
°rùe
)

4573 
c⁄f
->
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 = 2 * 
°rùe
;

4575 
c⁄f
->
fuŒsync
 = 0;

4576 
	}
}

4579 
	$h™dÀ_ªsh≠e_ªad_îr‹
(
mddev
 *mddev,

4580 
r10bio
 *
r10_bio
)

4583 
£˘‹s
 = 
r10_bio
->sectors;

4584 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4586 
r10bio
 
r10_bio
;

4587 
r10dev
 
devs
[
c⁄f
->
c›õs
];

4588 } 
⁄_°ack
;

4589 
r10bio
 *
r10b
 = &
⁄_°ack
.
r10_bio
;

4590 
¶Ÿ
 = 0;

4591 
idx
 = 0;

4592 
bio_vec
 *
bvec
 = 
r10_bio
->
ma°î_bio
->
bi_io_vec
;

4594 
r10b
->
£˘‹
 = 
r10_bio
->sector;

4595 
	`__øid10_föd_phys
(&
c⁄f
->
¥ev
, 
r10b
);

4597 
£˘‹s
) {

4598 
s
 = 
£˘‹s
;

4599 
suc˚ss
 = 0;

4600 
fú°_¶Ÿ
 = 
¶Ÿ
;

4602 i‡(
s
 > (
PAGE_SIZE
 >> 9))

4603 
s
 = 
PAGE_SIZE
 >> 9;

4605 !
suc˚ss
) {

4606 
d
 = 
r10b
->
devs
[
¶Ÿ
].
devnum
;

4607 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

4608 
£˘‹_t
 
addr
;

4609 i‡(
rdev
 =
NULL
 ||

4610 
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) ||

4611 !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

4612 
Áûed
;

4614 
addr
 = 
r10b
->
devs
[
¶Ÿ
].add∏+ 
idx
 * 
PAGE_SIZE
;

4615 
suc˚ss
 = 
	`sync_∑ge_io
(
rdev
,

4616 
addr
,

4617 
s
 << 9,

4618 
bvec
[
idx
].
bv_∑ge
,

4619 
READ
, 
Ál£
);

4620 i‡(
suc˚ss
)

4622 
Áûed
:

4623 
¶Ÿ
++;

4624 i‡(
¶Ÿ
 >
c⁄f
->
c›õs
)

4625 
¶Ÿ
 = 0;

4626 i‡(
¶Ÿ
 =
fú°_¶Ÿ
)

4629 i‡(!
suc˚ss
) {

4631 
	`£t_bô
(
MD_RECOVERY_INTR
,

4632 &
mddev
->
ªcovîy
);

4633  -
EIO
;

4635 
£˘‹s
 -
s
;

4636 
idx
++;

4639 
	}
}

4641 
	$íd_ªsh≠e_wrôe
(
bio
 *bio, 
îr‹
)

4643 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bio
->
bi_Êags
);

4644 
r10bio
 *
r10_bio
 = 
bio
->
bi_¥iv©e
;

4645 
mddev
 *mddev = 
r10_bio
->mddev;

4646 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4647 
d
;

4648 
¶Ÿ
;

4649 
ª∂
;

4650 
md_rdev
 *
rdev
 = 
NULL
;

4652 
d
 = 
	`föd_bio_disk
(
c⁄f
, 
r10_bio
, 
bio
, &
¶Ÿ
, &
ª∂
);

4653 i‡(
ª∂
)

4654 
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

4655 i‡(!
rdev
) {

4656 
	`smp_mb
();

4657 
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

4660 i‡(!
u±od©e
) {

4662 
	`md_îr‹
(
mddev
, 
rdev
);

4665 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

4666 
	`íd_ªsh≠e_ªque°
(
r10_bio
);

4667 
	}
}

4669 
	$íd_ªsh≠e_ªque°
(
r10bio
 *
r10_bio
)

4671 i‡(!
	`©omic_dec_™d_ã°
(&
r10_bio
->
ªmaöög
))

4673 
	`md_d⁄e_sync
(
r10_bio
->
mddev
,Ñ10_bio->
£˘‹s
, 1);

4674 
	`bio_put
(
r10_bio
->
ma°î_bio
);

4675 
	`put_buf
(
r10_bio
);

4676 
	}
}

4678 
	$øid10_föish_ªsh≠e
(
mddev
 *mddev)

4680 
r10c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4682 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

4685 i‡(
mddev
->
dñè_disks
 > 0) {

4686 
£˘‹_t
 
size
 = 
	`øid10_size
(
mddev
, 0, 0);

4687 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
size
);

4688 i‡(
mddev
->
ªcovîy_˝
 > mddev->
ªsync_max_£˘‹s
) {

4689 
mddev
->
ªcovîy_˝
 = mddev->
ªsync_max_£˘‹s
;

4690 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

4692 
mddev
->
ªsync_max_£˘‹s
 = 
size
;

4693 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

4694 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

4696 
d
;

4697 
d
 = 
c⁄f
->
geo
.
øid_disks
 ;

4698 
d
 < 
c⁄f
->
geo
.
øid_disks
 - 
mddev
->
dñè_disks
;

4699 
d
++) {

4700 
md_rdev
 *
rdev
 = 
c⁄f
->
múr‹s
[
d
].rdev;

4701 i‡(
rdev
)

4702 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

4703 
rdev
 = 
c⁄f
->
múr‹s
[
d
].
ª∂a˚mít
;

4704 i‡(
rdev
)

4705 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

4708 
mddev
->
œyout
 = mddev->
√w_œyout
;

4709 
mddev
->
chunk_£˘‹s
 = 1 << 
c⁄f
->
geo
.
chunk_shi·
;

4710 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

4711 
mddev
->
dñè_disks
 = 0;

4712 
mddev
->
ªsh≠e_backw¨ds
 = 0;

4713 
	}
}

4715 
md_≥rs⁄Æôy
 
	gøid10_≥rs⁄Æôy
 =

4717 .
«me
 = "raid10",

4718 .
	gÀvñ
 = 10,

4719 .
	gow√r
 = 
THIS_MODULE
,

4720 .
	gmake_ªque°
 = 
make_ªque°
,

4721 .
	grun
 = 
run
,

4722 .
	g°›
 = 
°›
,

4723 .
	g°©us
 = 
°©us
,

4724 .
	gîr‹_h™dÀr
 = 
îr‹
,

4725 .
	ghŸ_add_disk
 = 
øid10_add_disk
,

4726 .
	ghŸ_ªmove_disk

øid10_ªmove_disk
,

4727 .
	g•¨e_a˘ive
 = 
øid10_•¨e_a˘ive
,

4728 .
	gsync_ªque°
 = 
sync_ªque°
,

4729 .
	gquõs˚
 = 
øid10_quõs˚
,

4730 .
	gsize
 = 
øid10_size
,

4731 .
	gªsize
 = 
øid10_ªsize
,

4732 .
	gèkeovî
 = 
øid10_èkeovî
,

4733 .
	gcheck_ªsh≠e
 = 
øid10_check_ªsh≠e
,

4734 .
	g°¨t_ªsh≠e
 = 
øid10_°¨t_ªsh≠e
,

4735 .
	gföish_ªsh≠e
 = 
øid10_föish_ªsh≠e
,

4738 
__öô
 
	$øid_öô
()

4740  
	`ªgi°î_md_≥rs⁄Æôy
(&
øid10_≥rs⁄Æôy
);

4741 
	}
}

4743 
	$øid_exô
()

4745 
	`uƒegi°î_md_≥rs⁄Æôy
(&
øid10_≥rs⁄Æôy
);

4746 
	}
}

4748 
moduÀ_öô
(
øid_öô
);

4749 
moduÀ_exô
(
øid_exô
);

4750 
MODULE_LICENSE
("GPL");

4751 
MODULE_DESCRIPTION
("RAID10 (striped mirror)Öersonality for MD");

4752 
MODULE_ALIAS
("md-personality-9");

4753 
MODULE_ALIAS
("md-raid10");

4754 
MODULE_ALIAS
("md-level-10");

4756 
moduÀ_∑øm
(
max_queued_ªque°s
, , 
S_IRUGO
|
S_IWUSR
);

	@raid10.h

1 #i‚de‡
_RAID10_H


2 
	#_RAID10_H


	)

4 
	søid10_öfo
 {

5 
md_rdev
 *
	mrdev
, *
	mª∂a˚mít
;

6 
£˘‹_t
 
	mhód_posôi⁄
;

7 
	mªcovîy_dißbÀd
;

14 
	sr10c⁄f
 {

15 
mddev
 *
	mmddev
;

16 
øid10_öfo
 *
	mmúr‹s
;

17 
øid10_öfo
 *
	mmúr‹s_√w
, *
	mmúr‹s_ﬁd
;

18 
•ölock_t
 
	mdevi˚_lock
;

21 
	sgeom
 {

22 
	møid_disks
;

23 
	m√¨_c›õs
;

25 
	mÁr_c›õs
;

28 
	mÁr_off£t
;

31 
£˘‹_t
 
	m°ride
;

36 
	mÁr_£t_size
;

41 
	mchunk_shi·
;

42 
£˘‹_t
 
	mchunk_mask
;

43 } 
	m¥ev
, 
	mgeo
;

44 
	mc›õs
;

48 
£˘‹_t
 
	mdev_£˘‹s
;

50 
£˘‹_t
 
	mªsh≠e_¥ogªss
;

51 
£˘‹_t
 
	mªsh≠e_ß„
;

52 
	mªsh≠e_checkpoöt
;

53 
£˘‹_t
 
	moff£t_diff
;

55 
li°_hód
 
	mªåy_li°
;

57 
bio_li°
 
	m≥ndög_bio_li°
;

58 
	m≥ndög_cou¡
;

60 
•ölock_t
 
	mªsync_lock
;

61 
	mƒ_≥ndög
;

62 
	mƒ_waôög
;

63 
	mƒ_queued
;

64 
	mb¨rõr
;

65 
£˘‹_t
 
	m√xt_ªsync
;

66 
	mfuŒsync
;

70 
	mhave_ª∂a˚mít
;

73 
waô_queue_hód_t
 
	mwaô_b¨rõr
;

75 
mempoﬁ_t
 *
	mr10bio_poﬁ
;

76 
mempoﬁ_t
 *
	mr10buf_poﬁ
;

77 
∑ge
 *
	mtmµage
;

82 
md_thªad
 *
	mthªad
;

92 
	sr10bio
 {

93 
©omic_t
 
	mªmaöög
;

96 
£˘‹_t
 
	m£˘‹
;

97 
	m£˘‹s
;

98 
	m°©e
;

99 
mddev
 *
	mmddev
;

103 
bio
 *
	mma°î_bio
;

107 
	mªad_¶Ÿ
;

109 
li°_hód
 
	mªåy_li°
;

118 
	sr10dev
 {

119 
bio
 *
	mbio
;

121 
bio
 *
	mª∂_bio
;

123 
md_rdev
 *
	mrdev
;

126 
£˘‹_t
 
	maddr
;

127 
	mdevnum
;

128 } 
	mdevs
[0];

132 
	er10bio_°©e
 {

133 
	mR10BIO_U±od©e
,

134 
	mR10BIO_IsSync
,

135 
	mR10BIO_IsRecovî
,

136 
	mR10BIO_IsResh≠e
,

137 
	mR10BIO_Degøded
,

141 
	mR10BIO_RódEº‹
,

145 
	mR10BIO_MadeGood
,

146 
	mR10BIO_WrôeEº‹
,

151 
	mR10BIO_Pªvious
,

154 
md_øid10_c⁄ge°ed
(
mddev
 *mddev, 
bôs
);

	@raid10.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xc1eb978a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_mîge_bvec
) },

24 { 0x543b4234, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

25 { 0xeb594c85, 
__VMLINUX_SYMBOL_STR
(
bio_•lô
) },

26 { 0x153e70d9, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

27 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

28 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

29 { 0x7b56f141, 
__VMLINUX_SYMBOL_STR
(
submô_bio_waô
) },

30 { 0x9e4f2af3, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_›t
) },

31 { 0x3d69f5a0, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_bio£t
) },

32 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

33 { 0xc24e2400, 
__VMLINUX_SYMBOL_STR
(
rdev_£t_badblocks
) },

34 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

35 { 0xb6b46a7c, 
__VMLINUX_SYMBOL_STR
(
∑øm_›s_öt
) },

36 { 0x412fc7c2, 
__VMLINUX_SYMBOL_STR
(
md_is_badblock
) },

37 { 0xb78f29de, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_mddev
) },

38 { 0x6c3e048, 
__VMLINUX_SYMBOL_STR
(
bio_Æloc_mddev
) },

39 { 0x21e3985c, 
__VMLINUX_SYMBOL_STR
(
md_check_ªcovîy
) },

40 { 0x1a79d6e1, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_mö
) },

41 { 0x2a62f6ó, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_íd
) },

42 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

43 { 0x28624bc7, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ídwrôe
) },

44 { 0xefba93e1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_de°roy
) },

45 { 0x8c6766ba, 
__VMLINUX_SYMBOL_STR
(
bôm≠_u≈lug
) },

46 { 0x2Á06db6, 
__VMLINUX_SYMBOL_STR
(
bio_åim
) },

47 { 0x83c23d12, 
__VMLINUX_SYMBOL_STR
(
md_√w_evít
) },

48 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

49 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

50 { 0x5c750c00, 
__VMLINUX_SYMBOL_STR
(
ªvÆid©e_disk
) },

51 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

52 { 0xìff458e, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ªsize
) },

53 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

54 { 0xc3639d5e, 
__VMLINUX_SYMBOL_STR
(
bio_ª£t
) },

55 { 0x78b3a75f, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨t_sync
) },

56 { 0xd27b25dd, 
__VMLINUX_SYMBOL_STR
(
blk_check_∂ugged
) },

57 { 0x7723Øab, 
__VMLINUX_SYMBOL_STR
(
md_ªgi°î_thªad
) },

58 { 0x4101c3c9, 
__VMLINUX_SYMBOL_STR
(
md_Êush_ªque°
) },

59 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

60 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

61 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

62 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

63 { 0x33506218, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_disˇrd_£˘‹s
) },

64 { 0xd14e5bc6, 
__VMLINUX_SYMBOL_STR
(
bio_add_∑ge
) },

65 { 0x98a45556, 
__VMLINUX_SYMBOL_STR
(
md_do_sync
) },

66 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

67 { 0xb2ìc3d, 
__VMLINUX_SYMBOL_STR
(
bôm≠_˛o£_sync
) },

68 { 0xfb254830, 
__VMLINUX_SYMBOL_STR
(
bio_chaö
) },

69 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

70 { 0x8c0603d0, 
__VMLINUX_SYMBOL_STR
(
blk_sync_queue
) },

71 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchr⁄ize_sched
) },

72 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

73 { 0x669183e6, 
__VMLINUX_SYMBOL_STR
(
md_waô_f‹_blocked_rdev
) },

74 { 0xˇ8c76e1, 
__VMLINUX_SYMBOL_STR
(
__gë_∑ge_èû
) },

75 { 0x2c˚a702, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_add_rdev
) },

76 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

77 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

78 { 0xfc5b7524, 
__VMLINUX_SYMBOL_STR
(
md_d⁄e_sync
) },

79 { 0x210fd9b, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_lök
) },

80 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

81 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

82 { 0x4af67747, 
__VMLINUX_SYMBOL_STR
(
bôm≠_c⁄d_íd_sync
) },

83 { 0xe9dff136, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_Æloc
) },

84 { 0xc16fc560, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_°¨t
) },

85 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

86 { 0xd98d7985, 
__VMLINUX_SYMBOL_STR
(
rdev_˛ór_badblocks
) },

87 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

88 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

89 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

90 { 0x3f71Áa1, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_¸óã
) },

91 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

92 { 0x466356fd, 
__VMLINUX_SYMBOL_STR
(
sysfs_nŸify
) },

93 { 0xc90c172a, 
__VMLINUX_SYMBOL_STR
(
md_wakeup_thªad
) },

94 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

95 { 0xcc5005„, 
__VMLINUX_SYMBOL_STR
(
m¶ìp_öãºu±ibÀ
) },

96 { 0x7d788265, 
__VMLINUX_SYMBOL_STR
(
kînfs_nŸify
) },

97 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

98 { 0x4Ød52d7, 
__VMLINUX_SYMBOL_STR
(
mempoﬁ_‰ì
) },

99 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

100 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

101 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

102 { 0x5ab10213, 
__VMLINUX_SYMBOL_STR
(
sync_∑ge_io
) },

103 { 0x4c107f4a, 
__VMLINUX_SYMBOL_STR
(
md_uƒegi°î_thªad
) },

104 { 0xcb194cc4, 
__VMLINUX_SYMBOL_STR
(
md_föish_ªsh≠e
) },

105 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

106 { 0x2db8046c, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨twrôe
) },

107 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

108 { 0x1b82„Á, 
__VMLINUX_SYMBOL_STR
(
md_u≈lug
) },

109 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

110 { 0x2f6da7a9, 
__VMLINUX_SYMBOL_STR
(
md_îr‹
) },

111 { 0x88c6f˚5, 
__VMLINUX_SYMBOL_STR
(
put_∑ge
) },

112 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

113 { 0xd56b5f64, 
__VMLINUX_SYMBOL_STR
(
ktime_gë_ts64
) },

114 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

115 { 0x3cb8db59, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_wrôe_ßme_£˘‹s
) },

116 { 0x719b4945, 
__VMLINUX_SYMBOL_STR
(
md_öãgrôy_ªgi°î
) },

117 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

118 { 0xa73a„00, 
__VMLINUX_SYMBOL_STR
(
bôm≠_íd_sync
) },

121 c⁄° 
	g__moduÀ_dïíds
[]

122 
__u£d


123 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

127 
MODULE_INFO
(
§cvîsi⁄
, "5A8F7DF06FC50F39CC1D57B");

	@raid456.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
__visibÀ
 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
öåì
, "Y");

19 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

20 
__u£d


21 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

22 { 0x8b325cc0, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

23 { 0xc1eb978a, 
__VMLINUX_SYMBOL_STR
(
blk_queue_mîge_bvec
) },

24 { 0x543b4234, 
__VMLINUX_SYMBOL_STR
(
Æloc_∑ges_cuºít
) },

25 { 0xb76552eb, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

26 { 0x4ˇ4f9d8, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

27 { 0xd2b09˚5, 
__VMLINUX_SYMBOL_STR
(
__kmÆloc
) },

28 { 0xf0f38c77, 
__VMLINUX_SYMBOL_STR
(
async_øid6_d©≠_ªcov
) },

29 { 0x9e4f2af3, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_›t
) },

30 { 0x5ed9575c, 
__VMLINUX_SYMBOL_STR
(
mddev_c⁄ge°ed
) },

31 { 0xc24e2400, 
__VMLINUX_SYMBOL_STR
(
rdev_£t_badblocks
) },

32 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock
) },

33 { 0x784213a6, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

34 { 0xd0ì38b8, 
__VMLINUX_SYMBOL_STR
(
scheduÀ_timeout_unöãºu±ibÀ
) },

35 { 0x412fc7c2, 
__VMLINUX_SYMBOL_STR
(
md_is_badblock
) },

36 { 0xc7a1840e, 
__VMLINUX_SYMBOL_STR
(
Œi°_add_b©ch
) },

37 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__Æloc_w‹kqueue_key
) },

38 { 0xb78f29de, 
__VMLINUX_SYMBOL_STR
(
bio_˛⁄e_mddev
) },

39 { 0xc8b57c27, 
__VMLINUX_SYMBOL_STR
(
aut‹emove_wake_fun˘i⁄
) },

40 { 0xbd100793, 
__VMLINUX_SYMBOL_STR
(
˝u_⁄löe_mask
) },

41 { 0x6755˚92, 
__VMLINUX_SYMBOL_STR
(
mddev_su•íd
) },

42 { 0x32bded08, 
__VMLINUX_SYMBOL_STR
(
__åa˚poöt_block_bio_ªm≠
) },

43 { 0x21e3985c, 
__VMLINUX_SYMBOL_STR
(
md_check_ªcovîy
) },

44 { 0xc0a3d105, 
__VMLINUX_SYMBOL_STR
(
föd_√xt_bô
) },

45 { 0x1a79d6e1, 
__VMLINUX_SYMBOL_STR
(
blk_queue_io_mö
) },

46 { 0x2a62f6ó, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_íd
) },

47 { 0x3465f˚6, 
__VMLINUX_SYMBOL_STR
(
__åa˚poöt_block_bio_com∂ëe
) },

48 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

49 { 0xacf7679, 
__VMLINUX_SYMBOL_STR
(
dma_issue_≥ndög_Æl
) },

50 { 0xf087137d, 
__VMLINUX_SYMBOL_STR
(
__dy«mic_¥_debug
) },

51 { 0x28624bc7, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ídwrôe
) },

52 { 0x8c6766ba, 
__VMLINUX_SYMBOL_STR
(
bôm≠_u≈lug
) },

53 { 0x949f7342, 
__VMLINUX_SYMBOL_STR
(
__Æloc_≥r˝u
) },

54 { 0x571f1c47, 
__VMLINUX_SYMBOL_STR
(
async_syndrome_vÆ
) },

55 { 0x83c23d12, 
__VMLINUX_SYMBOL_STR
(
md_√w_evít
) },

56 { 0x4224ec8a, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_md_≥rs⁄Æôy
) },

57 { 0x7a2af7b4, 
__VMLINUX_SYMBOL_STR
(
˝u_numbî
) },

58 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

59 { 0x5c750c00, 
__VMLINUX_SYMBOL_STR
(
ªvÆid©e_disk
) },

60 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

61 { 0xc9ec4e21, 
__VMLINUX_SYMBOL_STR
(
‰ì_≥r˝u
) },

62 { 0xìff458e, 
__VMLINUX_SYMBOL_STR
(
bôm≠_ªsize
) },

63 { 0xec730387, 
__VMLINUX_SYMBOL_STR
(
_©omic_dec_™d_lock
) },

64 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__öô_waôqueue_hód
) },

65 { 0x„7c4287, 
__VMLINUX_SYMBOL_STR
(
ƒ_˝u_ids
) },

66 { 0xc3639d5e, 
__VMLINUX_SYMBOL_STR
(
bio_ª£t
) },

67 { 0x78b3a75f, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨t_sync
) },

68 { 0xd27b25dd, 
__VMLINUX_SYMBOL_STR
(
blk_check_∂ugged
) },

69 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k°πouŒ
) },

70 { 0x7723Øab, 
__VMLINUX_SYMBOL_STR
(
md_ªgi°î_thªad
) },

71 { 0xe693f9c5, 
__VMLINUX_SYMBOL_STR
(
bio_öô
) },

72 { 0x4101c3c9, 
__VMLINUX_SYMBOL_STR
(
md_Êush_ªque°
) },

73 { 0x8f64Ø4, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_u∆ock_úqª°‹e
) },

74 { 0x2ec1c843, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

75 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

76 { 0xad0e96da, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_group
) },

77 { 0x98a45556, 
__VMLINUX_SYMBOL_STR
(
md_do_sync
) },

78 { 0x8„ffb4c, 
__VMLINUX_SYMBOL_STR
(
async_øid6_2d©a_ªcov
) },

79 { 0x˚24d0b1, 
__VMLINUX_SYMBOL_STR
(
async_åiggî_ˇŒback
) },

80 { 0xì032b56, 
__VMLINUX_SYMBOL_STR
(
disk_°ack_limôs
) },

81 { 0xb2ìc3d, 
__VMLINUX_SYMBOL_STR
(
bôm≠_˛o£_sync
) },

82 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

83 { 0x80d3927f, 
__VMLINUX_SYMBOL_STR
(
__åa˚poöt_block_u≈lug
) },

84 { 0x5406d4ec, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_‰ì
) },

85 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_nuŒ
) },

86 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de°roy_w‹kqueue
) },

87 { 0x341cbed2, 
__VMLINUX_SYMBOL_STR
(
˝u_¥e£¡_mask
) },

88 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchr⁄ize_sched
) },

89 { 0x95045732, 
__VMLINUX_SYMBOL_STR
(
async_mem˝y
) },

90 { 0xc3e67731, 
__VMLINUX_SYMBOL_STR
(
blk_ªcou¡_£gmíts
) },

91 { 0x4a479984, 
__VMLINUX_SYMBOL_STR
(
gíîic_make_ªque°
) },

92 { 0x669183e6, 
__VMLINUX_SYMBOL_STR
(
md_waô_f‹_blocked_rdev
) },

93 { 0x42160169, 
__VMLINUX_SYMBOL_STR
(
Êush_w‹kqueue
) },

94 { 0x9b52dd2d, 
__VMLINUX_SYMBOL_STR
(
bio_ídio
) },

95 { 0x4f0c3029, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

96 { 0x9f46˚d8, 
__VMLINUX_SYMBOL_STR
(
__sw_hweight64
) },

97 { 0x73d8cb6e, 
__VMLINUX_SYMBOL_STR
(
Êush_sig«ls
) },

98 { 0xfc5b7524, 
__VMLINUX_SYMBOL_STR
(
md_d⁄e_sync
) },

99 { 0x1„9f800, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_˝u_nŸifõr
) },

100 { 0x210fd9b, 
__VMLINUX_SYMBOL_STR
(
sysfs_¸óã_lök
) },

101 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_föish_∂ug
) },

102 { 0xc59˚114, 
__VMLINUX_SYMBOL_STR
(
async_x‹_vÆ
) },

103 { 0xc4d6c774, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc
) },

104 { 0x78764f4e, 
__VMLINUX_SYMBOL_STR
(
pv_úq_›s
) },

105 { 0x4af67747, 
__VMLINUX_SYMBOL_STR
(
bôm≠_c⁄d_íd_sync
) },

106 { 0x99836851, 
__VMLINUX_SYMBOL_STR
(
async_x‹
) },

107 { 0x618911fc, 
__VMLINUX_SYMBOL_STR
(
numa_node
) },

108 { 0xddb1cd7, 
__VMLINUX_SYMBOL_STR
(
Œi°_ªvî£_‹dî
) },

109 { 0xc16fc560, 
__VMLINUX_SYMBOL_STR
(
md_wrôe_°¨t
) },

110 { 0x8b43159b, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_˝u_nŸifõr
) },

111 { 0x842708d6, 
__VMLINUX_SYMBOL_STR
(
bdev«me
) },

112 { 0xde11dbbf, 
__VMLINUX_SYMBOL_STR
(
__åa˚_nŸe_mesßge
) },

113 { 0x1a73f60e, 
__VMLINUX_SYMBOL_STR
(
async_tx_quõs˚
) },

114 { 0xd98d7985, 
__VMLINUX_SYMBOL_STR
(
rdev_˛ór_badblocks
) },

115 { 0xb9249d16, 
__VMLINUX_SYMBOL_STR
(
˝u_possibÀ_mask
) },

116 { 0x4b0f0127, 
__VMLINUX_SYMBOL_STR
(
md_Ælow_wrôe
) },

117 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduÀ
) },

118 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

119 { 0xd7d79132, 
__VMLINUX_SYMBOL_STR
(
put_⁄löe_˝us
) },

120 { 0x4332582f, 
__VMLINUX_SYMBOL_STR
(
md_£t_¨øy_£˘‹s
) },

121 { 0x43261dˇ, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úq
) },

122 { 0x466356fd, 
__VMLINUX_SYMBOL_STR
(
sysfs_nŸify
) },

123 { 0xc90c172a, 
__VMLINUX_SYMBOL_STR
(
md_wakeup_thªad
) },

124 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

125 { 0x3efb35c9, 
__VMLINUX_SYMBOL_STR
(
gë_⁄löe_˝us
) },

126 { 0x7d788265, 
__VMLINUX_SYMBOL_STR
(
kînfs_nŸify
) },

127 { 0xeddb98c1, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

128 { 0x61fb248a, 
__VMLINUX_SYMBOL_STR
(
node_°©es
) },

129 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

130 { 0x3928e„9, 
__VMLINUX_SYMBOL_STR
(
__≥r_˝u_off£t
) },

131 { 0x9327f5˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock_úqßve
) },

132 { 0xa85d2821, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

133 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

134 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô_evít
) },

135 { 0x1e047854, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_fmt
) },

136 { 0x4c107f4a, 
__VMLINUX_SYMBOL_STR
(
md_uƒegi°î_thªad
) },

137 { 0xe7f9e803, 
__VMLINUX_SYMBOL_STR
(
async_gí_syndrome
) },

138 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

139 { 0x2db8046c, 
__VMLINUX_SYMBOL_STR
(
bôm≠_°¨twrôe
) },

140 { 0x5c8b5˚8, 
__VMLINUX_SYMBOL_STR
(
¥ï¨e_to_waô
) },

141 { 0xd3719d59, 
__VMLINUX_SYMBOL_STR
(
∑øvút_tickëlocks_íabÀd
) },

142 { 0x2f6da7a9, 
__VMLINUX_SYMBOL_STR
(
md_îr‹
) },

143 { 0x88c6f˚5, 
__VMLINUX_SYMBOL_STR
(
put_∑ge
) },

144 { 0xb352177e, 
__VMLINUX_SYMBOL_STR
(
föd_fú°_bô
) },

145 { 0xÁ66f77c, 
__VMLINUX_SYMBOL_STR
(
föish_waô
) },

146 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_w‹k_⁄
) },

147 { 0xc01bc255, 
__VMLINUX_SYMBOL_STR
(
mddev_ªsume
) },

148 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_°¨t_∂ug
) },

149 { 0x3cb8db59, 
__VMLINUX_SYMBOL_STR
(
blk_queue_max_wrôe_ßme_£˘‹s
) },

150 { 0x6718077, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_md_≥rs⁄Æôy
) },

151 { 0xa73a„00, 
__VMLINUX_SYMBOL_STR
(
bôm≠_íd_sync
) },

154 c⁄° 
	g__moduÀ_dïíds
[]

155 
__u£d


156 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

160 
MODULE_INFO
(
§cvîsi⁄
, "F01BD8909000AC04F3E5EC9");

	@raid5.c

46 
	~<löux/blkdev.h
>

47 
	~<löux/kthªad.h
>

48 
	~<löux/øid/pq.h
>

49 
	~<löux/async_tx.h
>

50 
	~<löux/moduÀ.h
>

51 
	~<löux/async.h
>

52 
	~<löux/£q_fûe.h
>

53 
	~<löux/˝u.h
>

54 
	~<löux/¶ab.h
>

55 
	~<löux/øãlimô.h
>

56 
	~<löux/nodemask.h
>

57 
	~<åa˚/evíts/block.h
>

59 
	~"md.h
"

60 
	~"øid5.h
"

61 
	~"øid0.h
"

62 
	~"bôm≠.h
"

64 
	#˝u_to_group
(
˝u
Ë
	`˝u_to_node
(˝u)

	)

65 
	#ANY_GROUP
 
NUMA_NO_NODE


	)

67 
w‹kqueue_°ru˘
 *
	gøid5_wq
;

72 
	#NR_STRIPES
 256

	)

73 
	#STRIPE_SIZE
 
PAGE_SIZE


	)

74 
	#STRIPE_SHIFT
 (
PAGE_SHIFT
 - 9)

	)

75 
	#STRIPE_SECTORS
 (
STRIPE_SIZE
>>9)

	)

76 
	#IO_THRESHOLD
 1

	)

77 
	#BYPASS_THRESHOLD
 1

	)

78 
	#NR_HASH
 (
PAGE_SIZE
 / (
hli°_hód
))

	)

79 
	#HASH_MASK
 (
NR_HASH
 - 1)

	)

80 
	#MAX_STRIPE_BATCH
 8

	)

82 
ölöe
 
hli°_hód
 *
	$°rùe_hash
(
r5c⁄f
 *
c⁄f
, 
£˘‹_t
 
£˘
)

84 
hash
 = (
£˘
 >> 
STRIPE_SHIFT
Ë& 
HASH_MASK
;

85  &
c⁄f
->
°rùe_hashtbl
[
hash
];

86 
	}
}

88 
ölöe
 
	$°rùe_hash_locks_hash
(
£˘‹_t
 
£˘
)

90  (
£˘
 >> 
STRIPE_SHIFT
Ë& 
STRIPE_HASH_LOCKS_MASK
;

91 
	}
}

93 
ölöe
 
	$lock_devi˚_hash_lock
(
r5c⁄f
 *
c⁄f
, 
hash
)

95 
	`•ö_lock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

96 
	`•ö_lock
(&
c⁄f
->
devi˚_lock
);

97 
	}
}

99 
ölöe
 
	$u∆ock_devi˚_hash_lock
(
r5c⁄f
 *
c⁄f
, 
hash
)

101 
	`•ö_u∆ock
(&
c⁄f
->
devi˚_lock
);

102 
	`•ö_u∆ock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

103 
	}
}

105 
ölöe
 
	$lock_Æl_devi˚_hash_locks_úq
(
r5c⁄f
 *
c⁄f
)

107 
i
;

108 
	`loˇl_úq_dißbÀ
();

109 
	`•ö_lock
(
c⁄f
->
hash_locks
);

110 
i
 = 1; i < 
NR_STRIPE_HASH_LOCKS
; i++)

111 
	`•ö_lock_√°_lock
(
c⁄f
->
hash_locks
 + 
i
, conf->hash_locks);

112 
	`•ö_lock
(&
c⁄f
->
devi˚_lock
);

113 
	}
}

115 
ölöe
 
	$u∆ock_Æl_devi˚_hash_locks_úq
(
r5c⁄f
 *
c⁄f
)

117 
i
;

118 
	`•ö_u∆ock
(&
c⁄f
->
devi˚_lock
);

119 
i
 = 
NR_STRIPE_HASH_LOCKS
; i; i--)

120 
	`•ö_u∆ock
(
c⁄f
->
hash_locks
 + 
i
 - 1);

121 
	`loˇl_úq_íabÀ
();

122 
	}
}

133 
ölöe
 
bio
 *
	$r5_√xt_bio
(
bio
 *bio, 
£˘‹_t
 
£˘‹
)

135 
£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

136 i‡(
bio
->
bi_ôî
.
bi_£˘‹
 + 
£˘‹s
 < 
£˘‹
 + 
STRIPE_SECTORS
)

137  
bio
->
bi_√xt
;

139  
NULL
;

140 
	}
}

146 
ölöe
 
	$øid5_bi_¥o˚s£d_°rùes
(
bio
 *bio)

148 
©omic_t
 *
£gmíts
 = (©omic_à*)&
bio
->
bi_phys_£gmíts
;

149  (
	`©omic_ªad
(
£gmíts
) >> 16) & 0xffff;

150 
	}
}

152 
ölöe
 
	$øid5_dec_bi_a˘ive_°rùes
(
bio
 *bio)

154 
©omic_t
 *
£gmíts
 = (©omic_à*)&
bio
->
bi_phys_£gmíts
;

155  
	`©omic_sub_ªtu∫
(1, 
£gmíts
) & 0xffff;

156 
	}
}

158 
ölöe
 
	$øid5_öc_bi_a˘ive_°rùes
(
bio
 *bio)

160 
©omic_t
 *
£gmíts
 = (©omic_à*)&
bio
->
bi_phys_£gmíts
;

161 
	`©omic_öc
(
£gmíts
);

162 
	}
}

164 
ölöe
 
	$øid5_£t_bi_¥o˚s£d_°rùes
(
bio
 *bio,

165 
˙t
)

167 
©omic_t
 *
£gmíts
 = (©omic_à*)&
bio
->
bi_phys_£gmíts
;

168 
ﬁd
, 
√w
;

171 
ﬁd
 = 
	`©omic_ªad
(
£gmíts
);

172 
√w
 = (
ﬁd
 & 0xffffË| (
˙t
 << 16);

173 } 
	`©omic_cmpxchg
(
£gmíts
, 
ﬁd
, 
√w
) != old);

174 
	}
}

176 
ölöe
 
	$øid5_£t_bi_°rùes
(
bio
 *bio, 
˙t
)

178 
©omic_t
 *
£gmíts
 = (©omic_à*)&
bio
->
bi_phys_£gmíts
;

179 
	`©omic_£t
(
£gmíts
, 
˙t
);

180 
	}
}

183 
ölöe
 
	$øid6_d0
(
°rùe_hód
 *
sh
)

185 i‡(
sh
->
ddf_œyout
)

189 i‡(
sh
->
qd_idx
 =sh->
disks
 - 1)

192  
sh
->
qd_idx
 + 1;

193 
	}
}

194 
ölöe
 
	$øid6_√xt_disk
(
disk
, 
øid_disks
)

196 
disk
++;

197  (
disk
 < 
øid_disks
) ? disk : 0;

198 
	}
}

205 
	$øid6_idx_to_¶Ÿ
(
idx
, 
°rùe_hód
 *
sh
,

206 *
cou¡
, 
syndrome_disks
)

208 
¶Ÿ
 = *
cou¡
;

210 i‡(
sh
->
ddf_œyout
)

211 (*
cou¡
)++;

212 i‡(
idx
 =
sh
->
pd_idx
)

213  
syndrome_disks
;

214 i‡(
idx
 =
sh
->
qd_idx
)

215  
syndrome_disks
 + 1;

216 i‡(!
sh
->
ddf_œyout
)

217 (*
cou¡
)++;

218  
¶Ÿ
;

219 
	}
}

221 
	$ªtu∫_io
(
bio
 *
ªtu∫_bi
)

223 
bio
 *
bi
 = 
ªtu∫_bi
;

224 
bi
) {

226 
ªtu∫_bi
 = 
bi
->
bi_√xt
;

227 
bi
->
bi_√xt
 = 
NULL
;

228 
bi
->
bi_ôî
.
bi_size
 = 0;

229 
	`åa˚_block_bio_com∂ëe
(
	`bdev_gë_queue
(
bi
->
bi_bdev
),

230 
bi
, 0);

231 
	`bio_ídio
(
bi
, 0);

232 
bi
 = 
ªtu∫_bi
;

234 
	}
}

236 
¥öt_øid5_c⁄f
 (
r5c⁄f
 *
c⁄f
);

238 
	$°rùe_›î©i⁄s_a˘ive
(
°rùe_hód
 *
sh
)

240  
sh
->
check_°©e
 || sh->
ªc⁄°ru˘_°©e
 ||

241 
	`ã°_bô
(
STRIPE_BIOFILL_RUN
, &
sh
->
°©e
) ||

242 
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

243 
	}
}

245 
	$øid5_wakeup_°rùe_thªad
(
°rùe_hód
 *
sh
)

247 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

248 
r5w‹kî_group
 *
group
;

249 
thªad_˙t
;

250 
i
, 
˝u
 = 
sh
->cpu;

252 i‡(!
	`˝u_⁄löe
(
˝u
)) {

253 
˝u
 = 
	`˝umask_™y
(
˝u_⁄löe_mask
);

254 
sh
->
˝u
 = cpu;

257 i‡(
	`li°_em±y
(&
sh
->
Ãu
)) {

258 
r5w‹kî_group
 *
group
;

259 
group
 = 
c⁄f
->
w‹kî_groups
 + 
	`˝u_to_group
(
˝u
);

260 
	`li°_add_èû
(&
sh
->
Ãu
, &
group
->
h™dÀ_li°
);

261 
group
->
°rùes_˙t
++;

262 
sh
->
group
 = group;

265 i‡(
c⁄f
->
w‹kî_˙t_≥r_group
 == 0) {

266 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

270 
group
 = 
c⁄f
->
w‹kî_groups
 + 
	`˝u_to_group
(
sh
->
˝u
);

272 
group
->
w‹kîs
[0].
w‹kög
 = 
åue
;

274 
	`queue_w‹k_⁄
(
sh
->
˝u
, 
øid5_wq
, &
group
->
w‹kîs
[0].
w‹k
);

276 
thªad_˙t
 = 
group
->
°rùes_˙t
 / 
MAX_STRIPE_BATCH
 - 1;

278 
i
 = 1; i < 
c⁄f
->
w‹kî_˙t_≥r_group
 && 
thªad_˙t
 > 0; i++) {

279 i‡(
group
->
w‹kîs
[
i
].
w‹kög
 =
Ál£
) {

280 
group
->
w‹kîs
[
i
].
w‹kög
 = 
åue
;

281 
	`queue_w‹k_⁄
(
sh
->
˝u
, 
øid5_wq
,

282 &
group
->
w‹kîs
[
i
].
w‹k
);

283 
thªad_˙t
--;

286 
	}
}

288 
	$do_ªÀa£_°rùe
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

289 
li°_hód
 *
ãmp_öa˘ive_li°
)

291 
	`BUG_ON
(!
	`li°_em±y
(&
sh
->
Ãu
));

292 
	`BUG_ON
(
	`©omic_ªad
(&
c⁄f
->
a˘ive_°rùes
)==0);

293 i‡(
	`ã°_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
)) {

294 i‡(
	`ã°_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
) &&

295 !
	`ã°_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
)) {

296 
	`li°_add_èû
(&
sh
->
Ãu
, &
c⁄f
->
dñayed_li°
);

297 i‡(
	`©omic_ªad
(&
c⁄f
->
¥îód_a˘ive_°rùes
)

298 < 
IO_THRESHOLD
)

299 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

300 } i‡(
	`ã°_bô
(
STRIPE_BIT_DELAY
, &
sh
->
°©e
) &&

301 
sh
->
bm_£q
 - 
c⁄f
->
£q_wrôe
 > 0)

302 
	`li°_add_èû
(&
sh
->
Ãu
, &
c⁄f
->
bôm≠_li°
);

304 
	`˛ór_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

305 
	`˛ór_bô
(
STRIPE_BIT_DELAY
, &
sh
->
°©e
);

306 i‡(
c⁄f
->
w‹kî_˙t_≥r_group
 == 0) {

307 
	`li°_add_èû
(&
sh
->
Ãu
, &
c⁄f
->
h™dÀ_li°
);

309 
	`øid5_wakeup_°rùe_thªad
(
sh
);

313 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

315 
	`BUG_ON
(
	`°rùe_›î©i⁄s_a˘ive
(
sh
));

316 i‡(
	`ã°_™d_˛ór_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))

317 i‡(
	`©omic_dec_ªtu∫
(&
c⁄f
->
¥îód_a˘ive_°rùes
)

318 < 
IO_THRESHOLD
)

319 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

320 
	`©omic_dec
(&
c⁄f
->
a˘ive_°rùes
);

321 i‡(!
	`ã°_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
))

322 
	`li°_add_èû
(&
sh
->
Ãu
, 
ãmp_öa˘ive_li°
);

324 
	}
}

326 
	$__ªÀa£_°rùe
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

327 
li°_hód
 *
ãmp_öa˘ive_li°
)

329 i‡(
	`©omic_dec_™d_ã°
(&
sh
->
cou¡
))

330 
	`do_ªÀa£_°rùe
(
c⁄f
, 
sh
, 
ãmp_öa˘ive_li°
);

331 
	}
}

340 
	$ªÀa£_öa˘ive_°rùe_li°
(
r5c⁄f
 *
c⁄f
,

341 
li°_hód
 *
ãmp_öa˘ive_li°
,

342 
hash
)

344 
size
;

345 
boﬁ
 
do_wakeup
 = 
Ál£
;

346 
Êags
;

348 i‡(
hash
 =
NR_STRIPE_HASH_LOCKS
) {

349 
size
 = 
NR_STRIPE_HASH_LOCKS
;

350 
hash
 = 
NR_STRIPE_HASH_LOCKS
 - 1;

352 
size
 = 1;

353 
size
) {

354 
li°_hód
 *
li°
 = &
ãmp_öa˘ive_li°
[
size
 - 1];

360 i‡(!
	`li°_em±y_ˇªful
(
li°
)) {

361 
	`•ö_lock_úqßve
(
c⁄f
->
hash_locks
 + 
hash
, 
Êags
);

362 i‡(
	`li°_em±y
(
c⁄f
->
öa˘ive_li°
 + 
hash
) &&

363 !
	`li°_em±y
(
li°
))

364 
	`©omic_dec
(&
c⁄f
->
em±y_öa˘ive_li°_ƒ
);

365 
	`li°_•li˚_èû_öô
(
li°
, 
c⁄f
->
öa˘ive_li°
 + 
hash
);

366 
do_wakeup
 = 
åue
;

367 
	`•ö_u∆ock_úqª°‹e
(
c⁄f
->
hash_locks
 + 
hash
, 
Êags
);

369 
size
--;

370 
hash
--;

373 i‡(
do_wakeup
) {

374 
	`wake_up
(&
c⁄f
->
waô_f‹_°rùe
);

375 i‡(
c⁄f
->
ªåy_ªad_Æig√d
)

376 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

378 
	}
}

381 
	$ªÀa£_°rùe_li°
(
r5c⁄f
 *
c⁄f
,

382 
li°_hód
 *
ãmp_öa˘ive_li°
)

384 
°rùe_hód
 *
sh
;

385 
cou¡
 = 0;

386 
Œi°_node
 *
hód
;

388 
hód
 = 
	`Œi°_dñ_Æl
(&
c⁄f
->
ªÀa£d_°rùes
);

389 
hód
 = 
	`Œi°_ªvî£_‹dî
(head);

390 
hód
) {

391 
hash
;

393 
sh
 = 
	`Œi°_íåy
(
hód
, 
°rùe_hód
, 
ªÀa£_li°
);

394 
hód
 = 
	`Œi°_√xt
(head);

396 
	`smp_mb
();

397 
	`˛ór_bô
(
STRIPE_ON_RELEASE_LIST
, &
sh
->
°©e
);

403 
hash
 = 
sh
->
hash_lock_ödex
;

404 
	`__ªÀa£_°rùe
(
c⁄f
, 
sh
, &
ãmp_öa˘ive_li°
[
hash
]);

405 
cou¡
++;

408  
cou¡
;

409 
	}
}

411 
	$ªÀa£_°rùe
(
°rùe_hód
 *
sh
)

413 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

414 
Êags
;

415 
li°_hód
 
li°
;

416 
hash
;

417 
boﬁ
 
wakeup
;

421 i‡(
	`©omic_add_u∆ess
(&
sh
->
cou¡
, -1, 1))

424 i‡(
	`u∆ikñy
(!
c⁄f
->
mddev
->
thªad
) ||

425 
	`ã°_™d_£t_bô
(
STRIPE_ON_RELEASE_LIST
, &
sh
->
°©e
))

426 
¶ow_∑th
;

427 
wakeup
 = 
	`Œi°_add
(&
sh
->
ªÀa£_li°
, &
c⁄f
->
ªÀa£d_°rùes
);

428 i‡(
wakeup
)

429 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

431 
¶ow_∑th
:

432 
	`loˇl_úq_ßve
(
Êags
);

434 i‡(
	`©omic_dec_™d_lock
(&
sh
->
cou¡
, &
c⁄f
->
devi˚_lock
)) {

435 
	`INIT_LIST_HEAD
(&
li°
);

436 
hash
 = 
sh
->
hash_lock_ödex
;

437 
	`do_ªÀa£_°rùe
(
c⁄f
, 
sh
, &
li°
);

438 
	`•ö_u∆ock
(&
c⁄f
->
devi˚_lock
);

439 
	`ªÀa£_öa˘ive_°rùe_li°
(
c⁄f
, &
li°
, 
hash
);

441 
	`loˇl_úq_ª°‹e
(
Êags
);

442 
	}
}

444 
ölöe
 
	$ªmove_hash
(
°rùe_hód
 *
sh
)

446 
	`¥_debug
("remove_hash(), stripe %llu\n",

447 ()
sh
->
£˘‹
);

449 
	`hli°_dñ_öô
(&
sh
->
hash
);

450 
	}
}

452 
ölöe
 
	$ö£π_hash
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
)

454 
hli°_hód
 *
hp
 = 
	`°rùe_hash
(
c⁄f
, 
sh
->
£˘‹
);

456 
	`¥_debug
("insert_hash(), stripe %llu\n",

457 ()
sh
->
£˘‹
);

459 
	`hli°_add_hód
(&
sh
->
hash
, 
hp
);

460 
	}
}

464 
°rùe_hód
 *
	$gë_‰ì_°rùe
(
r5c⁄f
 *
c⁄f
, 
hash
)

466 
°rùe_hód
 *
sh
 = 
NULL
;

467 
li°_hód
 *
fú°
;

469 i‡(
	`li°_em±y
(
c⁄f
->
öa˘ive_li°
 + 
hash
))

470 
out
;

471 
fú°
 = (
c⁄f
->
öa˘ive_li°
 + 
hash
)->
√xt
;

472 
sh
 = 
	`li°_íåy
(
fú°
, 
°rùe_hód
, 
Ãu
);

473 
	`li°_dñ_öô
(
fú°
);

474 
	`ªmove_hash
(
sh
);

475 
	`©omic_öc
(&
c⁄f
->
a˘ive_°rùes
);

476 
	`BUG_ON
(
hash
 !
sh
->
hash_lock_ödex
);

477 i‡(
	`li°_em±y
(
c⁄f
->
öa˘ive_li°
 + 
hash
))

478 
	`©omic_öc
(&
c⁄f
->
em±y_öa˘ive_li°_ƒ
);

479 
out
:

480  
sh
;

481 
	}
}

483 
	$shrök_buf„rs
(
°rùe_hód
 *
sh
)

485 
∑ge
 *
p
;

486 
i
;

487 
num
 = 
sh
->
øid_c⁄f
->
poﬁ_size
;

489 
i
 = 0; i < 
num
 ; i++) {

490 
	`WARN_ON
(
sh
->
dev
[
i
].
∑ge
 !sh->dev[i].
‹ig_∑ge
);

491 
p
 = 
sh
->
dev
[
i
].
∑ge
;

492 i‡(!
p
)

494 
sh
->
dev
[
i
].
∑ge
 = 
NULL
;

495 
	`put_∑ge
(
p
);

497 
	}
}

499 
	$grow_buf„rs
(
°rùe_hód
 *
sh
)

501 
i
;

502 
num
 = 
sh
->
øid_c⁄f
->
poﬁ_size
;

504 
i
 = 0; i < 
num
; i++) {

505 
∑ge
 *page;

507 i‡(!(
∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
))) {

510 
sh
->
dev
[
i
].
∑ge
 =Öage;

511 
sh
->
dev
[
i
].
‹ig_∑ge
 = 
∑ge
;

514 
	}
}

516 
øid5_buûd_block
(
°rùe_hód
 *
sh
, 
i
, 
¥evious
);

517 
°rùe_£t_idx
(
£˘‹_t
 
°rùe
, 
r5c⁄f
 *
c⁄f
, 
¥evious
,

518 
°rùe_hód
 *
sh
);

520 
	$öô_°rùe
(
°rùe_hód
 *
sh
, 
£˘‹_t
 
£˘‹
, 
¥evious
)

522 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

523 
i
, 
£q
;

525 
	`BUG_ON
(
	`©omic_ªad
(&
sh
->
cou¡
) != 0);

526 
	`BUG_ON
(
	`ã°_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
));

527 
	`BUG_ON
(
	`°rùe_›î©i⁄s_a˘ive
(
sh
));

529 
	`¥_debug
("init_stripe called, stripe %llu\n",

530 ()
sh
->
£˘‹
);

532 
	`ªmove_hash
(
sh
);

533 
ªåy
:

534 
£q
 = 
	`ªad_£qcou¡_begö
(&
c⁄f
->
gí_lock
);

535 
sh
->
gíî©i⁄
 = 
c⁄f
->gíî©i⁄ - 
¥evious
;

536 
sh
->
disks
 = 
¥evious
 ? 
c⁄f
->
¥evious_øid_disks
 : c⁄f->
øid_disks
;

537 
sh
->
£˘‹
 = sector;

538 
	`°rùe_£t_idx
(
£˘‹
, 
c⁄f
, 
¥evious
, 
sh
);

539 
sh
->
°©e
 = 0;

542 
i
 = 
sh
->
disks
; i--; ) {

543 
r5dev
 *
dev
 = &
sh
->dev[
i
];

545 i‡(
dev
->
t‹ód
 || dev->
ªad
 || dev->
towrôe
 || dev->
wrôãn
 ||

546 
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
)) {

547 
	`¥ötk
(
KERN_ERR
 "sector=%llx i=%d %p %p %p %p %d\n",

548 ()
sh
->
£˘‹
, 
i
, 
dev
->
t‹ód
,

549 
dev
->
ªad
, dev->
towrôe
, dev->
wrôãn
,

550 
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
));

551 
	`WARN_ON
(1);

553 
dev
->
Êags
 = 0;

554 
	`øid5_buûd_block
(
sh
, 
i
, 
¥evious
);

556 i‡(
	`ªad_£qcou¡_ªåy
(&
c⁄f
->
gí_lock
, 
£q
))

557 
ªåy
;

558 
	`ö£π_hash
(
c⁄f
, 
sh
);

559 
sh
->
˝u
 = 
	`smp_¥o˚ss‹_id
();

560 
	}
}

562 
°rùe_hód
 *
	$__föd_°rùe
(
r5c⁄f
 *
c⁄f
, 
£˘‹_t
 
£˘‹
,

563 
gíî©i⁄
)

565 
°rùe_hód
 *
sh
;

567 
	`¥_debug
("__föd_°rùe, se˘‹ %Œu\n", ()
£˘‹
);

568 
	`hli°_f‹_óch_íåy
(
sh
, 
	`°rùe_hash
(
c⁄f
, 
£˘‹
), 
hash
)

569 i‡(
sh
->
£˘‹
 =£˘‹ && sh->
gíî©i⁄
 == generation)

570  
sh
;

571 
	`¥_debug
("__°rùê%ŒuÇŸ i¿ˇche\n", ()
£˘‹
);

572  
NULL
;

573 
	}
}

588 
	$ˇlc_degøded
(
r5c⁄f
 *
c⁄f
)

590 
degøded
, 
degøded2
;

591 
i
;

593 
	`rcu_ªad_lock
();

594 
degøded
 = 0;

595 
i
 = 0; i < 
c⁄f
->
¥evious_øid_disks
; i++) {

596 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].rdev);

597 i‡(
rdev
 && 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

598 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].
ª∂a˚mít
);

599 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

600 
degøded
++;

601 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

613 i‡(
c⁄f
->
øid_disks
 >c⁄f->
¥evious_øid_disks
)

614 
degøded
++;

616 
	`rcu_ªad_u∆ock
();

617 i‡(
c⁄f
->
øid_disks
 =c⁄f->
¥evious_øid_disks
)

618  
degøded
;

619 
	`rcu_ªad_lock
();

620 
degøded2
 = 0;

621 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

622 
md_rdev
 *
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].rdev);

623 i‡(
rdev
 && 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

624 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].
ª∂a˚mít
);

625 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

626 
degøded2
++;

627 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

635 i‡(
c⁄f
->
øid_disks
 <c⁄f->
¥evious_øid_disks
)

636 
degøded2
++;

638 
	`rcu_ªad_u∆ock
();

639 i‡(
degøded2
 > 
degøded
)

640  
degøded2
;

641  
degøded
;

642 
	}
}

644 
	$has_Áûed
(
r5c⁄f
 *
c⁄f
)

646 
degøded
;

648 i‡(
c⁄f
->
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
)

649  
c⁄f
->
mddev
->
degøded
 > c⁄f->
max_degøded
;

651 
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

652 i‡(
degøded
 > 
c⁄f
->
max_degøded
)

655 
	}
}

657 
°rùe_hód
 *

658 
	$gë_a˘ive_°rùe
(
r5c⁄f
 *
c⁄f
, 
£˘‹_t
 
£˘‹
,

659 
¥evious
, 
noblock
, 
noquõs˚
)

661 
°rùe_hód
 *
sh
;

662 
hash
 = 
	`°rùe_hash_locks_hash
(
£˘‹
);

664 
	`¥_debug
("gë_°rùe, se˘‹ %Œu\n", ()
£˘‹
);

666 
	`•ö_lock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

669 
	`waô_evít_lock_úq
(
c⁄f
->
waô_f‹_°rùe
,

670 
c⁄f
->
quõs˚
 =0 || 
noquõs˚
,

671 *(
c⁄f
->
hash_locks
 + 
hash
));

672 
sh
 = 
	`__föd_°rùe
(
c⁄f
, 
£˘‹
, c⁄f->
gíî©i⁄
 - 
¥evious
);

673 i‡(!
sh
) {

674 i‡(!
c⁄f
->
öa˘ive_blocked
)

675 
sh
 = 
	`gë_‰ì_°rùe
(
c⁄f
, 
hash
);

676 i‡(
noblock
 && 
sh
 =
NULL
)

678 i‡(!
sh
) {

679 
c⁄f
->
öa˘ive_blocked
 = 1;

680 
	`waô_evít_lock_úq
(

681 
c⁄f
->
waô_f‹_°rùe
,

682 !
	`li°_em±y
(
c⁄f
->
öa˘ive_li°
 + 
hash
) &&

683 (
	`©omic_ªad
(&
c⁄f
->
a˘ive_°rùes
)

684 < (
c⁄f
->
max_ƒ_°rùes
 * 3 / 4)

685 || !
c⁄f
->
öa˘ive_blocked
),

686 *(
c⁄f
->
hash_locks
 + 
hash
));

687 
c⁄f
->
öa˘ive_blocked
 = 0;

689 
	`öô_°rùe
(
sh
, 
£˘‹
, 
¥evious
);

690 
	`©omic_öc
(&
sh
->
cou¡
);

692 } i‡(!
	`©omic_öc_nŸ_zîo
(&
sh
->
cou¡
)) {

693 
	`•ö_lock
(&
c⁄f
->
devi˚_lock
);

694 i‡(!
	`©omic_ªad
(&
sh
->
cou¡
)) {

695 i‡(!
	`ã°_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
))

696 
	`©omic_öc
(&
c⁄f
->
a˘ive_°rùes
);

697 
	`BUG_ON
(
	`li°_em±y
(&
sh
->
Ãu
) &&

698 !
	`ã°_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
));

699 
	`li°_dñ_öô
(&
sh
->
Ãu
);

700 i‡(
sh
->
group
) {

701 
sh
->
group
->
°rùes_˙t
--;

702 
sh
->
group
 = 
NULL
;

705 
	`©omic_öc
(&
sh
->
cou¡
);

706 
	`•ö_u∆ock
(&
c⁄f
->
devi˚_lock
);

708 } 
sh
 =
NULL
);

710 
	`•ö_u∆ock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

711  
sh
;

712 
	}
}

717 
	$u£_√w_off£t
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
)

719 
£˘‹_t
 
¥ogªss
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

724 
	`smp_rmb
();

725 i‡(
¥ogªss
 =
MaxSe˘‹
)

727 i‡(
sh
->
gíî©i⁄
 =
c⁄f
->generation - 1)

733 
	}
}

736 
øid5_íd_ªad_ªque°
(
bio
 *
bi
, 
îr‹
);

738 
øid5_íd_wrôe_ªque°
(
bio
 *
bi
, 
îr‹
);

740 
	$›s_run_io
(
°rùe_hód
 *
sh
, 
°rùe_hód_°©e
 *
s
)

742 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

743 
i
, 
disks
 = 
sh
->disks;

745 
	`might_¶ìp
();

747 
i
 = 
disks
; i--; ) {

748 
rw
;

749 
ª∂a˚_⁄ly
 = 0;

750 
bio
 *
bi
, *
rbi
;

751 
md_rdev
 *
rdev
, *
ºdev
 = 
NULL
;

752 i‡(
	`ã°_™d_˛ór_bô
(
R5_W™twrôe
, &
sh
->
dev
[
i
].
Êags
)) {

753 i‡(
	`ã°_™d_˛ór_bô
(
R5_W™tFUA
, &
sh
->
dev
[
i
].
Êags
))

754 
rw
 = 
WRITE_FUA
;

756 
rw
 = 
WRITE
;

757 i‡(
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[
i
].
Êags
))

758 
rw
 |
REQ_DISCARD
;

759 } i‡(
	`ã°_™d_˛ór_bô
(
R5_W™åód
, &
sh
->
dev
[
i
].
Êags
))

760 
rw
 = 
READ
;

761 i‡(
	`ã°_™d_˛ór_bô
(
R5_W™tRïœ˚
,

762 &
sh
->
dev
[
i
].
Êags
)) {

763 
rw
 = 
WRITE
;

764 
ª∂a˚_⁄ly
 = 1;

767 i‡(
	`ã°_™d_˛ór_bô
(
R5_SyncIO
, &
sh
->
dev
[
i
].
Êags
))

768 
rw
 |
REQ_SYNC
;

770 
bi
 = &
sh
->
dev
[
i
].
ªq
;

771 
rbi
 = &
sh
->
dev
[
i
].
ºeq
;

773 
	`rcu_ªad_lock
();

774 
ºdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].
ª∂a˚mít
);

775 
	`smp_mb
();

776 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].rdev);

777 i‡(!
rdev
) {

778 
rdev
 = 
ºdev
;

779 
ºdev
 = 
NULL
;

781 i‡(
rw
 & 
WRITE
) {

782 i‡(
ª∂a˚_⁄ly
)

783 
rdev
 = 
NULL
;

784 i‡(
rdev
 =
ºdev
)

786 
ºdev
 = 
NULL
;

788 i‡(
	`ã°_bô
(
R5_RódRïl
, &
sh
->
dev
[
i
].
Êags
Ë&& 
ºdev
)

789 
rdev
 = 
ºdev
;

790 
ºdev
 = 
NULL
;

793 i‡(
rdev
 && 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

794 
rdev
 = 
NULL
;

795 i‡(
rdev
)

796 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

797 i‡(
ºdev
 && 
	`ã°_bô
(
Fau…y
, &ºdev->
Êags
))

798 
ºdev
 = 
NULL
;

799 i‡(
ºdev
)

800 
	`©omic_öc
(&
ºdev
->
ƒ_≥ndög
);

801 
	`rcu_ªad_u∆ock
();

807 (
rw
 & 
WRITE
Ë&& 
rdev
 &&

808 
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
)) {

809 
£˘‹_t
 
fú°_bad
;

810 
bad_£˘‹s
;

811 
bad
 = 
	`is_badblock
(
rdev
, 
sh
->
£˘‹
, 
STRIPE_SECTORS
,

812 &
fú°_bad
, &
bad_£˘‹s
);

813 i‡(!
bad
)

816 i‡(
bad
 < 0) {

817 
	`£t_bô
(
BlockedBadBlocks
, &
rdev
->
Êags
);

818 i‡(!
c⁄f
->
mddev
->
exã∫Æ
 &&

819 
c⁄f
->
mddev
->
Êags
) {

824 
	`md_check_ªcovîy
(
c⁄f
->
mddev
);

831 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

832 
	`md_waô_f‹_blocked_rdev
(
rdev
, 
c⁄f
->
mddev
);

835 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

836 
rdev
 = 
NULL
;

840 i‡(
rdev
) {

841 i‡(
s
->
syncög
 || s->
ex∑ndög
 || s->
ex∑nded


842 || 
s
->
ª∂acög
)

843 
	`md_sync_ac˘
(
rdev
->
bdev
, 
STRIPE_SECTORS
);

845 
	`£t_bô
(
STRIPE_IO_STARTED
, &
sh
->
°©e
);

847 
	`bio_ª£t
(
bi
);

848 
bi
->
bi_bdev
 = 
rdev
->
bdev
;

849 
bi
->
bi_rw
 = 
rw
;

850 
bi
->
bi_íd_io
 = (
rw
 & 
WRITE
)

851 ? 
øid5_íd_wrôe_ªque°


852 : 
øid5_íd_ªad_ªque°
;

853 
bi
->
bi_¥iv©e
 = 
sh
;

855 
	`¥_debug
("%s: for %llu schedule op %ld on disc %d\n",

856 
__func__
, ()
sh
->
£˘‹
,

857 
bi
->
bi_rw
, 
i
);

858 
	`©omic_öc
(&
sh
->
cou¡
);

859 i‡(
	`u£_√w_off£t
(
c⁄f
, 
sh
))

860 
bi
->
bi_ôî
.
bi_£˘‹
 = (
sh
->
£˘‹


861 + 
rdev
->
√w_d©a_off£t
);

863 
bi
->
bi_ôî
.
bi_£˘‹
 = (
sh
->
£˘‹


864 + 
rdev
->
d©a_off£t
);

865 i‡(
	`ã°_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
))

866 
bi
->
bi_rw
 |
REQ_NOMERGE
;

868 i‡(
	`ã°_bô
(
R5_SkùC›y
, &
sh
->
dev
[
i
].
Êags
))

869 
	`WARN_ON
(
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
));

870 
sh
->
dev
[
i
].
vec
.
bv_∑ge
 = sh->dev[i].
∑ge
;

871 
bi
->
bi_v˙t
 = 1;

872 
bi
->
bi_io_vec
[0].
bv_Àn
 = 
STRIPE_SIZE
;

873 
bi
->
bi_io_vec
[0].
bv_off£t
 = 0;

874 
bi
->
bi_ôî
.
bi_size
 = 
STRIPE_SIZE
;

879 i‡(
rw
 & 
REQ_DISCARD
)

880 
bi
->
bi_v˙t
 = 0;

881 i‡(
ºdev
)

882 
	`£t_bô
(
R5_DOUBLE_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

884 i‡(
c⁄f
->
mddev
->
gídisk
)

885 
	`åa˚_block_bio_ªm≠
(
	`bdev_gë_queue
(
bi
->
bi_bdev
),

886 
bi
, 
	`disk_devt
(
c⁄f
->
mddev
->
gídisk
),

887 
sh
->
dev
[
i
].
£˘‹
);

888 
	`gíîic_make_ªque°
(
bi
);

890 i‡(
ºdev
) {

891 i‡(
s
->
syncög
 || s->
ex∑ndög
 || s->
ex∑nded


892 || 
s
->
ª∂acög
)

893 
	`md_sync_ac˘
(
ºdev
->
bdev
, 
STRIPE_SECTORS
);

895 
	`£t_bô
(
STRIPE_IO_STARTED
, &
sh
->
°©e
);

897 
	`bio_ª£t
(
rbi
);

898 
rbi
->
bi_bdev
 = 
ºdev
->
bdev
;

899 
rbi
->
bi_rw
 = 
rw
;

900 
	`BUG_ON
(!(
rw
 & 
WRITE
));

901 
rbi
->
bi_íd_io
 = 
øid5_íd_wrôe_ªque°
;

902 
rbi
->
bi_¥iv©e
 = 
sh
;

904 
	`¥_debug
("%s: for %llu schedule op %ld on "

906 
__func__
, ()
sh
->
£˘‹
,

907 
rbi
->
bi_rw
, 
i
);

908 
	`©omic_öc
(&
sh
->
cou¡
);

909 i‡(
	`u£_√w_off£t
(
c⁄f
, 
sh
))

910 
rbi
->
bi_ôî
.
bi_£˘‹
 = (
sh
->
£˘‹


911 + 
ºdev
->
√w_d©a_off£t
);

913 
rbi
->
bi_ôî
.
bi_£˘‹
 = (
sh
->
£˘‹


914 + 
ºdev
->
d©a_off£t
);

915 i‡(
	`ã°_bô
(
R5_SkùC›y
, &
sh
->
dev
[
i
].
Êags
))

916 
	`WARN_ON
(
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
));

917 
sh
->
dev
[
i
].
rvec
.
bv_∑ge
 = sh->dev[i].
∑ge
;

918 
rbi
->
bi_v˙t
 = 1;

919 
rbi
->
bi_io_vec
[0].
bv_Àn
 = 
STRIPE_SIZE
;

920 
rbi
->
bi_io_vec
[0].
bv_off£t
 = 0;

921 
rbi
->
bi_ôî
.
bi_size
 = 
STRIPE_SIZE
;

926 i‡(
rw
 & 
REQ_DISCARD
)

927 
rbi
->
bi_v˙t
 = 0;

928 i‡(
c⁄f
->
mddev
->
gídisk
)

929 
	`åa˚_block_bio_ªm≠
(
	`bdev_gë_queue
(
rbi
->
bi_bdev
),

930 
rbi
, 
	`disk_devt
(
c⁄f
->
mddev
->
gídisk
),

931 
sh
->
dev
[
i
].
£˘‹
);

932 
	`gíîic_make_ªque°
(
rbi
);

934 i‡(!
rdev
 && !
ºdev
) {

935 i‡(
rw
 & 
WRITE
)

936 
	`£t_bô
(
STRIPE_DEGRADED
, &
sh
->
°©e
);

937 
	`¥_debug
("skip op %ld on disc %d for sector %llu\n",

938 
bi
->
bi_rw
, 
i
, ()
sh
->
£˘‹
);

939 
	`˛ór_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

940 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

943 
	}
}

945 
dma_async_tx_des¸ùt‹
 *

946 
	$async_c›y_d©a
(
‰ombio
, 
bio
 *bio, 
∑ge
 **page,

947 
£˘‹_t
 
£˘‹
, 
dma_async_tx_des¸ùt‹
 *
tx
,

948 
°rùe_hód
 *
sh
)

950 
bio_vec
 
bvl
;

951 
bvec_ôî
 
ôî
;

952 
∑ge
 *
bio_∑ge
;

953 
∑ge_off£t
;

954 
async_submô_˘l
 
submô
;

955 
async_tx_Êags
 
Êags
 = 0;

957 i‡(
bio
->
bi_ôî
.
bi_£˘‹
 >
£˘‹
)

958 
∑ge_off£t
 = (sig√d)(
bio
->
bi_ôî
.
bi_£˘‹
 - 
£˘‹
) * 512;

960 
∑ge_off£t
 = (sig√d)(
£˘‹
 - 
bio
->
bi_ôî
.
bi_£˘‹
) * -512;

962 i‡(
‰ombio
)

963 
Êags
 |
ASYNC_TX_FENCE
;

964 
	`öô_async_submô
(&
submô
, 
Êags
, 
tx
, 
NULL
, NULL, NULL);

966 
	`bio_f‹_óch_£gmít
(
bvl
, 
bio
, 
ôî
) {

967 
Àn
 = 
bvl
.
bv_Àn
;

968 
˛í
;

969 
b_off£t
 = 0;

971 i‡(
∑ge_off£t
 < 0) {

972 
b_off£t
 = -
∑ge_off£t
;

973 
∑ge_off£t
 +
b_off£t
;

974 
Àn
 -
b_off£t
;

977 i‡(
Àn
 > 0 && 
∑ge_off£t
 +Üí > 
STRIPE_SIZE
)

978 
˛í
 = 
STRIPE_SIZE
 - 
∑ge_off£t
;

980 
˛í
 = 
Àn
;

982 i‡(
˛í
 > 0) {

983 
b_off£t
 +
bvl
.
bv_off£t
;

984 
bio_∑ge
 = 
bvl
.
bv_∑ge
;

985 i‡(
‰ombio
) {

986 i‡(
sh
->
øid_c⁄f
->
skù_c›y
 &&

987 
b_off£t
 =0 && 
∑ge_off£t
 == 0 &&

988 
˛í
 =
STRIPE_SIZE
)

989 *
∑ge
 = 
bio_∑ge
;

991 
tx
 = 
	`async_mem˝y
(*
∑ge
, 
bio_∑ge
, 
∑ge_off£t
,

992 
b_off£t
, 
˛í
, &
submô
);

994 
tx
 = 
	`async_mem˝y
(
bio_∑ge
, *
∑ge
, 
b_off£t
,

995 
∑ge_off£t
, 
˛í
, &
submô
);

998 
submô
.
dïíd_tx
 = 
tx
;

1000 i‡(
˛í
 < 
Àn
)

1002 
∑ge_off£t
 +
Àn
;

1005  
tx
;

1006 
	}
}

1008 
	$›s_com∂ëe_biofûl
(*
°rùe_hód_ªf
)

1010 
°rùe_hód
 *
sh
 = 
°rùe_hód_ªf
;

1011 
bio
 *
ªtu∫_bi
 = 
NULL
;

1012 
i
;

1014 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1015 ()
sh
->
£˘‹
);

1018 
i
 = 
sh
->
disks
; i--; ) {

1019 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1026 i‡(
	`ã°_™d_˛ór_bô
(
R5_W™tfûl
, &
dev
->
Êags
)) {

1027 
bio
 *
rbi
, *
rbi2
;

1029 
	`BUG_ON
(!
dev
->
ªad
);

1030 
rbi
 = 
dev
->
ªad
;

1031 
dev
->
ªad
 = 
NULL
;

1032 
rbi
 &&Ñbi->
bi_ôî
.
bi_£˘‹
 <

1033 
dev
->
£˘‹
 + 
STRIPE_SECTORS
) {

1034 
rbi2
 = 
	`r5_√xt_bio
(
rbi
, 
dev
->
£˘‹
);

1035 i‡(!
	`øid5_dec_bi_a˘ive_°rùes
(
rbi
)) {

1036 
rbi
->
bi_√xt
 = 
ªtu∫_bi
;

1037 
ªtu∫_bi
 = 
rbi
;

1039 
rbi
 = 
rbi2
;

1043 
	`˛ór_bô
(
STRIPE_BIOFILL_RUN
, &
sh
->
°©e
);

1045 
	`ªtu∫_io
(
ªtu∫_bi
);

1047 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

1048 
	`ªÀa£_°rùe
(
sh
);

1049 
	}
}

1051 
	$›s_run_biofûl
(
°rùe_hód
 *
sh
)

1053 
dma_async_tx_des¸ùt‹
 *
tx
 = 
NULL
;

1054 
async_submô_˘l
 
submô
;

1055 
i
;

1057 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1058 ()
sh
->
£˘‹
);

1060 
i
 = 
sh
->
disks
; i--; ) {

1061 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1062 i‡(
	`ã°_bô
(
R5_W™tfûl
, &
dev
->
Êags
)) {

1063 
bio
 *
rbi
;

1064 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

1065 
dev
->
ªad
 = 
rbi
 = dev->
t‹ód
;

1066 
dev
->
t‹ód
 = 
NULL
;

1067 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

1068 
rbi
 &&Ñbi->
bi_ôî
.
bi_£˘‹
 <

1069 
dev
->
£˘‹
 + 
STRIPE_SECTORS
) {

1070 
tx
 = 
	`async_c›y_d©a
(0, 
rbi
, &
dev
->
∑ge
,

1071 
dev
->
£˘‹
, 
tx
, 
sh
);

1072 
rbi
 = 
	`r5_√xt_bio
‘bi, 
dev
->
£˘‹
);

1077 
	`©omic_öc
(&
sh
->
cou¡
);

1078 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_ACK
, 
tx
, 
›s_com∂ëe_biofûl
, 
sh
, 
NULL
);

1079 
	`async_åiggî_ˇŒback
(&
submô
);

1080 
	}
}

1082 
	$m¨k_èrgë_u±od©e
(
°rùe_hód
 *
sh
, 
èrgë
)

1084 
r5dev
 *
tgt
;

1086 i‡(
èrgë
 < 0)

1089 
tgt
 = &
sh
->
dev
[
èrgë
];

1090 
	`£t_bô
(
R5_UPTODATE
, &
tgt
->
Êags
);

1091 
	`BUG_ON
(!
	`ã°_bô
(
R5_W™tcompuã
, &
tgt
->
Êags
));

1092 
	`˛ór_bô
(
R5_W™tcompuã
, &
tgt
->
Êags
);

1093 
	}
}

1095 
	$›s_com∂ëe_compuã
(*
°rùe_hód_ªf
)

1097 
°rùe_hód
 *
sh
 = 
°rùe_hód_ªf
;

1099 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1100 ()
sh
->
£˘‹
);

1103 
	`m¨k_èrgë_u±od©e
(
sh
, sh->
›s
.
èrgë
);

1104 
	`m¨k_èrgë_u±od©e
(
sh
, sh->
›s
.
èrgë2
);

1106 
	`˛ór_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

1107 i‡(
sh
->
check_°©e
 =
check_°©e_compuã_run
)

1108 
sh
->
check_°©e
 = 
check_°©e_compuã_ªsu…
;

1109 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

1110 
	`ªÀa£_°rùe
(
sh
);

1111 
	}
}

1114 
addr_c⁄v_t
 *
	$to_addr_c⁄v
(
°rùe_hód
 *
sh
,

1115 
øid5_≥r˝u
 *
≥r˝u
)

1117  
≥r˝u
->
s¸ibbÀ
 + (
∑ge
 *Ë* (
sh
->
disks
 + 2);

1118 
	}
}

1120 
dma_async_tx_des¸ùt‹
 *

1121 
	$›s_run_compuã5
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
)

1123 
disks
 = 
sh
->disks;

1124 
∑ge
 **
x‹_§cs
 = 
≥r˝u
->
s¸ibbÀ
;

1125 
èrgë
 = 
sh
->
›s
.target;

1126 
r5dev
 *
tgt
 = &
sh
->
dev
[
èrgë
];

1127 
∑ge
 *
x‹_de°
 = 
tgt
->page;

1128 
cou¡
 = 0;

1129 
dma_async_tx_des¸ùt‹
 *
tx
;

1130 
async_submô_˘l
 
submô
;

1131 
i
;

1133 
	`¥_debug
("%s: stripe %llu block: %d\n",

1134 
__func__
, ()
sh
->
£˘‹
, 
èrgë
);

1135 
	`BUG_ON
(!
	`ã°_bô
(
R5_W™tcompuã
, &
tgt
->
Êags
));

1137 
i
 = 
disks
; i--; )

1138 i‡(
i
 !
èrgë
)

1139 
x‹_§cs
[
cou¡
++] = 
sh
->
dev
[
i
].
∑ge
;

1141 
	`©omic_öc
(&
sh
->
cou¡
);

1143 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
|
ASYNC_TX_XOR_ZERO_DST
, 
NULL
,

1144 
›s_com∂ëe_compuã
, 
sh
, 
	`to_addr_c⁄v
(sh, 
≥r˝u
));

1145 i‡(
	`u∆ikñy
(
cou¡
 == 1))

1146 
tx
 = 
	`async_mem˝y
(
x‹_de°
, 
x‹_§cs
[0], 0, 0, 
STRIPE_SIZE
, &
submô
);

1148 
tx
 = 
	`async_x‹
(
x‹_de°
, 
x‹_§cs
, 0, 
cou¡
, 
STRIPE_SIZE
, &
submô
);

1150  
tx
;

1151 
	}
}

1162 
	$£t_syndrome_sour˚s
(
∑ge
 **
§cs
, 
°rùe_hód
 *
sh
)

1164 
disks
 = 
sh
->disks;

1165 
syndrome_disks
 = 
sh
->
ddf_œyout
 ? 
disks
 : (disks - 2);

1166 
d0_idx
 = 
	`øid6_d0
(
sh
);

1167 
cou¡
;

1168 
i
;

1170 
i
 = 0; i < 
disks
; i++)

1171 
§cs
[
i
] = 
NULL
;

1173 
cou¡
 = 0;

1174 
i
 = 
d0_idx
;

1176 
¶Ÿ
 = 
	`øid6_idx_to_¶Ÿ
(
i
, 
sh
, &
cou¡
, 
syndrome_disks
);

1178 
§cs
[
¶Ÿ
] = 
sh
->
dev
[
i
].
∑ge
;

1179 
i
 = 
	`øid6_√xt_disk
(i, 
disks
);

1180 } 
i
 !
d0_idx
);

1182  
syndrome_disks
;

1183 
	}
}

1185 
dma_async_tx_des¸ùt‹
 *

1186 
	$›s_run_compuã6_1
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
)

1188 
disks
 = 
sh
->disks;

1189 
∑ge
 **
blocks
 = 
≥r˝u
->
s¸ibbÀ
;

1190 
èrgë
;

1191 
qd_idx
 = 
sh
->qd_idx;

1192 
dma_async_tx_des¸ùt‹
 *
tx
;

1193 
async_submô_˘l
 
submô
;

1194 
r5dev
 *
tgt
;

1195 
∑ge
 *
de°
;

1196 
i
;

1197 
cou¡
;

1199 i‡(
sh
->
›s
.
èrgë
 < 0)

1200 
èrgë
 = 
sh
->
›s
.
èrgë2
;

1201 i‡(
sh
->
›s
.
èrgë2
 < 0)

1202 
èrgë
 = 
sh
->
›s
.target;

1205 
	`BUG
();

1206 
	`BUG_ON
(
èrgë
 < 0);

1207 
	`¥_debug
("%s: stripe %llu block: %d\n",

1208 
__func__
, ()
sh
->
£˘‹
, 
èrgë
);

1210 
tgt
 = &
sh
->
dev
[
èrgë
];

1211 
	`BUG_ON
(!
	`ã°_bô
(
R5_W™tcompuã
, &
tgt
->
Êags
));

1212 
de°
 = 
tgt
->
∑ge
;

1214 
	`©omic_öc
(&
sh
->
cou¡
);

1216 i‡(
èrgë
 =
qd_idx
) {

1217 
cou¡
 = 
	`£t_syndrome_sour˚s
(
blocks
, 
sh
);

1218 
blocks
[
cou¡
] = 
NULL
;

1219 
	`BUG_ON
(
blocks
[
cou¡
+1] !
de°
);

1220 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
, 
NULL
,

1221 
›s_com∂ëe_compuã
, 
sh
,

1222 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1223 
tx
 = 
	`async_gí_syndrome
(
blocks
, 0, 
cou¡
+2, 
STRIPE_SIZE
, &
submô
);

1226 
cou¡
 = 0;

1227 
i
 = 
disks
; i-- ; ) {

1228 i‡(
i
 =
èrgë
 || i =
qd_idx
)

1230 
blocks
[
cou¡
++] = 
sh
->
dev
[
i
].
∑ge
;

1233 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
|
ASYNC_TX_XOR_ZERO_DST
,

1234 
NULL
, 
›s_com∂ëe_compuã
, 
sh
,

1235 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1236 
tx
 = 
	`async_x‹
(
de°
, 
blocks
, 0, 
cou¡
, 
STRIPE_SIZE
, &
submô
);

1239  
tx
;

1240 
	}
}

1242 
dma_async_tx_des¸ùt‹
 *

1243 
	$›s_run_compuã6_2
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
)

1245 
i
, 
cou¡
, 
disks
 = 
sh
->disks;

1246 
syndrome_disks
 = 
sh
->
ddf_œyout
 ? 
disks
 : disks-2;

1247 
d0_idx
 = 
	`øid6_d0
(
sh
);

1248 
Áûa
 = -1, 
Áûb
 = -1;

1249 
èrgë
 = 
sh
->
›s
.target;

1250 
èrgë2
 = 
sh
->
›s
.target2;

1251 
r5dev
 *
tgt
 = &
sh
->
dev
[
èrgë
];

1252 
r5dev
 *
tgt2
 = &
sh
->
dev
[
èrgë2
];

1253 
dma_async_tx_des¸ùt‹
 *
tx
;

1254 
∑ge
 **
blocks
 = 
≥r˝u
->
s¸ibbÀ
;

1255 
async_submô_˘l
 
submô
;

1257 
	`¥_debug
("%s: stripe %llu block1: %d block2: %d\n",

1258 
__func__
, ()
sh
->
£˘‹
, 
èrgë
, 
èrgë2
);

1259 
	`BUG_ON
(
èrgë
 < 0 || 
èrgë2
 < 0);

1260 
	`BUG_ON
(!
	`ã°_bô
(
R5_W™tcompuã
, &
tgt
->
Êags
));

1261 
	`BUG_ON
(!
	`ã°_bô
(
R5_W™tcompuã
, &
tgt2
->
Êags
));

1266 
i
 = 0; i < 
disks
 ; i++)

1267 
blocks
[
i
] = 
NULL
;

1268 
cou¡
 = 0;

1269 
i
 = 
d0_idx
;

1271 
¶Ÿ
 = 
	`øid6_idx_to_¶Ÿ
(
i
, 
sh
, &
cou¡
, 
syndrome_disks
);

1273 
blocks
[
¶Ÿ
] = 
sh
->
dev
[
i
].
∑ge
;

1275 i‡(
i
 =
èrgë
)

1276 
Áûa
 = 
¶Ÿ
;

1277 i‡(
i
 =
èrgë2
)

1278 
Áûb
 = 
¶Ÿ
;

1279 
i
 = 
	`øid6_√xt_disk
(i, 
disks
);

1280 } 
i
 !
d0_idx
);

1282 
	`BUG_ON
(
Áûa
 =
Áûb
);

1283 i‡(
Áûb
 < 
Áûa
)

1284 
	`sw≠
(
Áûa
, 
Áûb
);

1285 
	`¥_debug
("%s: stripe: %llu faila: %d failb: %d\n",

1286 
__func__
, ()
sh
->
£˘‹
, 
Áûa
, 
Áûb
);

1288 
	`©omic_öc
(&
sh
->
cou¡
);

1290 i‡(
Áûb
 =
syndrome_disks
+1) {

1292 i‡(
Áûa
 =
syndrome_disks
) {

1294 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
, 
NULL
,

1295 
›s_com∂ëe_compuã
, 
sh
,

1296 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1297  
	`async_gí_syndrome
(
blocks
, 0, 
syndrome_disks
+2,

1298 
STRIPE_SIZE
, &
submô
);

1300 
∑ge
 *
de°
;

1301 
d©a_èrgë
;

1302 
qd_idx
 = 
sh
->qd_idx;

1305 i‡(
èrgë
 =
qd_idx
)

1306 
d©a_èrgë
 = 
èrgë2
;

1308 
d©a_èrgë
 = 
èrgë
;

1310 
cou¡
 = 0;

1311 
i
 = 
disks
; i-- ; ) {

1312 i‡(
i
 =
d©a_èrgë
 || i =
qd_idx
)

1314 
blocks
[
cou¡
++] = 
sh
->
dev
[
i
].
∑ge
;

1316 
de°
 = 
sh
->
dev
[
d©a_èrgë
].
∑ge
;

1317 
	`öô_async_submô
(&
submô
,

1318 
ASYNC_TX_FENCE
|
ASYNC_TX_XOR_ZERO_DST
,

1319 
NULL
, NULL, NULL,

1320 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1321 
tx
 = 
	`async_x‹
(
de°
, 
blocks
, 0, 
cou¡
, 
STRIPE_SIZE
,

1322 &
submô
);

1324 
cou¡
 = 
	`£t_syndrome_sour˚s
(
blocks
, 
sh
);

1325 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
, 
tx
,

1326 
›s_com∂ëe_compuã
, 
sh
,

1327 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1328  
	`async_gí_syndrome
(
blocks
, 0, 
cou¡
+2,

1329 
STRIPE_SIZE
, &
submô
);

1332 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
, 
NULL
,

1333 
›s_com∂ëe_compuã
, 
sh
,

1334 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1335 i‡(
Áûb
 =
syndrome_disks
) {

1337  
	`async_øid6_d©≠_ªcov
(
syndrome_disks
+2,

1338 
STRIPE_SIZE
, 
Áûa
,

1339 
blocks
, &
submô
);

1342  
	`async_øid6_2d©a_ªcov
(
syndrome_disks
+2,

1343 
STRIPE_SIZE
, 
Áûa
, 
Áûb
,

1344 
blocks
, &
submô
);

1347 
	}
}

1350 
	$›s_com∂ëe_¥ex‹
(*
°rùe_hód_ªf
)

1352 
°rùe_hód
 *
sh
 = 
°rùe_hód_ªf
;

1354 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1355 ()
sh
->
£˘‹
);

1356 
	}
}

1358 
dma_async_tx_des¸ùt‹
 *

1359 
	$›s_run_¥ex‹
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
,

1360 
dma_async_tx_des¸ùt‹
 *
tx
)

1362 
disks
 = 
sh
->disks;

1363 
∑ge
 **
x‹_§cs
 = 
≥r˝u
->
s¸ibbÀ
;

1364 
cou¡
 = 0, 
pd_idx
 = 
sh
->pd_idx, 
i
;

1365 
async_submô_˘l
 
submô
;

1368 
∑ge
 *
x‹_de°
 = 
x‹_§cs
[
cou¡
++] = 
sh
->
dev
[
pd_idx
].page;

1370 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1371 ()
sh
->
£˘‹
);

1373 
i
 = 
disks
; i--; ) {

1374 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1376 i‡(
	`ã°_bô
(
R5_W™tdøö
, &
dev
->
Êags
))

1377 
x‹_§cs
[
cou¡
++] = 
dev
->
∑ge
;

1380 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_FENCE
|
ASYNC_TX_XOR_DROP_DST
, 
tx
,

1381 
›s_com∂ëe_¥ex‹
, 
sh
, 
	`to_addr_c⁄v
(sh, 
≥r˝u
));

1382 
tx
 = 
	`async_x‹
(
x‹_de°
, 
x‹_§cs
, 0, 
cou¡
, 
STRIPE_SIZE
, &
submô
);

1384  
tx
;

1385 
	}
}

1387 
dma_async_tx_des¸ùt‹
 *

1388 
	$›s_run_biodøö
(
°rùe_hód
 *
sh
, 
dma_async_tx_des¸ùt‹
 *
tx
)

1390 
disks
 = 
sh
->disks;

1391 
i
;

1393 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1394 ()
sh
->
£˘‹
);

1396 
i
 = 
disks
; i--; ) {

1397 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1398 
bio
 *
cho£n
;

1400 i‡(
	`ã°_™d_˛ór_bô
(
R5_W™tdøö
, &
dev
->
Êags
)) {

1401 
bio
 *
wbi
;

1403 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

1404 
cho£n
 = 
dev
->
towrôe
;

1405 
dev
->
towrôe
 = 
NULL
;

1406 
	`BUG_ON
(
dev
->
wrôãn
);

1407 
wbi
 = 
dev
->
wrôãn
 = 
cho£n
;

1408 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

1409 
	`WARN_ON
(
dev
->
∑ge
 !dev->
‹ig_∑ge
);

1411 
wbi
 && wbi->
bi_ôî
.
bi_£˘‹
 <

1412 
dev
->
£˘‹
 + 
STRIPE_SECTORS
) {

1413 i‡(
wbi
->
bi_rw
 & 
REQ_FUA
)

1414 
	`£t_bô
(
R5_W™tFUA
, &
dev
->
Êags
);

1415 i‡(
wbi
->
bi_rw
 & 
REQ_SYNC
)

1416 
	`£t_bô
(
R5_SyncIO
, &
dev
->
Êags
);

1417 i‡(
wbi
->
bi_rw
 & 
REQ_DISCARD
)

1418 
	`£t_bô
(
R5_Disˇrd
, &
dev
->
Êags
);

1420 
tx
 = 
	`async_c›y_d©a
(1, 
wbi
, &
dev
->
∑ge
,

1421 
dev
->
£˘‹
, 
tx
, 
sh
);

1422 i‡(
dev
->
∑ge
 !dev->
‹ig_∑ge
) {

1423 
	`£t_bô
(
R5_SkùC›y
, &
dev
->
Êags
);

1424 
	`˛ór_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

1425 
	`˛ór_bô
(
R5_OVERWRITE
, &
dev
->
Êags
);

1428 
wbi
 = 
	`r5_√xt_bio
(wbi, 
dev
->
£˘‹
);

1433  
tx
;

1434 
	}
}

1436 
	$›s_com∂ëe_ªc⁄°ru˘
(*
°rùe_hód_ªf
)

1438 
°rùe_hód
 *
sh
 = 
°rùe_hód_ªf
;

1439 
disks
 = 
sh
->disks;

1440 
pd_idx
 = 
sh
->pd_idx;

1441 
qd_idx
 = 
sh
->qd_idx;

1442 
i
;

1443 
boﬁ
 
fua
 = 
Ál£
, 
sync
 = fÆ£, 
disˇrd
 = false;

1445 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1446 ()
sh
->
£˘‹
);

1448 
i
 = 
disks
; i--; ) {

1449 
fua
 |
	`ã°_bô
(
R5_W™tFUA
, &
sh
->
dev
[
i
].
Êags
);

1450 
sync
 |
	`ã°_bô
(
R5_SyncIO
, &
sh
->
dev
[
i
].
Êags
);

1451 
disˇrd
 |
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[
i
].
Êags
);

1454 
i
 = 
disks
; i--; ) {

1455 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1457 i‡(
dev
->
wrôãn
 || 
i
 =
pd_idx
 || i =
qd_idx
) {

1458 i‡(!
disˇrd
 && !
	`ã°_bô
(
R5_SkùC›y
, &
dev
->
Êags
))

1459 
	`£t_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

1460 i‡(
fua
)

1461 
	`£t_bô
(
R5_W™tFUA
, &
dev
->
Êags
);

1462 i‡(
sync
)

1463 
	`£t_bô
(
R5_SyncIO
, &
dev
->
Êags
);

1467 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_døö_run
)

1468 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_døö_ªsu…
;

1469 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_¥ex‹_døö_run
)

1470 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_¥ex‹_døö_ªsu…
;

1472 
	`BUG_ON
(
sh
->
ªc⁄°ru˘_°©e
 !
ªc⁄°ru˘_°©e_run
);

1473 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_ªsu…
;

1476 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

1477 
	`ªÀa£_°rùe
(
sh
);

1478 
	}
}

1481 
	$›s_run_ªc⁄°ru˘5
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
,

1482 
dma_async_tx_des¸ùt‹
 *
tx
)

1484 
disks
 = 
sh
->disks;

1485 
∑ge
 **
x‹_§cs
 = 
≥r˝u
->
s¸ibbÀ
;

1486 
async_submô_˘l
 
submô
;

1487 
cou¡
 = 0, 
pd_idx
 = 
sh
->pd_idx, 
i
;

1488 
∑ge
 *
x‹_de°
;

1489 
¥ex‹
 = 0;

1490 
Êags
;

1492 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1493 ()
sh
->
£˘‹
);

1495 
i
 = 0; i < 
sh
->
disks
; i++) {

1496 i‡(
pd_idx
 =
i
)

1498 i‡(!
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[
i
].
Êags
))

1501 i‡(
i
 >
sh
->
disks
) {

1502 
	`©omic_öc
(&
sh
->
cou¡
);

1503 
	`£t_bô
(
R5_Disˇrd
, &
sh
->
dev
[
pd_idx
].
Êags
);

1504 
	`›s_com∂ëe_ªc⁄°ru˘
(
sh
);

1510 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_¥ex‹_døö_run
) {

1511 
¥ex‹
 = 1;

1512 
x‹_de°
 = 
x‹_§cs
[
cou¡
++] = 
sh
->
dev
[
pd_idx
].
∑ge
;

1513 
i
 = 
disks
; i--; ) {

1514 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1515 i‡(
dev
->
wrôãn
)

1516 
x‹_§cs
[
cou¡
++] = 
dev
->
∑ge
;

1519 
x‹_de°
 = 
sh
->
dev
[
pd_idx
].
∑ge
;

1520 
i
 = 
disks
; i--; ) {

1521 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1522 i‡(
i
 !
pd_idx
)

1523 
x‹_§cs
[
cou¡
++] = 
dev
->
∑ge
;

1532 
Êags
 = 
ASYNC_TX_ACK
 |

1533 (
¥ex‹
 ? 
ASYNC_TX_XOR_DROP_DST
 : 
ASYNC_TX_XOR_ZERO_DST
);

1535 
	`©omic_öc
(&
sh
->
cou¡
);

1537 
	`öô_async_submô
(&
submô
, 
Êags
, 
tx
, 
›s_com∂ëe_ªc⁄°ru˘
, 
sh
,

1538 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1539 i‡(
	`u∆ikñy
(
cou¡
 == 1))

1540 
tx
 = 
	`async_mem˝y
(
x‹_de°
, 
x‹_§cs
[0], 0, 0, 
STRIPE_SIZE
, &
submô
);

1542 
tx
 = 
	`async_x‹
(
x‹_de°
, 
x‹_§cs
, 0, 
cou¡
, 
STRIPE_SIZE
, &
submô
);

1543 
	}
}

1546 
	$›s_run_ªc⁄°ru˘6
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
,

1547 
dma_async_tx_des¸ùt‹
 *
tx
)

1549 
async_submô_˘l
 
submô
;

1550 
∑ge
 **
blocks
 = 
≥r˝u
->
s¸ibbÀ
;

1551 
cou¡
, 
i
;

1553 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
, ()
sh
->
£˘‹
);

1555 
i
 = 0; i < 
sh
->
disks
; i++) {

1556 i‡(
sh
->
pd_idx
 =
i
 || sh->
qd_idx
 == i)

1558 i‡(!
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[
i
].
Êags
))

1561 i‡(
i
 >
sh
->
disks
) {

1562 
	`©omic_öc
(&
sh
->
cou¡
);

1563 
	`£t_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

1564 
	`£t_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
qd_idx
].
Êags
);

1565 
	`›s_com∂ëe_ªc⁄°ru˘
(
sh
);

1569 
cou¡
 = 
	`£t_syndrome_sour˚s
(
blocks
, 
sh
);

1571 
	`©omic_öc
(&
sh
->
cou¡
);

1573 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_ACK
, 
tx
, 
›s_com∂ëe_ªc⁄°ru˘
,

1574 
sh
, 
	`to_addr_c⁄v
(sh, 
≥r˝u
));

1575 
	`async_gí_syndrome
(
blocks
, 0, 
cou¡
+2, 
STRIPE_SIZE
, &
submô
);

1576 
	}
}

1578 
	$›s_com∂ëe_check
(*
°rùe_hód_ªf
)

1580 
°rùe_hód
 *
sh
 = 
°rùe_hód_ªf
;

1582 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1583 ()
sh
->
£˘‹
);

1585 
sh
->
check_°©e
 = 
check_°©e_check_ªsu…
;

1586 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

1587 
	`ªÀa£_°rùe
(
sh
);

1588 
	}
}

1590 
	$›s_run_check_p
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
)

1592 
disks
 = 
sh
->disks;

1593 
pd_idx
 = 
sh
->pd_idx;

1594 
qd_idx
 = 
sh
->qd_idx;

1595 
∑ge
 *
x‹_de°
;

1596 
∑ge
 **
x‹_§cs
 = 
≥r˝u
->
s¸ibbÀ
;

1597 
dma_async_tx_des¸ùt‹
 *
tx
;

1598 
async_submô_˘l
 
submô
;

1599 
cou¡
;

1600 
i
;

1602 
	`¥_debug
("%s: såùê%Œu\n", 
__func__
,

1603 ()
sh
->
£˘‹
);

1605 
cou¡
 = 0;

1606 
x‹_de°
 = 
sh
->
dev
[
pd_idx
].
∑ge
;

1607 
x‹_§cs
[
cou¡
++] = 
x‹_de°
;

1608 
i
 = 
disks
; i--; ) {

1609 i‡(
i
 =
pd_idx
 || i =
qd_idx
)

1611 
x‹_§cs
[
cou¡
++] = 
sh
->
dev
[
i
].
∑ge
;

1614 
	`öô_async_submô
(&
submô
, 0, 
NULL
, NULL, NULL,

1615 
	`to_addr_c⁄v
(
sh
, 
≥r˝u
));

1616 
tx
 = 
	`async_x‹_vÆ
(
x‹_de°
, 
x‹_§cs
, 0, 
cou¡
, 
STRIPE_SIZE
,

1617 &
sh
->
›s
.
zîo_sum_ªsu…
, &
submô
);

1619 
	`©omic_öc
(&
sh
->
cou¡
);

1620 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_ACK
, 
tx
, 
›s_com∂ëe_check
, 
sh
, 
NULL
);

1621 
tx
 = 
	`async_åiggî_ˇŒback
(&
submô
);

1622 
	}
}

1624 
	$›s_run_check_pq
(
°rùe_hód
 *
sh
, 
øid5_≥r˝u
 *
≥r˝u
, 
checkp
)

1626 
∑ge
 **
§cs
 = 
≥r˝u
->
s¸ibbÀ
;

1627 
async_submô_˘l
 
submô
;

1628 
cou¡
;

1630 
	`¥_debug
("%s: såùê%Œu checkp: %d\n", 
__func__
,

1631 ()
sh
->
£˘‹
, 
checkp
);

1633 
cou¡
 = 
	`£t_syndrome_sour˚s
(
§cs
, 
sh
);

1634 i‡(!
checkp
)

1635 
§cs
[
cou¡
] = 
NULL
;

1637 
	`©omic_öc
(&
sh
->
cou¡
);

1638 
	`öô_async_submô
(&
submô
, 
ASYNC_TX_ACK
, 
NULL
, 
›s_com∂ëe_check
,

1639 
sh
, 
	`to_addr_c⁄v
(sh, 
≥r˝u
));

1640 
	`async_syndrome_vÆ
(
§cs
, 0, 
cou¡
+2, 
STRIPE_SIZE
,

1641 &
sh
->
›s
.
zîo_sum_ªsu…
, 
≥r˝u
->
•¨e_∑ge
, &
submô
);

1642 
	}
}

1644 
	$øid_run_›s
(
°rùe_hód
 *
sh
, 
›s_ªque°
)

1646 
ovîœp_˛ór
 = 0, 
i
, 
disks
 = 
sh
->disks;

1647 
dma_async_tx_des¸ùt‹
 *
tx
 = 
NULL
;

1648 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

1649 
Àvñ
 = 
c⁄f
->level;

1650 
øid5_≥r˝u
 *
≥r˝u
;

1651 
˝u
;

1653 
˝u
 = 
	`gë_˝u
();

1654 
≥r˝u
 = 
	`≥r_˝u_±r
(
c⁄f
->≥r˝u, 
˝u
);

1655 i‡(
	`ã°_bô
(
STRIPE_OP_BIOFILL
, &
›s_ªque°
)) {

1656 
	`›s_run_biofûl
(
sh
);

1657 
ovîœp_˛ór
++;

1660 i‡(
	`ã°_bô
(
STRIPE_OP_COMPUTE_BLK
, &
›s_ªque°
)) {

1661 i‡(
Àvñ
 < 6)

1662 
tx
 = 
	`›s_run_compuã5
(
sh
, 
≥r˝u
);

1664 i‡(
sh
->
›s
.
èrgë2
 < 0 || sh->›s.
èrgë
 < 0)

1665 
tx
 = 
	`›s_run_compuã6_1
(
sh
, 
≥r˝u
);

1667 
tx
 = 
	`›s_run_compuã6_2
(
sh
, 
≥r˝u
);

1670 i‡(
tx
 && !
	`ã°_bô
(
STRIPE_OP_RECONSTRUCT
, &
›s_ªque°
))

1671 
	`async_tx_ack
(
tx
);

1674 i‡(
	`ã°_bô
(
STRIPE_OP_PREXOR
, &
›s_ªque°
))

1675 
tx
 = 
	`›s_run_¥ex‹
(
sh
, 
≥r˝u
,Åx);

1677 i‡(
	`ã°_bô
(
STRIPE_OP_BIODRAIN
, &
›s_ªque°
)) {

1678 
tx
 = 
	`›s_run_biodøö
(
sh
,Åx);

1679 
ovîœp_˛ór
++;

1682 i‡(
	`ã°_bô
(
STRIPE_OP_RECONSTRUCT
, &
›s_ªque°
)) {

1683 i‡(
Àvñ
 < 6)

1684 
	`›s_run_ªc⁄°ru˘5
(
sh
, 
≥r˝u
, 
tx
);

1686 
	`›s_run_ªc⁄°ru˘6
(
sh
, 
≥r˝u
, 
tx
);

1689 i‡(
	`ã°_bô
(
STRIPE_OP_CHECK
, &
›s_ªque°
)) {

1690 i‡(
sh
->
check_°©e
 =
check_°©e_run
)

1691 
	`›s_run_check_p
(
sh
, 
≥r˝u
);

1692 i‡(
sh
->
check_°©e
 =
check_°©e_run_q
)

1693 
	`›s_run_check_pq
(
sh
, 
≥r˝u
, 0);

1694 i‡(
sh
->
check_°©e
 =
check_°©e_run_pq
)

1695 
	`›s_run_check_pq
(
sh
, 
≥r˝u
, 1);

1697 
	`BUG
();

1700 i‡(
ovîœp_˛ór
)

1701 
i
 = 
disks
; i--; ) {

1702 
r5dev
 *
dev
 = &
sh
->dev[
i
];

1703 i‡(
	`ã°_™d_˛ór_bô
(
R5_Ovîœp
, &
dev
->
Êags
))

1704 
	`wake_up
(&
sh
->
øid_c⁄f
->
waô_f‹_ovîœp
);

1706 
	`put_˝u
();

1707 
	}
}

1709 
	$grow_⁄e_°rùe
(
r5c⁄f
 *
c⁄f
, 
hash
)

1711 
°rùe_hód
 *
sh
;

1712 
sh
 = 
	`kmem_ˇche_zÆloc
(
c⁄f
->
¶ab_ˇche
, 
GFP_KERNEL
);

1713 i‡(!
sh
)

1716 
sh
->
øid_c⁄f
 = 
c⁄f
;

1718 
	`•ö_lock_öô
(&
sh
->
°rùe_lock
);

1720 i‡(
	`grow_buf„rs
(
sh
)) {

1721 
	`shrök_buf„rs
(
sh
);

1722 
	`kmem_ˇche_‰ì
(
c⁄f
->
¶ab_ˇche
, 
sh
);

1725 
sh
->
hash_lock_ödex
 = 
hash
;

1727 
	`©omic_£t
(&
sh
->
cou¡
, 1);

1728 
	`©omic_öc
(&
c⁄f
->
a˘ive_°rùes
);

1729 
	`INIT_LIST_HEAD
(&
sh
->
Ãu
);

1730 
	`ªÀa£_°rùe
(
sh
);

1732 
	}
}

1734 
	$grow_°rùes
(
r5c⁄f
 *
c⁄f
, 
num
)

1736 
kmem_ˇche
 *
sc
;

1737 
devs
 = 
	`max
(
c⁄f
->
øid_disks
, c⁄f->
¥evious_øid_disks
);

1738 
hash
;

1740 i‡(
c⁄f
->
mddev
->
gídisk
)

1741 
	`•rötf
(
c⁄f
->
ˇche_«me
[0],

1742 "øid%d-%s", 
c⁄f
->
Àvñ
, 
	`md«me
(c⁄f->
mddev
));

1744 
	`•rötf
(
c⁄f
->
ˇche_«me
[0],

1745 "øid%d-%p", 
c⁄f
->
Àvñ
, c⁄f->
mddev
);

1746 
	`•rötf
(
c⁄f
->
ˇche_«me
[1], "%s-alt", conf->cache_name[0]);

1748 
c⁄f
->
a˘ive_«me
 = 0;

1749 
sc
 = 
	`kmem_ˇche_¸óã
(
c⁄f
->
ˇche_«me
[c⁄f->
a˘ive_«me
],

1750 (
°rùe_hód
)+(
devs
-1)*(
r5dev
),

1751 0, 0, 
NULL
);

1752 i‡(!
sc
)

1754 
c⁄f
->
¶ab_ˇche
 = 
sc
;

1755 
c⁄f
->
poﬁ_size
 = 
devs
;

1756 
hash
 = 
c⁄f
->
max_ƒ_°rùes
 % 
NR_STRIPE_HASH_LOCKS
;

1757 
num
--) {

1758 i‡(!
	`grow_⁄e_°rùe
(
c⁄f
, 
hash
))

1760 
c⁄f
->
max_ƒ_°rùes
++;

1761 
hash
 = (hash + 1Ë% 
NR_STRIPE_HASH_LOCKS
;

1764 
	}
}

1779 
size_t
 
	$s¸ibbÀ_Àn
(
num
)

1781 
size_t
 
Àn
;

1783 
Àn
 = (
∑ge
 *Ë* (
num
+2Ë+ (
addr_c⁄v_t
) * (num+2);

1785  
Àn
;

1786 
	}
}

1788 
	$ªsize_°rùes
(
r5c⁄f
 *
c⁄f
, 
√wsize
)

1813 
°rùe_hód
 *
osh
, *
nsh
;

1814 
	`LIST_HEAD
(
√w°rùes
);

1815 
disk_öfo
 *
ndisks
;

1816 
˝u
;

1817 
îr
;

1818 
kmem_ˇche
 *
sc
;

1819 
i
;

1820 
hash
, 
˙t
;

1822 i‡(
√wsize
 <
c⁄f
->
poﬁ_size
)

1825 
îr
 = 
	`md_Ælow_wrôe
(
c⁄f
->
mddev
);

1826 i‡(
îr
)

1827  
îr
;

1830 
sc
 = 
	`kmem_ˇche_¸óã
(
c⁄f
->
ˇche_«me
[1-c⁄f->
a˘ive_«me
],

1831 (
°rùe_hód
)+(
√wsize
-1)*(
r5dev
),

1832 0, 0, 
NULL
);

1833 i‡(!
sc
)

1834  -
ENOMEM
;

1836 
i
 = 
c⁄f
->
max_ƒ_°rùes
; i; i--) {

1837 
nsh
 = 
	`kmem_ˇche_zÆloc
(
sc
, 
GFP_KERNEL
);

1838 i‡(!
nsh
)

1841 
nsh
->
øid_c⁄f
 = 
c⁄f
;

1842 
	`•ö_lock_öô
(&
nsh
->
°rùe_lock
);

1844 
	`li°_add
(&
nsh
->
Ãu
, &
√w°rùes
);

1846 i‡(
i
) {

1848 !
	`li°_em±y
(&
√w°rùes
)) {

1849 
nsh
 = 
	`li°_íåy
(
√w°rùes
.
√xt
, 
°rùe_hód
, 
Ãu
);

1850 
	`li°_dñ
(&
nsh
->
Ãu
);

1851 
	`kmem_ˇche_‰ì
(
sc
, 
nsh
);

1853 
	`kmem_ˇche_de°roy
(
sc
);

1854  -
ENOMEM
;

1860 
hash
 = 0;

1861 
˙t
 = 0;

1862 
	`li°_f‹_óch_íåy
(
nsh
, &
√w°rùes
, 
Ãu
) {

1863 
	`lock_devi˚_hash_lock
(
c⁄f
, 
hash
);

1864 
	`waô_evít_cmd
(
c⁄f
->
waô_f‹_°rùe
,

1865 !
	`li°_em±y
(
c⁄f
->
öa˘ive_li°
 + 
hash
),

1866 
	`u∆ock_devi˚_hash_lock
(
c⁄f
, 
hash
),

1867 
	`lock_devi˚_hash_lock
(
c⁄f
, 
hash
));

1868 
osh
 = 
	`gë_‰ì_°rùe
(
c⁄f
, 
hash
);

1869 
	`u∆ock_devi˚_hash_lock
(
c⁄f
, 
hash
);

1870 
	`©omic_£t
(&
nsh
->
cou¡
, 1);

1871 
i
=0; i<
c⁄f
->
poﬁ_size
; i++) {

1872 
nsh
->
dev
[
i
].
∑ge
 = 
osh
->dev[i].page;

1873 
nsh
->
dev
[
i
].
‹ig_∑ge
 = 
osh
->dev[i].
∑ge
;

1875  ; 
i
<
√wsize
; i++)

1876 
nsh
->
dev
[
i
].
∑ge
 = 
NULL
;

1877 
nsh
->
hash_lock_ödex
 = 
hash
;

1878 
	`kmem_ˇche_‰ì
(
c⁄f
->
¶ab_ˇche
, 
osh
);

1879 
˙t
++;

1880 i‡(
˙t
 >
c⁄f
->
max_ƒ_°rùes
 / 
NR_STRIPE_HASH_LOCKS
 +

1881 !!((
c⁄f
->
max_ƒ_°rùes
 % 
NR_STRIPE_HASH_LOCKS
Ë> 
hash
)) {

1882 
hash
++;

1883 
˙t
 = 0;

1886 
	`kmem_ˇche_de°roy
(
c⁄f
->
¶ab_ˇche
);

1893 
ndisks
 = 
	`kzÆloc
(
√wsize
 * (
disk_öfo
), 
GFP_NOIO
);

1894 i‡(
ndisks
) {

1895 
i
=0; i<
c⁄f
->
øid_disks
; i++)

1896 
ndisks
[
i
] = 
c⁄f
->
disks
[i];

1897 
	`k‰ì
(
c⁄f
->
disks
);

1898 
c⁄f
->
disks
 = 
ndisks
;

1900 
îr
 = -
ENOMEM
;

1902 
	`gë_⁄löe_˝us
();

1903 
c⁄f
->
s¸ibbÀ_Àn
 = 
	`s¸ibbÀ_Àn
(
√wsize
);

1904 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

1905 
øid5_≥r˝u
 *
≥r˝u
;

1906 *
s¸ibbÀ
;

1908 
≥r˝u
 = 
	`≥r_˝u_±r
(
c⁄f
->≥r˝u, 
˝u
);

1909 
s¸ibbÀ
 = 
	`kmÆloc
(
c⁄f
->
s¸ibbÀ_Àn
, 
GFP_NOIO
);

1911 i‡(
s¸ibbÀ
) {

1912 
	`k‰ì
(
≥r˝u
->
s¸ibbÀ
);

1913 
≥r˝u
->
s¸ibbÀ
 = scribble;

1915 
îr
 = -
ENOMEM
;

1919 
	`put_⁄löe_˝us
();

1922 !
	`li°_em±y
(&
√w°rùes
)) {

1923 
nsh
 = 
	`li°_íåy
(
√w°rùes
.
√xt
, 
°rùe_hód
, 
Ãu
);

1924 
	`li°_dñ_öô
(&
nsh
->
Ãu
);

1926 
i
=
c⁄f
->
øid_disks
; i < 
√wsize
; i++)

1927 i‡(
nsh
->
dev
[
i
].
∑ge
 =
NULL
) {

1928 
∑ge
 *
p
 = 
	`Æloc_∑ge
(
GFP_NOIO
);

1929 
nsh
->
dev
[
i
].
∑ge
 = 
p
;

1930 
nsh
->
dev
[
i
].
‹ig_∑ge
 = 
p
;

1931 i‡(!
p
)

1932 
îr
 = -
ENOMEM
;

1934 
	`ªÀa£_°rùe
(
nsh
);

1938 
c⁄f
->
¶ab_ˇche
 = 
sc
;

1939 
c⁄f
->
a˘ive_«me
 = 1-conf->active_name;

1940 
c⁄f
->
poﬁ_size
 = 
√wsize
;

1941  
îr
;

1942 
	}
}

1944 
	$dr›_⁄e_°rùe
(
r5c⁄f
 *
c⁄f
, 
hash
)

1946 
°rùe_hód
 *
sh
;

1948 
	`•ö_lock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

1949 
sh
 = 
	`gë_‰ì_°rùe
(
c⁄f
, 
hash
);

1950 
	`•ö_u∆ock_úq
(
c⁄f
->
hash_locks
 + 
hash
);

1951 i‡(!
sh
)

1953 
	`BUG_ON
(
	`©omic_ªad
(&
sh
->
cou¡
));

1954 
	`shrök_buf„rs
(
sh
);

1955 
	`kmem_ˇche_‰ì
(
c⁄f
->
¶ab_ˇche
, 
sh
);

1956 
	`©omic_dec
(&
c⁄f
->
a˘ive_°rùes
);

1958 
	}
}

1960 
	$shrök_°rùes
(
r5c⁄f
 *
c⁄f
)

1962 
hash
;

1963 
hash
 = 0; hash < 
NR_STRIPE_HASH_LOCKS
; hash++)

1964 
	`dr›_⁄e_°rùe
(
c⁄f
, 
hash
))

1967 i‡(
c⁄f
->
¶ab_ˇche
)

1968 
	`kmem_ˇche_de°roy
(
c⁄f
->
¶ab_ˇche
);

1969 
c⁄f
->
¶ab_ˇche
 = 
NULL
;

1970 
	}
}

1972 
	$øid5_íd_ªad_ªque°
(
bio
 * 
bi
, 
îr‹
)

1974 
°rùe_hód
 *
sh
 = 
bi
->
bi_¥iv©e
;

1975 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

1976 
disks
 = 
sh
->disks, 
i
;

1977 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

1978 
b
[
BDEVNAME_SIZE
];

1979 
md_rdev
 *
rdev
 = 
NULL
;

1980 
£˘‹_t
 
s
;

1982 
i
=0 ; i<
disks
; i++)

1983 i‡(
bi
 =&
sh
->
dev
[
i
].
ªq
)

1986 
	`¥_debug
("end_read_request %llu/%d, count: %d, uptodate %d.\n",

1987 ()
sh
->
£˘‹
, 
i
, 
	`©omic_ªad
(&sh->
cou¡
),

1988 
u±od©e
);

1989 i‡(
i
 =
disks
) {

1990 
	`BUG
();

1993 i‡(
	`ã°_bô
(
R5_RódRïl
, &
sh
->
dev
[
i
].
Êags
))

1999 
rdev
 = 
c⁄f
->
disks
[
i
].
ª∂a˚mít
;

2000 i‡(!
rdev
)

2001 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

2003 i‡(
	`u£_√w_off£t
(
c⁄f
, 
sh
))

2004 
s
 = 
sh
->
£˘‹
 + 
rdev
->
√w_d©a_off£t
;

2006 
s
 = 
sh
->
£˘‹
 + 
rdev
->
d©a_off£t
;

2007 i‡(
u±od©e
) {

2008 
	`£t_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
);

2009 i‡(
	`ã°_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
)) {

2014 
	`¥ötk_øãlimôed
(

2015 
KERN_INFO


2018 
	`md«me
(
c⁄f
->
mddev
), 
STRIPE_SECTORS
,

2019 ()
s
,

2020 
	`bdev«me
(
rdev
->
bdev
, 
b
));

2021 
	`©omic_add
(
STRIPE_SECTORS
, &
rdev
->
c‹ª˘ed_îr‹s
);

2022 
	`˛ór_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
);

2023 
	`˛ór_bô
(
R5_ReWrôe
, &
sh
->
dev
[
i
].
Êags
);

2024 } i‡(
	`ã°_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
))

2025 
	`˛ór_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
);

2027 i‡(
	`©omic_ªad
(&
rdev
->
ªad_îr‹s
))

2028 
	`©omic_£t
(&
rdev
->
ªad_îr‹s
, 0);

2030 c⁄° *
bdn
 = 
	`bdev«me
(
rdev
->
bdev
, 
b
);

2031 
ªåy
 = 0;

2032 
£t_bad
 = 0;

2034 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
);

2035 
	`©omic_öc
(&
rdev
->
ªad_îr‹s
);

2036 i‡(
	`ã°_bô
(
R5_RódRïl
, &
sh
->
dev
[
i
].
Êags
))

2037 
	`¥ötk_øãlimôed
(

2038 
KERN_WARNING


2041 
	`md«me
(
c⁄f
->
mddev
),

2042 ()
s
,

2043 
bdn
);

2044 i‡(
c⁄f
->
mddev
->
degøded
 >c⁄f->
max_degøded
) {

2045 
£t_bad
 = 1;

2046 
	`¥ötk_øãlimôed
(

2047 
KERN_WARNING


2050 
	`md«me
(
c⁄f
->
mddev
),

2051 ()
s
,

2052 
bdn
);

2053 } i‡(
	`ã°_bô
(
R5_ReWrôe
, &
sh
->
dev
[
i
].
Êags
)) {

2055 
£t_bad
 = 1;

2056 
	`¥ötk_øãlimôed
(

2057 
KERN_WARNING


2060 
	`md«me
(
c⁄f
->
mddev
),

2061 ()
s
,

2062 
bdn
);

2063 } i‡(
	`©omic_ªad
(&
rdev
->
ªad_îr‹s
)

2064 > 
c⁄f
->
max_ƒ_°rùes
)

2065 
	`¥ötk
(
KERN_WARNING


2067 
	`md«me
(
c⁄f
->
mddev
), 
bdn
);

2069 
ªåy
 = 1;

2070 i‡(
£t_bad
 && 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

2071 && !
	`ã°_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
))

2072 
ªåy
 = 1;

2073 i‡(
ªåy
)

2074 i‡(
	`ã°_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
)) {

2075 
	`£t_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
);

2076 
	`˛ór_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
);

2078 
	`£t_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
i
].
Êags
);

2080 
	`˛ór_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
);

2081 
	`˛ór_bô
(
R5_ReWrôe
, &
sh
->
dev
[
i
].
Êags
);

2082 i‡(!(
£t_bad


2083 && 
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

2084 && 
	`rdev_£t_badblocks
(

2085 
rdev
, 
sh
->
£˘‹
, 
STRIPE_SECTORS
, 0)))

2086 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2089 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2090 
	`˛ór_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

2091 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

2092 
	`ªÀa£_°rùe
(
sh
);

2093 
	}
}

2095 
	$øid5_íd_wrôe_ªque°
(
bio
 *
bi
, 
îr‹
)

2097 
°rùe_hód
 *
sh
 = 
bi
->
bi_¥iv©e
;

2098 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

2099 
disks
 = 
sh
->disks, 
i
;

2100 
md_rdev
 *
	`unöôülized_v¨
(
rdev
);

2101 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

2102 
£˘‹_t
 
fú°_bad
;

2103 
bad_£˘‹s
;

2104 
ª∂a˚mít
 = 0;

2106 
i
 = 0 ; i < 
disks
; i++) {

2107 i‡(
bi
 =&
sh
->
dev
[
i
].
ªq
) {

2108 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

2111 i‡(
bi
 =&
sh
->
dev
[
i
].
ºeq
) {

2112 
rdev
 = 
c⁄f
->
disks
[
i
].
ª∂a˚mít
;

2113 i‡(
rdev
)

2114 
ª∂a˚mít
 = 1;

2120 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

2124 
	`¥_debug
("end_write_request %llu/%d, count %d, uptodate: %d.\n",

2125 ()
sh
->
£˘‹
, 
i
, 
	`©omic_ªad
(&sh->
cou¡
),

2126 
u±od©e
);

2127 i‡(
i
 =
disks
) {

2128 
	`BUG
();

2132 i‡(
ª∂a˚mít
) {

2133 i‡(!
u±od©e
)

2134 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2135 i‡(
	`is_badblock
(
rdev
, 
sh
->
£˘‹
,

2136 
STRIPE_SECTORS
,

2137 &
fú°_bad
, &
bad_£˘‹s
))

2138 
	`£t_bô
(
R5_MadeGoodRïl
, &
sh
->
dev
[
i
].
Êags
);

2140 i‡(!
u±od©e
) {

2141 
	`£t_bô
(
STRIPE_DEGRADED
, &
sh
->
°©e
);

2142 
	`£t_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
);

2143 
	`£t_bô
(
R5_WrôeEº‹
, &
sh
->
dev
[
i
].
Êags
);

2144 i‡(!
	`ã°_™d_£t_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
))

2145 
	`£t_bô
(
MD_RECOVERY_NEEDED
,

2146 &
rdev
->
mddev
->
ªcovîy
);

2147 } i‡(
	`is_badblock
(
rdev
, 
sh
->
£˘‹
,

2148 
STRIPE_SECTORS
,

2149 &
fú°_bad
, &
bad_£˘‹s
)) {

2150 
	`£t_bô
(
R5_MadeGood
, &
sh
->
dev
[
i
].
Êags
);

2151 i‡(
	`ã°_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
))

2156 
	`£t_bô
(
R5_ReWrôe
, &
sh
->
dev
[
i
].
Êags
);

2159 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2161 i‡(!
	`ã°_™d_˛ór_bô
(
R5_DOUBLE_LOCKED
, &
sh
->
dev
[
i
].
Êags
))

2162 
	`˛ór_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

2163 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

2164 
	`ªÀa£_°rùe
(
sh
);

2165 
	}
}

2167 
£˘‹_t
 
compuã_blockƒ
(
°rùe_hód
 *
sh
, 
i
, 
¥evious
);

2169 
	$øid5_buûd_block
(
°rùe_hód
 *
sh
, 
i
, 
¥evious
)

2171 
r5dev
 *
dev
 = &
sh
->dev[
i
];

2173 
	`bio_öô
(&
dev
->
ªq
);

2174 
dev
->
ªq
.
bi_io_vec
 = &dev->
vec
;

2175 
dev
->
ªq
.
bi_max_vecs
 = 1;

2176 
dev
->
ªq
.
bi_¥iv©e
 = 
sh
;

2178 
	`bio_öô
(&
dev
->
ºeq
);

2179 
dev
->
ºeq
.
bi_io_vec
 = &dev->
rvec
;

2180 
dev
->
ºeq
.
bi_max_vecs
 = 1;

2181 
dev
->
ºeq
.
bi_¥iv©e
 = 
sh
;

2183 
dev
->
Êags
 = 0;

2184 
dev
->
£˘‹
 = 
	`compuã_blockƒ
(
sh
, 
i
, 
¥evious
);

2185 
	}
}

2187 
	$îr‹
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

2189 
b
[
BDEVNAME_SIZE
];

2190 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

2191 
Êags
;

2192 
	`¥_debug
("raid456:Érror called\n");

2194 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2195 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

2196 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

2197 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

2198 
	`£t_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
);

2200 
	`£t_bô
(
Blocked
, &
rdev
->
Êags
);

2201 
	`£t_bô
(
Fau…y
, &
rdev
->
Êags
);

2202 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

2203 
	`¥ötk
(
KERN_ALERT


2206 
	`md«me
(
mddev
),

2207 
	`bdev«me
(
rdev
->
bdev
, 
b
),

2208 
	`md«me
(
mddev
),

2209 
c⁄f
->
øid_disks
 - 
mddev
->
degøded
);

2210 
	}
}

2216 
£˘‹_t
 
	$øid5_compuã_£˘‹
(
r5c⁄f
 *
c⁄f
, 
£˘‹_t
 
r_£˘‹
,

2217 
¥evious
, *
dd_idx
,

2218 
°rùe_hód
 *
sh
)

2220 
£˘‹_t
 
°rùe
, 
°rùe2
;

2221 
£˘‹_t
 
chunk_numbî
;

2222 
chunk_off£t
;

2223 
pd_idx
, 
qd_idx
;

2224 
ddf_œyout
 = 0;

2225 
£˘‹_t
 
√w_£˘‹
;

2226 
Æg‹ôhm
 = 
¥evious
 ? 
c⁄f
->
¥ev_Ægo


2227 : 
c⁄f
->
Æg‹ôhm
;

2228 
£˘‹s_≥r_chunk
 = 
¥evious
 ? 
c⁄f
->
¥ev_chunk_£˘‹s


2229 : 
c⁄f
->
chunk_£˘‹s
;

2230 
øid_disks
 = 
¥evious
 ? 
c⁄f
->
¥evious_øid_disks


2231 : 
c⁄f
->
øid_disks
;

2232 
d©a_disks
 = 
øid_disks
 - 
c⁄f
->
max_degøded
;

2239 
chunk_off£t
 = 
	`£˘‹_div
(
r_£˘‹
, 
£˘‹s_≥r_chunk
);

2240 
chunk_numbî
 = 
r_£˘‹
;

2245 
°rùe
 = 
chunk_numbî
;

2246 *
dd_idx
 = 
	`£˘‹_div
(
°rùe
, 
d©a_disks
);

2247 
°rùe2
 = 
°rùe
;

2251 
pd_idx
 = 
qd_idx
 = -1;

2252 
c⁄f
->
Àvñ
) {

2254 
pd_idx
 = 
d©a_disks
;

2257 
Æg‹ôhm
) {

2258 
ALGORITHM_LEFT_ASYMMETRIC
:

2259 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2260 i‡(*
dd_idx
 >
pd_idx
)

2261 (*
dd_idx
)++;

2263 
ALGORITHM_RIGHT_ASYMMETRIC
:

2264 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2265 i‡(*
dd_idx
 >
pd_idx
)

2266 (*
dd_idx
)++;

2268 
ALGORITHM_LEFT_SYMMETRIC
:

2269 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2270 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

2272 
ALGORITHM_RIGHT_SYMMETRIC
:

2273 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2274 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

2276 
ALGORITHM_PARITY_0
:

2277 
pd_idx
 = 0;

2278 (*
dd_idx
)++;

2280 
ALGORITHM_PARITY_N
:

2281 
pd_idx
 = 
d©a_disks
;

2284 
	`BUG
();

2289 
Æg‹ôhm
) {

2290 
ALGORITHM_LEFT_ASYMMETRIC
:

2291 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

2292 
qd_idx
 = 
pd_idx
 + 1;

2293 i‡(
pd_idx
 =
øid_disks
-1) {

2294 (*
dd_idx
)++;

2295 
qd_idx
 = 0;

2296 } i‡(*
dd_idx
 >
pd_idx
)

2297 (*
dd_idx
) += 2;

2299 
ALGORITHM_RIGHT_ASYMMETRIC
:

2300 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2301 
qd_idx
 = 
pd_idx
 + 1;

2302 i‡(
pd_idx
 =
øid_disks
-1) {

2303 (*
dd_idx
)++;

2304 
qd_idx
 = 0;

2305 } i‡(*
dd_idx
 >
pd_idx
)

2306 (*
dd_idx
) += 2;

2308 
ALGORITHM_LEFT_SYMMETRIC
:

2309 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

2310 
qd_idx
 = (
pd_idx
 + 1Ë% 
øid_disks
;

2311 *
dd_idx
 = (
pd_idx
 + 2 + *dd_idxË% 
øid_disks
;

2313 
ALGORITHM_RIGHT_SYMMETRIC
:

2314 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2315 
qd_idx
 = (
pd_idx
 + 1Ë% 
øid_disks
;

2316 *
dd_idx
 = (
pd_idx
 + 2 + *dd_idxË% 
øid_disks
;

2319 
ALGORITHM_PARITY_0
:

2320 
pd_idx
 = 0;

2321 
qd_idx
 = 1;

2322 (*
dd_idx
) += 2;

2324 
ALGORITHM_PARITY_N
:

2325 
pd_idx
 = 
d©a_disks
;

2326 
qd_idx
 = 
d©a_disks
 + 1;

2329 
ALGORITHM_ROTATING_ZERO_RESTART
:

2333 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
);

2334 
qd_idx
 = 
pd_idx
 + 1;

2335 i‡(
pd_idx
 =
øid_disks
-1) {

2336 (*
dd_idx
)++;

2337 
qd_idx
 = 0;

2338 } i‡(*
dd_idx
 >
pd_idx
)

2339 (*
dd_idx
) += 2;

2340 
ddf_œyout
 = 1;

2343 
ALGORITHM_ROTATING_N_RESTART
:

2348 
°rùe2
 += 1;

2349 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

2350 
qd_idx
 = 
pd_idx
 + 1;

2351 i‡(
pd_idx
 =
øid_disks
-1) {

2352 (*
dd_idx
)++;

2353 
qd_idx
 = 0;

2354 } i‡(*
dd_idx
 >
pd_idx
)

2355 (*
dd_idx
) += 2;

2356 
ddf_œyout
 = 1;

2359 
ALGORITHM_ROTATING_N_CONTINUE
:

2361 
pd_idx
 = 
øid_disks
 - 1 - 
	`£˘‹_div
(
°rùe2
,Ñaid_disks);

2362 
qd_idx
 = (
pd_idx
 + 
øid_disks
 - 1) %Ñaid_disks;

2363 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% 
øid_disks
;

2364 
ddf_œyout
 = 1;

2367 
ALGORITHM_LEFT_ASYMMETRIC_6
:

2369 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

2370 i‡(*
dd_idx
 >
pd_idx
)

2371 (*
dd_idx
)++;

2372 
qd_idx
 = 
øid_disks
 - 1;

2375 
ALGORITHM_RIGHT_ASYMMETRIC_6
:

2376 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

2377 i‡(*
dd_idx
 >
pd_idx
)

2378 (*
dd_idx
)++;

2379 
qd_idx
 = 
øid_disks
 - 1;

2382 
ALGORITHM_LEFT_SYMMETRIC_6
:

2383 
pd_idx
 = 
d©a_disks
 - 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

2384 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% (
øid_disks
-1);

2385 
qd_idx
 = 
øid_disks
 - 1;

2388 
ALGORITHM_RIGHT_SYMMETRIC_6
:

2389 
pd_idx
 = 
	`£˘‹_div
(
°rùe2
, 
øid_disks
-1);

2390 *
dd_idx
 = (
pd_idx
 + 1 + *dd_idxË% (
øid_disks
-1);

2391 
qd_idx
 = 
øid_disks
 - 1;

2394 
ALGORITHM_PARITY_0_6
:

2395 
pd_idx
 = 0;

2396 (*
dd_idx
)++;

2397 
qd_idx
 = 
øid_disks
 - 1;

2401 
	`BUG
();

2406 i‡(
sh
) {

2407 
sh
->
pd_idx
 =Öd_idx;

2408 
sh
->
qd_idx
 = qd_idx;

2409 
sh
->
ddf_œyout
 = ddf_layout;

2414 
√w_£˘‹
 = (
£˘‹_t
)
°rùe
 * 
£˘‹s_≥r_chunk
 + 
chunk_off£t
;

2415  
√w_£˘‹
;

2416 
	}
}

2419 
£˘‹_t
 
	$compuã_blockƒ
(
°rùe_hód
 *
sh
, 
i
, 
¥evious
)

2421 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

2422 
øid_disks
 = 
sh
->
disks
;

2423 
d©a_disks
 = 
øid_disks
 - 
c⁄f
->
max_degøded
;

2424 
£˘‹_t
 
√w_£˘‹
 = 
sh
->
£˘‹
, 
check
;

2425 
£˘‹s_≥r_chunk
 = 
¥evious
 ? 
c⁄f
->
¥ev_chunk_£˘‹s


2426 : 
c⁄f
->
chunk_£˘‹s
;

2427 
Æg‹ôhm
 = 
¥evious
 ? 
c⁄f
->
¥ev_Ægo


2428 : 
c⁄f
->
Æg‹ôhm
;

2429 
£˘‹_t
 
°rùe
;

2430 
chunk_off£t
;

2431 
£˘‹_t
 
chunk_numbî
;

2432 
dummy1
, 
dd_idx
 = 
i
;

2433 
£˘‹_t
 
r_£˘‹
;

2434 
°rùe_hód
 
sh2
;

2437 
chunk_off£t
 = 
	`£˘‹_div
(
√w_£˘‹
, 
£˘‹s_≥r_chunk
);

2438 
°rùe
 = 
√w_£˘‹
;

2440 i‡(
i
 =
sh
->
pd_idx
)

2442 
c⁄f
->
Àvñ
) {

2445 
Æg‹ôhm
) {

2446 
ALGORITHM_LEFT_ASYMMETRIC
:

2447 
ALGORITHM_RIGHT_ASYMMETRIC
:

2448 i‡(
i
 > 
sh
->
pd_idx
)

2449 
i
--;

2451 
ALGORITHM_LEFT_SYMMETRIC
:

2452 
ALGORITHM_RIGHT_SYMMETRIC
:

2453 i‡(
i
 < 
sh
->
pd_idx
)

2454 
i
 +
øid_disks
;

2455 
i
 -(
sh
->
pd_idx
 + 1);

2457 
ALGORITHM_PARITY_0
:

2458 
i
 -= 1;

2460 
ALGORITHM_PARITY_N
:

2463 
	`BUG
();

2467 i‡(
i
 =
sh
->
qd_idx
)

2469 
Æg‹ôhm
) {

2470 
ALGORITHM_LEFT_ASYMMETRIC
:

2471 
ALGORITHM_RIGHT_ASYMMETRIC
:

2472 
ALGORITHM_ROTATING_ZERO_RESTART
:

2473 
ALGORITHM_ROTATING_N_RESTART
:

2474 i‡(
sh
->
pd_idx
 =
øid_disks
-1)

2475 
i
--;

2476 i‡(
i
 > 
sh
->
pd_idx
)

2477 
i
 -= 2;

2479 
ALGORITHM_LEFT_SYMMETRIC
:

2480 
ALGORITHM_RIGHT_SYMMETRIC
:

2481 i‡(
sh
->
pd_idx
 =
øid_disks
-1)

2482 
i
--;

2485 i‡(
i
 < 
sh
->
pd_idx
)

2486 
i
 +
øid_disks
;

2487 
i
 -(
sh
->
pd_idx
 + 2);

2490 
ALGORITHM_PARITY_0
:

2491 
i
 -= 2;

2493 
ALGORITHM_PARITY_N
:

2495 
ALGORITHM_ROTATING_N_CONTINUE
:

2497 i‡(
sh
->
pd_idx
 == 0)

2498 
i
--;

2501 i‡(
i
 < 
sh
->
pd_idx
)

2502 
i
 +
øid_disks
;

2503 
i
 -(
sh
->
pd_idx
 + 1);

2506 
ALGORITHM_LEFT_ASYMMETRIC_6
:

2507 
ALGORITHM_RIGHT_ASYMMETRIC_6
:

2508 i‡(
i
 > 
sh
->
pd_idx
)

2509 
i
--;

2511 
ALGORITHM_LEFT_SYMMETRIC_6
:

2512 
ALGORITHM_RIGHT_SYMMETRIC_6
:

2513 i‡(
i
 < 
sh
->
pd_idx
)

2514 
i
 +
d©a_disks
 + 1;

2515 
i
 -(
sh
->
pd_idx
 + 1);

2517 
ALGORITHM_PARITY_0_6
:

2518 
i
 -= 1;

2521 
	`BUG
();

2526 
chunk_numbî
 = 
°rùe
 * 
d©a_disks
 + 
i
;

2527 
r_£˘‹
 = 
chunk_numbî
 * 
£˘‹s_≥r_chunk
 + 
chunk_off£t
;

2529 
check
 = 
	`øid5_compuã_£˘‹
(
c⁄f
, 
r_£˘‹
,

2530 
¥evious
, &
dummy1
, &
sh2
);

2531 i‡(
check
 !
sh
->
£˘‹
 || 
dummy1
 !
dd_idx
 || 
sh2
.
pd_idx
 != sh->pd_idx

2532 || 
sh2
.
qd_idx
 !
sh
->qd_idx) {

2533 
	`¥ötk
(
KERN_ERR
 "md/raid:%s: compute_blocknr: mapÇot correct\n",

2534 
	`md«me
(
c⁄f
->
mddev
));

2537  
r_£˘‹
;

2538 
	}
}

2542 
	$scheduÀ_ªc⁄°ru˘i⁄
(
°rùe_hód
 *
sh
, 
°rùe_hód_°©e
 *
s
,

2543 
rcw
, 
ex∑nd
)

2545 
i
, 
pd_idx
 = 
sh
->pd_idx, 
disks
 = sh->disks;

2546 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

2547 
Àvñ
 = 
c⁄f
->level;

2549 i‡(
rcw
) {

2551 
i
 = 
disks
; i--; ) {

2552 
r5dev
 *
dev
 = &
sh
->dev[
i
];

2554 i‡(
dev
->
towrôe
) {

2555 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

2556 
	`£t_bô
(
R5_W™tdøö
, &
dev
->
Êags
);

2557 i‡(!
ex∑nd
)

2558 
	`˛ór_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

2559 
s
->
locked
++;

2566 i‡(!
ex∑nd
) {

2567 i‡(!
s
->
locked
)

2570 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_døö_run
;

2571 
	`£t_bô
(
STRIPE_OP_BIODRAIN
, &
s
->
›s_ªque°
);

2573 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_run
;

2575 
	`£t_bô
(
STRIPE_OP_RECONSTRUCT
, &
s
->
›s_ªque°
);

2577 i‡(
s
->
locked
 + 
c⁄f
->
max_degøded
 =
disks
)

2578 i‡(!
	`ã°_™d_£t_bô
(
STRIPE_FULL_WRITE
, &
sh
->
°©e
))

2579 
	`©omic_öc
(&
c⁄f
->
≥ndög_fuŒ_wrôes
);

2581 
	`BUG_ON
(
Àvñ
 == 6);

2582 
	`BUG_ON
(!(
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[
pd_idx
].
Êags
) ||

2583 
	`ã°_bô
(
R5_W™tcompuã
, &
sh
->
dev
[
pd_idx
].
Êags
)));

2585 
i
 = 
disks
; i--; ) {

2586 
r5dev
 *
dev
 = &
sh
->dev[
i
];

2587 i‡(
i
 =
pd_idx
)

2590 i‡(
dev
->
towrôe
 &&

2591 (
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

2592 
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
))) {

2593 
	`£t_bô
(
R5_W™tdøö
, &
dev
->
Êags
);

2594 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

2595 
	`˛ór_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

2596 
s
->
locked
++;

2599 i‡(!
s
->
locked
)

2602 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_¥ex‹_døö_run
;

2603 
	`£t_bô
(
STRIPE_OP_PREXOR
, &
s
->
›s_ªque°
);

2604 
	`£t_bô
(
STRIPE_OP_BIODRAIN
, &
s
->
›s_ªque°
);

2605 
	`£t_bô
(
STRIPE_OP_RECONSTRUCT
, &
s
->
›s_ªque°
);

2611 
	`£t_bô
(
R5_LOCKED
, &
sh
->
dev
[
pd_idx
].
Êags
);

2612 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[
pd_idx
].
Êags
);

2613 
s
->
locked
++;

2615 i‡(
Àvñ
 == 6) {

2616 
qd_idx
 = 
sh
->qd_idx;

2617 
r5dev
 *
dev
 = &
sh
->dev[
qd_idx
];

2619 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

2620 
	`˛ór_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

2621 
s
->
locked
++;

2624 
	`¥_debug
("%s: stripe %lluÜocked: %d ops_request: %lx\n",

2625 
__func__
, ()
sh
->
£˘‹
,

2626 
s
->
locked
, s->
›s_ªque°
);

2627 
	}
}

2634 
	$add_°rùe_bio
(
°rùe_hód
 *
sh
, 
bio
 *
bi
, 
dd_idx
, 
f‹wrôe
)

2636 
bio
 **
bù
;

2637 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

2638 
fú°wrôe
=0;

2640 
	`¥_debug
("adding bi b#%lluÅo stripe s#%llu\n",

2641 ()
bi
->
bi_ôî
.
bi_£˘‹
,

2642 ()
sh
->
£˘‹
);

2652 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

2653 i‡(
f‹wrôe
) {

2654 
bù
 = &
sh
->
dev
[
dd_idx
].
towrôe
;

2655 i‡(*
bù
 =
NULL
)

2656 
fú°wrôe
 = 1;

2658 
bù
 = &
sh
->
dev
[
dd_idx
].
t‹ód
;

2659 *
bù
 && (*bù)->
bi_ôî
.
bi_£˘‹
 < 
bi
->bi_iter.bi_sector) {

2660 i‡(
	`bio_íd_£˘‹
(*
bù
Ë> 
bi
->
bi_ôî
.
bi_£˘‹
)

2661 
ovîœp
;

2662 
bù
 = & (*bù)->
bi_√xt
;

2664 i‡(*
bù
 && (*bù)->
bi_ôî
.
bi_£˘‹
 < 
	`bio_íd_£˘‹
(
bi
))

2665 
ovîœp
;

2667 
	`BUG_ON
(*
bù
 && 
bi
->
bi_√xt
 && (*bip) != bi->bi_next);

2668 i‡(*
bù
)

2669 
bi
->
bi_√xt
 = *
bù
;

2670 *
bù
 = 
bi
;

2671 
	`øid5_öc_bi_a˘ive_°rùes
(
bi
);

2673 i‡(
f‹wrôe
) {

2675 
£˘‹_t
 
£˘‹
 = 
sh
->
dev
[
dd_idx
].sector;

2676 
bi
=
sh
->
dev
[
dd_idx
].
towrôe
;

2677 
£˘‹
 < 
sh
->
dev
[
dd_idx
].£˘‹ + 
STRIPE_SECTORS
 &&

2678 
bi
 && bi->
bi_ôî
.
bi_£˘‹
 <
£˘‹
;

2679 
bi
 = 
	`r5_√xt_bio
(bi, 
sh
->
dev
[
dd_idx
].
£˘‹
)) {

2680 i‡(
	`bio_íd_£˘‹
(
bi
Ë>
£˘‹
)

2681 
£˘‹
 = 
	`bio_íd_£˘‹
(
bi
);

2683 i‡(
£˘‹
 >
sh
->
dev
[
dd_idx
].£˘‹ + 
STRIPE_SECTORS
)

2684 
	`£t_bô
(
R5_OVERWRITE
, &
sh
->
dev
[
dd_idx
].
Êags
);

2687 
	`¥_debug
("added bi b#%lluÅo stripe s#%llu, disk %d.\n",

2688 ()(*
bù
)->
bi_ôî
.
bi_£˘‹
,

2689 ()
sh
->
£˘‹
, 
dd_idx
);

2690 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

2692 i‡(
c⁄f
->
mddev
->
bôm≠
 && 
fú°wrôe
) {

2693 
	`bôm≠_°¨twrôe
(
c⁄f
->
mddev
->
bôm≠
, 
sh
->
£˘‹
,

2694 
STRIPE_SECTORS
, 0);

2695 
sh
->
bm_£q
 = 
c⁄f
->
£q_Êush
+1;

2696 
	`£t_bô
(
STRIPE_BIT_DELAY
, &
sh
->
°©e
);

2700 
ovîœp
:

2701 
	`£t_bô
(
R5_Ovîœp
, &
sh
->
dev
[
dd_idx
].
Êags
);

2702 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

2704 
	}
}

2706 
íd_ªsh≠e
(
r5c⁄f
 *
c⁄f
);

2708 
	$°rùe_£t_idx
(
£˘‹_t
 
°rùe
, 
r5c⁄f
 *
c⁄f
, 
¥evious
,

2709 
°rùe_hód
 *
sh
)

2711 
£˘‹s_≥r_chunk
 =

2712 
¥evious
 ? 
c⁄f
->
¥ev_chunk_£˘‹s
 : c⁄f->
chunk_£˘‹s
;

2713 
dd_idx
;

2714 
chunk_off£t
 = 
	`£˘‹_div
(
°rùe
, 
£˘‹s_≥r_chunk
);

2715 
disks
 = 
¥evious
 ? 
c⁄f
->
¥evious_øid_disks
 : c⁄f->
øid_disks
;

2717 
	`øid5_compuã_£˘‹
(
c⁄f
,

2718 
°rùe
 * (
disks
 - 
c⁄f
->
max_degøded
)

2719 *
£˘‹s_≥r_chunk
 + 
chunk_off£t
,

2720 
¥evious
,

2721 &
dd_idx
, 
sh
);

2722 
	}
}

2725 
	$h™dÀ_Áûed_°rùe
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

2726 
°rùe_hód_°©e
 *
s
, 
disks
,

2727 
bio
 **
ªtu∫_bi
)

2729 
i
;

2730 
i
 = 
disks
; i--; ) {

2731 
bio
 *
bi
;

2732 
bôm≠_íd
 = 0;

2734 i‡(
	`ã°_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
)) {

2735 
md_rdev
 *
rdev
;

2736 
	`rcu_ªad_lock
();

2737 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].rdev);

2738 i‡(
rdev
 && 
	`ã°_bô
(
In_sync
, &rdev->
Êags
))

2739 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

2741 
rdev
 = 
NULL
;

2742 
	`rcu_ªad_u∆ock
();

2743 i‡(
rdev
) {

2744 i‡(!
	`rdev_£t_badblocks
(

2745 
rdev
,

2746 
sh
->
£˘‹
,

2747 
STRIPE_SECTORS
, 0))

2748 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

2749 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

2752 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

2754 
bi
 = 
sh
->
dev
[
i
].
towrôe
;

2755 
sh
->
dev
[
i
].
towrôe
 = 
NULL
;

2756 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

2757 i‡(
bi
)

2758 
bôm≠_íd
 = 1;

2760 i‡(
	`ã°_™d_˛ór_bô
(
R5_Ovîœp
, &
sh
->
dev
[
i
].
Êags
))

2761 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

2763 
bi
 && bi->
bi_ôî
.
bi_£˘‹
 <

2764 
sh
->
dev
[
i
].
£˘‹
 + 
STRIPE_SECTORS
) {

2765 
bio
 *
√xtbi
 = 
	`r5_√xt_bio
(
bi
, 
sh
->
dev
[
i
].
£˘‹
);

2766 
	`˛ór_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

2767 i‡(!
	`øid5_dec_bi_a˘ive_°rùes
(
bi
)) {

2768 
	`md_wrôe_íd
(
c⁄f
->
mddev
);

2769 
bi
->
bi_√xt
 = *
ªtu∫_bi
;

2770 *
ªtu∫_bi
 = 
bi
;

2772 
bi
 = 
√xtbi
;

2774 i‡(
bôm≠_íd
)

2775 
	`bôm≠_ídwrôe
(
c⁄f
->
mddev
->
bôm≠
, 
sh
->
£˘‹
,

2776 
STRIPE_SECTORS
, 0, 0);

2777 
bôm≠_íd
 = 0;

2779 
bi
 = 
sh
->
dev
[
i
].
wrôãn
;

2780 
sh
->
dev
[
i
].
wrôãn
 = 
NULL
;

2781 i‡(
	`ã°_™d_˛ór_bô
(
R5_SkùC›y
, &
sh
->
dev
[
i
].
Êags
)) {

2782 
	`WARN_ON
(
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
));

2783 
sh
->
dev
[
i
].
∑ge
 = sh->dev[i].
‹ig_∑ge
;

2786 i‡(
bi
Ë
bôm≠_íd
 = 1;

2787 
bi
 && bi->
bi_ôî
.
bi_£˘‹
 <

2788 
sh
->
dev
[
i
].
£˘‹
 + 
STRIPE_SECTORS
) {

2789 
bio
 *
bi2
 = 
	`r5_√xt_bio
(
bi
, 
sh
->
dev
[
i
].
£˘‹
);

2790 
	`˛ór_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

2791 i‡(!
	`øid5_dec_bi_a˘ive_°rùes
(
bi
)) {

2792 
	`md_wrôe_íd
(
c⁄f
->
mddev
);

2793 
bi
->
bi_√xt
 = *
ªtu∫_bi
;

2794 *
ªtu∫_bi
 = 
bi
;

2796 
bi
 = 
bi2
;

2802 i‡(!
	`ã°_bô
(
R5_W™tfûl
, &
sh
->
dev
[
i
].
Êags
) &&

2803 (!
	`ã°_bô
(
R5_Insync
, &
sh
->
dev
[
i
].
Êags
) ||

2804 
	`ã°_bô
(
R5_RódEº‹
, &
sh
->
dev
[
i
].
Êags
))) {

2805 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

2806 
bi
 = 
sh
->
dev
[
i
].
t‹ód
;

2807 
sh
->
dev
[
i
].
t‹ód
 = 
NULL
;

2808 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

2809 i‡(
	`ã°_™d_˛ór_bô
(
R5_Ovîœp
, &
sh
->
dev
[
i
].
Êags
))

2810 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

2811 
bi
 && bi->
bi_ôî
.
bi_£˘‹
 <

2812 
sh
->
dev
[
i
].
£˘‹
 + 
STRIPE_SECTORS
) {

2813 
bio
 *
√xtbi
 =

2814 
	`r5_√xt_bio
(
bi
, 
sh
->
dev
[
i
].
£˘‹
);

2815 
	`˛ór_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

2816 i‡(!
	`øid5_dec_bi_a˘ive_°rùes
(
bi
)) {

2817 
bi
->
bi_√xt
 = *
ªtu∫_bi
;

2818 *
ªtu∫_bi
 = 
bi
;

2820 
bi
 = 
√xtbi
;

2823 i‡(
bôm≠_íd
)

2824 
	`bôm≠_ídwrôe
(
c⁄f
->
mddev
->
bôm≠
, 
sh
->
£˘‹
,

2825 
STRIPE_SECTORS
, 0, 0);

2829 
	`˛ór_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

2832 i‡(
	`ã°_™d_˛ór_bô
(
STRIPE_FULL_WRITE
, &
sh
->
°©e
))

2833 i‡(
	`©omic_dec_™d_ã°
(&
c⁄f
->
≥ndög_fuŒ_wrôes
))

2834 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

2835 
	}
}

2838 
	$h™dÀ_Áûed_sync
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

2839 
°rùe_hód_°©e
 *
s
)

2841 
ab‹t
 = 0;

2842 
i
;

2844 
	`˛ór_bô
(
STRIPE_SYNCING
, &
sh
->
°©e
);

2845 i‡(
	`ã°_™d_˛ór_bô
(
R5_Ovîœp
, &
sh
->
dev
[sh->
pd_idx
].
Êags
))

2846 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

2847 
s
->
syncög
 = 0;

2848 
s
->
ª∂acög
 = 0;

2856 i‡(
	`ã°_bô
(
MD_RECOVERY_RECOVER
, &
c⁄f
->
mddev
->
ªcovîy
)) {

2860 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

2861 
md_rdev
 *
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

2862 i‡(
rdev


2863 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)

2864 && !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

2865 && !
	`rdev_£t_badblocks
(
rdev
, 
sh
->
£˘‹
,

2866 
STRIPE_SECTORS
, 0))

2867 
ab‹t
 = 1;

2868 
rdev
 = 
c⁄f
->
disks
[
i
].
ª∂a˚mít
;

2869 i‡(
rdev


2870 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)

2871 && !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

2872 && !
	`rdev_£t_badblocks
(
rdev
, 
sh
->
£˘‹
,

2873 
STRIPE_SECTORS
, 0))

2874 
ab‹t
 = 1;

2876 i‡(
ab‹t
)

2877 
c⁄f
->
ªcovîy_dißbÀd
 =

2878 
c⁄f
->
mddev
->
ªcovîy_dißbÀd
;

2880 
	`md_d⁄e_sync
(
c⁄f
->
mddev
, 
STRIPE_SECTORS
, !
ab‹t
);

2881 
	}
}

2883 
	$w™t_ª∂a˚
(
°rùe_hód
 *
sh
, 
disk_idx
)

2885 
md_rdev
 *
rdev
;

2886 
rv
 = 0;

2888 
rdev
 = 
sh
->
øid_c⁄f
->
disks
[
disk_idx
].
ª∂a˚mít
;

2889 i‡(
rdev


2890 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)

2891 && !
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

2892 && (
rdev
->
ªcovîy_off£t
 <
sh
->
£˘‹


2893 || 
rdev
->
mddev
->
ªcovîy_˝
 <
sh
->
£˘‹
))

2894 
rv
 = 1;

2896  
rv
;

2897 
	}
}

2905 
	$„tch_block
(
°rùe_hód
 *
sh
, 
°rùe_hód_°©e
 *
s
,

2906 
disk_idx
, 
disks
)

2908 
r5dev
 *
dev
 = &
sh
->dev[
disk_idx
];

2909 
r5dev
 *
fdev
[2] = { &
sh
->
dev
[
s
->
Áûed_num
[0]],

2910 &
sh
->
dev
[
s
->
Áûed_num
[1]] };

2913 i‡(!
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

2914 !
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) &&

2915 (
dev
->
t‹ód
 ||

2916 (
dev
->
towrôe
 && !
	`ã°_bô
(
R5_OVERWRITE
, &dev->
Êags
)) ||

2917 
s
->
syncög
 || s->
ex∑ndög
 ||

2918 (
s
->
ª∂acög
 && 
	`w™t_ª∂a˚
(
sh
, 
disk_idx
)) ||

2919 (
s
->
Áûed
 >1 && 
fdev
[0]->
t‹ód
) ||

2920 (
s
->
Áûed
 >2 && 
fdev
[1]->
t‹ód
) ||

2921 (
sh
->
øid_c⁄f
->
Àvñ
 <5 && 
s
->
Áûed
 && 
fdev
[0]->
towrôe
 &&

2922 (!
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
Ë||Åe°_bô(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
)) &&

2923 !
	`ã°_bô
(
R5_OVERWRITE
, &
fdev
[0]->
Êags
)) ||

2924 (
sh
->
øid_c⁄f
->
Àvñ
 =6 && 
s
->
Áûed
 && s->
to_wrôe
 &&

2925 
s
->
to_wrôe
 - s->
n⁄_ovîwrôe
 < 
sh
->
øid_c⁄f
->
øid_disks
 - 2 &&

2926 (!
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
Ë||Åe°_bô(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))))) {

2930 
	`BUG_ON
(
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
));

2931 
	`BUG_ON
(
	`ã°_bô
(
R5_W™åód
, &
dev
->
Êags
));

2932 i‡((
s
->
u±od©e
 =
disks
 - 1) &&

2933 (
s
->
Áûed
 && (
disk_idx
 =s->
Áûed_num
[0] ||

2934 
disk_idx
 =
s
->
Áûed_num
[1]))) {

2938 
	`¥_debug
("Computing stripe %llu block %d\n",

2939 ()
sh
->
£˘‹
, 
disk_idx
);

2940 
	`£t_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

2941 
	`£t_bô
(
STRIPE_OP_COMPUTE_BLK
, &
s
->
›s_ªque°
);

2942 
	`£t_bô
(
R5_W™tcompuã
, &
dev
->
Êags
);

2943 
sh
->
›s
.
èrgë
 = 
disk_idx
;

2944 
sh
->
›s
.
èrgë2
 = -1;

2945 
s
->
ªq_compuã
 = 1;

2952 
s
->
u±od©e
++;

2954 } i‡(
s
->
u±od©e
 =
disks
-2 && s->
Áûed
 >= 2) {

2958 
Ÿhî
;

2959 
Ÿhî
 = 
disks
; other--; ) {

2960 i‡(
Ÿhî
 =
disk_idx
)

2962 i‡(!
	`ã°_bô
(
R5_UPTODATE
,

2963 &
sh
->
dev
[
Ÿhî
].
Êags
))

2966 
	`BUG_ON
(
Ÿhî
 < 0);

2967 
	`¥_debug
("Computing stripe %llu blocks %d,%d\n",

2968 ()
sh
->
£˘‹
,

2969 
disk_idx
, 
Ÿhî
);

2970 
	`£t_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

2971 
	`£t_bô
(
STRIPE_OP_COMPUTE_BLK
, &
s
->
›s_ªque°
);

2972 
	`£t_bô
(
R5_W™tcompuã
, &
sh
->
dev
[
disk_idx
].
Êags
);

2973 
	`£t_bô
(
R5_W™tcompuã
, &
sh
->
dev
[
Ÿhî
].
Êags
);

2974 
sh
->
›s
.
èrgë
 = 
disk_idx
;

2975 
sh
->
›s
.
èrgë2
 = 
Ÿhî
;

2976 
s
->
u±od©e
 += 2;

2977 
s
->
ªq_compuã
 = 1;

2979 } i‡(
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
)) {

2980 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

2981 
	`£t_bô
(
R5_W™åód
, &
dev
->
Êags
);

2982 
s
->
locked
++;

2983 
	`¥_debug
("Reading block %d (sync=%d)\n",

2984 
disk_idx
, 
s
->
syncög
);

2989 
	}
}

2994 
	$h™dÀ_°rùe_fûl
(
°rùe_hód
 *
sh
,

2995 
°rùe_hód_°©e
 *
s
,

2996 
disks
)

2998 
i
;

3004 i‡(!
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
Ë&& !sh->
check_°©e
 &&

3005 !
sh
->
ªc⁄°ru˘_°©e
)

3006 
i
 = 
disks
; i--; )

3007 i‡(
	`„tch_block
(
sh
, 
s
, 
i
, 
disks
))

3009 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3010 
	}
}

3018 
	$h™dÀ_°rùe_˛ón_evít
(
r5c⁄f
 *
c⁄f
,

3019 
°rùe_hód
 *
sh
, 
disks
, 
bio
 **
ªtu∫_bi
)

3021 
i
;

3022 
r5dev
 *
dev
;

3023 
disˇrd_≥ndög
 = 0;

3025 
i
 = 
disks
; i--; )

3026 i‡(
sh
->
dev
[
i
].
wrôãn
) {

3027 
dev
 = &
sh
->dev[
i
];

3028 i‡(!
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3029 (
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

3030 
	`ã°_bô
(
R5_Disˇrd
, &
dev
->
Êags
) ||

3031 
	`ã°_bô
(
R5_SkùC›y
, &
dev
->
Êags
))) {

3033 
bio
 *
wbi
, *
wbi2
;

3034 
	`¥_debug
("Rëu∫ wrôêf‹ dis¯%d\n", 
i
);

3035 i‡(
	`ã°_™d_˛ór_bô
(
R5_Disˇrd
, &
dev
->
Êags
))

3036 
	`˛ór_bô
(
R5_UPTODATE
, &
dev
->
Êags
);

3037 i‡(
	`ã°_™d_˛ór_bô
(
R5_SkùC›y
, &
dev
->
Êags
)) {

3038 
	`WARN_ON
(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
));

3039 
dev
->
∑ge
 = dev->
‹ig_∑ge
;

3041 
wbi
 = 
dev
->
wrôãn
;

3042 
dev
->
wrôãn
 = 
NULL
;

3043 
wbi
 && wbi->
bi_ôî
.
bi_£˘‹
 <

3044 
dev
->
£˘‹
 + 
STRIPE_SECTORS
) {

3045 
wbi2
 = 
	`r5_√xt_bio
(
wbi
, 
dev
->
£˘‹
);

3046 i‡(!
	`øid5_dec_bi_a˘ive_°rùes
(
wbi
)) {

3047 
	`md_wrôe_íd
(
c⁄f
->
mddev
);

3048 
wbi
->
bi_√xt
 = *
ªtu∫_bi
;

3049 *
ªtu∫_bi
 = 
wbi
;

3051 
wbi
 = 
wbi2
;

3053 
	`bôm≠_ídwrôe
(
c⁄f
->
mddev
->
bôm≠
, 
sh
->
£˘‹
,

3054 
STRIPE_SECTORS
,

3055 !
	`ã°_bô
(
STRIPE_DEGRADED
, &
sh
->
°©e
),

3057 } i‡(
	`ã°_bô
(
R5_Disˇrd
, &
dev
->
Êags
))

3058 
disˇrd_≥ndög
 = 1;

3059 
	`WARN_ON
(
	`ã°_bô
(
R5_SkùC›y
, &
dev
->
Êags
));

3060 
	`WARN_ON
(
dev
->
∑ge
 !dev->
‹ig_∑ge
);

3062 i‡(!
disˇrd_≥ndög
 &&

3063 
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
pd_idx
].
Êags
)) {

3064 
	`˛ór_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

3065 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

3066 i‡(
sh
->
qd_idx
 >= 0) {

3067 
	`˛ór_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
qd_idx
].
Êags
);

3068 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[sh->
qd_idx
].
Êags
);

3071 
	`˛ór_bô
(
STRIPE_DISCARD
, &
sh
->
°©e
);

3077 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

3078 
	`ªmove_hash
(
sh
);

3079 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

3080 i‡(
	`ã°_bô
(
STRIPE_SYNC_REQUESTED
, &
sh
->
°©e
))

3081 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3085 i‡(
	`ã°_™d_˛ór_bô
(
STRIPE_FULL_WRITE
, &
sh
->
°©e
))

3086 i‡(
	`©omic_dec_™d_ã°
(&
c⁄f
->
≥ndög_fuŒ_wrôes
))

3087 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

3088 
	}
}

3090 
	$h™dÀ_°rùe_dútyög
(
r5c⁄f
 *
c⁄f
,

3091 
°rùe_hód
 *
sh
,

3092 
°rùe_hód_°©e
 *
s
,

3093 
disks
)

3095 
rmw
 = 0, 
rcw
 = 0, 
i
;

3096 
£˘‹_t
 
ªcovîy_˝
 = 
c⁄f
->
mddev
->recovery_cp;

3106 i‡(
c⁄f
->
max_degøded
 == 2 ||

3107 (
ªcovîy_˝
 < 
MaxSe˘‹
 && 
sh
->
£˘‹
 >=Ñecovery_cp)) {

3111 
rcw
 = 1; 
rmw
 = 2;

3112 
	`¥_debug
("force RCW max_degraded=%u,Ñecovery_cp=%llu sh->sector=%llu\n",

3113 
c⁄f
->
max_degøded
, ()
ªcovîy_˝
,

3114 ()
sh
->
£˘‹
);

3115 } 
i
 = 
disks
; i--; ) {

3117 
r5dev
 *
dev
 = &
sh
->dev[
i
];

3118 i‡((
dev
->
towrôe
 || 
i
 =
sh
->
pd_idx
) &&

3119 !
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3120 !(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

3121 
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
))) {

3122 i‡(
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
))

3123 
rmw
++;

3125 
rmw
 +2*
disks
;

3128 i‡(!
	`ã°_bô
(
R5_OVERWRITE
, &
dev
->
Êags
Ë&& 
i
 !
sh
->
pd_idx
 &&

3129 !
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3130 !(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

3131 
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
))) {

3132 i‡(
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
))

3133 
rcw
++;

3135 
rcw
 +2*
disks
;

3138 
	`¥_debug
("for sector %llu,Ñmw=%dÑcw=%d\n",

3139 ()
sh
->
£˘‹
, 
rmw
, 
rcw
);

3140 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3141 i‡(
rmw
 < 
rcw
 &&Ñmw > 0) {

3143 i‡(
c⁄f
->
mddev
->
queue
)

3144 
	`blk_add_åa˚_msg
(
c⁄f
->
mddev
->
queue
,

3146 ()
sh
->
£˘‹
, 
rmw
);

3147 
i
 = 
disks
; i--; ) {

3148 
r5dev
 *
dev
 = &
sh
->dev[
i
];

3149 i‡((
dev
->
towrôe
 || 
i
 =
sh
->
pd_idx
) &&

3150 !
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3151 !(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

3152 
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
)) &&

3153 
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
)) {

3154 i‡(
	`ã°_bô
(
STRIPE_PREREAD_ACTIVE
,

3155 &
sh
->
°©e
)) {

3156 
	`¥_debug
("Read_old block %d forÑ-m-w\n",

3157 
i
);

3158 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3159 
	`£t_bô
(
R5_W™åód
, &
dev
->
Êags
);

3160 
s
->
locked
++;

3162 
	`£t_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

3163 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3168 i‡(
rcw
 <
rmw
 &&Ñcw > 0) {

3170 
qªad
 =0;

3171 
rcw
 = 0;

3172 
i
 = 
disks
; i--; ) {

3173 
r5dev
 *
dev
 = &
sh
->dev[
i
];

3174 i‡(!
	`ã°_bô
(
R5_OVERWRITE
, &
dev
->
Êags
) &&

3175 
i
 !
sh
->
pd_idx
 && i !sh->
qd_idx
 &&

3176 !
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3177 !(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) ||

3178 
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
))) {

3179 
rcw
++;

3180 i‡(
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
) &&

3181 
	`ã°_bô
(
STRIPE_PREREAD_ACTIVE
,

3182 &
sh
->
°©e
)) {

3183 
	`¥_debug
("Read_old block "

3184 "%d f‹ Rec⁄°ru˘\n", 
i
);

3185 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3186 
	`£t_bô
(
R5_W™åód
, &
dev
->
Êags
);

3187 
s
->
locked
++;

3188 
qªad
++;

3190 
	`£t_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

3191 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3195 i‡(
rcw
 && 
c⁄f
->
mddev
->
queue
)

3196 
	`blk_add_åa˚_msg
(
c⁄f
->
mddev
->
queue
, "raid5Ñcw %llu %d %d %d",

3197 ()
sh
->
£˘‹
,

3198 
rcw
, 
qªad
, 
	`ã°_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
));

3210 i‡((
s
->
ªq_compuã
 || !
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
)) &&

3211 (
s
->
locked
 =0 && (
rcw
 =0 || 
rmw
 == 0) &&

3212 !
	`ã°_bô
(
STRIPE_BIT_DELAY
, &
sh
->
°©e
)))

3213 
	`scheduÀ_ªc⁄°ru˘i⁄
(
sh
, 
s
, 
rcw
 == 0, 0);

3214 
	}
}

3216 
	$h™dÀ_∑rôy_checks5
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

3217 
°rùe_hód_°©e
 *
s
, 
disks
)

3219 
r5dev
 *
dev
 = 
NULL
;

3221 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3223 
sh
->
check_°©e
) {

3224 
check_°©e_idÀ
:

3226 i‡(
s
->
Áûed
 == 0) {

3227 
	`BUG_ON
(
s
->
u±od©e
 !
disks
);

3228 
sh
->
check_°©e
 = 
check_°©e_run
;

3229 
	`£t_bô
(
STRIPE_OP_CHECK
, &
s
->
›s_ªque°
);

3230 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

3231 
s
->
u±od©e
--;

3234 
dev
 = &
sh
->dev[
s
->
Áûed_num
[0]];

3236 
check_°©e_compuã_ªsu…
:

3237 
sh
->
check_°©e
 = 
check_°©e_idÀ
;

3238 i‡(!
dev
)

3239 
dev
 = &
sh
->dev[sh->
pd_idx
];

3242 i‡(
	`ã°_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
))

3246 
	`BUG_ON
(!
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
));

3247 
	`BUG_ON
(
s
->
u±od©e
 !
disks
);

3249 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3250 
s
->
locked
++;

3251 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3253 
	`˛ór_bô
(
STRIPE_DEGRADED
, &
sh
->
°©e
);

3254 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3256 
check_°©e_run
:

3258 
check_°©e_check_ªsu…
:

3259 
sh
->
check_°©e
 = 
check_°©e_idÀ
;

3264 i‡(
s
->
Áûed
)

3271 i‡((
sh
->
›s
.
zîo_sum_ªsu…
 & 
SUM_CHECK_P_RESULT
) == 0)

3275 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3277 
	`©omic64_add
(
STRIPE_SECTORS
, &
c⁄f
->
mddev
->
ªsync_mism©ches
);

3278 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
c⁄f
->
mddev
->
ªcovîy
))

3280 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3282 
sh
->
check_°©e
 = 
check_°©e_compuã_run
;

3283 
	`£t_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

3284 
	`£t_bô
(
STRIPE_OP_COMPUTE_BLK
, &
s
->
›s_ªque°
);

3285 
	`£t_bô
(
R5_W™tcompuã
,

3286 &
sh
->
dev
[sh->
pd_idx
].
Êags
);

3287 
sh
->
›s
.
èrgë
 = sh->
pd_idx
;

3288 
sh
->
›s
.
èrgë2
 = -1;

3289 
s
->
u±od©e
++;

3293 
check_°©e_compuã_run
:

3296 
	`¥ötk
(
KERN_ERR
 "%s: unknown check_state: %d sector: %llu\n",

3297 
__func__
, 
sh
->
check_°©e
,

3298 (Ë
sh
->
£˘‹
);

3299 
	`BUG
();

3301 
	}
}

3304 
	$h™dÀ_∑rôy_checks6
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
,

3305 
°rùe_hód_°©e
 *
s
,

3306 
disks
)

3308 
pd_idx
 = 
sh
->pd_idx;

3309 
qd_idx
 = 
sh
->qd_idx;

3310 
r5dev
 *
dev
;

3312 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3314 
	`BUG_ON
(
s
->
Áûed
 > 2);

3322 
sh
->
check_°©e
) {

3323 
check_°©e_idÀ
:

3325 i‡(
s
->
Áûed
 =s->
q_Áûed
) {

3330 
sh
->
check_°©e
 = 
check_°©e_run
;

3332 i‡(!
s
->
q_Áûed
 && s->
Áûed
 < 2) {

3336 i‡(
sh
->
check_°©e
 =
check_°©e_run
)

3337 
sh
->
check_°©e
 = 
check_°©e_run_pq
;

3339 
sh
->
check_°©e
 = 
check_°©e_run_q
;

3343 
sh
->
›s
.
zîo_sum_ªsu…
 = 0;

3345 i‡(
sh
->
check_°©e
 =
check_°©e_run
) {

3347 
	`˛ór_bô
(
R5_UPTODATE
, &
sh
->
dev
[
pd_idx
].
Êags
);

3348 
s
->
u±od©e
--;

3350 i‡(
sh
->
check_°©e
 >
check_°©e_run
 &&

3351 
sh
->
check_°©e
 <
check_°©e_run_pq
) {

3355 
	`£t_bô
(
STRIPE_OP_CHECK
, &
s
->
›s_ªque°
);

3360 
	`BUG_ON
(
s
->
Áûed
 != 2);

3362 
check_°©e_compuã_ªsu…
:

3363 
sh
->
check_°©e
 = 
check_°©e_idÀ
;

3366 i‡(
	`ã°_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
))

3372 
	`BUG_ON
(
s
->
u±od©e
 < 
disks
 - 1);

3373 i‡(
s
->
Áûed
 == 2) {

3374 
dev
 = &
sh
->dev[
s
->
Áûed_num
[1]];

3375 
s
->
locked
++;

3376 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3377 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3379 i‡(
s
->
Áûed
 >= 1) {

3380 
dev
 = &
sh
->dev[
s
->
Áûed_num
[0]];

3381 
s
->
locked
++;

3382 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3383 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3385 i‡(
sh
->
›s
.
zîo_sum_ªsu…
 & 
SUM_CHECK_P_RESULT
) {

3386 
dev
 = &
sh
->dev[
pd_idx
];

3387 
s
->
locked
++;

3388 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3389 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3391 i‡(
sh
->
›s
.
zîo_sum_ªsu…
 & 
SUM_CHECK_Q_RESULT
) {

3392 
dev
 = &
sh
->dev[
qd_idx
];

3393 
s
->
locked
++;

3394 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3395 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3397 
	`˛ór_bô
(
STRIPE_DEGRADED
, &
sh
->
°©e
);

3399 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3401 
check_°©e_run
:

3402 
check_°©e_run_q
:

3403 
check_°©e_run_pq
:

3405 
check_°©e_check_ªsu…
:

3406 
sh
->
check_°©e
 = 
check_°©e_idÀ
;

3412 i‡(
sh
->
›s
.
zîo_sum_ªsu…
 == 0) {

3414 i‡(!
s
->
Áûed
)

3415 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3421 
sh
->
check_°©e
 = 
check_°©e_compuã_ªsu…
;

3429 
	`©omic64_add
(
STRIPE_SECTORS
, &
c⁄f
->
mddev
->
ªsync_mism©ches
);

3430 i‡(
	`ã°_bô
(
MD_RECOVERY_CHECK
, &
c⁄f
->
mddev
->
ªcovîy
))

3432 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3434 *
èrgë
 = &
sh
->
›s
.target;

3436 
sh
->
›s
.
èrgë
 = -1;

3437 
sh
->
›s
.
èrgë2
 = -1;

3438 
sh
->
check_°©e
 = 
check_°©e_compuã_run
;

3439 
	`£t_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
);

3440 
	`£t_bô
(
STRIPE_OP_COMPUTE_BLK
, &
s
->
›s_ªque°
);

3441 i‡(
sh
->
›s
.
zîo_sum_ªsu…
 & 
SUM_CHECK_P_RESULT
) {

3442 
	`£t_bô
(
R5_W™tcompuã
,

3443 &
sh
->
dev
[
pd_idx
].
Êags
);

3444 *
èrgë
 = 
pd_idx
;

3445 
èrgë
 = &
sh
->
›s
.
èrgë2
;

3446 
s
->
u±od©e
++;

3448 i‡(
sh
->
›s
.
zîo_sum_ªsu…
 & 
SUM_CHECK_Q_RESULT
) {

3449 
	`£t_bô
(
R5_W™tcompuã
,

3450 &
sh
->
dev
[
qd_idx
].
Êags
);

3451 *
èrgë
 = 
qd_idx
;

3452 
s
->
u±od©e
++;

3457 
check_°©e_compuã_run
:

3460 
	`¥ötk
(
KERN_ERR
 "%s: unknown check_state: %d sector: %llu\n",

3461 
__func__
, 
sh
->
check_°©e
,

3462 (Ë
sh
->
£˘‹
);

3463 
	`BUG
();

3465 
	}
}

3467 
	$h™dÀ_°rùe_ex∑nsi⁄
(
r5c⁄f
 *
c⁄f
, 
°rùe_hód
 *
sh
)

3469 
i
;

3474 
dma_async_tx_des¸ùt‹
 *
tx
 = 
NULL
;

3475 
	`˛ór_bô
(
STRIPE_EXPAND_SOURCE
, &
sh
->
°©e
);

3476 
i
 = 0; i < 
sh
->
disks
; i++)

3477 i‡(
i
 !
sh
->
pd_idx
 && i !sh->
qd_idx
) {

3478 
dd_idx
, 
j
;

3479 
°rùe_hód
 *
sh2
;

3480 
async_submô_˘l
 
submô
;

3482 
£˘‹_t
 
bn
 = 
	`compuã_blockƒ
(
sh
, 
i
, 1);

3483 
£˘‹_t
 
s
 = 
	`øid5_compuã_£˘‹
(
c⁄f
, 
bn
, 0,

3484 &
dd_idx
, 
NULL
);

3485 
sh2
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
s
, 0, 1, 1);

3486 i‡(
sh2
 =
NULL
)

3492 i‡(!
	`ã°_bô
(
STRIPE_EXPANDING
, &
sh2
->
°©e
) ||

3493 
	`ã°_bô
(
R5_Ex∑nded
, &
sh2
->
dev
[
dd_idx
].
Êags
)) {

3495 
	`ªÀa£_°rùe
(
sh2
);

3500 
	`öô_async_submô
(&
submô
, 0, 
tx
, 
NULL
, NULL, NULL);

3501 
tx
 = 
	`async_mem˝y
(
sh2
->
dev
[
dd_idx
].
∑ge
,

3502 
sh
->
dev
[
i
].
∑ge
, 0, 0, 
STRIPE_SIZE
,

3503 &
submô
);

3505 
	`£t_bô
(
R5_Ex∑nded
, &
sh2
->
dev
[
dd_idx
].
Êags
);

3506 
	`£t_bô
(
R5_UPTODATE
, &
sh2
->
dev
[
dd_idx
].
Êags
);

3507 
j
 = 0; j < 
c⁄f
->
øid_disks
; j++)

3508 i‡(
j
 !
sh2
->
pd_idx
 &&

3509 
j
 !
sh2
->
qd_idx
 &&

3510 !
	`ã°_bô
(
R5_Ex∑nded
, &
sh2
->
dev
[
j
].
Êags
))

3512 i‡(
j
 =
c⁄f
->
øid_disks
) {

3513 
	`£t_bô
(
STRIPE_EXPAND_READY
, &
sh2
->
°©e
);

3514 
	`£t_bô
(
STRIPE_HANDLE
, &
sh2
->
°©e
);

3516 
	`ªÀa£_°rùe
(
sh2
);

3520 
	`async_tx_quõs˚
(&
tx
);

3521 
	}
}

3537 
	$™Æy£_°rùe
(
°rùe_hód
 *
sh
, 
°rùe_hód_°©e
 *
s
)

3539 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

3540 
disks
 = 
sh
->disks;

3541 
r5dev
 *
dev
;

3542 
i
;

3543 
do_ªcovîy
 = 0;

3545 
	`mem£t
(
s
, 0, (*s));

3547 
s
->
ex∑ndög
 = 
	`ã°_bô
(
STRIPE_EXPAND_SOURCE
, &
sh
->
°©e
);

3548 
s
->
ex∑nded
 = 
	`ã°_bô
(
STRIPE_EXPAND_READY
, &
sh
->
°©e
);

3549 
s
->
Áûed_num
[0] = -1;

3550 
s
->
Áûed_num
[1] = -1;

3553 
	`rcu_ªad_lock
();

3554 
i
=
disks
; i--; ) {

3555 
md_rdev
 *
rdev
;

3556 
£˘‹_t
 
fú°_bad
;

3557 
bad_£˘‹s
;

3558 
is_bad
 = 0;

3560 
dev
 = &
sh
->dev[
i
];

3562 
	`¥_debug
("check %d: state 0x%lxÑead %p write %p written %p\n",

3563 
i
, 
dev
->
Êags
,

3564 
dev
->
t‹ód
, dev->
towrôe
, dev->
wrôãn
);

3570 i‡(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
Ë&& dev->
t‹ód
 &&

3571 !
	`ã°_bô
(
STRIPE_BIOFILL_RUN
, &
sh
->
°©e
))

3572 
	`£t_bô
(
R5_W™tfûl
, &
dev
->
Êags
);

3575 i‡(
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
))

3576 
s
->
locked
++;

3577 i‡(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
))

3578 
s
->
u±od©e
++;

3579 i‡(
	`ã°_bô
(
R5_W™tcompuã
, &
dev
->
Êags
)) {

3580 
s
->
compuã
++;

3581 
	`BUG_ON
(
s
->
compuã
 > 2);

3584 i‡(
	`ã°_bô
(
R5_W™tfûl
, &
dev
->
Êags
))

3585 
s
->
to_fûl
++;

3586 i‡(
dev
->
t‹ód
)

3587 
s
->
to_ªad
++;

3588 i‡(
dev
->
towrôe
) {

3589 
s
->
to_wrôe
++;

3590 i‡(!
	`ã°_bô
(
R5_OVERWRITE
, &
dev
->
Êags
))

3591 
s
->
n⁄_ovîwrôe
++;

3593 i‡(
dev
->
wrôãn
)

3594 
s
->
wrôãn
++;

3598 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].
ª∂a˚mít
);

3599 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
) &&

3600 
rdev
->
ªcovîy_off£t
 >
sh
->
£˘‹
 + 
STRIPE_SECTORS
 &&

3601 !
	`is_badblock
(
rdev
, 
sh
->
£˘‹
, 
STRIPE_SECTORS
,

3602 &
fú°_bad
, &
bad_£˘‹s
))

3603 
	`£t_bô
(
R5_RódRïl
, &
dev
->
Êags
);

3605 i‡(
rdev
)

3606 
	`£t_bô
(
R5_NìdRïœ˚
, &
dev
->
Êags
);

3607 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
i
].rdev);

3608 
	`˛ór_bô
(
R5_RódRïl
, &
dev
->
Êags
);

3610 i‡(
rdev
 && 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

3611 
rdev
 = 
NULL
;

3612 i‡(
rdev
) {

3613 
is_bad
 = 
	`is_badblock
(
rdev
, 
sh
->
£˘‹
, 
STRIPE_SECTORS
,

3614 &
fú°_bad
, &
bad_£˘‹s
);

3615 i‡(
s
->
blocked_rdev
 =
NULL


3616 && (
	`ã°_bô
(
Blocked
, &
rdev
->
Êags
)

3617 || 
is_bad
 < 0)) {

3618 i‡(
is_bad
 < 0)

3619 
	`£t_bô
(
BlockedBadBlocks
,

3620 &
rdev
->
Êags
);

3621 
s
->
blocked_rdev
 = 
rdev
;

3622 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

3625 
	`˛ór_bô
(
R5_Insync
, &
dev
->
Êags
);

3626 i‡(!
rdev
)

3628 i‡(
is_bad
) {

3630 i‡(!
	`ã°_bô
(
WrôeEº‹Sìn
, &
rdev
->
Êags
) &&

3631 
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
)) {

3635 
	`£t_bô
(
R5_Insync
, &
dev
->
Êags
);

3636 
	`£t_bô
(
R5_RódEº‹
, &
dev
->
Êags
);

3638 } i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
))

3639 
	`£t_bô
(
R5_Insync
, &
dev
->
Êags
);

3640 i‡(
sh
->
£˘‹
 + 
STRIPE_SECTORS
 <
rdev
->
ªcovîy_off£t
)

3642 
	`£t_bô
(
R5_Insync
, &
dev
->
Êags
);

3643 i‡(
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
) &&

3644 
	`ã°_bô
(
R5_Ex∑nded
, &
dev
->
Êags
))

3649 
	`£t_bô
(
R5_Insync
, &
dev
->
Êags
);

3651 i‡(
	`ã°_bô
(
R5_WrôeEº‹
, &
dev
->
Êags
)) {

3654 
md_rdev
 *
rdev2
 = 
	`rcu_dîe„ªn˚
(

3655 
c⁄f
->
disks
[
i
].
rdev
);

3656 i‡(
rdev2
 =
rdev
)

3657 
	`˛ór_bô
(
R5_Insync
, &
dev
->
Êags
);

3658 i‡(
rdev2
 && !
	`ã°_bô
(
Fau…y
, &rdev2->
Êags
)) {

3659 
s
->
h™dÀ_bad_blocks
 = 1;

3660 
	`©omic_öc
(&
rdev2
->
ƒ_≥ndög
);

3662 
	`˛ór_bô
(
R5_WrôeEº‹
, &
dev
->
Êags
);

3664 i‡(
	`ã°_bô
(
R5_MadeGood
, &
dev
->
Êags
)) {

3667 
md_rdev
 *
rdev2
 = 
	`rcu_dîe„ªn˚
(

3668 
c⁄f
->
disks
[
i
].
rdev
);

3669 i‡(
rdev2
 && !
	`ã°_bô
(
Fau…y
, &rdev2->
Êags
)) {

3670 
s
->
h™dÀ_bad_blocks
 = 1;

3671 
	`©omic_öc
(&
rdev2
->
ƒ_≥ndög
);

3673 
	`˛ór_bô
(
R5_MadeGood
, &
dev
->
Êags
);

3675 i‡(
	`ã°_bô
(
R5_MadeGoodRïl
, &
dev
->
Êags
)) {

3676 
md_rdev
 *
rdev2
 = 
	`rcu_dîe„ªn˚
(

3677 
c⁄f
->
disks
[
i
].
ª∂a˚mít
);

3678 i‡(
rdev2
 && !
	`ã°_bô
(
Fau…y
, &rdev2->
Êags
)) {

3679 
s
->
h™dÀ_bad_blocks
 = 1;

3680 
	`©omic_öc
(&
rdev2
->
ƒ_≥ndög
);

3682 
	`˛ór_bô
(
R5_MadeGoodRïl
, &
dev
->
Êags
);

3684 i‡(!
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
)) {

3686 
	`˛ór_bô
(
R5_RódEº‹
, &
dev
->
Êags
);

3687 
	`˛ór_bô
(
R5_ReWrôe
, &
dev
->
Êags
);

3689 i‡(
	`ã°_bô
(
R5_RódEº‹
, &
dev
->
Êags
))

3690 
	`˛ór_bô
(
R5_Insync
, &
dev
->
Êags
);

3691 i‡(!
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
)) {

3692 i‡(
s
->
Áûed
 < 2)

3693 
s
->
Áûed_num
[s->
Áûed
] = 
i
;

3694 
s
->
Áûed
++;

3695 i‡(
rdev
 && !
	`ã°_bô
(
Fau…y
, &rdev->
Êags
))

3696 
do_ªcovîy
 = 1;

3699 i‡(
	`ã°_bô
(
STRIPE_SYNCING
, &
sh
->
°©e
)) {

3708 i‡(
do_ªcovîy
 ||

3709 
sh
->
£˘‹
 >
c⁄f
->
mddev
->
ªcovîy_˝
 ||

3710 
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &(
c⁄f
->
mddev
->
ªcovîy
)))

3711 
s
->
syncög
 = 1;

3713 
s
->
ª∂acög
 = 1;

3715 
	`rcu_ªad_u∆ock
();

3716 
	}
}

3718 
	$h™dÀ_°rùe
(
°rùe_hód
 *
sh
)

3720 
°rùe_hód_°©e
 
s
;

3721 
r5c⁄f
 *
c⁄f
 = 
sh
->
øid_c⁄f
;

3722 
i
;

3723 
¥ex‹
;

3724 
disks
 = 
sh
->disks;

3725 
r5dev
 *
pdev
, *
qdev
;

3727 
	`˛ór_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3728 i‡(
	`ã°_™d_£t_bô_lock
(
STRIPE_ACTIVE
, &
sh
->
°©e
)) {

3731 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3735 i‡(
	`ã°_bô
(
STRIPE_SYNC_REQUESTED
, &
sh
->
°©e
)) {

3736 
	`•ö_lock
(&
sh
->
°rùe_lock
);

3738 i‡(!
	`ã°_bô
(
STRIPE_DISCARD
, &
sh
->
°©e
) &&

3739 
	`ã°_™d_˛ór_bô
(
STRIPE_SYNC_REQUESTED
, &
sh
->
°©e
)) {

3740 
	`£t_bô
(
STRIPE_SYNCING
, &
sh
->
°©e
);

3741 
	`˛ór_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3742 
	`˛ór_bô
(
STRIPE_REPLACED
, &
sh
->
°©e
);

3744 
	`•ö_u∆ock
(&
sh
->
°rùe_lock
);

3746 
	`˛ór_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

3748 
	`¥_debug
("handling stripe %llu, state=%#lx cnt=%d, "

3750 ()
sh
->
£˘‹
, sh->
°©e
,

3751 
	`©omic_ªad
(&
sh
->
cou¡
), sh->
pd_idx
, sh->
qd_idx
,

3752 
sh
->
check_°©e
, sh->
ªc⁄°ru˘_°©e
);

3754 
	`™Æy£_°rùe
(
sh
, &
s
);

3756 i‡(
s
.
h™dÀ_bad_blocks
) {

3757 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3758 
föish
;

3761 i‡(
	`u∆ikñy
(
s
.
blocked_rdev
)) {

3762 i‡(
s
.
syncög
 || s.
ex∑ndög
 || s.
ex∑nded
 ||

3763 
s
.
ª∂acög
 || s.
to_wrôe
 || s.
wrôãn
) {

3764 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3765 
föish
;

3768 
	`rdev_dec_≥ndög
(
s
.
blocked_rdev
, 
c⁄f
->
mddev
);

3769 
s
.
blocked_rdev
 = 
NULL
;

3772 i‡(
s
.
to_fûl
 && !
	`ã°_bô
(
STRIPE_BIOFILL_RUN
, &
sh
->
°©e
)) {

3773 
	`£t_bô
(
STRIPE_OP_BIOFILL
, &
s
.
›s_ªque°
);

3774 
	`£t_bô
(
STRIPE_BIOFILL_RUN
, &
sh
->
°©e
);

3777 
	`¥_debug
("locked=%d uptodate=%dÅo_read=%d"

3779 
s
.
locked
, s.
u±od©e
, s.
to_ªad
, s.
to_wrôe
, s.
Áûed
,

3780 
s
.
Áûed_num
[0], s.failed_num[1]);

3784 i‡(
s
.
Áûed
 > 
c⁄f
->
max_degøded
) {

3785 
sh
->
check_°©e
 = 0;

3786 
sh
->
ªc⁄°ru˘_°©e
 = 0;

3787 i‡(
s
.
to_ªad
+s.
to_wrôe
+s.
wrôãn
)

3788 
	`h™dÀ_Áûed_°rùe
(
c⁄f
, 
sh
, &
s
, 
disks
, &s.
ªtu∫_bi
);

3789 i‡(
s
.
syncög
 + s.
ª∂acög
)

3790 
	`h™dÀ_Áûed_sync
(
c⁄f
, 
sh
, &
s
);

3796 
¥ex‹
 = 0;

3797 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_¥ex‹_døö_ªsu…
)

3798 
¥ex‹
 = 1;

3799 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_døö_ªsu…
 ||

3800 
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_¥ex‹_døö_ªsu…
) {

3801 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_idÀ
;

3806 
	`BUG_ON
(!
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[sh->
pd_idx
].
Êags
) &&

3807 !
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
pd_idx
].
Êags
));

3808 
	`BUG_ON
(
sh
->
qd_idx
 >= 0 &&

3809 !
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[sh->
qd_idx
].
Êags
) &&

3810 !
	`ã°_bô
(
R5_Disˇrd
, &
sh
->
dev
[sh->
qd_idx
].
Êags
));

3811 
i
 = 
disks
; i--; ) {

3812 
r5dev
 *
dev
 = &
sh
->dev[
i
];

3813 i‡(
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
) &&

3814 (
i
 =
sh
->
pd_idx
 || i =sh->
qd_idx
 ||

3815 
dev
->
wrôãn
)) {

3816 
	`¥_debug
("Wrôög block %d\n", 
i
);

3817 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3818 i‡(
¥ex‹
)

3820 i‡(
s
.
Áûed
 > 1)

3822 i‡(!
	`ã°_bô
(
R5_Insync
, &
dev
->
Êags
) ||

3823 ((
i
 =
sh
->
pd_idx
 || i =sh->
qd_idx
) &&

3824 
s
.
Áûed
 == 0))

3825 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3828 i‡(
	`ã°_™d_˛ór_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))

3829 
s
.
dec_¥îód_a˘ive
 = 1;

3836 
pdev
 = &
sh
->
dev
[sh->
pd_idx
];

3837 
s
.
p_Áûed
 = (s.
Áûed
 >1 && s.
Áûed_num
[0] =
sh
->
pd_idx
)

3838 || (
s
.
Áûed
 >2 && s.
Áûed_num
[1] =
sh
->
pd_idx
);

3839 
qdev
 = &
sh
->
dev
[sh->
qd_idx
];

3840 
s
.
q_Áûed
 = (s.
Áûed
 >1 && s.
Áûed_num
[0] =
sh
->
qd_idx
)

3841 || (
s
.
Áûed
 >2 && s.
Áûed_num
[1] =
sh
->
qd_idx
)

3842 || 
c⁄f
->
Àvñ
 < 6;

3844 i‡(
s
.
wrôãn
 &&

3845 (
s
.
p_Áûed
 || ((
	`ã°_bô
(
R5_Insync
, &
pdev
->
Êags
)

3846 && !
	`ã°_bô
(
R5_LOCKED
, &
pdev
->
Êags
)

3847 && (
	`ã°_bô
(
R5_UPTODATE
, &
pdev
->
Êags
) ||

3848 
	`ã°_bô
(
R5_Disˇrd
, &
pdev
->
Êags
))))) &&

3849 (
s
.
q_Áûed
 || ((
	`ã°_bô
(
R5_Insync
, &
qdev
->
Êags
)

3850 && !
	`ã°_bô
(
R5_LOCKED
, &
qdev
->
Êags
)

3851 && (
	`ã°_bô
(
R5_UPTODATE
, &
qdev
->
Êags
) ||

3852 
	`ã°_bô
(
R5_Disˇrd
, &
qdev
->
Êags
))))))

3853 
	`h™dÀ_°rùe_˛ón_evít
(
c⁄f
, 
sh
, 
disks
, &
s
.
ªtu∫_bi
);

3859 i‡(
s
.
to_ªad
 || s.
n⁄_ovîwrôe


3860 || (
c⁄f
->
Àvñ
 =6 && 
s
.
to_wrôe
 && s.
Áûed
)

3861 || (
s
.
syncög
 && (s.
u±od©e
 + s.
compuã
 < 
disks
))

3862 || 
s
.
ª∂acög


3863 || 
s
.
ex∑ndög
)

3864 
	`h™dÀ_°rùe_fûl
(
sh
, &
s
, 
disks
);

3872 i‡(
s
.
to_wrôe
 && !
sh
->
ªc⁄°ru˘_°©e
 && !sh->
check_°©e
)

3873 
	`h™dÀ_°rùe_dútyög
(
c⁄f
, 
sh
, &
s
, 
disks
);

3880 i‡(
sh
->
check_°©e
 ||

3881 (
s
.
syncög
 && s.
locked
 == 0 &&

3882 !
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
) &&

3883 !
	`ã°_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
))) {

3884 i‡(
c⁄f
->
Àvñ
 == 6)

3885 
	`h™dÀ_∑rôy_checks6
(
c⁄f
, 
sh
, &
s
, 
disks
);

3887 
	`h™dÀ_∑rôy_checks5
(
c⁄f
, 
sh
, &
s
, 
disks
);

3890 i‡((
s
.
ª∂acög
 || s.
syncög
Ë&& s.
locked
 == 0

3891 && !
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
)

3892 && !
	`ã°_bô
(
STRIPE_REPLACED
, &
sh
->
°©e
)) {

3894 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++)

3895 i‡(
	`ã°_bô
(
R5_NìdRïœ˚
, &
sh
->
dev
[
i
].
Êags
)) {

3896 
	`WARN_ON
(!
	`ã°_bô
(
R5_UPTODATE
, &
sh
->
dev
[
i
].
Êags
));

3897 
	`£t_bô
(
R5_W™tRïœ˚
, &
sh
->
dev
[
i
].
Êags
);

3898 
	`£t_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

3899 
s
.
locked
++;

3901 i‡(
s
.
ª∂acög
)

3902 
	`£t_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
);

3903 
	`£t_bô
(
STRIPE_REPLACED
, &
sh
->
°©e
);

3905 i‡((
s
.
syncög
 || s.
ª∂acög
Ë&& s.
locked
 == 0 &&

3906 !
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
) &&

3907 
	`ã°_bô
(
STRIPE_INSYNC
, &
sh
->
°©e
)) {

3908 
	`md_d⁄e_sync
(
c⁄f
->
mddev
, 
STRIPE_SECTORS
, 1);

3909 
	`˛ór_bô
(
STRIPE_SYNCING
, &
sh
->
°©e
);

3910 i‡(
	`ã°_™d_˛ór_bô
(
R5_Ovîœp
, &
sh
->
dev
[sh->
pd_idx
].
Êags
))

3911 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

3917 i‡(
s
.
Áûed
 <
c⁄f
->
max_degøded
 && !c⁄f->
mddev
->
ro
)

3918 
i
 = 0; i < 
s
.
Áûed
; i++) {

3919 
r5dev
 *
dev
 = &
sh
->dev[
s
.
Áûed_num
[
i
]];

3920 i‡(
	`ã°_bô
(
R5_RódEº‹
, &
dev
->
Êags
)

3921 && !
	`ã°_bô
(
R5_LOCKED
, &
dev
->
Êags
)

3922 && 
	`ã°_bô
(
R5_UPTODATE
, &
dev
->
Êags
)

3924 i‡(!
	`ã°_bô
(
R5_ReWrôe
, &
dev
->
Êags
)) {

3925 
	`£t_bô
(
R5_W™twrôe
, &
dev
->
Êags
);

3926 
	`£t_bô
(
R5_ReWrôe
, &
dev
->
Êags
);

3927 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3928 
s
.
locked
++;

3931 
	`£t_bô
(
R5_W™åód
, &
dev
->
Êags
);

3932 
	`£t_bô
(
R5_LOCKED
, &
dev
->
Êags
);

3933 
s
.
locked
++;

3940 i‡(
sh
->
ªc⁄°ru˘_°©e
 =
ªc⁄°ru˘_°©e_ªsu…
) {

3941 
°rùe_hód
 *
sh_§c


3942 
	`gë_a˘ive_°rùe
(
c⁄f
, 
sh
->
£˘‹
, 1, 1, 1);

3943 i‡(
sh_§c
 && 
	`ã°_bô
(
STRIPE_EXPAND_SOURCE
, &sh_§c->
°©e
)) {

3947 
	`£t_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

3948 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

3949 i‡(!
	`ã°_™d_£t_bô
(
STRIPE_PREREAD_ACTIVE
,

3950 &
sh_§c
->
°©e
))

3951 
	`©omic_öc
(&
c⁄f
->
¥îód_a˘ive_°rùes
);

3952 
	`ªÀa£_°rùe
(
sh_§c
);

3953 
föish
;

3955 i‡(
sh_§c
)

3956 
	`ªÀa£_°rùe
(
sh_§c
);

3958 
sh
->
ªc⁄°ru˘_°©e
 = 
ªc⁄°ru˘_°©e_idÀ
;

3959 
	`˛ór_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
);

3960 
i
 = 
c⁄f
->
øid_disks
; i--; ) {

3961 
	`£t_bô
(
R5_W™twrôe
, &
sh
->
dev
[
i
].
Êags
);

3962 
	`£t_bô
(
R5_LOCKED
, &
sh
->
dev
[
i
].
Êags
);

3963 
s
.
locked
++;

3967 i‡(
s
.
ex∑nded
 && 
	`ã°_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
) &&

3968 !
sh
->
ªc⁄°ru˘_°©e
) {

3970 
sh
->
disks
 = 
c⁄f
->
øid_disks
;

3971 
	`°rùe_£t_idx
(
sh
->
£˘‹
, 
c⁄f
, 0, sh);

3972 
	`scheduÀ_ªc⁄°ru˘i⁄
(
sh
, &
s
, 1, 1);

3973 } i‡(
s
.
ex∑nded
 && !
sh
->
ªc⁄°ru˘_°©e
 && s.
locked
 == 0) {

3974 
	`˛ór_bô
(
STRIPE_EXPAND_READY
, &
sh
->
°©e
);

3975 
	`©omic_dec
(&
c⁄f
->
ªsh≠e_°rùes
);

3976 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

3977 
	`md_d⁄e_sync
(
c⁄f
->
mddev
, 
STRIPE_SECTORS
, 1);

3980 i‡(
s
.
ex∑ndög
 && s.
locked
 == 0 &&

3981 !
	`ã°_bô
(
STRIPE_COMPUTE_RUN
, &
sh
->
°©e
))

3982 
	`h™dÀ_°rùe_ex∑nsi⁄
(
c⁄f
, 
sh
);

3984 
föish
:

3986 i‡(
	`u∆ikñy
(
s
.
blocked_rdev
)) {

3987 i‡(
c⁄f
->
mddev
->
exã∫Æ
)

3988 
	`md_waô_f‹_blocked_rdev
(
s
.
blocked_rdev
,

3989 
c⁄f
->
mddev
);

3995 
	`rdev_dec_≥ndög
(
s
.
blocked_rdev
,

3996 
c⁄f
->
mddev
);

3999 i‡(
s
.
h™dÀ_bad_blocks
)

4000 
i
 = 
disks
; i--; ) {

4001 
md_rdev
 *
rdev
;

4002 
r5dev
 *
dev
 = &
sh
->dev[
i
];

4003 i‡(
	`ã°_™d_˛ór_bô
(
R5_WrôeEº‹
, &
dev
->
Êags
)) {

4005 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

4006 i‡(!
	`rdev_£t_badblocks
(
rdev
, 
sh
->
£˘‹
,

4007 
STRIPE_SECTORS
, 0))

4008 
	`md_îr‹
(
c⁄f
->
mddev
, 
rdev
);

4009 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

4011 i‡(
	`ã°_™d_˛ór_bô
(
R5_MadeGood
, &
dev
->
Êags
)) {

4012 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

4013 
	`rdev_˛ór_badblocks
(
rdev
, 
sh
->
£˘‹
,

4014 
STRIPE_SECTORS
, 0);

4015 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

4017 i‡(
	`ã°_™d_˛ór_bô
(
R5_MadeGoodRïl
, &
dev
->
Êags
)) {

4018 
rdev
 = 
c⁄f
->
disks
[
i
].
ª∂a˚mít
;

4019 i‡(!
rdev
)

4021 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

4022 
	`rdev_˛ór_badblocks
(
rdev
, 
sh
->
£˘‹
,

4023 
STRIPE_SECTORS
, 0);

4024 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

4028 i‡(
s
.
›s_ªque°
)

4029 
	`øid_run_›s
(
sh
, 
s
.
›s_ªque°
);

4031 
	`›s_run_io
(
sh
, &
s
);

4033 i‡(
s
.
dec_¥îód_a˘ive
) {

4038 
	`©omic_dec
(&
c⁄f
->
¥îód_a˘ive_°rùes
);

4039 i‡(
	`©omic_ªad
(&
c⁄f
->
¥îód_a˘ive_°rùes
) <

4040 
IO_THRESHOLD
)

4041 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

4044 
	`ªtu∫_io
(
s
.
ªtu∫_bi
);

4046 
	`˛ór_bô_u∆ock
(
STRIPE_ACTIVE
, &
sh
->
°©e
);

4047 
	}
}

4049 
	$øid5_a˘iv©e_dñayed
(
r5c⁄f
 *
c⁄f
)

4051 i‡(
	`©omic_ªad
(&
c⁄f
->
¥îód_a˘ive_°rùes
Ë< 
IO_THRESHOLD
) {

4052 !
	`li°_em±y
(&
c⁄f
->
dñayed_li°
)) {

4053 
li°_hód
 *
l
 = 
c⁄f
->
dñayed_li°
.
√xt
;

4054 
°rùe_hód
 *
sh
;

4055 
sh
 = 
	`li°_íåy
(
l
, 
°rùe_hód
, 
Ãu
);

4056 
	`li°_dñ_öô
(
l
);

4057 
	`˛ór_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

4058 i‡(!
	`ã°_™d_£t_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))

4059 
	`©omic_öc
(&
c⁄f
->
¥îód_a˘ive_°rùes
);

4060 
	`li°_add_èû
(&
sh
->
Ãu
, &
c⁄f
->
hﬁd_li°
);

4061 
	`øid5_wakeup_°rùe_thªad
(
sh
);

4064 
	}
}

4066 
	$a˘iv©e_bô_dñay
(
r5c⁄f
 *
c⁄f
,

4067 
li°_hód
 *
ãmp_öa˘ive_li°
)

4070 
li°_hód
 
hód
;

4071 
	`li°_add
(&
hód
, &
c⁄f
->
bôm≠_li°
);

4072 
	`li°_dñ_öô
(&
c⁄f
->
bôm≠_li°
);

4073 !
	`li°_em±y
(&
hód
)) {

4074 
°rùe_hód
 *
sh
 = 
	`li°_íåy
(
hód
.
√xt
, °rùe_hód, 
Ãu
);

4075 
hash
;

4076 
	`li°_dñ_öô
(&
sh
->
Ãu
);

4077 
	`©omic_öc
(&
sh
->
cou¡
);

4078 
hash
 = 
sh
->
hash_lock_ödex
;

4079 
	`__ªÀa£_°rùe
(
c⁄f
, 
sh
, &
ãmp_öa˘ive_li°
[
hash
]);

4081 
	}
}

4083 
	$md_øid5_c⁄ge°ed
(
mddev
 *mddev, 
bôs
)

4085 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4091 i‡(
c⁄f
->
öa˘ive_blocked
)

4093 i‡(
c⁄f
->
quõs˚
)

4095 i‡(
	`©omic_ªad
(&
c⁄f
->
em±y_öa˘ive_li°_ƒ
))

4099 
	}
}

4100 
EXPORT_SYMBOL_GPL
(
md_øid5_c⁄ge°ed
);

4102 
	$øid5_c⁄ge°ed
(*
d©a
, 
bôs
)

4104 
mddev
 *mddev = 
d©a
;

4106  
	`mddev_c⁄ge°ed
(
mddev
, 
bôs
) ||

4107 
	`md_øid5_c⁄ge°ed
(
mddev
, 
bôs
);

4108 
	}
}

4113 
	$øid5_mîgóbÀ_bvec
(
ªque°_queue
 *
q
,

4114 
bvec_mîge_d©a
 *
bvm
,

4115 
bio_vec
 *
biovec
)

4117 
mddev
 *mddev = 
q
->
queued©a
;

4118 
£˘‹_t
 
£˘‹
 = 
bvm
->
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bvm->
bi_bdev
);

4119 
max
;

4120 
chunk_£˘‹s
 = 
mddev
->chunk_sectors;

4121 
bio_£˘‹s
 = 
bvm
->
bi_size
 >> 9;

4123 i‡((
bvm
->
bi_rw
 & 1Ë=
WRITE
)

4124  
biovec
->
bv_Àn
;

4126 i‡(
mddev
->
√w_chunk_£˘‹s
 < mddev->
chunk_£˘‹s
)

4127 
chunk_£˘‹s
 = 
mddev
->
√w_chunk_£˘‹s
;

4128 
max
 = (
chunk_£˘‹s
 - ((
£˘‹
 & (chunk_£˘‹†- 1)Ë+ 
bio_£˘‹s
)) << 9;

4129 i‡(
max
 < 0) max = 0;

4130 i‡(
max
 <
biovec
->
bv_Àn
 && 
bio_£˘‹s
 == 0)

4131  
biovec
->
bv_Àn
;

4133  
max
;

4134 
	}
}

4137 
	$ö_chunk_bound¨y
(
mddev
 *mddev, 
bio
 *bio)

4139 
£˘‹_t
 
£˘‹
 = 
bio
->
bi_ôî
.
bi_£˘‹
 + 
	`gë_°¨t_£˘
(bio->
bi_bdev
);

4140 
chunk_£˘‹s
 = 
mddev
->chunk_sectors;

4141 
bio_£˘‹s
 = 
	`bio_£˘‹s
(
bio
);

4143 i‡(
mddev
->
√w_chunk_£˘‹s
 < mddev->
chunk_£˘‹s
)

4144 
chunk_£˘‹s
 = 
mddev
->
√w_chunk_£˘‹s
;

4145  
chunk_£˘‹s
 >=

4146 ((
£˘‹
 & (
chunk_£˘‹s
 - 1)Ë+ 
bio_£˘‹s
);

4147 
	}
}

4153 
	$add_bio_to_ªåy
(
bio
 *
bi
,
r5c⁄f
 *
c⁄f
)

4155 
Êags
;

4157 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

4159 
bi
->
bi_√xt
 = 
c⁄f
->
ªåy_ªad_Æig√d_li°
;

4160 
c⁄f
->
ªåy_ªad_Æig√d_li°
 = 
bi
;

4162 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

4163 
	`md_wakeup_thªad
(
c⁄f
->
mddev
->
thªad
);

4164 
	}
}

4167 
bio
 *
	$ªmove_bio_‰om_ªåy
(
r5c⁄f
 *
c⁄f
)

4169 
bio
 *
bi
;

4171 
bi
 = 
c⁄f
->
ªåy_ªad_Æig√d
;

4172 i‡(
bi
) {

4173 
c⁄f
->
ªåy_ªad_Æig√d
 = 
NULL
;

4174  
bi
;

4176 
bi
 = 
c⁄f
->
ªåy_ªad_Æig√d_li°
;

4177 if(
bi
) {

4178 
c⁄f
->
ªåy_ªad_Æig√d_li°
 = 
bi
->
bi_√xt
;

4179 
bi
->
bi_√xt
 = 
NULL
;

4184 
	`øid5_£t_bi_°rùes
(
bi
, 1);

4187  
bi
;

4188 
	}
}

4197 
	$øid5_Æign_ídio
(
bio
 *
bi
, 
îr‹
)

4199 
bio
* 
øid_bi
 = 
bi
->
bi_¥iv©e
;

4200 
mddev
 *mddev;

4201 
r5c⁄f
 *
c⁄f
;

4202 
u±od©e
 = 
	`ã°_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

4203 
md_rdev
 *
rdev
;

4205 
	`bio_put
(
bi
);

4207 
rdev
 = (*)
øid_bi
->
bi_√xt
;

4208 
øid_bi
->
bi_√xt
 = 
NULL
;

4209 
mddev
 = 
rdev
->mddev;

4210 
c⁄f
 = 
mddev
->
¥iv©e
;

4212 
	`rdev_dec_≥ndög
(
rdev
, 
c⁄f
->
mddev
);

4214 i‡(!
îr‹
 && 
u±od©e
) {

4215 
	`åa˚_block_bio_com∂ëe
(
	`bdev_gë_queue
(
øid_bi
->
bi_bdev
),

4216 
øid_bi
, 0);

4217 
	`bio_ídio
(
øid_bi
, 0);

4218 i‡(
	`©omic_dec_™d_ã°
(&
c⁄f
->
a˘ive_Æig√d_ªads
))

4219 
	`wake_up
(&
c⁄f
->
waô_f‹_°rùe
);

4224 
	`¥_debug
("raid5_align_endio : ioÉrror...handing IO foráÑetry\n");

4226 
	`add_bio_to_ªåy
(
øid_bi
, 
c⁄f
);

4227 
	}
}

4229 
	$bio_fôs_rdev
(
bio
 *
bi
)

4231 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
bi
->
bi_bdev
);

4233 i‡(
	`bio_£˘‹s
(
bi
Ë> 
	`queue_max_£˘‹s
(
q
))

4235 
	`blk_ªcou¡_£gmíts
(
q
, 
bi
);

4236 i‡(
bi
->
bi_phys_£gmíts
 > 
	`queue_max_£gmíts
(
q
))

4239 i‡(
q
->
mîge_bvec_‚
)

4246 
	}
}

4249 
	$chunk_Æig√d_ªad
(
mddev
 *mddev, 
bio
 * 
øid_bio
)

4251 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4252 
dd_idx
;

4253 
bio
* 
Æign_bi
;

4254 
md_rdev
 *
rdev
;

4255 
£˘‹_t
 
íd_£˘‹
;

4257 i‡(!
	`ö_chunk_bound¨y
(
mddev
, 
øid_bio
)) {

4258 
	`¥_debug
("chunk_aligned_read :Çonáligned\n");

4264 
Æign_bi
 = 
	`bio_˛⁄e_mddev
(
øid_bio
, 
GFP_NOIO
, 
mddev
);

4265 i‡(!
Æign_bi
)

4271 
Æign_bi
->
bi_íd_io
 = 
øid5_Æign_ídio
;

4272 
Æign_bi
->
bi_¥iv©e
 = 
øid_bio
;

4276 
Æign_bi
->
bi_ôî
.
bi_£˘‹
 =

4277 
	`øid5_compuã_£˘‹
(
c⁄f
, 
øid_bio
->
bi_ôî
.
bi_£˘‹
,

4278 0, &
dd_idx
, 
NULL
);

4280 
íd_£˘‹
 = 
	`bio_íd_£˘‹
(
Æign_bi
);

4281 
	`rcu_ªad_lock
();

4282 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
dd_idx
].
ª∂a˚mít
);

4283 i‡(!
rdev
 || 
	`ã°_bô
(
Fau…y
, &rdev->
Êags
) ||

4284 
rdev
->
ªcovîy_off£t
 < 
íd_£˘‹
) {

4285 
rdev
 = 
	`rcu_dîe„ªn˚
(
c⁄f
->
disks
[
dd_idx
].rdev);

4286 i‡(
rdev
 &&

4287 (
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) ||

4288 !(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

4289 
rdev
->
ªcovîy_off£t
 >
íd_£˘‹
)))

4290 
rdev
 = 
NULL
;

4292 i‡(
rdev
) {

4293 
£˘‹_t
 
fú°_bad
;

4294 
bad_£˘‹s
;

4296 
	`©omic_öc
(&
rdev
->
ƒ_≥ndög
);

4297 
	`rcu_ªad_u∆ock
();

4298 
øid_bio
->
bi_√xt
 = (*)
rdev
;

4299 
Æign_bi
->
bi_bdev
 = 
rdev
->
bdev
;

4300 
Æign_bi
->
bi_Êags
 &~(1 << 
BIO_SEG_VALID
);

4302 i‡(!
	`bio_fôs_rdev
(
Æign_bi
) ||

4303 
	`is_badblock
(
rdev
, 
Æign_bi
->
bi_ôî
.
bi_£˘‹
,

4304 
	`bio_£˘‹s
(
Æign_bi
),

4305 &
fú°_bad
, &
bad_£˘‹s
)) {

4307 
	`bio_put
(
Æign_bi
);

4308 
	`rdev_dec_≥ndög
(
rdev
, 
mddev
);

4313 
Æign_bi
->
bi_ôî
.
bi_£˘‹
 +
rdev
->
d©a_off£t
;

4315 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4316 
	`waô_evít_lock_úq
(
c⁄f
->
waô_f‹_°rùe
,

4317 
c⁄f
->
quõs˚
 == 0,

4318 
c⁄f
->
devi˚_lock
);

4319 
	`©omic_öc
(&
c⁄f
->
a˘ive_Æig√d_ªads
);

4320 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4322 i‡(
mddev
->
gídisk
)

4323 
	`åa˚_block_bio_ªm≠
(
	`bdev_gë_queue
(
Æign_bi
->
bi_bdev
),

4324 
Æign_bi
, 
	`disk_devt
(
mddev
->
gídisk
),

4325 
øid_bio
->
bi_ôî
.
bi_£˘‹
);

4326 
	`gíîic_make_ªque°
(
Æign_bi
);

4329 
	`rcu_ªad_u∆ock
();

4330 
	`bio_put
(
Æign_bi
);

4333 
	}
}

4345 
°rùe_hód
 *
	$__gë_¥i‹ôy_°rùe
(
r5c⁄f
 *
c⁄f
, 
group
)

4347 
°rùe_hód
 *
sh
 = 
NULL
, *
tmp
;

4348 
li°_hód
 *
h™dÀ_li°
 = 
NULL
;

4349 
r5w‹kî_group
 *
wg
 = 
NULL
;

4351 i‡(
c⁄f
->
w‹kî_˙t_≥r_group
 == 0) {

4352 
h™dÀ_li°
 = &
c⁄f
->handle_list;

4353 } i‡(
group
 !
ANY_GROUP
) {

4354 
h™dÀ_li°
 = &
c⁄f
->
w‹kî_groups
[
group
].handle_list;

4355 
wg
 = &
c⁄f
->
w‹kî_groups
[
group
];

4357 
i
;

4358 
i
 = 0; i < 
c⁄f
->
group_˙t
; i++) {

4359 
h™dÀ_li°
 = &
c⁄f
->
w‹kî_groups
[
i
].handle_list;

4360 
wg
 = &
c⁄f
->
w‹kî_groups
[
i
];

4361 i‡(!
	`li°_em±y
(
h™dÀ_li°
))

4366 
	`¥_debug
("%s: handle: %s hold: %s full_writes: %d bypass_count: %d\n",

4367 
__func__
,

4368 
	`li°_em±y
(
h™dÀ_li°
) ? "empty" : "busy",

4369 
	`li°_em±y
(&
c⁄f
->
hﬁd_li°
) ? "empty" : "busy",

4370 
	`©omic_ªad
(&
c⁄f
->
≥ndög_fuŒ_wrôes
), c⁄f->
by∑ss_cou¡
);

4372 i‡(!
	`li°_em±y
(
h™dÀ_li°
)) {

4373 
sh
 = 
	`li°_íåy
(
h™dÀ_li°
->
√xt
, 
	`ty≥of
(*sh), 
Ãu
);

4375 i‡(
	`li°_em±y
(&
c⁄f
->
hﬁd_li°
))

4376 
c⁄f
->
by∑ss_cou¡
 = 0;

4377 i‡(!
	`ã°_bô
(
STRIPE_IO_STARTED
, &
sh
->
°©e
)) {

4378 i‡(
c⁄f
->
hﬁd_li°
.
√xt
 =c⁄f->
œ°_hﬁd
)

4379 
c⁄f
->
by∑ss_cou¡
++;

4381 
c⁄f
->
œ°_hﬁd
 = c⁄f->
hﬁd_li°
.
√xt
;

4382 
c⁄f
->
by∑ss_cou¡
 -c⁄f->
by∑ss_thªshﬁd
;

4383 i‡(
c⁄f
->
by∑ss_cou¡
 < 0)

4384 
c⁄f
->
by∑ss_cou¡
 = 0;

4387 } i‡(!
	`li°_em±y
(&
c⁄f
->
hﬁd_li°
) &&

4388 ((
c⁄f
->
by∑ss_thªshﬁd
 &&

4389 
c⁄f
->
by∑ss_cou¡
 > c⁄f->
by∑ss_thªshﬁd
) ||

4390 
	`©omic_ªad
(&
c⁄f
->
≥ndög_fuŒ_wrôes
) == 0)) {

4392 
	`li°_f‹_óch_íåy
(
tmp
, &
c⁄f
->
hﬁd_li°
, 
Ãu
) {

4393 i‡(
c⁄f
->
w‹kî_˙t_≥r_group
 == 0 ||

4394 
group
 =
ANY_GROUP
 ||

4395 !
	`˝u_⁄löe
(
tmp
->
˝u
) ||

4396 
	`˝u_to_group
(
tmp
->
˝u
Ë=
group
) {

4397 
sh
 = 
tmp
;

4402 i‡(
sh
) {

4403 
c⁄f
->
by∑ss_cou¡
 -c⁄f->
by∑ss_thªshﬁd
;

4404 i‡(
c⁄f
->
by∑ss_cou¡
 < 0)

4405 
c⁄f
->
by∑ss_cou¡
 = 0;

4407 
wg
 = 
NULL
;

4410 i‡(!
sh
)

4411  
NULL
;

4413 i‡(
wg
) {

4414 
wg
->
°rùes_˙t
--;

4415 
sh
->
group
 = 
NULL
;

4417 
	`li°_dñ_öô
(&
sh
->
Ãu
);

4418 
	`BUG_ON
(
	`©omic_öc_ªtu∫
(&
sh
->
cou¡
) != 1);

4419  
sh
;

4420 
	}
}

4422 
	søid5_∂ug_cb
 {

4423 
blk_∂ug_cb
 
	mcb
;

4424 
li°_hód
 
	mli°
;

4425 
li°_hód
 
	mãmp_öa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

4428 
	$øid5_u≈lug
(
blk_∂ug_cb
 *
blk_cb
, 
boﬁ
 
‰om_scheduÀ
)

4430 
øid5_∂ug_cb
 *
cb
 = 
	`c⁄èöî_of
(

4431 
blk_cb
, 
øid5_∂ug_cb
, 
cb
);

4432 
°rùe_hód
 *
sh
;

4433 
mddev
 *mddev = 
cb
->cb.
d©a
;

4434 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4435 
˙t
 = 0;

4436 
hash
;

4438 i‡(
cb
->
li°
.
√xt
 && !
	`li°_em±y
(&cb->list)) {

4439 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4440 !
	`li°_em±y
(&
cb
->
li°
)) {

4441 
sh
 = 
	`li°_fú°_íåy
(&
cb
->
li°
, 
°rùe_hód
, 
Ãu
);

4442 
	`li°_dñ_öô
(&
sh
->
Ãu
);

4448 
	`smp_mb__bef‹e_©omic
();

4449 
	`˛ór_bô
(
STRIPE_ON_UNPLUG_LIST
, &
sh
->
°©e
);

4454 
hash
 = 
sh
->
hash_lock_ödex
;

4455 
	`__ªÀa£_°rùe
(
c⁄f
, 
sh
, &
cb
->
ãmp_öa˘ive_li°
[
hash
]);

4456 
˙t
++;

4458 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4460 
	`ªÀa£_öa˘ive_°rùe_li°
(
c⁄f
, 
cb
->
ãmp_öa˘ive_li°
,

4461 
NR_STRIPE_HASH_LOCKS
);

4462 i‡(
mddev
->
queue
)

4463 
	`åa˚_block_u≈lug
(
mddev
->
queue
, 
˙t
, !
‰om_scheduÀ
);

4464 
	`k‰ì
(
cb
);

4465 
	}
}

4467 
	$ªÀa£_°rùe_∂ug
(
mddev
 *mddev,

4468 
°rùe_hód
 *
sh
)

4470 
blk_∂ug_cb
 *
blk_cb
 = 
	`blk_check_∂ugged
(

4471 
øid5_u≈lug
, 
mddev
,

4472 (
øid5_∂ug_cb
));

4473 
øid5_∂ug_cb
 *
cb
;

4475 i‡(!
blk_cb
) {

4476 
	`ªÀa£_°rùe
(
sh
);

4480 
cb
 = 
	`c⁄èöî_of
(
blk_cb
, 
øid5_∂ug_cb
, cb);

4482 i‡(
cb
->
li°
.
√xt
 =
NULL
) {

4483 
i
;

4484 
	`INIT_LIST_HEAD
(&
cb
->
li°
);

4485 
i
 = 0; i < 
NR_STRIPE_HASH_LOCKS
; i++)

4486 
	`INIT_LIST_HEAD
(
cb
->
ãmp_öa˘ive_li°
 + 
i
);

4489 i‡(!
	`ã°_™d_£t_bô
(
STRIPE_ON_UNPLUG_LIST
, &
sh
->
°©e
))

4490 
	`li°_add_èû
(&
sh
->
Ãu
, &
cb
->
li°
);

4492 
	`ªÀa£_°rùe
(
sh
);

4493 
	}
}

4495 
	$make_disˇrd_ªque°
(
mddev
 *mddev, 
bio
 *
bi
)

4497 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4498 
£˘‹_t
 
logiˇl_£˘‹
, 
œ°_£˘‹
;

4499 
°rùe_hód
 *
sh
;

4500 
ªmaöög
;

4501 
°rùe_£˘‹s
;

4503 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
)

4507 
logiˇl_£˘‹
 = 
bi
->
bi_ôî
.
bi_£˘‹
 & ~((
£˘‹_t
)
STRIPE_SECTORS
-1);

4508 
œ°_£˘‹
 = 
bi
->
bi_ôî
.
bi_£˘‹
 + (bi->bi_ôî.
bi_size
>>9);

4510 
bi
->
bi_√xt
 = 
NULL
;

4511 
bi
->
bi_phys_£gmíts
 = 1;

4513 
°rùe_£˘‹s
 = 
c⁄f
->
chunk_£˘‹s
 *

4514 (
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
);

4515 
logiˇl_£˘‹
 = 
	`DIV_ROUND_UP_SECTOR_T
(logical_sector,

4516 
°rùe_£˘‹s
);

4517 
	`£˘‹_div
(
œ°_£˘‹
, 
°rùe_£˘‹s
);

4519 
logiˇl_£˘‹
 *
c⁄f
->
chunk_£˘‹s
;

4520 
œ°_£˘‹
 *
c⁄f
->
chunk_£˘‹s
;

4522 ; 
logiˇl_£˘‹
 < 
œ°_£˘‹
;

4523 
logiˇl_£˘‹
 +
STRIPE_SECTORS
) {

4524 
	`DEFINE_WAIT
(
w
);

4525 
d
;

4526 
agaö
:

4527 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
logiˇl_£˘‹
, 0, 0, 0);

4528 
	`¥ï¨e_to_waô
(&
c⁄f
->
waô_f‹_ovîœp
, &
w
,

4529 
TASK_UNINTERRUPTIBLE
);

4530 
	`£t_bô
(
R5_Ovîœp
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

4531 i‡(
	`ã°_bô
(
STRIPE_SYNCING
, &
sh
->
°©e
)) {

4532 
	`ªÀa£_°rùe
(
sh
);

4533 
	`scheduÀ
();

4534 
agaö
;

4536 
	`˛ór_bô
(
R5_Ovîœp
, &
sh
->
dev
[sh->
pd_idx
].
Êags
);

4537 
	`•ö_lock_úq
(&
sh
->
°rùe_lock
);

4538 
d
 = 0; d < 
c⁄f
->
øid_disks
; d++) {

4539 i‡(
d
 =
sh
->
pd_idx
 || d =sh->
qd_idx
)

4541 i‡(
sh
->
dev
[
d
].
towrôe
 || sh->dev[d].
t‹ód
) {

4542 
	`£t_bô
(
R5_Ovîœp
, &
sh
->
dev
[
d
].
Êags
);

4543 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

4544 
	`ªÀa£_°rùe
(
sh
);

4545 
	`scheduÀ
();

4546 
agaö
;

4549 
	`£t_bô
(
STRIPE_DISCARD
, &
sh
->
°©e
);

4550 
	`föish_waô
(&
c⁄f
->
waô_f‹_ovîœp
, &
w
);

4551 
d
 = 0; d < 
c⁄f
->
øid_disks
; d++) {

4552 i‡(
d
 =
sh
->
pd_idx
 || d =sh->
qd_idx
)

4554 
sh
->
dev
[
d
].
towrôe
 = 
bi
;

4555 
	`£t_bô
(
R5_OVERWRITE
, &
sh
->
dev
[
d
].
Êags
);

4556 
	`øid5_öc_bi_a˘ive_°rùes
(
bi
);

4558 
	`•ö_u∆ock_úq
(&
sh
->
°rùe_lock
);

4559 i‡(
c⁄f
->
mddev
->
bôm≠
) {

4560 
d
 = 0;

4561 
d
 < 
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
;

4562 
d
++)

4563 
	`bôm≠_°¨twrôe
(
mddev
->
bôm≠
,

4564 
sh
->
£˘‹
,

4565 
STRIPE_SECTORS
,

4567 
sh
->
bm_£q
 = 
c⁄f
->
£q_Êush
 + 1;

4568 
	`£t_bô
(
STRIPE_BIT_DELAY
, &
sh
->
°©e
);

4571 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

4572 
	`˛ór_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

4573 i‡(!
	`ã°_™d_£t_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))

4574 
	`©omic_öc
(&
c⁄f
->
¥îód_a˘ive_°rùes
);

4575 
	`ªÀa£_°rùe_∂ug
(
mddev
, 
sh
);

4578 
ªmaöög
 = 
	`øid5_dec_bi_a˘ive_°rùes
(
bi
);

4579 i‡(
ªmaöög
 == 0) {

4580 
	`md_wrôe_íd
(
mddev
);

4581 
	`bio_ídio
(
bi
, 0);

4583 
	}
}

4585 
	$make_ªque°
(
mddev
 *mddev, 
bio
 * 
bi
)

4587 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4588 
dd_idx
;

4589 
£˘‹_t
 
√w_£˘‹
;

4590 
£˘‹_t
 
logiˇl_£˘‹
, 
œ°_£˘‹
;

4591 
°rùe_hód
 *
sh
;

4592 c⁄° 
rw
 = 
	`bio_d©a_dú
(
bi
);

4593 
ªmaöög
;

4594 
	`DEFINE_WAIT
(
w
);

4595 
boﬁ
 
do_¥ï¨e
;

4597 i‡(
	`u∆ikñy
(
bi
->
bi_rw
 & 
REQ_FLUSH
)) {

4598 
	`md_Êush_ªque°
(
mddev
, 
bi
);

4602 
	`md_wrôe_°¨t
(
mddev
, 
bi
);

4604 i‡(
rw
 =
READ
 &&

4605 
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
 &&

4606 
	`chunk_Æig√d_ªad
(
mddev
,
bi
))

4609 i‡(
	`u∆ikñy
(
bi
->
bi_rw
 & 
REQ_DISCARD
)) {

4610 
	`make_disˇrd_ªque°
(
mddev
, 
bi
);

4614 
logiˇl_£˘‹
 = 
bi
->
bi_ôî
.
bi_£˘‹
 & ~((
£˘‹_t
)
STRIPE_SECTORS
-1);

4615 
œ°_£˘‹
 = 
	`bio_íd_£˘‹
(
bi
);

4616 
bi
->
bi_√xt
 = 
NULL
;

4617 
bi
->
bi_phys_£gmíts
 = 1;

4619 
	`¥ï¨e_to_waô
(&
c⁄f
->
waô_f‹_ovîœp
, &
w
, 
TASK_UNINTERRUPTIBLE
);

4620 ;
logiˇl_£˘‹
 < 
œ°_£˘‹
;Üogiˇl_£˘‹ +
STRIPE_SECTORS
) {

4621 
¥evious
;

4622 
£q
;

4624 
do_¥ï¨e
 = 
Ál£
;

4625 
ªåy
:

4626 
£q
 = 
	`ªad_£qcou¡_begö
(&
c⁄f
->
gí_lock
);

4627 
¥evious
 = 0;

4628 i‡(
do_¥ï¨e
)

4629 
	`¥ï¨e_to_waô
(&
c⁄f
->
waô_f‹_ovîœp
, &
w
,

4630 
TASK_UNINTERRUPTIBLE
);

4631 i‡(
	`u∆ikñy
(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
)) {

4640 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4641 i‡(
mddev
->
ªsh≠e_backw¨ds


4642 ? 
logiˇl_£˘‹
 < 
c⁄f
->
ªsh≠e_¥ogªss


4643 : 
logiˇl_£˘‹
 >
c⁄f
->
ªsh≠e_¥ogªss
) {

4644 
¥evious
 = 1;

4646 i‡(
mddev
->
ªsh≠e_backw¨ds


4647 ? 
logiˇl_£˘‹
 < 
c⁄f
->
ªsh≠e_ß„


4648 : 
logiˇl_£˘‹
 >
c⁄f
->
ªsh≠e_ß„
) {

4649 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4650 
	`scheduÀ
();

4651 
do_¥ï¨e
 = 
åue
;

4652 
ªåy
;

4655 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4658 
√w_£˘‹
 = 
	`øid5_compuã_£˘‹
(
c⁄f
, 
logiˇl_£˘‹
,

4659 
¥evious
,

4660 &
dd_idx
, 
NULL
);

4661 
	`¥_debug
("raid456: make_request, sector %lluÜogical %llu\n",

4662 ()
√w_£˘‹
,

4663 ()
logiˇl_£˘‹
);

4665 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
√w_£˘‹
, 
¥evious
,

4666 (
bi
->
bi_rw
&
RWA_MASK
), 0);

4667 i‡(
sh
) {

4668 i‡(
	`u∆ikñy
(
¥evious
)) {

4677 
mu°_ªåy
 = 0;

4678 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4679 i‡(
mddev
->
ªsh≠e_backw¨ds


4680 ? 
logiˇl_£˘‹
 >
c⁄f
->
ªsh≠e_¥ogªss


4681 : 
logiˇl_£˘‹
 < 
c⁄f
->
ªsh≠e_¥ogªss
)

4683 
mu°_ªåy
 = 1;

4684 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4685 i‡(
mu°_ªåy
) {

4686 
	`ªÀa£_°rùe
(
sh
);

4687 
	`scheduÀ
();

4688 
do_¥ï¨e
 = 
åue
;

4689 
ªåy
;

4692 i‡(
	`ªad_£qcou¡_ªåy
(&
c⁄f
->
gí_lock
, 
£q
)) {

4696 
	`ªÀa£_°rùe
(
sh
);

4697 
ªåy
;

4700 i‡(
rw
 =
WRITE
 &&

4701 
logiˇl_£˘‹
 >
mddev
->
su•íd_lo
 &&

4702 
logiˇl_£˘‹
 < 
mddev
->
su•íd_hi
) {

4703 
	`ªÀa£_°rùe
(
sh
);

4708 
	`Êush_sig«ls
(
cuºít
);

4709 
	`¥ï¨e_to_waô
(&
c⁄f
->
waô_f‹_ovîœp
,

4710 &
w
, 
TASK_INTERRUPTIBLE
);

4711 i‡(
logiˇl_£˘‹
 >
mddev
->
su•íd_lo
 &&

4712 
logiˇl_£˘‹
 < 
mddev
->
su•íd_hi
) {

4713 
	`scheduÀ
();

4714 
do_¥ï¨e
 = 
åue
;

4716 
ªåy
;

4719 i‡(
	`ã°_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
) ||

4720 !
	`add_°rùe_bio
(
sh
, 
bi
, 
dd_idx
, 
rw
)) {

4725 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4726 
	`ªÀa£_°rùe
(
sh
);

4727 
	`scheduÀ
();

4728 
do_¥ï¨e
 = 
åue
;

4729 
ªåy
;

4731 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

4732 
	`˛ór_bô
(
STRIPE_DELAYED
, &
sh
->
°©e
);

4733 i‡((
bi
->
bi_rw
 & 
REQ_SYNC
) &&

4734 !
	`ã°_™d_£t_bô
(
STRIPE_PREREAD_ACTIVE
, &
sh
->
°©e
))

4735 
	`©omic_öc
(&
c⁄f
->
¥îód_a˘ive_°rùes
);

4736 
	`ªÀa£_°rùe_∂ug
(
mddev
, 
sh
);

4739 
	`˛ór_bô
(
BIO_UPTODATE
, &
bi
->
bi_Êags
);

4743 
	`föish_waô
(&
c⁄f
->
waô_f‹_ovîœp
, &
w
);

4745 
ªmaöög
 = 
	`øid5_dec_bi_a˘ive_°rùes
(
bi
);

4746 i‡(
ªmaöög
 == 0) {

4748 i‡–
rw
 =
WRITE
 )

4749 
	`md_wrôe_íd
(
mddev
);

4751 
	`åa˚_block_bio_com∂ëe
(
	`bdev_gë_queue
(
bi
->
bi_bdev
),

4752 
bi
, 0);

4753 
	`bio_ídio
(
bi
, 0);

4755 
	}
}

4757 
£˘‹_t
 
øid5_size
(
mddev
 *mddev, se˘‹_à
£˘‹s
, 
øid_disks
);

4759 
£˘‹_t
 
	$ªsh≠e_ªque°
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹_ƒ
, *
skù≥d
)

4770 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

4771 
°rùe_hód
 *
sh
;

4772 
£˘‹_t
 
fú°_£˘‹
, 
œ°_£˘‹
;

4773 
øid_disks
 = 
c⁄f
->
¥evious_øid_disks
;

4774 
d©a_disks
 = 
øid_disks
 - 
c⁄f
->
max_degøded
;

4775 
√w_d©a_disks
 = 
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
;

4776 
i
;

4777 
dd_idx
;

4778 
£˘‹_t
 
wrôïos
, 
ªadpos
, 
ß„pos
;

4779 
£˘‹_t
 
°rùe_addr
;

4780 
ªsh≠e_£˘‹s
;

4781 
li°_hód
 
°rùes
;

4783 i‡(
£˘‹_ƒ
 == 0) {

4785 i‡(
mddev
->
ªsh≠e_backw¨ds
 &&

4786 
c⁄f
->
ªsh≠e_¥ogªss
 < 
	`øid5_size
(
mddev
, 0, 0)) {

4787 
£˘‹_ƒ
 = 
	`øid5_size
(
mddev
, 0, 0)

4788 - 
c⁄f
->
ªsh≠e_¥ogªss
;

4789 } i‡(!
mddev
->
ªsh≠e_backw¨ds
 &&

4790 
c⁄f
->
ªsh≠e_¥ogªss
 > 0)

4791 
£˘‹_ƒ
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4792 
	`£˘‹_div
(
£˘‹_ƒ
, 
√w_d©a_disks
);

4793 i‡(
£˘‹_ƒ
) {

4794 
mddev
->
cuº_ªsync_com∂ëed
 = 
£˘‹_ƒ
;

4795 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

4796 *
skù≥d
 = 1;

4797  
£˘‹_ƒ
;

4805 i‡(
mddev
->
√w_chunk_£˘‹s
 > mddev->
chunk_£˘‹s
)

4806 
ªsh≠e_£˘‹s
 = 
mddev
->
√w_chunk_£˘‹s
;

4808 
ªsh≠e_£˘‹s
 = 
mddev
->
chunk_£˘‹s
;

4816 
wrôïos
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4817 
	`£˘‹_div
(
wrôïos
, 
√w_d©a_disks
);

4818 
ªadpos
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4819 
	`£˘‹_div
(
ªadpos
, 
d©a_disks
);

4820 
ß„pos
 = 
c⁄f
->
ªsh≠e_ß„
;

4821 
	`£˘‹_div
(
ß„pos
, 
d©a_disks
);

4822 i‡(
mddev
->
ªsh≠e_backw¨ds
) {

4823 
wrôïos
 -
	`mö_t
(
£˘‹_t
, 
ªsh≠e_£˘‹s
, writepos);

4824 
ªadpos
 +
ªsh≠e_£˘‹s
;

4825 
ß„pos
 +
ªsh≠e_£˘‹s
;

4827 
wrôïos
 +
ªsh≠e_£˘‹s
;

4828 
ªadpos
 -
	`mö_t
(
£˘‹_t
, 
ªsh≠e_£˘‹s
,Ñeadpos);

4829 
ß„pos
 -
	`mö_t
(
£˘‹_t
, 
ªsh≠e_£˘‹s
, safepos);

4835 i‡(
mddev
->
ªsh≠e_backw¨ds
) {

4836 
	`BUG_ON
(
c⁄f
->
ªsh≠e_¥ogªss
 == 0);

4837 
°rùe_addr
 = 
wrôïos
;

4838 
	`BUG_ON
((
mddev
->
dev_£˘‹s
 &

4839 ~((
£˘‹_t
)
ªsh≠e_£˘‹s
 - 1))

4840 - 
ªsh≠e_£˘‹s
 - 
°rùe_addr


4841 !
£˘‹_ƒ
);

4843 
	`BUG_ON
(
wrôïos
 !
£˘‹_ƒ
 + 
ªsh≠e_£˘‹s
);

4844 
°rùe_addr
 = 
£˘‹_ƒ
;

4867 i‡(
c⁄f
->
mö_off£t_diff
 < 0) {

4868 
ß„pos
 +-
c⁄f
->
mö_off£t_diff
;

4869 
ªadpos
 +-
c⁄f
->
mö_off£t_diff
;

4871 
wrôïos
 +
c⁄f
->
mö_off£t_diff
;

4873 i‡((
mddev
->
ªsh≠e_backw¨ds


4874 ? (
ß„pos
 > 
wrôïos
 && 
ªadpos
 < writepos)

4875 : (
ß„pos
 < 
wrôïos
 && 
ªadpos
 > writepos)) ||

4876 
	`time_a·î
(
jiffõs
, 
c⁄f
->
ªsh≠e_checkpoöt
 + 10*
HZ
)) {

4878 
	`waô_evít
(
c⁄f
->
waô_f‹_ovîœp
,

4879 
	`©omic_ªad
(&
c⁄f
->
ªsh≠e_°rùes
)==0

4880 || 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
));

4881 i‡(
	`©omic_ªad
(&
c⁄f
->
ªsh≠e_°rùes
) != 0)

4883 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4884 
mddev
->
cuº_ªsync_com∂ëed
 = 
£˘‹_ƒ
;

4885 
c⁄f
->
ªsh≠e_checkpoöt
 = 
jiffõs
;

4886 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

4887 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4888 
	`waô_evít
(
mddev
->
sb_waô
, mddev->
Êags
 == 0 ||

4889 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
));

4890 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

4892 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4893 
c⁄f
->
ªsh≠e_ß„
 = 
mddev
->
ªsh≠e_posôi⁄
;

4894 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4895 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

4896 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

4899 
	`INIT_LIST_HEAD
(&
°rùes
);

4900 
i
 = 0; i < 
ªsh≠e_£˘‹s
; i +
STRIPE_SECTORS
) {

4901 
j
;

4902 
skù≥d_disk
 = 0;

4903 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
°rùe_addr
+
i
, 0, 0, 1);

4904 
	`£t_bô
(
STRIPE_EXPANDING
, &
sh
->
°©e
);

4905 
	`©omic_öc
(&
c⁄f
->
ªsh≠e_°rùes
);

4909 
j
=
sh
->
disks
; j--;) {

4910 
£˘‹_t
 
s
;

4911 i‡(
j
 =
sh
->
pd_idx
)

4913 i‡(
c⁄f
->
Àvñ
 == 6 &&

4914 
j
 =
sh
->
qd_idx
)

4916 
s
 = 
	`compuã_blockƒ
(
sh
, 
j
, 0);

4917 i‡(
s
 < 
	`øid5_size
(
mddev
, 0, 0)) {

4918 
skù≥d_disk
 = 1;

4921 
	`mem£t
(
	`∑ge_addªss
(
sh
->
dev
[
j
].
∑ge
), 0, 
STRIPE_SIZE
);

4922 
	`£t_bô
(
R5_Ex∑nded
, &
sh
->
dev
[
j
].
Êags
);

4923 
	`£t_bô
(
R5_UPTODATE
, &
sh
->
dev
[
j
].
Êags
);

4925 i‡(!
skù≥d_disk
) {

4926 
	`£t_bô
(
STRIPE_EXPAND_READY
, &
sh
->
°©e
);

4927 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

4929 
	`li°_add
(&
sh
->
Ãu
, &
°rùes
);

4931 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4932 i‡(
mddev
->
ªsh≠e_backw¨ds
)

4933 
c⁄f
->
ªsh≠e_¥ogªss
 -
ªsh≠e_£˘‹s
 * 
√w_d©a_disks
;

4935 
c⁄f
->
ªsh≠e_¥ogªss
 +
ªsh≠e_£˘‹s
 * 
√w_d©a_disks
;

4936 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4942 
fú°_£˘‹
 =

4943 
	`øid5_compuã_£˘‹
(
c⁄f
, 
°rùe_addr
*(
√w_d©a_disks
),

4944 1, &
dd_idx
, 
NULL
);

4945 
œ°_£˘‹
 =

4946 
	`øid5_compuã_£˘‹
(
c⁄f
, ((
°rùe_addr
+
ªsh≠e_£˘‹s
)

4947 * 
√w_d©a_disks
 - 1),

4948 1, &
dd_idx
, 
NULL
);

4949 i‡(
œ°_£˘‹
 >
mddev
->
dev_£˘‹s
)

4950 
œ°_£˘‹
 = 
mddev
->
dev_£˘‹s
 - 1;

4951 
fú°_£˘‹
 <
œ°_£˘‹
) {

4952 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
fú°_£˘‹
, 1, 0, 1);

4953 
	`£t_bô
(
STRIPE_EXPAND_SOURCE
, &
sh
->
°©e
);

4954 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

4955 
	`ªÀa£_°rùe
(
sh
);

4956 
fú°_£˘‹
 +
STRIPE_SECTORS
;

4961 !
	`li°_em±y
(&
°rùes
)) {

4962 
sh
 = 
	`li°_íåy
(
°rùes
.
√xt
, 
°rùe_hód
, 
Ãu
);

4963 
	`li°_dñ_öô
(&
sh
->
Ãu
);

4964 
	`ªÀa£_°rùe
(
sh
);

4969 
£˘‹_ƒ
 +
ªsh≠e_£˘‹s
;

4970 i‡((
£˘‹_ƒ
 - 
mddev
->
cuº_ªsync_com∂ëed
) * 2

4971 >
mddev
->
ªsync_max
 - mddev->
cuº_ªsync_com∂ëed
) {

4973 
	`waô_evít
(
c⁄f
->
waô_f‹_ovîœp
,

4974 
	`©omic_ªad
(&
c⁄f
->
ªsh≠e_°rùes
) == 0

4975 || 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
));

4976 i‡(
	`©omic_ªad
(&
c⁄f
->
ªsh≠e_°rùes
) != 0)

4977 
ªt
;

4978 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

4979 
mddev
->
cuº_ªsync_com∂ëed
 = 
£˘‹_ƒ
;

4980 
c⁄f
->
ªsh≠e_checkpoöt
 = 
jiffõs
;

4981 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

4982 
	`md_wakeup_thªad
(
mddev
->
thªad
);

4983 
	`waô_evít
(
mddev
->
sb_waô
,

4984 !
	`ã°_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
)

4985 || 
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
));

4986 i‡(
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
))

4987 
ªt
;

4988 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

4989 
c⁄f
->
ªsh≠e_ß„
 = 
mddev
->
ªsh≠e_posôi⁄
;

4990 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

4991 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

4992 
	`sysfs_nŸify
(&
mddev
->
kobj
, 
NULL
, "sync_completed");

4994 
ªt
:

4995  
ªsh≠e_£˘‹s
;

4996 
	}
}

4999 
ölöe
 
£˘‹_t
 
	$sync_ªque°
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹_ƒ
, *
skù≥d
, 
go_Á°î
)

5001 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5002 
°rùe_hód
 *
sh
;

5003 
£˘‹_t
 
max_£˘‹
 = 
mddev
->
dev_£˘‹s
;

5004 
£˘‹_t
 
sync_blocks
;

5005 
°ûl_degøded
 = 0;

5006 
i
;

5008 i‡(
£˘‹_ƒ
 >
max_£˘‹
) {

5011 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
)) {

5012 
	`íd_ªsh≠e
(
c⁄f
);

5016 i‡(
mddev
->
cuº_ªsync
 < 
max_£˘‹
)

5017 
	`bôm≠_íd_sync
(
mddev
->
bôm≠
, mddev->
cuº_ªsync
,

5018 &
sync_blocks
, 1);

5020 
c⁄f
->
fuŒsync
 = 0;

5021 
	`bôm≠_˛o£_sync
(
mddev
->
bôm≠
);

5027 
	`waô_evít
(
c⁄f
->
waô_f‹_ovîœp
, c⁄f->
quõs˚
 != 2);

5029 i‡(
	`ã°_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
))

5030  
	`ªsh≠e_ªque°
(
mddev
, 
£˘‹_ƒ
, 
skù≥d
);

5042 i‡(
mddev
->
degøded
 >
c⁄f
->
max_degøded
 &&

5043 
	`ã°_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
)) {

5044 
£˘‹_t
 
rv
 = 
mddev
->
dev_£˘‹s
 - 
£˘‹_ƒ
;

5045 *
skù≥d
 = 1;

5046  
rv
;

5048 i‡(!
	`ã°_bô
(
MD_RECOVERY_REQUESTED
, &
mddev
->
ªcovîy
) &&

5049 !
c⁄f
->
fuŒsync
 &&

5050 !
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
, &
sync_blocks
, 1) &&

5051 
sync_blocks
 >
STRIPE_SECTORS
) {

5053 
sync_blocks
 /
STRIPE_SECTORS
;

5054 *
skù≥d
 = 1;

5055  
sync_blocks
 * 
STRIPE_SECTORS
;

5058 
	`bôm≠_c⁄d_íd_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
);

5060 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
£˘‹_ƒ
, 0, 1, 0);

5061 i‡(
sh
 =
NULL
) {

5062 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
£˘‹_ƒ
, 0, 0, 0);

5066 
	`scheduÀ_timeout_unöãºu±ibÀ
(1);

5072 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++)

5073 i‡(
c⁄f
->
disks
[
i
].
rdev
 =
NULL
)

5074 
°ûl_degøded
 = 1;

5076 
	`bôm≠_°¨t_sync
(
mddev
->
bôm≠
, 
£˘‹_ƒ
, &
sync_blocks
, 
°ûl_degøded
);

5078 
	`£t_bô
(
STRIPE_SYNC_REQUESTED
, &
sh
->
°©e
);

5079 
	`£t_bô
(
STRIPE_HANDLE
, &
sh
->
°©e
);

5081 
	`ªÀa£_°rùe
(
sh
);

5083  
STRIPE_SECTORS
;

5084 
	}
}

5086 
	$ªåy_Æig√d_ªad
(
r5c⁄f
 *
c⁄f
, 
bio
 *
øid_bio
)

5098 
°rùe_hód
 *
sh
;

5099 
dd_idx
;

5100 
£˘‹_t
 
£˘‹
, 
logiˇl_£˘‹
, 
œ°_£˘‹
;

5101 
s˙t
 = 0;

5102 
ªmaöög
;

5103 
h™dÀd
 = 0;

5105 
logiˇl_£˘‹
 = 
øid_bio
->
bi_ôî
.
bi_£˘‹
 &

5106 ~((
£˘‹_t
)
STRIPE_SECTORS
-1);

5107 
£˘‹
 = 
	`øid5_compuã_£˘‹
(
c⁄f
, 
logiˇl_£˘‹
,

5108 0, &
dd_idx
, 
NULL
);

5109 
œ°_£˘‹
 = 
	`bio_íd_£˘‹
(
øid_bio
);

5111 ; 
logiˇl_£˘‹
 < 
œ°_£˘‹
;

5112 
logiˇl_£˘‹
 +
STRIPE_SECTORS
,

5113 
£˘‹
 +
STRIPE_SECTORS
,

5114 
s˙t
++) {

5116 i‡(
s˙t
 < 
	`øid5_bi_¥o˚s£d_°rùes
(
øid_bio
))

5120 
sh
 = 
	`gë_a˘ive_°rùe
(
c⁄f
, 
£˘‹
, 0, 1, 1);

5122 i‡(!
sh
) {

5124 
	`øid5_£t_bi_¥o˚s£d_°rùes
(
øid_bio
, 
s˙t
);

5125 
c⁄f
->
ªåy_ªad_Æig√d
 = 
øid_bio
;

5126  
h™dÀd
;

5129 i‡(!
	`add_°rùe_bio
(
sh
, 
øid_bio
, 
dd_idx
, 0)) {

5130 
	`ªÀa£_°rùe
(
sh
);

5131 
	`øid5_£t_bi_¥o˚s£d_°rùes
(
øid_bio
, 
s˙t
);

5132 
c⁄f
->
ªåy_ªad_Æig√d
 = 
øid_bio
;

5133  
h™dÀd
;

5136 
	`£t_bô
(
R5_RódNoMîge
, &
sh
->
dev
[
dd_idx
].
Êags
);

5137 
	`h™dÀ_°rùe
(
sh
);

5138 
	`ªÀa£_°rùe
(
sh
);

5139 
h™dÀd
++;

5141 
ªmaöög
 = 
	`øid5_dec_bi_a˘ive_°rùes
(
øid_bio
);

5142 i‡(
ªmaöög
 == 0) {

5143 
	`åa˚_block_bio_com∂ëe
(
	`bdev_gë_queue
(
øid_bio
->
bi_bdev
),

5144 
øid_bio
, 0);

5145 
	`bio_ídio
(
øid_bio
, 0);

5147 i‡(
	`©omic_dec_™d_ã°
(&
c⁄f
->
a˘ive_Æig√d_ªads
))

5148 
	`wake_up
(&
c⁄f
->
waô_f‹_°rùe
);

5149  
h™dÀd
;

5150 
	}
}

5152 
	$h™dÀ_a˘ive_°rùes
(
r5c⁄f
 *
c⁄f
, 
group
,

5153 
r5w‹kî
 *
w‹kî
,

5154 
li°_hód
 *
ãmp_öa˘ive_li°
)

5156 
°rùe_hód
 *
b©ch
[
MAX_STRIPE_BATCH
], *
sh
;

5157 
i
, 
b©ch_size
 = 0, 
hash
;

5158 
boﬁ
 
ªÀa£_öa˘ive
 = 
Ál£
;

5160 
b©ch_size
 < 
MAX_STRIPE_BATCH
 &&

5161 (
sh
 = 
	`__gë_¥i‹ôy_°rùe
(
c⁄f
, 
group
)Ë!
NULL
)

5162 
b©ch
[
b©ch_size
++] = 
sh
;

5164 i‡(
b©ch_size
 == 0) {

5165 
i
 = 0; i < 
NR_STRIPE_HASH_LOCKS
; i++)

5166 i‡(!
	`li°_em±y
(
ãmp_öa˘ive_li°
 + 
i
))

5168 i‡(
i
 =
NR_STRIPE_HASH_LOCKS
)

5169  
b©ch_size
;

5170 
ªÀa£_öa˘ive
 = 
åue
;

5172 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5174 
	`ªÀa£_öa˘ive_°rùe_li°
(
c⁄f
, 
ãmp_öa˘ive_li°
,

5175 
NR_STRIPE_HASH_LOCKS
);

5177 i‡(
ªÀa£_öa˘ive
) {

5178 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5182 
i
 = 0; i < 
b©ch_size
; i++)

5183 
	`h™dÀ_°rùe
(
b©ch
[
i
]);

5185 
	`c⁄d_ªsched
();

5187 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5188 
i
 = 0; i < 
b©ch_size
; i++) {

5189 
hash
 = 
b©ch
[
i
]->
hash_lock_ödex
;

5190 
	`__ªÀa£_°rùe
(
c⁄f
, 
b©ch
[
i
], &
ãmp_öa˘ive_li°
[
hash
]);

5192  
b©ch_size
;

5193 
	}
}

5195 
	$øid5_do_w‹k
(
w‹k_°ru˘
 *
w‹k
)

5197 
r5w‹kî
 *
w‹kî
 = 
	`c⁄èöî_of
(
w‹k
, r5worker, work);

5198 
r5w‹kî_group
 *
group
 = 
w‹kî
->group;

5199 
r5c⁄f
 *
c⁄f
 = 
group
->conf;

5200 
group_id
 = 
group
 - 
c⁄f
->
w‹kî_groups
;

5201 
h™dÀd
;

5202 
blk_∂ug
 
∂ug
;

5204 
	`¥_debug
("+++Ñaid5workeráctive\n");

5206 
	`blk_°¨t_∂ug
(&
∂ug
);

5207 
h™dÀd
 = 0;

5208 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5210 
b©ch_size
, 
ªÀa£d
;

5212 
ªÀa£d
 = 
	`ªÀa£_°rùe_li°
(
c⁄f
, 
w‹kî
->
ãmp_öa˘ive_li°
);

5214 
b©ch_size
 = 
	`h™dÀ_a˘ive_°rùes
(
c⁄f
, 
group_id
, 
w‹kî
,

5215 
w‹kî
->
ãmp_öa˘ive_li°
);

5216 
w‹kî
->
w‹kög
 = 
Ál£
;

5217 i‡(!
b©ch_size
 && !
ªÀa£d
)

5219 
h™dÀd
 +
b©ch_size
;

5221 
	`¥_debug
("%d såùe†h™dÀd\n", 
h™dÀd
);

5223 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5224 
	`blk_föish_∂ug
(&
∂ug
);

5226 
	`¥_debug
("---Ñaid5worker inactive\n");

5227 
	}
}

5236 
	$øid5d
(
md_thªad
 *
thªad
)

5238 
mddev
 *mddev = 
thªad
->mddev;

5239 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5240 
h™dÀd
;

5241 
blk_∂ug
 
∂ug
;

5243 
	`¥_debug
("+++Ñaid5dáctive\n");

5245 
	`md_check_ªcovîy
(
mddev
);

5247 
	`blk_°¨t_∂ug
(&
∂ug
);

5248 
h™dÀd
 = 0;

5249 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5251 
bio
 *bio;

5252 
b©ch_size
, 
ªÀa£d
;

5254 
ªÀa£d
 = 
	`ªÀa£_°rùe_li°
(
c⁄f
, c⁄f->
ãmp_öa˘ive_li°
);

5257 !
	`li°_em±y
(&
c⁄f
->
bôm≠_li°
)) {

5259 
c⁄f
->
£q_Êush
++;

5260 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5261 
	`bôm≠_u≈lug
(
mddev
->
bôm≠
);

5262 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5263 
c⁄f
->
£q_wrôe
 = c⁄f->
£q_Êush
;

5264 
	`a˘iv©e_bô_dñay
(
c⁄f
, c⁄f->
ãmp_öa˘ive_li°
);

5266 
	`øid5_a˘iv©e_dñayed
(
c⁄f
);

5268 (
bio
 = 
	`ªmove_bio_‰om_ªåy
(
c⁄f
))) {

5269 
ok
;

5270 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5271 
ok
 = 
	`ªåy_Æig√d_ªad
(
c⁄f
, 
bio
);

5272 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5273 i‡(!
ok
)

5275 
h™dÀd
++;

5278 
b©ch_size
 = 
	`h™dÀ_a˘ive_°rùes
(
c⁄f
, 
ANY_GROUP
, 
NULL
,

5279 
c⁄f
->
ãmp_öa˘ive_li°
);

5280 i‡(!
b©ch_size
 && !
ªÀa£d
)

5282 
h™dÀd
 +
b©ch_size
;

5284 i‡(
mddev
->
Êags
 & ~(1<<
MD_CHANGE_PENDING
)) {

5285 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5286 
	`md_check_ªcovîy
(
mddev
);

5287 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5290 
	`¥_debug
("%d såùe†h™dÀd\n", 
h™dÀd
);

5292 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5294 
	`async_tx_issue_≥ndög_Æl
();

5295 
	`blk_föish_∂ug
(&
∂ug
);

5297 
	`¥_debug
("---Ñaid5d inactive\n");

5298 
	}
}

5300 
ssize_t


5301 
	$øid5_show_°rùe_ˇche_size
(
mddev
 *mddev, *
∑ge
)

5303 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5304 i‡(
c⁄f
)

5305  
	`•rötf
(
∑ge
, "%d\n", 
c⁄f
->
max_ƒ_°rùes
);

5308 
	}
}

5311 
	$øid5_£t_ˇche_size
(
mddev
 *mddev, 
size
)

5313 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5314 
îr
;

5315 
hash
;

5317 i‡(
size
 <= 16 || size > 32768)

5318  -
EINVAL
;

5319 
hash
 = (
c⁄f
->
max_ƒ_°rùes
 - 1Ë% 
NR_STRIPE_HASH_LOCKS
;

5320 
size
 < 
c⁄f
->
max_ƒ_°rùes
) {

5321 i‡(
	`dr›_⁄e_°rùe
(
c⁄f
, 
hash
))

5322 
c⁄f
->
max_ƒ_°rùes
--;

5325 
hash
--;

5326 i‡(
hash
 < 0)

5327 
hash
 = 
NR_STRIPE_HASH_LOCKS
 - 1;

5329 
îr
 = 
	`md_Ælow_wrôe
(
mddev
);

5330 i‡(
îr
)

5331  
îr
;

5332 
hash
 = 
c⁄f
->
max_ƒ_°rùes
 % 
NR_STRIPE_HASH_LOCKS
;

5333 
size
 > 
c⁄f
->
max_ƒ_°rùes
) {

5334 i‡(
	`grow_⁄e_°rùe
(
c⁄f
, 
hash
))

5335 
c⁄f
->
max_ƒ_°rùes
++;

5337 
hash
 = (hash + 1Ë% 
NR_STRIPE_HASH_LOCKS
;

5340 
	}
}

5341 
EXPORT_SYMBOL
(
øid5_£t_ˇche_size
);

5343 
ssize_t


5344 
	$øid5_°‹e_°rùe_ˇche_size
(
mddev
 *mddev, c⁄° *
∑ge
, 
size_t
 
Àn
)

5346 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5347 
√w
;

5348 
îr
;

5350 i‡(
Àn
 >
PAGE_SIZE
)

5351  -
EINVAL
;

5352 i‡(!
c⁄f
)

5353  -
ENODEV
;

5355 i‡(
	`k°πoul
(
∑ge
, 10, &
√w
))

5356  -
EINVAL
;

5357 
îr
 = 
	`øid5_£t_ˇche_size
(
mddev
, 
√w
);

5358 i‡(
îr
)

5359  
îr
;

5360  
Àn
;

5361 
	}
}

5363 
md_sysfs_íåy


5364 
	gøid5_°rùeˇche_size
 = 
__ATTR
(
°rùe_ˇche_size
, 
S_IRUGO
 | 
S_IWUSR
,

5365 
øid5_show_°rùe_ˇche_size
,

5366 
øid5_°‹e_°rùe_ˇche_size
);

5368 
ssize_t


5369 
	$øid5_show_¥îód_thªshﬁd
(
mddev
 *mddev, *
∑ge
)

5371 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5372 i‡(
c⁄f
)

5373  
	`•rötf
(
∑ge
, "%d\n", 
c⁄f
->
by∑ss_thªshﬁd
);

5376 
	}
}

5378 
ssize_t


5379 
	$øid5_°‹e_¥îód_thªshﬁd
(
mddev
 *mddev, c⁄° *
∑ge
, 
size_t
 
Àn
)

5381 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5382 
√w
;

5383 i‡(
Àn
 >
PAGE_SIZE
)

5384  -
EINVAL
;

5385 i‡(!
c⁄f
)

5386  -
ENODEV
;

5388 i‡(
	`k°πoul
(
∑ge
, 10, &
√w
))

5389  -
EINVAL
;

5390 i‡(
√w
 > 
c⁄f
->
max_ƒ_°rùes
)

5391  -
EINVAL
;

5392 
c⁄f
->
by∑ss_thªshﬁd
 = 
√w
;

5393  
Àn
;

5394 
	}
}

5396 
md_sysfs_íåy


5397 
	gøid5_¥îód_by∑ss_thªshﬁd
 = 
__ATTR
(
¥îód_by∑ss_thªshﬁd
,

5398 
S_IRUGO
 | 
S_IWUSR
,

5399 
øid5_show_¥îód_thªshﬁd
,

5400 
øid5_°‹e_¥îód_thªshﬁd
);

5402 
ssize_t


5403 
	$øid5_show_skù_c›y
(
mddev
 *mddev, *
∑ge
)

5405 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5406 i‡(
c⁄f
)

5407  
	`•rötf
(
∑ge
, "%d\n", 
c⁄f
->
skù_c›y
);

5410 
	}
}

5412 
ssize_t


5413 
	$øid5_°‹e_skù_c›y
(
mddev
 *mddev, c⁄° *
∑ge
, 
size_t
 
Àn
)

5415 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5416 
√w
;

5417 i‡(
Àn
 >
PAGE_SIZE
)

5418  -
EINVAL
;

5419 i‡(!
c⁄f
)

5420  -
ENODEV
;

5422 i‡(
	`k°πoul
(
∑ge
, 10, &
√w
))

5423  -
EINVAL
;

5424 
√w
 = !!new;

5425 i‡(
√w
 =
c⁄f
->
skù_c›y
)

5426  
Àn
;

5428 
	`mddev_su•íd
(
mddev
);

5429 
c⁄f
->
skù_c›y
 = 
√w
;

5430 i‡(
√w
)

5431 
mddev
->
queue
->
backög_dev_öfo
.
ˇ∑bûôõs
 |=

5432 
BDI_CAP_STABLE_WRITES
;

5434 
mddev
->
queue
->
backög_dev_öfo
.
ˇ∑bûôõs
 &=

5435 ~
BDI_CAP_STABLE_WRITES
;

5436 
	`mddev_ªsume
(
mddev
);

5437  
Àn
;

5438 
	}
}

5440 
md_sysfs_íåy


5441 
	gøid5_skù_c›y
 = 
__ATTR
(
skù_c›y
, 
S_IRUGO
 | 
S_IWUSR
,

5442 
øid5_show_skù_c›y
,

5443 
øid5_°‹e_skù_c›y
);

5446 
ssize_t


5447 
	$°rùe_ˇche_a˘ive_show
(
mddev
 *mddev, *
∑ge
)

5449 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5450 i‡(
c⁄f
)

5451  
	`•rötf
(
∑ge
, "%d\n", 
	`©omic_ªad
(&
c⁄f
->
a˘ive_°rùes
));

5454 
	}
}

5456 
md_sysfs_íåy


5457 
	gøid5_°rùeˇche_a˘ive
 = 
__ATTR_RO
(
°rùe_ˇche_a˘ive
);

5459 
ssize_t


5460 
	$øid5_show_group_thªad_˙t
(
mddev
 *mddev, *
∑ge
)

5462 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5463 i‡(
c⁄f
)

5464  
	`•rötf
(
∑ge
, "%d\n", 
c⁄f
->
w‹kî_˙t_≥r_group
);

5467 
	}
}

5469 
Æloc_thªad_groups
(
r5c⁄f
 *
c⁄f
, 
˙t
,

5470 *
group_˙t
,

5471 *
w‹kî_˙t_≥r_group
,

5472 
r5w‹kî_group
 **
w‹kî_groups
);

5473 
ssize_t


5474 
	$øid5_°‹e_group_thªad_˙t
(
mddev
 *mddev, c⁄° *
∑ge
, 
size_t
 
Àn
)

5476 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5477 
√w
;

5478 
îr
;

5479 
r5w‹kî_group
 *
√w_groups
, *
ﬁd_groups
;

5480 
group_˙t
, 
w‹kî_˙t_≥r_group
;

5482 i‡(
Àn
 >
PAGE_SIZE
)

5483  -
EINVAL
;

5484 i‡(!
c⁄f
)

5485  -
ENODEV
;

5487 i‡(
	`k°πoul
(
∑ge
, 10, &
√w
))

5488  -
EINVAL
;

5490 i‡(
√w
 =
c⁄f
->
w‹kî_˙t_≥r_group
)

5491  
Àn
;

5493 
	`mddev_su•íd
(
mddev
);

5495 
ﬁd_groups
 = 
c⁄f
->
w‹kî_groups
;

5496 i‡(
ﬁd_groups
)

5497 
	`Êush_w‹kqueue
(
øid5_wq
);

5499 
îr
 = 
	`Æloc_thªad_groups
(
c⁄f
, 
√w
,

5500 &
group_˙t
, &
w‹kî_˙t_≥r_group
,

5501 &
√w_groups
);

5502 i‡(!
îr
) {

5503 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

5504 
c⁄f
->
group_˙t
 = group_cnt;

5505 
c⁄f
->
w‹kî_˙t_≥r_group
 = worker_cnt_per_group;

5506 
c⁄f
->
w‹kî_groups
 = 
√w_groups
;

5507 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

5509 i‡(
ﬁd_groups
)

5510 
	`k‰ì
(
ﬁd_groups
[0].
w‹kîs
);

5511 
	`k‰ì
(
ﬁd_groups
);

5514 
	`mddev_ªsume
(
mddev
);

5516 i‡(
îr
)

5517  
îr
;

5518  
Àn
;

5519 
	}
}

5521 
md_sysfs_íåy


5522 
	gøid5_group_thªad_˙t
 = 
__ATTR
(
group_thªad_˙t
, 
S_IRUGO
 | 
S_IWUSR
,

5523 
øid5_show_group_thªad_˙t
,

5524 
øid5_°‹e_group_thªad_˙t
);

5526 
©åibuã
 *
	gøid5_©ås
[] = {

5527 &
øid5_°rùeˇche_size
.
©å
,

5528 &
øid5_°rùeˇche_a˘ive
.
©å
,

5529 &
øid5_¥îód_by∑ss_thªshﬁd
.
©å
,

5530 &
øid5_group_thªad_˙t
.
©å
,

5531 &
øid5_skù_c›y
.
©å
,

5532 
NULL
,

5534 
©åibuã_group
 
	gøid5_©ås_group
 = {

5535 .
«me
 = 
NULL
,

5536 .
	g©ås
 = 
øid5_©ås
,

5539 
	$Æloc_thªad_groups
(
r5c⁄f
 *
c⁄f
, 
˙t
,

5540 *
group_˙t
,

5541 *
w‹kî_˙t_≥r_group
,

5542 
r5w‹kî_group
 **
w‹kî_groups
)

5544 
i
, 
j
, 
k
;

5545 
ssize_t
 
size
;

5546 
r5w‹kî
 *
w‹kîs
;

5548 *
w‹kî_˙t_≥r_group
 = 
˙t
;

5549 i‡(
˙t
 == 0) {

5550 *
group_˙t
 = 0;

5551 *
w‹kî_groups
 = 
NULL
;

5554 *
group_˙t
 = 
	`num_possibÀ_nodes
();

5555 
size
 = (
r5w‹kî
Ë* 
˙t
;

5556 
w‹kîs
 = 
	`kzÆloc
(
size
 * *
group_˙t
, 
GFP_NOIO
);

5557 *
w‹kî_groups
 = 
	`kzÆloc
((
r5w‹kî_group
) *

5558 *
group_˙t
, 
GFP_NOIO
);

5559 i‡(!*
w‹kî_groups
 || !
w‹kîs
) {

5560 
	`k‰ì
(
w‹kîs
);

5561 
	`k‰ì
(*
w‹kî_groups
);

5562  -
ENOMEM
;

5565 
i
 = 0; i < *
group_˙t
; i++) {

5566 
r5w‹kî_group
 *
group
;

5568 
group
 = &(*
w‹kî_groups
)[
i
];

5569 
	`INIT_LIST_HEAD
(&
group
->
h™dÀ_li°
);

5570 
group
->
c⁄f
 = conf;

5571 
group
->
w‹kîs
 = w‹kî†+ 
i
 * 
˙t
;

5573 
j
 = 0; j < 
˙t
; j++) {

5574 
r5w‹kî
 *
w‹kî
 = 
group
->
w‹kîs
 + 
j
;

5575 
w‹kî
->
group
 = group;

5576 
	`INIT_WORK
(&
w‹kî
->
w‹k
, 
øid5_do_w‹k
);

5578 
k
 = 0; k < 
NR_STRIPE_HASH_LOCKS
; k++)

5579 
	`INIT_LIST_HEAD
(
w‹kî
->
ãmp_öa˘ive_li°
 + 
k
);

5584 
	}
}

5586 
	$‰ì_thªad_groups
(
r5c⁄f
 *
c⁄f
)

5588 i‡(
c⁄f
->
w‹kî_groups
)

5589 
	`k‰ì
(
c⁄f
->
w‹kî_groups
[0].
w‹kîs
);

5590 
	`k‰ì
(
c⁄f
->
w‹kî_groups
);

5591 
c⁄f
->
w‹kî_groups
 = 
NULL
;

5592 
	}
}

5594 
£˘‹_t


5595 
	$øid5_size
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
, 
øid_disks
)

5597 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

5599 i‡(!
£˘‹s
)

5600 
£˘‹s
 = 
mddev
->
dev_£˘‹s
;

5601 i‡(!
øid_disks
)

5603 
øid_disks
 = 
	`mö
(
c⁄f
->øid_disks, c⁄f->
¥evious_øid_disks
);

5605 
£˘‹s
 &~((
£˘‹_t
)
mddev
->
chunk_£˘‹s
 - 1);

5606 
£˘‹s
 &~((
£˘‹_t
)
mddev
->
√w_chunk_£˘‹s
 - 1);

5607  
£˘‹s
 * (
øid_disks
 - 
c⁄f
->
max_degøded
);

5608 
	}
}

5610 
	$‰ì_s¸©ch_buf„r
(
r5c⁄f
 *
c⁄f
, 
øid5_≥r˝u
 *
≥r˝u
)

5612 
	`ß„_put_∑ge
(
≥r˝u
->
•¨e_∑ge
);

5613 
	`k‰ì
(
≥r˝u
->
s¸ibbÀ
);

5614 
≥r˝u
->
•¨e_∑ge
 = 
NULL
;

5615 
≥r˝u
->
s¸ibbÀ
 = 
NULL
;

5616 
	}
}

5618 
	$Æloc_s¸©ch_buf„r
(
r5c⁄f
 *
c⁄f
, 
øid5_≥r˝u
 *
≥r˝u
)

5620 i‡(
c⁄f
->
Àvñ
 =6 && !
≥r˝u
->
•¨e_∑ge
)

5621 
≥r˝u
->
•¨e_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

5622 i‡(!
≥r˝u
->
s¸ibbÀ
)

5623 
≥r˝u
->
s¸ibbÀ
 = 
	`kmÆloc
(
c⁄f
->
s¸ibbÀ_Àn
, 
GFP_KERNEL
);

5625 i‡(!
≥r˝u
->
s¸ibbÀ
 || (
c⁄f
->
Àvñ
 =6 && !≥r˝u->
•¨e_∑ge
)) {

5626 
	`‰ì_s¸©ch_buf„r
(
c⁄f
, 
≥r˝u
);

5627  -
ENOMEM
;

5631 
	}
}

5633 
	$øid5_‰ì_≥r˝u
(
r5c⁄f
 *
c⁄f
)

5635 
˝u
;

5637 i‡(!
c⁄f
->
≥r˝u
)

5640 #ifde‡
CONFIG_HOTPLUG_CPU


5641 
	`uƒegi°î_˝u_nŸifõr
(&
c⁄f
->
˝u_nŸify
);

5644 
	`gë_⁄löe_˝us
();

5645 
	`f‹_óch_possibÀ_˝u
(
˝u
)

5646 
	`‰ì_s¸©ch_buf„r
(
c⁄f
, 
	`≥r_˝u_±r
(c⁄f->
≥r˝u
, 
˝u
));

5647 
	`put_⁄löe_˝us
();

5649 
	`‰ì_≥r˝u
(
c⁄f
->
≥r˝u
);

5650 
	}
}

5652 
	$‰ì_c⁄f
(
r5c⁄f
 *
c⁄f
)

5654 
	`‰ì_thªad_groups
(
c⁄f
);

5655 
	`shrök_°rùes
(
c⁄f
);

5656 
	`øid5_‰ì_≥r˝u
(
c⁄f
);

5657 
	`k‰ì
(
c⁄f
->
disks
);

5658 
	`k‰ì
(
c⁄f
->
°rùe_hashtbl
);

5659 
	`k‰ì
(
c⁄f
);

5660 
	}
}

5662 #ifde‡
CONFIG_HOTPLUG_CPU


5663 
	$øid456_˝u_nŸify
(
nŸifõr_block
 *
nfb
, 
a˘i⁄
,

5664 *
h˝u
)

5666 
r5c⁄f
 *
c⁄f
 = 
	`c⁄èöî_of
(
nfb
, r5c⁄f, 
˝u_nŸify
);

5667 
˝u
 = ()
h˝u
;

5668 
øid5_≥r˝u
 *
≥r˝u
 = 
	`≥r_˝u_±r
(
c⁄f
->≥r˝u, 
˝u
);

5670 
a˘i⁄
) {

5671 
CPU_UP_PREPARE
:

5672 
CPU_UP_PREPARE_FROZEN
:

5673 i‡(
	`Æloc_s¸©ch_buf„r
(
c⁄f
, 
≥r˝u
)) {

5674 
	`¥_îr
("%s: failed memoryállocation for cpu%ld\n",

5675 
__func__
, 
˝u
);

5676  
	`nŸifõr_‰om_î∫o
(-
ENOMEM
);

5679 
CPU_DEAD
:

5680 
CPU_DEAD_FROZEN
:

5681 
	`‰ì_s¸©ch_buf„r
(
c⁄f
, 
	`≥r_˝u_±r
(c⁄f->
≥r˝u
, 
˝u
));

5686  
NOTIFY_OK
;

5687 
	}
}

5690 
	$øid5_Æloc_≥r˝u
(
r5c⁄f
 *
c⁄f
)

5692 
˝u
;

5693 
îr
 = 0;

5695 
c⁄f
->
≥r˝u
 = 
	`Æloc_≥r˝u
(
øid5_≥r˝u
);

5696 i‡(!
c⁄f
->
≥r˝u
)

5697  -
ENOMEM
;

5699 #ifde‡
CONFIG_HOTPLUG_CPU


5700 
c⁄f
->
˝u_nŸify
.
nŸifõr_ˇŒ
 = 
øid456_˝u_nŸify
;

5701 
c⁄f
->
˝u_nŸify
.
¥i‹ôy
 = 0;

5702 
îr
 = 
	`ªgi°î_˝u_nŸifõr
(&
c⁄f
->
˝u_nŸify
);

5703 i‡(
îr
)

5704  
îr
;

5707 
	`gë_⁄löe_˝us
();

5708 
	`f‹_óch_¥e£¡_˝u
(
˝u
) {

5709 
îr
 = 
	`Æloc_s¸©ch_buf„r
(
c⁄f
, 
	`≥r_˝u_±r
(c⁄f->
≥r˝u
, 
˝u
));

5710 i‡(
îr
) {

5711 
	`¥_îr
("%s: failed memoryállocation for cpu%ld\n",

5712 
__func__
, 
˝u
);

5716 
	`put_⁄löe_˝us
();

5718  
îr
;

5719 
	}
}

5721 
r5c⁄f
 *
	$£tup_c⁄f
(
mddev
 *mddev)

5723 
r5c⁄f
 *
c⁄f
;

5724 
øid_disk
, 
mem‹y
, 
max_disks
;

5725 
md_rdev
 *
rdev
;

5726 
disk_öfo
 *
disk
;

5727 
≥rs_«me
[6];

5728 
i
;

5729 
group_˙t
, 
w‹kî_˙t_≥r_group
;

5730 
r5w‹kî_group
 *
√w_group
;

5732 i‡(
mddev
->
√w_Àvñ
 != 5

5733 && 
mddev
->
√w_Àvñ
 != 4

5734 && 
mddev
->
√w_Àvñ
 != 6) {

5735 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:ÑaidÜevelÇot setÅo 4/5/6 (%d)\n",

5736 
	`md«me
(
mddev
), mddev->
√w_Àvñ
);

5737  
	`ERR_PTR
(-
EIO
);

5739 i‡((
mddev
->
√w_Àvñ
 == 5

5740 && !
	`Æg‹ôhm_vÆid_øid5
(
mddev
->
√w_œyout
)) ||

5741 (
mddev
->
√w_Àvñ
 == 6

5742 && !
	`Æg‹ôhm_vÆid_øid6
(
mddev
->
√w_œyout
))) {

5743 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:Üayout %dÇot supported\n",

5744 
	`md«me
(
mddev
), mddev->
√w_œyout
);

5745  
	`ERR_PTR
(-
EIO
);

5747 i‡(
mddev
->
√w_Àvñ
 =6 && mddev->
øid_disks
 < 4) {

5748 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:ÇotÉnough configured devices (%d, minimum 4)\n",

5749 
	`md«me
(
mddev
), mddev->
øid_disks
);

5750  
	`ERR_PTR
(-
EINVAL
);

5753 i‡(!
mddev
->
√w_chunk_£˘‹s
 ||

5754 (
mddev
->
√w_chunk_£˘‹s
 << 9Ë% 
PAGE_SIZE
 ||

5755 !
	`is_powî_of_2
(
mddev
->
√w_chunk_£˘‹s
)) {

5756 
	`¥ötk
(
KERN_ERR
 "md/raid:%s: invalid chunk size %d\n",

5757 
	`md«me
(
mddev
), mddev->
√w_chunk_£˘‹s
 << 9);

5758  
	`ERR_PTR
(-
EINVAL
);

5761 
c⁄f
 = 
	`kzÆloc
((
r5c⁄f
), 
GFP_KERNEL
);

5762 i‡(
c⁄f
 =
NULL
)

5763 
ab‹t
;

5765 i‡(!
	`Æloc_thªad_groups
(
c⁄f
, 0, &
group_˙t
, &
w‹kî_˙t_≥r_group
,

5766 &
√w_group
)) {

5767 
c⁄f
->
group_˙t
 = group_cnt;

5768 
c⁄f
->
w‹kî_˙t_≥r_group
 = worker_cnt_per_group;

5769 
c⁄f
->
w‹kî_groups
 = 
√w_group
;

5771 
ab‹t
;

5772 
	`•ö_lock_öô
(&
c⁄f
->
devi˚_lock
);

5773 
	`£qcou¡_öô
(&
c⁄f
->
gí_lock
);

5774 
	`öô_waôqueue_hód
(&
c⁄f
->
waô_f‹_°rùe
);

5775 
	`öô_waôqueue_hód
(&
c⁄f
->
waô_f‹_ovîœp
);

5776 
	`INIT_LIST_HEAD
(&
c⁄f
->
h™dÀ_li°
);

5777 
	`INIT_LIST_HEAD
(&
c⁄f
->
hﬁd_li°
);

5778 
	`INIT_LIST_HEAD
(&
c⁄f
->
dñayed_li°
);

5779 
	`INIT_LIST_HEAD
(&
c⁄f
->
bôm≠_li°
);

5780 
	`öô_Œi°_hód
(&
c⁄f
->
ªÀa£d_°rùes
);

5781 
	`©omic_£t
(&
c⁄f
->
a˘ive_°rùes
, 0);

5782 
	`©omic_£t
(&
c⁄f
->
¥îód_a˘ive_°rùes
, 0);

5783 
	`©omic_£t
(&
c⁄f
->
a˘ive_Æig√d_ªads
, 0);

5784 
c⁄f
->
by∑ss_thªshﬁd
 = 
BYPASS_THRESHOLD
;

5785 
c⁄f
->
ªcovîy_dißbÀd
 = 
mddev
->recovery_disabled - 1;

5787 
c⁄f
->
øid_disks
 = 
mddev
->raid_disks;

5788 i‡(
mddev
->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
)

5789 
c⁄f
->
¥evious_øid_disks
 = 
mddev
->
øid_disks
;

5791 
c⁄f
->
¥evious_øid_disks
 = 
mddev
->
øid_disks
 - mddev->
dñè_disks
;

5792 
max_disks
 = 
	`max
(
c⁄f
->
øid_disks
, c⁄f->
¥evious_øid_disks
);

5793 
c⁄f
->
s¸ibbÀ_Àn
 = 
	`s¸ibbÀ_Àn
(
max_disks
);

5795 
c⁄f
->
disks
 = 
	`kzÆloc
(
max_disks
 * (
disk_öfo
),

5796 
GFP_KERNEL
);

5797 i‡(!
c⁄f
->
disks
)

5798 
ab‹t
;

5800 
c⁄f
->
mddev
 = mddev;

5802 i‡((
c⁄f
->
°rùe_hashtbl
 = 
	`kzÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
)Ë=
NULL
)

5803 
ab‹t
;

5810 
	`•ö_lock_öô
(
c⁄f
->
hash_locks
);

5811 
i
 = 1; i < 
NR_STRIPE_HASH_LOCKS
; i++)

5812 
	`•ö_lock_öô
(
c⁄f
->
hash_locks
 + 
i
);

5814 
i
 = 0; i < 
NR_STRIPE_HASH_LOCKS
; i++)

5815 
	`INIT_LIST_HEAD
(
c⁄f
->
öa˘ive_li°
 + 
i
);

5817 
i
 = 0; i < 
NR_STRIPE_HASH_LOCKS
; i++)

5818 
	`INIT_LIST_HEAD
(
c⁄f
->
ãmp_öa˘ive_li°
 + 
i
);

5820 
c⁄f
->
Àvñ
 = 
mddev
->
√w_Àvñ
;

5821 i‡(
	`øid5_Æloc_≥r˝u
(
c⁄f
) != 0)

5822 
ab‹t
;

5824 
	`¥_debug
("øid456:Ñun(%sËˇŒed.\n", 
	`md«me
(
mddev
));

5826 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

5827 
øid_disk
 = 
rdev
->raid_disk;

5828 i‡(
øid_disk
 >
max_disks


5829 || 
øid_disk
 < 0)

5831 
disk
 = 
c⁄f
->
disks
 + 
øid_disk
;

5833 i‡(
	`ã°_bô
(
Rïœ˚mít
, &
rdev
->
Êags
)) {

5834 i‡(
disk
->
ª∂a˚mít
)

5835 
ab‹t
;

5836 
disk
->
ª∂a˚mít
 = 
rdev
;

5838 i‡(
disk
->
rdev
)

5839 
ab‹t
;

5840 
disk
->
rdev
 =Ñdev;

5843 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

5844 
b
[
BDEVNAME_SIZE
];

5845 
	`¥ötk
(
KERN_INFO
 "md/raid:%s: device %s operationalásÑaid"

5847 
	`md«me
(
mddev
), 
	`bdev«me
(
rdev
->
bdev
, 
b
), 
øid_disk
);

5848 } i‡(
rdev
->
ßved_øid_disk
 !
øid_disk
)

5850 
c⁄f
->
fuŒsync
 = 1;

5853 
c⁄f
->
chunk_£˘‹s
 = 
mddev
->
√w_chunk_£˘‹s
;

5854 
c⁄f
->
Àvñ
 = 
mddev
->
√w_Àvñ
;

5855 i‡(
c⁄f
->
Àvñ
 == 6)

5856 
c⁄f
->
max_degøded
 = 2;

5858 
c⁄f
->
max_degøded
 = 1;

5859 
c⁄f
->
Æg‹ôhm
 = 
mddev
->
√w_œyout
;

5860 
c⁄f
->
ªsh≠e_¥ogªss
 = 
mddev
->
ªsh≠e_posôi⁄
;

5861 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

5862 
c⁄f
->
¥ev_chunk_£˘‹s
 = 
mddev
->
chunk_£˘‹s
;

5863 
c⁄f
->
¥ev_Ægo
 = 
mddev
->
œyout
;

5866 
mem‹y
 = 
c⁄f
->
max_ƒ_°rùes
 * ((
°rùe_hód
) +

5867 
max_disks
 * (((
bio
Ë+ 
PAGE_SIZE
))) / 1024;

5868 
	`©omic_£t
(&
c⁄f
->
em±y_öa˘ive_li°_ƒ
, 
NR_STRIPE_HASH_LOCKS
);

5869 i‡(
	`grow_°rùes
(
c⁄f
, 
NR_STRIPES
)) {

5870 
	`¥ötk
(
KERN_ERR


5872 
	`md«me
(
mddev
), 
mem‹y
);

5873 
ab‹t
;

5875 
	`¥ötk
(
KERN_INFO
 "md/raid:%s:állocated %dkB\n",

5876 
	`md«me
(
mddev
), 
mem‹y
);

5878 
	`•rötf
(
≥rs_«me
, "øid%d", 
mddev
->
√w_Àvñ
);

5879 
c⁄f
->
thªad
 = 
	`md_ªgi°î_thªad
(
øid5d
, 
mddev
, 
≥rs_«me
);

5880 i‡(!
c⁄f
->
thªad
) {

5881 
	`¥ötk
(
KERN_ERR


5883 
	`md«me
(
mddev
));

5884 
ab‹t
;

5887  
c⁄f
;

5889 
ab‹t
:

5890 i‡(
c⁄f
) {

5891 
	`‰ì_c⁄f
(
c⁄f
);

5892  
	`ERR_PTR
(-
EIO
);

5894  
	`ERR_PTR
(-
ENOMEM
);

5895 
	}
}

5898 
	$⁄ly_∑rôy
(
øid_disk
, 
Ægo
, 
øid_disks
, 
max_degøded
)

5900 
Ægo
) {

5901 
ALGORITHM_PARITY_0
:

5902 i‡(
øid_disk
 < 
max_degøded
)

5905 
ALGORITHM_PARITY_N
:

5906 i‡(
øid_disk
 >
øid_disks
 - 
max_degøded
)

5909 
ALGORITHM_PARITY_0_6
:

5910 i‡(
øid_disk
 == 0 ||

5911 
øid_disk
 =
øid_disks
 - 1)

5914 
ALGORITHM_LEFT_ASYMMETRIC_6
:

5915 
ALGORITHM_RIGHT_ASYMMETRIC_6
:

5916 
ALGORITHM_LEFT_SYMMETRIC_6
:

5917 
ALGORITHM_RIGHT_SYMMETRIC_6
:

5918 i‡(
øid_disk
 =
øid_disks
 - 1)

5922 
	}
}

5924 
	$run
(
mddev
 *mddev)

5926 
r5c⁄f
 *
c⁄f
;

5927 
w‹kög_disks
 = 0;

5928 
dúty_∑rôy_disks
 = 0;

5929 
md_rdev
 *
rdev
;

5930 
£˘‹_t
 
ªsh≠e_off£t
 = 0;

5931 
i
;

5932 
mö_off£t_diff
 = 0;

5933 
fú°
 = 1;

5935 i‡(
mddev
->
ªcovîy_˝
 !
MaxSe˘‹
)

5936 
	`¥ötk
(
KERN_NOTICE
 "md/raid:%s:Çot clean"

5938 
	`md«me
(
mddev
));

5940 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

5941 
diff
;

5942 i‡(
rdev
->
øid_disk
 < 0)

5944 
diff
 = (
rdev
->
√w_d©a_off£t
 -Ñdev->
d©a_off£t
);

5945 i‡(
fú°
) {

5946 
mö_off£t_diff
 = 
diff
;

5947 
fú°
 = 0;

5948 } i‡(
mddev
->
ªsh≠e_backw¨ds
 &&

5949 
diff
 < 
mö_off£t_diff
)

5950 
mö_off£t_diff
 = 
diff
;

5951 i‡(!
mddev
->
ªsh≠e_backw¨ds
 &&

5952 
diff
 > 
mö_off£t_diff
)

5953 
mö_off£t_diff
 = 
diff
;

5956 i‡(
mddev
->
ªsh≠e_posôi⁄
 !
MaxSe˘‹
) {

5969 
£˘‹_t
 
hîe_√w
, 
hîe_ﬁd
;

5970 
ﬁd_disks
;

5971 
max_degøded
 = (
mddev
->
Àvñ
 == 6 ? 2 : 1);

5973 i‡(
mddev
->
√w_Àvñ
 !mddev->
Àvñ
) {

5974 
	`¥ötk
(
KERN_ERR
 "md/raid:%s: unsupportedÑeshape "

5976 
	`md«me
(
mddev
));

5977  -
EINVAL
;

5979 
ﬁd_disks
 = 
mddev
->
øid_disks
 - mddev->
dñè_disks
;

5984 
hîe_√w
 = 
mddev
->
ªsh≠e_posôi⁄
;

5985 i‡(
	`£˘‹_div
(
hîe_√w
, 
mddev
->
√w_chunk_£˘‹s
 *

5986 (
mddev
->
øid_disks
 - 
max_degøded
))) {

5987 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:Ñeshape_positionÇot "

5988 "⁄á såùêbound¨y\n", 
	`md«me
(
mddev
));

5989  -
EINVAL
;

5991 
ªsh≠e_off£t
 = 
hîe_√w
 * 
mddev
->
√w_chunk_£˘‹s
;

5993 
hîe_ﬁd
 = 
mddev
->
ªsh≠e_posôi⁄
;

5994 
	`£˘‹_div
(
hîe_ﬁd
, 
mddev
->
chunk_£˘‹s
 *

5995 (
ﬁd_disks
-
max_degøded
));

5998 i‡(
mddev
->
dñè_disks
 == 0) {

5999 i‡((
hîe_√w
 * 
mddev
->
√w_chunk_£˘‹s
 !=

6000 
hîe_ﬁd
 * 
mddev
->
chunk_£˘‹s
)) {

6001 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:ÑeshapeÖosition is"

6002 " c⁄fu£d -áb‹tög\n", 
	`md«me
(
mddev
));

6003  -
EINVAL
;

6012 i‡(
	`abs
(
mö_off£t_diff
Ë>
mddev
->
chunk_£˘‹s
 &&

6013 
	`abs
(
mö_off£t_diff
Ë>
mddev
->
√w_chunk_£˘‹s
)

6015 i‡(
mddev
->
ro
 == 0) {

6016 
	`¥ötk
(
KERN_ERR
 "md/raid:%s: in-placeÑeshape "

6019 
	`md«me
(
mddev
));

6020  -
EINVAL
;

6022 } i‡(
mddev
->
ªsh≠e_backw¨ds


6023 ? (
hîe_√w
 * 
mddev
->
√w_chunk_£˘‹s
 + 
mö_off£t_diff
 <=

6024 
hîe_ﬁd
 * 
mddev
->
chunk_£˘‹s
)

6025 : (
hîe_√w
 * 
mddev
->
√w_chunk_£˘‹s
 >=

6026 
hîe_ﬁd
 * 
mddev
->
chunk_£˘‹s
 + (-
mö_off£t_diff
))) {

6028 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:Ñeshape_positionÅooÉarly for "

6030 
	`md«me
(
mddev
));

6031  -
EINVAL
;

6033 
	`¥ötk
(
KERN_INFO
 "md/raid:%s:Ñeshape will continue\n",

6034 
	`md«me
(
mddev
));

6037 
	`BUG_ON
(
mddev
->
Àvñ
 !mddev->
√w_Àvñ
);

6038 
	`BUG_ON
(
mddev
->
œyout
 !mddev->
√w_œyout
);

6039 
	`BUG_ON
(
mddev
->
chunk_£˘‹s
 !mddev->
√w_chunk_£˘‹s
);

6040 
	`BUG_ON
(
mddev
->
dñè_disks
 != 0);

6043 i‡(
mddev
->
¥iv©e
 =
NULL
)

6044 
c⁄f
 = 
	`£tup_c⁄f
(
mddev
);

6046 
c⁄f
 = 
mddev
->
¥iv©e
;

6048 i‡(
	`IS_ERR
(
c⁄f
))

6049  
	`PTR_ERR
(
c⁄f
);

6051 
c⁄f
->
mö_off£t_diff
 = min_offset_diff;

6052 
mddev
->
thªad
 = 
c⁄f
->thread;

6053 
c⁄f
->
thªad
 = 
NULL
;

6054 
mddev
->
¥iv©e
 = 
c⁄f
;

6056 
i
 = 0; i < 
c⁄f
->
øid_disks
 && c⁄f->
¥evious_øid_disks
;

6057 
i
++) {

6058 
rdev
 = 
c⁄f
->
disks
[
i
].rdev;

6059 i‡(!
rdev
 && 
c⁄f
->
disks
[
i
].
ª∂a˚mít
) {

6061 
rdev
 = 
c⁄f
->
disks
[
i
].
ª∂a˚mít
;

6062 
c⁄f
->
disks
[
i
].
ª∂a˚mít
 = 
NULL
;

6063 
	`˛ór_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

6064 
c⁄f
->
disks
[
i
].
rdev
 =Ñdev;

6066 i‡(!
rdev
)

6068 i‡(
c⁄f
->
disks
[
i
].
ª∂a˚mít
 &&

6069 
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

6071 
	`¥ötk
(
KERN_ERR
 "md: cannot handle concurrent "

6073 
ab‹t
;

6075 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)) {

6076 
w‹kög_disks
++;

6088 i‡(
mddev
->
maj‹_vîsi⁄
 == 0 &&

6089 
mddev
->
mö‹_vîsi⁄
 > 90)

6090 
rdev
->
ªcovîy_off£t
 = 
ªsh≠e_off£t
;

6092 i‡(
rdev
->
ªcovîy_off£t
 < 
ªsh≠e_off£t
) {

6094 i‡(!
	`⁄ly_∑rôy
(
rdev
->
øid_disk
,

6095 
c⁄f
->
Æg‹ôhm
,

6096 
c⁄f
->
øid_disks
,

6097 
c⁄f
->
max_degøded
))

6100 i‡(!
	`⁄ly_∑rôy
(
rdev
->
øid_disk
,

6101 
c⁄f
->
¥ev_Ægo
,

6102 
c⁄f
->
¥evious_øid_disks
,

6103 
c⁄f
->
max_degøded
))

6105 
dúty_∑rôy_disks
++;

6111 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

6113 i‡(
	`has_Áûed
(
c⁄f
)) {

6114 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:ÇotÉnough operational devices"

6116 
	`md«me
(
mddev
), mddev->
degøded
, 
c⁄f
->
øid_disks
);

6117 
ab‹t
;

6121 
mddev
->
dev_£˘‹s
 &~(mddev->
chunk_£˘‹s
 - 1);

6122 
mddev
->
ªsync_max_£˘‹s
 = mddev->
dev_£˘‹s
;

6124 i‡(
mddev
->
degøded
 > 
dúty_∑rôy_disks
 &&

6125 
mddev
->
ªcovîy_˝
 !
MaxSe˘‹
) {

6126 i‡(
mddev
->
ok_°¨t_degøded
)

6127 
	`¥ötk
(
KERN_WARNING


6130 
	`md«me
(
mddev
));

6132 
	`¥ötk
(
KERN_ERR


6134 
	`md«me
(
mddev
));

6135 
ab‹t
;

6139 i‡(
mddev
->
degøded
 == 0)

6140 
	`¥ötk
(
KERN_INFO
 "md/raid:%s:ÑaidÜevel %dáctive with %d out of %d"

6141 " devi˚s,álg‹ôhm %d\n", 
	`md«me
(
mddev
), 
c⁄f
->
Àvñ
,

6142 
mddev
->
øid_disks
-mddev->
degøded
, mddev->raid_disks,

6143 
mddev
->
√w_œyout
);

6145 
	`¥ötk
(
KERN_ALERT
 "md/raid:%s:ÑaidÜevel %dáctive with %d"

6147 
	`md«me
(
mddev
), 
c⁄f
->
Àvñ
,

6148 
mddev
->
øid_disks
 - mddev->
degøded
,

6149 
mddev
->
øid_disks
, mddev->
√w_œyout
);

6151 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6153 i‡(
c⁄f
->
ªsh≠e_¥ogªss
 !
MaxSe˘‹
) {

6154 
c⁄f
->
ªsh≠e_ß„
 = c⁄f->
ªsh≠e_¥ogªss
;

6155 
	`©omic_£t
(&
c⁄f
->
ªsh≠e_°rùes
, 0);

6156 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

6157 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

6158 
	`£t_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

6159 
	`£t_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

6160 
mddev
->
sync_thªad
 = 
	`md_ªgi°î_thªad
(
md_do_sync
, mddev,

6166 i‡(
mddev
->
to_ªmove
 =&
øid5_©ås_group
)

6167 
mddev
->
to_ªmove
 = 
NULL
;

6168 i‡(
mddev
->
kobj
.
sd
 &&

6169 
	`sysfs_¸óã_group
(&
mddev
->
kobj
, &
øid5_©ås_group
))

6170 
	`¥ötk
(
KERN_WARNING


6172 
	`md«me
(
mddev
));

6173 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`øid5_size
(mddev, 0, 0));

6175 i‡(
mddev
->
queue
) {

6176 
chunk_size
;

6177 
boﬁ
 
disˇrd_suµ‹ãd
 = 
åue
;

6182 
d©a_disks
 = 
c⁄f
->
¥evious_øid_disks
 - c⁄f->
max_degøded
;

6183 
°rùe
 = 
d©a_disks
 *

6184 ((
mddev
->
chunk_£˘‹s
 << 9Ë/ 
PAGE_SIZE
);

6185 i‡(
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 < 2 * 
°rùe
)

6186 
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 = 2 * 
°rùe
;

6188 
	`blk_queue_mîge_bvec
(
mddev
->
queue
, 
øid5_mîgóbÀ_bvec
);

6190 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_d©a
 = mddev;

6191 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
øid5_c⁄ge°ed
;

6193 
chunk_size
 = 
mddev
->
chunk_£˘‹s
 << 9;

6194 
	`blk_queue_io_mö
(
mddev
->
queue
, 
chunk_size
);

6195 
	`blk_queue_io_›t
(
mddev
->
queue
, 
chunk_size
 *

6196 (
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
));

6197 
mddev
->
queue
->
limôs
.
øid_∑πül_°rùes_ex≥nsive
 = 1;

6202 
°rùe
 = såùê* 
PAGE_SIZE
;

6205 (
°rùe
-1) & stripe)

6206 
°rùe
 = (stripe | (stripe-1)) + 1;

6207 
mddev
->
queue
->
limôs
.
disˇrd_Æignmít
 = 
°rùe
;

6208 
mddev
->
queue
->
limôs
.
disˇrd_gønuœrôy
 = 
°rùe
;

6213 
mddev
->
queue
->
limôs
.
disˇrd_zî€s_d©a
 = 0;

6215 
	`blk_queue_max_wrôe_ßme_£˘‹s
(
mddev
->
queue
, 0);

6217 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

6218 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

6219 
rdev
->
d©a_off£t
 << 9);

6220 
	`disk_°ack_limôs
(
mddev
->
gídisk
, 
rdev
->
bdev
,

6221 
rdev
->
√w_d©a_off£t
 << 9);

6232 i‡(!
	`blk_queue_disˇrd
(
	`bdev_gë_queue
(
rdev
->
bdev
)) ||

6233 !
	`bdev_gë_queue
(
rdev
->
bdev
)->

6234 
limôs
.
disˇrd_zî€s_d©a
)

6235 
disˇrd_suµ‹ãd
 = 
Ál£
;

6238 i‡(
disˇrd_suµ‹ãd
 &&

6239 
mddev
->
queue
->
limôs
.
max_disˇrd_£˘‹s
 >
°rùe
 &&

6240 
mddev
->
queue
->
limôs
.
disˇrd_gønuœrôy
 >
°rùe
)

6241 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
,

6242 
mddev
->
queue
);

6244 
	`queue_Êag_˛ór_u∆ocked
(
QUEUE_FLAG_DISCARD
,

6245 
mddev
->
queue
);

6249 
ab‹t
:

6250 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

6251 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6252 
	`‰ì_c⁄f
(
c⁄f
);

6253 
mddev
->
¥iv©e
 = 
NULL
;

6254 
	`¥ötk
(
KERN_ALERT
 "md/øid:%s: faûedÅÿru¿øid së.\n", 
	`md«me
(
mddev
));

6255  -
EIO
;

6256 
	}
}

6258 
	$°›
(
mddev
 *mddev)

6260 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6262 
	`md_uƒegi°î_thªad
(&
mddev
->
thªad
);

6263 i‡(
mddev
->
queue
)

6264 
mddev
->
queue
->
backög_dev_öfo
.
c⁄ge°ed_‚
 = 
NULL
;

6265 
	`‰ì_c⁄f
(
c⁄f
);

6266 
mddev
->
¥iv©e
 = 
NULL
;

6267 
mddev
->
to_ªmove
 = &
øid5_©ås_group
;

6269 
	}
}

6271 
	$°©us
(
£q_fûe
 *
£q
, 
mddev
 *mddev)

6273 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6274 
i
;

6276 
	`£q_¥ötf
(
£q
, "Üevñ %d, %dk chunk,álg‹ôhm %d", 
mddev
->
Àvñ
,

6277 
mddev
->
chunk_£˘‹s
 / 2, mddev->
œyout
);

6278 
	`£q_¥ötf
 (
£q
, " [%d/%d] [", 
c⁄f
->
øid_disks
, c⁄f->øid_disk†- 
mddev
->
degøded
);

6279 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++)

6280 
	`£q_¥ötf
 (
£q
, "%s",

6281 
c⁄f
->
disks
[
i
].
rdev
 &&

6282 
	`ã°_bô
(
In_sync
, &
c⁄f
->
disks
[
i
].
rdev
->
Êags
) ? "U" : "_");

6283 
	`£q_¥ötf
 (
£q
, "]");

6284 
	}
}

6286 
	$¥öt_øid5_c⁄f
 (
r5c⁄f
 *
c⁄f
)

6288 
i
;

6289 
disk_öfo
 *
tmp
;

6291 
	`¥ötk
(
KERN_DEBUG
 "RAID confÖrintout:\n");

6292 i‡(!
c⁄f
) {

6293 
	`¥ötk
("(conf==NULL)\n");

6296 
	`¥ötk
(
KERN_DEBUG
 " ---Üevñ:%dÑd:%d wd:%d\n", 
c⁄f
->
Àvñ
,

6297 
c⁄f
->
øid_disks
,

6298 
c⁄f
->
øid_disks
 - c⁄f->
mddev
->
degøded
);

6300 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

6301 
b
[
BDEVNAME_SIZE
];

6302 
tmp
 = 
c⁄f
->
disks
 + 
i
;

6303 i‡(
tmp
->
rdev
)

6304 
	`¥ötk
(
KERN_DEBUG
 " disk %d, o:%d, dev:%s\n",

6305 
i
, !
	`ã°_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
),

6306 
	`bdev«me
(
tmp
->
rdev
->
bdev
, 
b
));

6308 
	}
}

6310 
	$øid5_•¨e_a˘ive
(
mddev
 *mddev)

6312 
i
;

6313 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6314 
disk_öfo
 *
tmp
;

6315 
cou¡
 = 0;

6316 
Êags
;

6318 
i
 = 0; i < 
c⁄f
->
øid_disks
; i++) {

6319 
tmp
 = 
c⁄f
->
disks
 + 
i
;

6320 i‡(
tmp
->
ª∂a˚mít


6321 && 
tmp
->
ª∂a˚mít
->
ªcovîy_off£t
 =
MaxSe˘‹


6322 && !
	`ã°_bô
(
Fau…y
, &
tmp
->
ª∂a˚mít
->
Êags
)

6323 && !
	`ã°_™d_£t_bô
(
In_sync
, &
tmp
->
ª∂a˚mít
->
Êags
)) {

6325 i‡(!
tmp
->
rdev


6326 || !
	`ã°_™d_˛ór_bô
(
In_sync
, &
tmp
->
rdev
->
Êags
))

6327 
cou¡
++;

6328 i‡(
tmp
->
rdev
) {

6333 
	`£t_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
);

6334 
	`sysfs_nŸify_dúít_ß„
(

6335 
tmp
->
rdev
->
sysfs_°©e
);

6337 
	`sysfs_nŸify_dúít_ß„
(
tmp
->
ª∂a˚mít
->
sysfs_°©e
);

6338 } i‡(
tmp
->
rdev


6339 && 
tmp
->
rdev
->
ªcovîy_off£t
 =
MaxSe˘‹


6340 && !
	`ã°_bô
(
Fau…y
, &
tmp
->
rdev
->
Êags
)

6341 && !
	`ã°_™d_£t_bô
(
In_sync
, &
tmp
->
rdev
->
Êags
)) {

6342 
cou¡
++;

6343 
	`sysfs_nŸify_dúít_ß„
(
tmp
->
rdev
->
sysfs_°©e
);

6346 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

6347 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

6348 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

6349 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6350  
cou¡
;

6351 
	}
}

6353 
	$øid5_ªmove_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

6355 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6356 
îr
 = 0;

6357 
numbî
 = 
rdev
->
øid_disk
;

6358 
md_rdev
 **
rdevp
;

6359 
disk_öfo
 *
p
 = 
c⁄f
->
disks
 + 
numbî
;

6361 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6362 i‡(
rdev
 =
p
->rdev)

6363 
rdevp
 = &
p
->
rdev
;

6364 i‡(
rdev
 =
p
->
ª∂a˚mít
)

6365 
rdevp
 = &
p
->
ª∂a˚mít
;

6369 i‡(
numbî
 >
c⁄f
->
øid_disks
 &&

6370 
c⁄f
->
ªsh≠e_¥ogªss
 =
MaxSe˘‹
)

6371 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

6373 i‡(
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
) ||

6374 
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

6375 
îr
 = -
EBUSY
;

6376 
ab‹t
;

6381 i‡(!
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
) &&

6382 
mddev
->
ªcovîy_dißbÀd
 !
c⁄f
->recovery_disabled &&

6383 !
	`has_Áûed
(
c⁄f
) &&

6384 (!
p
->
ª∂a˚mít
 ||Ö->ª∂a˚míà=
rdev
) &&

6385 
numbî
 < 
c⁄f
->
øid_disks
) {

6386 
îr
 = -
EBUSY
;

6387 
ab‹t
;

6389 *
rdevp
 = 
NULL
;

6390 
	`synchr⁄ize_rcu
();

6391 i‡(
	`©omic_ªad
(&
rdev
->
ƒ_≥ndög
)) {

6393 
îr
 = -
EBUSY
;

6394 *
rdevp
 = 
rdev
;

6395 } i‡(
p
->
ª∂a˚mít
) {

6397 
p
->
rdev
 =Ö->
ª∂a˚mít
;

6398 
	`˛ór_bô
(
Rïœ˚mít
, &
p
->
ª∂a˚mít
->
Êags
);

6399 
	`smp_mb
();

6402 
p
->
ª∂a˚mít
 = 
NULL
;

6403 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

6408 
	`˛ór_bô
(
W™tRïœ˚mít
, &
rdev
->
Êags
);

6409 
ab‹t
:

6411 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6412  
îr
;

6413 
	}
}

6415 
	$øid5_add_disk
(
mddev
 *mddev, 
md_rdev
 *
rdev
)

6417 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6418 
îr
 = -
EEXIST
;

6419 
disk
;

6420 
disk_öfo
 *
p
;

6421 
fú°
 = 0;

6422 
œ°
 = 
c⁄f
->
øid_disks
 - 1;

6424 i‡(
mddev
->
ªcovîy_dißbÀd
 =
c⁄f
->recovery_disabled)

6425  -
EBUSY
;

6427 i‡(
rdev
->
ßved_øid_disk
 < 0 && 
	`has_Áûed
(
c⁄f
))

6429  -
EINVAL
;

6431 i‡(
rdev
->
øid_disk
 >= 0)

6432 
fú°
 = 
œ°
 = 
rdev
->
øid_disk
;

6438 i‡(
rdev
->
ßved_øid_disk
 >= 0 &&

6439 
rdev
->
ßved_øid_disk
 >
fú°
 &&

6440 
c⁄f
->
disks
[
rdev
->
ßved_øid_disk
].rdev =
NULL
)

6441 
fú°
 = 
rdev
->
ßved_øid_disk
;

6443 
disk
 = 
fú°
; disk <
œ°
; disk++) {

6444 
p
 = 
c⁄f
->
disks
 + 
disk
;

6445 i‡(
p
->
rdev
 =
NULL
) {

6446 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

6447 
rdev
->
øid_disk
 = 
disk
;

6448 
îr
 = 0;

6449 i‡(
rdev
->
ßved_øid_disk
 !
disk
)

6450 
c⁄f
->
fuŒsync
 = 1;

6451 
	`rcu_assign_poöãr
(
p
->
rdev
,Ñdev);

6452 
out
;

6455 
disk
 = 
fú°
; disk <
œ°
; disk++) {

6456 
p
 = 
c⁄f
->
disks
 + 
disk
;

6457 i‡(
	`ã°_bô
(
W™tRïœ˚mít
, &
p
->
rdev
->
Êags
) &&

6458 
p
->
ª∂a˚mít
 =
NULL
) {

6459 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

6460 
	`£t_bô
(
Rïœ˚mít
, &
rdev
->
Êags
);

6461 
rdev
->
øid_disk
 = 
disk
;

6462 
îr
 = 0;

6463 
c⁄f
->
fuŒsync
 = 1;

6464 
	`rcu_assign_poöãr
(
p
->
ª∂a˚mít
, 
rdev
);

6468 
out
:

6469 
	`¥öt_øid5_c⁄f
(
c⁄f
);

6470  
îr
;

6471 
	}
}

6473 
	$øid5_ªsize
(
mddev
 *mddev, 
£˘‹_t
 
£˘‹s
)

6482 
£˘‹_t
 
√wsize
;

6483 
£˘‹s
 &~((
£˘‹_t
)
mddev
->
chunk_£˘‹s
 - 1);

6484 
√wsize
 = 
	`øid5_size
(
mddev
, 
£˘‹s
, mddev->
øid_disks
);

6485 i‡(
mddev
->
exã∫Æ_size
 &&

6486 
mddev
->
¨øy_£˘‹s
 > 
√wsize
)

6487  -
EINVAL
;

6488 i‡(
mddev
->
bôm≠
) {

6489 
ªt
 = 
	`bôm≠_ªsize
(
mddev
->
bôm≠
, 
£˘‹s
, 0, 0);

6490 i‡(
ªt
)

6491  
ªt
;

6493 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
√wsize
);

6494 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

6495 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

6496 i‡(
£˘‹s
 > 
mddev
->
dev_£˘‹s
 &&

6497 
mddev
->
ªcovîy_˝
 > mddev->
dev_£˘‹s
) {

6498 
mddev
->
ªcovîy_˝
 = mddev->
dev_£˘‹s
;

6499 
	`£t_bô
(
MD_RECOVERY_NEEDED
, &
mddev
->
ªcovîy
);

6501 
mddev
->
dev_£˘‹s
 = 
£˘‹s
;

6502 
mddev
->
ªsync_max_£˘‹s
 = 
£˘‹s
;

6504 
	}
}

6506 
	$check_°rùe_ˇche
(
mddev
 *mddev)

6516 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6517 i‡(((
mddev
->
chunk_£˘‹s
 << 9Ë/ 
STRIPE_SIZE
) * 4

6518 > 
c⁄f
->
max_ƒ_°rùes
 ||

6519 ((
mddev
->
√w_chunk_£˘‹s
 << 9Ë/ 
STRIPE_SIZE
) * 4

6520 > 
c⁄f
->
max_ƒ_°rùes
) {

6521 
	`¥ötk
(
KERN_WARNING
 "md/raid:%s:Ñeshape:ÇotÉnough stripes. Needed %lu\n",

6522 
	`md«me
(
mddev
),

6523 ((
	`max
(
mddev
->
chunk_£˘‹s
, mddev->
√w_chunk_£˘‹s
) << 9)

6524 / 
STRIPE_SIZE
)*4);

6528 
	}
}

6530 
	$check_ªsh≠e
(
mddev
 *mddev)

6532 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6534 i‡(
mddev
->
dñè_disks
 == 0 &&

6535 
mddev
->
√w_œyout
 =mddev->
œyout
 &&

6536 
mddev
->
√w_chunk_£˘‹s
 =mddev->
chunk_£˘‹s
)

6538 i‡(
	`has_Áûed
(
c⁄f
))

6539  -
EINVAL
;

6540 i‡(
mddev
->
dñè_disks
 < 0 && mddev->
ªsh≠e_posôi⁄
 =
MaxSe˘‹
) {

6546 
mö
 = 2;

6547 i‡(
mddev
->
Àvñ
 == 6)

6548 
mö
 = 4;

6549 i‡(
mddev
->
øid_disks
 + mddev->
dñè_disks
 < 
mö
)

6550  -
EINVAL
;

6553 i‡(!
	`check_°rùe_ˇche
(
mddev
))

6554  -
ENOSPC
;

6556  
	`ªsize_°rùes
(
c⁄f
, (c⁄f->
¥evious_øid_disks


6557 + 
mddev
->
dñè_disks
));

6558 
	}
}

6560 
	$øid5_°¨t_ªsh≠e
(
mddev
 *mddev)

6562 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6563 
md_rdev
 *
rdev
;

6564 
•¨es
 = 0;

6565 
Êags
;

6567 i‡(
	`ã°_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
))

6568  -
EBUSY
;

6570 i‡(!
	`check_°rùe_ˇche
(
mddev
))

6571  -
ENOSPC
;

6573 i‡(
	`has_Áûed
(
c⁄f
))

6574  -
EINVAL
;

6576 
	`rdev_f‹_óch
(
rdev
, 
mddev
) {

6577 i‡(!
	`ã°_bô
(
In_sync
, &
rdev
->
Êags
)

6578 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
))

6579 
•¨es
++;

6582 i‡(
•¨es
 - 
mddev
->
degøded
 < mddev->
dñè_disks
 - 
c⁄f
->
max_degøded
)

6586  -
EINVAL
;

6592 i‡(
	`øid5_size
(
mddev
, 0, 
c⁄f
->
øid_disks
 + mddev->
dñè_disks
)

6593 < 
mddev
->
¨øy_£˘‹s
) {

6594 
	`¥ötk
(
KERN_ERR
 "md/raid:%s:árray size must beÑeduced "

6595 "bef‹ênumbî o‡disks\n", 
	`md«me
(
mddev
));

6596  -
EINVAL
;

6599 
	`©omic_£t
(&
c⁄f
->
ªsh≠e_°rùes
, 0);

6600 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

6601 
	`wrôe_£qcou¡_begö
(&
c⁄f
->
gí_lock
);

6602 
c⁄f
->
¥evious_øid_disks
 = c⁄f->
øid_disks
;

6603 
c⁄f
->
øid_disks
 +
mddev
->
dñè_disks
;

6604 
c⁄f
->
¥ev_chunk_£˘‹s
 = c⁄f->
chunk_£˘‹s
;

6605 
c⁄f
->
chunk_£˘‹s
 = 
mddev
->
√w_chunk_£˘‹s
;

6606 
c⁄f
->
¥ev_Ægo
 = c⁄f->
Æg‹ôhm
;

6607 
c⁄f
->
Æg‹ôhm
 = 
mddev
->
√w_œyout
;

6608 
c⁄f
->
gíî©i⁄
++;

6612 
	`smp_mb
();

6613 i‡(
mddev
->
ªsh≠e_backw¨ds
)

6614 
c⁄f
->
ªsh≠e_¥ogªss
 = 
	`øid5_size
(
mddev
, 0, 0);

6616 
c⁄f
->
ªsh≠e_¥ogªss
 = 0;

6617 
c⁄f
->
ªsh≠e_ß„
 = c⁄f->
ªsh≠e_¥ogªss
;

6618 
	`wrôe_£qcou¡_íd
(&
c⁄f
->
gí_lock
);

6619 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

6625 
	`mddev_su•íd
(
mddev
);

6626 
	`mddev_ªsume
(
mddev
);

6635 i‡(
mddev
->
dñè_disks
 >= 0) {

6636 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

6637 i‡(
rdev
->
øid_disk
 < 0 &&

6638 !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

6639 i‡(
	`øid5_add_disk
(
mddev
, 
rdev
) == 0) {

6640 i‡(
rdev
->
øid_disk


6641 >
c⁄f
->
¥evious_øid_disks
)

6642 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

6644 
rdev
->
ªcovîy_off£t
 = 0;

6646 i‡(
	`sysfs_lök_rdev
(
mddev
, 
rdev
))

6649 } i‡(
rdev
->
øid_disk
 >
c⁄f
->
¥evious_øid_disks


6650 && !
	`ã°_bô
(
Fau…y
, &
rdev
->
Êags
)) {

6652 
	`£t_bô
(
In_sync
, &
rdev
->
Êags
);

6659 
	`•ö_lock_úqßve
(&
c⁄f
->
devi˚_lock
, 
Êags
);

6660 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

6661 
	`•ö_u∆ock_úqª°‹e
(&
c⁄f
->
devi˚_lock
, 
Êags
);

6663 
mddev
->
øid_disks
 = 
c⁄f
->raid_disks;

6664 
mddev
->
ªsh≠e_posôi⁄
 = 
c⁄f
->
ªsh≠e_¥ogªss
;

6665 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

6667 
	`˛ór_bô
(
MD_RECOVERY_SYNC
, &
mddev
->
ªcovîy
);

6668 
	`˛ór_bô
(
MD_RECOVERY_CHECK
, &
mddev
->
ªcovîy
);

6669 
	`£t_bô
(
MD_RECOVERY_RESHAPE
, &
mddev
->
ªcovîy
);

6670 
	`£t_bô
(
MD_RECOVERY_RUNNING
, &
mddev
->
ªcovîy
);

6671 
mddev
->
sync_thªad
 = 
	`md_ªgi°î_thªad
(
md_do_sync
, mddev,

6673 i‡(!
mddev
->
sync_thªad
) {

6674 
mddev
->
ªcovîy
 = 0;

6675 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

6676 
	`wrôe_£qcou¡_begö
(&
c⁄f
->
gí_lock
);

6677 
mddev
->
øid_disks
 = 
c⁄f
->øid_disk†c⁄f->
¥evious_øid_disks
;

6678 
mddev
->
√w_chunk_£˘‹s
 =

6679 
c⁄f
->
chunk_£˘‹s
 = c⁄f->
¥ev_chunk_£˘‹s
;

6680 
mddev
->
√w_œyout
 = 
c⁄f
->
Æg‹ôhm
 = c⁄f->
¥ev_Ægo
;

6681 
	`rdev_f‹_óch
(
rdev
, 
mddev
)

6682 
rdev
->
√w_d©a_off£t
 =Ñdev->
d©a_off£t
;

6683 
	`smp_wmb
();

6684 
c⁄f
->
gíî©i⁄
 --;

6685 
c⁄f
->
ªsh≠e_¥ogªss
 = 
MaxSe˘‹
;

6686 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

6687 
	`wrôe_£qcou¡_íd
(&
c⁄f
->
gí_lock
);

6688 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

6689  -
EAGAIN
;

6691 
c⁄f
->
ªsh≠e_checkpoöt
 = 
jiffõs
;

6692 
	`md_wakeup_thªad
(
mddev
->
sync_thªad
);

6693 
	`md_√w_evít
(
mddev
);

6695 
	}
}

6700 
	$íd_ªsh≠e
(
r5c⁄f
 *
c⁄f
)

6703 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
c⁄f
->
mddev
->
ªcovîy
)) {

6704 
md_rdev
 *
rdev
;

6706 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

6707 
c⁄f
->
¥evious_øid_disks
 = c⁄f->
øid_disks
;

6708 
	`rdev_f‹_óch
(
rdev
, 
c⁄f
->
mddev
)

6709 
rdev
->
d©a_off£t
 =Ñdev->
√w_d©a_off£t
;

6710 
	`smp_wmb
();

6711 
c⁄f
->
ªsh≠e_¥ogªss
 = 
MaxSe˘‹
;

6712 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

6713 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

6718 i‡(
c⁄f
->
mddev
->
queue
) {

6719 
d©a_disks
 = 
c⁄f
->
øid_disks
 - c⁄f->
max_degøded
;

6720 
°rùe
 = 
d©a_disks
 * ((
c⁄f
->
chunk_£˘‹s
 << 9)

6721 / 
PAGE_SIZE
);

6722 i‡(
c⁄f
->
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 < 2 * 
°rùe
)

6723 
c⁄f
->
mddev
->
queue
->
backög_dev_öfo
.
ø_∑ges
 = 2 * 
°rùe
;

6726 
	}
}

6731 
	$øid5_föish_ªsh≠e
(
mddev
 *mddev)

6733 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6735 i‡(!
	`ã°_bô
(
MD_RECOVERY_INTR
, &
mddev
->
ªcovîy
)) {

6737 i‡(
mddev
->
dñè_disks
 > 0) {

6738 
	`md_£t_¨øy_£˘‹s
(
mddev
, 
	`øid5_size
(mddev, 0, 0));

6739 
	`£t_ˇ∑côy
(
mddev
->
gídisk
, mddev->
¨øy_£˘‹s
);

6740 
	`ªvÆid©e_disk
(
mddev
->
gídisk
);

6742 
d
;

6743 
	`•ö_lock_úq
(&
c⁄f
->
devi˚_lock
);

6744 
mddev
->
degøded
 = 
	`ˇlc_degøded
(
c⁄f
);

6745 
	`•ö_u∆ock_úq
(&
c⁄f
->
devi˚_lock
);

6746 
d
 = 
c⁄f
->
øid_disks
 ;

6747 
d
 < 
c⁄f
->
øid_disks
 - 
mddev
->
dñè_disks
;

6748 
d
++) {

6749 
md_rdev
 *
rdev
 = 
c⁄f
->
disks
[
d
].rdev;

6750 i‡(
rdev
)

6751 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

6752 
rdev
 = 
c⁄f
->
disks
[
d
].
ª∂a˚mít
;

6753 i‡(
rdev
)

6754 
	`˛ór_bô
(
In_sync
, &
rdev
->
Êags
);

6757 
mddev
->
œyout
 = 
c⁄f
->
Æg‹ôhm
;

6758 
mddev
->
chunk_£˘‹s
 = 
c⁄f
->chunk_sectors;

6759 
mddev
->
ªsh≠e_posôi⁄
 = 
MaxSe˘‹
;

6760 
mddev
->
dñè_disks
 = 0;

6761 
mddev
->
ªsh≠e_backw¨ds
 = 0;

6763 
	}
}

6765 
	$øid5_quõs˚
(
mddev
 *mddev, 
°©e
)

6767 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6769 
°©e
) {

6771 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

6775 
	`lock_Æl_devi˚_hash_locks_úq
(
c⁄f
);

6779 
c⁄f
->
quõs˚
 = 2;

6780 
	`waô_evít_cmd
(
c⁄f
->
waô_f‹_°rùe
,

6781 
	`©omic_ªad
(&
c⁄f
->
a˘ive_°rùes
) == 0 &&

6782 
	`©omic_ªad
(&
c⁄f
->
a˘ive_Æig√d_ªads
) == 0,

6783 
	`u∆ock_Æl_devi˚_hash_locks_úq
(
c⁄f
),

6784 
	`lock_Æl_devi˚_hash_locks_úq
(
c⁄f
));

6785 
c⁄f
->
quõs˚
 = 1;

6786 
	`u∆ock_Æl_devi˚_hash_locks_úq
(
c⁄f
);

6788 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

6792 
	`lock_Æl_devi˚_hash_locks_úq
(
c⁄f
);

6793 
c⁄f
->
quõs˚
 = 0;

6794 
	`wake_up
(&
c⁄f
->
waô_f‹_°rùe
);

6795 
	`wake_up
(&
c⁄f
->
waô_f‹_ovîœp
);

6796 
	`u∆ock_Æl_devi˚_hash_locks_úq
(
c⁄f
);

6799 
	}
}

6802 *
	$øid45_èkeovî_øid0
(
mddev
 *mddev, 
Àvñ
)

6804 
r0c⁄f
 *
øid0_c⁄f
 = 
mddev
->
¥iv©e
;

6805 
£˘‹_t
 
£˘‹s
;

6808 i‡(
øid0_c⁄f
->
ƒ_°rù_z⁄es
 > 1) {

6809 
	`¥ötk
(
KERN_ERR
 "md/raid:%s: cannotÅakeoverÑaid0 with moreÅhan one zone.\n",

6810 
	`md«me
(
mddev
));

6811  
	`ERR_PTR
(-
EINVAL
);

6814 
£˘‹s
 = 
øid0_c⁄f
->
°rù_z⁄e
[0].
z⁄e_íd
;

6815 
	`£˘‹_div
(
£˘‹s
, 
øid0_c⁄f
->
°rù_z⁄e
[0].
nb_dev
);

6816 
mddev
->
dev_£˘‹s
 = 
£˘‹s
;

6817 
mddev
->
√w_Àvñ
 = 
Àvñ
;

6818 
mddev
->
√w_œyout
 = 
ALGORITHM_PARITY_N
;

6819 
mddev
->
√w_chunk_£˘‹s
 = mddev->
chunk_£˘‹s
;

6820 
mddev
->
øid_disks
 += 1;

6821 
mddev
->
dñè_disks
 = 1;

6823 
mddev
->
ªcovîy_˝
 = 
MaxSe˘‹
;

6825  
	`£tup_c⁄f
(
mddev
);

6826 
	}
}

6829 *
	$øid5_èkeovî_øid1
(
mddev
 *mddev)

6831 
chunk£˘
;

6833 i‡(
mddev
->
øid_disks
 != 2 ||

6834 
mddev
->
degøded
 > 1)

6835  
	`ERR_PTR
(-
EINVAL
);

6839 
chunk£˘
 = 64*2;

6842 
chunk£˘
 && (
mddev
->
¨øy_£˘‹s
 & (chunksect-1)))

6843 
chunk£˘
 >>= 1;

6845 i‡((
chunk£˘
<<9Ë< 
STRIPE_SIZE
)

6847  
	`ERR_PTR
(-
EINVAL
);

6849 
mddev
->
√w_Àvñ
 = 5;

6850 
mddev
->
√w_œyout
 = 
ALGORITHM_LEFT_SYMMETRIC
;

6851 
mddev
->
√w_chunk_£˘‹s
 = 
chunk£˘
;

6853  
	`£tup_c⁄f
(
mddev
);

6854 
	}
}

6856 *
	$øid5_èkeovî_øid6
(
mddev
 *mddev)

6858 
√w_œyout
;

6860 
mddev
->
œyout
) {

6861 
ALGORITHM_LEFT_ASYMMETRIC_6
:

6862 
√w_œyout
 = 
ALGORITHM_LEFT_ASYMMETRIC
;

6864 
ALGORITHM_RIGHT_ASYMMETRIC_6
:

6865 
√w_œyout
 = 
ALGORITHM_RIGHT_ASYMMETRIC
;

6867 
ALGORITHM_LEFT_SYMMETRIC_6
:

6868 
√w_œyout
 = 
ALGORITHM_LEFT_SYMMETRIC
;

6870 
ALGORITHM_RIGHT_SYMMETRIC_6
:

6871 
√w_œyout
 = 
ALGORITHM_RIGHT_SYMMETRIC
;

6873 
ALGORITHM_PARITY_0_6
:

6874 
√w_œyout
 = 
ALGORITHM_PARITY_0
;

6876 
ALGORITHM_PARITY_N
:

6877 
√w_œyout
 = 
ALGORITHM_PARITY_N
;

6880  
	`ERR_PTR
(-
EINVAL
);

6882 
mddev
->
√w_Àvñ
 = 5;

6883 
mddev
->
√w_œyout
 =Çew_layout;

6884 
mddev
->
dñè_disks
 = -1;

6885 
mddev
->
øid_disks
 -= 1;

6886  
	`£tup_c⁄f
(
mddev
);

6887 
	}
}

6890 
	$øid5_check_ªsh≠e
(
mddev
 *mddev)

6897 
r5c⁄f
 *
c⁄f
 = 
mddev
->
¥iv©e
;

6898 
√w_chunk
 = 
mddev
->
√w_chunk_£˘‹s
;

6900 i‡(
mddev
->
√w_œyout
 >0 && !
	`Æg‹ôhm_vÆid_øid5
(mddev->new_layout))

6901  -
EINVAL
;

6902 i‡(
√w_chunk
 > 0) {

6903 i‡(!
	`is_powî_of_2
(
√w_chunk
))

6904  -
EINVAL
;

6905 i‡(
√w_chunk
 < (
PAGE_SIZE
>>9))

6906  -
EINVAL
;

6907 i‡(
mddev
->
¨øy_£˘‹s
 & (
√w_chunk
-1))

6909  -
EINVAL
;

6914 i‡(
mddev
->
øid_disks
 == 2) {

6916 i‡(
mddev
->
√w_œyout
 >= 0) {

6917 
c⁄f
->
Æg‹ôhm
 = 
mddev
->
√w_œyout
;

6918 
mddev
->
œyout
 = mddev->
√w_œyout
;

6920 i‡(
√w_chunk
 > 0) {

6921 
c⁄f
->
chunk_£˘‹s
 = 
√w_chunk
 ;

6922 
mddev
->
chunk_£˘‹s
 = 
√w_chunk
;

6924 
	`£t_bô
(
MD_CHANGE_DEVS
, &
mddev
->
Êags
);

6925 
	`md_wakeup_thªad
(
mddev
->
thªad
);

6927  
	`check_ªsh≠e
(
mddev
);

6928 
	}
}

6930 
	$øid6_check_ªsh≠e
(
mddev
 *mddev)

6932 
√w_chunk
 = 
mddev
->
√w_chunk_£˘‹s
;

6934 i‡(
mddev
->
√w_œyout
 >0 && !
	`Æg‹ôhm_vÆid_øid6
(mddev->new_layout))

6935  -
EINVAL
;

6936 i‡(
√w_chunk
 > 0) {

6937 i‡(!
	`is_powî_of_2
(
√w_chunk
))

6938  -
EINVAL
;

6939 i‡(
√w_chunk
 < (
PAGE_SIZE
 >> 9))

6940  -
EINVAL
;

6941 i‡(
mddev
->
¨øy_£˘‹s
 & (
√w_chunk
-1))

6943  -
EINVAL
;

6947  
	`check_ªsh≠e
(
mddev
);

6948 
	}
}

6950 *
	$øid5_èkeovî
(
mddev
 *mddev)

6958 i‡(
mddev
->
Àvñ
 == 0)

6959  
	`øid45_èkeovî_øid0
(
mddev
, 5);

6960 i‡(
mddev
->
Àvñ
 == 1)

6961  
	`øid5_èkeovî_øid1
(
mddev
);

6962 i‡(
mddev
->
Àvñ
 == 4) {

6963 
mddev
->
√w_œyout
 = 
ALGORITHM_PARITY_N
;

6964 
mddev
->
√w_Àvñ
 = 5;

6965  
	`£tup_c⁄f
(
mddev
);

6967 i‡(
mddev
->
Àvñ
 == 6)

6968  
	`øid5_èkeovî_øid6
(
mddev
);

6970  
	`ERR_PTR
(-
EINVAL
);

6971 
	}
}

6973 *
	$øid4_èkeovî
(
mddev
 *mddev)

6979 i‡(
mddev
->
Àvñ
 == 0)

6980  
	`øid45_èkeovî_øid0
(
mddev
, 4);

6981 i‡(
mddev
->
Àvñ
 == 5 &&

6982 
mddev
->
œyout
 =
ALGORITHM_PARITY_N
) {

6983 
mddev
->
√w_œyout
 = 0;

6984 
mddev
->
√w_Àvñ
 = 4;

6985  
	`£tup_c⁄f
(
mddev
);

6987  
	`ERR_PTR
(-
EINVAL
);

6988 
	}
}

6990 
md_≥rs⁄Æôy
 
	gøid5_≥rs⁄Æôy
;

6992 *
	$øid6_èkeovî
(
mddev
 *mddev)

6998 
√w_œyout
;

7000 i‡(
mddev
->
≥rs
 !&
øid5_≥rs⁄Æôy
)

7001  
	`ERR_PTR
(-
EINVAL
);

7002 i‡(
mddev
->
degøded
 > 1)

7003  
	`ERR_PTR
(-
EINVAL
);

7004 i‡(
mddev
->
øid_disks
 > 253)

7005  
	`ERR_PTR
(-
EINVAL
);

7006 i‡(
mddev
->
øid_disks
 < 3)

7007  
	`ERR_PTR
(-
EINVAL
);

7009 
mddev
->
œyout
) {

7010 
ALGORITHM_LEFT_ASYMMETRIC
:

7011 
√w_œyout
 = 
ALGORITHM_LEFT_ASYMMETRIC_6
;

7013 
ALGORITHM_RIGHT_ASYMMETRIC
:

7014 
√w_œyout
 = 
ALGORITHM_RIGHT_ASYMMETRIC_6
;

7016 
ALGORITHM_LEFT_SYMMETRIC
:

7017 
√w_œyout
 = 
ALGORITHM_LEFT_SYMMETRIC_6
;

7019 
ALGORITHM_RIGHT_SYMMETRIC
:

7020 
√w_œyout
 = 
ALGORITHM_RIGHT_SYMMETRIC_6
;

7022 
ALGORITHM_PARITY_0
:

7023 
√w_œyout
 = 
ALGORITHM_PARITY_0_6
;

7025 
ALGORITHM_PARITY_N
:

7026 
√w_œyout
 = 
ALGORITHM_PARITY_N
;

7029  
	`ERR_PTR
(-
EINVAL
);

7031 
mddev
->
√w_Àvñ
 = 6;

7032 
mddev
->
√w_œyout
 =Çew_layout;

7033 
mddev
->
dñè_disks
 = 1;

7034 
mddev
->
øid_disks
 += 1;

7035  
	`£tup_c⁄f
(
mddev
);

7036 
	}
}

7039 
md_≥rs⁄Æôy
 
	gøid6_≥rs⁄Æôy
 =

7041 .
«me
 = "raid6",

7042 .
	gÀvñ
 = 6,

7043 .
	gow√r
 = 
THIS_MODULE
,

7044 .
	gmake_ªque°
 = 
make_ªque°
,

7045 .
	grun
 = 
run
,

7046 .
	g°›
 = 
°›
,

7047 .
	g°©us
 = 
°©us
,

7048 .
	gîr‹_h™dÀr
 = 
îr‹
,

7049 .
	ghŸ_add_disk
 = 
øid5_add_disk
,

7050 .
	ghŸ_ªmove_disk

øid5_ªmove_disk
,

7051 .
	g•¨e_a˘ive
 = 
øid5_•¨e_a˘ive
,

7052 .
	gsync_ªque°
 = 
sync_ªque°
,

7053 .
	gªsize
 = 
øid5_ªsize
,

7054 .
	gsize
 = 
øid5_size
,

7055 .
	gcheck_ªsh≠e
 = 
øid6_check_ªsh≠e
,

7056 .
	g°¨t_ªsh≠e
 = 
øid5_°¨t_ªsh≠e
,

7057 .
	gföish_ªsh≠e
 = 
øid5_föish_ªsh≠e
,

7058 .
	gquõs˚
 = 
øid5_quõs˚
,

7059 .
	gèkeovî
 = 
øid6_èkeovî
,

7061 
md_≥rs⁄Æôy
 
	gøid5_≥rs⁄Æôy
 =

7063 .
«me
 = "raid5",

7064 .
	gÀvñ
 = 5,

7065 .
	gow√r
 = 
THIS_MODULE
,

7066 .
	gmake_ªque°
 = 
make_ªque°
,

7067 .
	grun
 = 
run
,

7068 .
	g°›
 = 
°›
,

7069 .
	g°©us
 = 
°©us
,

7070 .
	gîr‹_h™dÀr
 = 
îr‹
,

7071 .
	ghŸ_add_disk
 = 
øid5_add_disk
,

7072 .
	ghŸ_ªmove_disk

øid5_ªmove_disk
,

7073 .
	g•¨e_a˘ive
 = 
øid5_•¨e_a˘ive
,

7074 .
	gsync_ªque°
 = 
sync_ªque°
,

7075 .
	gªsize
 = 
øid5_ªsize
,

7076 .
	gsize
 = 
øid5_size
,

7077 .
	gcheck_ªsh≠e
 = 
øid5_check_ªsh≠e
,

7078 .
	g°¨t_ªsh≠e
 = 
øid5_°¨t_ªsh≠e
,

7079 .
	gföish_ªsh≠e
 = 
øid5_föish_ªsh≠e
,

7080 .
	gquõs˚
 = 
øid5_quõs˚
,

7081 .
	gèkeovî
 = 
øid5_èkeovî
,

7084 
md_≥rs⁄Æôy
 
	gøid4_≥rs⁄Æôy
 =

7086 .
«me
 = "raid4",

7087 .
	gÀvñ
 = 4,

7088 .
	gow√r
 = 
THIS_MODULE
,

7089 .
	gmake_ªque°
 = 
make_ªque°
,

7090 .
	grun
 = 
run
,

7091 .
	g°›
 = 
°›
,

7092 .
	g°©us
 = 
°©us
,

7093 .
	gîr‹_h™dÀr
 = 
îr‹
,

7094 .
	ghŸ_add_disk
 = 
øid5_add_disk
,

7095 .
	ghŸ_ªmove_disk

øid5_ªmove_disk
,

7096 .
	g•¨e_a˘ive
 = 
øid5_•¨e_a˘ive
,

7097 .
	gsync_ªque°
 = 
sync_ªque°
,

7098 .
	gªsize
 = 
øid5_ªsize
,

7099 .
	gsize
 = 
øid5_size
,

7100 .
	gcheck_ªsh≠e
 = 
øid5_check_ªsh≠e
,

7101 .
	g°¨t_ªsh≠e
 = 
øid5_°¨t_ªsh≠e
,

7102 .
	gföish_ªsh≠e
 = 
øid5_föish_ªsh≠e
,

7103 .
	gquõs˚
 = 
øid5_quõs˚
,

7104 .
	gèkeovî
 = 
øid4_èkeovî
,

7107 
__öô
 
	$øid5_öô
()

7109 
øid5_wq
 = 
	`Æloc_w‹kqueue
("raid5wq",

7110 
WQ_UNBOUND
|
WQ_MEM_RECLAIM
|
WQ_CPU_INTENSIVE
|
WQ_SYSFS
, 0);

7111 i‡(!
øid5_wq
)

7112  -
ENOMEM
;

7113 
	`ªgi°î_md_≥rs⁄Æôy
(&
øid6_≥rs⁄Æôy
);

7114 
	`ªgi°î_md_≥rs⁄Æôy
(&
øid5_≥rs⁄Æôy
);

7115 
	`ªgi°î_md_≥rs⁄Æôy
(&
øid4_≥rs⁄Æôy
);

7117 
	}
}

7119 
	$øid5_exô
()

7121 
	`uƒegi°î_md_≥rs⁄Æôy
(&
øid6_≥rs⁄Æôy
);

7122 
	`uƒegi°î_md_≥rs⁄Æôy
(&
øid5_≥rs⁄Æôy
);

7123 
	`uƒegi°î_md_≥rs⁄Æôy
(&
øid4_≥rs⁄Æôy
);

7124 
	`de°roy_w‹kqueue
(
øid5_wq
);

7125 
	}
}

7127 
moduÀ_öô
(
øid5_öô
);

7128 
moduÀ_exô
(
øid5_exô
);

7129 
MODULE_LICENSE
("GPL");

7130 
MODULE_DESCRIPTION
("RAID4/5/6 (striping withÖarity)Öersonality for MD");

7131 
MODULE_ALIAS
("md-personality-4");

7132 
MODULE_ALIAS
("md-raid5");

7133 
MODULE_ALIAS
("md-raid4");

7134 
MODULE_ALIAS
("md-level-5");

7135 
MODULE_ALIAS
("md-level-4");

7136 
MODULE_ALIAS
("md-personality-8");

7137 
MODULE_ALIAS
("md-raid6");

7138 
MODULE_ALIAS
("md-level-6");

7141 
MODULE_ALIAS
("raid5");

7142 
MODULE_ALIAS
("raid6");

	@raid5.h

1 #i‚de‡
_RAID5_H


2 
	#_RAID5_H


	)

4 
	~<löux/øid/x‹.h
>

5 
	~<löux/dm´ngöe.h
>

174 
	echeck_°©es
 {

175 
	mcheck_°©e_idÀ
 = 0,

176 
	mcheck_°©e_run
,

177 
	mcheck_°©e_run_q
,

178 
	mcheck_°©e_run_pq
,

179 
	mcheck_°©e_check_ªsu…
,

180 
	mcheck_°©e_compuã_run
,

181 
	mcheck_°©e_compuã_ªsu…
,

187 
	eªc⁄°ru˘_°©es
 {

188 
	mªc⁄°ru˘_°©e_idÀ
 = 0,

189 
	mªc⁄°ru˘_°©e_¥ex‹_døö_run
,

190 
	mªc⁄°ru˘_°©e_døö_run
,

191 
	mªc⁄°ru˘_°©e_run
,

192 
	mªc⁄°ru˘_°©e_¥ex‹_døö_ªsu…
,

193 
	mªc⁄°ru˘_°©e_døö_ªsu…
,

194 
	mªc⁄°ru˘_°©e_ªsu…
,

197 
	s°rùe_hód
 {

198 
hli°_node
 
	mhash
;

199 
li°_hód
 
	mÃu
;

200 
Œi°_node
 
	mªÀa£_li°
;

201 
r5c⁄f
 *
	møid_c⁄f
;

202 
	mgíî©i⁄
;

204 
£˘‹_t
 
	m£˘‹
;

205 
	mpd_idx
;

206 
	mqd_idx
;

207 
	mddf_œyout
;

208 
	mhash_lock_ödex
;

209 
	m°©e
;

210 
©omic_t
 
	mcou¡
;

211 
	mbm_£q
;

212 
	mdisks
;

213 
check_°©es
 
	mcheck_°©e
;

214 
ªc⁄°ru˘_°©es
 
	mªc⁄°ru˘_°©e
;

215 
•ölock_t
 
	m°rùe_lock
;

216 
	m˝u
;

217 
r5w‹kî_group
 *
	mgroup
;

225 
	s°rùe_›î©i⁄s
 {

226 
	mèrgë
, 
	mèrgë2
;

227 
sum_check_Êags
 
	mzîo_sum_ªsu…
;

228 } 
	m›s
;

229 
	sr5dev
 {

233 
bio
 
	mªq
, 
	mºeq
;

234 
bio_vec
 
	mvec
, 
	mrvec
;

235 
∑ge
 *
	m∑ge
, *
	m‹ig_∑ge
;

236 
bio
 *
	mt‹ód
, *
	mªad
, *
	mtowrôe
, *
	mwrôãn
;

237 
£˘‹_t
 
	m£˘‹
;

238 
	mÊags
;

239 } 
	mdev
[1];

245 
	s°rùe_hód_°©e
 {

252 
	msyncög
, 
	mex∑ndög
, 
	mex∑nded
, 
	mª∂acög
;

253 
	mlocked
, 
	mu±od©e
, 
	mto_ªad
, 
	mto_wrôe
, 
	mÁûed
, 
	mwrôãn
;

254 
	mto_fûl
, 
	mcompuã
, 
	mªq_compuã
, 
	mn⁄_ovîwrôe
;

255 
	mÁûed_num
[2];

256 
	mp_Áûed
, 
	mq_Áûed
;

257 
	mdec_¥îód_a˘ive
;

258 
	m›s_ªque°
;

260 
bio
 *
	mªtu∫_bi
;

261 
md_rdev
 *
	mblocked_rdev
;

262 
	mh™dÀ_bad_blocks
;

266 
	er5dev_Êags
 {

267 
	mR5_UPTODATE
,

268 
	mR5_LOCKED
,

269 
	mR5_DOUBLE_LOCKED
,

270 
	mR5_OVERWRITE
,

272 
	mR5_Insync
,

273 
	mR5_W™åód
,

274 
	mR5_W™twrôe
,

275 
	mR5_Ovîœp
,

277 
	mR5_RódNoMîge
,

278 
	mR5_RódEº‹
,

279 
	mR5_ReWrôe
,

281 
	mR5_Ex∑nded
,

282 
	mR5_W™tcompuã
,

285 
	mR5_W™tfûl
,

288 
	mR5_W™tdøö
,

289 
	mR5_W™tFUA
,

290 
	mR5_SyncIO
,

291 
	mR5_WrôeEº‹
,

292 
	mR5_MadeGood
,

293 
	mR5_RódRïl
,

294 
	mR5_MadeGoodRïl
,

296 
	mR5_NìdRïœ˚
,

298 
	mR5_W™tRïœ˚
,

301 
	mR5_Disˇrd
,

302 
	mR5_SkùC›y
,

309 
	mSTRIPE_ACTIVE
,

310 
	mSTRIPE_HANDLE
,

311 
	mSTRIPE_SYNC_REQUESTED
,

312 
	mSTRIPE_SYNCING
,

313 
	mSTRIPE_INSYNC
,

314 
	mSTRIPE_REPLACED
,

315 
	mSTRIPE_PREREAD_ACTIVE
,

316 
	mSTRIPE_DELAYED
,

317 
	mSTRIPE_DEGRADED
,

318 
	mSTRIPE_BIT_DELAY
,

319 
	mSTRIPE_EXPANDING
,

320 
	mSTRIPE_EXPAND_SOURCE
,

321 
	mSTRIPE_EXPAND_READY
,

322 
	mSTRIPE_IO_STARTED
,

323 
	mSTRIPE_FULL_WRITE
,

324 
	mSTRIPE_BIOFILL_RUN
,

325 
	mSTRIPE_COMPUTE_RUN
,

326 
	mSTRIPE_OPS_REQ_PENDING
,

327 
	mSTRIPE_ON_UNPLUG_LIST
,

328 
	mSTRIPE_DISCARD
,

329 
	mSTRIPE_ON_RELEASE_LIST
,

336 
	mSTRIPE_OP_BIOFILL
,

337 
	mSTRIPE_OP_COMPUTE_BLK
,

338 
	mSTRIPE_OP_PREXOR
,

339 
	mSTRIPE_OP_BIODRAIN
,

340 
	mSTRIPE_OP_RECONSTRUCT
,

341 
	mSTRIPE_OP_CHECK
,

368 
	sdisk_öfo
 {

369 
md_rdev
 *
	mrdev
, *
	mª∂a˚mít
;

377 
	#NR_STRIPE_HASH_LOCKS
 8

	)

378 
	#STRIPE_HASH_LOCKS_MASK
 (
NR_STRIPE_HASH_LOCKS
 - 1)

	)

380 
	sr5w‹kî
 {

381 
w‹k_°ru˘
 
	mw‹k
;

382 
r5w‹kî_group
 *
	mgroup
;

383 
li°_hód
 
	mãmp_öa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

384 
boﬁ
 
	mw‹kög
;

387 
	sr5w‹kî_group
 {

388 
li°_hód
 
	mh™dÀ_li°
;

389 
r5c⁄f
 *
	mc⁄f
;

390 
r5w‹kî
 *
	mw‹kîs
;

391 
	m°rùes_˙t
;

394 
	sr5c⁄f
 {

395 
hli°_hód
 *
	m°rùe_hashtbl
;

397 
•ölock_t
 
	mhash_locks
[
NR_STRIPE_HASH_LOCKS
];

398 
mddev
 *
	mmddev
;

399 
	mchunk_£˘‹s
;

400 
	mÀvñ
, 
	mÆg‹ôhm
;

401 
	mmax_degøded
;

402 
	møid_disks
;

403 
	mmax_ƒ_°rùes
;

410 
£˘‹_t
 
	mªsh≠e_¥ogªss
;

414 
£˘‹_t
 
	mªsh≠e_ß„
;

415 
	m¥evious_øid_disks
;

416 
	m¥ev_chunk_£˘‹s
;

417 
	m¥ev_Ægo
;

418 
	mgíî©i⁄
;

419 
£qcou¡_t
 
	mgí_lock
;

420 
	mªsh≠e_checkpoöt
;

422 
	mmö_off£t_diff
;

429 
li°_hód
 
	mh™dÀ_li°
;

430 
li°_hód
 
	mhﬁd_li°
;

431 
li°_hód
 
	mdñayed_li°
;

432 
li°_hód
 
	mbôm≠_li°
;

433 
bio
 *
	mªåy_ªad_Æig√d
;

434 
bio
 *
	mªåy_ªad_Æig√d_li°
;

435 
©omic_t
 
	m¥îód_a˘ive_°rùes
;

436 
©omic_t
 
	ma˘ive_Æig√d_ªads
;

437 
©omic_t
 
	m≥ndög_fuŒ_wrôes
;

438 
	mby∑ss_cou¡
;

439 
	mby∑ss_thªshﬁd
;

440 
	mskù_c›y
;

441 
li°_hód
 *
	mœ°_hﬁd
;

443 
©omic_t
 
	mªsh≠e_°rùes
;

447 
	ma˘ive_«me
;

448 
	mˇche_«me
[2][32];

449 
kmem_ˇche
 *
	m¶ab_ˇche
;

451 
	m£q_Êush
, 
	m£q_wrôe
;

452 
	mquõs˚
;

454 
	mfuŒsync
;

458 
	mªcovîy_dißbÀd
;

460 
	søid5_≥r˝u
 {

461 
∑ge
 *
	m•¨e_∑ge
;

462 *
	ms¸ibbÀ
;

466 } 
__≥r˝u
 *
	m≥r˝u
;

467 
size_t
 
	ms¸ibbÀ_Àn
;

471 #ifde‡
CONFIG_HOTPLUG_CPU


472 
nŸifõr_block
 
	m˝u_nŸify
;

478 
©omic_t
 
	ma˘ive_°rùes
;

479 
li°_hód
 
	möa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

480 
©omic_t
 
	mem±y_öa˘ive_li°_ƒ
;

481 
Œi°_hód
 
	mªÀa£d_°rùes
;

482 
waô_queue_hód_t
 
	mwaô_f‹_°rùe
;

483 
waô_queue_hód_t
 
	mwaô_f‹_ovîœp
;

484 
	möa˘ive_blocked
;

487 
	mpoﬁ_size
;

488 
•ölock_t
 
	mdevi˚_lock
;

489 
disk_öfo
 *
	mdisks
;

494 
md_thªad
 *
	mthªad
;

495 
li°_hód
 
	mãmp_öa˘ive_li°
[
NR_STRIPE_HASH_LOCKS
];

496 
r5w‹kî_group
 *
	mw‹kî_groups
;

497 
	mgroup_˙t
;

498 
	mw‹kî_˙t_≥r_group
;

504 
	#ALGORITHM_LEFT_ASYMMETRIC
 0

	)

505 
	#ALGORITHM_RIGHT_ASYMMETRIC
 1

	)

506 
	#ALGORITHM_LEFT_SYMMETRIC
 2

	)

507 
	#ALGORITHM_RIGHT_SYMMETRIC
 3

	)

512 
	#ALGORITHM_PARITY_0
 4

	)

513 
	#ALGORITHM_PARITY_N
 5

	)

527 
	#ALGORITHM_ROTATING_ZERO_RESTART
 8

	)

528 
	#ALGORITHM_ROTATING_N_RESTART
 9

	)

529 
	#ALGORITHM_ROTATING_N_CONTINUE
 10

	)

537 
	#ALGORITHM_LEFT_ASYMMETRIC_6
 16

	)

538 
	#ALGORITHM_RIGHT_ASYMMETRIC_6
 17

	)

539 
	#ALGORITHM_LEFT_SYMMETRIC_6
 18

	)

540 
	#ALGORITHM_RIGHT_SYMMETRIC_6
 19

	)

541 
	#ALGORITHM_PARITY_0_6
 20

	)

542 
	#ALGORITHM_PARITY_N_6
 
ALGORITHM_PARITY_N


	)

544 
ölöe
 
	$Æg‹ôhm_vÆid_øid5
(
œyout
)

546  (
œyout
 >= 0) &&

547 (
œyout
 <= 5);

548 
	}
}

549 
ölöe
 
	$Æg‹ôhm_vÆid_øid6
(
œyout
)

551  (
œyout
 >= 0 &&Üayout <= 5)

553 (
œyout
 >= 8 &&Üayout <= 10)

555 (
œyout
 >= 16 &&Üayout <= 20);

556 
	}
}

558 
ölöe
 
	$Æg‹ôhm_is_DDF
(
œyout
)

560  
œyout
 >= 8 &&Üayout <= 10;

561 
	}
}

563 
md_øid5_c⁄ge°ed
(
mddev
 *mddev, 
bôs
);

564 
md_øid5_kick_devi˚
(
r5c⁄f
 *
c⁄f
);

565 
øid5_£t_ˇche_size
(
mddev
 *mddev, 
size
);

	@/usr/include/linux/blkpg.h

1 #i‚de‡
_LINUX_BLKPG_H


2 
	#_LINUX_BLKPG_H


	)

28 
	~<löux/io˘l.h
>

30 
	#BLKPG
 
	`_IO
(0x12,105)

	)

33 
	sblkpg_io˘l_¨g
 {

34 
	m›
;

35 
	mÊags
;

36 
	md©Æí
;

37 *
	md©a
;

41 
	#BLKPG_ADD_PARTITION
 1

	)

42 
	#BLKPG_DEL_PARTITION
 2

	)

43 
	#BLKPG_RESIZE_PARTITION
 3

	)

46 
	#BLKPG_DEVNAMELTH
 64

	)

47 
	#BLKPG_VOLNAMELTH
 64

	)

50 
	sblkpg_∑πôi⁄
 {

51 
	m°¨t
;

52 
	mÀngth
;

53 
	m≤o
;

54 
	mdev«me
[
BLKPG_DEVNAMELTH
];

56 
	mvﬁ«me
[
BLKPG_VOLNAMELTH
];

	@/usr/include/linux/blktrace_api.h

1 #i‚de‡
BLKTRACE_H


2 
	#BLKTRACE_H


	)

4 
	~<löux/ty≥s.h
>

9 
	eblkåa˚_ˇt
 {

10 
	mBLK_TC_READ
 = 1 << 0,

11 
	mBLK_TC_WRITE
 = 1 << 1,

12 
	mBLK_TC_FLUSH
 = 1 << 2,

13 
	mBLK_TC_SYNC
 = 1 << 3,

14 
	mBLK_TC_SYNCIO
 = 
BLK_TC_SYNC
,

15 
	mBLK_TC_QUEUE
 = 1 << 4,

16 
	mBLK_TC_REQUEUE
 = 1 << 5,

17 
	mBLK_TC_ISSUE
 = 1 << 6,

18 
	mBLK_TC_COMPLETE
 = 1 << 7,

19 
	mBLK_TC_FS
 = 1 << 8,

20 
	mBLK_TC_PC
 = 1 << 9,

21 
	mBLK_TC_NOTIFY
 = 1 << 10,

22 
	mBLK_TC_AHEAD
 = 1 << 11,

23 
	mBLK_TC_META
 = 1 << 12,

24 
	mBLK_TC_DISCARD
 = 1 << 13,

25 
	mBLK_TC_DRV_DATA
 = 1 << 14,

26 
	mBLK_TC_FUA
 = 1 << 15,

28 
	mBLK_TC_END
 = 1 << 15,

31 
	#BLK_TC_SHIFT
 (16)

	)

32 
	#BLK_TC_ACT
(
a˘
Ë(◊˘Ë<< 
BLK_TC_SHIFT
)

	)

37 
	eblkåa˚_a˘
 {

38 
	m__BLK_TA_QUEUE
 = 1,

39 
	m__BLK_TA_BACKMERGE
,

40 
	m__BLK_TA_FRONTMERGE
,

41 
	m__BLK_TA_GETRQ
,

42 
	m__BLK_TA_SLEEPRQ
,

43 
	m__BLK_TA_REQUEUE
,

44 
	m__BLK_TA_ISSUE
,

45 
	m__BLK_TA_COMPLETE
,

46 
	m__BLK_TA_PLUG
,

47 
	m__BLK_TA_UNPLUG_IO
,

48 
	m__BLK_TA_UNPLUG_TIMER
,

49 
	m__BLK_TA_INSERT
,

50 
	m__BLK_TA_SPLIT
,

51 
	m__BLK_TA_BOUNCE
,

52 
	m__BLK_TA_REMAP
,

53 
	m__BLK_TA_ABORT
,

54 
	m__BLK_TA_DRV_DATA
,

60 
	eblkåa˚_nŸify
 {

61 
	m__BLK_TN_PROCESS
 = 0,

62 
	m__BLK_TN_TIMESTAMP
,

63 
	m__BLK_TN_MESSAGE
,

70 
	#BLK_TA_QUEUE
 (
__BLK_TA_QUEUE
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

71 
	#BLK_TA_BACKMERGE
 (
__BLK_TA_BACKMERGE
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

72 
	#BLK_TA_FRONTMERGE
 (
__BLK_TA_FRONTMERGE
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

73 
	#BLK_TA_GETRQ
 (
__BLK_TA_GETRQ
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

74 
	#BLK_TA_SLEEPRQ
 (
__BLK_TA_SLEEPRQ
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

75 
	#BLK_TA_REQUEUE
 (
__BLK_TA_REQUEUE
 | 
	`BLK_TC_ACT
(
BLK_TC_REQUEUE
))

	)

76 
	#BLK_TA_ISSUE
 (
__BLK_TA_ISSUE
 | 
	`BLK_TC_ACT
(
BLK_TC_ISSUE
))

	)

77 
	#BLK_TA_COMPLETE
 (
__BLK_TA_COMPLETE
| 
	`BLK_TC_ACT
(
BLK_TC_COMPLETE
))

	)

78 
	#BLK_TA_PLUG
 (
__BLK_TA_PLUG
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

79 
	#BLK_TA_UNPLUG_IO
 (
__BLK_TA_UNPLUG_IO
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

80 
	#BLK_TA_UNPLUG_TIMER
 (
__BLK_TA_UNPLUG_TIMER
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

81 
	#BLK_TA_INSERT
 (
__BLK_TA_INSERT
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

82 
	#BLK_TA_SPLIT
 (
__BLK_TA_SPLIT
)

	)

83 
	#BLK_TA_BOUNCE
 (
__BLK_TA_BOUNCE
)

	)

84 
	#BLK_TA_REMAP
 (
__BLK_TA_REMAP
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

85 
	#BLK_TA_ABORT
 (
__BLK_TA_ABORT
 | 
	`BLK_TC_ACT
(
BLK_TC_QUEUE
))

	)

86 
	#BLK_TA_DRV_DATA
 (
__BLK_TA_DRV_DATA
 | 
	`BLK_TC_ACT
(
BLK_TC_DRV_DATA
))

	)

88 
	#BLK_TN_PROCESS
 (
__BLK_TN_PROCESS
 | 
	`BLK_TC_ACT
(
BLK_TC_NOTIFY
))

	)

89 
	#BLK_TN_TIMESTAMP
 (
__BLK_TN_TIMESTAMP
 | 
	`BLK_TC_ACT
(
BLK_TC_NOTIFY
))

	)

90 
	#BLK_TN_MESSAGE
 (
__BLK_TN_MESSAGE
 | 
	`BLK_TC_ACT
(
BLK_TC_NOTIFY
))

	)

92 
	#BLK_IO_TRACE_MAGIC
 0x65617400

	)

93 
	#BLK_IO_TRACE_VERSION
 0x07

	)

98 
	sblk_io_åa˚
 {

99 
__u32
 
	mmagic
;

100 
__u32
 
	m£quí˚
;

101 
__u64
 
	mtime
;

102 
__u64
 
	m£˘‹
;

103 
__u32
 
	mbyãs
;

104 
__u32
 
	ma˘i⁄
;

105 
__u32
 
	mpid
;

106 
__u32
 
	mdevi˚
;

107 
__u32
 
	m˝u
;

108 
__u16
 
	mîr‹
;

109 
__u16
 
	mpdu_Àn
;

115 
	sblk_io_åa˚_ªm≠
 {

116 
__be32
 
	mdevi˚_‰om
;

117 
__be32
 
	mdevi˚_to
;

118 
__be64
 
	m£˘‹_‰om
;

122 
	mBlkåa˚_£tup
 = 1,

123 
	mBlkåa˚_ru¬ög
,

124 
	mBlkåa˚_°›≥d
,

127 
	#BLKTRACE_BDEV_SIZE
 32

	)

132 
	sblk_u£r_åa˚_£tup
 {

133 
	m«me
[
BLKTRACE_BDEV_SIZE
];

134 
__u16
 
	ma˘_mask
;

135 
__u32
 
	mbuf_size
;

136 
__u32
 
	mbuf_ƒ
;

137 
__u64
 
	m°¨t_lba
;

138 
__u64
 
	míd_lba
;

139 
__u32
 
	mpid
;

	@/usr/include/linux/connector.h

22 #i‚de‡
__CONNECTOR_H


23 
	#__CONNECTOR_H


	)

25 
	~<löux/ty≥s.h
>

30 
	#CN_IDX_PROC
 0x1

	)

31 
	#CN_VAL_PROC
 0x1

	)

32 
	#CN_IDX_CIFS
 0x2

	)

33 
	#CN_VAL_CIFS
 0x1

	)

34 
	#CN_W1_IDX
 0x3

	)

35 
	#CN_W1_VAL
 0x1

	)

36 
	#CN_IDX_V86D
 0x4

	)

37 
	#CN_VAL_V86D_UVESAFB
 0x1

	)

38 
	#CN_IDX_BB
 0x5

	)

39 
	#CN_DST_IDX
 0x6

	)

40 
	#CN_DST_VAL
 0x1

	)

41 
	#CN_IDX_DM
 0x7

	)

42 
	#CN_VAL_DM_USERSPACE_LOG
 0x1

	)

43 
	#CN_IDX_DRBD
 0x8

	)

44 
	#CN_VAL_DRBD
 0x1

	)

45 
	#CN_KVP_IDX
 0x9

	)

46 
	#CN_KVP_VAL
 0x1

	)

47 
	#CN_VSS_IDX
 0xA

	)

48 
	#CN_VSS_VAL
 0x1

	)

51 
	#CN_NETLINK_USERS
 11

	)

56 
	#CONNECTOR_MAX_MSG_SIZE
 16384

	)

64 
	scb_id
 {

65 
__u32
 
	midx
;

66 
__u32
 
	mvÆ
;

69 
	s˙_msg
 {

70 
cb_id
 
	mid
;

72 
__u32
 
	m£q
;

73 
__u32
 
	mack
;

75 
__u16
 
	mÀn
;

76 
__u16
 
	mÊags
;

77 
__u8
 
	md©a
[0];

	@/usr/include/linux/dm-ioctl.h

8 #i‚de‡
_LINUX_DM_IOCTL_V4_H


9 
	#_LINUX_DM_IOCTL_V4_H


	)

11 
	~<löux/ty≥s.h
>

13 
	#DM_DIR
 "m≠≥r"

	)

14 
	#DM_CONTROL_NODE
 "c⁄åﬁ"

	)

15 
	#DM_MAX_TYPE_NAME
 16

	)

16 
	#DM_NAME_LEN
 128

	)

17 
	#DM_UUID_LEN
 129

	)

102 
	sdm_io˘l
 {

117 
__u32
 
	mvîsi⁄
[3];

118 
__u32
 
	md©a_size
;

121 
__u32
 
	md©a_°¨t
;

124 
__u32
 
	mèrgë_cou¡
;

125 
__s32
 
	m›í_cou¡
;

126 
__u32
 
	mÊags
;

137 
__u32
 
	mevít_ƒ
;

138 
__u32
 
	m∑ddög
;

140 
__u64
 
	mdev
;

142 
	m«me
[
DM_NAME_LEN
];

143 
	muuid
[
DM_UUID_LEN
];

145 
	md©a
[7];

152 
	sdm_èrgë_•ec
 {

153 
__u64
 
	m£˘‹_°¨t
;

154 
__u64
 
	mÀngth
;

155 
__s32
 
	m°©us
;

167 
__u32
 
	m√xt
;

169 
	mèrgë_ty≥
[
DM_MAX_TYPE_NAME
];

181 
	sdm_èrgë_dïs
 {

182 
__u32
 
	mcou¡
;

183 
__u32
 
	m∑ddög
;

184 
__u64
 
	mdev
[0];

190 
	sdm_«me_li°
 {

191 
__u64
 
	mdev
;

192 
__u32
 
	m√xt
;

194 
	m«me
[0];

200 
	sdm_èrgë_vîsi⁄s
 {

201 
__u32
 
	m√xt
;

202 
__u32
 
	mvîsi⁄
[3];

204 
	m«me
[0];

210 
	sdm_èrgë_msg
 {

211 
__u64
 
	m£˘‹
;

213 
	mmesßge
[0];

222 
	mDM_VERSION_CMD
 = 0,

223 
	mDM_REMOVE_ALL_CMD
,

224 
	mDM_LIST_DEVICES_CMD
,

227 
	mDM_DEV_CREATE_CMD
,

228 
	mDM_DEV_REMOVE_CMD
,

229 
	mDM_DEV_RENAME_CMD
,

230 
	mDM_DEV_SUSPEND_CMD
,

231 
	mDM_DEV_STATUS_CMD
,

232 
	mDM_DEV_WAIT_CMD
,

235 
	mDM_TABLE_LOAD_CMD
,

236 
	mDM_TABLE_CLEAR_CMD
,

237 
	mDM_TABLE_DEPS_CMD
,

238 
	mDM_TABLE_STATUS_CMD
,

241 
	mDM_LIST_VERSIONS_CMD
,

242 
	mDM_TARGET_MSG_CMD
,

243 
	mDM_DEV_SET_GEOMETRY_CMD


246 
	#DM_IOCTL
 0xfd

	)

248 
	#DM_VERSION
 
	`_IOWR
(
DM_IOCTL
, 
DM_VERSION_CMD
, 
dm_io˘l
)

	)

249 
	#DM_REMOVE_ALL
 
	`_IOWR
(
DM_IOCTL
, 
DM_REMOVE_ALL_CMD
, 
dm_io˘l
)

	)

250 
	#DM_LIST_DEVICES
 
	`_IOWR
(
DM_IOCTL
, 
DM_LIST_DEVICES_CMD
, 
dm_io˘l
)

	)

252 
	#DM_DEV_CREATE
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_CREATE_CMD
, 
dm_io˘l
)

	)

253 
	#DM_DEV_REMOVE
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_REMOVE_CMD
, 
dm_io˘l
)

	)

254 
	#DM_DEV_RENAME
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_RENAME_CMD
, 
dm_io˘l
)

	)

255 
	#DM_DEV_SUSPEND
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_SUSPEND_CMD
, 
dm_io˘l
)

	)

256 
	#DM_DEV_STATUS
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_STATUS_CMD
, 
dm_io˘l
)

	)

257 
	#DM_DEV_WAIT
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_WAIT_CMD
, 
dm_io˘l
)

	)

259 
	#DM_TABLE_LOAD
 
	`_IOWR
(
DM_IOCTL
, 
DM_TABLE_LOAD_CMD
, 
dm_io˘l
)

	)

260 
	#DM_TABLE_CLEAR
 
	`_IOWR
(
DM_IOCTL
, 
DM_TABLE_CLEAR_CMD
, 
dm_io˘l
)

	)

261 
	#DM_TABLE_DEPS
 
	`_IOWR
(
DM_IOCTL
, 
DM_TABLE_DEPS_CMD
, 
dm_io˘l
)

	)

262 
	#DM_TABLE_STATUS
 
	`_IOWR
(
DM_IOCTL
, 
DM_TABLE_STATUS_CMD
, 
dm_io˘l
)

	)

264 
	#DM_LIST_VERSIONS
 
	`_IOWR
(
DM_IOCTL
, 
DM_LIST_VERSIONS_CMD
, 
dm_io˘l
)

	)

266 
	#DM_TARGET_MSG
 
	`_IOWR
(
DM_IOCTL
, 
DM_TARGET_MSG_CMD
, 
dm_io˘l
)

	)

267 
	#DM_DEV_SET_GEOMETRY
 
	`_IOWR
(
DM_IOCTL
, 
DM_DEV_SET_GEOMETRY_CMD
, 
dm_io˘l
)

	)

269 
	#DM_VERSION_MAJOR
 4

	)

270 
	#DM_VERSION_MINOR
 27

	)

271 
	#DM_VERSION_PATCHLEVEL
 0

	)

272 
	#DM_VERSION_EXTRA
 "-io˘»(2013-10-30)"

	)

275 
	#DM_READONLY_FLAG
 (1 << 0Ë

	)

276 
	#DM_SUSPEND_FLAG
 (1 << 1Ë

	)

277 
	#DM_PERSISTENT_DEV_FLAG
 (1 << 3Ë

	)

283 
	#DM_STATUS_TABLE_FLAG
 (1 << 4Ë

	)

289 
	#DM_ACTIVE_PRESENT_FLAG
 (1 << 5Ë

	)

290 
	#DM_INACTIVE_PRESENT_FLAG
 (1 << 6Ë

	)

296 
	#DM_BUFFER_FULL_FLAG
 (1 << 8Ë

	)

301 
	#DM_SKIP_BDGET_FLAG
 (1 << 9Ë

	)

306 
	#DM_SKIP_LOCKFS_FLAG
 (1 << 10Ë

	)

313 
	#DM_NOFLUSH_FLAG
 (1 << 11Ë

	)

320 
	#DM_QUERY_INACTIVE_TABLE_FLAG
 (1 << 12Ë

	)

325 
	#DM_UEVENT_GENERATED_FLAG
 (1 << 13Ë

	)

331 
	#DM_UUID_FLAG
 (1 << 14Ë

	)

337 
	#DM_SECURE_DATA_FLAG
 (1 << 15Ë

	)

342 
	#DM_DATA_OUT_FLAG
 (1 << 16Ë

	)

353 
	#DM_DEFERRED_REMOVE
 (1 << 17Ë

	)

	@/usr/include/linux/dm-log-userspace.h

7 #i‚de‡
__DM_LOG_USERSPACE_H__


8 
	#__DM_LOG_USERSPACE_H__


	)

10 
	~<löux/dm-io˘l.h
>

70 
	#DM_ULOG_CTR
 1

	)

89 
	#DM_ULOG_DTR
 2

	)

108 
	#DM_ULOG_PRESUSPEND
 3

	)

127 
	#DM_ULOG_POSTSUSPEND
 4

	)

146 
	#DM_ULOG_RESUME
 5

	)

164 
	#DM_ULOG_GET_REGION_SIZE
 6

	)

182 
	#DM_ULOG_IS_CLEAN
 7

	)

197 
	#DM_ULOG_IN_SYNC
 8

	)

214 
	#DM_ULOG_FLUSH
 9

	)

233 
	#DM_ULOG_MARK_REGION
 10

	)

252 
	#DM_ULOG_CLEAR_REGION
 11

	)

270 
	#DM_ULOG_GET_RESYNC_WORK
 12

	)

289 
	#DM_ULOG_SET_REGION_SYNC
 13

	)

307 
	#DM_ULOG_GET_SYNC_COUNT
 14

	)

323 
	#DM_ULOG_STATUS_INFO
 15

	)

339 
	#DM_ULOG_STATUS_TABLE
 16

	)

357 
	#DM_ULOG_IS_REMOTE_RECOVERING
 17

	)

374 
	#DM_ULOG_REQUEST_MASK
 0xFF

	)

375 
	#DM_ULOG_REQUEST_TYPE
(
ªque°_ty≥
) \

376 (
DM_ULOG_REQUEST_MASK
 & (
ªque°_ty≥
))

	)

389 
	#DM_ULOG_REQUEST_VERSION
 2

	)

391 
	sdm_ulog_ªque°
 {

402 
uöt64_t
 
	mluid
;

403 
	muuid
[
DM_UUID_LEN
];

404 
	m∑ddög
[3];

406 
uöt32_t
 
	mvîsi⁄
;

407 
öt32_t
 
	mîr‹
;

409 
uöt32_t
 
	m£q
;

410 
uöt32_t
 
	mªque°_ty≥
;

411 
uöt32_t
 
	md©a_size
;

413 
	md©a
[0];

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/fs.h

1 #i‚de‡
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<löux/limôs.h
>

10 
	~<löux/io˘l.h
>

11 
	~<löux/ty≥s.h
>

24 #unde‡
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	sf°rim_ønge
 {

39 
__u64
 
	m°¨t
;

40 
__u64
 
	mÀn
;

41 
__u64
 
	mmöÀn
;

45 
	sfûes_°©_°ru˘
 {

46 
	mƒ_fûes
;

47 
	mƒ_‰ì_fûes
;

48 
	mmax_fûes
;

51 
	söodes_°©_t
 {

52 
	mƒ_öodes
;

53 
	mƒ_unu£d
;

54 
	mdummy
[5];

58 
	#NR_FILE
 8192

	)

64 
	#MS_RDONLY
 1

	)

65 
	#MS_NOSUID
 2

	)

66 
	#MS_NODEV
 4

	)

67 
	#MS_NOEXEC
 8

	)

68 
	#MS_SYNCHRONOUS
 16

	)

69 
	#MS_REMOUNT
 32

	)

70 
	#MS_MANDLOCK
 64

	)

71 
	#MS_DIRSYNC
 128

	)

72 
	#MS_NOATIME
 1024

	)

73 
	#MS_NODIRATIME
 2048

	)

74 
	#MS_BIND
 4096

	)

75 
	#MS_MOVE
 8192

	)

76 
	#MS_REC
 16384

	)

77 
	#MS_VERBOSE
 32768

	)

79 
	#MS_SILENT
 32768

	)

80 
	#MS_POSIXACL
 (1<<16Ë

	)

81 
	#MS_UNBINDABLE
 (1<<17Ë

	)

82 
	#MS_PRIVATE
 (1<<18Ë

	)

83 
	#MS_SLAVE
 (1<<19Ë

	)

84 
	#MS_SHARED
 (1<<20Ë

	)

85 
	#MS_RELATIME
 (1<<21Ë

	)

86 
	#MS_KERNMOUNT
 (1<<22Ë

	)

87 
	#MS_I_VERSION
 (1<<23Ë

	)

88 
	#MS_STRICTATIME
 (1<<24Ë

	)

91 
	#MS_NOSEC
 (1<<28)

	)

92 
	#MS_BORN
 (1<<29)

	)

93 
	#MS_ACTIVE
 (1<<30)

	)

94 
	#MS_NOUSER
 (1<<31)

	)

99 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
)

	)

104 
	#MS_MGC_VAL
 0xC0ED0000

	)

105 
	#MS_MGC_MSK
 0xffff0000

	)

110 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

111 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

112 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

113 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

114 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

115 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

116 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

117 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

118 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

119 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

120 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

121 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

123 
	#BLKPG
 
	`_IO
(0x12,105)

	)

127 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

128 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

133 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

134 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

135 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

136 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

137 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

138 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

139 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

140 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

141 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

142 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

143 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

144 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

145 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

146 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

147 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

148 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

150 
	#BMAP_IOCTL
 1

	)

151 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

152 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

153 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

154 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

155 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

157 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

158 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

159 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

160 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

161 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

162 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

163 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

164 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

165 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

170 
	#FS_SECRM_FL
 0x00000001

	)

171 
	#FS_UNRM_FL
 0x00000002

	)

172 
	#FS_COMPR_FL
 0x00000004

	)

173 
	#FS_SYNC_FL
 0x00000008

	)

174 
	#FS_IMMUTABLE_FL
 0x00000010

	)

175 
	#FS_APPEND_FL
 0x00000020

	)

176 
	#FS_NODUMP_FL
 0x00000040

	)

177 
	#FS_NOATIME_FL
 0x00000080

	)

179 
	#FS_DIRTY_FL
 0x00000100

	)

180 
	#FS_COMPRBLK_FL
 0x00000200

	)

181 
	#FS_NOCOMP_FL
 0x00000400

	)

182 
	#FS_ECOMPR_FL
 0x00000800

	)

184 
	#FS_BTREE_FL
 0x00001000

	)

185 
	#FS_INDEX_FL
 0x00001000

	)

186 
	#FS_IMAGIC_FL
 0x00002000

	)

187 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

188 
	#FS_NOTAIL_FL
 0x00008000

	)

189 
	#FS_DIRSYNC_FL
 0x00010000

	)

190 
	#FS_TOPDIR_FL
 0x00020000

	)

191 
	#FS_EXTENT_FL
 0x00080000

	)

192 
	#FS_DIRECTIO_FL
 0x00100000

	)

193 
	#FS_NOCOW_FL
 0x00800000

	)

194 
	#FS_RESERVED_FL
 0x80000000

	)

196 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

197 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

200 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

201 
	#SYNC_FILE_RANGE_WRITE
 2

	)

202 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/hdreg.h

1 #i‚de‡
_LINUX_HDREG_H


2 
	#_LINUX_HDREG_H


	)

4 
	~<löux/ty≥s.h
>

10 
	#HDIO_DRIVE_CMD_HDR_SIZE
 (4 * (
__u8
))

	)

11 
	#HDIO_DRIVE_HOB_HDR_SIZE
 (8 * (
__u8
))

	)

12 
	#HDIO_DRIVE_TASK_HDR_SIZE
 (8 * (
__u8
))

	)

14 
	#IDE_DRIVE_TASK_NO_DATA
 0

	)

15 
	#IDE_DRIVE_TASK_INVALID
 -1

	)

16 
	#IDE_DRIVE_TASK_SET_XFER
 1

	)

17 
	#IDE_DRIVE_TASK_IN
 2

	)

18 
	#IDE_DRIVE_TASK_OUT
 3

	)

19 
	#IDE_DRIVE_TASK_RAW_WRITE
 4

	)

24 
	#IDE_TASKFILE_STD_IN_FLAGS
 0xFE

	)

25 
	#IDE_HOB_STD_IN_FLAGS
 0x3C

	)

26 
	#IDE_TASKFILE_STD_OUT_FLAGS
 0xFE

	)

27 
	#IDE_HOB_STD_OUT_FLAGS
 0x3C

	)

29 
	tèsk_i‹eg_t
;

30 
	tßè_i‹eg_t
;

32 
	uide_ªg_vÆid_s
 {

33 
	mÆl
 : 16;

35 
	md©a
 : 1;

36 
	mîr‹_„©uª
 : 1;

37 
	m£˘‹
 : 1;

38 
	mn£˘‹
 : 1;

39 
	mlcyl
 : 1;

40 
	mhcyl
 : 1;

41 
	m£À˘
 : 1;

42 
	m°©us_comm™d
 : 1;

44 
	md©a_hob
 : 1;

45 
	mîr‹_„©uª_hob
 : 1;

46 
	m£˘‹_hob
 : 1;

47 
	mn£˘‹_hob
 : 1;

48 
	mlcyl_hob
 : 1;

49 
	mhcyl_hob
 : 1;

50 
	m£À˘_hob
 : 1;

51 
	mc⁄åﬁ_hob
 : 1;

52 } 
	mb
;

53 } 
	tide_ªg_vÆid_t
;

55 
	side_èsk_ªque°_s
 {

56 
__u8
 
	mio_p‹ts
[8];

57 
__u8
 
	mhob_p‹ts
[8];

58 
ide_ªg_vÆid_t
 
	mout_Êags
;

59 
ide_ªg_vÆid_t
 
	mö_Êags
;

60 
	md©a_pha£
;

61 
	mªq_cmd
;

62 
	mout_size
;

63 
	mö_size
;

64 } 
	tide_èsk_ªque°_t
;

66 
	side_io˘l_ªque°_s
 {

67 
ide_èsk_ªque°_t
 *
	mèsk_ªque°
;

68 *
	mout_buf„r
;

69 *
	mö_buf„r
;

70 } 
	tide_io˘l_ªque°_t
;

72 
	shd_drive_cmd_hdr
 {

73 
__u8
 
	mcomm™d
;

74 
__u8
 
	m£˘‹_numbî
;

75 
__u8
 
	m„©uª
;

76 
__u8
 
	m£˘‹_cou¡
;

79 
	shd_drive_èsk_hdr
 {

80 
__u8
 
	md©a
;

81 
__u8
 
	m„©uª
;

82 
__u8
 
	m£˘‹_cou¡
;

83 
__u8
 
	m£˘‹_numbî
;

84 
__u8
 
	mlow_cylödî
;

85 
__u8
 
	mhigh_cylödî
;

86 
__u8
 
	mdevi˚_hód
;

87 
__u8
 
	mcomm™d
;

88 } 
	tèsk_°ru˘_t
;

90 
	shd_drive_hob_hdr
 {

91 
__u8
 
	md©a
;

92 
__u8
 
	m„©uª
;

93 
__u8
 
	m£˘‹_cou¡
;

94 
__u8
 
	m£˘‹_numbî
;

95 
__u8
 
	mlow_cylödî
;

96 
__u8
 
	mhigh_cylödî
;

97 
__u8
 
	mdevi˚_hód
;

98 
__u8
 
	mc⁄åﬁ
;

99 } 
	thob_°ru˘_t
;

101 
	#TASKFILE_NO_DATA
 0x0000

	)

103 
	#TASKFILE_IN
 0x0001

	)

104 
	#TASKFILE_MULTI_IN
 0x0002

	)

106 
	#TASKFILE_OUT
 0x0004

	)

107 
	#TASKFILE_MULTI_OUT
 0x0008

	)

108 
	#TASKFILE_IN_OUT
 0x0010

	)

110 
	#TASKFILE_IN_DMA
 0x0020

	)

111 
	#TASKFILE_OUT_DMA
 0x0040

	)

112 
	#TASKFILE_IN_DMAQ
 0x0080

	)

113 
	#TASKFILE_OUT_DMAQ
 0x0100

	)

115 
	#TASKFILE_P_IN
 0x0200

	)

116 
	#TASKFILE_P_OUT
 0x0400

	)

117 
	#TASKFILE_P_IN_DMA
 0x0800

	)

118 
	#TASKFILE_P_OUT_DMA
 0x1000

	)

119 
	#TASKFILE_P_IN_DMAQ
 0x2000

	)

120 
	#TASKFILE_P_OUT_DMAQ
 0x4000

	)

121 
	#TASKFILE_48
 0x8000

	)

122 
	#TASKFILE_INVALID
 0x7fff

	)

125 
	#WIN_NOP
 0x00

	)

129 
	#CFA_REQ_EXT_ERROR_CODE
 0x03

	)

133 
	#WIN_SRST
 0x08

	)

134 
	#WIN_DEVICE_RESET
 0x08

	)

138 
	#WIN_RECAL
 0x10

	)

139 
	#WIN_RESTORE
 
WIN_RECAL


	)

143 
	#WIN_READ
 0x20

	)

144 
	#WIN_READ_ONCE
 0x21

	)

145 
	#WIN_READ_LONG
 0x22

	)

146 
	#WIN_READ_LONG_ONCE
 0x23

	)

147 
	#WIN_READ_EXT
 0x24

	)

148 
	#WIN_READDMA_EXT
 0x25

	)

149 
	#WIN_READDMA_QUEUED_EXT
 0x26

	)

150 
	#WIN_READ_NATIVE_MAX_EXT
 0x27

	)

154 
	#WIN_MULTREAD_EXT
 0x29

	)

158 
	#WIN_WRITE
 0x30

	)

159 
	#WIN_WRITE_ONCE
 0x31

	)

160 
	#WIN_WRITE_LONG
 0x32

	)

161 
	#WIN_WRITE_LONG_ONCE
 0x33

	)

162 
	#WIN_WRITE_EXT
 0x34

	)

163 
	#WIN_WRITEDMA_EXT
 0x35

	)

164 
	#WIN_WRITEDMA_QUEUED_EXT
 0x36

	)

165 
	#WIN_SET_MAX_EXT
 0x37

	)

166 
	#CFA_WRITE_SECT_WO_ERASE
 0x38

	)

167 
	#WIN_MULTWRITE_EXT
 0x39

	)

171 
	#WIN_WRITE_VERIFY
 0x3C

	)

175 
	#WIN_VERIFY
 0x40

	)

176 
	#WIN_VERIFY_ONCE
 0x41

	)

177 
	#WIN_VERIFY_EXT
 0x42

	)

181 
	#WIN_FORMAT
 0x50

	)

185 
	#WIN_INIT
 0x60

	)

189 
	#WIN_SEEK
 0x70

	)

191 
	#CFA_TRANSLATE_SECTOR
 0x87

	)

192 
	#WIN_DIAGNOSE
 0x90

	)

193 
	#WIN_SPECIFY
 0x91

	)

194 
	#WIN_DOWNLOAD_MICROCODE
 0x92

	)

195 
	#WIN_STANDBYNOW2
 0x94

	)

196 
	#WIN_STANDBY2
 0x96

	)

197 
	#WIN_SETIDLE2
 0x97

	)

198 
	#WIN_CHECKPOWERMODE2
 0x98

	)

199 
	#WIN_SLEEPNOW2
 0x99

	)

203 
	#WIN_PACKETCMD
 0xA0

	)

204 
	#WIN_PIDENTIFY
 0xA1

	)

205 
	#WIN_QUEUED_SERVICE
 0xA2

	)

206 
	#WIN_SMART
 0xB0

	)

207 
	#CFA_ERASE_SECTORS
 0xC0

	)

208 
	#WIN_MULTREAD
 0xC4

	)

209 
	#WIN_MULTWRITE
 0xC5

	)

210 
	#WIN_SETMULT
 0xC6

	)

211 
	#WIN_READDMA_QUEUED
 0xC7

	)

212 
	#WIN_READDMA
 0xC8

	)

213 
	#WIN_READDMA_ONCE
 0xC9

	)

214 
	#WIN_WRITEDMA
 0xCA

	)

215 
	#WIN_WRITEDMA_ONCE
 0xCB

	)

216 
	#WIN_WRITEDMA_QUEUED
 0xCC

	)

217 
	#CFA_WRITE_MULTI_WO_ERASE
 0xCD

	)

218 
	#WIN_GETMEDIASTATUS
 0xDA

	)

219 
	#WIN_ACKMEDIACHANGE
 0xDB

	)

220 
	#WIN_POSTBOOT
 0xDC

	)

221 
	#WIN_PREBOOT
 0xDD

	)

222 
	#WIN_DOORLOCK
 0xDE

	)

223 
	#WIN_DOORUNLOCK
 0xDF

	)

224 
	#WIN_STANDBYNOW1
 0xE0

	)

225 
	#WIN_IDLEIMMEDIATE
 0xE1

	)

226 
	#WIN_STANDBY
 0xE2

	)

227 
	#WIN_SETIDLE1
 0xE3

	)

228 
	#WIN_READ_BUFFER
 0xE4

	)

229 
	#WIN_CHECKPOWERMODE1
 0xE5

	)

230 
	#WIN_SLEEPNOW1
 0xE6

	)

231 
	#WIN_FLUSH_CACHE
 0xE7

	)

232 
	#WIN_WRITE_BUFFER
 0xE8

	)

233 
	#WIN_WRITE_SAME
 0xE9

	)

235 
	#WIN_FLUSH_CACHE_EXT
 0xEA

	)

236 
	#WIN_IDENTIFY
 0xEC

	)

237 
	#WIN_MEDIAEJECT
 0xED

	)

238 
	#WIN_IDENTIFY_DMA
 0xEE

	)

239 
	#WIN_SETFEATURES
 0xEF

	)

240 
	#EXABYTE_ENABLE_NEST
 0xF0

	)

241 
	#WIN_SECURITY_SET_PASS
 0xF1

	)

242 
	#WIN_SECURITY_UNLOCK
 0xF2

	)

243 
	#WIN_SECURITY_ERASE_PREPARE
 0xF3

	)

244 
	#WIN_SECURITY_ERASE_UNIT
 0xF4

	)

245 
	#WIN_SECURITY_FREEZE_LOCK
 0xF5

	)

246 
	#WIN_SECURITY_DISABLE
 0xF6

	)

247 
	#WIN_READ_NATIVE_MAX
 0xF8

	)

248 
	#WIN_SET_MAX
 0xF9

	)

249 
	#DISABLE_SEAGATE
 0xFB

	)

253 
	#SMART_READ_VALUES
 0xD0

	)

254 
	#SMART_READ_THRESHOLDS
 0xD1

	)

255 
	#SMART_AUTOSAVE
 0xD2

	)

256 
	#SMART_SAVE
 0xD3

	)

257 
	#SMART_IMMEDIATE_OFFLINE
 0xD4

	)

258 
	#SMART_READ_LOG_SECTOR
 0xD5

	)

259 
	#SMART_WRITE_LOG_SECTOR
 0xD6

	)

260 
	#SMART_WRITE_THRESHOLDS
 0xD7

	)

261 
	#SMART_ENABLE
 0xD8

	)

262 
	#SMART_DISABLE
 0xD9

	)

263 
	#SMART_STATUS
 0xDA

	)

264 
	#SMART_AUTO_OFFLINE
 0xDB

	)

268 
	#SMART_LCYL_PASS
 0x4F

	)

269 
	#SMART_HCYL_PASS
 0xC2

	)

272 
	#SETFEATURES_EN_8BIT
 0x01

	)

273 
	#SETFEATURES_EN_WCACHE
 0x02

	)

274 
	#SETFEATURES_DIS_DEFECT
 0x04

	)

275 
	#SETFEATURES_EN_APM
 0x05

	)

276 
	#SETFEATURES_EN_SAME_R
 0x22

	)

277 
	#SETFEATURES_DIS_MSN
 0x31

	)

278 
	#SETFEATURES_DIS_RETRY
 0x33

	)

279 
	#SETFEATURES_EN_AAM
 0x42

	)

280 
	#SETFEATURES_RW_LONG
 0x44

	)

281 
	#SETFEATURES_SET_CACHE
 0x54

	)

282 
	#SETFEATURES_DIS_RLA
 0x55

	)

283 
	#SETFEATURES_EN_RI
 0x5D

	)

284 
	#SETFEATURES_EN_SI
 0x5E

	)

285 
	#SETFEATURES_DIS_RPOD
 0x66

	)

286 
	#SETFEATURES_DIS_ECC
 0x77

	)

287 
	#SETFEATURES_DIS_8BIT
 0x81

	)

288 
	#SETFEATURES_DIS_WCACHE
 0x82

	)

289 
	#SETFEATURES_EN_DEFECT
 0x84

	)

290 
	#SETFEATURES_DIS_APM
 0x85

	)

291 
	#SETFEATURES_EN_ECC
 0x88

	)

292 
	#SETFEATURES_EN_MSN
 0x95

	)

293 
	#SETFEATURES_EN_RETRY
 0x99

	)

294 
	#SETFEATURES_EN_RLA
 0xAA

	)

295 
	#SETFEATURES_PREFETCH
 0xAB

	)

296 
	#SETFEATURES_EN_REST
 0xAC

	)

297 
	#SETFEATURES_4B_RW_LONG
 0xBB

	)

298 
	#SETFEATURES_DIS_AAM
 0xC2

	)

299 
	#SETFEATURES_EN_RPOD
 0xCC

	)

300 
	#SETFEATURES_DIS_RI
 0xDD

	)

301 
	#SETFEATURES_EN_SAME_M
 0xDD

	)

302 
	#SETFEATURES_DIS_SI
 0xDE

	)

306 
	#SECURITY_SET_PASSWORD
 0xBA

	)

307 
	#SECURITY_UNLOCK
 0xBB

	)

308 
	#SECURITY_ERASE_PREPARE
 0xBC

	)

309 
	#SECURITY_ERASE_UNIT
 0xBD

	)

310 
	#SECURITY_FREEZE_LOCK
 0xBE

	)

311 
	#SECURITY_DISABLE_PASSWORD
 0xBF

	)

313 
	shd_geomëry
 {

314 
	mhóds
;

315 
	m£˘‹s
;

316 
	mcylödîs
;

317 
	m°¨t
;

321 
	#HDIO_GETGEO
 0x0301

	)

322 
	#HDIO_GET_UNMASKINTR
 0x0302

	)

323 
	#HDIO_GET_MULTCOUNT
 0x0304

	)

324 
	#HDIO_GET_QDMA
 0x0305

	)

326 
	#HDIO_SET_XFER
 0x0306

	)

328 
	#HDIO_OBSOLETE_IDENTITY
 0x0307

	)

329 
	#HDIO_GET_KEEPSETTINGS
 0x0308

	)

330 
	#HDIO_GET_32BIT
 0x0309

	)

331 
	#HDIO_GET_NOWERR
 0x030®

	)

332 
	#HDIO_GET_DMA
 0x030b

	)

333 
	#HDIO_GET_NICE
 0x030¯

	)

334 
	#HDIO_GET_IDENTITY
 0x030d

	)

335 
	#HDIO_GET_WCACHE
 0x030ê

	)

336 
	#HDIO_GET_ACOUSTIC
 0x030‡

	)

337 
	#HDIO_GET_ADDRESS
 0x0310

	)

339 
	#HDIO_GET_BUSSTATE
 0x031®

	)

340 
	#HDIO_TRISTATE_HWIF
 0x031b

	)

341 
	#HDIO_DRIVE_RESET
 0x031¯

	)

342 
	#HDIO_DRIVE_TASKFILE
 0x031d

	)

343 
	#HDIO_DRIVE_TASK
 0x031ê

	)

344 
	#HDIO_DRIVE_CMD
 0x031‡

	)

345 
	#HDIO_DRIVE_CMD_AEB
 
HDIO_DRIVE_TASK


	)

348 
	#HDIO_SET_MULTCOUNT
 0x0321

	)

349 
	#HDIO_SET_UNMASKINTR
 0x0322

	)

350 
	#HDIO_SET_KEEPSETTINGS
 0x0323

	)

351 
	#HDIO_SET_32BIT
 0x0324

	)

352 
	#HDIO_SET_NOWERR
 0x0325

	)

353 
	#HDIO_SET_DMA
 0x0326

	)

354 
	#HDIO_SET_PIO_MODE
 0x0327

	)

355 
	#HDIO_SCAN_HWIF
 0x0328

	)

356 
	#HDIO_UNREGISTER_HWIF
 0x032®

	)

357 
	#HDIO_SET_NICE
 0x0329

	)

358 
	#HDIO_SET_WCACHE
 0x032b

	)

359 
	#HDIO_SET_ACOUSTIC
 0x032¯

	)

360 
	#HDIO_SET_BUSSTATE
 0x032d

	)

361 
	#HDIO_SET_QDMA
 0x032ê

	)

362 
	#HDIO_SET_ADDRESS
 0x032‡

	)

366 
	mBUSSTATE_OFF
 = 0,

367 
	mBUSSTATE_ON
,

368 
	mBUSSTATE_TRISTATE


377 
	#__NEW_HD_DRIVE_ID


	)

385 
	shd_driveid
 {

386 
	mc⁄fig
;

387 
	mcyls
;

388 
	mª£rved2
;

389 
	mhóds
;

390 
	måack_byãs
;

391 
	m£˘‹_byãs
;

392 
	m£˘‹s
;

393 
	mvíd‹0
;

394 
	mvíd‹1
;

395 
	mvíd‹2
;

396 
	m£rül_no
[20];

397 
	mbuf_ty≥
;

398 
	mbuf_size
;

401 
	mecc_byãs
;

402 
	mfw_ªv
[8];

403 
	mmodñ
[40];

404 
	mmax_mu…£˘
;

405 
	mvíd‹3
;

406 
	mdw‹d_io
;

407 
	mvíd‹4
;

408 
	mˇ∑bûôy
;

414 
	mª£rved50
;

415 
	mvíd‹5
;

416 
	mtPIO
;

417 
	mvíd‹6
;

418 
	mtDMA
;

419 
	mfõld_vÆid
;

424 
	mcur_cyls
;

425 
	mcur_hóds
;

426 
	mcur_£˘‹s
;

427 
	mcur_ˇ∑côy0
;

428 
	mcur_ˇ∑côy1
;

429 
	mmu…£˘
;

430 
	mmu…£˘_vÆid
;

431 
	mlba_ˇ∑côy
;

432 
	mdma_1w‹d
;

433 
	mdma_mw‹d
;

434 
	meide_pio_modes
;

435 
	meide_dma_mö
;

436 
	meide_dma_time
;

437 
	meide_pio
;

438 
	meide_pio_i‹dy
;

439 
	mw‹ds69_70
[2];

442 
	mw‹ds71_74
[4];

445 
	mqueue_dïth
;

449 
	mw‹ds76_79
[4];

450 
	mmaj‹_ªv_num
;

451 
	mmö‹_ªv_num
;

452 
	mcomm™d_£t_1
;

470 
	mcomm™d_£t_2
;

488 
	mcfs£
;

500 
	mcfs_íabÀ_1
;

519 
	mcfs_íabÀ_2
;

538 
	mcsf_deÁu…
;

550 
	mdma_u…ø
;

551 
	må£uc
;

552 
	måsEuc
;

553 
	mCurAPMvÆues
;

554 
	mm¥c
;

555 
	mhw_c⁄fig
;

573 
	macou°ic
;

577 
	mm§qs
;

578 
	msx„π
;

579 
	mßl
;

580 
	m•g
;

581 
	mlba_ˇ∑côy_2
;

582 
	mw‹ds104_125
[22];

583 
	mœ°_lun
;

584 
	mw‹d127
;

592 
	mdlf
;

604 
	mcsfo
;

612 
	mw‹ds130_155
[26];

613 
	mw‹d156
;

614 
	mw‹ds157_159
[3];

615 
	mcÁ_powî
;

622 
	mw‹ds161_175
[15];

623 
	mw‹ds176_205
[30];

624 
	mw‹ds206_254
[49];

625 
	möãgrôy_w‹d
;

636 
	#IDE_NICE_DSC_OVERLAP
 (0Ë

	)

637 
	#IDE_NICE_ATAPI_OVERLAP
 (1Ë

	)

638 
	#IDE_NICE_1
 (3Ë

	)

639 
	#IDE_NICE_0
 (2Ë

	)

640 
	#IDE_NICE_2
 (4Ë

	)

	@/usr/include/linux/kdev_t.h

1 #i‚de‡
_LINUX_KDEV_T_H


2 
	#_LINUX_KDEV_T_H


	)

8 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

9 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

10 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

1 #i‚de‡
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<löux/sysöfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

	@/usr/include/linux/poll.h

1 
	~<asm/pﬁl.h
>

	@/usr/include/linux/raid/md_p.h

15 #i‚de‡
_MD_P_H


16 
	#_MD_P_H


	)

18 
	~<löux/ty≥s.h
>

19 
	~<asm/byã‹dî.h
>

47 
	#MD_RESERVED_BYTES
 (64 * 1024)

	)

48 
	#MD_RESERVED_SECTORS
 (
MD_RESERVED_BYTES
 / 512)

	)

50 
	#MD_NEW_SIZE_SECTORS
(
x
Ë((x & ~(
MD_RESERVED_SECTORS
 - 1)Ë- MD_RESERVED_SECTORS)

	)

52 
	#MD_SB_BYTES
 4096

	)

53 
	#MD_SB_WORDS
 (
MD_SB_BYTES
 / 4)

	)

54 
	#MD_SB_SECTORS
 (
MD_SB_BYTES
 / 512)

	)

59 
	#MD_SB_GENERIC_OFFSET
 0

	)

60 
	#MD_SB_PERSONALITY_OFFSET
 64

	)

61 
	#MD_SB_DISKS_OFFSET
 128

	)

62 
	#MD_SB_DESCRIPTOR_OFFSET
 992

	)

64 
	#MD_SB_GENERIC_CONSTANT_WORDS
 32

	)

65 
	#MD_SB_GENERIC_STATE_WORDS
 32

	)

66 
	#MD_SB_GENERIC_WORDS
 (
MD_SB_GENERIC_CONSTANT_WORDS
 + 
MD_SB_GENERIC_STATE_WORDS
)

	)

67 
	#MD_SB_PERSONALITY_WORDS
 64

	)

68 
	#MD_SB_DESCRIPTOR_WORDS
 32

	)

69 
	#MD_SB_DISKS
 27

	)

70 
	#MD_SB_DISKS_WORDS
 (
MD_SB_DISKS
*
MD_SB_DESCRIPTOR_WORDS
)

	)

71 
	#MD_SB_RESERVED_WORDS
 (1024 - 
MD_SB_GENERIC_WORDS
 - 
MD_SB_PERSONALITY_WORDS
 - 
MD_SB_DISKS_WORDS
 - 
MD_SB_DESCRIPTOR_WORDS
)

	)

72 
	#MD_SB_EQUAL_WORDS
 (
MD_SB_GENERIC_WORDS
 + 
MD_SB_PERSONALITY_WORDS
 + 
MD_SB_DISKS_WORDS
)

	)

77 
	#MD_DISK_FAULTY
 0

	)

78 
	#MD_DISK_ACTIVE
 1

	)

79 
	#MD_DISK_SYNC
 2

	)

80 
	#MD_DISK_REMOVED
 3

	)

82 
	#MD_DISK_WRITEMOSTLY
 9

	)

87 
	smdp_devi˚_des¸ùt‹_s
 {

88 
__u32
 
	mnumbî
;

89 
__u32
 
	mmaj‹
;

90 
__u32
 
	mmö‹
;

91 
__u32
 
	møid_disk
;

92 
__u32
 
	m°©e
;

93 
__u32
 
	mª£rved
[
MD_SB_DESCRIPTOR_WORDS
 - 5];

94 } 
	tmdp_disk_t
;

96 
	#MD_SB_MAGIC
 0xa92b4efc

	)

101 
	#MD_SB_CLEAN
 0

	)

102 
	#MD_SB_ERRORS
 1

	)

104 
	#MD_SB_BITMAP_PRESENT
 8

	)

117 
	smdp_su≥rblock_s
 {

121 
__u32
 
	mmd_magic
;

122 
__u32
 
	mmaj‹_vîsi⁄
;

123 
__u32
 
	mmö‹_vîsi⁄
;

124 
__u32
 
	m∑tch_vîsi⁄
;

125 
__u32
 
	mgvÆid_w‹ds
;

126 
__u32
 
	m£t_uuid0
;

127 
__u32
 
	m˘ime
;

128 
__u32
 
	mÀvñ
;

129 
__u32
 
	msize
;

130 
__u32
 
	mƒ_disks
;

131 
__u32
 
	møid_disks
;

132 
__u32
 
	mmd_mö‹
;

133 
__u32
 
	mnŸ_≥rsi°ít
;

134 
__u32
 
	m£t_uuid1
;

135 
__u32
 
	m£t_uuid2
;

136 
__u32
 
	m£t_uuid3
;

137 
__u32
 
	mg°©e_¸e£rved
[
MD_SB_GENERIC_CONSTANT_WORDS
 - 16];

142 
__u32
 
	mutime
;

143 
__u32
 
	m°©e
;

144 
__u32
 
	ma˘ive_disks
;

145 
__u32
 
	mw‹kög_disks
;

146 
__u32
 
	mÁûed_disks
;

147 
__u32
 
	m•¨e_disks
;

148 
__u32
 
	msb_csum
;

149 #i‡
deföed
(
__BYTE_ORDER
Ë? __BYTE_ORDER =
__BIG_ENDIAN
 : defined(__BIG_ENDIAN)

150 
__u32
 
	mevíts_hi
;

151 
__u32
 
	mevíts_lo
;

152 
__u32
 
	m˝_evíts_hi
;

153 
__u32
 
	m˝_evíts_lo
;

154 #ñi‡
deföed
(
__BYTE_ORDER
Ë? __BYTE_ORDER =
__LITTLE_ENDIAN
 : defined(__LITTLE_ENDIAN)

155 
__u32
 
	mevíts_lo
;

156 
__u32
 
	mevíts_hi
;

157 
__u32
 
	m˝_evíts_lo
;

158 
__u32
 
	m˝_evíts_hi
;

160 #îr‹ 
un•ecifõd
 
ídü¬ess


162 
__u32
 
	mªcovîy_˝
;

164 
__u64
 
	mªsh≠e_posôi⁄
;

165 
__u32
 
	m√w_Àvñ
;

166 
__u32
 
	mdñè_disks
;

167 
__u32
 
	m√w_œyout
;

168 
__u32
 
	m√w_chunk
;

169 
__u32
 
	mg°©e_§e£rved
[
MD_SB_GENERIC_STATE_WORDS
 - 18];

174 
__u32
 
	mœyout
;

175 
__u32
 
	mchunk_size
;

176 
__u32
 
	mroŸ_pv
;

177 
__u32
 
	mroŸ_block
;

178 
__u32
 
	mp°©e_ª£rved
[
MD_SB_PERSONALITY_WORDS
 - 4];

183 
mdp_disk_t
 
	mdisks
[
MD_SB_DISKS
];

188 
__u32
 
	mª£rved
[
MD_SB_RESERVED_WORDS
];

193 
mdp_disk_t
 
	mthis_disk
;

195 } 
	tmdp_su≥r_t
;

197 
__ölöe__
 
__u64
 
	$md_evít
(
mdp_su≥r_t
 *
sb
) {

198 
__u64
 
ev
 = 
sb
->
evíts_hi
;

199  (
ev
<<32)| 
sb
->
evíts_lo
;

200 
	}
}

202 
	#MD_SUPERBLOCK_1_TIME_SEC_MASK
 ((1ULL<<40Ë- 1)

	)

211 
	smdp_su≥rblock_1
 {

213 
__À32
 
	mmagic
;

214 
__À32
 
	mmaj‹_vîsi⁄
;

215 
__À32
 
	m„©uª_m≠
;

216 
__À32
 
	m∑d0
;

218 
__u8
 
	m£t_uuid
[16];

219 
	m£t_«me
[32];

221 
__À64
 
	m˘ime
;

222 
__À32
 
	mÀvñ
;

223 
__À32
 
	mœyout
;

224 
__À64
 
	msize
;

226 
__À32
 
	mchunksize
;

227 
__À32
 
	møid_disks
;

228 
__À32
 
	mbôm≠_off£t
;

234 
__À32
 
	m√w_Àvñ
;

235 
__À64
 
	mªsh≠e_posôi⁄
;

236 
__À32
 
	mdñè_disks
;

237 
__À32
 
	m√w_œyout
;

238 
__À32
 
	m√w_chunk
;

239 
__À32
 
	m√w_off£t
;

245 
__À64
 
	md©a_off£t
;

246 
__À64
 
	md©a_size
;

247 
__À64
 
	msu≥r_off£t
;

248 
__À64
 
	mªcovîy_off£t
;

249 
__À32
 
	mdev_numbî
;

250 
__À32
 
	m˙t_c‹ª˘ed_ªad
;

251 
__u8
 
	mdevi˚_uuid
[16];

252 
__u8
 
	mdevÊags
;

253 
	#WrôeMo°ly1
 1

	)

257 
__u8
 
	mbblog_shi·
;

258 
__À16
 
	mbblog_size
;

259 
__À32
 
	mbblog_off£t
;

263 
__À64
 
	mutime
;

264 
__À64
 
	mevíts
;

265 
__À64
 
	mªsync_off£t
;

266 
__À32
 
	msb_csum
;

267 
__À32
 
	mmax_dev
;

268 
__u8
 
	m∑d3
[64-32];

276 
__À16
 
	mdev_rﬁes
[0];

280 
	#MD_FEATURE_BITMAP_OFFSET
 1

	)

281 
	#MD_FEATURE_RECOVERY_OFFSET
 2

	)

284 
	#MD_FEATURE_RESHAPE_ACTIVE
 4

	)

285 
	#MD_FEATURE_BAD_BLOCKS
 8

	)

286 
	#MD_FEATURE_REPLACEMENT
 16

	)

290 
	#MD_FEATURE_RESHAPE_BACKWARDS
 32

	)

294 
	#MD_FEATURE_NEW_OFFSET
 64

	)

295 
	#MD_FEATURE_ALL
 (
MD_FEATURE_BITMAP_OFFSET
 \

296 |
MD_FEATURE_RECOVERY_OFFSET
 \

297 |
MD_FEATURE_RESHAPE_ACTIVE
 \

298 |
MD_FEATURE_BAD_BLOCKS
 \

299 |
MD_FEATURE_REPLACEMENT
 \

300 |
MD_FEATURE_RESHAPE_BACKWARDS
 \

301 |
MD_FEATURE_NEW_OFFSET
 \

302 )

	)

	@/usr/include/linux/raid/md_u.h

15 #i‚de‡
_MD_U_H


16 
	#_MD_U_H


	)

23 
	#MD_MAJOR_VERSION
 0

	)

24 
	#MD_MINOR_VERSION
 90

	)

34 
	#MD_PATCHLEVEL_VERSION
 3

	)

39 
	#RAID_VERSION
 
	`_IOR
 (
MD_MAJOR
, 0x10, 
mdu_vîsi⁄_t
)

	)

40 
	#GET_ARRAY_INFO
 
	`_IOR
 (
MD_MAJOR
, 0x11, 
mdu_¨øy_öfo_t
)

	)

41 
	#GET_DISK_INFO
 
	`_IOR
 (
MD_MAJOR
, 0x12, 
mdu_disk_öfo_t
)

	)

42 
	#PRINT_RAID_DEBUG
 
	`_IO
 (
MD_MAJOR
, 0x13)

	)

43 
	#RAID_AUTORUN
 
	`_IO
 (
MD_MAJOR
, 0x14)

	)

44 
	#GET_BITMAP_FILE
 
	`_IOR
 (
MD_MAJOR
, 0x15, 
mdu_bôm≠_fûe_t
)

	)

47 
	#CLEAR_ARRAY
 
	`_IO
 (
MD_MAJOR
, 0x20)

	)

48 
	#ADD_NEW_DISK
 
	`_IOW
 (
MD_MAJOR
, 0x21, 
mdu_disk_öfo_t
)

	)

49 
	#HOT_REMOVE_DISK
 
	`_IO
 (
MD_MAJOR
, 0x22)

	)

50 
	#SET_ARRAY_INFO
 
	`_IOW
 (
MD_MAJOR
, 0x23, 
mdu_¨øy_öfo_t
)

	)

51 
	#SET_DISK_INFO
 
	`_IO
 (
MD_MAJOR
, 0x24)

	)

52 
	#WRITE_RAID_INFO
 
	`_IO
 (
MD_MAJOR
, 0x25)

	)

53 
	#UNPROTECT_ARRAY
 
	`_IO
 (
MD_MAJOR
, 0x26)

	)

54 
	#PROTECT_ARRAY
 
	`_IO
 (
MD_MAJOR
, 0x27)

	)

55 
	#HOT_ADD_DISK
 
	`_IO
 (
MD_MAJOR
, 0x28)

	)

56 
	#SET_DISK_FAULTY
 
	`_IO
 (
MD_MAJOR
, 0x29)

	)

57 
	#HOT_GENERATE_ERROR
 
	`_IO
 (
MD_MAJOR
, 0x2a)

	)

58 
	#SET_BITMAP_FILE
 
	`_IOW
 (
MD_MAJOR
, 0x2b, )

	)

61 
	#RUN_ARRAY
 
	`_IOW
 (
MD_MAJOR
, 0x30, 
mdu_∑øm_t
)

	)

63 
	#STOP_ARRAY
 
	`_IO
 (
MD_MAJOR
, 0x32)

	)

64 
	#STOP_ARRAY_RO
 
	`_IO
 (
MD_MAJOR
, 0x33)

	)

65 
	#RESTART_ARRAY_RW
 
	`_IO
 (
MD_MAJOR
, 0x34)

	)

68 
	#MdpMö‹Shi·
 6

	)

70 
	smdu_vîsi⁄_s
 {

71 
	mmaj‹
;

72 
	mmö‹
;

73 
	m∑tchÀvñ
;

74 } 
	tmdu_vîsi⁄_t
;

76 
	smdu_¨øy_öfo_s
 {

80 
	mmaj‹_vîsi⁄
;

81 
	mmö‹_vîsi⁄
;

82 
	m∑tch_vîsi⁄
;

83 
	m˘ime
;

84 
	mÀvñ
;

85 
	msize
;

86 
	mƒ_disks
;

87 
	møid_disks
;

88 
	mmd_mö‹
;

89 
	mnŸ_≥rsi°ít
;

94 
	mutime
;

95 
	m°©e
;

96 
	ma˘ive_disks
;

97 
	mw‹kög_disks
;

98 
	mÁûed_disks
;

99 
	m•¨e_disks
;

104 
	mœyout
;

105 
	mchunk_size
;

107 } 
	tmdu_¨øy_öfo_t
;

110 
	#LEVEL_MULTIPATH
 (-4)

	)

111 
	#LEVEL_LINEAR
 (-1)

	)

112 
	#LEVEL_FAULTY
 (-5)

	)

118 
	#LEVEL_NONE
 (-1000000)

	)

120 
	smdu_disk_öfo_s
 {

124 
	mnumbî
;

125 
	mmaj‹
;

126 
	mmö‹
;

127 
	møid_disk
;

128 
	m°©e
;

130 } 
	tmdu_disk_öfo_t
;

132 
	smdu_°¨t_öfo_s
 {

136 
	mmaj‹
;

137 
	mmö‹
;

138 
	møid_disk
;

139 
	m°©e
;

141 } 
	tmdu_°¨t_öfo_t
;

143 
	smdu_bôm≠_fûe_s


145 
	m∑th«me
[4096];

146 } 
	tmdu_bôm≠_fûe_t
;

148 
	smdu_∑øm_s


150 
	m≥rs⁄Æôy
;

151 
	mchunk_size
;

152 
	mmax_Áu…
;

153 } 
	tmdu_∑øm_t
;

	@/usr/include/linux/random.h

7 #i‚de‡
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<löux/ty≥s.h
>

11 
	~<löux/io˘l.h
>

12 
	~<löux/úqƒ.h
>

17 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

20 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

23 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

29 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

32 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

35 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

37 
	sønd_poﬁ_öfo
 {

38 
	míå›y_cou¡
;

39 
	mbuf_size
;

40 
__u32
 
	mbuf
[0];

	@/usr/include/linux/reboot.h

1 #i‚de‡
_LINUX_REBOOT_H


2 
	#_LINUX_REBOOT_H


	)

8 
	#LINUX_REBOOT_MAGIC1
 0x„e1dód

	)

9 
	#LINUX_REBOOT_MAGIC2
 672274793

	)

10 
	#LINUX_REBOOT_MAGIC2A
 85072278

	)

11 
	#LINUX_REBOOT_MAGIC2B
 369367448

	)

12 
	#LINUX_REBOOT_MAGIC2C
 537993216

	)

28 
	#LINUX_REBOOT_CMD_RESTART
 0x01234567

	)

29 
	#LINUX_REBOOT_CMD_HALT
 0xCDEF0123

	)

30 
	#LINUX_REBOOT_CMD_CAD_ON
 0x89ABCDEF

	)

31 
	#LINUX_REBOOT_CMD_CAD_OFF
 0x00000000

	)

32 
	#LINUX_REBOOT_CMD_POWER_OFF
 0x4321FEDC

	)

33 
	#LINUX_REBOOT_CMD_RESTART2
 0xA1B2C3D4

	)

34 
	#LINUX_REBOOT_CMD_SW_SUSPEND
 0xD000FCE2

	)

35 
	#LINUX_REBOOT_CMD_KEXEC
 0x45584543

	)

	@/usr/include/linux/sched.h

1 #i‚de‡
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000f‡

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/string.h

1 #i‚de‡
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<°rög.h
>

	@/usr/include/linux/sysctl.h

22 #i‚de‡
_LINUX_SYSCTL_H


23 
	#_LINUX_SYSCTL_H


	)

25 
	~<löux/kî√l.h
>

26 
	~<löux/ty≥s.h
>

29 
	gcom∂ëi⁄
;

31 
	#CTL_MAXNAME
 10

	)

36 
	s__sys˘l_¨gs
 {

37 *
	m«me
;

38 
	m∆í
;

39 *
	mﬁdvÆ
;

40 
size_t
 *
	mﬁdÀ≈
;

41 *
	m√wvÆ
;

42 
size_t
 
	m√wÀn
;

43 
	m__unu£d
[4];

52 
	mCTL_KERN
=1,

53 
	mCTL_VM
=2,

54 
	mCTL_NET
=3,

55 
	mCTL_PROC
=4,

56 
	mCTL_FS
=5,

57 
	mCTL_DEBUG
=6,

58 
	mCTL_DEV
=7,

59 
	mCTL_BUS
=8,

60 
	mCTL_ABI
=9,

61 
	mCTL_CPU
=10,

62 
	mCTL_ARLAN
=254,

63 
	mCTL_S390DBF
=5677,

64 
	mCTL_SUNRPC
=7249,

65 
	mCTL_PM
=9899,

66 
	mCTL_FRV
=9898,

72 
	mCTL_BUS_ISA
=1

78 
	mINOTIFY_MAX_USER_INSTANCES
=1,

79 
	mINOTIFY_MAX_USER_WATCHES
=2,

80 
	mINOTIFY_MAX_QUEUED_EVENTS
=3

86 
	mKERN_OSTYPE
=1,

87 
	mKERN_OSRELEASE
=2,

88 
	mKERN_OSREV
=3,

89 
	mKERN_VERSION
=4,

90 
	mKERN_SECUREMASK
=5,

91 
	mKERN_PROF
=6,

92 
	mKERN_NODENAME
=7,

93 
	mKERN_DOMAINNAME
=8,

95 
	mKERN_PANIC
=15,

96 
	mKERN_REALROOTDEV
=16,

98 
	mKERN_SPARC_REBOOT
=21,

99 
	mKERN_CTLALTDEL
=22,

100 
	mKERN_PRINTK
=23,

101 
	mKERN_NAMETRANS
=24,

102 
	mKERN_PPC_HTABRECLAIM
=25,

103 
	mKERN_PPC_ZEROPAGED
=26,

104 
	mKERN_PPC_POWERSAVE_NAP
=27,

105 
	mKERN_MODPROBE
=28,

106 
	mKERN_SG_BIG_BUFF
=29,

107 
	mKERN_ACCT
=30,

108 
	mKERN_PPC_L2CR
=31,

110 
	mKERN_RTSIGNR
=32,

111 
	mKERN_RTSIGMAX
=33,

113 
	mKERN_SHMMAX
=34,

114 
	mKERN_MSGMAX
=35,

115 
	mKERN_MSGMNB
=36,

116 
	mKERN_MSGPOOL
=37,

117 
	mKERN_SYSRQ
=38,

118 
	mKERN_MAX_THREADS
=39,

119 
	mKERN_RANDOM
=40,

120 
	mKERN_SHMALL
=41,

121 
	mKERN_MSGMNI
=42,

122 
	mKERN_SEM
=43,

123 
	mKERN_SPARC_STOP_A
=44,

124 
	mKERN_SHMMNI
=45,

125 
	mKERN_OVERFLOWUID
=46,

126 
	mKERN_OVERFLOWGID
=47,

127 
	mKERN_SHMPATH
=48,

128 
	mKERN_HOTPLUG
=49,

129 
	mKERN_IEEE_EMULATION_WARNINGS
=50,

130 
	mKERN_S390_USER_DEBUG_LOGGING
=51,

131 
	mKERN_CORE_USES_PID
=52,

132 
	mKERN_TAINTED
=53,

133 
	mKERN_CADPID
=54,

134 
	mKERN_PIDMAX
=55,

135 
	mKERN_CORE_PATTERN
=56,

136 
	mKERN_PANIC_ON_OOPS
=57,

137 
	mKERN_HPPA_PWRSW
=58,

138 
	mKERN_HPPA_UNALIGNED
=59,

139 
	mKERN_PRINTK_RATELIMIT
=60,

140 
	mKERN_PRINTK_RATELIMIT_BURST
=61,

141 
	mKERN_PTY
=62,

142 
	mKERN_NGROUPS_MAX
=63,

143 
	mKERN_SPARC_SCONS_PWROFF
=64,

144 
	mKERN_HZ_TIMER
=65,

145 
	mKERN_UNKNOWN_NMI_PANIC
=66,

146 
	mKERN_BOOTLOADER_TYPE
=67,

147 
	mKERN_RANDOMIZE
=68,

148 
	mKERN_SETUID_DUMPABLE
=69,

149 
	mKERN_SPIN_RETRY
=70,

150 
	mKERN_ACPI_VIDEO_FLAGS
=71,

151 
	mKERN_IA64_UNALIGNED
=72,

152 
	mKERN_COMPAT_LOG
=73,

153 
	mKERN_MAX_LOCK_DEPTH
=74,

154 
	mKERN_NMI_WATCHDOG
=75,

155 
	mKERN_PANIC_ON_NMI
=76,

163 
	mVM_UNUSED1
=1,

164 
	mVM_UNUSED2
=2,

165 
	mVM_UNUSED3
=3,

166 
	mVM_UNUSED4
=4,

167 
	mVM_OVERCOMMIT_MEMORY
=5,

168 
	mVM_UNUSED5
=6,

169 
	mVM_UNUSED7
=7,

170 
	mVM_UNUSED8
=8,

171 
	mVM_UNUSED9
=9,

172 
	mVM_PAGE_CLUSTER
=10,

173 
	mVM_DIRTY_BACKGROUND
=11,

174 
	mVM_DIRTY_RATIO
=12,

175 
	mVM_DIRTY_WB_CS
=13,

176 
	mVM_DIRTY_EXPIRE_CS
=14,

177 
	mVM_NR_PDFLUSH_THREADS
=15,

178 
	mVM_OVERCOMMIT_RATIO
=16,

179 
	mVM_PAGEBUF
=17,

180 
	mVM_HUGETLB_PAGES
=18,

181 
	mVM_SWAPPINESS
=19,

182 
	mVM_LOWMEM_RESERVE_RATIO
=20,

183 
	mVM_MIN_FREE_KBYTES
=21,

184 
	mVM_MAX_MAP_COUNT
=22,

185 
	mVM_LAPTOP_MODE
=23,

186 
	mVM_BLOCK_DUMP
=24,

187 
	mVM_HUGETLB_GROUP
=25,

188 
	mVM_VFS_CACHE_PRESSURE
=26,

189 
	mVM_LEGACY_VA_LAYOUT
=27,

190 
	mVM_SWAP_TOKEN_TIMEOUT
=28,

191 
	mVM_DROP_PAGECACHE
=29,

192 
	mVM_PERCPU_PAGELIST_FRACTION
=30,

193 
	mVM_ZONE_RECLAIM_MODE
=31,

194 
	mVM_MIN_UNMAPPED
=32,

195 
	mVM_PANIC_ON_OOM
=33,

196 
	mVM_VDSO_ENABLED
=34,

197 
	mVM_MIN_SLAB
=35,

204 
	mNET_CORE
=1,

205 
	mNET_ETHER
=2,

206 
	mNET_802
=3,

207 
	mNET_UNIX
=4,

208 
	mNET_IPV4
=5,

209 
	mNET_IPX
=6,

210 
	mNET_ATALK
=7,

211 
	mNET_NETROM
=8,

212 
	mNET_AX25
=9,

213 
	mNET_BRIDGE
=10,

214 
	mNET_ROSE
=11,

215 
	mNET_IPV6
=12,

216 
	mNET_X25
=13,

217 
	mNET_TR
=14,

218 
	mNET_DECNET
=15,

219 
	mNET_ECONET
=16,

220 
	mNET_SCTP
=17,

221 
	mNET_LLC
=18,

222 
	mNET_NETFILTER
=19,

223 
	mNET_DCCP
=20,

224 
	mNET_IRDA
=412,

230 
	mRANDOM_POOLSIZE
=1,

231 
	mRANDOM_ENTROPY_COUNT
=2,

232 
	mRANDOM_READ_THRESH
=3,

233 
	mRANDOM_WRITE_THRESH
=4,

234 
	mRANDOM_BOOT_ID
=5,

235 
	mRANDOM_UUID
=6

241 
	mPTY_MAX
=1,

242 
	mPTY_NR
=2

248 
	mBUS_ISA_MEM_BASE
=1,

249 
	mBUS_ISA_PORT_BASE
=2,

250 
	mBUS_ISA_PORT_SHIFT
=3

256 
	mNET_CORE_WMEM_MAX
=1,

257 
	mNET_CORE_RMEM_MAX
=2,

258 
	mNET_CORE_WMEM_DEFAULT
=3,

259 
	mNET_CORE_RMEM_DEFAULT
=4,

261 
	mNET_CORE_MAX_BACKLOG
=6,

262 
	mNET_CORE_FASTROUTE
=7,

263 
	mNET_CORE_MSG_COST
=8,

264 
	mNET_CORE_MSG_BURST
=9,

265 
	mNET_CORE_OPTMEM_MAX
=10,

266 
	mNET_CORE_HOT_LIST_LENGTH
=11,

267 
	mNET_CORE_DIVERT_VERSION
=12,

268 
	mNET_CORE_NO_CONG_THRESH
=13,

269 
	mNET_CORE_NO_CONG
=14,

270 
	mNET_CORE_LO_CONG
=15,

271 
	mNET_CORE_MOD_CONG
=16,

272 
	mNET_CORE_DEV_WEIGHT
=17,

273 
	mNET_CORE_SOMAXCONN
=18,

274 
	mNET_CORE_BUDGET
=19,

275 
	mNET_CORE_AEVENT_ETIME
=20,

276 
	mNET_CORE_AEVENT_RSEQTH
=21,

277 
	mNET_CORE_WARNINGS
=22,

288 
	mNET_UNIX_DESTROY_DELAY
=1,

289 
	mNET_UNIX_DELETE_DELAY
=2,

290 
	mNET_UNIX_MAX_DGRAM_QLEN
=3,

296 
	mNET_NF_CONNTRACK_MAX
=1,

297 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_SYN_SENT
=2,

298 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_SYN_RECV
=3,

299 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_ESTABLISHED
=4,

300 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_FIN_WAIT
=5,

301 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_CLOSE_WAIT
=6,

302 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_LAST_ACK
=7,

303 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_TIME_WAIT
=8,

304 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_CLOSE
=9,

305 
	mNET_NF_CONNTRACK_UDP_TIMEOUT
=10,

306 
	mNET_NF_CONNTRACK_UDP_TIMEOUT_STREAM
=11,

307 
	mNET_NF_CONNTRACK_ICMP_TIMEOUT
=12,

308 
	mNET_NF_CONNTRACK_GENERIC_TIMEOUT
=13,

309 
	mNET_NF_CONNTRACK_BUCKETS
=14,

310 
	mNET_NF_CONNTRACK_LOG_INVALID
=15,

311 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_MAX_RETRANS
=16,

312 
	mNET_NF_CONNTRACK_TCP_LOOSE
=17,

313 
	mNET_NF_CONNTRACK_TCP_BE_LIBERAL
=18,

314 
	mNET_NF_CONNTRACK_TCP_MAX_RETRANS
=19,

315 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_CLOSED
=20,

316 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_WAIT
=21,

317 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_ECHOED
=22,

318 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_ESTABLISHED
=23,

319 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_SENT
=24,

320 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_RECD
=25,

321 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_ACK_SENT
=26,

322 
	mNET_NF_CONNTRACK_COUNT
=27,

323 
	mNET_NF_CONNTRACK_ICMPV6_TIMEOUT
=28,

324 
	mNET_NF_CONNTRACK_FRAG6_TIMEOUT
=29,

325 
	mNET_NF_CONNTRACK_FRAG6_LOW_THRESH
=30,

326 
	mNET_NF_CONNTRACK_FRAG6_HIGH_THRESH
=31,

327 
	mNET_NF_CONNTRACK_CHECKSUM
=32,

334 
	mNET_IPV4_FORWARD
=8,

335 
	mNET_IPV4_DYNADDR
=9,

337 
	mNET_IPV4_CONF
=16,

338 
	mNET_IPV4_NEIGH
=17,

339 
	mNET_IPV4_ROUTE
=18,

340 
	mNET_IPV4_FIB_HASH
=19,

341 
	mNET_IPV4_NETFILTER
=20,

343 
	mNET_IPV4_TCP_TIMESTAMPS
=33,

344 
	mNET_IPV4_TCP_WINDOW_SCALING
=34,

345 
	mNET_IPV4_TCP_SACK
=35,

346 
	mNET_IPV4_TCP_RETRANS_COLLAPSE
=36,

347 
	mNET_IPV4_DEFAULT_TTL
=37,

348 
	mNET_IPV4_AUTOCONFIG
=38,

349 
	mNET_IPV4_NO_PMTU_DISC
=39,

350 
	mNET_IPV4_TCP_SYN_RETRIES
=40,

351 
	mNET_IPV4_IPFRAG_HIGH_THRESH
=41,

352 
	mNET_IPV4_IPFRAG_LOW_THRESH
=42,

353 
	mNET_IPV4_IPFRAG_TIME
=43,

354 
	mNET_IPV4_TCP_MAX_KA_PROBES
=44,

355 
	mNET_IPV4_TCP_KEEPALIVE_TIME
=45,

356 
	mNET_IPV4_TCP_KEEPALIVE_PROBES
=46,

357 
	mNET_IPV4_TCP_RETRIES1
=47,

358 
	mNET_IPV4_TCP_RETRIES2
=48,

359 
	mNET_IPV4_TCP_FIN_TIMEOUT
=49,

360 
	mNET_IPV4_IP_MASQ_DEBUG
=50,

361 
	mNET_TCP_SYNCOOKIES
=51,

362 
	mNET_TCP_STDURG
=52,

363 
	mNET_TCP_RFC1337
=53,

364 
	mNET_TCP_SYN_TAILDROP
=54,

365 
	mNET_TCP_MAX_SYN_BACKLOG
=55,

366 
	mNET_IPV4_LOCAL_PORT_RANGE
=56,

367 
	mNET_IPV4_ICMP_ECHO_IGNORE_ALL
=57,

368 
	mNET_IPV4_ICMP_ECHO_IGNORE_BROADCASTS
=58,

369 
	mNET_IPV4_ICMP_SOURCEQUENCH_RATE
=59,

370 
	mNET_IPV4_ICMP_DESTUNREACH_RATE
=60,

371 
	mNET_IPV4_ICMP_TIMEEXCEED_RATE
=61,

372 
	mNET_IPV4_ICMP_PARAMPROB_RATE
=62,

373 
	mNET_IPV4_ICMP_ECHOREPLY_RATE
=63,

374 
	mNET_IPV4_ICMP_IGNORE_BOGUS_ERROR_RESPONSES
=64,

375 
	mNET_IPV4_IGMP_MAX_MEMBERSHIPS
=65,

376 
	mNET_TCP_TW_RECYCLE
=66,

377 
	mNET_IPV4_ALWAYS_DEFRAG
=67,

378 
	mNET_IPV4_TCP_KEEPALIVE_INTVL
=68,

379 
	mNET_IPV4_INET_PEER_THRESHOLD
=69,

380 
	mNET_IPV4_INET_PEER_MINTTL
=70,

381 
	mNET_IPV4_INET_PEER_MAXTTL
=71,

382 
	mNET_IPV4_INET_PEER_GC_MINTIME
=72,

383 
	mNET_IPV4_INET_PEER_GC_MAXTIME
=73,

384 
	mNET_TCP_ORPHAN_RETRIES
=74,

385 
	mNET_TCP_ABORT_ON_OVERFLOW
=75,

386 
	mNET_TCP_SYNACK_RETRIES
=76,

387 
	mNET_TCP_MAX_ORPHANS
=77,

388 
	mNET_TCP_MAX_TW_BUCKETS
=78,

389 
	mNET_TCP_FACK
=79,

390 
	mNET_TCP_REORDERING
=80,

391 
	mNET_TCP_ECN
=81,

392 
	mNET_TCP_DSACK
=82,

393 
	mNET_TCP_MEM
=83,

394 
	mNET_TCP_WMEM
=84,

395 
	mNET_TCP_RMEM
=85,

396 
	mNET_TCP_APP_WIN
=86,

397 
	mNET_TCP_ADV_WIN_SCALE
=87,

398 
	mNET_IPV4_NONLOCAL_BIND
=88,

399 
	mNET_IPV4_ICMP_RATELIMIT
=89,

400 
	mNET_IPV4_ICMP_RATEMASK
=90,

401 
	mNET_TCP_TW_REUSE
=91,

402 
	mNET_TCP_FRTO
=92,

403 
	mNET_TCP_LOW_LATENCY
=93,

404 
	mNET_IPV4_IPFRAG_SECRET_INTERVAL
=94,

405 
	mNET_IPV4_IGMP_MAX_MSF
=96,

406 
	mNET_TCP_NO_METRICS_SAVE
=97,

407 
	mNET_TCP_DEFAULT_WIN_SCALE
=105,

408 
	mNET_TCP_MODERATE_RCVBUF
=106,

409 
	mNET_TCP_TSO_WIN_DIVISOR
=107,

410 
	mNET_TCP_BIC_BETA
=108,

411 
	mNET_IPV4_ICMP_ERRORS_USE_INBOUND_IFADDR
=109,

412 
	mNET_TCP_CONG_CONTROL
=110,

413 
	mNET_TCP_ABC
=111,

414 
	mNET_IPV4_IPFRAG_MAX_DIST
=112,

415 
	mNET_TCP_MTU_PROBING
=113,

416 
	mNET_TCP_BASE_MSS
=114,

417 
	mNET_IPV4_TCP_WORKAROUND_SIGNED_WINDOWS
=115,

418 
	mNET_TCP_DMA_COPYBREAK
=116,

419 
	mNET_TCP_SLOW_START_AFTER_IDLE
=117,

420 
	mNET_CIPSOV4_CACHE_ENABLE
=118,

421 
	mNET_CIPSOV4_CACHE_BUCKET_SIZE
=119,

422 
	mNET_CIPSOV4_RBM_OPTFMT
=120,

423 
	mNET_CIPSOV4_RBM_STRICTVALID
=121,

424 
	mNET_TCP_AVAIL_CONG_CONTROL
=122,

425 
	mNET_TCP_ALLOWED_CONG_CONTROL
=123,

426 
	mNET_TCP_MAX_SSTHRESH
=124,

427 
	mNET_TCP_FRTO_RESPONSE
=125,

431 
	mNET_IPV4_ROUTE_FLUSH
=1,

432 
	mNET_IPV4_ROUTE_MIN_DELAY
=2,

433 
	mNET_IPV4_ROUTE_MAX_DELAY
=3,

434 
	mNET_IPV4_ROUTE_GC_THRESH
=4,

435 
	mNET_IPV4_ROUTE_MAX_SIZE
=5,

436 
	mNET_IPV4_ROUTE_GC_MIN_INTERVAL
=6,

437 
	mNET_IPV4_ROUTE_GC_TIMEOUT
=7,

438 
	mNET_IPV4_ROUTE_GC_INTERVAL
=8,

439 
	mNET_IPV4_ROUTE_REDIRECT_LOAD
=9,

440 
	mNET_IPV4_ROUTE_REDIRECT_NUMBER
=10,

441 
	mNET_IPV4_ROUTE_REDIRECT_SILENCE
=11,

442 
	mNET_IPV4_ROUTE_ERROR_COST
=12,

443 
	mNET_IPV4_ROUTE_ERROR_BURST
=13,

444 
	mNET_IPV4_ROUTE_GC_ELASTICITY
=14,

445 
	mNET_IPV4_ROUTE_MTU_EXPIRES
=15,

446 
	mNET_IPV4_ROUTE_MIN_PMTU
=16,

447 
	mNET_IPV4_ROUTE_MIN_ADVMSS
=17,

448 
	mNET_IPV4_ROUTE_SECRET_INTERVAL
=18,

449 
	mNET_IPV4_ROUTE_GC_MIN_INTERVAL_MS
=19,

454 
	mNET_PROTO_CONF_ALL
=-2,

455 
	mNET_PROTO_CONF_DEFAULT
=-3

462 
	mNET_IPV4_CONF_FORWARDING
=1,

463 
	mNET_IPV4_CONF_MC_FORWARDING
=2,

464 
	mNET_IPV4_CONF_PROXY_ARP
=3,

465 
	mNET_IPV4_CONF_ACCEPT_REDIRECTS
=4,

466 
	mNET_IPV4_CONF_SECURE_REDIRECTS
=5,

467 
	mNET_IPV4_CONF_SEND_REDIRECTS
=6,

468 
	mNET_IPV4_CONF_SHARED_MEDIA
=7,

469 
	mNET_IPV4_CONF_RP_FILTER
=8,

470 
	mNET_IPV4_CONF_ACCEPT_SOURCE_ROUTE
=9,

471 
	mNET_IPV4_CONF_BOOTP_RELAY
=10,

472 
	mNET_IPV4_CONF_LOG_MARTIANS
=11,

473 
	mNET_IPV4_CONF_TAG
=12,

474 
	mNET_IPV4_CONF_ARPFILTER
=13,

475 
	mNET_IPV4_CONF_MEDIUM_ID
=14,

476 
	mNET_IPV4_CONF_NOXFRM
=15,

477 
	mNET_IPV4_CONF_NOPOLICY
=16,

478 
	mNET_IPV4_CONF_FORCE_IGMP_VERSION
=17,

479 
	mNET_IPV4_CONF_ARP_ANNOUNCE
=18,

480 
	mNET_IPV4_CONF_ARP_IGNORE
=19,

481 
	mNET_IPV4_CONF_PROMOTE_SECONDARIES
=20,

482 
	mNET_IPV4_CONF_ARP_ACCEPT
=21,

483 
	mNET_IPV4_CONF_ARP_NOTIFY
=22,

489 
	mNET_IPV4_NF_CONNTRACK_MAX
=1,

490 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_SYN_SENT
=2,

491 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_SYN_RECV
=3,

492 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_ESTABLISHED
=4,

493 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_FIN_WAIT
=5,

494 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_CLOSE_WAIT
=6,

495 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_LAST_ACK
=7,

496 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_TIME_WAIT
=8,

497 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_CLOSE
=9,

498 
	mNET_IPV4_NF_CONNTRACK_UDP_TIMEOUT
=10,

499 
	mNET_IPV4_NF_CONNTRACK_UDP_TIMEOUT_STREAM
=11,

500 
	mNET_IPV4_NF_CONNTRACK_ICMP_TIMEOUT
=12,

501 
	mNET_IPV4_NF_CONNTRACK_GENERIC_TIMEOUT
=13,

502 
	mNET_IPV4_NF_CONNTRACK_BUCKETS
=14,

503 
	mNET_IPV4_NF_CONNTRACK_LOG_INVALID
=15,

504 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_MAX_RETRANS
=16,

505 
	mNET_IPV4_NF_CONNTRACK_TCP_LOOSE
=17,

506 
	mNET_IPV4_NF_CONNTRACK_TCP_BE_LIBERAL
=18,

507 
	mNET_IPV4_NF_CONNTRACK_TCP_MAX_RETRANS
=19,

508 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_CLOSED
=20,

509 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_WAIT
=21,

510 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_ECHOED
=22,

511 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_ESTABLISHED
=23,

512 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_SENT
=24,

513 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_RECD
=25,

514 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_ACK_SENT
=26,

515 
	mNET_IPV4_NF_CONNTRACK_COUNT
=27,

516 
	mNET_IPV4_NF_CONNTRACK_CHECKSUM
=28,

521 
	mNET_IPV6_CONF
=16,

522 
	mNET_IPV6_NEIGH
=17,

523 
	mNET_IPV6_ROUTE
=18,

524 
	mNET_IPV6_ICMP
=19,

525 
	mNET_IPV6_BINDV6ONLY
=20,

526 
	mNET_IPV6_IP6FRAG_HIGH_THRESH
=21,

527 
	mNET_IPV6_IP6FRAG_LOW_THRESH
=22,

528 
	mNET_IPV6_IP6FRAG_TIME
=23,

529 
	mNET_IPV6_IP6FRAG_SECRET_INTERVAL
=24,

530 
	mNET_IPV6_MLD_MAX_MSF
=25,

534 
	mNET_IPV6_ROUTE_FLUSH
=1,

535 
	mNET_IPV6_ROUTE_GC_THRESH
=2,

536 
	mNET_IPV6_ROUTE_MAX_SIZE
=3,

537 
	mNET_IPV6_ROUTE_GC_MIN_INTERVAL
=4,

538 
	mNET_IPV6_ROUTE_GC_TIMEOUT
=5,

539 
	mNET_IPV6_ROUTE_GC_INTERVAL
=6,

540 
	mNET_IPV6_ROUTE_GC_ELASTICITY
=7,

541 
	mNET_IPV6_ROUTE_MTU_EXPIRES
=8,

542 
	mNET_IPV6_ROUTE_MIN_ADVMSS
=9,

543 
	mNET_IPV6_ROUTE_GC_MIN_INTERVAL_MS
=10

547 
	mNET_IPV6_FORWARDING
=1,

548 
	mNET_IPV6_HOP_LIMIT
=2,

549 
	mNET_IPV6_MTU
=3,

550 
	mNET_IPV6_ACCEPT_RA
=4,

551 
	mNET_IPV6_ACCEPT_REDIRECTS
=5,

552 
	mNET_IPV6_AUTOCONF
=6,

553 
	mNET_IPV6_DAD_TRANSMITS
=7,

554 
	mNET_IPV6_RTR_SOLICITS
=8,

555 
	mNET_IPV6_RTR_SOLICIT_INTERVAL
=9,

556 
	mNET_IPV6_RTR_SOLICIT_DELAY
=10,

557 
	mNET_IPV6_USE_TEMPADDR
=11,

558 
	mNET_IPV6_TEMP_VALID_LFT
=12,

559 
	mNET_IPV6_TEMP_PREFERED_LFT
=13,

560 
	mNET_IPV6_REGEN_MAX_RETRY
=14,

561 
	mNET_IPV6_MAX_DESYNC_FACTOR
=15,

562 
	mNET_IPV6_MAX_ADDRESSES
=16,

563 
	mNET_IPV6_FORCE_MLD_VERSION
=17,

564 
	mNET_IPV6_ACCEPT_RA_DEFRTR
=18,

565 
	mNET_IPV6_ACCEPT_RA_PINFO
=19,

566 
	mNET_IPV6_ACCEPT_RA_RTR_PREF
=20,

567 
	mNET_IPV6_RTR_PROBE_INTERVAL
=21,

568 
	mNET_IPV6_ACCEPT_RA_RT_INFO_MAX_PLEN
=22,

569 
	mNET_IPV6_PROXY_NDP
=23,

570 
	mNET_IPV6_ACCEPT_SOURCE_ROUTE
=25,

571 
	m__NET_IPV6_MAX


576 
	mNET_IPV6_ICMP_RATELIMIT
=1

581 
	mNET_NEIGH_MCAST_SOLICIT
=1,

582 
	mNET_NEIGH_UCAST_SOLICIT
=2,

583 
	mNET_NEIGH_APP_SOLICIT
=3,

584 
	mNET_NEIGH_RETRANS_TIME
=4,

585 
	mNET_NEIGH_REACHABLE_TIME
=5,

586 
	mNET_NEIGH_DELAY_PROBE_TIME
=6,

587 
	mNET_NEIGH_GC_STALE_TIME
=7,

588 
	mNET_NEIGH_UNRES_QLEN
=8,

589 
	mNET_NEIGH_PROXY_QLEN
=9,

590 
	mNET_NEIGH_ANYCAST_DELAY
=10,

591 
	mNET_NEIGH_PROXY_DELAY
=11,

592 
	mNET_NEIGH_LOCKTIME
=12,

593 
	mNET_NEIGH_GC_INTERVAL
=13,

594 
	mNET_NEIGH_GC_THRESH1
=14,

595 
	mNET_NEIGH_GC_THRESH2
=15,

596 
	mNET_NEIGH_GC_THRESH3
=16,

597 
	mNET_NEIGH_RETRANS_TIME_MS
=17,

598 
	mNET_NEIGH_REACHABLE_TIME_MS
=18,

603 
	mNET_DCCP_DEFAULT
=1,

608 
	mNET_IPX_PPROP_BROADCASTING
=1,

609 
	mNET_IPX_FORWARDING
=2

614 
	mNET_LLC2
=1,

615 
	mNET_LLC_STATION
=2,

620 
	mNET_LLC2_TIMEOUT
=1,

625 
	mNET_LLC_STATION_ACK_TIMEOUT
=1,

630 
	mNET_LLC2_ACK_TIMEOUT
=1,

631 
	mNET_LLC2_P_TIMEOUT
=2,

632 
	mNET_LLC2_REJ_TIMEOUT
=3,

633 
	mNET_LLC2_BUSY_TIMEOUT
=4,

638 
	mNET_ATALK_AARP_EXPIRY_TIME
=1,

639 
	mNET_ATALK_AARP_TICK_TIME
=2,

640 
	mNET_ATALK_AARP_RETRANSMIT_LIMIT
=3,

641 
	mNET_ATALK_AARP_RESOLVE_TIME
=4

647 
	mNET_NETROM_DEFAULT_PATH_QUALITY
=1,

648 
	mNET_NETROM_OBSOLESCENCE_COUNT_INITIALISER
=2,

649 
	mNET_NETROM_NETWORK_TTL_INITIALISER
=3,

650 
	mNET_NETROM_TRANSPORT_TIMEOUT
=4,

651 
	mNET_NETROM_TRANSPORT_MAXIMUM_TRIES
=5,

652 
	mNET_NETROM_TRANSPORT_ACKNOWLEDGE_DELAY
=6,

653 
	mNET_NETROM_TRANSPORT_BUSY_DELAY
=7,

654 
	mNET_NETROM_TRANSPORT_REQUESTED_WINDOW_SIZE
=8,

655 
	mNET_NETROM_TRANSPORT_NO_ACTIVITY_TIMEOUT
=9,

656 
	mNET_NETROM_ROUTING_CONTROL
=10,

657 
	mNET_NETROM_LINK_FAILS_COUNT
=11,

658 
	mNET_NETROM_RESET
=12

663 
	mNET_AX25_IP_DEFAULT_MODE
=1,

664 
	mNET_AX25_DEFAULT_MODE
=2,

665 
	mNET_AX25_BACKOFF_TYPE
=3,

666 
	mNET_AX25_CONNECT_MODE
=4,

667 
	mNET_AX25_STANDARD_WINDOW
=5,

668 
	mNET_AX25_EXTENDED_WINDOW
=6,

669 
	mNET_AX25_T1_TIMEOUT
=7,

670 
	mNET_AX25_T2_TIMEOUT
=8,

671 
	mNET_AX25_T3_TIMEOUT
=9,

672 
	mNET_AX25_IDLE_TIMEOUT
=10,

673 
	mNET_AX25_N2
=11,

674 
	mNET_AX25_PACLEN
=12,

675 
	mNET_AX25_PROTOCOL
=13,

676 
	mNET_AX25_DAMA_SLAVE_TIMEOUT
=14

681 
	mNET_ROSE_RESTART_REQUEST_TIMEOUT
=1,

682 
	mNET_ROSE_CALL_REQUEST_TIMEOUT
=2,

683 
	mNET_ROSE_RESET_REQUEST_TIMEOUT
=3,

684 
	mNET_ROSE_CLEAR_REQUEST_TIMEOUT
=4,

685 
	mNET_ROSE_ACK_HOLD_BACK_TIMEOUT
=5,

686 
	mNET_ROSE_ROUTING_CONTROL
=6,

687 
	mNET_ROSE_LINK_FAIL_TIMEOUT
=7,

688 
	mNET_ROSE_MAX_VCS
=8,

689 
	mNET_ROSE_WINDOW_SIZE
=9,

690 
	mNET_ROSE_NO_ACTIVITY_TIMEOUT
=10

695 
	mNET_X25_RESTART_REQUEST_TIMEOUT
=1,

696 
	mNET_X25_CALL_REQUEST_TIMEOUT
=2,

697 
	mNET_X25_RESET_REQUEST_TIMEOUT
=3,

698 
	mNET_X25_CLEAR_REQUEST_TIMEOUT
=4,

699 
	mNET_X25_ACK_HOLD_BACK_TIMEOUT
=5,

700 
	mNET_X25_FORWARD
=6

706 
	mNET_TR_RIF_TIMEOUT
=1

711 
	mNET_DECNET_NODE_TYPE
 = 1,

712 
	mNET_DECNET_NODE_ADDRESS
 = 2,

713 
	mNET_DECNET_NODE_NAME
 = 3,

714 
	mNET_DECNET_DEFAULT_DEVICE
 = 4,

715 
	mNET_DECNET_TIME_WAIT
 = 5,

716 
	mNET_DECNET_DN_COUNT
 = 6,

717 
	mNET_DECNET_DI_COUNT
 = 7,

718 
	mNET_DECNET_DR_COUNT
 = 8,

719 
	mNET_DECNET_DST_GC_INTERVAL
 = 9,

720 
	mNET_DECNET_CONF
 = 10,

721 
	mNET_DECNET_NO_FC_MAX_CWND
 = 11,

722 
	mNET_DECNET_MEM
 = 12,

723 
	mNET_DECNET_RMEM
 = 13,

724 
	mNET_DECNET_WMEM
 = 14,

725 
	mNET_DECNET_DEBUG_LEVEL
 = 255

730 
	mNET_DECNET_CONF_LOOPBACK
 = -2,

731 
	mNET_DECNET_CONF_DDCMP
 = -3,

732 
	mNET_DECNET_CONF_PPP
 = -4,

733 
	mNET_DECNET_CONF_X25
 = -5,

734 
	mNET_DECNET_CONF_GRE
 = -6,

735 
	mNET_DECNET_CONF_ETHER
 = -7

742 
	mNET_DECNET_CONF_DEV_PRIORITY
 = 1,

743 
	mNET_DECNET_CONF_DEV_T1
 = 2,

744 
	mNET_DECNET_CONF_DEV_T2
 = 3,

745 
	mNET_DECNET_CONF_DEV_T3
 = 4,

746 
	mNET_DECNET_CONF_DEV_FORWARDING
 = 5,

747 
	mNET_DECNET_CONF_DEV_BLKSIZE
 = 6,

748 
	mNET_DECNET_CONF_DEV_STATE
 = 7

753 
	mNET_SCTP_RTO_INITIAL
 = 1,

754 
	mNET_SCTP_RTO_MIN
 = 2,

755 
	mNET_SCTP_RTO_MAX
 = 3,

756 
	mNET_SCTP_RTO_ALPHA
 = 4,

757 
	mNET_SCTP_RTO_BETA
 = 5,

758 
	mNET_SCTP_VALID_COOKIE_LIFE
 = 6,

759 
	mNET_SCTP_ASSOCIATION_MAX_RETRANS
 = 7,

760 
	mNET_SCTP_PATH_MAX_RETRANS
 = 8,

761 
	mNET_SCTP_MAX_INIT_RETRANSMITS
 = 9,

762 
	mNET_SCTP_HB_INTERVAL
 = 10,

763 
	mNET_SCTP_PRESERVE_ENABLE
 = 11,

764 
	mNET_SCTP_MAX_BURST
 = 12,

765 
	mNET_SCTP_ADDIP_ENABLE
 = 13,

766 
	mNET_SCTP_PRSCTP_ENABLE
 = 14,

767 
	mNET_SCTP_SNDBUF_POLICY
 = 15,

768 
	mNET_SCTP_SACK_TIMEOUT
 = 16,

769 
	mNET_SCTP_RCVBUF_POLICY
 = 17,

774 
	mNET_BRIDGE_NF_CALL_ARPTABLES
 = 1,

775 
	mNET_BRIDGE_NF_CALL_IPTABLES
 = 2,

776 
	mNET_BRIDGE_NF_CALL_IP6TABLES
 = 3,

777 
	mNET_BRIDGE_NF_FILTER_VLAN_TAGGED
 = 4,

778 
	mNET_BRIDGE_NF_FILTER_PPPOE_TAGGED
 = 5,

783 
	mNET_IRDA_DISCOVERY
=1,

784 
	mNET_IRDA_DEVNAME
=2,

785 
	mNET_IRDA_DEBUG
=3,

786 
	mNET_IRDA_FAST_POLL
=4,

787 
	mNET_IRDA_DISCOVERY_SLOTS
=5,

788 
	mNET_IRDA_DISCOVERY_TIMEOUT
=6,

789 
	mNET_IRDA_SLOT_TIMEOUT
=7,

790 
	mNET_IRDA_MAX_BAUD_RATE
=8,

791 
	mNET_IRDA_MIN_TX_TURN_TIME
=9,

792 
	mNET_IRDA_MAX_TX_DATA_SIZE
=10,

793 
	mNET_IRDA_MAX_TX_WINDOW
=11,

794 
	mNET_IRDA_MAX_NOREPLY_TIME
=12,

795 
	mNET_IRDA_WARN_NOREPLY_TIME
=13,

796 
	mNET_IRDA_LAP_KEEPALIVE_TIME
=14,

803 
	mFS_NRINODE
=1,

804 
	mFS_STATINODE
=2,

805 
	mFS_MAXINODE
=3,

806 
	mFS_NRDQUOT
=4,

807 
	mFS_MAXDQUOT
=5,

808 
	mFS_NRFILE
=6,

809 
	mFS_MAXFILE
=7,

810 
	mFS_DENTRY
=8,

811 
	mFS_NRSUPER
=9,

812 
	mFS_MAXSUPER
=10,

813 
	mFS_OVERFLOWUID
=11,

814 
	mFS_OVERFLOWGID
=12,

815 
	mFS_LEASES
=13,

816 
	mFS_DIR_NOTIFY
=14,

817 
	mFS_LEASE_TIME
=15,

818 
	mFS_DQSTATS
=16,

819 
	mFS_XFS
=17,

820 
	mFS_AIO_NR
=18,

821 
	mFS_AIO_MAX_NR
=19,

822 
	mFS_INOTIFY
=20,

823 
	mFS_OCFS2
=988,

828 
	mFS_DQ_LOOKUPS
 = 1,

829 
	mFS_DQ_DROPS
 = 2,

830 
	mFS_DQ_READS
 = 3,

831 
	mFS_DQ_WRITES
 = 4,

832 
	mFS_DQ_CACHE_HITS
 = 5,

833 
	mFS_DQ_ALLOCATED
 = 6,

834 
	mFS_DQ_FREE
 = 7,

835 
	mFS_DQ_SYNCS
 = 8,

836 
	mFS_DQ_WARNINGS
 = 9,

843 
	mDEV_CDROM
=1,

844 
	mDEV_HWMON
=2,

845 
	mDEV_PARPORT
=3,

846 
	mDEV_RAID
=4,

847 
	mDEV_MAC_HID
=5,

848 
	mDEV_SCSI
=6,

849 
	mDEV_IPMI
=7,

854 
	mDEV_CDROM_INFO
=1,

855 
	mDEV_CDROM_AUTOCLOSE
=2,

856 
	mDEV_CDROM_AUTOEJECT
=3,

857 
	mDEV_CDROM_DEBUG
=4,

858 
	mDEV_CDROM_LOCK
=5,

859 
	mDEV_CDROM_CHECK_MEDIA
=6

864 
	mDEV_PARPORT_DEFAULT
=-3

869 
	mDEV_RAID_SPEED_LIMIT_MIN
=1,

870 
	mDEV_RAID_SPEED_LIMIT_MAX
=2

875 
	mDEV_PARPORT_DEFAULT_TIMESLICE
=1,

876 
	mDEV_PARPORT_DEFAULT_SPINTIME
=2

881 
	mDEV_PARPORT_SPINTIME
=1,

882 
	mDEV_PARPORT_BASE_ADDR
=2,

883 
	mDEV_PARPORT_IRQ
=3,

884 
	mDEV_PARPORT_DMA
=4,

885 
	mDEV_PARPORT_MODES
=5,

886 
	mDEV_PARPORT_DEVICES
=6,

887 
	mDEV_PARPORT_AUTOPROBE
=16

892 
	mDEV_PARPORT_DEVICES_ACTIVE
=-3,

897 
	mDEV_PARPORT_DEVICE_TIMESLICE
=1,

902 
	mDEV_MAC_HID_KEYBOARD_SENDS_LINUX_KEYCODES
=1,

903 
	mDEV_MAC_HID_KEYBOARD_LOCK_KEYCODES
=2,

904 
	mDEV_MAC_HID_MOUSE_BUTTON_EMULATION
=3,

905 
	mDEV_MAC_HID_MOUSE_BUTTON2_KEYCODE
=4,

906 
	mDEV_MAC_HID_MOUSE_BUTTON3_KEYCODE
=5,

907 
	mDEV_MAC_HID_ADB_MOUSE_SENDS_KEYCODES
=6

912 
	mDEV_SCSI_LOGGING_LEVEL
=1,

917 
	mDEV_IPMI_POWEROFF_POWERCYCLE
=1,

923 
	mABI_DEFHANDLER_COFF
=1,

924 
	mABI_DEFHANDLER_ELF
=2,

925 
	mABI_DEFHANDLER_LCALL7
=3,

926 
	mABI_DEFHANDLER_LIBCSO
=4,

927 
	mABI_TRACE
=5,

928 
	mABI_FAKE_UTSNAME
=6,

	@/usr/include/linux/time.h

1 #i‚de‡
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<löux/ty≥s.h
>

7 #i‚de‡
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime•ec
 {

10 
__kî√l_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimevÆ
 {

16 
__kî√l_time_t
 
	mtv_£c
;

17 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

20 
	stimez⁄e
 {

21 
	mtz_möuãswe°
;

22 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

57 
	#CLOCK_SGI_CYCLE
 10

	)

58 
	#CLOCK_TAI
 11

	)

60 
	#MAX_CLOCKS
 16

	)

61 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

62 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

67 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 #ifde‡
__CHECK_ENDIAN__


22 
	#__bôwi£
 
__bôwi£__


	)

24 
	#__bôwi£


	)

27 
__u16
 
	t__bôwi£
 
	t__À16
;

28 
__u16
 
	t__bôwi£
 
	t__be16
;

29 
__u32
 
	t__bôwi£
 
	t__À32
;

30 
__u32
 
	t__bôwi£
 
	t__be32
;

31 
__u64
 
	t__bôwi£
 
	t__À64
;

32 
__u64
 
	t__bôwi£
 
	t__be64
;

34 
__u16
 
	t__bôwi£
 
	t__sum16
;

35 
__u32
 
	t__bôwi£
 
	t__wsum
;

46 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

48 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/wait.h

1 #i‚de‡
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

6 
	#WSTOPPED
 
WUNTRACED


	)

7 
	#WEXITED
 0x00000004

	)

8 
	#WCONTINUED
 0x00000008

	)

9 
	#WNOWAIT
 0x01000000

	)

11 
	#__WNOTHREAD
 0x20000000

	)

12 
	#__WALL
 0x40000000

	)

13 
	#__WCLONE
 0x80000000

	)

16 
	#P_ALL
 0

	)

17 
	#P_PID
 1

	)

18 
	#P_PGID
 2

	)

	@/usr/include/linux/ioctl.h

1 #i‚de‡
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/limits.h

1 #i‚de‡
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

1 #i‚de‡
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<löux/ty≥s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysöfo
 {

8 
__kî√l_l⁄g_t
 
	mu±ime
;

9 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

10 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

11 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

12 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

13 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

14 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

15 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

16 
__u16
 
	m¥ocs
;

17 
__u16
 
	m∑d
;

18 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

19 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

20 
__u32
 
	mmem_unô
;

21 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

39 #i‡
deföed
 
__˝lu•lus
 && (__˝lu•lu†>199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

47 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

50 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

51 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN


58 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

69 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

73 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #ifde‡
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


85  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


91  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifde‡
__USE_GNU


104 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

107 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

110 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

111 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

118 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

121 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

132 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

133 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

138 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

141 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

151 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

152 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

154 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

155 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

156 
__THROW
 
	`__n⁄nuŒ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifde‡
__USE_XOPEN2K8


163 
	~<xloˇÀ.h
>

166 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

167 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

169 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

170 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

173 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED
 \

174 || 
deföed
 
__USE_XOPEN2K8


176 *
	$°rdup
 (c⁄° *
__s
)

177 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_XOPEN2K8


184 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

185 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

188 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


190 
	#°rdu∑
(
s
) \

191 (
__exãnsi⁄__
 \

193 c⁄° *
__ﬁd
 = (
s
); \

194 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

195 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

196 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

197 
	}
}))

	)

200 
	#°∫du∑
(
s
, 
n
) \

201 (
__exãnsi⁄__
 \

203 c⁄° *
__ﬁd
 = (
s
); \

204 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

205 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

206 
__√w
[
__Àn
] = '\0'; \

207 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
°rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

218 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

221 #ifde‡
__OPTIMIZE__


222 
__exã∫_Æways_ölöe
 *

223 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


225  
__buûtö_°rchr
 (
__s
, 
__c
);

228 
__exã∫_Æways_ölöe
 const *

229 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


231  
__buûtö_°rchr
 (
__s
, 
__c
);

236 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

237 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`°ºchr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

245 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

248 #ifde‡
__OPTIMIZE__


249 
__exã∫_Æways_ölöe
 *

250 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


252  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

255 
__exã∫_Æways_ölöe
 const *

256 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


258  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifde‡
__USE_GNU


271 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

274 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

286 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

289 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

290 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

296 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

297 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

298 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

300 #ifde‡
__OPTIMIZE__


301 
__exã∫_Æways_ölöe
 *

302 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


304  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

307 
__exã∫_Æways_ölöe
 const *

308 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


310  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

313 
	}
}

315 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

316 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

323 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

324 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

325 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

327 #ifde‡
__OPTIMIZE__


328 
__exã∫_Æways_ölöe
 *

329 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


331  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

334 
__exã∫_Æways_ölöe
 const *

335 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


337  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

340 
	}
}

342 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

343 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

348 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

349 
__THROW
 
	`__n⁄nuŒ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

355 c⁄° *
__ª°ri˘
 
__dñim
,

356 **
__ª°ri˘
 
__ßve_±r
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

358 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


359 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

360 **
__ª°ri˘
 
__ßve_±r
)

361 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

364 #ifde‡
__USE_GNU


366 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

368 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

369 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

370 c⁄° *
__√edÀ
)

371 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

374 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

378 #ifde‡
__USE_GNU


382 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

383 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

384 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

388 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

389 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

390 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

391 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

392 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

393 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$°æí
 (c⁄° *
__s
)

400 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

407 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

414 
__END_NAMESPACE_STD


415 #i‡
deföed
 
__USE_XOPEN2K
 || deföed 
__USE_MISC


423 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


426 #ifde‡
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

428 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

429 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

431 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

432 
__THROW
 
	`__n⁄nuŒ
 ((2));

433 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

438 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

439 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

443 #ifde‡
__USE_XOPEN2K8


445 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

451 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

453 #ifde‡
__USE_BSD


455 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

456 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

459 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

462 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

466 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`ödex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

471 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

474 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__exã∫_Æways_ölöe
 *

476 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


478  
	`__buûtö_ödex
 (
__s
, 
__c
);

481 
__exã∫_Æways_ölöe
 const *

482 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


484  
	`__buûtö_ödex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$ödex
 (c⁄° *
__s
, 
__c
)

490 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`rödex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

499 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

502 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__exã∫_Æways_ölöe
 *

504 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


506  
	`__buûtö_rödex
 (
__s
, 
__c
);

509 
__exã∫_Æways_ölöe
 const *

510 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


512  
	`__buûtö_rödex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$rödex
 (c⁄° *
__s
, 
__c
)

518 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

523 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

527 #ifdef 
__USE_GNU


528 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

530 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

534 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

535 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

538 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

546 
__loˇÀ_t
 
__loc
)

547 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

549 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

550 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

551 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

558 c⁄° *
__ª°ri˘
 
__dñim
)

559 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

567 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

568 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

570 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

574 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

575 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

576 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

578 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

579 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

585 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

588 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

591 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

593 #i‚de‡
ba£«me


598 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£«me
 (*
__fûíame
)

600 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

601 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

602 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

604 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

610 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

611 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

612 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


632 
	~<bôs/°rög.h
>

635 
	~<bôs/°rög2.h
>

638 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


640 
	~<bôs/°rög3.h
>

644 
__END_DECLS


	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #unde‡
__USE_ISOC11


102 #unde‡
__USE_ISOC99


103 #unde‡
__USE_ISOC95


104 #unde‡
__USE_ISOCXX11


105 #unde‡
__USE_POSIX


106 #unde‡
__USE_POSIX2


107 #unde‡
__USE_POSIX199309


108 #unde‡
__USE_POSIX199506


109 #unde‡
__USE_XOPEN


110 #unde‡
__USE_XOPEN_EXTENDED


111 #unde‡
__USE_UNIX98


112 #unde‡
__USE_XOPEN2K


113 #unde‡
__USE_XOPEN2KXSI


114 #unde‡
__USE_XOPEN2K8


115 #unde‡
__USE_XOPEN2K8XSI


116 #unde‡
__USE_LARGEFILE


117 #unde‡
__USE_LARGEFILE64


118 #unde‡
__USE_FILE_OFFSET64


119 #unde‡
__USE_BSD


120 #unde‡
__USE_SVID


121 #unde‡
__USE_MISC


122 #unde‡
__USE_ATFILE


123 #unde‡
__USE_GNU


124 #unde‡
__USE_REENTRANT


125 #unde‡
__USE_FORTIFY_LEVEL


126 #unde‡
__KERNEL_STRICT_NAMES


130 #i‚de‡
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

143 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

150 #ifde‡
_GNU_SOURCE


151 #unde‡
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #unde‡
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #unde‡
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #unde‡
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #unde‡
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #unde‡
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #unde‡
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #unde‡
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #unde‡
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #unde‡
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #unde‡
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #unde‡
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

180 || (!
deföed
 
	g__STRICT_ANSI__
 \

181 && !
deföed
 
	g_ISOC99_SOURCE
 \

182 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

183 && !
deföed
 
	g_XOPEN_SOURCE
 \

184 && !
deföed
 
	g_BSD_SOURCE
 && !deföed 
	g_SVID_SOURCE
))

185 #unde‡
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #unde‡
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #unde‡
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #i‡(
deföed
 
_ISOC11_SOURCE
 \

195 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

201 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

207 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

216 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifde‡
_DEFAULT_SOURCE


224 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #unde‡
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #unde‡
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #i‡((!
deföed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #i‡
deföed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >1 || deföed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #unde‡
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #unde‡
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #unde‡
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #unde‡
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #unde‡
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #unde‡
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifde‡
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifde‡
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifde‡
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #i‡
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #i‡
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<°dc-¥edef.h
>

360 #unde‡
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

369 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

372 #i‚de‡
__ASSEMBLER__


373 #i‚de‡
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

388 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

389 && 
deföed
 
	g__exã∫_ölöe


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/°ubs.h
>

	@/usr/include/linux/stddef.h

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
199
3816
bcache/alloc.c
bcache/bcache.h
bcache/bcache.mod.c
bcache/bset.c
bcache/bset.h
bcache/btree.c
bcache/btree.h
bcache/closure.c
bcache/closure.h
bcache/debug.c
bcache/debug.h
bcache/extents.c
bcache/extents.h
bcache/io.c
bcache/journal.c
bcache/journal.h
bcache/movinggc.c
bcache/request.c
bcache/request.h
bcache/stats.c
bcache/stats.h
bcache/super.c
bcache/sysfs.c
bcache/sysfs.h
bcache/trace.c
bcache/util.c
bcache/util.h
bcache/writeback.c
bcache/writeback.h
bitmap.c
bitmap.h
dm-bio-prison.c
dm-bio-prison.h
dm-bio-prison.mod.c
dm-bio-record.h
dm-bufio.c
dm-bufio.h
dm-bufio.mod.c
dm-builtin.c
dm-cache-block-types.h
dm-cache-cleaner.mod.c
dm-cache-metadata.c
dm-cache-metadata.h
dm-cache-mq.mod.c
dm-cache-policy-cleaner.c
dm-cache-policy-internal.h
dm-cache-policy-mq.c
dm-cache-policy.c
dm-cache-policy.h
dm-cache-target.c
dm-cache.mod.c
dm-crypt.c
dm-crypt.mod.c
dm-dedup-backend.h
dm-dedup-cbt.c
dm-dedup-cbt.h
dm-dedup-hash.c
dm-dedup-hash.h
dm-dedup-kvstore.h
dm-dedup-ram.c
dm-dedup-ram.h
dm-dedup-rw.c
dm-dedup-rw.h
dm-dedup-target.c
dm-dedup-target.h
dm-dedup.mod.c
dm-delay.c
dm-delay.mod.c
dm-era-target.c
dm-exception-store.c
dm-exception-store.h
dm-flakey.c
dm-flakey.mod.c
dm-io.c
dm-ioctl.c
dm-kcopyd.c
dm-linear.c
dm-log-userspace-base.c
dm-log-userspace-transfer.c
dm-log-userspace-transfer.h
dm-log-userspace.mod.c
dm-log.c
dm-log.mod.c
dm-mirror.mod.c
dm-mpath.c
dm-mpath.h
dm-multipath.mod.c
dm-path-selector.c
dm-path-selector.h
dm-queue-length.c
dm-queue-length.mod.c
dm-raid.c
dm-raid.mod.c
dm-raid1.c
dm-region-hash.c
dm-region-hash.mod.c
dm-round-robin.c
dm-round-robin.mod.c
dm-service-time.c
dm-service-time.mod.c
dm-snap-persistent.c
dm-snap-transient.c
dm-snap.c
dm-snapshot.mod.c
dm-stats.c
dm-stats.h
dm-stripe.c
dm-switch.c
dm-switch.mod.c
dm-sysfs.c
dm-table.c
dm-target.c
dm-thin-metadata.c
dm-thin-metadata.h
dm-thin-pool.mod.c
dm-thin.c
dm-uevent.c
dm-uevent.h
dm-verity.c
dm-verity.mod.c
dm-zero.c
dm-zero.mod.c
dm.c
dm.h
faulty.c
faulty.mod.c
linear.c
linear.h
linear.mod.c
md.c
md.h
multipath.c
multipath.h
multipath.mod.c
persistent-data/dm-array.c
persistent-data/dm-array.h
persistent-data/dm-bitset.c
persistent-data/dm-bitset.h
persistent-data/dm-block-manager.c
persistent-data/dm-block-manager.h
persistent-data/dm-btree-internal.h
persistent-data/dm-btree-remove.c
persistent-data/dm-btree-spine.c
persistent-data/dm-btree.c
persistent-data/dm-btree.h
persistent-data/dm-persistent-data-internal.h
persistent-data/dm-persistent-data.mod.c
persistent-data/dm-space-map-common.c
persistent-data/dm-space-map-common.h
persistent-data/dm-space-map-disk.c
persistent-data/dm-space-map-disk.h
persistent-data/dm-space-map-metadata.c
persistent-data/dm-space-map-metadata.h
persistent-data/dm-space-map.h
persistent-data/dm-transaction-manager.c
persistent-data/dm-transaction-manager.h
raid0.c
raid0.h
raid0.mod.c
raid1.c
raid1.h
raid1.mod.c
raid10.c
raid10.h
raid10.mod.c
raid456.mod.c
raid5.c
raid5.h
/usr/include/linux/blkpg.h
/usr/include/linux/blktrace_api.h
/usr/include/linux/connector.h
/usr/include/linux/dm-ioctl.h
/usr/include/linux/dm-log-userspace.h
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/hdreg.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/poll.h
/usr/include/linux/raid/md_p.h
/usr/include/linux/raid/md_u.h
/usr/include/linux/random.h
/usr/include/linux/reboot.h
/usr/include/linux/sched.h
/usr/include/linux/string.h
/usr/include/linux/sysctl.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/wait.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/features.h
/usr/include/linux/stddef.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h
